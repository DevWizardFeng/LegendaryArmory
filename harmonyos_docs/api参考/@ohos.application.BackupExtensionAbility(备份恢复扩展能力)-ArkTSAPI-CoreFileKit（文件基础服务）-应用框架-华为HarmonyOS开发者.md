<h1 _ngcontent-kus-c119="" class="doc-title ng-star-inserted" title="@ohos.application.BackupExtensionAbility (备份恢复扩展能力)"> @ohos.application.BackupExtensionAbility (备份恢复扩展能力) </h1>

<div _ngcontent-kus-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>BackupExtensionAbility模块提供备份恢复服务相关扩展能力，为应用提供扩展的备份恢复能力。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <ul><li><p>本模块首批接口从API version 10开始支持。后续版本的新增接口，采用上角标单独标记接口的起始版本。</p>  </li><li><p>本模块接口仅可在Stage模型下使用。</p>  </li></ul>  </div></div></div>  <div class="tiledSection"><h2 id="导入模块" device-type="phone,2in1,tablet,wearable,tv">导入模块<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="导入模块" tips="复制节点链接"></i></h2><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="bundleversion" device-type="phone,2in1,tablet,wearable,tv">BundleVersion<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="bundleversion" tips="复制节点链接"></i></h2><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>恢复时所需要的版本信息，开发者可根据配置的版本号来判断本次恢复时的应用版本数据。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.4.1.6.1.1" width="20%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.6.1.2" width="20%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.6.1.3" width="20%">只读</th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.6.1.4" width="20%">可选</th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.6.1.5" width="20%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="20%">code</td> <td class="cellrowborder" width="20%">number</td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">应用的版本号。</td> </tr> <tr><td class="cellrowborder" width="20%">name</td> <td class="cellrowborder" width="20%">string</td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">应用的版本名称。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="backupextensionability" device-type="phone,2in1,tablet,wearable,tv">BackupExtensionAbility<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="backupextensionability" tips="复制节点链接"></i></h2><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>应用接入数据备份恢复需要通过BackupExtensionAbility实现，开发者可以通过<a href="/consumer/cn/doc/harmonyos-references/js-apis-application-backupextensionability#onbackup">onBackup</a>，<a href="/consumer/cn/doc/harmonyos-references/js-apis-application-backupextensionability#onrestore">onRestore</a>来实现自定义的备份恢复操作。</p> </div>  <div class="tiledSection"><h3 id="属性" device-type="phone,2in1,tablet,wearable,tv" class="firsth2">属性<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="属性" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.3.1.6.1.1" width="20%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.6.1.2" width="20%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.6.1.3" width="20%">只读</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.6.1.4" width="20%">可选</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.6.1.5" width="20%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="20%">context<sup>11+</sup></td> <td class="cellrowborder" width="20%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-backupextensioncontext">BackupExtensionContext</a></td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">否</td> <td class="cellrowborder" width="20%">BackupExtensionAbility的上下文环境，继承自<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-extensioncontext">ExtensionContext</a>。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="onbackup" device-type="phone,2in1,tablet,wearable,tv">onBackup<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onbackup" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onBackup(): void</p> <p>Extension生命周期回调，在执行备份数据时回调，由开发者提供扩展的备份数据的操作。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onBackup</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onBackup'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="onbackupex12" device-type="phone,2in1,tablet,wearable,tv">onBackupEx<sup>12+</sup><i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onbackupex12" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onBackupEx(backupInfo: string): string | Promise&lt;string&gt;</p> <p>备份恢复框架增加扩展参数，允许应用备份、恢复时传递参数给应用。支持异步操作，使用Promise异步回调。</p> <p>onBackupEx与onBackup互斥，如果重写onBackupEx，则优先调用onBackupEx。</p> <p>onBackupEx返回值不能为空字符串，若onBackupEx返回值为空字符串，则会尝试调用onBackup。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.8.1.5.1.1" width="25%">参数名</th> <th align="left" class="cellrowborder" id="mcps1.3.8.8.1.5.1.2" width="25%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.8.8.1.5.1.3" width="25%">必填</th> <th align="left" class="cellrowborder" id="mcps1.3.8.8.1.5.1.4" width="25%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="25%">backupInfo</td> <td class="cellrowborder" width="25%">string</td> <td class="cellrowborder" width="25%">是</td> <td class="cellrowborder" width="25%"><p>扩展恢复数据的特殊处理接口中三方应用需要传递的包信息。</p> <p>backupInfo可能为空字符串，需要开发者针对空字符串场景做判断处理。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.8.10.1.3.1.1" width="50%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.8.10.1.3.1.2" width="50%">说明</th> </tr><tr><td class="cellrowborder" width="50%">string | Promise&lt;string&gt;</td> <td class="cellrowborder" width="50%"><p>返回应用执行自定义备份操作的信息，包含备份结果和报错信息，返回值为Json格式。</p> <p>异步返回Promise对象。</p> <p>同步返回string。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>同步处理业务场景中，推荐使用示例如下。</p>  </div></div></div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ErrorInfo</span> {</li><li>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">errorCode</span>: <span class="hljs-built_in">number</span>,</li><li>  <span class="hljs-attr">errorInfo</span>: <span class="hljs-built_in">string</span></li><li>}</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onBackupEx</span>(<span class="hljs-attr">backupInfo</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (backupInfo == <span class="hljs-string">""</span>) {</li><li>        <span class="hljs-comment">//当backupInfo为空时，应用根据业务自行做处理。</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"backupInfo is empty"</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onBackupEx ok`</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorInfo</span> = {</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-string">"ErrorInfo"</span>,</li><li>        <span class="hljs-attr">errorCode</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">errorInfo</span>: <span class="hljs-string">"app customized error info"</span></li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(errorInfo);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`BackupExt error. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>异步处理业务场景中，推荐使用示例如下。</p>  </div></div></div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ErrorInfo</span> {</li><li>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">errorCode</span>: <span class="hljs-built_in">number</span>,</li><li>  <span class="hljs-attr">errorInfo</span>: <span class="hljs-built_in">string</span></li><li>}</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-comment">//异步实现</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onBackupEx</span>(<span class="hljs-attr">backupInfo</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (backupInfo == <span class="hljs-string">""</span>) {</li><li>        <span class="hljs-comment">//当backupInfo为空时，应用根据业务自行做处理。</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"backupInfo is empty"</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onBackupEx ok`</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorInfo</span> = {</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-string">"ErrorInfo"</span>,</li><li>        <span class="hljs-attr">errorCode</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">errorInfo</span>: <span class="hljs-string">"app customized error info"</span></li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(errorInfo);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`BackupExt error. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="onrestore" device-type="phone,2in1,tablet,wearable,tv">onRestore<i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onrestore" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onRestore(bundleVersion: BundleVersion): void</p> <p>Extension生命周期回调，在执行恢复数据时回调，由开发者提供扩展的恢复数据的操作。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.6.1.5.1.1" width="25%">参数名</th> <th align="left" class="cellrowborder" id="mcps1.3.9.6.1.5.1.2" width="25%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.9.6.1.5.1.3" width="25%">必填</th> <th align="left" class="cellrowborder" id="mcps1.3.9.6.1.5.1.4" width="25%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="25%">bundleVersion</td> <td class="cellrowborder" width="25%"><a href="/consumer/cn/doc/harmonyos-references/js-apis-application-backupextensionability#bundleversion">BundleVersion</a></td> <td class="cellrowborder" width="25%">是</td> <td class="cellrowborder" width="25%">恢复时应用数据所在的版本信息。</td> </tr>  </tbody></table></div> </div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRestore</span>(<span class="hljs-params">bundleVersion : BundleVersion</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRestore ok <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(bundleVersion)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="onrestoreex12" device-type="phone,2in1,tablet,wearable,tv">onRestoreEx<sup>12+</sup><i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onrestoreex12" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onRestoreEx(bundleVersion: BundleVersion, restoreInfo: string): string | Promise&lt;string&gt;</p> <p>Extension生命周期回调，在执行恢复数据时回调，由开发者提供扩展的恢复数据的操作，支持异步操作，使用Promise异步回调。</p> <p>onRestoreEx与onRestore互斥，如果重写onRestoreEx，则优先调用onRestoreEx。</p> <p>onRestoreEx返回值不能为空字符串，若onRestoreEx返回值为空字符串，则会尝试调用onRestore。</p> <p>onRestoreEx的返回值为Json格式，使用方法见示例代码。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.9.1.5.1.1" width="25%">参数名</th> <th align="left" class="cellrowborder" id="mcps1.3.10.9.1.5.1.2" width="25%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.10.9.1.5.1.3" width="25%">必填</th> <th align="left" class="cellrowborder" id="mcps1.3.10.9.1.5.1.4" width="25%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="25%">bundleVersion</td> <td class="cellrowborder" width="25%"><a href="/consumer/cn/doc/harmonyos-references/js-apis-application-backupextensionability#bundleversion">BundleVersion</a></td> <td class="cellrowborder" width="25%">是</td> <td class="cellrowborder" width="25%">恢复时应用数据所在的版本信息。</td> </tr> <tr><td class="cellrowborder" width="25%">restoreInfo</td> <td class="cellrowborder" width="25%">string</td> <td class="cellrowborder" width="25%">是</td> <td class="cellrowborder" width="25%"><p>预留字段，应用恢复过程中需要的扩展参数。</p> <p>restoreInfo可能为空字符串，需要开发者针对空字符串场景做判断处理。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.10.11.1.3.1.1" width="50%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.10.11.1.3.1.2" width="50%">说明</th> </tr><tr><td class="cellrowborder" width="50%">string | Promise&lt;string&gt;</td> <td class="cellrowborder" width="50%"><p>返回应用执行自定义恢复操作的信息，包含恢复结果和报错信息，返回值为Json格式。</p> <p>异步返回Promise对象。</p> <p>同步返回string。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>异步处理业务场景中，推荐使用示例如下。</p>  </div></div></div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ErrorInfo</span> {</li><li>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">errorCode</span>: <span class="hljs-built_in">number</span>,</li><li>  <span class="hljs-attr">errorInfo</span>: <span class="hljs-built_in">string</span></li><li>}</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-comment">// 异步实现</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRestoreEx</span>(bundleVersion : <span class="hljs-title class_">BundleVersion</span>, <span class="hljs-attr">restoreInfo</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (restoreInfo == <span class="hljs-string">""</span>) {</li><li>        <span class="hljs-comment">//当restoreInfo为空时，应用根据业务自行做处理。</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"restoreInfo is empty"</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRestoreEx ok <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(bundleVersion)}</span>`</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorInfo</span> = {</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-string">"ErrorInfo"</span>,</li><li>        <span class="hljs-attr">errorCode</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">errorInfo</span>: <span class="hljs-string">"app customized error info"</span></li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(errorInfo);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onRestoreEx error. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>同步处理业务场景中，推荐使用示例如下。</p>  </div></div></div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ErrorInfo</span> {</li><li>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">errorCode</span>: <span class="hljs-built_in">number</span>,</li><li>  <span class="hljs-attr">errorInfo</span>: <span class="hljs-built_in">string</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-comment">// 同步实现</span></li><li>  <span class="hljs-title function_">onRestoreEx</span>(bundleVersion : <span class="hljs-title class_">BundleVersion</span>, <span class="hljs-attr">restoreInfo</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (restoreInfo == <span class="hljs-string">""</span>) {</li><li>        <span class="hljs-comment">//当restoreInfo为空时，应用根据业务自行做处理。</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"restoreInfo is empty"</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRestoreEx ok <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(bundleVersion)}</span>`</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorInfo</span> = {</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-string">"ErrorInfo"</span>,</li><li>        <span class="hljs-attr">errorCode</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">errorInfo</span>: <span class="hljs-string">"app customized error info"</span></li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(errorInfo);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onRestoreEx error. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="onprocess12" device-type="phone,2in1,tablet,wearable,tv">onProcess<sup>12+</sup><i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onprocess12" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onProcess(): string</p> <p>备份恢复框架增加进度返回接口。该接口为同步接口，由应用在执行onBackup(onBackupEx)/onRestore(onRestoreEx)期间进行实现。返回应用自身处理业务的进度，返回值为json结构，使用方法见示例代码。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>返回值：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.11.6.1.3.1.1" width="50%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.11.6.1.3.1.2" width="50%">说明</th> </tr><tr><td class="cellrowborder" width="50%">string</td> <td class="cellrowborder" width="50%">返回应用onBackup或者onRestore执行过程中处理数据的进度信息（返回值为Json格式）。</td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <ul><li>onProcess可以不实现，系统有默认处理机制；若要实现，返回值结构严格按照示例代码返回。</li><li>实现onProcess时，业务需要将onBackup(onBackupEx)/onRestore(onRestoreEx)做异步实现，且需要单独开辟子线程，否则onProcess相关功能无法正常运行。具体使用方式见示例代码。</li><li>onProcess()推荐使用示例如下。</li></ul>  </div></div></div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrateProgressInfo</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">migrateProgress</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"test"</span>; <span class="hljs-comment">// appName</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">processed</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 已处理的数据</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 总数</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isPercentage</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 可选字段，true表示需要按百分比的格式化展示进度，false或者不实现该字段表示按具体项数展示进度</span></li><li>
</li><li>  <span class="hljs-title function_">getMigrateProgress</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">migrateProgress</span> = <span class="hljs-string">`{"progressInfo": [{"name": <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, "processed": <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.processed}</span>, "total": <span class="hljs-subst">${</span></span></li><li><span class="hljs-string">      <span class="hljs-variable language_">this</span>.total}</span>, "isPercentage": <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.isPercentage}</span>}]}`;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">migrateProgress</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateProcessed</span>(<span class="hljs-params">processed: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processed</span> = processed;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">progressInfo</span>: <span class="hljs-title class_">MigrateProgressInfo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MigrateProgressInfo</span>();</li><li>
</li><li>  <span class="hljs-comment">// 如下代码中，appJob方法为模拟的实际业务代码，args为appJob方法的参数，用于提交到taskpool中，开启子线程进行工作</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onBackup</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onBackup begin`</span>);</li><li>    <span class="hljs-keyword">let</span> args = <span class="hljs-number">100</span>; <span class="hljs-comment">// args为appJob方法的参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">jobTask</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">LongTask</span>(appJob, <span class="hljs-variable language_">this</span>.<span class="hljs-property">progressInfo</span>, args);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(jobTask, taskpool.<span class="hljs-property">Priority</span>.<span class="hljs-property">LOW</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"onBackup error."</span> + error.<span class="hljs-property">message</span>);</li><li>    }</li><li>    taskpool.<span class="hljs-title function_">terminateTask</span>(jobTask); <span class="hljs-comment">// 需要手动销毁</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onBackup end`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRestore</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRestore begin`</span>);</li><li>    <span class="hljs-keyword">let</span> args = <span class="hljs-number">100</span>; <span class="hljs-comment">// args为appJob方法的参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">jobTask</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">LongTask</span>(appJob, <span class="hljs-variable language_">this</span>.<span class="hljs-property">progressInfo</span>, args);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(jobTask, taskpool.<span class="hljs-property">Priority</span>.<span class="hljs-property">LOW</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"onRestore error."</span> + error.<span class="hljs-property">message</span>);</li><li>    }</li><li>    taskpool.<span class="hljs-title function_">terminateTask</span>(jobTask); <span class="hljs-comment">// 需要手动销毁</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRestore end`</span>);</li><li>  }</li><li> </li><li>
</li><li>  <span class="hljs-title function_">onProcess</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onProcess begin`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">progressInfo</span>.<span class="hljs-title function_">getMigrateProgress</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">appJob</span>(<span class="hljs-params">progressInfo: MigrateProgressInfo, args: <span class="hljs-built_in">number</span></span>) : <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`appJob begin, args is: `</span> + args);</li><li>  <span class="hljs-comment">// 在业务执行时刷新已处理进度</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">currentProcessed</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 模拟业务实际逻辑</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; args; i++) {</li><li>    currentProcessed = i;</li><li>    progressInfo.<span class="hljs-title function_">updateProcessed</span>(currentProcessed);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="onrelease20" device-type="phone,2in1,tablet,wearable,tv">onRelease<sup>20+</sup><i class="anchor-icon anchor-icon-device active" active-tips="隐藏支持设备" tips="显示支持设备"></i><i class="anchor-icon anchor-icon-link" anchorid="onrelease20" tips="复制节点链接"></i></h3><div class="device-list active"><span class="support-device-pre">支持设备</span><span class="support-device-item">Phone</span><span class="support-device-item">PC/2in1</span><span class="support-device-item">Tablet</span><span class="support-device-item">TV</span><span class="support-device-item">Wearable</span></div><p>onRelease(scenario: number): Promise&lt;void&gt;</p> <p>备份恢复框架安全退出接口。应用备份或恢复完成时回调，应用可实现备份恢复完成后的一些特殊处理，例如清理备份或恢复产生的临时文件。使用Promise异步回调。</p> <p>onRelease具有超时机制，应用若在5秒内未完成onRelease操作，将触发备份恢复结束时的应用进程退出流程。</p> <p><strong>系统能力</strong>：SystemCapability.FileManagement.StorageService.Backup</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.7.1.5.1.1" width="25%">参数名</th> <th align="left" class="cellrowborder" id="mcps1.3.12.7.1.5.1.2" width="25%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.12.7.1.5.1.3" width="25%">必填</th> <th align="left" class="cellrowborder" id="mcps1.3.12.7.1.5.1.4" width="25%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" width="25%">scenario</td> <td class="cellrowborder" width="25%">number</td> <td class="cellrowborder" width="25%">是</td> <td class="cellrowborder" width="25%"><p>表示处于备份或恢复场景。</p> <p>scenario = 1表示当前为备份场景。</p> <p>scenario = 2表示当前为恢复场景。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.12.9.1.3.1.1" width="50%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.12.9.1.3.1.2" width="50%">说明</th> </tr><tr><td class="cellrowborder" width="50%">Promise&lt;void&gt;</td> <td class="cellrowborder" width="50%">Promise对象，无返回结果。</td> </tr>  </tbody></table></div> </div> <p><strong>示例：</strong></p> <div _ngcontent-kus-c106="" class="highlight-div"><div _ngcontent-kus-c106="" class="highlight-div-header"><div _ngcontent-kus-c106="" class="highlight-div-header-left"><div _ngcontent-kus-c106="" class="handle-button expand-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kus-c106="" class="highlight-div-header-right"><div _ngcontent-kus-c106="" class="handle-button ai-button"></div><div _ngcontent-kus-c106="" class="handle-button line-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kus-c106="" class="handle-button theme-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kus-c106="" class="handle-button copy-button"><div _ngcontent-kus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kus-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 以清理文件为例</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SCENARIO_BACKUP</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SCENARIO_RESTORE</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li><li><span class="hljs-comment">// 需要清理的临时目录</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'/data/storage/el2/base/.temp/'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRelease</span>(<span class="hljs-attr">scenario</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (scenario == <span class="hljs-variable constant_">SCENARIO_BACKUP</span>) {</li><li>        <span class="hljs-comment">// 备份场景，应用自行实现处理，以清理备份产生的临时文件为例</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRelease begin`</span>);</li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">rmdir</span>(filePath);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRelease end, rmdir succeed`</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (scenario == <span class="hljs-variable constant_">SCENARIO_RESTORE</span>) {</li><li>        <span class="hljs-comment">// 恢复场景，应用自行实现处理，以清理恢复产生的临时文件为例</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRelease begin`</span>);</li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">rmdir</span>(filePath);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onRelease end, rmdir succeed`</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onRelease failed with error. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>