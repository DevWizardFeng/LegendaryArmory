<h1 _ngcontent-jjb-c119="" class="doc-title ng-star-inserted" title="Vulkan External Memory开发指导"> Vulkan External Memory开发指导 </h1>

<div _ngcontent-jjb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>VK_OHOS_external_memory 扩展用于在GPU Vulkan环境下与HarmonyOS的本机缓冲区（OHNativeBuffer）之间做零拷贝的内存共享。</p> <p>该扩展允许：把由HarmonyOS或其他组件（Camera、RenderService、视频解码器、OHNativeWindow等）创建的OHNativeBuffer导入为Vulkan内存（并绑定到VkImage/VkBuffer）。</p> <p>这可以实现视频帧、相机输出、图像解码器等在生产端与Vulkan渲染/计算端的高效共享，避免额外拷贝或像素转换。</p> <p>所以，本指导将介绍实现视频解码器与渲染器零拷贝：将解码器输出OHNativeBuffer，直接导入Vulkan。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="结构体" class="firsth2">结构体<i class="anchor-icon anchor-icon-link" anchorid="结构体" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" width="50%">描述</th> </tr><tr><td class="cellrowborder" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vknativebufferpropertiesohos">VkNativeBufferPropertiesOHOS</a></td> <td class="cellrowborder" width="50%">包含了NativeBuffer的属性。</td> </tr> <tr><td class="cellrowborder" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vknativebufferformatpropertiesohos">VkNativeBufferFormatPropertiesOHOS</a></td> <td class="cellrowborder" width="50%">包含了NativeBuffer的一些格式属性。</td> </tr> <tr><td class="cellrowborder" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vkimportnativebufferinfoohos">VkImportNativeBufferInfoOHOS</a></td> <td class="cellrowborder" width="50%">包含了OH_NativeBuffer结构体的指针。</td> </tr> <tr><td class="cellrowborder" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vkmemorygetnativebufferinfoohos">VkMemoryGetNativeBufferInfoOHOS</a></td> <td class="cellrowborder" width="50%">用于从Vulkan内存中获取OH_NativeBuffer。</td> </tr> <tr><td class="cellrowborder" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vkexternalformatohos">VkExternalFormatOHOS</a></td> <td class="cellrowborder" width="50%">表示外部定义的格式标识符。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="函数">函数<i class="anchor-icon anchor-icon-link" anchorid="函数" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="tableClass2_t"> <tbody><tr class="firstRow"><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" width="50%">描述</th> </tr><tr><td class="cellrowborder" width="50%">VKAPI_ATTR VkResult VKAPI_CALL <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-ohos-h#vkgetnativebufferpropertiesohos">vkGetNativeBufferPropertiesOHOS</a> (VkDevice device, const struct OH_NativeBuffer *buffer, <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-vulkan-vknativebufferpropertiesohos">VkNativeBufferPropertiesOHOS</a> *pProperties)</td> <td class="cellrowborder" width="50%">获取OH_NativeBuffer属性。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p>以下步骤说明了如何将视频解码器输出的本机缓冲区（OHNativeBuffer）导入为Vulkan内存，并绑定到VkImage/VkBuffer。</p> <ol><li><p>启动渲染子线程，初始化Vulkan环境，动态加载libvulkan.so, 并加载Vulkan基础函数的指针。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRenderThread</span>::<span class="hljs-title class_">ThreadMainLoop</span>() {</li><li>    <span class="hljs-variable">threadId_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">get_id</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitRenderContext</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitNativeVsync</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">CreateNativeImage</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">running_</span>) {</li><li>        {</li><li>            <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"Waiting for Vsync."</span>);</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">Lock</span>(<span class="hljs-title class_">wakeUpMutex_</span>);</li><li>            <span class="hljs-variable">wakeUpCond_</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-variable">Lock</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> <span class="hljs-variable">wakeup_</span> || <span class="hljs-variable">vSyncCnt_</span> &gt; <span class="hljs-number">0</span> || <span class="hljs-variable">availableFrameCnt_</span> &gt; <span class="hljs-number">0</span>; });</li><li>            <span class="hljs-variable">wakeup_</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">vSyncCnt_</span>--;</li><li>            (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeVSync_RequestFrame</span>(<span class="hljs-variable">nativeVsync_</span>, &amp;<span class="hljs-title class_">VulkanRenderThread</span>::<span class="hljs-title class_">OnVsync</span>, <span class="hljs-keyword">this</span>);</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">VulkanRenderTask</span>&gt; <span class="hljs-title class_">tasks</span>;</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">taskMutex_</span>);</li><li>            <span class="hljs-variable">tasks</span>.<span class="hljs-title function_">swap</span>(<span class="hljs-variable">tasks_</span>);</li><li>        }</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">auto</span> &amp;<span class="hljs-title class_">task</span> : <span class="hljs-title class_">tasks</span>) {</li><li>            <span class="hljs-title function_">task</span>(*<span class="hljs-variable">vulkanRenderContext_</span>);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">availableFrameCnt_</span> &lt;= <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-title function_">DrawImage</span>();</li><li>        <span class="hljs-variable">availableFrameCnt_</span>--;</li><li>    }</li><li>}</li></ol></pre></div></div>  <p> 动态加载libvulkan.so，并加载Vulkan基础函数的指针。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Dynamically load Vulkan library and base function pointers</span></li><li><span class="hljs-variable">bool</span> <span class="hljs-title function_">LoadVulkanLibrary</span>() {</li><li>    <span class="hljs-comment">// Load vulkan library</span></li><li>    <span class="hljs-variable">constexpr</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">path</span> = <span class="hljs-string">"libvulkan.so"</span>;</li><li>    <span class="hljs-title function_">dlerror</span>();</li><li>    <span class="hljs-variable">g_libVulkan</span> = <span class="hljs-title function_">dlopen</span>(<span class="hljs-variable">path</span>, <span class="hljs-variable">RTLD_NOW</span> | <span class="hljs-variable">RTLD_LOCAL</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">g_libVulkan</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Failed to load vulkan Library, %{public}s"</span>, <span class="hljs-title function_">dlerror</span>());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// // Load base function pointers</span></li><li>    <span class="hljs-variable">vkEnumerateInstanceExtensionProperties</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkEnumerateInstanceExtensionProperties</span>&gt;(</li><li>        <span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkEnumerateInstanceExtensionProperties"</span>));</li><li>    <span class="hljs-variable">vkEnumerateInstanceLayerProperties</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkEnumerateInstanceLayerProperties</span>&gt;(</li><li>        <span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkEnumerateInstanceLayerProperties"</span>));</li><li>    <span class="hljs-variable">vkCreateInstance</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkCreateInstance</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkCreateInstance"</span>));</li><li>    <span class="hljs-variable">vkGetInstanceProcAddr</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkGetInstanceProcAddr</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkGetInstanceProcAddr"</span>));</li><li>    <span class="hljs-variable">vkGetDeviceProcAddr</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkGetDeviceProcAddr</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkGetDeviceProcAddr"</span>));</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>创建NatvieImage对象作为OHNativeBuffer的消费端，并根据NativeImage对象获取对应的NativeWindow对象，将NativeWindow句柄传给视频编解码，作为OHNativeBuffer的生产端，用于生产视频帧内容。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulkanRenderThread::CreateNativeImage</span><span class="hljs-params">()</span> </span>{</li><li>    nativeImage_ = <span class="hljs-built_in">OH_ConsumerSurface_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (nativeImage_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"OH_NativeImage_Create failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;</li><li>    {</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">Lock</span><span class="hljs-params">(nativeImageSurfaceIdMutex_)</span></span>;</li><li>        nativeImageWindow_ = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(nativeImage_);</li><li>        ret = <span class="hljs-built_in">OH_NativeImage_GetSurfaceId</span>(nativeImage_, &amp;nativeImageSurfaceId_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>                    <span class="hljs-string">"OH_NativeImage_GetSurfaceId failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    nativeImageFrameAvailableListener_.context = <span class="hljs-keyword">this</span>;</li><li>    nativeImageFrameAvailableListener_.onFrameAvailable = &amp;VulkanRenderThread::OnNativeImageFrameAvailable;</li><li>    ret = <span class="hljs-built_in">OH_NativeImage_SetOnFrameAvailableListener</span>(nativeImage_, nativeImageFrameAvailableListener_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>                    <span class="hljs-string">"OH_NativeImage_SetonFrameAvailableListener failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>获取XComponent的NativeWindowd对象，根据NativeWindow对象创建出Vulkan环境的VkSurface，用于绘制显示内容。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VulkanRenderThread::UpdateNativeWindow</span><span class="hljs-params">(<span class="hljs-type">void</span> *window, <span class="hljs-type">uint64_t</span> width, <span class="hljs-type">uint64_t</span> height)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"UpdateNativeWindow."</span>);</li><li>    <span class="hljs-keyword">auto</span> nativeWindow = <span class="hljs-built_in">reinterpret_cast</span>&lt;OHNativeWindow *&gt;(window);</li><li>    <span class="hljs-built_in">PostTask</span>([<span class="hljs-keyword">this</span>, nativeWindow, width, height](VulkanRender &amp;renderContext) {</li><li>        <span class="hljs-keyword">if</span> (nativeWindow_ != nativeWindow) {</li><li>            <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>                (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_NativeWindow_NativeObjectUnreference</span>(nativeWindow_);</li><li>            }</li><li>            nativeWindow_ = nativeWindow;</li><li>            <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>                (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_NativeWindow_NativeObjectReference</span>(nativeWindow_);</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>            vulkanRenderContext_-&gt;<span class="hljs-built_in">SetupWindow</span>(nativeWindow_);</li><li>        }</li><li>    });</li><li>}</li></ol></pre></div></div>  <p> 同时更新初始化Vulkan的上下文，包括Vulkan的实列、选择物理设备、创建渲染管线等。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRender</span>::<span class="hljs-title class_">SetupWindow</span>(<span class="hljs-variable">NativeWindow</span> <span class="hljs-variable">*nativeWindow</span>) {</li><li>    <span class="hljs-variable">nativeWindow_</span> = <span class="hljs-variable">nativeWindow</span>;</li><li>    <span class="hljs-title function_">CreateInstance</span>();</li><li>    <span class="hljs-variable">vkExample</span>::<span class="hljs-title class_">utils</span>::<span class="hljs-title class_">LoadVulkanFunctions</span>(<span class="hljs-title class_">instance</span>);</li><li>    <span class="hljs-title function_">CreateSurface</span>();</li><li>    <span class="hljs-title function_">PickPhysicalDevice</span>();</li><li>    <span class="hljs-title function_">CreateLogicalDevice</span>();</li><li>    <span class="hljs-variable">vkExample</span>::<span class="hljs-title class_">utils</span>::<span class="hljs-title class_">LoadVulkanFunctions</span>(<span class="hljs-title class_">device</span>);</li><li>
</li><li>    <span class="hljs-title function_">createSwapChain</span>();</li><li>    <span class="hljs-title function_">createRenderPass</span>();</li><li>    <span class="hljs-title function_">createFrameBuffersAndImages</span>();</li><li>    <span class="hljs-title function_">createVertexBuffer</span>();</li><li>    <span class="hljs-title function_">createUniformBuffer</span>();</li><li>    <span class="hljs-variable">deviceInfoInitialized</span> = <span class="hljs-keyword">true</span>;</li><li>}</li></ol></pre></div></div>  <p> 通过vkCreateSurfaceOHOS()创建VkSurface对象。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulkanRender::CreateSurface</span><span class="hljs-params">()</span> </span>{</li><li>    VkSurfaceCreateInfoOHOS surfaceCreateInfo{};</li><li>    surfaceCreateInfo.sType = VK_STRUCTURE_TYPE_SURFACE_CREATE_INFO_OHOS;</li><li>    <span class="hljs-keyword">if</span> (nativeWindow_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"nativeWindow_ is nulptr.Failed to create surface !"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    surfaceCreateInfo.window = nativeWindow_;</li><li>    surfaceCreateInfo.flags = <span class="hljs-number">0</span>;</li><li>    surfaceCreateInfo.pNext = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">bool</span> res = <span class="hljs-built_in">CheckResult</span>(<span class="hljs-built_in">vkCreateSurfaceOHOS</span>(instance, &amp;surfaceCreateInfo, <span class="hljs-literal">nullptr</span>, &amp;surface));</li><li>    <span class="hljs-keyword">return</span> res;</li><li>}</li></ol></pre></div></div>  </li><li><p>初始化视频解码的环境，包括初始化解封装器、初始化解码器。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">StartPlayer</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">SampleInfo</span> <span class="hljs-variable">sampleInfo</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">4</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFd</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileOffset</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileSize</span>);</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">length</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">char</span>* <span class="hljs-variable">buf</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">char</span>[<span class="hljs-variable">length</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">memset</span>(<span class="hljs-title class_">buf</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">buf</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">buf</span>;</li><li>    <span class="hljs-variable">PluginRender</span> *<span class="hljs-variable">render</span> = <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">GetInstance</span>(<span class="hljs-keyword">type</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">render</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> == <span class="hljs-string">"Vulkan"</span>) {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">vulkanRenderThread_</span>-&gt;<span class="hljs-title class_">GetNativeImageWindow</span>();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Init</span>(<span class="hljs-title class_">sampleInfo</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>启动解码器、解码输入子线程、解码输出子线程。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Player::Start</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    <span class="hljs-type">int32_t</span> ret;</li><li>    <span class="hljs-keyword">if</span> (isStarted_ || demuxer_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Already started."</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>    </li><li>    <span class="hljs-keyword">if</span> (videoDecContext_) {</li><li>        ret = videoDecoder_-&gt;<span class="hljs-built_in">Start</span>();</li><li>        <span class="hljs-keyword">if</span> (ret != AVCODEC_SAMPLE_ERR_OK) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Video Decoder start failed"</span>);</li><li>            lock.<span class="hljs-built_in">unlock</span>();</li><li>            <span class="hljs-built_in">StartRelease</span>();</li><li>            <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>        }</li><li>        isStarted_ = <span class="hljs-literal">true</span>;</li><li>        videoDecInputThread_ = std::<span class="hljs-built_in">make_unique</span>&lt;std::thread&gt;(&amp;Player::VideoDecInputThread, <span class="hljs-keyword">this</span>);</li><li>        videoDecOutputThread_ = std::<span class="hljs-built_in">make_unique</span>&lt;std::thread&gt;(&amp;Player::VideoDecOutputThread, <span class="hljs-keyword">this</span>);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (videoDecInputThread_ == <span class="hljs-literal">nullptr</span> || videoDecOutputThread_ == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Create thread failed"</span>);</li><li>            lock.<span class="hljs-built_in">unlock</span>();</li><li>            <span class="hljs-built_in">StartRelease</span>();</li><li>            <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Succeed"</span>);</li><li>    doneCond_.<span class="hljs-built_in">notify_all</span>();</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre></div></div>  </li><li><p>在解码输入子线程中，通过解封装器读取视频数据，并交给解码器。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">VideoDecInputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder input thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;;</li><li>        }</li><li>        </li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>()) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputFrameCount</span>++;</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>
</li><li>        <span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">ReadSample</span>(<span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">GetVideoTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                            <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>
</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">PushInputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Push data failed, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>  </li><li><p>在解码输出子线程中，将解码后的视频提交给输出Surface。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">VideoDecOutputThread</span>() {</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameInterval</span> = <span class="hljs-variable">MICROSECOND</span> / <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-variable">thread_local</span> <span class="hljs-variable">auto</span> <span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>()) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>,<span class="hljs-string">"Out buffer count: %{public}u, size: %{public}d, flag: %{public}u, pts: %{public}ld"</span>,</li><li>                            <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span>,</li><li>                            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>);</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>
</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>, <span class="hljs-keyword">true</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_until</span>(<span class="hljs-variable">lastPushTime</span> <span class="hljs-variable">+ std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">microseconds</span>(<span class="hljs-title class_">sampleInfo_</span>.<span class="hljs-title class_">frameInterval</span>));</li><li>        <span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li>    }</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>}</li></ol></pre></div></div>  </li><li><p>在NativeImage有可用数据后，通过OH_NativeImage_AcquireNativeWindowBuffer()获取视频数据，并通过OH_NativeBuffer_FromNativeWindowBuffer()转化NativeBuffer的类型。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRenderThread</span>::<span class="hljs-title class_">DrawImage</span>() {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"DrawImage."</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">OHNativeWindowBuffer</span> *<span class="hljs-variable">inBuffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_NativeBuffer</span> *<span class="hljs-variable">nativeBuffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">fenceFd1</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_AcquireNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, &amp;<span class="hljs-title class_">inBuffer</span>, &amp;<span class="hljs-title class_">fenceFd1</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeWindow_NativeObjectReference</span>(<span class="hljs-variable">inBuffer</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeBuffer_FromNativeWindowBuffer</span>(<span class="hljs-variable">inBuffer</span>, &amp;<span class="hljs-title class_">nativeBuffer</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeBuffer</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_NativeWindow_NativeObjectUnreference</span>(<span class="hljs-variable">inBuffer</span>);</li><li>        <span class="hljs-title function_">OH_NativeImage_ReleaseNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">inBuffer</span>, -<span class="hljs-number">1</span>);</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"nativeBuffer is null."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_GetTransformMatrix</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">matrix_</span>);</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">transformTmp</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">ComputeTransform</span>(<span class="hljs-variable">transformTmp</span>, <span class="hljs-variable">matrix_</span>);</li><li>    <span class="hljs-variable">vulkanRenderContext_</span>-&gt;<span class="hljs-title class_">hwBufferToTexture</span>(<span class="hljs-title class_">nativeBuffer</span>, <span class="hljs-title class_">matrix_</span>);</li><li>    <span class="hljs-variable">vulkanRenderContext_</span>-&gt;<span class="hljs-title class_">render</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">lastInBuffer_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_NativeWindow_NativeObjectUnreference</span>(<span class="hljs-variable">lastInBuffer_</span>);</li><li>        <span class="hljs-title function_">OH_NativeImage_ReleaseNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">lastInBuffer_</span>, -<span class="hljs-number">1</span>);</li><li>    }</li><li>    <span class="hljs-variable">lastInBuffer_</span> = <span class="hljs-variable">inBuffer</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>Vulkan根据NativeBuffer创建对应的ImageView用于渲染显示，同时创建对应格式的采样器，将YUV格式的图像采样成RGBA的图像，用于正确的渲染显示。</p>  <div _ngcontent-jjb-c106="" class="highlight-div"><div _ngcontent-jjb-c106="" class="highlight-div-header"><div _ngcontent-jjb-c106="" class="highlight-div-header-left"><div _ngcontent-jjb-c106="" class="handle-button expand-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjb-c106="" class="highlight-div-header-right"><div _ngcontent-jjb-c106="" class="handle-button ai-button"></div><div _ngcontent-jjb-c106="" class="handle-button line-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjb-c106="" class="handle-button theme-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjb-c106="" class="handle-button copy-button"><div _ngcontent-jjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjb-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRender</span>::<span class="hljs-title class_">hwBufferToTexture</span>(<span class="hljs-variable">OH_NativeBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-title class_">float</span> <span class="hljs-title class_">transformMatrix</span>[<span class="hljs-number">16</span>]) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-number">0xFF00</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"hwBufferToTexture."</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">deviceInfoInitialized</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">UniformBufferObject</span> <span class="hljs-variable">ubo</span>{};</li><li>    <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">ubo</span>.<span class="hljs-variable">mvp</span>, <span class="hljs-variable">transformMatrix</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>) * <span class="hljs-number">16</span>);</li><li>    <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">buffersInfo</span>.<span class="hljs-variable">uniformBufferMapped</span>, &amp;<span class="hljs-title class_">ubo</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">ubo</span>));</li><li>    <span class="hljs-variable">VkNativeBufferFormatPropertiesOHOS</span> <span class="hljs-variable">nbFormatProps</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_NATIVE_BUFFER_FORMAT_PROPERTIES_OHOS</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span></li><li>    };</li><li>    <span class="hljs-variable">VkNativeBufferPropertiesOHOS</span> <span class="hljs-variable">nbProps</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_NATIVE_BUFFER_PROPERTIES_OHOS</span>,</li><li>                                            .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">nbFormatProps</span>};</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkGetNativeBufferPropertiesOHOS</span>(<span class="hljs-variable">device</span>, <span class="hljs-variable">buffer</span>, &amp;<span class="hljs-title class_">nbProps</span>));</li><li>
</li><li>    <span class="hljs-variable">VkImportNativeBufferInfoOHOS</span> <span class="hljs-variable">importBufferInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMPORT_NATIVE_BUFFER_INFO_OHOS</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>,</li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">buffer</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkMemoryDedicatedAllocateInfo</span> <span class="hljs-variable">dedicatedAllocateInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_MEMORY_DEDICATED_ALLOCATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">importBufferInfo</span>,</li><li>        .<span class="hljs-variable">image</span> = <span class="hljs-variable">VK_NULL_HANDLE</span>, <span class="hljs-comment">// wiLl be set later</span></li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">VK_NULL_HANDLE</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkPhysicalDeviceMemoryProperties</span> <span class="hljs-variable">physicalDeviceMemProps</span>;</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">foundTypeIndex</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">vkGetPhysicalDeviceMemoryProperties</span>(<span class="hljs-variable">gpuDevice</span>, &amp;<span class="hljs-title class_">physicalDeviceMemProps</span>);</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">memTypeCnt</span> = <span class="hljs-variable">physicalDeviceMemProps</span>.<span class="hljs-variable">memoryTypeCount</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">memTypeCnt</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbProps</span>.<span class="hljs-variable">memoryTypeBits</span> &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-variable">i</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">VkPhysicalDeviceMemoryProperties</span> &amp;<span class="hljs-title class_">pdmp</span> = <span class="hljs-variable">physicalDeviceMemProps</span>;</li><li>            <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">supportedFLags</span> = <span class="hljs-variable">pdmp</span>.<span class="hljs-variable">memoryTypes</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">propertyFlags</span> &amp; <span class="hljs-title class_">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>;</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">supportedFLags</span> == <span class="hljs-variable">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>) {</li><li>                <span class="hljs-variable">foundTypeIndex</span> = <span class="hljs-variable">i</span>;</li><li>                <span class="hljs-keyword">break</span>;</li><li>            }</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">VkMemoryAllocateInfo</span> <span class="hljs-variable">allocInfo</span>{</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">dedicatedAllocateInfo</span>,</li><li>        .<span class="hljs-variable">allocationSize</span> = <span class="hljs-variable">nbProps</span>.<span class="hljs-variable">allocationSize</span>,</li><li>        .<span class="hljs-variable">memoryTypeIndex</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// Memory type assigned in the next step</span></li><li>    };</li><li>
</li><li>    <span class="hljs-title function_">mapMemoryTypeToIndex</span>(<span class="hljs-variable">nbProps</span>.<span class="hljs-variable">memoryTypeBits</span>, <span class="hljs-variable">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>, &amp;<span class="hljs-title class_">allocInfo</span>.<span class="hljs-variable">memoryTypeIndex</span>);</li><li>    <span class="hljs-variable">VkExternalFormatOHOS</span> <span class="hljs-variable">externalFormat</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_EXTERNAL_FORMAT_OHOS</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">externalFormat</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> == <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">externalFormat</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">externalFormat</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">VkExternalMemoryImageCreateInfo</span> <span class="hljs-variable">externalMemoryImageInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_EXTERNAL_MEMORY_IMAGE_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalFormat</span>,</li><li>        .<span class="hljs-variable">handleTypes</span> = <span class="hljs-variable">VK_EXTERNAL_MEMORY_HANDLE_TYPE_OHOS_NATIVE_BUFFER_BIT_OHOS</span>,</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkImageUsageFlags</span> <span class="hljs-variable">usageFlags</span> = <span class="hljs-variable">VK_IMAGE_USAGE_SAMPLED_BIT</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> != <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">usageFlags</span> = <span class="hljs-variable">usageFlags</span> | <span class="hljs-variable">VK_IMAGE_USAGE_TRANSFER_SRC_BIT</span> | <span class="hljs-variable">VK_IMAGE_USAGE_TRANSFER_DST_BIT</span> |</li><li>                    <span class="hljs-variable">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT</span> | <span class="hljs-variable">VK_IMAGE_USAGE_INPUT_ATTACHMENT_BIT</span>;</li><li>    }</li><li>    <span class="hljs-variable">OH_NativeBuffer_Config</span> <span class="hljs-variable">config</span>;</li><li>    <span class="hljs-title function_">OH_NativeBuffer_GetConfig</span>(<span class="hljs-variable">buffer</span>, &amp;<span class="hljs-title class_">config</span>);</li><li>    <span class="hljs-variable">VkImageCreateInfo</span> <span class="hljs-variable">image_create_info</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalMemoryImageInfo</span>,</li><li>        .<span class="hljs-variable">flags</span> = <span class="hljs-number">0</span>,</li><li>        .<span class="hljs-variable">imageType</span> = <span class="hljs-variable">VK_IMAGE_TYPE_2D</span>,</li><li>        .<span class="hljs-variable">format</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span>,</li><li>        .<span class="hljs-variable">extent</span> = {<span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span>&gt;(<span class="hljs-variable">config</span>.<span class="hljs-variable">width</span>), <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span>&gt;(<span class="hljs-variable">config</span>.<span class="hljs-variable">height</span>), <span class="hljs-number">1</span>},</li><li>        .<span class="hljs-variable">mipLevels</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">arrayLayers</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">samples</span> = <span class="hljs-variable">VK_SAMPLE_COUNT_1_BIT</span>,</li><li>        .<span class="hljs-variable">tiling</span> = <span class="hljs-variable">VK_IMAGE_TILING_OPTIMAL</span>,</li><li>        .<span class="hljs-variable">usage</span> = <span class="hljs-variable">usageFlags</span>,</li><li>        .<span class="hljs-variable">sharingMode</span> = <span class="hljs-variable">VK_SHARING_MODE_EXCLUSIVE</span>,</li><li>        .<span class="hljs-variable">queueFamilyIndexCount</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">pQueueFamilyIndices</span> = &amp;<span class="hljs-title class_">queueFamilyIndex_</span>,</li><li>        <span class="hljs-comment">// VK_IMAGE_LAYOUT_UNDEFINED is mandatory when using external memory</span></li><li>        .<span class="hljs-variable">initialLayout</span> = <span class="hljs-variable">VK_IMAGE_LAYOUT_UNDEFINED</span></li><li>    };</li><li>
</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateImage</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">image_create_info</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureImage</span>));</li><li>    <span class="hljs-variable">dedicatedAllocateInfo</span>.<span class="hljs-variable">image</span> = <span class="hljs-variable">externalTextureImage</span>;</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkAllocateMemory</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">allocInfo</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureMemory</span>));</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkBindImageMemory</span>(<span class="hljs-variable">device</span>, <span class="hljs-variable">externalTextureImage</span>, <span class="hljs-variable">externalTextureMemory</span>, <span class="hljs-number">0</span>));</li><li>
</li><li>    <span class="hljs-variable">VkSamplerYcbcrConversionCreateInfo</span> <span class="hljs-variable">ycbcrCreateInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_YCBCR_CONVERSION_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">ycbcrRange</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYcbcrRange</span>,</li><li>        .<span class="hljs-variable">components</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">samplerYcbcrConversionComponents</span>,</li><li>        .<span class="hljs-variable">xChromaOffset</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedXChromaOffset</span>,</li><li>        .<span class="hljs-variable">yChromaOffset</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYChromaOffset</span>,</li><li>        .<span class="hljs-variable">chromaFilter</span> = <span class="hljs-variable">VK_FILTER_LINEAR</span>,</li><li>        .<span class="hljs-variable">forceExplicitReconstruction</span> = <span class="hljs-keyword">false</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> == <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalFormat</span>;</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">format</span> = <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>;</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">ycbcrModel</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYcbcrModel</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">CheckResult</span>(</li><li>        <span class="hljs-title function_">vkCreateSamplerYcbcrConversion</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">ycbcrCreateInfo</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">ycbcrConversion</span>));</li><li>
</li><li>    <span class="hljs-variable">VkSamplerYcbcrConversionInfo</span> <span class="hljs-variable">convInfoWrap</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_YCBCR_CONVERSION_INFO</span>,</li><li>        .<span class="hljs-variable">conversion</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">ycbcrConversion</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>,</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkImageViewCreateInfo</span> <span class="hljs-variable">view</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">convInfoWrap</span>,</li><li>        .<span class="hljs-variable">flags</span> = <span class="hljs-number">0</span>,</li><li>        .<span class="hljs-variable">image</span> = <span class="hljs-variable">externalTextureImage</span>,</li><li>        .<span class="hljs-variable">viewType</span> = <span class="hljs-variable">VK_IMAGE_VIEW_TYPE_2D</span>,</li><li>        .<span class="hljs-variable">format</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span>,</li><li>        .<span class="hljs-variable">components</span> =</li><li>            {</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span></li><li>            },</li><li>        .<span class="hljs-variable">subresourceRange</span> = {<span class="hljs-variable">VK_IMAGE_ASPECT_COLOR_BIT</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>},</li><li>    };</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateImageView</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">view</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">view</span>));</li><li>
</li><li>    <span class="hljs-comment">// Create sampler</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">VkSamplerCreateInfo</span> <span class="hljs-variable">sampler</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">convInfoWrap</span>,</li><li>        .<span class="hljs-variable">magFilter</span> = <span class="hljs-variable">VK_FILTER_NEAREST</span>,</li><li>        .<span class="hljs-variable">minFilter</span> = <span class="hljs-variable">VK_FILTER_NEAREST</span>,</li><li>        .<span class="hljs-variable">mipmapMode</span> = <span class="hljs-variable">VK_SAMPLER_MIPMAP_MODE_NEAREST</span>,</li><li>        .<span class="hljs-variable">addressModeU</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">addressModeV</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">addressModeW</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">mipLodBias</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">compareEnable</span> = <span class="hljs-variable">VK_FALSE</span>,</li><li>        .<span class="hljs-variable">anisotropyEnable</span> = <span class="hljs-variable">VK_FALSE</span>,</li><li>        .<span class="hljs-variable">maxAnisotropy</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">compareOp</span> = <span class="hljs-variable">VK_COMPARE_OP_NEVER</span>,</li><li>        .<span class="hljs-variable">minLod</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">maxLod</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">borderColor</span> = <span class="hljs-variable">VK_BORDER_COLOR_FLOAT_OPAQUE_WHITE</span>,</li><li>        .<span class="hljs-variable">unnormalizedCoordinates</span> = <span class="hljs-variable">VK_FALSE</span></li><li>    };</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateSampler</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">sampler</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">sampler</span>));</li><li>
</li><li>    <span class="hljs-title function_">createDescriptorSetLayout</span>();</li><li>    <span class="hljs-title function_">createDescriptorSet</span>();</li><li>
</li><li>    <span class="hljs-variable">VkDescriptorImageInfo</span> <span class="hljs-variable">imageInfo</span> = {</li><li>        .<span class="hljs-variable">sampler</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">sampler</span>,</li><li>        .<span class="hljs-variable">imageView</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">view</span>,</li><li>        .<span class="hljs-variable">imageLayout</span> = <span class="hljs-variable">VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkDescriptorBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = {</li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">buffersInfo</span>.<span class="hljs-variable">uniformBuf</span>, .<span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>, .<span class="hljs-variable">range</span> = <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">UniformBufferObject</span>)};</li><li>    <span class="hljs-variable">VkWriteDescriptorSet</span> <span class="hljs-variable">bufferWrite</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET</span>,</li><li>                                        .<span class="hljs-variable">dstSet</span> = <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descSet</span>,</li><li>                                        .<span class="hljs-variable">dstBinding</span> = <span class="hljs-number">0</span>,</li><li>                                        .<span class="hljs-variable">dstArrayElement</span> = <span class="hljs-number">0</span>,</li><li>                                        .<span class="hljs-variable">descriptorCount</span> = <span class="hljs-number">1</span>,</li><li>                                        .<span class="hljs-variable">descriptorType</span> = <span class="hljs-variable">VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER</span>,</li><li>                                        .<span class="hljs-variable">pImageInfo</span> = <span class="hljs-variable">nullptr</span>,</li><li>                                        .<span class="hljs-variable">pBufferInfo</span> = &amp;<span class="hljs-title class_">bufferInfo</span>,</li><li>                                        .<span class="hljs-variable">pTexelBufferView</span> = <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">VkWriteDescriptorSet</span> <span class="hljs-variable">imageWrite</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET</span>,</li><li>                                    .<span class="hljs-variable">dstSet</span> = <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descSet</span>,</li><li>                                    .<span class="hljs-variable">dstBinding</span> = <span class="hljs-number">1</span>,</li><li>                                    .<span class="hljs-variable">dstArrayElement</span> = <span class="hljs-number">0</span>,</li><li>                                    .<span class="hljs-variable">descriptorCount</span> = <span class="hljs-number">1</span>,</li><li>                                    .<span class="hljs-variable">descriptorType</span> = <span class="hljs-variable">VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER</span>,</li><li>                                    .<span class="hljs-variable">pImageInfo</span> = &amp;<span class="hljs-title class_">imageInfo</span>,</li><li>                                    .<span class="hljs-variable">pBufferInfo</span> = <span class="hljs-variable">nullptr</span>,</li><li>                                    .<span class="hljs-variable">pTexelBufferView</span> = <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>[<span class="hljs-number">0</span>] = <span class="hljs-variable">bufferWrite</span>;</li><li>    <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>[<span class="hljs-number">1</span>] = <span class="hljs-variable">imageWrite</span>;</li><li>    <span class="hljs-title function_">vkUpdateDescriptorSets</span>(<span class="hljs-variable">device</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-title function_">createGraphicsPipeline</span>();</li><li>    <span class="hljs-title function_">createOtherStaff</span>();</li><li>
</li><li>    <span class="hljs-title function_">recordCommandBuffer</span>();</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"hwBufferToTexture end"</span>);</li><li>}</li></ol></pre></div></div>  </li></ol> </div>  </div> <div></div></div>