<h1 _ngcontent-fos-c119="" class="doc-title ng-star-inserted" title="Vulkan Surface开发指导"> Vulkan Surface开发指导 </h1>

<div _ngcontent-fos-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>在HarmonyOS中，扩展VK_OHOS_surface相关的API创建出来的VkSurfaceKHR会对接到本机窗口（OHNativeWindow）模块，实现本机缓冲区（OHNativeBuffer）的轮转，用于屏幕显示。</p>     <p>创建VkSurfaceKHR对象需要通过OHNativeWindow，而OHNativeWindow需要从XComponent中获取，所以此场景下需要配合XComponent模块和NativeWindow模块一起使用。XComponent模块的具体使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines" target="_blank">XComponent开发指导</a>。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="tableClass2_t">                      <tbody><tr class="firstRow">         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" width="50%">描述</th>        </tr><tr>         <td class="cellrowborder" width="50%">vkCreateSurfaceOHOS (VkInstance instance, const VkSurfaceCreateInfoOHOS* pCreateInfo, const VkAllocationCallbacks* pAllocator, VkSurfaceKHR* pSurface)</td>         <td class="cellrowborder" width="50%">创建VkSurfaceKHR对象。</td>        </tr>             </tbody></table></div>     </div>     <p>更多的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/vulkan">Vulkan</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下步骤说明了如何创建一个VkSurfaceKHR对象。</p>     <p><strong>HarmonyOS平台宏</strong></p>     <p>使用平台扩展的接口，需要定义一个宏VK_USE_PLATFORM_OHOS，我们在CMakeLists.txt定义这个宏。</p>     <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" data-highlighted="yes"><ol class="linenums"><li>ADD_DEFINITIONS(-DVK_USE_PLATFORM_OHOS=1)</li></ol></pre></div></div>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加Vulkan的lib和周边模块的lib。</p>     <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" data-highlighted="yes"><ol class="linenums"><li>libvulkan.so</li><li>libace_ndk.z.so</li><li>libnative_window.so</li><li>libnative_image.so</li><li>libnative_buffer.so</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>在程序中通过dlopen函数链接libvulkan.so动态库时不需要在CMake中增加依赖，否则会导致符号冲突。</p>      </div></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ace/xcomponent/native_interface_xcomponent.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_window/external_window.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vulkan/vulkan.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p><strong>首先需要创建一个Vulkan实例</strong>。</p>       <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">VkInstance</span> <span class="hljs-variable">instance</span> = <span class="hljs-variable">VK_NULL_HANDLE</span>;</li><li>
</li><li><span class="hljs-variable">VkApplicationInfo</span> <span class="hljs-variable">appInfo</span> = {};</li><li><span class="hljs-variable">appInfo</span>.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_APPLICATION_INFO</span>;</li><li><span class="hljs-variable">appInfo</span>.<span class="hljs-variable">pApplicationName</span> = <span class="hljs-string">"vulkanExample"</span>;</li><li><span class="hljs-variable">appInfo</span>.<span class="hljs-variable">pEngineName</span> = <span class="hljs-string">"vulkanExample"</span>;</li><li><span class="hljs-variable">appInfo</span>.<span class="hljs-variable">apiVersion</span> = <span class="hljs-variable">VK_API_VERSION_1_3</span>;</li><li>
</li><li><span class="hljs-variable">VkInstanceCreateInfo</span> <span class="hljs-variable">instanceCreateInfo</span> = {};</li><li><span class="hljs-variable">instanceCreateInfo</span>.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO</span>;</li><li><span class="hljs-variable">instanceCreateInfo</span>.<span class="hljs-variable">pNext</span> = <span class="hljs-variable">NULL</span>;</li><li><span class="hljs-variable">instanceCreateInfo</span>.<span class="hljs-variable">pApplicationInfo</span> = &amp;<span class="hljs-title class_">appInfo</span>;</li><li>
</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-title class_">char</span> *&gt; <span class="hljs-title class_">instanceExtensions</span> = {</li><li>    <span class="hljs-variable">VK_KHR_SURFACE_EXTENSION_NAME</span>,</li><li>    <span class="hljs-variable">VK_OHOS_SURFACE_EXTENSION_NAME</span> <span class="hljs-comment">// Surface扩展</span></li><li>};</li><li><span class="hljs-variable">instanceCreateInfo</span>.<span class="hljs-variable">enabledExtensionCount</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span>&gt;(<span class="hljs-variable">instanceExtensions</span>.<span class="hljs-title function_">size</span>());</li><li><span class="hljs-variable">instanceCreateInfo</span>.<span class="hljs-variable">ppEnabledExtensionNames</span> = <span class="hljs-variable">instanceExtensions</span>.<span class="hljs-title function_">data</span>();</li><li>
</li><li><span class="hljs-title function_">vkCreateInstance</span>(&amp;<span class="hljs-title class_">instanceCreateInfo</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">instance</span>);</li></ol></pre></div></div></li>      <li>       <p><strong>获取OHNativeWindow</strong>。</p>       <p>OHNativeWindow需要从XComponent组件中获取，下面提供一份从XComponent组件中获取OHNativeWindow的代码示例，XComponent模块的具体使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines" target="_blank">XComponent模块的介绍文档</a>。</p>       <ol>        <li>         <p>ets/pages/Index.ets中增加一个XComponent组件。</p>         <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">XComponent</span>({</li><li>    <span class="hljs-attr">id</span>: <span class="hljs-string">'xcomponentId'</span>,</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-string">'surface'</span>,</li><li>    <span class="hljs-attr">libraryname</span>: <span class="hljs-string">'entry'</span></li><li>})</li><li>.<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-number">360</span>)</li><li>.<span class="hljs-title function_">height</span>(<span class="hljs-number">360</span>)</li></ol></pre></div></div></li>        <li>         <p>从XComponent组件中获取OHNativeWindow。</p>         <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// XComponent在创建Suface时的回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnSurfaceCreatedCB</span><span class="hljs-params">(OH_NativeXComponent *component, <span class="hljs-type">void</span> *window)</span> </span>{</li><li>    <span class="hljs-comment">// 在回调函数里可以拿到OHNativeWindow</span></li><li>    OHNativeWindow *nativeWindow = <span class="hljs-built_in">static_cast</span>&lt;OHNativeWindow *&gt;(window);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>
</li><li>    napi_value exportInstance = <span class="hljs-literal">nullptr</span>;</li><li>    OH_NativeXComponent *nativeXComponent = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 获取nativeXComponent</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, exports, OH_NATIVE_XCOMPONENT_OBJ, &amp;exportInstance);</li><li>    <span class="hljs-built_in">napi_unwrap</span>(env, exportInstance, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> **&gt;(&amp;nativeXComponent));</li><li>    <span class="hljs-comment">// 获取XComponentId</span></li><li>    <span class="hljs-type">char</span> idStr[OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>] = {};</li><li>    <span class="hljs-type">uint64_t</span> idSize = OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-built_in">OH_NativeXComponent_GetXComponentId</span>(nativeXComponent, idStr, &amp;idSize);</li><li>
</li><li>    <span class="hljs-comment">// 声明一个XComponent的Callback</span></li><li>    OH_NativeXComponent_Callback callback;</li><li>    <span class="hljs-comment">// 注册OnSurfaceCreated回调函数</span></li><li>    callback.OnSurfaceCreated = OnSurfaceCreatedCB;</li><li>    <span class="hljs-comment">// 将callback注册给nativeXComponent</span></li><li>    <span class="hljs-built_in">OH_NativeXComponent_RegisterCallback</span>(nativeXComponent, &amp;callback);</li><li>
</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div></li>       </ol></li>      <li>       <p><strong>创建VkSurfaceKHR对象</strong>。</p>       <div _ngcontent-fos-c106="" class="highlight-div"><div _ngcontent-fos-c106="" class="highlight-div-header"><div _ngcontent-fos-c106="" class="highlight-div-header-left"><div _ngcontent-fos-c106="" class="handle-button expand-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fos-c106="" class="highlight-div-header-right"><div _ngcontent-fos-c106="" class="handle-button ai-button"></div><div _ngcontent-fos-c106="" class="handle-button line-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fos-c106="" class="handle-button theme-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fos-c106="" class="handle-button copy-button"><div _ngcontent-fos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fos-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">VkSurfaceKHR</span> <span class="hljs-variable">surface</span> <span class="hljs-operator">=</span> VK_NULL_HANDLE;</li><li><span class="hljs-type">VkSurfaceCreateInfoOHOS</span> <span class="hljs-variable">surfaceCreateInfo</span> <span class="hljs-operator">=</span> {};</li><li>surfaceCreateInfo.sType = VK_STRUCTURE_TYPE_SURFACE_CREATE_INFO_OHOS;</li><li>surfaceCreateInfo.window = nativeWindow; <span class="hljs-comment">// 这里的nativeWindow就是从上一步骤OnSurfaceCreatedCB回调函数中拿到的</span></li><li><span class="hljs-type">int</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> vkCreateSurfaceOHOS(instance, &amp;surfaceCreateInfo, NULL, &amp;surface);</li><li><span class="hljs-keyword">if</span> (err != VK_SUCCESS) {</li><li>    <span class="hljs-comment">// Create Surface Failed.</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>