<h1 _ngcontent-sjc-c119="" class="doc-title ng-star-inserted" title="libuv"> libuv </h1>

<div _ngcontent-sjc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p><a href="http://libuv.org/" target="_blank">libuv</a>是一个跨平台库，基于事件驱动来实现异步I/O，适用于网络编程和文件系统操作。它是Node.js的核心库之一，也被其他语言的开发者广泛使用。</p>    </div>    <div class="tiledSection">     <h2 id="支持的能力">支持的能力<i class="anchor-icon anchor-icon-link" anchorid="支持的能力" tips="复制节点链接"></i></h2>          <p><a href="http://libuv.org/" target="_blank">libuv</a>实现了跨平台的基于事件驱动的异步I/O。</p>     <p>支持标准库接口。</p>    </div>    <div class="tiledSection">     <h2 id="引入libuv能力">引入libuv能力<i class="anchor-icon anchor-icon-link" anchorid="引入libuv能力" tips="复制节点链接"></i></h2>          <p>如果开发者需要使用libuv相关功能，首先请添加头文件：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li></ol></pre></div></div>     <p>其次在CMakeLists.txt中添加以下动态链接库：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>libuv.so</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="接口列表">接口列表<i class="anchor-icon anchor-icon-link" anchorid="接口列表" tips="复制节点链接"></i></h2>          <p>详见<a href="http://docs.libuv.org/en/v1.x/api.html" target="_blank">libuv支持的API文档</a>。</p>    </div>    <div class="tiledSection">     <h2 id="harmonyos引入libuv的背景">HarmonyOS引入libuv的背景<i class="anchor-icon anchor-icon-link" anchorid="harmonyos引入libuv的背景" tips="复制节点链接"></i></h2>          <p>在HarmonyOS的早期版本中，为了兼容Node.js的生态，将Node.js的Node-API引入到系统中，方便Node.js开发者快速接入HarmonyOS，扩展自己的JS接口。同时引入了Node.js的事件循环实现库——libuv。</p>    </div>    <div class="tiledSection">     <h3 id="演进方向" class="firsth2">演进方向<i class="anchor-icon anchor-icon-link" anchorid="演进方向" tips="复制节点链接"></i></h3>          <p>随着HarmonyOS的逐步完善，我们计划在未来的版本中，逐步将应用模型中的事件循环归一，并增强HarmonyOS自身的事件循环，以解决许多双loop机制下的调度问题，并为开发者提供更加完善的任务优先级、插队等与任务主循环交互的方法。</p>     <p>开发者应尽可能避免在napi_get_uv_event_loop接口获取的应用主loop上使用libuv的ndk进行操作，因为这可能会带来各种问题，并给未来的兼容性变更带来大量的工作量。</p>     <p>如果开发者希望跟主线程事件循环交互，比如插入任务等，应当使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-data-types-interfaces" target="_blank">Node-API提供的接口</a>。</p>     <p>HarmonyOS还将长期通过Node-API来为开发者提供和主线程交互及扩展JS接口的能力，但会屏蔽实现层使用的事件循环。Node-API的主要功能接口将会长期维护，并保证与Node.js的原生行为一致，来保证熟悉Node.js的扩展机制的开发者方便地将自己的已有代码接入到HarmonyOS中来。</p>     <p>如果开发者对libuv非常熟悉，并自信能够处理好所有的内存管理和多线程问题，那么仍可以像使用原生libuv一样，自己启动线程，并在上面使用libuv完成自己的业务。在没有特殊版本要求的情况下，开发者不需要额外引入libuv库到自己的应用工程中。</p>    </div>    <div class="tiledSection">     <h2 id="当前问题和解决方案">当前问题和解决方案<i class="anchor-icon anchor-icon-link" anchorid="当前问题和解决方案" tips="复制节点链接"></i></h2>          <p>根据现有机制，一个线程上只能存在一个事件循环，为了适配系统应用的主事件循环，在主线程上的JS环境中，uvloop中的事件处理是由主事件循环监听其fd，触发一次uv_run来驱动的。因此部分依赖uvloop事件循环的功能无法生效。</p>     <p>基于上述，比较常用的场景和解决方案有：</p>    </div>    <div class="tiledSection">     <h3 id="场景一在js主线程抛异步任务到工作线程执行在主线程中执行js代码处理返回结果" class="firsth2">场景一、在JS主线程抛异步任务到工作线程执行，在主线程中执行JS代码处理返回结果<i class="anchor-icon anchor-icon-link" anchorid="场景一在js主线程抛异步任务到工作线程执行在主线程中执行js代码处理返回结果" tips="复制节点链接"></i></h3>          <p><strong>错误示例：</strong></p>     <p>在Native侧直接通过调用napi_get_uv_event_loop接口获取系统loop，调用libuv NDK接口实现相关功能。</p>     <p>ArkTS侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"test"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">test</span>();</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0X0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">uv_work_t</span>* work)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in execute"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">complete</span><span class="hljs-params">(<span class="hljs-type">uv_work_t</span>* work, <span class="hljs-type">int</span> status)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in complete"</span>);</li><li>    <span class="hljs-keyword">delete</span> work;</li><li>}</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    uv_loop_s* loop = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">/* 获取应用JS主线程的uv_loop */</span></li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>    <span class="hljs-type">uv_work_t</span>* work = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_work_t</span>;</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">uv_queue_work</span>(loop, work, execute, complete);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"delete work"</span>);</li><li>        <span class="hljs-keyword">delete</span> work;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"test"</span>, <span class="hljs-literal">nullptr</span>, Test, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts文件中添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">test</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>     <p><strong>正确示例：</strong></p>     <p>可通过napi_create_async_work、napi_queue_async_work搭配使用。</p>     <p>ArkTS侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"test"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">test</span>();</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0X0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>napi_value jsCb;</li><li><span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value work_name;</li><li>    napi_async_work work;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"ohos"</span>, NAPI_AUTO_LENGTH, &amp;work_name);</li><li>    <span class="hljs-comment">/* 第四个参数是异步线程的work任务，第五个参数为主线程的回调 */</span></li><li>    <span class="hljs-built_in">napi_create_async_work</span>(</li><li>        env, <span class="hljs-literal">nullptr</span>, work_name, [](napi_env env, <span class="hljs-type">void</span>* data){<span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in execute"</span>); },</li><li>        [](napi_env env, napi_status status, <span class="hljs-type">void</span>* data){</li><li>            <span class="hljs-comment">/* 不关心具体实现 */</span></li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in complete"</span>);</li><li>            <span class="hljs-built_in">napi_delete_async_work</span>(env, (napi_async_work)data);</li><li>        },</li><li>        <span class="hljs-literal">nullptr</span>, &amp;work);</li><li>    <span class="hljs-comment">/* 通过napi_queue_async_work触发异步任务执行 */</span></li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, work);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"test"</span>, <span class="hljs-literal">nullptr</span>, Test, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts文件中添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">test</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="场景二在native侧向应用主循环抛fd事件接口无法生效">场景二、在Native侧向应用主循环抛fd事件，接口无法生效<i class="anchor-icon anchor-icon-link" anchorid="场景二在native侧向应用主循环抛fd事件接口无法生效" tips="复制节点链接"></i></h3>          <p>由于应用主循环仅仅接收fd事件，在监听了uvloop中的backend_fd后，只有该fd事件被触发才会执行一次uv_run。这就意味着，在应用主循环中调用uv接口，如果不触发一次fd事件，uv_run将永远不会被执行，最后导致libuv的接口正常调用时不生效（仅当应用中没有触发uvloop中的fd事件时）。</p>     <p><strong>错误示例：</strong></p>     <p>我们以uv_poll_start接口举例，来说明在HarmonyOS中，我们像使用原生libuv一样调用uv_poll_start接口时无法生效的问题。</p>     <p>ArkTS侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testClose"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testClose</span>();</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0X0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/eventfd.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>napi_value jsCb;</li><li><span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">poll_handler</span><span class="hljs-params">(<span class="hljs-type">uv_poll_t</span>* handle,<span class="hljs-type">int</span> status, <span class="hljs-type">int</span> events)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos poll print"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestClose</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::thread::id this_id = std::this_thread::<span class="hljs-built_in">get_id</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos thread id : %{public}ld"</span>, this_id);</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value workBname;</li><li>    </li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"test"</span>, NAPI_AUTO_LENGTH, &amp;workBname);</li><li>    </li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;jsCb, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取事件循环</span></li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>    <span class="hljs-comment">// 创建一个eventfd</span></li><li>    fd = <span class="hljs-built_in">eventfd</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"fd is %{public}d"</span>,fd);</li><li>    <span class="hljs-type">uv_poll_t</span>* poll_handle = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_poll_t</span>;</li><li>    <span class="hljs-comment">// 初始化一个poll句柄，并将其与eventfd关联</span></li><li>    <span class="hljs-built_in">uv_poll_init</span>(loop, poll_handle, fd);</li><li>    <span class="hljs-comment">// 开始监听poll事件</span></li><li>    <span class="hljs-built_in">uv_poll_start</span>(poll_handle, UV_READABLE, poll_handler);</li><li>    <span class="hljs-comment">// 创建一个新线程，向eventfd写入数据</span></li><li>    <span class="hljs-function">std::thread <span class="hljs-title">mythread</span><span class="hljs-params">([](){</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++){</span></li><li><span class="hljs-function">            <span class="hljs-type">int</span> value = <span class="hljs-number">10</span>;</span></li><li><span class="hljs-function">            <span class="hljs-type">int</span> ret = eventfd_write(fd, value);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>){</span></li><li><span class="hljs-function">                OH_LOG_INFO(LOG_APP, <span class="hljs-string">"write failed!"</span>);</span></li><li><span class="hljs-function">                <span class="hljs-keyword">continue</span>;</span></li><li><span class="hljs-function">            }</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">    })</span>;</li><li>    mythread.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"testClose"</span>, <span class="hljs-literal">nullptr</span>, TestClose, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testClose</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>     <p>在上述代码中，流程如下：</p>     <ol>      <li>首先通过napi_get_uv_event_loop接口获取到应用主线程的uvloop。</li>      <li>然后创建一个eventfd。</li>      <li>初始化uv_poll_t，并启动该句柄使其生效，在eventfd可读时触发回调函数poll_handler。</li>      <li>新开一个线程，向eventfd里写入字符。</li>     </ol>     <p>执行上述代码，poll_handler并不能正常打印。这是由于应用主线程是靠fd驱动来执行uv_run的，而非以UV_RUN_DEFAULT模式来进行循环。尽管uvloop中的backend_fd已经被event_handler监听，但是当执行uv_poll_start的时候，fd并未通过epoll_ctl加入到backend_fd中被其监听，<strong>而是在下一次uv_run中的uv__io_poll这个函数才会执行epoll_ctl函数。因此，如果应用进程中没有其他触发backend_fd事件的时候，libuv接口的正常使用可能不会达到开发者的预期。</strong></p>     <p><strong>临时方案：</strong></p>     <p>在当下的系统版本中，我们并不推荐开发者直接通过napi_get_uv_event_loop获取应用主线程的uvloop进行业务逻辑的开发。如果当前Node-API的接口无法满足开发者的开发需求，确有必要使用libuv来实现业务功能，为了使libuv接口在主线程上生效，开发者可以在调用类似uv_xxx_start后，执行一次uv_async_send的方式来主动触发应用主线程执行一次uv_run。这样可以保证该接口生效并正常执行。</p>     <p>针对上述无法生效的代码示例，可以修改如下使其生效。</p>     <p>ArkTS侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testClose"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testClose</span>();</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧:</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/eventfd.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>napi_value jsCb;</li><li><span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">poll_handler</span><span class="hljs-params">(<span class="hljs-type">uv_poll_t</span>* handle,<span class="hljs-type">int</span> status, <span class="hljs-type">int</span> events)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos poll print"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestClose</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::thread::id this_id = std::this_thread::<span class="hljs-built_in">get_id</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos thread id : %{public}ld"</span>, this_id);</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value workBName;</li><li>    </li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"test"</span>, NAPI_AUTO_LENGTH, &amp;workBName);</li><li>    </li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;jsCb, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>
</li><li>    fd = <span class="hljs-built_in">eventfd</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"fd is %{public}d"</span>,fd);</li><li>    <span class="hljs-type">uv_poll_t</span>* poll_handle = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_poll_t</span>;</li><li>    <span class="hljs-built_in">uv_poll_init</span>(loop, poll_handle, fd);</li><li>    <span class="hljs-built_in">uv_poll_start</span>(poll_handle, UV_READABLE, poll_handler);</li><li>
</li><li>    <span class="hljs-comment">// 主动触发一次fd事件，让主线程执行一次uv_run</span></li><li>    <span class="hljs-built_in">uv_async_send</span>(&amp;loop-&gt;wq_async);</li><li>    </li><li>    <span class="hljs-function">std::thread <span class="hljs-title">mythread</span><span class="hljs-params">([](){</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++){</span></li><li><span class="hljs-function">            <span class="hljs-type">int</span> value = <span class="hljs-number">10</span>;</span></li><li><span class="hljs-function">            <span class="hljs-type">int</span> ret = eventfd_write(fd, value);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>){</span></li><li><span class="hljs-function">                OH_LOG_INFO(LOG_APP, <span class="hljs-string">"write failed!"</span>);</span></li><li><span class="hljs-function">                <span class="hljs-keyword">continue</span>;</span></li><li><span class="hljs-function">            }</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">    })</span>;</li><li>    mythread.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"testClose"</span>, <span class="hljs-literal">nullptr</span>, TestClose, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testClose</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="libuv使用指导">libuv使用指导<i class="anchor-icon anchor-icon-link" anchorid="libuv使用指导" tips="复制节点链接"></i></h2>          <p><strong>重要：libuv NDK中所有依赖uv_run的接口在当前系统的应用主循环中无法及时生效，并且可能会导致卡顿掉帧的现象。因此不建议直接在JS主线程上使用libuv NDK接口，对于异步任务执行及与使用线程安全函数与主线程通信，开发者可以直接调用Node-API接口来实现相关功能。</strong></p>    </div>    <div class="tiledSection">     <h3 id="libuv接口与node-api接口对应关系" class="firsth2">libuv接口与Node-API接口对应关系<i class="anchor-icon anchor-icon-link" anchorid="libuv接口与node-api接口对应关系" tips="复制节点链接"></i></h3>          <p>当前HarmonyOS提供了一些Node-API接口，可以替换libuv接口的使用。主要包括异步任务相关接口，线程安全的函数调用接口。</p>     <p><strong>1. 异步任务接口</strong></p>     <p>当开发者需要执行一个比较耗时的操作但又不希望阻塞主线程执行时，libuv提供了底层接口uv_queue_work帮助开发者在异步线程中执行耗时操作，然后将结果回调到主线程上进行处理。</p>     <p>在Node-API中，通常可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-asynchronous-task" target="_blank">napi_async_work</a>相关函数来实现异步开发的功能。</p>     <p>相关函数为：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 创建一个新的异步工作</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param env 指向当前环境的指针</span></li><li><span class="hljs-comment">* @param async_resource 可选的资源对象，用于跟踪异步操作</span></li><li><span class="hljs-comment">* @param async_resource_name 可选的字符串，用于描述异步资源</span></li><li><span class="hljs-comment">* @param execute 一个回调函数，它将在一个新的线程中执行异步操作</span></li><li><span class="hljs-comment">* @param complete 一个回调函数，它将在异步操作完成后被调用</span></li><li><span class="hljs-comment">* @param data 用户定义的数据，它将被传递给execute和complete回调函数</span></li><li><span class="hljs-comment">* @param result 指向新创建的异步工作的指针</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_create_async_work</span><span class="hljs-params">(napi_env env,</span></span></li><li><span class="hljs-function">                                  napi_value async_resource,</span></li><li><span class="hljs-function">                                  napi_value async_resource_name,</span></li><li><span class="hljs-function">                                  napi_async_execute_callback execute,</span></li><li><span class="hljs-function">                                  napi_async_complete_callback complete,</span></li><li><span class="hljs-function">                                  <span class="hljs-type">void</span>* data,</span></li><li><span class="hljs-function">                                  napi_async_work* result)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 将异步工作添加到队列中</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param env 指向当前环境的指针</span></li><li><span class="hljs-comment">* @param work 指向异步工作的指针</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_queue_async_work</span><span class="hljs-params">(napi_env env, napi_async_work work)</span></span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 删除异步工作</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param env 指向当前环境的指针</span></li><li><span class="hljs-comment">* @param work 指向异步工作的指针</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_delete_async_work</span><span class="hljs-params">(napi_env env, napi_async_work work)</span></span>;</li></ol></pre></div></div>     <p><strong>2. 跨线程共享和调用的线程安全函数</strong></p>     <p>当开发者想在任意子线程传递某个回调函数到应用主线程上执行时，libuv的实现方式一般使用uv_async_t句柄用于线程间通信。</p>     <p>相关函数包含：</p>     <ul>      <li>uv_async_init()</li>      <li>uv_async_send()</li>     </ul>     <p>Node-API与之对应的接口为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-thread-safety" target="_blank">napi_threadsafe_function</a>相关函数。</p>     <p>相关函数：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 用于创建一个线程安全的函数，该函数可以在多个线程中调用，而不需要担心数据竞争或其他线程安全问题</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param env 指向NAPI环境的指针，用于创建和操作Javascript值</span></li><li><span class="hljs-comment">* @param func 指向JavaScript函数的指针</span></li><li><span class="hljs-comment">* @param async_resource 异步资源，通常是一个表示异步操作的对象</span></li><li><span class="hljs-comment">* @param async_resource_name 指向资源名称的指针，这个名称将用于日志和调试</span></li><li><span class="hljs-comment">* @param max_queue_size 一个整数，表示队列的最大大小，当队列满时，新的调用将被丢弃</span></li><li><span class="hljs-comment">* @param initial_thread_count 无符号整数，表示在创建线程安全函数时，初始的线程数量</span></li><li><span class="hljs-comment">* @param thread_finalize_data 一个指向在所有线程之前需要清理的数据</span></li><li><span class="hljs-comment">* @param napi_finalize thread_finalize_cb 回调函数，当所有线程完成时被调用，用于清理资源</span></li><li><span class="hljs-comment">* @param context 指向上下文的指针，这个上下文将被传递给call_js_func函数</span></li><li><span class="hljs-comment">* @param call_js_cb 指向回调函数的指针，这个函数将在Javascript函数被调用时被调用</span></li><li><span class="hljs-comment">* @param result 指向napi_threadsafe_function结构的指针，这个结构将被填充为新创建的线程安全函数</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_create_threadsafe_function</span><span class="hljs-params">(napi_env env,</span></span></li><li><span class="hljs-function">                                            napi_value func,</span></li><li><span class="hljs-function">                                            napi_value async_resource,</span></li><li><span class="hljs-function">                                            napi_value async_resource_name,</span></li><li><span class="hljs-function">                                            <span class="hljs-type">size_t</span> max_queue_size,</span></li><li><span class="hljs-function">                                            <span class="hljs-type">size_t</span> initial_thread_count,</span></li><li><span class="hljs-function">                                            <span class="hljs-type">void</span>* thread_finalize_data,</span></li><li><span class="hljs-function">                                            napi_finalize thread_finalize_cb,</span></li><li><span class="hljs-function">                                            <span class="hljs-type">void</span>* context,</span></li><li><span class="hljs-function">                                            napi_threadsafe_function_call_js call_js_cb,</span></li><li><span class="hljs-function">                                            napi_threadsafe_function* result)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 获取一个线程安全的函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param function 指向线程安全函数的指针</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_acquire_threadsafe_function</span><span class="hljs-params">(napi_threadsafe_function function)</span></span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 调用一个线程安全的函数</span></li><li><span class="hljs-comment">* @param function 指向线程安全函数的指针</span></li><li><span class="hljs-comment">* @param data 用户数据</span></li><li><span class="hljs-comment">* @param is_blocking 枚举值，它决定调用JavaScript函数是阻塞的还是非阻塞的</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_call_threadsafe_function</span><span class="hljs-params">(napi_threadsafe_function function,</span></span></li><li><span class="hljs-function">                                          <span class="hljs-type">void</span>* data,</span></li><li><span class="hljs-function">                                          napi_threadsafe_function_call_mode is_blocking)</span>;</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 释放一个线程安全的函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param function 指向线程安全函数的指针</span></li><li><span class="hljs-comment">* @param is_blocking 枚举值，它决定调用JavaScript函数是阻塞的还是非阻塞的</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function">napi_status <span class="hljs-title">napi_release_threadsafe_function</span><span class="hljs-params">(napi_threadsafe_function function,</span></span></li><li><span class="hljs-function">                                             napi_threadsafe_function_call_mode is_blocking)</span>;</li></ol></pre></div></div>     <p>除此之外，如果开发者需要libuv其他原生接口来实现业务功能，为了让开发者正确使用libuv提供的接口能力，避免因为错误使用而陷入到问题当中。在后续章节，我们将逐步介绍libuv的一些基本概念和HarmonyOS系统中常用函数的正确使用方法，它仅仅可以保证开发者使用libuv接口的时候不会出现应用进程崩溃等现象。另外，我们还统计了在当前应用主线程上可以正常使用的接口，以及无法在应用主线程上使用的接口。</p>    </div>    <div class="tiledSection">     <h3 id="接口汇总说明">接口汇总说明<i class="anchor-icon anchor-icon-link" anchorid="接口汇总说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="tableClass2_t">                      <tbody><tr class="firstRow">         <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.1" width="50%">接口类型</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.2" width="50%">接口汇总</th>        </tr><tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_loop_init</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_loop_close</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_default_loop</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_run</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_loop_alive</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环">loop概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_stop</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Handle概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_poll_*</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Handle概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_timer_*</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Handle概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_async_*</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Handle概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_signal_*</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Handle概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_fs_*</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Request概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_random</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Request概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_getaddrinfo</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Request概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_getnameinfo</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">Request概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_queue_work</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#线程间通信">线程间通信原理及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_async_init</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#线程间通信">线程间通信原理及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_async_send</td>        </tr>        <tr>         <td class="cellrowborder" width="50%"><a href="/consumer/cn/doc/harmonyos-references/libuv#线程池">线程池概念及相关接口</a></td>         <td class="cellrowborder" width="50%">uv_queue_work</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="libuv单线程约束">libuv单线程约束<i class="anchor-icon anchor-icon-link" anchorid="libuv单线程约束" tips="复制节点链接"></i></h3>          <p>在HarmonyOS中使用libuv时，<strong>务必注意：使用uv_loop_init接口初始化loop的线程和调用uv_run的线程应保持一致，称为loop线程，并且对uvloop的所有非线程安全操作，均需保证与loop同线程，否则将会有发生crash的风险</strong>。HarmonyOS对libuv的使用有更严格的约束，对于非线程安全的函数，libuv将实现多线程检测机制，检测到多线程问题后输出警告日志。为了确保检测机制的准确性，协助开发者规避uv接口的不规范使用，我们建议在创建事件循环与执行uv_run始终保持在同一线程。根据loop来源的不同，可分为两种情况，即开发者创建loop和从env获取loop。</p>     <p><strong>1. 开发者创建loop</strong></p>     <p>开发者可以通过调用uv_loop_new创建loop或者uv_loop_init接口初始化loop，loop的生命周期由开发者自行维护。在这种情况下，如前文所述，需要保证uv_run执行在与创建/初始化loop操作相同的线程上，即loop线程上。此外，其余非线程安全操作，如timer相关操作等，均需要在loop线程上进行。</p>     <p>如果因为业务需要，必须在其他线程往loop线程抛任务，请使用uv_async_send函数：即在async句柄初始化时，注册一个回调函数，并在该回调中实现相应的操作，当调用uv_async_send时，在主线程上执行该回调函数。</p>     <p>ArkTS侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TestTimerAsync"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testTimerAsync</span>();  <span class="hljs-comment">// 初始化async句柄</span></li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          </li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TestTimerAsyncSend"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testTimerAsyncSend</span>();  <span class="hljs-comment">// 子线程调用uv_async_send提交定时器任务</span></li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;napi/native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-type">uv_async_t</span>* async = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_async_t</span>;</li><li><span class="hljs-type">bool</span> cond1 = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">bool</span> cond2 = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-comment">// 使用技巧：在使用loop时, 需要特别注意uv_stop函数的使用, 开发者需要确保uv_stop前</span></li><li><span class="hljs-comment">// 通知与loop相关的所有线程的handle都关闭, 参考stop_loop函数的实现</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">stop_loop</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">uv_stop</span>(loop);</li><li>    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> ensure_close = [](<span class="hljs-type">uv_handle_t</span>* handle, <span class="hljs-type">void</span>*) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">uv_is_closing</span>(handle)) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-built_in">uv_close</span>(handle, <span class="hljs-literal">nullptr</span>);</li><li>        }</li><li>    };</li><li>    <span class="hljs-comment">// 遍历所有句柄, 如果handle处于活跃状态, 调用ensure_close</span></li><li>    <span class="hljs-built_in">uv_walk</span>(loop, ensure_close, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 继续运行uv_run, 直到loop中不存在活跃的句柄和请求为止</span></li><li>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">uv_run</span>(loop, UV_RUN_DEFAULT) == <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 最后检查loop状态</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">uv_loop_alive</span>(loop) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 执行创建定时器操作</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">async_cb</span><span class="hljs-params">(<span class="hljs-type">uv_async_t</span>* handle)</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> loop = handle-&gt;loop;</li><li>    <span class="hljs-type">uv_timer_t</span>* timer = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_timer_t</span>;</li><li>    <span class="hljs-built_in">uv_timer_init</span>(loop, timer);</li><li>
</li><li>    <span class="hljs-comment">// 在适当的时机关闭async句柄</span></li><li>    <span class="hljs-keyword">if</span> (cond2) {</li><li>        <span class="hljs-built_in">uv_close</span>((<span class="hljs-type">uv_handle_t</span>*)handle, [](<span class="hljs-type">uv_handle_t</span>* handle){</li><li>            <span class="hljs-built_in">delete</span> (<span class="hljs-type">uv_async_t</span>*)handle;</li><li>        });</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">uv_timer_start</span>(timer,</li><li>        [](<span class="hljs-type">uv_timer_t</span>* timer){</li><li>            <span class="hljs-comment">// do something</span></li><li>            <span class="hljs-comment">// 在适当的时机停掉timer</span></li><li>            <span class="hljs-keyword">if</span> (cond1) {</li><li>                <span class="hljs-built_in">uv_timer_stop</span>(timer);</li><li>                <span class="hljs-built_in">uv_close</span>((<span class="hljs-type">uv_handle_t</span>*)timer, [](<span class="hljs-type">uv_handle_t</span>* handle){</li><li>                    <span class="hljs-built_in">delete</span>(<span class="hljs-type">uv_timer_t</span>*)handle;</li><li>                });</li><li>            }</li><li>        },</li><li>        <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 初始化async句柄, 绑定对应的回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimerAsync</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">([](){  <span class="hljs-comment">// A线程，loop线程</span></span></span></li><li><span class="hljs-function">        <span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_loop_t</span>;</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 开发者自己创建loop, 请注意维护loop的生命周期</span></span></li><li><span class="hljs-function">        uv_loop_init(loop);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 初始化一个async句柄, 注册回调函数</span></span></li><li><span class="hljs-function">        uv_async_init(loop, async, async_cb);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 让loop开始运行</span></span></li><li><span class="hljs-function">        uv_run(loop, UV_RUN_DEFAULT);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 清理所有的handle</span></span></li><li><span class="hljs-function">        stop_loop(loop);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 释放loop</span></span></li><li><span class="hljs-function">        uv_loop_close(loop);</span></li><li><span class="hljs-function">        <span class="hljs-keyword">delete</span> loop;</span></li><li><span class="hljs-function">    })</span>;</li><li>    t.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 在另一个线程上调用uv_async_send函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimerAsyncSend</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([](){ <span class="hljs-comment">// B线程</span></span></span></li><li><span class="hljs-function">        uv_async_send(async);  <span class="hljs-comment">// 调用uv_async_send, 通知loop线程调用与async句柄绑定的timer_cb</span></span></li><li><span class="hljs-function">        uv_sleep(<span class="hljs-number">500</span>);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 修改cond1, 关闭timer handle</span></span></li><li><span class="hljs-function">        cond1 = <span class="hljs-literal">true</span>;</span></li><li><span class="hljs-function">    })</span>;</li><li>
</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([](){ <span class="hljs-comment">// B线程</span></span></span></li><li><span class="hljs-function">        uv_sleep(<span class="hljs-number">1000</span>);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 修改cond2, 关闭async handle</span></span></li><li><span class="hljs-function">        cond2 = <span class="hljs-literal">true</span>;</span></li><li><span class="hljs-function">        uv_async_send(async);</span></li><li><span class="hljs-function">    })</span>;</li><li>
</li><li>    t1.<span class="hljs-built_in">detach</span>();</li><li>    t2.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"testTimerAsync"</span>, <span class="hljs-literal">nullptr</span>, TestTimerAsync, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"testTimerAsyncSend"</span>, <span class="hljs-literal">nullptr</span>, TestTimerAsyncSend, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testTimerAsync</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testTimerAsyncSend</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>     <p><strong>2. 从env获取loop</strong></p>     <p>开发者使用napi_get_uv_event_loop接口从env获取到的loop一般是系统创建的JS主线程的事件循环，因此应当避免在子线程中调用非线程安全函数。</p>     <p>如因业务需要，必须在非loop线程上调用非线程安全函数，请使用线程安全函数uv_async_send将任务提交到loop线程。即定义一个uv_async_t*类型的句柄，初始化该句柄的时候，将需要在子线程调用的非线程安全函数在对应的async_cb中调用，然后在非loop线程上调用uv_async_send函数，并回到loop线程上执行async_cb。请参考<a href="/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests">libuv中的handles和requests</a>章节关于<strong>正确使用timer示例</strong>的场景二内容。</p>    </div>    <div class="tiledSection">     <h3 id="线程安全函数">线程安全函数<i class="anchor-icon anchor-icon-link" anchorid="线程安全函数" tips="复制节点链接"></i></h3>          <p>在libuv中，由于涉及到大量的异步任务，稍有不慎就会陷入到多线程问题中。在这里，我们对libuv中常用的线程安全函数和非线程安全函数做了汇总。若开发者在多线程编程中调用了非线程安全的函数，势必要对其进行加锁保护或者保证代码的正确运行时序，否则将陷入到crash问题中。</p>     <p>线程安全函数：</p>     <ul>      <li>uv_async_send()：向异步句柄发送信号，可以在任何线程中调用。</li>      <li>uv_thread_create()：创建一个新线程并执行指定的函数，可以在任何线程中调用。</li>      <li>锁相关的操作，如uv_mutex_lock()、uv_mutex_unlock()等等。</li>     </ul>     <p><strong>提示：所有形如uv_xxx_init的函数，即使它是以线程安全的方式实现的，但使用时要注意，避免多个线程同时调用uv_xxx_init，否则它依旧会引起多线程资源竞争的问题。最好的方式是在事件循环线程中调用该函数。</strong></p>     <p><strong>注：uv_async_send函数被调用后，回调函数是被异步触发的。如果调用了多次uv_async_send，libuv只保证至少有一次回调会被执行。这就可能导致一旦对同一句柄触发了多次uv_async_send，libuv对回调的处理可能会违背开发者的预期。多次对同一个async句柄进行send操作，还会导致任意两次相同句柄send操作之间提交的的其他async_cb任务丢失。</strong> 而在Native侧，可以保证回调的执行次数和开发者调用napi_call_threadsafe_function的次数保持一致。</p>     <p>非线程安全函数：</p>     <ul>      <li>uv_os_unsetenv()：删除环境变量</li>      <li>uv_os_setenv()：设置环境变量</li>      <li>uv_os_getenv()：获取环境变量</li>      <li>uv_os_environ()：检索所有的环境变量</li>      <li>uv_os_tmpdir()：获取临时目录</li>      <li>uv_os_homedir()：获取家目录</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="libuv中的事件循环">libuv中的事件循环<i class="anchor-icon anchor-icon-link" anchorid="libuv中的事件循环" tips="复制节点链接"></i></h3>          <p>事件循环是libuv中最核心的一个概念，loop负责管理整个事件循环的所有资源，它贯穿于整个事件循环的生命周期。通常将uv_run所在的线程称为该事件循环的主线程。</p>     <p><strong>1. 事件循环运行的三种方式</strong></p>     <p>UV_RUN_DEFAULT：默认轮询方式，该模式将会一直运行下去，直到loop中没有活跃的句柄和请求。</p>     <p>UV_RUN_ONCE：一次轮询模式，如果pending_queue中有回调函数，则执行，然后跳过uv__io_poll函数。此模式默认认为loop中一定有事件发生。</p>     <p>UV_RUN_NOWAIT：非阻塞模式，该模式下不会执行pending_queue，而是直接执行一次I/O轮询（uv__io_poll）。</p>     <p><strong>2. 常用接口</strong></p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_loop_init</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop)</span></span>;</li></ol></pre></div></div>     <p>对loop进行初始化。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_loop_close</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop)</span></span>;</li></ol></pre></div></div>     <p>关闭loop，该函数只有在loop中所有的句柄和请求都关闭后才能成功返回，否则将返回UV_EBUSY。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_loop_delete</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop)</span></span>;</li></ol></pre></div></div>     <p>释放loop，该接口会先调用uv_loop_close，然后再将loop释放掉。在HarmonyOS平台上，由于assert函数不生效，因此不论uv_loop_close函数是否成功清理loop上的资源，都会将loop释放掉。开发者使用该接口时，请务必确保在loop线程退出时，loop上的资源可以被正确释放，即挂在loop上的handle和request均被关闭，否则会导致资源泄漏。<strong>开发者使用该接口时务必格外谨慎，建议非必要不使用。</strong></p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">uv_loop_t</span>* <span class="hljs-title">uv_default_loop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;</li></ol></pre></div></div>     <p>该函数创建一个进程级的loop。在HarmonyOS中，由于目前的应用主循环及其他JS工作线程还存在着libuv的loop。因此我们不建议开发者使用该函数来创建loop并实现业务功能。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_run</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop, uv_run_mode mode)</span></span>;</li></ol></pre></div></div>     <p>启动事件循环。运行模式可查看事件循环运行的三种方式。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_loop_alive</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span> loop)</span></span>;</li></ol></pre></div></div>     <p>判断loop是否处于活跃状态。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">uv_stop</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop)</span></span>;</li></ol></pre></div></div>     <p>该函数用来停止一个事件循环，在loop的下一次迭代中才会停止。如果该函数发生在I/O操作之前，将不会阻塞而是直接跳过uv__io_poll。</p>    </div>    <div class="tiledSection">     <h3 id="libuv中的handles和requests">libuv中的handles和requests<i class="anchor-icon anchor-icon-link" anchorid="libuv中的handles和requests" tips="复制节点链接"></i></h3>          <p>handle表示一个持久性的对象，通常挂载到loop中对应的handle_queue队列上。如果handle处于活跃状态，每次uv_run都会处理handle中的回调函数。</p>     <p>request表示一个短暂性的请求，一个request只触发一次回调操作。</p>     <p>下面是HarmonyOS系统中最常用的几个Handles和Requests：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/* Handle Type */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_handle_s</span> <span class="hljs-type">uv_handle_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_timer_s</span> <span class="hljs-type">uv_timer_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_async_s</span> <span class="hljs-type">uv_async_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_signal_s</span> <span class="hljs-type">uv_signal_t</span>;</li><li>
</li><li><span class="hljs-comment">/* Request Type */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_req_s</span> <span class="hljs-type">uv_req_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_work_s</span> <span class="hljs-type">uv_work_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_fs_s</span> <span class="hljs-type">uv_fs_t</span>;</li></ol></pre></div></div>     <p><strong>注：在handles中，uv_xxx_t继承了uv_handle_t；在requests中，uv_work_t继承了uv_req_t。</strong></p>     <p>对于libuv中的handles，对其有正确的认识并管理好它的生命周期至关重要。handle作为一个长期存在于loop中的句柄，在使用中，开发者应遵循下面的原则：</p>     <ol>      <li>句柄的初始化工作应在事件循环的线程中进行。</li>      <li>若由于业务问题，句柄需要在其他工作线程初始化，在使用之前用原子变量判断是否初始化完成。</li>      <li>句柄在确定后续不再使用后，调用uv_close将句柄从loop中摘除。</li>     </ol>     <p>在这里，需要特别说明一下uv_close的使用方法。uv_close被用来关闭一个handle，但是关闭handle的动作是异步的。函数原型为：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">uv_close</span><span class="hljs-params">(<span class="hljs-type">uv_handle_t</span>* handle, uv_close_cb close_cb)</span></span></li></ol></pre></div></div>     <p>handle：要关闭的句柄。</p>     <p>close_cb：处理该句柄的函数，用来进行内存管理等操作。</p>     <p>调用uv_close后，首先将要关闭的handle挂载到loop的closing_handles队列上，然后等待loop所在线程运行uv__run_closing_handles函数。最后回调函数close_cb将会在loop的下一次迭代中执行。因此，释放内存等操作应该在close_cb中进行。并且这种异步的关闭操作会带来多线程问题，开发者需要谨慎处理uv_close的时序问题，并且保证在close_cb执行之前handles的生命周期。</p>     <p><strong>Tips</strong>：在<a href="http://libuv.org/" target="_blank">libuv官方文档</a>中，有个经验法则需要在此提示一下。原文翻译：如果 uv_foo_t 类型的句柄具有 uv_foo_start() 函数，则从调用该函数的那一刻起，它就处于活动状态。 同样，uv_foo_stop()再次停用句柄。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ol>        <li>         <p>所有的handle关闭前必须要调用uv_close，所有的内存操作都要在uv_close的close_cb中执行。</p></li>        <li>         <p>所有的handle操作都不能通过获取其他线程loop的方式，在非loop线程上调用。</p></li>       </ol>      </div></div></div>     <p>对于libuv中的requests，开发者需要确保在进行异步任务提交时，<strong>通过动态申请的request，要在loop所在线程执行的complete回调函数中释放</strong>。用uv_work_t举例，代码可参考如下：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uv_work_t</span>* work = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_work_t</span>;</li><li><span class="hljs-built_in">uv_queue_work</span>(loop, work, [](<span class="hljs-type">uv_work_t</span>* req) {</li><li>    <span class="hljs-comment">// 异步操作</span></li><li>}, [](<span class="hljs-type">uv_work_t</span>* req, <span class="hljs-type">int</span> status) {</li><li>    <span class="hljs-comment">// 回调操作</span></li><li>    <span class="hljs-keyword">delete</span> req;</li><li>});</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="libuv-timer使用规范">libuv timer使用规范<i class="anchor-icon anchor-icon-link" anchorid="libuv-timer使用规范" tips="复制节点链接"></i></h3>          <p>使用libuv timer需要遵守如下约定：</p>     <ol>      <li>请不要在多个线程中使用libuv的接口（uv_timer_start、uv_timer_stop和uv_timer_again）同时操作同一个loop的timer heap，否则将导致崩溃，如果想要使用libuv的接口操作定时器，请<strong>保持在与当前env绑定的loop所在线程上操作</strong>；</li>      <li>如因业务需求往指定线程抛定时器，请使用uv_async_send线程安全函数实现。</li>     </ol>     <p><strong>1. 错误使用timer示例</strong></p>     <p>以下错误示例中，由于在多个线程操作同一个loop的timer heap，崩溃率极高。</p>     <p>ArkTS侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">waitforRunner</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-string">"use concurrent"</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xff</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"executed"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TimerTest"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>            <span class="hljs-keyword">while</span> (i--) {</li><li>              <span class="hljs-built_in">setTimeout</span>(waitforRunner, <span class="hljs-number">200</span>);</li><li>              testNapi.<span class="hljs-title function_">testTimer</span>();</li><li>          }</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native C++侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;napi/native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">uv_timer_t</span>* timer = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_timer_t</span>;</li><li>    </li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>    <span class="hljs-built_in">uv_timer_init</span>(loop, timer);</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([&amp;loop, &amp;timer](){</span></span></li><li><span class="hljs-function">        uv_timer_start(timer, [](<span class="hljs-type">uv_timer_t</span>* timer){</span></li><li><span class="hljs-function">            uv_timer_stop(timer);</span></li><li><span class="hljs-function">        }, <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>);</span></li><li><span class="hljs-function">    })</span>;</li><li>    </li><li>    t1.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"testTimer"</span>, <span class="hljs-literal">nullptr</span>, TestTimer, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testTimer</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>     <p><strong>2. 正确使用timer示例</strong></p>     <p><strong>场景一：</strong> 在上述场景中，需保证在JS主线程上进行timer的相关操作。将上述TestTimer函数的代码做如下修改，便可以避免崩溃发生。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">uv_timer_t</span>* timer = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_timer_t</span>;</li><li>    </li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>    <span class="hljs-built_in">uv_timer_init</span>(loop, timer);</li><li>    <span class="hljs-built_in">uv_timer_start</span>(timer, [](<span class="hljs-type">uv_timer_t</span>* timer){</li><li>        <span class="hljs-built_in">uv_timer_stop</span>(timer);</li><li>    }, <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>     <p><strong>场景二：</strong> 如果需要在指定的子线程抛定时器，请使用线程安全函数uv_async_send实现。</p>     <p>ArkTS侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TestTimerAsync"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testTimerAsync</span>();  <span class="hljs-comment">// 初始化async句柄</span></li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          </li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TestTimerAsyncSend"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'14fp'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testNapi.<span class="hljs-title function_">testTimerAsyncSend</span>();  <span class="hljs-comment">// 子线程调用uv_async_send提交定时器任务</span></li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>Native侧：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;napi/native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-type">uv_async_t</span>* async = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_async_t</span>;</li><li>
</li><li><span class="hljs-comment">// 执行创建定时器操作</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">async_cb</span><span class="hljs-params">(<span class="hljs-type">uv_async_t</span>* handle)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> loop = handle-&gt;loop;</li><li>    <span class="hljs-type">uv_timer_t</span>* timer = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_timer_t</span>;</li><li>    <span class="hljs-built_in">uv_timer_init</span>(loop, timer);</li><li>    </li><li>    <span class="hljs-built_in">uv_timer_start</span>(timer, [](<span class="hljs-type">uv_timer_t</span>* timer){</li><li>        <span class="hljs-built_in">uv_timer_stop</span>(timer);</li><li>    }, <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 初始化async句柄，绑定对应的回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimerAsync</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(env, &amp;loop);</li><li>    <span class="hljs-built_in">uv_async_init</span>(loop, async, async_cb);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestTimerAsyncSend</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">([](){</span></span></li><li><span class="hljs-function">        uv_async_send(async);  <span class="hljs-comment">// 在任意子线程中调用uv_async_send，通知主线程调用与async绑定的timer_cb</span></span></li><li><span class="hljs-function">    })</span>;</li><li>    t.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"testTimerAsync"</span>, <span class="hljs-literal">nullptr</span>, TestTimerAsync, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"testTimerAsyncSend"</span>, <span class="hljs-literal">nullptr</span>, TestTimerAsyncSend, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>    </li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>在index.d.ts添加如下代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testTimerAsync</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testTimerAsyncSend</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="线程间通信">线程间通信<i class="anchor-icon anchor-icon-link" anchorid="线程间通信" tips="复制节点链接"></i></h3>          <p>上面简单介绍了一些libuv中的基本概念，在这里我们将着重介绍libuv中的线程间通信。</p>     <p>libuv的线程间通信是通过uv_async_t句柄来进行的，相关函数如下：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_async_init</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop, <span class="hljs-type">uv_async_t</span>* handle, uv_async_cb async_cb)</span></span></li></ol></pre></div></div>     <p>loop：事件循环loop。</p>     <p>handle：线程间通信句柄。</p>     <p>async_cb：回调函数。</p>     <p>返回：成功，返回0。失败，返回错误码。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_async_send</span><span class="hljs-params">(<span class="hljs-type">uv_async_t</span>* handle)</span></span></li></ol></pre></div></div>     <p>handle：线程间通信句柄。</p>     <p>返回：成功，返回0。失败，返回错误码。</p>     <p>说明</p>     <ol>      <li>       <p>uv_async_t从调用uv_async_init开始后就一直处于活跃状态，除非用uv_close将其关闭。</p></li>      <li>       <p>uv_async_t的执行顺序严格按照uv_async_init的顺序，而非通过uv_async_send的顺序来执行的。因此按照初始化的顺序来管理好时序问题是必要的。</p></li>     </ol>     <p><span><img originheight="798" originwidth="1412" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115903.66951144648346630994957587811943:50001231000000:2800:7898A257233B390C7D079E15855A5452D653F067739EBC2A537BF53BCF6048E3.jpg" width="920" height="519.943342776204"></span></p>     <p>示例代码：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li>
</li><li><span class="hljs-type">uv_loop_t</span>* loop = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">uv_async_t</span>* async = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int</span> g_counter = <span class="hljs-number">10</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">async_handler</span><span class="hljs-params">(<span class="hljs-type">uv_async_t</span>* handle)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::cout &lt;&lt; <span class="hljs-string">"ohos async print"</span> &lt;&lt; std::endl;</li><li>    <span class="hljs-keyword">if</span> (--g_counter == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-comment">// 调用uv_close关闭async，在主循环中释放内存。</span></li><li>        <span class="hljs-built_in">uv_close</span>((<span class="hljs-type">uv_handle_t</span>*)async, [](<span class="hljs-type">uv_handle_t</span>* handle) {</li><li>            std::cout &lt;&lt; <span class="hljs-string">"delete async"</span> &lt;&lt; std::endl;</li><li>            <span class="hljs-built_in">delete</span> (<span class="hljs-type">uv_async_t</span>*)handle;</li><li>        });</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    loop = <span class="hljs-built_in">uv_default_loop</span>();</li><li>    async = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_async_t</span>;</li><li>    <span class="hljs-built_in">uv_async_init</span>(loop, async, async_handler);</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">subThread</span><span class="hljs-params">([]() {</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</span></li><li><span class="hljs-function">            usleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 避免多次调用uv_async_send只执行一次</span></span></li><li><span class="hljs-function">            std::cout &lt;&lt; i &lt;&lt; <span class="hljs-string">"th: subThread triggered"</span> &lt;&lt; std::endl;</span></li><li><span class="hljs-function">            uv_async_send(async);</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">    })</span>;</li><li>    subThread.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">uv_run</span>(loop, UV_RUN_DEFAULT);</li><li>}</li></ol></pre></div></div>     <p>该示例代码仅仅描述了一个简单的场景，步骤如下：</p>     <ol>      <li>在主线程中初始化async句柄</li>      <li>新建一个子线程，在里面每隔100毫秒触发一次uv_async_send。10次以后调用uv_close关闭async句柄。</li>      <li>在主线程运行事件循环。</li>     </ol>     <p>可以看到，每触发一次，主线程都会执行一次回调函数。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">0</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">1</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">2</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">3</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">4</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">5</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">6</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">7</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">8</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-number">9</span><span class="hljs-variable">th</span>:<span class="hljs-title class_">subThread</span> <span class="hljs-title class_">triggered</span></li><li><span class="hljs-variable">ohos</span> <span class="hljs-variable">async</span> <span class="hljs-variable">print</span></li><li><span class="hljs-variable">delete</span> <span class="hljs-variable">async</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="线程池">线程池<i class="anchor-icon anchor-icon-link" anchorid="线程池" tips="复制节点链接"></i></h3>          <p>线程池是libuv的一个核心功能，libuv中的线程池通过uv_loop_t中的成员变量wq_async来控制工作线程与主线程的通信。核心函数如下：</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_queue_work</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                  <span class="hljs-type">uv_work_t</span>* req,</span></li><li><span class="hljs-function">                  uv_work_cb work_cb,</span></li><li><span class="hljs-function">                  uv_after_work_cb after_work_cb)</span></li></ol></pre></div></div>     <p>work_cb：提交给工作线程的任务。</p>     <p>after_work_cb：loop所在线程要执行的回调函数。</p>     <p><strong>注意：</strong> work_cb与after_work_cb的执行有一个时序问题，只有work_cb执行完，通过uv_async_send(loop-&gt;wq_async)触发fd事件，loop所在线程在下一次迭代中才会执行after_work_cb。只有执行到after_work_cb时，与之相关的uv_work_t生命周期才算结束。</p>     <p><strong>1. 异步任务提交</strong></p>     <p>下图为原生libuv的线程池工作流程，图中流程已简化，默认句柄的pending标志为1，worker线程个数不代表线程池中线程的真实数量。</p>     <p><span><img originheight="725" originwidth="1420" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115903.94397512563655704666994187827957:50001231000000:2800:1C42FCEF20E223F868A3E8B50B4FADAEADD9D7E4030500BAE073C5630333CDB4.jpg" width="920" height="469.71830985915494"></span></p>     <p><strong>2. 异步任务提交注意事项</strong></p>     <p>在HarmonyOS中，uv_queue_work函数在UI线程的工作流程为：将work_cb抛到FFRT对应优先级的线程池中，然后待FFRT调度执行该任务，并将after_work_cb抛到eventhandler对应优先级的event queue中，等待eventhandler调度并回到loop线程执行。需要注意的是，uv_queue_work调用完后，并不代表其中的任何一个任务执行完，仅代表将work_cb插入到FFRT对应优先级的线程池中。taskpool和jsworker线程的工作流程和原生libuv逻辑保持一致。</p>     <p>对于一些特定场景，比如对内存开销敏感的场景中，同一个request可以重复使用，前提是保证同一类任务之间的顺序，并且要确保最后一次调用uv_queue_work时做好对该request的释放工作。</p>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uv_work_t</span>* work = new <span class="hljs-type">uv_work_t</span>;</li><li>uv_queue_work(loop, work, [](<span class="hljs-type">uv_work_t</span>* work) {</li><li>        <span class="hljs-comment">//do something</span></li><li>    },</li><li>    [](<span class="hljs-type">uv_work_t</span>* work, <span class="hljs-type">int</span> status) {</li><li>        <span class="hljs-comment">// do something</span></li><li>        uv_queue_work(loop, work, [](...) {<span class="hljs-comment">/* do something*/</span>}, [](...) {</li><li>            <span class="hljs-comment">//do something</span></li><li>            <span class="hljs-keyword">if</span> (last_task) {  <span class="hljs-comment">// 最后一个任务执行完以后，释放该request</span></li><li>                delete work;</li><li>            }</li><li>        });</li><li>    },</li><li>    )</li></ol></pre></div></div>     <p><strong>3. uv_queue_work使用约束</strong></p>     <p>特别强调，开发者需要明确，uv_queue_work函数仅用于抛异步任务，<strong>异步任务的execute回调被提交到线程池后会经过调度执行，因此并不保证多次提交的任务及其回调按照时序关系执行</strong>。</p>     <p>另外，uv_queue_work仅限于在loop线程中调用，这样不会有多线程安全问题。<strong>请不要把uv_queue_work作为线程间通信的手段，即A线程获取到B线程的loop，并通过uv_queue_work抛异步任务的方式，把execute置为空任务，而把complete回调放在B线程中执行。</strong> 这种方式不仅低效，而且还增加了发生故障时定位问题的难度。为了避免低效的任务提交，请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-thread-safety" target="_blank">napi_threadsafe_function相关函数</a>。</p>    </div>    <div class="tiledSection">     <h3 id="harmonyos中libuv的使用现状">HarmonyOS中libuv的使用现状<i class="anchor-icon anchor-icon-link" anchorid="harmonyos中libuv的使用现状" tips="复制节点链接"></i></h3>          <p>当前HarmonyOS系统中涉及到libuv的线程主要有主线程、JS Worker线程、Taskpool中的TaskWorker线程以及IPC线程。除了主线程采用了eventhandler作为主循环，其他线程都是使用libuv中的UV_RUN_DEFAULT运行模式作为当前线程的事件主循环来执行任务。在主线程中，eventhandler通过fd驱动的方式来触发任务的执行，eventhandler监听了uv_loop中的backend_fd。当loop中有fd事件触发的时候，eventhandler会执行一次uv_run来执行一遍libuv中的任务。</p>     <p>综上所述，开发者会发现这样一种现象：<strong>同样的libuv接口在主线程上不生效，但在JS Worker线程中就没问题。这主要还是因为主线程上所有不通过触发fd来驱动的uv接口都不会得到及时的响应。</strong></p>     <p>另外，在应用主线程中，所有的异步任务尽管最终都是通过libuv得到执行的。但是在当前系统中，libuv的线程池已经对接到了FFRT中，任何抛向libuv的异步任务都会在FFRT的线程中得到调度。应用主线程的回调函数也通过PostTask接口插入到eventhandler的队列上。这就意味着FFRT线程上的异步任务完成后不再通过uv_async_send的方式触发主线程的回调。过程如下图:</p>     <p><span><img originheight="458" originwidth="921" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115903.68571984410957185404609479032644:50001231000000:2800:D0B0B7905021004340E996534BBA7204503D43A63F25721EC1812942C6CCF2D0.jpg" width="920" height="457.5027144408252"></span></p>     <p>我们总结了五种类型的请求任务是直接可以按照正常用法在应用主循环中生效的：</p>     <ul>      <li>       <p>uv_random_t</p>       <p>函数原型：</p></li>     </ul>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 将一个工作请求添加到事件循环的队列中。</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 随机数请求</span></li><li><span class="hljs-comment">* @param buf 存储随机数的缓冲区</span></li><li><span class="hljs-comment">* @param buflen 缓冲区的长度</span></li><li><span class="hljs-comment">* @param flags 一个无符号整数，表示生成随机数的选项</span></li><li><span class="hljs-comment">* @param cb  随机数生成完成后的回调函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回错误码</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_random</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">             <span class="hljs-type">uv_random_t</span>* req,</span></li><li><span class="hljs-function">             <span class="hljs-type">void</span>* buf,</span></li><li><span class="hljs-function">             <span class="hljs-type">size_t</span> buflen,</span></li><li><span class="hljs-function">             <span class="hljs-type">unsigned</span> flags,</span></li><li><span class="hljs-function">             uv_random_cb cb)</span>;</li></ol></pre></div></div>     <ul>      <li>       <p>uv_work_t</p>       <p>函数原型：</p></li>     </ul>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 将一个工作请求添加到事件循环的队列中。当事件循环在下一次迭代时，work_cb函数将会在一个新的线程中被调用。当work_cb函数完成时，after_work_cb函数将会在事件循环的线程中被调用。</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 工作请求</span></li><li><span class="hljs-comment">* @param work_cb 在新线程中被调用的函数</span></li><li><span class="hljs-comment">* @param after_work_cb 在事件循环线程中被调用的函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_queue_work</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                  <span class="hljs-type">uv_work_t</span>* req,</span></li><li><span class="hljs-function">                  uv_work_cb work_cb,</span></li><li><span class="hljs-function">                  uv_after_work_cb after_work_cb)</span>;</li></ol></pre></div></div>     <ul>      <li>       <p>uv_fs_t</p>       <p>文件类提供的所有异步接口，在应用主线程中都是可以生效的。主要有如下：</p></li>     </ul>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步读取文件</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 文件操作请求</span></li><li><span class="hljs-comment">* @param file 文件描述符</span></li><li><span class="hljs-comment">* @param bufs 读取数据的缓冲区</span></li><li><span class="hljs-comment">* @param nbufs 缓冲区的数量</span></li><li><span class="hljs-comment">* @param off 文件的偏移量</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_fs_read</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop, <span class="hljs-type">uv_fs_t</span>* req,</span></span></li><li><span class="hljs-function">              uv_file file,</span></li><li><span class="hljs-function">              <span class="hljs-type">const</span> <span class="hljs-type">uv_buf_t</span> bufs[],</span></li><li><span class="hljs-function">              <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nbufs,</span></li><li><span class="hljs-function">              <span class="hljs-type">int64_t</span> off,</span></li><li><span class="hljs-function">              uv_fs_cb cb)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步打开文件</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 文件操作请求</span></li><li><span class="hljs-comment">* @param path 文件路径</span></li><li><span class="hljs-comment">* @param flags 打开文件的方式</span></li><li><span class="hljs-comment">* @param mode 文件权限</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_fs_open</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">               <span class="hljs-type">uv_fs_t</span>* req,</span></li><li><span class="hljs-function">               <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path,</span></li><li><span class="hljs-function">               <span class="hljs-type">int</span> flags,</span></li><li><span class="hljs-function">               <span class="hljs-type">int</span> mode,</span></li><li><span class="hljs-function">               uv_fs_cb cb)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步发送文件</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 文件操作请求</span></li><li><span class="hljs-comment">* @param out_fd 输出文件描述符</span></li><li><span class="hljs-comment">* @param in_fd 输入文件描述符</span></li><li><span class="hljs-comment">* @param off 文件的偏移量</span></li><li><span class="hljs-comment">* @param len 发送的长度</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_fs_sendfile</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                   <span class="hljs-type">uv_fs_t</span>* req,</span></li><li><span class="hljs-function">                   uv_file out_fd,</span></li><li><span class="hljs-function">                   uv_file in_fd,</span></li><li><span class="hljs-function">                   <span class="hljs-type">int64_t</span> off,</span></li><li><span class="hljs-function">                   <span class="hljs-type">size_t</span> len,</span></li><li><span class="hljs-function">                   uv_fs_cb cb)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步写入文件</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 文件操作请求</span></li><li><span class="hljs-comment">* @param file 文件描述符</span></li><li><span class="hljs-comment">* @param bufs 要写入的数据</span></li><li><span class="hljs-comment">* @param nbufs 数据的数量</span></li><li><span class="hljs-comment">* @param off 文件的偏移量</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_fs_write</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                <span class="hljs-type">uv_fs_t</span>* req,</span></li><li><span class="hljs-function">                uv_file file,</span></li><li><span class="hljs-function">                <span class="hljs-type">const</span> <span class="hljs-type">uv_buf_t</span> bufs[],</span></li><li><span class="hljs-function">                <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nbufs,</span></li><li><span class="hljs-function">                <span class="hljs-type">int64_t</span> off,</span></li><li><span class="hljs-function">                uv_fs_cb cb)</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步复制文件</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 文件操作请求</span></li><li><span class="hljs-comment">* @param path 源文件路径</span></li><li><span class="hljs-comment">* @param new_path 目标文件路径</span></li><li><span class="hljs-comment">* @param flags 复制选项</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_fs_copyfile</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                   <span class="hljs-type">uv_fs_t</span>* req,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* new_path</span></li><li><span class="hljs-function">                   <span class="hljs-type">int</span> flags,</span></li><li><span class="hljs-function">                   uv_fs_cb cb)</span>;</li></ol></pre></div></div>     <ul>      <li>       <p>uv_getaddrinfo_t</p>       <p>函数原型：</p></li>     </ul>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步获取地址信息</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 地址信息请求</span></li><li><span class="hljs-comment">* @param cb 完成后的回调函数</span></li><li><span class="hljs-comment">* @param hostname 主机名</span></li><li><span class="hljs-comment">* @param service 服务名</span></li><li><span class="hljs-comment">* @param hints 地址信息提示</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_getaddrinfo</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                   <span class="hljs-type">uv_getaddrinfo_t</span>* req,</span></li><li><span class="hljs-function">                   uv_getaddrinfo_cb cb,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* hostname,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-type">char</span>* service,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> addrinfo* hints)</span>;</li></ol></pre></div></div>     <ul>      <li>       <p>uv_getnameinfo_t</p>       <p>函数原型：</p></li>     </ul>     <div _ngcontent-sjc-c106="" class="highlight-div"><div _ngcontent-sjc-c106="" class="highlight-div-header"><div _ngcontent-sjc-c106="" class="highlight-div-header-left"><div _ngcontent-sjc-c106="" class="handle-button expand-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjc-c106="" class="highlight-div-header-right"><div _ngcontent-sjc-c106="" class="handle-button ai-button"></div><div _ngcontent-sjc-c106="" class="handle-button line-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjc-c106="" class="handle-button theme-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjc-c106="" class="handle-button copy-button"><div _ngcontent-sjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* @brief 异步获取名称信息</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @param loop 事件循环</span></li><li><span class="hljs-comment">* @param req 名称信息请求</span></li><li><span class="hljs-comment">* @param getnameinfo_cb 完成后的回调函数</span></li><li><span class="hljs-comment">* @param addr 地址</span></li><li><span class="hljs-comment">* @param flags 标志</span></li><li><span class="hljs-comment">*</span></li><li><span class="hljs-comment">* @return 成功返回0，失败返回-1</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">uv_getnameinfo</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                   <span class="hljs-type">uv_getnameinfo_t</span>* req,</span></li><li><span class="hljs-function">                   uv_getnameinfo_cb getnameinfo_cb,</span></li><li><span class="hljs-function">                   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr* addr,</span></li><li><span class="hljs-function">                   <span class="hljs-type">int</span> flags)</span>;</li></ol></pre></div></div>     <p>在应用主线程上不生效的接口主要包括：</p>     <ul>      <li>idle句柄</li>      <li>prepare句柄</li>      <li>check句柄</li>      <li>signal相关函数</li>      <li>tcp及udp相关函数</li>     </ul>    </div>   </div>   <div></div></div>