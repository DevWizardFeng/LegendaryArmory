<h1 _ngcontent-pvb-c119="" class="doc-title ng-star-inserted" title="生成优惠签名购买参数"> 生成优惠签名购买参数 </h1>

<div _ngcontent-pvb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者在促销优惠场景下需要传入JWT格式的jwsRepresentation参数，该参数包含购买订单涉及的优惠及商品信息。JSON Web Token（JWT）是一个开放标准（RFC 7519），定义了一种安全传输信息的方法，具体请参见<a href="https://jwt.io/" target="_blank">jwt.io</a>。开发者可以使用从<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>下载的私钥签名生成JWT。密钥生成和下载请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-set-necessary-parameters#section12796923310" target="_blank">配置密钥</a>。创建JWT格式的签名购买参数需要以下几步：</p>    <ol>     <li>创建JWT Header</li>     <li>创建JWT Payload</li>     <li>创建JWT格式的signature</li>    </ol>    <div class="tiledSection">     <h2 id="section19716287255">创建JWT Header<i class="anchor-icon anchor-icon-link" anchorid="section19716287255" tips="复制节点链接"></i></h2>          <p>Header参数如下：</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table>      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.4.1.5.1.1" width="17.169999999999998%">         <p>参数</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.4.1.5.1.2" width="17.669999999999998%">         <p>是否必选</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.4.1.5.1.3" width="17.169999999999998%">         <p>参数类型</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.4.1.5.1.4" width="47.99%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" width="17.169999999999998%">         <p>alg</p></td>        <td class="cellrowborder" width="17.669999999999998%">         <p>是</p></td>        <td class="cellrowborder" width="17.169999999999998%">         <p>String</p></td>        <td class="cellrowborder" width="47.99%">         <p>算法类型，固定为ES256。</p></td>       </tr>       <tr>        <td class="cellrowborder" width="17.169999999999998%">         <p>typ</p></td>        <td class="cellrowborder" width="17.669999999999998%">         <p>是</p></td>        <td class="cellrowborder" width="17.169999999999998%">         <p>String</p></td>        <td class="cellrowborder" width="47.99%">         <p>Token类型，固定为JWT。</p></td>       </tr>       <tr>        <td class="cellrowborder" width="17.169999999999998%">         <p>kid</p></td>        <td class="cellrowborder" width="17.669999999999998%">         <p>是</p></td>        <td class="cellrowborder" width="17.169999999999998%">         <p>String</p></td>        <td class="cellrowborder" width="47.99%">         <p>密钥ID，获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-set-necessary-parameters#section12796923310" target="_blank">配置密钥</a>。如果有多个密钥，请使用对JWT进行签名的同一私钥的密钥ID。</p></td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="section202141451152815">创建JWT Payload<i class="anchor-icon anchor-icon-link" anchorid="section202141451152815" tips="复制节点链接"></i></h2>          <p>JWT负载包含访问服务端API的一些关键信息，例如密钥颁发者ID、JWT签发时间和JWT到期时间等。JWT负载参数如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table>       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.1" width="17.169999999999998%">          <p>参数</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.2" width="17.669999999999998%">          <p>是否必选</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.3" width="17.169999999999998%">          <p>参数类型</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.4" width="47.99%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>iss</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>String</p></td>         <td class="cellrowborder" width="47.99%">          <p>标识密钥颁发者ID（Issuer ID），获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-set-necessary-parameters#section12796923310" target="_blank">配置密钥</a>的说明。</p></td>        </tr>        <tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>aud</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>String</p></td>         <td class="cellrowborder" width="47.99%">          <p>JWT的预期接收者，确保JWT是针对其自身的，固定为iap-v1。</p></td>        </tr>        <tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>iat</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>Long</p></td>         <td class="cellrowborder" width="47.99%">          <p>JWT签发时间，UTC时间戳，以秒为单位。</p></td>        </tr>        <tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>exp</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>Long</p></td>         <td class="cellrowborder" width="47.99%">          <p>JWT到期时间，UTC时间戳，以秒为单位。</p>          <p>（exp-iat）即为JWT的有效期，有效期不能超过1小时。</p></td>        </tr>        <tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>aid</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>String</p></td>         <td class="cellrowborder" width="47.99%">          <p>APP ID，获取方式参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-config-app-identity-info" target="_blank">配置应用身份信息</a>。</p></td>        </tr>        <tr>         <td class="cellrowborder" width="17.169999999999998%">          <p>data</p></td>         <td class="cellrowborder" width="17.669999999999998%">          <p>是</p></td>         <td class="cellrowborder" width="17.169999999999998%">          <p>String</p></td>         <td class="cellrowborder" width="47.99%">          <p>优惠信息扩展信息，为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-server-data-model#section13876141516408">PurchaseReservedInfo</a>结构的Json字符串。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section1867421172915">创建JWT格式的signature<i class="anchor-icon anchor-icon-link" anchorid="section1867421172915" tips="复制节点链接"></i></h2>          <p>使用Header中指定的算法(ES256)以及密钥ID关联的私钥进行签名生成JWT，可以使用各种开源库来创建JWT格式的token，具体请参见<a href="https://jwt.io/" target="_blank">jwt.io</a>。</p>    </div>    <div class="tiledSection">     <h3 id="section1435074914419" class="firsth2">代码示例<i class="anchor-icon anchor-icon-link" anchorid="section1435074914419" tips="复制节点链接"></i></h3>          <div class="switchPre"><div class="preTab preTab-cn"><div class="activePre" switchpre-data="0">Java</div></div><div class="switchPreBox"><div class="prebox"><div _ngcontent-pvb-c106="" class="highlight-div"><div _ngcontent-pvb-c106="" class="highlight-div-header"><div _ngcontent-pvb-c106="" class="highlight-div-header-left"><div _ngcontent-pvb-c106="" class="handle-button expand-button"><div _ngcontent-pvb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pvb-c106="" class="highlight-div-header-right"><div _ngcontent-pvb-c106="" class="handle-button ai-button"></div><div _ngcontent-pvb-c106="" class="handle-button line-button"><div _ngcontent-pvb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pvb-c106="" class="handle-button theme-button"><div _ngcontent-pvb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pvb-c106="" class="handle-button copy-button"><div _ngcontent-pvb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pvb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li> </li><li><span class=""><span class="hljs-keyword">import</span> </span>com.auth0.jwt.JWT<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>com.auth0.jwt.algorithms.Algorithm<span class="">;</span></li><li>
</li><li><span class=""><span class="hljs-keyword">import</span> </span>java.security.KeyFactory<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.security.NoSuchAlgorithmException<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.security.interfaces.ECPrivateKey<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.security.spec.InvalidKeySpecException<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.security.spec.PKCS8EncodedKeySpec<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.util.Base64<span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.util.Map<span class="">;</span></li><li>
</li><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> </span><span class="hljs-title class_">JwsRepresentationGenerator</span> {</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span>String <span class=""><span class="hljs-title function_">createJwsRepresentation</span></span><span class="hljs-params">(String signingKey, Map&lt;String, Object&gt; jwtHeader,</span></li><li><span class="hljs-params">        Map&lt;String, Object&gt; jwtPayload)</span> {</li><li>        <span class=""><span class="hljs-keyword">try</span> </span>{</li><li>            <span class="hljs-comment">// Configure a key and download the private key file in AppGallery Connect.</span></li><li>            <span class=""><span class="hljs-type">byte</span></span>[] derEncodedSigningKey = Base64.getDecoder().decode(signingKey);</li><li>            <span class="hljs-type">KeyFactory</span> <span class="hljs-variable">keyFactory</span> <span class="hljs-operator">=</span> KeyFactory.getInstance(<span class=""><span class="hljs-string">"EC"</span></span>);</li><li>            <span class="hljs-type">PKCS8EncodedKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">PKCS8EncodedKeySpec</span>(derEncodedSigningKey);</li><li>            <span class="hljs-type">ECPrivateKey</span> <span class="hljs-variable">ecPrivateKey</span> <span class="hljs-operator">=</span> (ECPrivateKey) keyFactory.generatePrivate(keySpec);</li><li>            <span class=""><span class="hljs-keyword">return</span> </span>JWT.create().withHeader(jwtHeader).withPayload(jwtPayload).sign(Algorithm.ECDSA256(ecPrivateKey));</li><li>        } <span class=""><span class="hljs-keyword">catch</span> </span>(NoSuchAlgorithmException | InvalidKeySpecException e) {</li><li>            <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment"><span class="hljs-doctag">TODO:</span> Need to replace it with the actual business logic.</span></span></li><li>            <span class=""><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> </span><span class="hljs-title class_">RuntimeException</span>(e);</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div></div></div></div>    </div>   </div>   <div></div></div>