<h1 _ngcontent-sjj-c119="" class="doc-title ng-star-inserted" title="@State装饰器：组件内状态"> @State装饰器：组件内状态 </h1>

<div _ngcontent-sjj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>被状态变量装饰器装饰的变量称为状态变量，使普通变量具备状态属性。当状态变量改变时，会触发其直接绑定的UI组件渲染更新。</p>    <p>在状态变量相关装饰器中，@State是最基础的装饰器，也是大部分状态变量的数据源。</p>    <p>在阅读@State文档前，建议开发者对状态管理框架有基本的了解。建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state-management-overview">状态管理概述</a>。最佳实践请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-status-management" target="_blank">状态管理最佳实践</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>从API version 9开始，该装饰器支持在ArkTS卡片中使用。</p>      <p>从API version 11开始，该装饰器支持在元服务中使用。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>@State装饰的变量与声明式范式中的其他被装饰变量一样，是私有的，只能从组件内部访问，在声明时必须指定其类型并完成本地初始化；若需从父组件初始化，也可选择使用命名参数机制完成赋值。</p>     <p>@State装饰的变量拥有以下特性：</p>     <ul>      <li>@State装饰的变量生命周期与其所属自定义组件的生命周期相同。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="装饰器使用规则说明">装饰器使用规则说明<i class="anchor-icon anchor-icon-link" anchorid="装饰器使用规则说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">@State变量装饰器</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">装饰器参数</td>         <td class="cellrowborder" valign="top" width="50%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">同步类型</td>         <td class="cellrowborder" valign="top" width="50%">不与父组件中任何类型的变量同步。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">          <p>object、class、string、number、boolean、enum类型，以及这些类型的数组。</p>          <p>API version 10开始支持<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰date类型变量">Date类型</a>。</p>          <p>API version 11及以上支持<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰map类型变量">Map</a>、<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰set类型变量">Set</a>类型、undefined和null类型、ArkUI框架定义的联合类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-types#length" target="_blank">Length</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-types#resourcestr" target="_blank">ResourceStr</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-types#resourcecolor" target="_blank">ResourceColor</a>类型以及这些类型的联合类型，示例见<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#state支持联合类型实例">@State支持联合类型实例</a>。</p>          <p>支持类型的场景见<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#观察变化">观察变化</a>。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">不允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">不支持装饰Function类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">被装饰变量的初始值</td>         <td class="cellrowborder" valign="top" width="50%">必须本地初始化。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="变量的传递访问规则说明">变量的传递/访问规则说明<i class="anchor-icon anchor-icon-link" anchorid="变量的传递访问规则说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">传递/访问</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">从父组件初始化</td>         <td class="cellrowborder" valign="top" width="50%">          <p>可以从父组件或本地初始化。</p>          <p>父组件传入非undefined值时覆盖本地初始值，否则使用@State的本地初始值。</p>          <p>支持父组件中的常规变量以及装饰器装饰的状态变量：@State、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Provide</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Consume</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@ObjectLink</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storagelink">@StorageLink</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storageprop">@StorageProp</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstoragelink">@LocalStorageLink</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstorageprop">@LocalStorageProp</a>，初始化@State。需要注意：父组件传入的外部变量对@State初始化时，仅作为初始值，后续变量的变化不会同步至@State。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">用于初始化子组件</td>         <td class="cellrowborder" valign="top" width="50%">@State装饰的变量支持初始化子组件的常规变量、@State、@Link、@Prop、@Provide。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">是否支持组件外访问</td>         <td class="cellrowborder" valign="top" width="50%">不支持，只能在组件内访问。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>图1</strong> 初始化规则图示</p>     <p><span><img originheight="273" originwidth="1897" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114951.36092488698418147353279861669816:50001231000000:2800:17B6468C797B8FA8A8BD1049A849F60EAB28934A9EF6CFD9177260963DB1BCB8.png" width="920" height="132.39852398523985"></span></p>    </div>    <div class="tiledSection">     <h2 id="观察变化和行为表现">观察变化和行为表现<i class="anchor-icon anchor-icon-link" anchorid="观察变化和行为表现" tips="复制节点链接"></i></h2>          <p>并不是状态变量的所有更改都会引起UI的刷新，只有可以被框架观察到的修改才会引起UI刷新。本小节将介绍什么样的修改才能被观察到，以及观察到变化后，框架是怎么引起UI刷新的，即框架的行为表现是什么。</p>    </div>    <div class="tiledSection">     <h3 id="观察变化" class="firsth2">观察变化<i class="anchor-icon anchor-icon-link" anchorid="观察变化" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>当装饰的数据类型为boolean、string、number类型时，可以观察到数值的变化。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 简单类型</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 可以观察到值的变化</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">1</span>;</li></ol></pre></div></div></li>      <li>       <p>当装饰的数据类型为class或Object时，可以观察到自身的赋值和属性赋值的变化，即Object.keys(observedObject)返回的所有属性。示例如下：</p>       <p>声明Person和Model类。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-title class_">Person</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, person: Person</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = person;</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>@State装饰的类型是Model。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// class类型</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">title</span>: <span class="hljs-title class_">Model</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hello'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'World'</span>));</li></ol></pre></div></div>       <p>对@State装饰变量的赋值。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// class类型赋值</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hi'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'ArkUI'</span>));</li></ol></pre></div></div>       <p>对@State装饰变量的属性赋值。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// class属性的赋值</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'Hi'</span>;</li></ol></pre></div></div>       <p>嵌套属性的赋值观察不到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 嵌套的属性赋值观察不到</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-property">name</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'ArkUI'</span>;</li></ol></pre></div></div></li>      <li>       <p>当装饰的对象是array时，可以观察到数组本身的赋值和添加、删除、更新数组的变化。例子如下。</p>       <p>声明Model类。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>@State装饰的对象为Model类型数组时。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 数组类型</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">title</span>: <span class="hljs-title class_">Model</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-number">11</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-number">1</span>)];</li></ol></pre></div></div>       <p>数组自身的赋值可以观察到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 数组赋值</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-number">2</span>)];</li></ol></pre></div></div>       <p>数组项的赋值可以观察到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 数组项赋值</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-number">2</span>);</li></ol></pre></div></div>       <p>删除数组项可以观察到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 数组项更改</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-title function_">pop</span>();</li></ol></pre></div></div>       <p>新增数组项可以观察到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 数组项更改</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-number">12</span>));</li></ol></pre></div></div>       <p>数组项中属性的赋值观察不到。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 嵌套的属性赋值观察不到</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = <span class="hljs-number">6</span>;</li></ol></pre></div></div></li>      <li>       <p>当装饰的对象是Date时，可以观察到Date的赋值，以及通过调用Date的接口setFullYear, setMonth, setDate, setHours, setMinutes, setSeconds, setMilliseconds, setTime, setUTCFullYear, setUTCMonth, setUTCDate, setUTCHours, setUTCMinutes, setUTCSeconds, setUTCMilliseconds更新Date的属性，详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰date类型变量">装饰Date类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Map时，可以观察到Map整体的赋值，以及通过调用Map的接口set, clear, delete更新Map的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰map类型变量">装饰Map类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Set时，可以观察到Set整体的赋值，以及通过调用Set的接口add, clear, delete更新Set的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-state#装饰set类型变量">装饰Set类型变量</a>。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="框架行为">框架行为<i class="anchor-icon anchor-icon-link" anchorid="框架行为" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>当状态变量改变时，查询依赖该状态变量的组件。</p></li>      <li>       <p>执行依赖该状态变量的组件更新方法，实现组件更新渲染。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="限制条件">限制条件<i class="anchor-icon anchor-icon-link" anchorid="限制条件" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>@State装饰的变量必须初始化，否则编译期会报错。</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 错误写法，编译报错</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li><span class="hljs-comment">// 正确写法</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li></ol></pre></div></div></li>      <li>       <p>@State不支持装饰Function类型的变量，框架会抛出运行时错误。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="装饰简单类型的变量" class="firsth2">装饰简单类型的变量<i class="anchor-icon anchor-icon-link" anchorid="装饰简单类型的变量" tips="复制节点链接"></i></h3>          <p>以下示例为@State装饰的简单类型，count被@State装饰成为状态变量，count的改变引起Button组件的刷新：</p>     <ul>      <li>       <p>当状态变量count改变时，只能查询到Button组件与之关联。</p></li>      <li>       <p>执行Button组件的更新方法，实现按需刷新。</p></li>     </ul>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Button</span>(<span class="hljs-string">`click times: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;</li><li>      })</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰class对象类型的变量">装饰class对象类型的变量<i class="anchor-icon anchor-icon-link" anchorid="装饰class对象类型的变量" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>自定义组件MyComponent定义了被@State装饰的状态变量count和title，其中title的类型为自定义类Model。如果count或title的值发生变化，则查询MyComponent中使用该状态变量的UI组件，并进行重新渲染。</p></li>      <li>       <p>EntryComponent中有多个MyComponent组件实例，第一个MyComponent内部状态的更改不会影响第二个MyComponent。</p></li>     </ul>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">EntryComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 此处指定的参数都将在初始渲染时覆盖本地定义的默认值，并不是所有的参数都需要从父组件初始化</span></li><li>      <span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">increaseBy</span>: <span class="hljs-number">2</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>      <span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">title</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hello World 2'</span>), <span class="hljs-attr">count</span>: <span class="hljs-number">7</span> })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">title</span>: <span class="hljs-title class_">Model</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hello World'</span>);</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">increaseBy</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.title.value}</span>`</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`Click to change title`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// @State变量的更新将触发上面的Text组件内容更新</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>.<span class="hljs-property">value</span> === <span class="hljs-string">'Hello ArkUI'</span> ? <span class="hljs-string">'Hello World'</span> : <span class="hljs-string">'Hello ArkUI'</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`Click to increase count = <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// @State变量的更新将触发该Button组件的内容更新</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">increaseBy</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="291" originwidth="294" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114952.00717156516072433003816931794789:50001231000000:2800:9419EB987EA488BD5B29584F8D4D87CA3870745E674DEE235FC57F1656D55E82.gif" class="notEnlarge" width="294" height="291"></span></p>     <p>从上述示例中，我们可以了解到@State变量的初始化机制：</p>     <ol>      <li>       <p>上述示例中，在没有外部传入的情况下，使用默认的值进行本地初始化：</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// title没有外部传入，使用本地的值new Model('Hello World')进行初始化</span></li><li><span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">increaseBy</span>: <span class="hljs-number">2</span> })</li><li><span class="hljs-comment">// increaseBy没有外部传入，使用本地的值1进行初始化</span></li><li><span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">title</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hello World 2'</span>), <span class="hljs-attr">count</span>: <span class="hljs-number">7</span> })</li></ol></pre></div></div></li>      <li>       <p>上述示例中，在有外部传入的情况下，使用外部传入的值进行初始化：</p>       <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// count和increaseBy均有外部传入，分别使用传入的1和2进行初始化</span></li><li><span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">increaseBy</span>: <span class="hljs-number">2</span> })</li><li><span class="hljs-comment">// title和count均有外部传入，分别使用传入的new Model('Hello World 2')和7进行初始化</span></li><li><span class="hljs-title class_">MyComponent</span>({ <span class="hljs-attr">title</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-string">'Hello World 2'</span>), <span class="hljs-attr">count</span>: <span class="hljs-number">7</span> })</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="装饰map类型变量">装饰Map类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰map类型变量" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 11开始，@State支持Map类型。</p>      </div></div></div>     <p>在下面的示例中，message类型为Map&lt;number, string&gt;，点击Button改变message的值，视图会随之刷新。</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MapSample</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span>], [<span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">3</span>, <span class="hljs-string">'c'</span>]]);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>]</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">0</span>]}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">1</span>]}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Divider</span>()</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'init map'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span>], [<span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">3</span>, <span class="hljs-string">'c'</span>]]);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set new one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">4</span>, <span class="hljs-string">'d'</span>);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">clear</span>();</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'replace the first one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'aa'</span>);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete the first one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-number">0</span>);</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰set类型变量">装饰Set类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰set类型变量" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 11开始，@State支持Set类型。</p>      </div></div></div>     <p>在下面的示例中，message类型为Set&lt;number&gt;，点击Button改变message的值，视图会随之刷新。</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">SetSample</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>]</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">0</span>]}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Divider</span>()</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'init set'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set new one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">clear</span>();</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete the first one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-number">0</span>);</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰date类型变量">装饰Date类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰date类型变量" tips="复制节点链接"></i></h3>          <p>在下面的示例中，selectedDate类型为Date，点击Button改变selectedDate的值，视图会随之刷新。</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-meta">@Entry</span></li><li>  <span class="hljs-meta">@Component</span></li><li>  struct <span class="hljs-title class_">DatePickerExample</span> {</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">selectedDate</span>: <span class="hljs-title class_">Date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2021-08-08'</span>);</li><li>  </li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set selectedDate to 2023-07-08'</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2023-07-08'</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the year by 1'</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setFullYear</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getFullYear</span>() + <span class="hljs-number">1</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the month by 1'</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setMonth</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the day by 1'</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>);</li><li>          })</li><li>        <span class="hljs-title class_">DatePicker</span>({</li><li>          <span class="hljs-attr">start</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'1970-1-1'</span>),</li><li>          <span class="hljs-attr">end</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2100-1-1'</span>),</li><li>          <span class="hljs-attr">selected</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span></li><li>        })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="state支持联合类型实例">State支持联合类型实例<i class="anchor-icon anchor-icon-link" anchorid="state支持联合类型实例" tips="复制节点链接"></i></h3>          <p>@State支持联合类型和undefined和null，在下面的示例中，count类型为number | undefined，点击Button改变count的属性或者类型，视图会随之刷新。</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">EntryComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">MyComponent</span>()</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`count(<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>)`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-literal">undefined</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="使用箭头函数改变状态变量未生效" class="firsth2">使用箭头函数改变状态变量未生效<i class="anchor-icon anchor-icon-link" anchorid="使用箭头函数改变状态变量未生效" tips="复制节点链接"></i></h3>          <p>箭头函数体内的this对象，就是定义该函数时所在的作用域指向的对象，而不是使用时所在的作用域指向的对象。所以在该场景下，changeCoverUrl的this指向PlayDetailViewModel，而不是被装饰器@State代理的状态变量。</p>     <p>反例：</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlayDetailViewModel</span> {</li><li>  <span class="hljs-attr">coverUrl</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'#00ff00'</span>;</li><li>
</li><li>  changeCoverUrl= <span class="hljs-function">()=&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">coverUrl</span> = <span class="hljs-string">'#00F5FF'</span>;</li><li>  }</li><li>
</li><li>}</li></ol></pre></div></div>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">PlayDetailViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./PlayDetailViewModel'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PlayDetailPage</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">PlayDetailViewModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlayDetailViewModel</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">coverUrl</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">coverUrl</span>)</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击改变颜色'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">changeCoverUrl</span>();</li><li>          })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignContent</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Top</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>将当前this.vm传入，调用代理状态变量的属性赋值。</p>     <p>正例：</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlayDetailViewModel</span> {</li><li>  <span class="hljs-attr">coverUrl</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'#00ff00'</span>;</li><li>
</li><li>  changeCoverUrl= <span class="hljs-function">(<span class="hljs-params">model:PlayDetailViewModel</span>)=&gt;</span> {</li><li>    model.<span class="hljs-property">coverUrl</span> = <span class="hljs-string">'#00F5FF'</span>;</li><li>  }</li><li>
</li><li>}</li></ol></pre></div></div>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">PlayDetailViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./PlayDetailViewModel'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PlayDetailPage</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">PlayDetailViewModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlayDetailViewModel</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">coverUrl</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">coverUrl</span>)</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击改变颜色'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> self = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">changeCoverUrl</span>(self);</li><li>          })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignContent</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Top</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="类的构造函数中通过捕获this修改变量无法观察">类的构造函数中通过捕获this修改变量无法观察<i class="anchor-icon anchor-icon-link" anchorid="类的构造函数中通过捕获this修改变量无法观察" tips="复制节点链接"></i></h3>          <p>在状态管理中，类会被一层“代理”进行包装。当在组件中改变该类的成员变量时，会被该代理进行拦截，在更改数据源中值的同时，也会将变化通知给绑定的组件，从而实现观测变化与触发刷新。</p>     <p>当在构造函数中初始化修改success的箭头函数时，TestModel实例尚未被代理封装，this指向TestModel实例本身。因此，后续触发query事件时，状态管理无法观测到变化。</p>     <p>当开发者将修改success的箭头函数放在query中时，已完成TestModel对象初始化和代理封装。通过this.viewModel.query()调用query时，query函数中的this指向viewModel代理对象，对代理对象成员属性isSuccess的更改能够被观测到，因此触发query事件可以被状态管理观测到变化。</p>     <p>【反例】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">viewModel</span>: <span class="hljs-title class_">TestModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestModel</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>.<span class="hljs-property">isSuccess</span> ? <span class="hljs-string">'success'</span> : <span class="hljs-string">'failed'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>.<span class="hljs-title function_">query</span>();</li><li>          })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestModel</span> {</li><li>  <span class="hljs-attr">isSuccess</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">model</span>: <span class="hljs-title class_">Model</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSuccess</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`this.isSuccess: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.isSuccess}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">query</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">query</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">cb: () =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = cb;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">query</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上述示例代码中，状态变量的修改在构造函数内。界面刚开始时显示“failed”，点击后日志打印“this.isSuccess: true”，表明修改成功，但界面仍然显示“failed”，这说明UI未刷新。</p>     <p>【正例】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">viewModel</span>: <span class="hljs-title class_">TestModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestModel</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>.<span class="hljs-property">isSuccess</span> ? <span class="hljs-string">'success'</span> : <span class="hljs-string">'failed'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>.<span class="hljs-title function_">query</span>();</li><li>          })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestModel</span> {</li><li>  <span class="hljs-attr">isSuccess</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">model</span>: <span class="hljs-title class_">Model</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  })</li><li>
</li><li>  <span class="hljs-title function_">query</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">callback</span> = <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSuccess</span> = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">query</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">cb: () =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = cb;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">query</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上文示例代码将状态变量的修改放在类的普通方法中，界面开始时显示“failed”，点击后显示“success”。</p>    </div>    <div class="tiledSection">     <h3 id="状态变量只能影响其直接绑定的ui组件的刷新">状态变量只能影响其直接绑定的UI组件的刷新<i class="anchor-icon anchor-icon-link" anchorid="状态变量只能影响其直接绑定的ui组件的刷新" tips="复制节点链接"></i></h3>          <p>【示例1】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'杭州'</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'上海'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">info</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>.<span class="hljs-property">address</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message}</span>`</span>);</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.info.address}</span>`</span>);</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>.<span class="hljs-property">address</span> = <span class="hljs-string">'北京'</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>点击Button('change')只会触发第二个Text组件的刷新，因为message是字符串类型。字符串是值类型，点击按钮时，改变的是info中的address值，而不会影响this.message的值，因此第一个Text组件不会刷新。</p>     <p>【示例2】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'杭州'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">address: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = address;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-attr">info</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-string">'天津'</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">info</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-string">'上海'</span>);</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">info</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.info.address}</span>`</span>);</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.info.address}</span>`</span>);</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">info</span>.<span class="hljs-property">address</span> = <span class="hljs-string">'北京'</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在aboutToAppear中，info的引用被赋值给了user的成员属性info。因此，点击按钮改变info中的属性时，会触发第一个Text组件的刷新。第二个Text组件由于观测能力仅有一层，无法检测到二层属性的变化，所以不会刷新。</p>     <p>【示例3】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'杭州'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">address: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = address;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-attr">info</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-string">'天津'</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">info</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-string">'上海'</span>);</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">info</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.info.address}</span>`</span>);</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.info.address}</span>`</span>);</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-string">'广州'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">info</span>.<span class="hljs-property">address</span> = <span class="hljs-string">'北京'</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在上述示例中，点击按钮后有以下变化：</p>     <ul>      <li>第一个Text组件不会刷新。这是因为在点击事件中执行this.user.info = new Info('广州')，该变化使得this.user.info不再引用this.info，而是重新赋值了一个Info实例，因此再改变this.user.info的属性不会被this.info观察，第一个Text组件不会刷新。</li>      <li>第二个Text组件会刷新。这是因为点击按钮后，首先执行this.user.info = new Info('广州')，该变化属于第一层的赋值，可以被观察，会对当前自定义组件标脏，并请求下一帧刷新。再执行this.user.info.address = '北京'，该变化属于第二层的赋值，不能被观察到。但是需要注意，当前变化虽然无法被观察到，但赋值是可以生效的。在下一帧刷新到来时，this.user.info.address已被修改为北京，因此第二个Text组件显示北京。</li>     </ul>     <p>如果上述示例注释掉this.user.info = new Info('广州')，则与示例2场景一致，只会触发第一个Text组件更新，第二个Text组件将无法更新。</p>    </div>    <div class="tiledSection">     <h3 id="复杂类型常量重复赋值给状态变量触发刷新">复杂类型常量重复赋值给状态变量触发刷新<i class="anchor-icon anchor-icon-link" anchorid="复杂类型常量重复赋值给状态变量触发刷新" tips="复制节点链接"></i></h3>          <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataObj</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'default name'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">list</span>: <span class="hljs-title class_">DataObj</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'a'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'b'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'c'</span>)];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataObjFromList</span>: <span class="hljs-title class_">DataObj</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">ConsumerChild</span>({ <span class="hljs-attr">dataObj</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change to self'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ConsumerChild</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onDataObjChange'</span>) <span class="hljs-attr">dataObj</span>: <span class="hljs-title class_">DataObj</span>;</li><li>
</li><li>  <span class="hljs-title function_">onDataObjChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'dataObj changed'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getContent</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`this.dataObj.name change: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.dataObj.name}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObj</span>.<span class="hljs-property">name</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContent</span>()).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上示例每次点击Button('change to self')，把相同的类实例赋值给一个Class类型的状态变量，会触发刷新并输出this.dataObj.name change: a日志。原因是在状态管理V1中，会给被@Observed装饰的类对象以及使用状态变量装饰器如@State装饰的Class、Date、Map、Set、Array类型的对象添加一层代理，用于观测一层属性或API调用产生的变化。</p>     <p>当再次赋值list[0]时，dataObjFromList已经是Proxy类型，而list[0]是Object类型，因此判断两者不相等，会触发赋值和刷新。</p>     <p>为了避免这种不必要的赋值和刷新，可以通过用@Observed装饰类，或者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-gettarget">UIUtils.getTarget()</a>获取原始对象，提前进行新旧值的判断，如果相同则不执行赋值。</p>     <p>方法一：增加@Observed</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataObj</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'default name'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">list</span>: <span class="hljs-title class_">DataObj</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'a'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'b'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'c'</span>)];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataObjFromList</span>: <span class="hljs-title class_">DataObj</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">ConsumerChild</span>({ <span class="hljs-attr">dataObj</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change to self'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ConsumerChild</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onDataObjChange'</span>) <span class="hljs-attr">dataObj</span>: <span class="hljs-title class_">DataObj</span>;</li><li>
</li><li>  <span class="hljs-title function_">onDataObjChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'dataObj changed'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObj</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上示例，给对应的类增加了@Observed装饰器后，list[0]已经是Proxy类型了，这样再次赋值时，相同的对象，就不会触发刷新。</p>     <p>方法二：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-gettarget">UIUtils.getTarget()</a>获取原始对象</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.arkui.StateManagement'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataObj</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'default name'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">list</span>: <span class="hljs-title class_">DataObj</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'a'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'b'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObj</span>(<span class="hljs-string">'c'</span>)];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataObjFromList</span>: <span class="hljs-title class_">DataObj</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">ConsumerChild</span>({ <span class="hljs-attr">dataObj</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change to self'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 获取原始对象来和新值做对比</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">getTarget</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span>) !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>]) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObjFromList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>];</li><li>        }</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ConsumerChild</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onDataObjChange'</span>) <span class="hljs-attr">dataObj</span>: <span class="hljs-title class_">DataObj</span>;</li><li>
</li><li>  <span class="hljs-title function_">onDataObjChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'dataObj changed'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataObj</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上示例，在赋值前，使用getTarget获取了对应状态变量的原始对象，经过对比后，如果和当前对象一样，就不赋值，不触发刷新。</p>    </div>    <div class="tiledSection">     <h3 id="不允许在build里改状态变量">不允许在build里改状态变量<i class="anchor-icon anchor-icon-link" anchorid="不允许在build里改状态变量" tips="复制节点链接"></i></h3>          <p>不允许在build里改变状态变量，状态管理框架会在运行时报出Error级别日志。通过事件回调或异步回调更新状态变量，例如在onClick中修改@State，是允许的。</p>     <p>下面的示例，渲染的流程是：</p>     <ol>      <li>       <p>创建Index自定义组件。</p></li>      <li>       <p>执行Index的build方法：</p>       <ol>        <li>         <p>创建Column组件。</p></li>        <li>         <p>创建Text组件。创建Text组件的过程中，触发this.count++。</p></li>        <li>         <p>count的改变再次触发Text组件的刷新。</p></li>        <li>         <p>Text最终显示为2。</p></li>       </ol></li>     </ol>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 应避免直接在Text组件内改变count的值</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count++}</span>`</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在首次创建的过程中，Text组件被多渲染了一次，最终显示为2。</p>     <p>框架识别到在build里改变状态变量会打error日志，error日志为：</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">FIX</span> <span class="hljs-variable constant_">THIS</span> <span class="hljs-variable constant_">APPLICATION</span> <span class="hljs-attr">ERROR</span>: <span class="hljs-meta">@Component</span> <span class="hljs-string">'Index'</span>: <span class="hljs-title class_">State</span> variable <span class="hljs-string">'count'</span> has changed during render! <span class="hljs-title class_">It</span><span class="hljs-string">'s illegal to change @Component state while build (initial render or re-render) is on-going. Application error!</span></li></ol></pre></div></div>     <p>在上述示例中，Text组件多渲染了一次。这个错误行为不会造成严重的后果，所以许多开发者忽略了这个日志。</p>     <p>但是，此行为是严重错误的，随着工程的复杂度升级，隐患将逐渐增大。见下一个例子。</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message++}</span>`</span>)</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message++}</span>`</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上面示例的渲染过程为：</p>     <ol>      <li>       <p>创建第一个Text组件，触发this.message改变。</p></li>      <li>       <p>this.message改变又触发第二个Text组件的刷新。</p></li>      <li>       <p>第二个Text组件的刷新又触发this.message的改变，触发第一个Text组件刷新。</p></li>      <li>       <p>循环重新渲染。</p></li>      <li>       <p>系统长时间无响应，appfreeze。</p></li>     </ol>     <p>因此，在build方法中改变状态变量是完全错误的。当发现“FIX THIS APPLICATION ERROR: @Component ... has changed during render! It's illegal to change @Component state while build (initial render or re-render) is on-going. Application error!”日志时，即使当前没有带来严重后果，也应该警惕并修改错误写法。</p>    </div>    <div class="tiledSection">     <h3 id="使用abthisobject形式调用不会触发ui刷新">使用a.b(this.object)形式调用，不会触发UI刷新<i class="anchor-icon anchor-icon-link" anchorid="使用abthisobject形式调用不会触发ui刷新" tips="复制节点链接"></i></h3>          <p>在build方法内，当@State装饰的变量是Object类型、且通过a.b(this.object)形式调用时，b方法内传入的是this.object的原始对象，修改其属性，无法触发UI刷新。如下例中，通过静态方法Balloon.increaseVolume或者this.reduceVolume修改balloon的volume时，UI不会刷新。</p>     <p>【反例】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Balloon</span> {</li><li>  <span class="hljs-attr">volume</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">volume</span> = volume;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">increaseVolume</span>(<span class="hljs-params">balloon:Balloon</span>) {</li><li>    balloon.<span class="hljs-property">volume</span> += <span class="hljs-number">2</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">balloon</span>: <span class="hljs-title class_">Balloon</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Balloon</span>(<span class="hljs-number">10</span>);</li><li>
</li><li>  <span class="hljs-title function_">reduceVolume</span>(<span class="hljs-params">balloon:Balloon</span>) {</li><li>    balloon.<span class="hljs-property">volume</span> -= <span class="hljs-number">1</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>:<span class="hljs-number">8</span>}) {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`The volume of the balloon is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.balloon.volume}</span> cubic centimeters.`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`increaseVolume`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>          <span class="hljs-comment">// 通过静态方法调用，无法触发UI刷新</span></li><li>          <span class="hljs-title class_">Balloon</span>.<span class="hljs-title function_">increaseVolume</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">balloon</span>);</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`reduceVolume`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>          <span class="hljs-comment">// 使用this通过自定义组件内部方法调用，无法触发UI刷新</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reduceVolume</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">balloon</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>状态变量观察类属性变化是通过代理捕获其变化的，当使用a.b(this.object)调用时，框架会将代理对象转换为原始对象。修改原始对象属性，无法观察，因此UI不会刷新。开发者可以使用如下方法修改：</p>     <ol>      <li>先将this.balloon赋值给临时变量。</li>      <li>       <p>再使用临时变量完成原本的调用逻辑。</p>       <p>具体见正例。</p></li>     </ol>     <p>【正例】</p>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Balloon</span> {</li><li>  <span class="hljs-attr">volume</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">volume</span> = volume;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">increaseVolume</span>(<span class="hljs-params">balloon:Balloon</span>) {</li><li>    balloon.<span class="hljs-property">volume</span> += <span class="hljs-number">2</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">balloon</span>: <span class="hljs-title class_">Balloon</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Balloon</span>(<span class="hljs-number">10</span>);</li><li>
</li><li>  <span class="hljs-title function_">reduceVolume</span>(<span class="hljs-params">balloon:Balloon</span>) {</li><li>    balloon.<span class="hljs-property">volume</span> -= <span class="hljs-number">1</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>:<span class="hljs-number">8</span>}) {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`The volume of the balloon is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.balloon.volume}</span> cubic centimeters.`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`increaseVolume`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>          <span class="hljs-comment">// 通过赋值给临时变量保留Proxy代理</span></li><li>          <span class="hljs-keyword">let</span> balloon1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">balloon</span>;</li><li>          <span class="hljs-title class_">Balloon</span>.<span class="hljs-title function_">increaseVolume</span>(balloon1);</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`reduceVolume`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>          <span class="hljs-comment">// 通过赋值给临时变量保留Proxy代理</span></li><li>          <span class="hljs-keyword">let</span> balloon2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">balloon</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reduceVolume</span>(balloon2);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="用注册回调的方式更改状态变量需要执行解注册">用注册回调的方式更改状态变量需要执行解注册<i class="anchor-icon anchor-icon-link" anchorid="用注册回调的方式更改状态变量需要执行解注册" tips="复制节点链接"></i></h3>          <p>开发者可以在aboutToAppear中注册箭头函数，以此改变组件中的状态变量。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>需要在aboutToDisappear中将注册的函数置空，以避免箭头函数捕获自定义组件的this实例，导致自定义组件无法被释放，从而造成内存泄漏。</p>      </div></div></div>     <div _ngcontent-sjj-c106="" class="highlight-div"><div _ngcontent-sjj-c106="" class="highlight-div-header"><div _ngcontent-sjj-c106="" class="highlight-div-header-left"><div _ngcontent-sjj-c106="" class="handle-button expand-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sjj-c106="" class="highlight-div-header-right"><div _ngcontent-sjj-c106="" class="handle-button ai-button"></div><div _ngcontent-sjj-c106="" class="handle-button line-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sjj-c106="" class="handle-button theme-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sjj-c106="" class="handle-button copy-button"><div _ngcontent-sjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sjj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">undefined</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>
</li><li>  <span class="hljs-title function_">add</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = callback;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">delete</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">call</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>();</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">model</span>: <span class="hljs-title class_">Model</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Model</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    model.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`count值: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          model.<span class="hljs-title function_">call</span>();</li><li>        })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    model.<span class="hljs-title function_">delete</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>此外，也可以使用 LocalStorage在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#自定义组件外改变状态变量">自定义组件外改变状态变量</a>。</p>    </div>   </div>   <div></div></div>