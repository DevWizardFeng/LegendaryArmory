<h1 _ngcontent-fsm-c119="" class="doc-title ng-star-inserted" title="@Watch装饰器：状态变量更改通知"> @Watch装饰器：状态变量更改通知 </h1>

<div _ngcontent-fsm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>@Watch应用于对状态变量的监听。如果开发者需要关注某个状态变量的值是否改变，可以使用@Watch为状态变量设置回调函数。</p> <p>@Watch提供了状态变量的监听能力，@Watch仅能监听到可以观察到的变化。</p> <p>在阅读本文档前，建议开发者对状态管理基本观察能力有基本的了解。建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 9开始，该装饰器支持在ArkTS卡片中使用。</p>  <p>从API version 11开始，该装饰器支持在元服务中使用。</p>  </div></div></div>  <div class="tiledSection"><h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2><p>@Watch用于监听状态变量的变化，当状态变量变化时，@Watch的回调方法将被调用。@Watch在ArkUI框架内部判断数值有无更新使用的是严格相等（===），遵循严格相等规范。当严格相等判断的结果是false（即不相等）的情况下，就会触发@Watch的回调。</p> </div>  <div class="tiledSection"><h2 id="装饰器说明">装饰器说明<i class="anchor-icon anchor-icon-link" anchorid="装饰器说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">@Watch补充变量装饰器</th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">装饰器参数</td> <td class="cellrowborder" valign="top" width="50%">必填。常量字符串，字符串需要有引号。是(string) =&gt; void自定义成员函数的方法的引用。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">可装饰的自定义组件变量</td> <td class="cellrowborder" valign="top" width="50%">可监听所有装饰器装饰的状态变量。不允许监听常规变量。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">装饰器的顺序</td> <td class="cellrowborder" valign="top" width="50%">装饰器顺序不影响实际功能，开发者可以根据自己的需要决定装饰器顺序的先后。建议<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link</a>等装饰器在@Watch装饰器之前，以保持整体风格的一致。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">@Watch触发时机</td> <td class="cellrowborder" valign="top" width="50%">使用@Watch来监听状态变量变化时，回调触发时间是变量真正变化、被赋值的时间。详细示例请参考使用场景中的<a href="/consumer/cn/doc/harmonyos-guides/arkts-watch#watch的触发时机">@Watch的触发时机</a>。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="语法说明">语法说明<i class="anchor-icon anchor-icon-link" anchorid="语法说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">(changedPropertyName? : string) =&gt; void</td> <td class="cellrowborder" valign="top" width="50%"><p>该函数是自定义组件的成员函数，changedPropertyName是被watch的属性名。</p> <p>在多个状态变量绑定同一个@Watch的回调方法的时候，可以通过changedPropertyName进行不同的逻辑处理</p> <p>将属性名作为字符串输入参数，不返回任何内容。</p> </td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="观察变化和行为表现">观察变化和行为表现<i class="anchor-icon anchor-icon-link" anchorid="观察变化和行为表现" tips="复制节点链接"></i></h2><ol><li><p>当观察到状态变量的变化（包括双向绑定的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage">AppStorage</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage">LocalStorage</a>中对应的key发生的变化）的时候，对应的@Watch的回调方法将被触发；</p>  </li><li><p>@Watch方法在自定义组件的属性变更之后同步执行；</p>  </li><li><p>如果在@Watch的方法里改变了其他的状态变量，也会引起状态变更和@Watch的执行；</p>  </li><li><p>在第一次初始化的时候，@Watch装饰的方法不会被调用，即认为初始化不是状态变量的改变。只有在后续状态改变时，才会调用@Watch回调方法。</p>  </li></ol> </div>  <div class="tiledSection"><h2 id="限制条件">限制条件<i class="anchor-icon anchor-icon-link" anchorid="限制条件" tips="复制节点链接"></i></h2><ul><li><p>建议开发者避免无限循环。循环可能是因为在@Watch的回调方法里直接或者间接地修改了同一个状态变量引起的。为了避免循环的产生，建议不要在@Watch的回调方法里修改当前装饰的状态变量；</p>  </li><li><p>开发者应关注性能，属性值更新函数会延迟组件的重新渲染（具体请见上面的行为表现），因此，回调函数应仅执行快速运算；</p>  </li><li><p>不建议在@Watch函数中调用async await，因为@Watch设计的用途是为了快速的计算，异步行为可能会导致重新渲染速度的性能问题。</p>  </li><li><p>@Watch参数为必选，且参数类型必须是string，否则编译期会报错。不建议开发者传入undefined，传入后编译不会报错，相当于传入“undefined”。</p>  </li></ul> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 错误写法，编译报错</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>() <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(change) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li><span class="hljs-comment">// 正确写法</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'change'</span>) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-title function_">change</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`xxx`</span>);</li><li>}</li></ol></pre></div></div> <ul><li>@Watch内的参数必须是声明的方法名，否则编译期会报错。</li></ul> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 错误写法，没有对应名称的函数，编译报错</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'change'</span>) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-title function_">onChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`xxx`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 正确写法</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'change'</span>) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-title function_">change</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`xxx`</span>);</li><li>}</li></ol></pre></div></div> <ul><li>常规变量不能被@Watch装饰，否则编译期会报错。</li></ul> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//错误写法</span></li><li><span class="hljs-meta">@Watch</span>(<span class="hljs-string">'change'</span>) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-title function_">change</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`xxx`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 正确写法</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'change'</span>) <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-title function_">change</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`xxx`</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="watch和自定义组件更新" class="firsth2">@Watch和自定义组件更新<i class="anchor-icon anchor-icon-link" anchorid="watch和自定义组件更新" tips="复制节点链接"></i></h3><p>以下示例展示组件更新和@Watch的处理步骤。count在CountModifier中由@State装饰，在TotalView中由@Prop装饰。</p> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">TotalView</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onCountUpdated'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// @Watch 回调</span></li><li>  <span class="hljs-title function_">onCountUpdated</span>(<span class="hljs-attr">propName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Total: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.total}</span>`</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CountModifier</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add to basket'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++</li><li>        })</li><li>      <span class="hljs-title class_">TotalView</span>({ <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>处理步骤：</p> <ol><li><p>CountModifier自定义组件的Button.onClick点击事件自增count。</p>  </li><li><p>由于@State count变量更改，子组件TotalView中的@Prop被更新，其@Watch('onCountUpdated')方法被调用，更新了子组件TotalView 中的total变量。</p>  </li><li><p>子组件TotalView中的Text重新渲染。</p>  </li></ol> </div>  <div class="tiledSection"><h3 id="watch与link组合使用">@Watch与@Link组合使用<i class="anchor-icon anchor-icon-link" anchorid="watch与link组合使用" tips="复制节点链接"></i></h3><p>以下示例说明了如何在子组件中观察@Link变量。</p> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PurchaseItem</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title class_">NextId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">price: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = <span class="hljs-title class_">PurchaseItem</span>.<span class="hljs-property">NextId</span>++;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">price</span> = price;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BasketViewer</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onBasketUpdated'</span>) <span class="hljs-attr">shopBasket</span>: <span class="hljs-title class_">PurchaseItem</span>[];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">totalPurchase</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">updateTotal</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> total = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shopBasket</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, i</span>) =&gt;</span> sum + i.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// 超过100欧元可享受折扣</span></li><li>    <span class="hljs-keyword">if</span> (total &gt;= <span class="hljs-number">100</span>) {</li><li>      total = <span class="hljs-number">0.9</span> * total;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> total;</li><li>  }</li><li>  <span class="hljs-comment">// @Watch 回调</span></li><li>  <span class="hljs-title function_">onBasketUpdated</span>(<span class="hljs-attr">propName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalPurchase</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateTotal</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shopBasket</span>,</li><li>        <span class="hljs-function">(<span class="hljs-params">item: PurchaseItem</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Price: <span class="hljs-subst">${item.price.toFixed(<span class="hljs-number">2</span>)}</span> €`</span>)</li><li>        },</li><li>        <span class="hljs-function">(<span class="hljs-params">item: PurchaseItem</span>) =&gt;</span> item.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>()</li><li>      )</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Total: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.totalPurchase.toFixed(<span class="hljs-number">2</span>)}</span> €`</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BasketModifier</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">shopBasket</span>: <span class="hljs-title class_">PurchaseItem</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Add to basket'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">shopBasket</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PurchaseItem</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">100</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>())))</li><li>        })</li><li>      <span class="hljs-title class_">BasketViewer</span>({ <span class="hljs-attr">shopBasket</span>: $shopBasket })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>处理步骤如下：</p> <ol><li><p>BasketModifier组件的Button.onClick向BasketModifier shopBasket中添加条目；</p>  </li><li><p>@Link装饰的BasketViewer shopBasket值发生变化；</p>  </li><li><p>状态管理框架调用@Watch函数BasketViewer onBasketUpdated 更新BasketViewer TotalPurchase的值；</p>  </li><li><p>@Link shopBasket的改变，新增了数组项，ForEach组件会执行item Builder，渲染构建新的Item项；@State totalPurchase改变，对应的Text组件也重新渲染；重新渲染是异步发生的。</p>  </li></ol> </div>  <div class="tiledSection"><h3 id="watch的触发时机">@Watch的触发时机<i class="anchor-icon anchor-icon-link" anchorid="watch的触发时机" tips="复制节点链接"></i></h3><p>为了展示@Watch回调触发时间是根据状态变量真正变化的时间，本示例在子组件中同时使用@Link和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@ObjectLink</a>装饰器，分别观察不同的状态对象。通过在父组件中更改状态变量并观察@Watch回调的先后顺序，来表明@Watch触发的时机与赋值、同步的关系。</p> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-attr">isFinished</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">isFinished : <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinished</span> = isFinished;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ParentComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onTaskAChanged'</span>) <span class="hljs-attr">taskA</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-literal">false</span>);</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onTaskBChanged'</span>) <span class="hljs-attr">taskB</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-literal">false</span>);</li><li>
</li><li>  <span class="hljs-title function_">onTaskAChanged</span>(<span class="hljs-attr">changedPropertyName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`观测到父组件任务属性变化: <span class="hljs-subst">${changedPropertyName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onTaskBChanged</span>(<span class="hljs-attr">changedPropertyName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`观测到父组件任务属性变化: <span class="hljs-subst">${changedPropertyName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`父组件任务A状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.taskA.isFinished ? <span class="hljs-string">'已完成'</span> : <span class="hljs-string">'未完成'</span>}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`父组件任务B状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.taskB.isFinished ? <span class="hljs-string">'已完成'</span> : <span class="hljs-string">'未完成'</span>}</span>`</span>)</li><li>      <span class="hljs-title class_">ChildComponent</span>({ <span class="hljs-attr">taskA</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskA</span>, <span class="hljs-attr">taskB</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskB</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换任务状态'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskB</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskB</span>.<span class="hljs-property">isFinished</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskA</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskA</span>.<span class="hljs-property">isFinished</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildComponent</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onObjectLinkTaskChanged'</span>) <span class="hljs-attr">taskB</span>: <span class="hljs-title class_">Task</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onLinkTaskChanged'</span>) <span class="hljs-attr">taskA</span>: <span class="hljs-title class_">Task</span>;</li><li>
</li><li>  <span class="hljs-title function_">onObjectLinkTaskChanged</span>(<span class="hljs-attr">changedPropertyName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`观测到子组件@ObjectLink关联的任务属性变化: <span class="hljs-subst">${changedPropertyName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onLinkTaskChanged</span>(<span class="hljs-attr">changedPropertyName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`观测到子组件@Link关联的任务属性变化: <span class="hljs-subst">${changedPropertyName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`子组件任务A状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.taskA.isFinished ? <span class="hljs-string">'已完成'</span> : <span class="hljs-string">'未完成'</span>}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`子组件任务B状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.taskB.isFinished ? <span class="hljs-string">'已完成'</span> : <span class="hljs-string">'未完成'</span>}</span>`</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>处理步骤如下：</p> <ol><li><p>当点击按钮切换任务状态时，父组件首先更新了被@ObjectLink关联的taskB，然后更新了被@Link关联的taskA。</p>  </li><li><p>观察到日志依次显示：</p>  <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">观测到父组件任务属性变化</span>: <span class="hljs-title class_">taskB</span></li><li><span class="hljs-variable">观测到父组件任务属性变化</span>: <span class="hljs-title class_">taskA</span></li><li><span class="hljs-variable">观测到子组件</span>@<span class="hljs-title function_">Link关联的任务属性变化</span>: <span class="hljs-title class_">taskA</span></li><li><span class="hljs-variable">观测到子组件</span>@<span class="hljs-title function_">ObjectLink关联的任务属性变化</span>: <span class="hljs-title class_">taskB</span></li></ol></pre></div></div>  </li><li><p>通过日志可以看到，父组件的回调顺序和修改顺序一致，而子组件中@Link和@ObjectLink的回调触发顺序与父组件中变量更新的顺序不同。这是因为父组件的变量更新是即时的，但子组件中@Link和@ObjectLink获取更新数据的时机不同。@Link的状态更新是同步的，状态变化会立刻触发@Watch回调。而@ObjectLink的更新依赖于父组件的同步，当父组件刷新并将更新后的变量传递给子组件时，@Watch回调才会触发，因此触发顺序略晚于@Link。</p>  </li><li><p>这是符合预期的行为，展示了@Watch回调的触发时机是根据状态变量真正变化的时间。因为@Link直接同步，而@ObjectLink需要等父组件更新子组件变量。类似地，@Prop也可能表现出与@ObjectLink类似的行为，其回调触发时间也会略晚。</p>  </li></ol> </div>  <div class="tiledSection"><h3 id="使用changedpropertyname进行不同的逻辑处理">使用changedPropertyName进行不同的逻辑处理<i class="anchor-icon anchor-icon-link" anchorid="使用changedpropertyname进行不同的逻辑处理" tips="复制节点链接"></i></h3><p>以下示例说明了如何在@Watch函数中使用changedPropertyName进行不同的逻辑处理。</p> <div _ngcontent-fsm-c106="" class="highlight-div"><div _ngcontent-fsm-c106="" class="highlight-div-header"><div _ngcontent-fsm-c106="" class="highlight-div-header-left"><div _ngcontent-fsm-c106="" class="handle-button expand-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsm-c106="" class="highlight-div-header-right"><div _ngcontent-fsm-c106="" class="handle-button ai-button"></div><div _ngcontent-fsm-c106="" class="handle-button line-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsm-c106="" class="handle-button theme-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsm-c106="" class="handle-button copy-button"><div _ngcontent-fsm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UsePropertyName</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'countUpdated'</span>) <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'countUpdated'</span>) <span class="hljs-attr">cabbage</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">fruit</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// @Watch 回调</span></li><li>  <span class="hljs-title function_">countUpdated</span>(<span class="hljs-attr">propName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (propName == <span class="hljs-string">'apple'</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Number of apples: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apple.toString()}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Number of cabbages: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.cabbage.toString()}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Total number of fruits: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.fruit.toString()}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Add apples'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Add cabbages'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cabbage</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>处理步骤如下：</p> <ol><li><p>点击Button('Add apples')时，apple的值发生变化。</p>  </li><li><p>状态管理框架调用@Watch函数countUpdated，发生变化的状态变量名为apple，满足if逻辑条件，fruit的值被改变。</p>  </li><li><p>绑定了apple，fruit状态变量的Text重新渲染。</p>  </li><li><p>点击Button('Add cabbages')时，cabbage的值发生变化。</p>  </li><li><p>状态管理框架调用@Watch函数countUpdated，发生变化的状态变量名为cabbage，不满足if逻辑条件，fruit的值不发生变化。</p>  </li><li><p>绑定了cabbage状态变量的Text重新渲染。</p>  </li></ol> </div> </div> <div></div></div>