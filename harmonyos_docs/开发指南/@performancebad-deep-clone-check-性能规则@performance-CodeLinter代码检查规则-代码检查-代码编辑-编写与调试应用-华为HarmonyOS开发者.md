<h1 _ngcontent-hsa-c119="" class="doc-title ng-star-inserted" title="@performance/bad-deep-clone-check"> @performance/bad-deep-clone-check </h1>

<div _ngcontent-hsa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000002367970246"><p id="ZH-CN_TOPIC_0000002510294277__p176458299713">避免使用不合理深拷贝，如JSON.parse(JSON.stringify(foo))和_.cloneDeep(foo)。</p> <div class="tiledSection"><h2 id="section118281715182614">规则配置<i class="anchor-icon anchor-icon-link" anchorid="section118281715182614" tips="复制节点链接"></i></h2><div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002510294277__screen2316105518263" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// code-linter.json5</span></li><li>{</li><li>  <span class="hljs-string">"rules"</span>: {</li><li>    <span class="hljs-string">"@performance/bad-deep-clone-check"</span>: <span class="hljs-string">"warn"</span>,</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section182418564158">选项<i class="anchor-icon anchor-icon-link" anchorid="section182418564158" tips="复制节点链接"></i></h2><div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" id="ZH-CN_TOPIC_0000002510294277__screen10586133123020" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"@performance/bad-deep-clone-check"</span>: [</li><li>      <span class="hljs-number">1</span>,</li><li>      {</li><li>        <span class="hljs-string">"functions"</span>: [</li><li>          <span class="hljs-string">"utils.clone"</span></li><li>        ]</li><li>      }</li><li>    ]</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section1660912340444">正例<i class="anchor-icon anchor-icon-link" anchorid="section1660912340444" tips="复制节点链接"></i></h2><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002510294277__p9138142142013">正例的深拷贝实现仅作为示例，开发者需根据业务实际情况确认是否使用该实现。</p> <ul id="ZH-CN_TOPIC_0000002510294277__ul1231725842"><li id="li142311925945">该示例实现不支持函数和文档对象模型（Document Object Model）元素的拷贝。函数通常不需要深拷贝。</li><li id="li1429812564451">对于复杂的对象结构，使用该示例性能可能受到影响。</li><li id="li02318251417">对于大型的自定义对象结构，可以使用结构化克隆算法（Structured Clone）或Web Worker。</li></ul> </div></div></div> <div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" id="ZH-CN_TOPIC_0000002510294277__screen8740949123111" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// deepClone.ts</span></li><li><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cloneable</span> = <span class="hljs-built_in">object</span> | <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt; | <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">any</span>&gt; | <span class="hljs-title class_">Date</span> | <span class="hljs-title class_">RegExp</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> deepClone&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span>&gt;(<span class="hljs-attr">source</span>: T, weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()): T {</li><li>  <span class="hljs-comment">// 处理原始类型和函数</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> source !== <span class="hljs-string">'object'</span> || source === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">return</span> source;</li><li>  }</li><li>  <span class="hljs-comment">// 处理循环引用</span></li><li>  <span class="hljs-keyword">if</span> (weakMap.<span class="hljs-title function_">has</span>(source)) {</li><li>    <span class="hljs-keyword">return</span> weakMap.<span class="hljs-title function_">get</span>(source);</li><li>  }</li><li>  <span class="hljs-comment">// 处理特殊对象类型</span></li><li>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(source) <span class="hljs-keyword">as</span> T;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(source.<span class="hljs-property">source</span>, source.<span class="hljs-property">flags</span>) <span class="hljs-keyword">as</span> T;</li><li>  }</li><li>  <span class="hljs-comment">// 处理数组</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(source)) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">cloneArr</span>: <span class="hljs-built_in">any</span>[] = [];</li><li>    weakMap.<span class="hljs-title function_">set</span>(source, cloneArr);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> source) {</li><li>      cloneArr.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">deepClone</span>(item, weakMap));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> cloneArr <span class="hljs-keyword">as</span> T;</li><li>  }</li><li>  <span class="hljs-comment">// 处理Map</span></li><li>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Map</span>) {</li><li>    <span class="hljs-keyword">const</span> cloneMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>    weakMap.<span class="hljs-title function_">set</span>(source, cloneMap);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> source) {</li><li>      cloneMap.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">deepClone</span>(key, weakMap), <span class="hljs-title function_">deepClone</span>(value, weakMap));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> cloneMap <span class="hljs-keyword">as</span> T;</li><li>  }</li><li>  <span class="hljs-comment">// 处理Set</span></li><li>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Set</span>) {</li><li>    <span class="hljs-keyword">const</span> cloneSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();</li><li>    weakMap.<span class="hljs-title function_">set</span>(source, cloneSet);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> source) {</li><li>      cloneSet.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">deepClone</span>(value, weakMap));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> cloneSet <span class="hljs-keyword">as</span> T;</li><li>  }</li><li>  <span class="hljs-comment">// 处理普通对象</span></li><li>  <span class="hljs-keyword">const</span> cloneObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(source));</li><li>  weakMap.<span class="hljs-title function_">set</span>(source, cloneObj);</li><li>  <span class="hljs-comment">// 使用Object.getOwnPropertyDescriptors获取所有属性描述符</span></li><li>  <span class="hljs-keyword">const</span> descriptors = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptors</span>(source);</li><li>
</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, descriptor] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(descriptors)) {</li><li>    <span class="hljs-keyword">if</span> (descriptor.<span class="hljs-property">value</span> !== <span class="hljs-literal">undefined</span>) {</li><li>      descriptor.<span class="hljs-property">value</span> = <span class="hljs-title function_">deepClone</span>(descriptor.<span class="hljs-property">value</span>, weakMap);</li><li>    }</li><li>    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(cloneObj, key, descriptor);</li><li>  }</li><li>  <span class="hljs-comment">// 处理Symbol属性</span></li><li>  <span class="hljs-keyword">const</span> symbolKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(source);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> symbolKeys) {</li><li>    cloneObj[key] = <span class="hljs-title function_">deepClone</span>(source[key <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>], weakMap);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> cloneObj;</li><li>}</li></ol></pre></div></div> <div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002510294277__screen16613163419441" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//example.ts</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">deepClone</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./deepClone'</span>;</li><li>
</li><li><span class="hljs-comment">// 使用示例</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">obj</span> = {</li><li>  <span class="hljs-variable">a</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-variable">b</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>],</li><li>  <span class="hljs-variable">c</span>: { <span class="hljs-variable">d</span>: <span class="hljs-number">4</span> },</li><li>  <span class="hljs-variable">e</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Date</span>(),</li><li>  <span class="hljs-variable">f</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Map</span>([['<span class="hljs-title class_">key</span>', '<span class="hljs-title class_">value</span>']]),</li><li>  <span class="hljs-variable">g</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),</li><li>  <span class="hljs-variable">h</span>: /<span class="hljs-variable">regexp</span>/<span class="hljs-variable">gim</span></li><li>};</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">cloned</span> = <span class="hljs-title function_">deepClone</span>(<span class="hljs-variable">obj</span>);</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section470091981618">反例<i class="anchor-icon anchor-icon-link" anchorid="section470091981618" tips="复制节点链接"></i></h2><div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002510294277__screen189671368456" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-package">_</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 下载lodash依赖：</span></li><li><span class="hljs-comment">* 1、ohpm install lodash</span></li><li><span class="hljs-comment">* 2、ohpm install @types/lodash --save-dev</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Foo</span> {</li><li><span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span>;</li><li><span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>;</li><li>}</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">foo</span>:<span class="hljs-title class_">Foo</span> = {</li><li><span class="hljs-variable">id</span>:<span class="hljs-number">1</span>,</li><li><span class="hljs-variable">name</span>:<span class="hljs-string">"aa"</span></li><li>}</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">clone1</span>:<span class="hljs-title class_">Foo</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">foo</span>)) <span class="hljs-keyword">as</span> <span class="hljs-variable">Foo</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">clone2</span>:<span class="hljs-title class_">Foo</span> = <span class="hljs-variable">_</span>.<span class="hljs-title function_">cloneDeep</span>(<span class="hljs-variable">foo</span>);</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section1613660124014">规则集<i class="anchor-icon anchor-icon-link" anchorid="section1613660124014" tips="复制节点链接"></i></h2><div _ngcontent-hsa-c106="" class="highlight-div"><div _ngcontent-hsa-c106="" class="highlight-div-header"><div _ngcontent-hsa-c106="" class="highlight-div-header-left"><div _ngcontent-hsa-c106="" class="handle-button expand-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hsa-c106="" class="highlight-div-header-right"><div _ngcontent-hsa-c106="" class="handle-button ai-button"></div><div _ngcontent-hsa-c106="" class="handle-button line-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hsa-c106="" class="handle-button theme-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hsa-c106="" class="handle-button copy-button"><div _ngcontent-hsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hsa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002510294277__screen4618649194513" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-variable">plugin</span>:@<span class="hljs-title class_">performance</span>/</span><span class=""><span class="hljs-variable">recommended</span></span></li><li><span class=""><span class="hljs-variable">plugin</span>:@<span class="hljs-title class_">performance</span>/<span class="hljs-variable">all</span></span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002510294277__p72027303176">Code Linter代码检查规则的配置指导请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter">Code Linter代码检查</a>。</p> </div> </div> <div></div></div>