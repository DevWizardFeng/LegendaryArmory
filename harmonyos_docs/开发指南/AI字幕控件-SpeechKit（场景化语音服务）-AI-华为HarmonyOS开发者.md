<h1 _ngcontent-uuf-c119="" class="doc-title ng-star-inserted" title="AI字幕控件"> AI字幕控件 </h1>

<div _ngcontent-uuf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section95081927164310">适用场景<i class="anchor-icon anchor-icon-link" anchorid="section95081927164310" tips="复制节点链接"></i></h2>          <p>AI字幕控件应用广泛，例如在用户不熟悉音频源语言或者静音的时候，为用户提供字幕服务。</p>     <p>本章节将向您介绍如何使用AI字幕组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent" target="_blank">AICaptionComponent</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent#section816451553012" target="_blank">AICaptionController</a>展示AI字幕，效果如下图所示。</p>     <p><span><img height="531.8120710000001" originheight="1940" originwidth="1208" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114226.34921080785237199526389052357970:50001231000000:2800:D76287121C5B37E1D515F3952B1C4C9CF8E9744D29D3D3B103C2F2A9FA2F37A0.jpg" title="点击放大" width="331.17"></span></p>    </div>    <div class="tiledSection">     <h2 id="section1070612236242">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1070612236242" tips="复制节点链接"></i></h2>          <p>AI字幕功能主要由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent" target="_blank">AICaptionComponent</a>提供，更多接口及使用方法请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50.17%">          <p>接口</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="49.830000000000005%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50.17%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent" target="_blank">AICaptionComponent</a></p></td>         <td class="cellrowborder" valign="top" width="49.830000000000005%">          <p>AI字幕组件。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50.17%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent#section15787428226" target="_blank">AICaptionOptions</a></p></td>         <td class="cellrowborder" valign="top" width="49.830000000000005%">          <p>AI字幕初始化参数。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50.17%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/speech-aicaptioncomponent#section816451553012" target="_blank">AICaptionController</a></p></td>         <td class="cellrowborder" valign="top" width="49.830000000000005%">          <p>AI字幕组件的控制器，是AI字幕组件的主要功能入口类，用来操作AI字幕。它所承载的工作包括：写音频数据、获取音频流信息等。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section19768142695511">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section19768142695511" tips="复制节点链接"></i></h2>          <ol>      <li><span>从项目根目录进入/src/main/ets/pages/Index.ets文件，在使用AI字幕控件前，将实现AI字幕控件和其他相关的类添加至工程。</span>       <p></p>       <div _ngcontent-uuf-c106="" class="highlight-div"><div _ngcontent-uuf-c106="" class="highlight-div-header"><div _ngcontent-uuf-c106="" class="highlight-div-header-left"><div _ngcontent-uuf-c106="" class="handle-button expand-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uuf-c106="" class="highlight-div-header-right"><div _ngcontent-uuf-c106="" class="handle-button ai-button"></div><div _ngcontent-uuf-c106="" class="handle-button line-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uuf-c106="" class="handle-button theme-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uuf-c106="" class="handle-button copy-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uuf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AICaptionComponent</span>, <span class="hljs-title class_">AICaptionController</span>, <span class="hljs-title class_">AICaptionOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.SpeechKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>简单配置页面的布局，加入AI字幕组件，并在aboutToAppear中设置AI字幕组件的传入参数。</span>       <p></p>       <div _ngcontent-uuf-c106="" class="highlight-div"><div _ngcontent-uuf-c106="" class="highlight-div-header"><div _ngcontent-uuf-c106="" class="highlight-div-header-left"><div _ngcontent-uuf-c106="" class="handle-button expand-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uuf-c106="" class="highlight-div-header-right"><div _ngcontent-uuf-c106="" class="handle-button ai-button"></div><div _ngcontent-uuf-c106="" class="handle-button line-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uuf-c106="" class="handle-button theme-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uuf-c106="" class="handle-button copy-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uuf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'AI_CAPTION_DEMO'</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">...msg: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, msg.<span class="hljs-title function_">join</span>())</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">...msg: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, msg.<span class="hljs-title function_">join</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> captionOption ?: <span class="hljs-title class_">AICaptionOptions</span>;</li><li>  <span class="hljs-keyword">private</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AICaptionController</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShown</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// AI字幕初始化参数，设置字幕的不透明度和回调函数</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">captionOption</span> = {</li><li>      <span class="hljs-attr">initialOpacity</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">onPrepared</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPrepared'</span>)</li><li>      },</li><li>      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onError, code: <span class="hljs-subst">${error.code}</span>, msg: <span class="hljs-subst">${error.message}</span>`</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">调用</span></span><span class=""><span class="hljs-comment">AICaptionComponent</span></span><span class=""><span class="hljs-comment">组件初始化字幕</span></span></li><li>      <span class="hljs-title class_">AICaptionComponent</span>({</li><li>        <span class="hljs-attr">isShown</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>,</li><li>        <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>,</li><li>        <span class="hljs-attr">options</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">captionOption</span></li><li>      })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>      <span class="hljs-title class_">Divider</span>()</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'上面是字幕区域'</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#7A7D6A'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>在布局中加入两个按钮以及点击事件的回调函数。</span>       <p></p>       <ul>        <li>第一个按钮的回调函数负责控制AI字幕组件的显示状态。</li>        <li>第二个按钮的回调函数负责读取资源目录中的音频文件，将音频数据传给AI字幕组件。</li>       </ul>       <div _ngcontent-uuf-c106="" class="highlight-div"><div _ngcontent-uuf-c106="" class="highlight-div-header"><div _ngcontent-uuf-c106="" class="highlight-div-header-left"><div _ngcontent-uuf-c106="" class="handle-button expand-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uuf-c106="" class="highlight-div-header-right"><div _ngcontent-uuf-c106="" class="handle-button ai-button"></div><div _ngcontent-uuf-c106="" class="handle-button line-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uuf-c106="" class="handle-button theme-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uuf-c106="" class="handle-button copy-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uuf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AudioData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.SpeechKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-attr">isReading</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">readPcmAudio</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">fileData</span>: <span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      fileData =</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getMediaContent</span>($r(<span class="hljs-string">'app.media.chineseAudio'</span>).<span class="hljs-property">id</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`get fileData fail , msg <span class="hljs-subst">${e}</span> `</span>)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (fileData === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> bufferSize = <span class="hljs-number">640</span>;</li><li>    <span class="hljs-keyword">const</span> byteLength = fileData.<span class="hljs-property">byteLength</span>;</li><li>    <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'byteLength'</span>, byteLength.<span class="hljs-title function_">toString</span>())</li><li>    <span class="hljs-keyword">let</span> startTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>    <span class="hljs-keyword">while</span> (offset &lt; byteLength) {</li><li>      <span class="hljs-comment">// 模拟实际情况，读文件比录音机返回流快，所以要等待一段时间</span></li><li>      <span class="hljs-keyword">let</span> nextOffset = offset + bufferSize</li><li>      <span class="hljs-keyword">if</span> (offset &gt; byteLength) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-keyword">return</span></li><li>      }</li><li>      <span class="hljs-keyword">const</span> arrayBuffer = fileData.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(offset, nextOffset);</li><li>      <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'data byteLength'</span>, data.<span class="hljs-property">byteLength</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">audioData</span>: <span class="hljs-title class_">AudioData</span> = {</li><li>        <span class="hljs-attr">data</span>: data</li><li>      }</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`offset: <span class="hljs-subst">${offset}</span> | byteLength: <span class="hljs-subst">${byteLength}</span> | bufferSize: <span class="hljs-subst">${bufferSize}</span>`</span>)</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`writeAudio： <span class="hljs-subst">${audioData.data.byteLength}</span>`</span>)</li><li>       <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">writeAudio</span>(audioData)</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`writeAudio exception`</span>)</li><li>        }</li><li>      }</li><li>      offset = offset + bufferSize;</li><li>      <span class="hljs-keyword">const</span> waitTime = bufferSize / <span class="hljs-number">32</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sleep</span>(waitTime)</li><li>    }</li><li>    <span class="hljs-keyword">let</span> endTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'playtime'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(endTime - startTime))</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">sleep</span>(<span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, time))</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>     <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换字幕显示状态:'</span> + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span> ? <span class="hljs-string">'显示'</span> : <span class="hljs-string">'隐藏'</span>))</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#B8BDA0'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'读取PCM音频'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#B8BDA0'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readPcmAudio</span>()</li><li>          }</li><li>        })</li><li>     <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1976852613552">开发实例<i class="anchor-icon anchor-icon-link" anchorid="section1976852613552" tips="复制节点链接"></i></h2>          <p>Index.ets</p>     <div _ngcontent-uuf-c106="" class="highlight-div"><div _ngcontent-uuf-c106="" class="highlight-div-header"><div _ngcontent-uuf-c106="" class="highlight-div-header-left"><div _ngcontent-uuf-c106="" class="handle-button expand-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uuf-c106="" class="highlight-div-header-right"><div _ngcontent-uuf-c106="" class="handle-button ai-button"></div><div _ngcontent-uuf-c106="" class="handle-button line-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uuf-c106="" class="handle-button theme-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uuf-c106="" class="handle-button copy-button"><div _ngcontent-uuf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uuf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AICaptionComponent</span>, <span class="hljs-title class_">AICaptionOptions</span>, <span class="hljs-title class_">AICaptionController</span>, <span class="hljs-title class_">AudioData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.SpeechKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'AI_CAPTION_DEMO'</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">...msg: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, msg.<span class="hljs-title function_">join</span>())</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">...msg: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, msg.<span class="hljs-title function_">join</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> captionOption?: <span class="hljs-title class_">AICaptionOptions</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">controller</span>: <span class="hljs-title class_">AICaptionController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AICaptionController</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShown</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">isReading</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// AI字幕初始化参数，设置字幕的不透明度和回调函数</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">captionOption</span> = {</li><li>      <span class="hljs-attr">initialOpacity</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">onPrepared</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPrepared'</span>)</li><li>      },</li><li>      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AICaption component error. Error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">readPcmAudio</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-comment">// chineseAudio.pcm文件放在entry\src\main\resources\base\media路径下</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">fileData</span>: <span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      fileData =</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getMediaContent</span>($r(<span class="hljs-string">'app.media.chineseAudio'</span>).<span class="hljs-property">id</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`get fileData fail , msg <span class="hljs-subst">${e}</span> `</span>)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (fileData === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> bufferSize = <span class="hljs-number">640</span>;</li><li>    <span class="hljs-keyword">const</span> byteLength = fileData.<span class="hljs-property">byteLength</span>;</li><li>    <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Pcm data total bytes: <span class="hljs-subst">${byteLength.toString()}</span>`</span>)</li><li>    <span class="hljs-keyword">let</span> startTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>    <span class="hljs-keyword">while</span> (offset &lt; byteLength) {</li><li>      <span class="hljs-comment">// 模拟实际情况，读文件比录音机返回流快，所以要等待一段时间</span></li><li>      <span class="hljs-keyword">let</span> nextOffset = offset + bufferSize</li><li>      <span class="hljs-keyword">if</span> (offset &gt; byteLength) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-keyword">return</span></li><li>      }</li><li>      <span class="hljs-keyword">const</span> arrayBuffer = fileData.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(offset, nextOffset);</li><li>      <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">audioData</span>: <span class="hljs-title class_">AudioData</span> = {</li><li>        <span class="hljs-attr">data</span>: data</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">writeAudio</span>(audioData)</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`writeAudio exception`</span>)</li><li>        }</li><li>      }</li><li>      offset = offset + bufferSize;</li><li>      <span class="hljs-keyword">const</span> waitTime = bufferSize / <span class="hljs-number">32</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sleep</span>(waitTime)</li><li>    }</li><li>    <span class="hljs-keyword">let</span> endTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Audio play time: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(endTime - startTime)}</span>`</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">sleep</span>(<span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, time))</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换字幕显示状态:'</span> + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span> ? <span class="hljs-string">'显示'</span> : <span class="hljs-string">'隐藏'</span>))</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#B8BDA0'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'读取PCM音频'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#B8BDA0'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReading</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readPcmAudio</span>()</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Divider</span>()</li><li>      <span class="hljs-comment">// 调用AICaptionComponent组件初始化字幕</span></li><li>      <span class="hljs-title class_">AICaptionComponent</span>({</li><li>        <span class="hljs-attr">isShown</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>,</li><li>        <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>,</li><li>        <span class="hljs-attr">options</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">captionOption</span></li><li>      })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>      <span class="hljs-title class_">Divider</span>()</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShown</span>) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'上面是字幕区域'</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#7A7D6A'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>