<h1 _ngcontent-per-c119="" class="doc-title ng-star-inserted" title="API使用示例"> API使用示例 </h1>

<div _ngcontent-per-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001824472821"><p id="ZH-CN_TOPIC_0000002478334444__p19106758134517">示例：在工程级hvigorfile.ts文件中分别注册工程级与模块级任务。</p> <div _ngcontent-per-c106="" class="highlight-div"><div _ngcontent-per-c106="" class="highlight-div-header"><div _ngcontent-per-c106="" class="highlight-div-header-left"><div _ngcontent-per-c106="" class="handle-button expand-button"><div _ngcontent-per-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-per-c106="" class="highlight-div-header-right"><div _ngcontent-per-c106="" class="handle-button ai-button"></div><div _ngcontent-per-c106="" class="handle-button line-button"><div _ngcontent-per-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-per-c106="" class="handle-button theme-button"><div _ngcontent-per-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-per-c106="" class="handle-button copy-button"><div _ngcontent-per-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-per-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" id="ZH-CN_TOPIC_0000002478334444__screen13726155354515" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 工程级hvigorfile.ts文件</span></li><li><span class="hljs-keyword">import</span> { hvigor, <span class="hljs-title class_">HvigorNode</span>, <span class="hljs-title class_">HvigorPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/hvigor'</span>;</li><li><span class="hljs-keyword">import</span> { appTasks, <span class="hljs-title class_">OhosHapContext</span>, <span class="hljs-title class_">OhosPluginId</span>, <span class="hljs-title class_">Target</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/hvigor-ohos-plugin'</span>;</li><li>
</li><li><span class="hljs-comment">// 实现自定义插件</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">customPlugin</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">HvigorPlugin</span> {</li><li>  <span class="hljs-keyword">return</span> {</li><li>    <span class="hljs-attr">pluginId</span>: <span class="hljs-string">'customPlugin'</span>,</li><li>    <span class="hljs-title function_">context</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-keyword">return</span> {</li><li>        <span class="hljs-attr">data</span>: <span class="hljs-string">'customPlugin xxx'</span></li><li>      };</li><li>    },</li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">apply</span>(<span class="hljs-attr">currentNode</span>: <span class="hljs-title class_">HvigorNode</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>      hvigor.<span class="hljs-title function_">nodesEvaluated</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-comment">// 注册模块级任务</span></li><li>        <span class="hljs-title function_">hapTask</span>(currentNode);</li><li>      });</li><li>    }</li><li>  };</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">hapTask</span>(<span class="hljs-params">currentNode: HvigorNode</span>) {</li><li>  <span class="hljs-comment">// 等待全部节点加载完成之后获取子节点信息</span></li><li>  currentNode.<span class="hljs-title function_">subNodes</span>(<span class="hljs-function">(<span class="hljs-params">node: HvigorNode</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 获取hap模块上下文信息</span></li><li>    <span class="hljs-keyword">const</span> hapContext = node.<span class="hljs-title function_">getContext</span>(<span class="hljs-title class_">OhosPluginId</span>.<span class="hljs-property">OHOS_HAP_PLUGIN</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">OhosHapContext</span>;</li><li>    <span class="hljs-keyword">const</span> moduleName = hapContext?.<span class="hljs-title function_">getModuleName</span>();</li><li>    hapContext?.<span class="hljs-title function_">targets</span>(<span class="hljs-function">(<span class="hljs-params">target: Target</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> targetName = target.<span class="hljs-title function_">getTargetName</span>();</li><li>      <span class="hljs-keyword">const</span> outputPath = target.<span class="hljs-title function_">getBuildTargetOutputPath</span>();</li><li>      <span class="hljs-comment">// 禁用任务</span></li><li>      node.<span class="hljs-title function_">getTaskByName</span>(<span class="hljs-string">`<span class="hljs-subst">${target.getTargetName()}</span>@SignHap`</span>)?.<span class="hljs-title function_">setEnable</span>(<span class="hljs-literal">false</span>);</li><li>      node.<span class="hljs-title function_">registerTask</span>({</li><li>        <span class="hljs-comment">// 任务名称</span></li><li>        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${targetName}</span>@onlineSignHap`</span>,</li><li>        <span class="hljs-comment">// 任务执行逻辑主体函数</span></li><li>        <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'module Task'</span>);</li><li>        },</li><li>        <span class="hljs-comment">// 配置前置任务依赖</span></li><li>        <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">`<span class="hljs-subst">${targetName}</span>@PackageHap`</span>],</li><li>        <span class="hljs-comment">// 配置任务的后置任务依赖</span></li><li>        <span class="hljs-attr">postDependencies</span>: [<span class="hljs-string">'assembleHap'</span>]</li><li>      });</li><li>    });</li><li>  });</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</li><li>  <span class="hljs-attr">system</span>: appTasks,  <span class="hljs-comment">/* Built-in plugin of Hvigor. It cannot be modified. */</span></li><li>  <span class="hljs-attr">plugins</span>:[<span class="hljs-title function_">customPlugin</span>()]         <span class="hljs-comment">/* Custom plugin to extend the functionality of Hvigor. */</span></li><li>};</li></ol></pre></div></div> </div> <div></div></div>