<h1 _ngcontent-haj-c119="" class="doc-title ng-star-inserted" title="AR物体摆放"> AR物体摆放 </h1>

<div _ngcontent-haj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section15574916175319">概要<i class="anchor-icon anchor-icon-link" anchorid="section15574916175319" tips="复制节点链接"></i></h2>          <p>从5.1.0(18)开始，AR Engine支持物体摆放能力。</p>     <p>本章节通过AR Engine识别设备周围的平面，并允许用户在平面上放置虚拟物体，实现虚拟和现实的融合。AR物体摆放可用于虚拟家具、数字展厅等应用，给用户提供虚实结合的新体验。</p>     <div class="fignone">      <span class="figcap"><b>图1 </b>AR物体摆放示意图</span>      <br><span><img height="446.88" originheight="561" originwidth="656" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114357.38131958722668405082018133469922:50001231000000:2800:44E0CDAB92660BFE185BD7DDFA2CD2B13C4ED2611A475BF88026B7875E9F037C.jpg" title="点击放大" width="523.6875"></span>     </div>     <p>本章节涉及的AR Engine能力如下：</p>     <ul>      <li>运动跟踪能力</li>      <li>环境跟踪能力（平面检测）</li>      <li>命中检测能力</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section4701164061710">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section4701164061710" tips="复制节点链接"></i></h2>          <p>AR物体摆放主要依赖<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，以下接口为AR物体摆放相关接口。详细接口和说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-arkts-api" target="_blank">AR Engine API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="49.94%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50.06%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section07524457283" target="_blank">ARViewContext.init</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>初始化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，初始化AR会话和设置AR渲染场景等。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section9795165613212" target="_blank">ARViewContext.pause</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>暂停相机跟踪与AR场景渲染。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section169251835133414" target="_blank">ARViewContext.destroy</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>销毁<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，释放ARView使用资源，包括AR会话与呈现场景销毁，在退出ARView场景时使用。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section639015333356" target="_blank">ARViewContext.resume</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>用于恢复暂停的相机跟踪与AR场景渲染。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section885612613616" target="_blank">ARViewContext.scene</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>设置ARView的AR场景。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section1371542426" target="_blank">ARViewContext.scene</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获得的AR呈现场景，用于管理空间节点。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section18461161774312" target="_blank">ARViewContext.session</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取AR会话，用于获取相关AR环境跟踪、相机跟踪、命中检测等能力，如相机位姿、平面信息、创建锚点等。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section4323184815436" target="_blank">ARViewContext.config</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>设置AR会话的配置文件，如北向坐标、性能模式等。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section20507194174418" target="_blank">ARViewContext.callback</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>设置回调函数，以根据回调功能实现对应业务逻辑。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1293654414328" target="_blank">ARFrame.getCamera</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取当前帧的摄像机参数对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section43145512417" target="_blank">ARFrame.getUpdatedTrackables</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取更新后的指定类型的可追踪对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section20353182861218" target="_blank">ARFrame.hitTest</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>根据相机投射光线，获取预览区域中的像素坐标（pixelX和pixelY）来确定射线方向，然后检测这个射线在平面或点云中是否有交点。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1448415478356" target="_blank">ARAnchor.getPose</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取锚点在世界坐标系中的位姿信息。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1864219177109" target="_blank">ARHitResult.getHitPose</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取交点位姿。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section727122311104" target="_blank">ARHitResult.getTrackable</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取被命中的可追踪对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section5278038164917" target="_blank">ARPose.getMatrix</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>将位姿数据转换为一个4x4的矩阵。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section171161453144613">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section171161453144613" tips="复制节点链接"></i></h2>          <p>AR Engine仅输出识别到的平面数据。为便于用户观察，开发者可使用AGP（Ark Graphics Platform）渲染引擎或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>绘制识别的平面。关于AGP的介绍可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkgraphics3d-overview" target="_blank">ArkGraphics 3D简介</a>和<a href="https://gitcode.com/openharmony/graphic_graphic_3d" target="_blank">AGP引擎</a>。</p>     <p>对于使用ArkTS的任何AR应用，首先需要创建一个AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，用于管理AR Engine的系统状态。AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>的创建可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-arsession">管理AR会话</a>章节。</p>    </div>    <div class="tiledSection">     <h3 id="section7494111510448" class="firsth2">导入模块<i class="anchor-icon anchor-icon-link" anchorid="section7494111510448" tips="复制节点链接"></i></h3>          <div class="p">      AR物体摆放所需要导入的模块如下。      <div _ngcontent-haj-c106="" class="highlight-div"><div _ngcontent-haj-c106="" class="highlight-div-header"><div _ngcontent-haj-c106="" class="highlight-div-header-left"><div _ngcontent-haj-c106="" class="handle-button expand-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-haj-c106="" class="highlight-div-header-right"><div _ngcontent-haj-c106="" class="handle-button ai-button"></div><div _ngcontent-haj-c106="" class="handle-button line-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-haj-c106="" class="handle-button theme-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-haj-c106="" class="handle-button copy-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-haj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { arEngine, <span class="hljs-title class_">ARView</span>, arViewController } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AREngine'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span>, <span class="hljs-title class_">Scene</span>, <span class="hljs-title class_">Vec3</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics3D'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section16223272317">定义变量<i class="anchor-icon anchor-icon-link" anchorid="section16223272317" tips="复制节点链接"></i></h3>          <p id="ZH-CN_TOPIC_0000002329946682__zh-cn_topic_0000002329786834_p1151639175819">定义变量hitAnchorList存储放置物体处的锚点信息、hitPoseList存储放置物体处的位姿信息和statusBarHeight设备状态栏高度。</p>     <div class="p" id="ZH-CN_TOPIC_0000002329946682__zh-cn_topic_0000002329786834_p464319208490">      用户点击设备的坐标和显示预览流的坐标不一致，预览流的窗口略小于设备屏幕，因此需要减去设备状态栏高度以获取准确的点击坐标。      <div _ngcontent-haj-c106="" class="highlight-div"><div _ngcontent-haj-c106="" class="highlight-div-header"><div _ngcontent-haj-c106="" class="highlight-div-header-left"><div _ngcontent-haj-c106="" class="handle-button expand-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-haj-c106="" class="highlight-div-header-right"><div _ngcontent-haj-c106="" class="handle-button ai-button"></div><div _ngcontent-haj-c106="" class="handle-button line-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-haj-c106="" class="handle-button theme-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-haj-c106="" class="handle-button copy-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-haj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" id="ZH-CN_TOPIC_0000002329946682__zh-cn_topic_0000002329786834_screen26151344631" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">frame</span>: arEngine.<span class="hljs-property">ARFrame</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hitAnchorList</span>: arEngine.<span class="hljs-property">ARAnchor</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hitPoseList</span>: <span class="hljs-title class_">Vec3</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">statusBarHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section1883517144711">显示预览流<i class="anchor-icon anchor-icon-link" anchorid="section1883517144711" tips="复制节点链接"></i></h3>          <p>在ARView中加入点击事件，进行碰撞检测，获取锚点位姿数据加入列表。</p>     <div _ngcontent-haj-c106="" class="highlight-div"><div _ngcontent-haj-c106="" class="highlight-div-header"><div _ngcontent-haj-c106="" class="highlight-div-header-left"><div _ngcontent-haj-c106="" class="handle-button expand-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-haj-c106="" class="highlight-div-header-right"><div _ngcontent-haj-c106="" class="handle-button ai-button"></div><div _ngcontent-haj-c106="" class="handle-button line-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-haj-c106="" class="handle-button theme-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-haj-c106="" class="handle-button copy-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-haj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ARWorldBuilder</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-title class_">ARWorld</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ARWorld</span> {</li><li>  <span class="hljs-meta">@State</span> arContext?: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>) {</li><li>          <span class="hljs-title class_">ARView</span>({ <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> })</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">alignRules</span>({</li><li>              <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>              <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>            })</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">objectCollisionDetection</span>(event);</li><li>            })</li><li>        }</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initARView</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAvoidArea</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onWillDisappear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onShown</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resumeARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取用户点击坐标，获取碰撞检测结果</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">objectCollisionDetection</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">windowX</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">windowY</span>) - statusBarHeight;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Get onclick position, x: <span class="hljs-subst">${x}</span> y: <span class="hljs-subst">${y}</span>.`</span>);</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: arEngine.<span class="hljs-property">ARHitResult</span>[] = frame.<span class="hljs-title function_">hitTest</span>(x, y);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The hitResult size is: <span class="hljs-subst">${result.length}</span>.`</span>);</li><li>      <span class="hljs-keyword">if</span> (!result) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; result.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">hitResult</span>: arEngine.<span class="hljs-property">ARHitResult</span> = result[i];</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">trackable</span>: arEngine.<span class="hljs-property">ARTrackable</span> = hitResult.<span class="hljs-title function_">getTrackable</span>();</li><li>
</li><li>        <span class="hljs-keyword">if</span> (trackable.<span class="hljs-property">type</span> !== arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">PLANE</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">hitPlane</span>: arEngine.<span class="hljs-property">ARPlane</span> = trackable <span class="hljs-keyword">as</span> arEngine.<span class="hljs-property">ARPlane</span>;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">hitPose</span>: arEngine.<span class="hljs-property">ARPose</span> = hitResult.<span class="hljs-title function_">getHitPose</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">inPolygon</span>: <span class="hljs-built_in">boolean</span> = hitPlane.<span class="hljs-title function_">isPoseInPolygon</span>(hitPose);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">distance</span>: <span class="hljs-built_in">number</span> = hitResult.<span class="hljs-property">distance</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The hitResult inPolygon is: <span class="hljs-subst">${inPolygon}</span>, distance is: <span class="hljs-subst">${distance}</span>.`</span>);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (!inPolygon || distance &lt;= <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">hitAnchor</span>: arEngine.<span class="hljs-property">ARAnchor</span> = hitResult.<span class="hljs-title function_">createAnchor</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">pos</span>: <span class="hljs-title class_">Vec3</span> = hitAnchor.<span class="hljs-title function_">getPose</span>().<span class="hljs-property">translation</span>;</li><li>
</li><li>        hitPoseList.<span class="hljs-title function_">push</span>(pos);</li><li>        hitAnchorList.<span class="hljs-title function_">push</span>(hitAnchor);</li><li>
</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting hit result.'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get hitResults. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">Scene</span>.<span class="hljs-title function_">load</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">scene</span>: <span class="hljs-title class_">Scene</span>) =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">viewContext</span>: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-keyword">new</span> arViewController.<span class="hljs-title class_">ARViewContext</span>();</li><li>      viewContext.<span class="hljs-property">scene</span> = scene;</li><li>      viewContext.<span class="hljs-property">callback</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ARViewCallbackImpl</span>();</li><li>      viewContext.<span class="hljs-property">config</span> = {</li><li>        <span class="hljs-attr">type</span>: arEngine.<span class="hljs-property">ARType</span>.<span class="hljs-property">WORLD</span>,</li><li>        <span class="hljs-attr">planeFindingMode</span>: arEngine.<span class="hljs-property">ARPlaneFindingMode</span>.<span class="hljs-property">HORIZONTAL_AND_VERTICAL</span>,</li><li>        <span class="hljs-attr">powerMode</span>: arEngine.<span class="hljs-property">ARPowerMode</span>.<span class="hljs-property">NORMAL</span>,</li><li>        <span class="hljs-attr">semanticMode</span>: arEngine.<span class="hljs-property">ARSemanticMode</span>.<span class="hljs-property">NONE</span>,</li><li>        <span class="hljs-attr">poseMode</span>: arEngine.<span class="hljs-property">ARPoseMode</span>.<span class="hljs-property">GRAVITY</span>,</li><li>        <span class="hljs-attr">depthMode</span>: arEngine.<span class="hljs-property">ARDepthMode</span>.<span class="hljs-property">AUTOMATIC</span>,</li><li>        <span class="hljs-attr">meshMode</span>: arEngine.<span class="hljs-property">ARMeshMode</span>.<span class="hljs-property">DISABLED</span>,</li><li>        <span class="hljs-attr">focusMode</span>: arEngine.<span class="hljs-property">ARFocusMode</span>.<span class="hljs-property">AUTO</span></li><li>      }</li><li>      viewContext.<span class="hljs-title function_">init</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> = viewContext;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in initializing ARView.'</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to init ARView. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>      })</li><li>    })</li><li>  }</li><li>
</li><li> <span class="hljs-comment">// 获取屏幕上减去状态栏的真实高度（预览流高度）</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getAvoidArea</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avoidAreaType</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_SYSTEM</span>;</li><li>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 获取顶部状态栏高度</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">avoidArea</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidArea</span> = data.<span class="hljs-title function_">getWindowAvoidArea</span>(avoidAreaType);</li><li>      statusBarHeight = avoidArea.<span class="hljs-property">topRect</span>.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The statusBarHeight is <span class="hljs-subst">${statusBarHeight}</span>.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to obtain the window. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">stopARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resumeARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">pauseARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section3627140114817">渲染识别的平面和放置的物体<i class="anchor-icon anchor-icon-link" anchorid="section3627140114817" tips="复制节点链接"></i></h3>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section9396615174614" target="_blank">ARViewCallback</a>，使用其中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section52341758194715" target="_blank">onFrameUpdate</a>方法进行帧数据更新，获取平面信息。</p>     <div _ngcontent-haj-c106="" class="highlight-div"><div _ngcontent-haj-c106="" class="highlight-div-header"><div _ngcontent-haj-c106="" class="highlight-div-header-left"><div _ngcontent-haj-c106="" class="handle-button expand-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-haj-c106="" class="highlight-div-header-right"><div _ngcontent-haj-c106="" class="handle-button ai-button"></div><div _ngcontent-haj-c106="" class="handle-button line-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-haj-c106="" class="handle-button theme-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-haj-c106="" class="handle-button copy-button"><div _ngcontent-haj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-haj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARViewCallbackImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">arViewController.ARViewCallback</span> {</li><li>  <span class="hljs-title function_">onAnchorAdd</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onAnchorUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onFrameUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">sysBootTs</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">session</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">arSession</span>: arEngine.<span class="hljs-property">ARSession</span> = ctx.<span class="hljs-property">session</span>;</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      frame = arSession.<span class="hljs-title function_">getFrame</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">camera</span>: arEngine.<span class="hljs-property">ARCamera</span> = frame.<span class="hljs-title function_">getCamera</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">trackable</span>: arEngine.<span class="hljs-property">ARTrackable</span>[] = [];</li><li>
</li><li>      <span class="hljs-keyword">if</span> (camera.<span class="hljs-property">state</span> === arEngine.<span class="hljs-property">ARTrackingState</span>.<span class="hljs-property">TRACKING</span>) {</li><li>        trackable = arSession.<span class="hljs-title function_">getAllTrackables</span>(arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">PLANE</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in getting tracking plane，length is: <span class="hljs-subst">${trackable.length}</span>.`</span>);  <span class="hljs-comment">// 输出识别到的平面数量</span></li><li>      }</li><li>
</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to update data. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>