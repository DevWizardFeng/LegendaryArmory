<h1 _ngcontent-tia-c119="" class="doc-title ng-star-inserted" title="AR物体摆放"> AR物体摆放 </h1>

<div _ngcontent-tia-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section226018341487">概要<i class="anchor-icon anchor-icon-link" anchorid="section226018341487" tips="复制节点链接"></i></h2>          <p>从5.0.0(12)开始，AR Engine支持物体摆放能力。</p>     <p>本章节通过AR Engine识别设备周围的平面，并允许用户在平面上放置虚拟物体，实现虚拟和现实的融合。AR物体摆放可用于虚拟家具、数字展厅等应用，给用户提供虚实结合的新体验。</p>     <div class="fignone">      <span class="figcap"><b>图1 </b>AR物体摆放示意图</span>      <br><span><img height="446.88" originheight="561" originwidth="656" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114357.81359176139236527428477727198706:50001231000000:2800:1CF0E99950461F8FEC821E13F7A19418F585ACD8F532FF620B6A0E25A0EF9E97.jpg" title="点击放大" width="523.6875"></span>     </div>     <p>本章节涉及的AR Engine能力如下：</p>     <ul>      <li>运动跟踪能力</li>      <li>环境跟踪能力（平面检测）</li>      <li>命中检测能力</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section4701164061710">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section4701164061710" tips="复制节点链接"></i></h2>          <p>以下接口为AR物体摆放相关接口。详细接口和说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine" target="_blank">AR Engine API参考</a>。</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.1" valign="top" width="49.94%">         <p>接口名</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.2" valign="top" width="50.06%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga47713cb18234569e03b5216b6c8442d3" target="_blank">HMS_AREngine_ARSession_Create</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>创建一个新的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga2dbf3585f50628750ec855501c043650" target="_blank">AREngine_ARSession</a>会话。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga1d1cacf372a8011a439f0e4e76994259" target="_blank">HMS_AREngine_ARSession_Update</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>更新AR Engine的计算结果。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga6394ae995148abbe3d00082817bf320a" target="_blank">HMS_AREngine_ARSession_Configure</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga2dbf3585f50628750ec855501c043650" target="_blank">AREngine_ARSession</a>会话。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gadfcb9589137a39c5afcb217e18853a9d" target="_blank">HMS_AREngine_ARFrame_Create</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>创建一个新的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gaf35f728a1179ef54a3eba9f1cf021719" target="_blank">AREngine_ARFrame</a>对象，将指针存储到中*outFrame。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga3f23bf747def8303c3fb261a9e9a2286" target="_blank">HMS_AREngine_ARSession_SetDisplayGeometry</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>设置显示的高和宽（以像素为单位）。该高度和宽度是显示视图的高度和宽度，如果不一致，会导致显示相机预览出错。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gac697e4be36db63ed6098f154aa9ac01c" target="_blank">HMS_AREngine_ARSession_SetCameraGLTexture</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>设置可用于存储相机预览流数据的openGL纹理。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gac5b39338f95317671d8de6d4f409cf9c" target="_blank">HMS_AREngine_ARSession_GetAllTrackables</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取所有指定类型的可跟踪对象集合。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gab1782eeeeddc01b77a140af915cb351c" target="_blank">HMS_AREngine_ARTrackableList_AcquireItem</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>从可跟踪列表中获取指定index的对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gabbb03027afb984be8542d00d2eebd063" target="_blank">HMS_AREngine_ARPlane_GetCenterPose</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取从平面的局部坐标系到世界坐标系转换的位姿信息。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gad9377f19261d5bbc2044497729b4e0df" target="_blank">HMS_AREngine_ARFrame_HitTest</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>根据屏幕上兴趣点位置获取命中检测结果。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga131d081663d457c594664c977bd9033c" target="_blank">HMS_AREngine_ARHitResultList_GetSize</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取命中检测结果对象列表中包含的对象数。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gaf165c7a1c9ae003cac2a1c2ac2e5e5c4" target="_blank">HMS_AREngine_ARHitResultList_GetItem</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>在命中检测结果列表中获取指定索引的命中检测结果对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga4b06bcca0f6fc0b081ef8210765d9c91" target="_blank">HMS_AREngine_ARHitResult_Create</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>创建一个空的命中检测结果对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga30abe7b3457c991815dd79fcfaf26018" target="_blank">HMS_AREngine_ARHitResult_AcquireNewAnchor</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>在碰撞命中位置创建一个新的锚点。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gac3a02e30bb7706d87c4c29d38b363840" target="_blank">HMS_AREngine_ARHitResult_AcquireTrackable</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取被命中的可追踪对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga5295c975a0ff3d633a1dde5a8eb70863" target="_blank">HMS_AREngine_ARFrame_AcquireCamera</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取当前帧的相机参数对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gafb471f39563ca1a4947d4f87c77e24e2" target="_blank">HMS_AREngine_ARPose_Create</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>分配并初始化一个新的位姿对象。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.94%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga00df108c4ba187967a10e9c4d2e27d3a" target="_blank">HMS_AREngine_ARCamera_GetPose</a></p></td>        <td class="cellrowborder" valign="top" width="50.06%">         <p>获取当前相机对象在AR世界空间中的位姿。</p></td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="section171161453144613">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section171161453144613" tips="复制节点链接"></i></h2>          <p id="ZH-CN_TOPIC_0000002363865157__zh-cn_topic_0000002363865165_p193824275361">本章节给出了关键开发步骤，完整代码可以参考<a href="https://gitcode.com/harmonyos_samples/arengine_-sample-code_-clientdemo_cpp" target="_blank">示例代码</a>。</p>    </div>    <div class="tiledSection">     <h3 id="section1557014318265" class="firsth2">声明Native接口<i class="anchor-icon anchor-icon-link" anchorid="section1557014318265" tips="复制节点链接"></i></h3>          <p>ArkTS接口声明。</p>     <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">start</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, params: <span class="hljs-built_in">Int32Array</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">show</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">hide</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">update</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">stop</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">init</span>: <span class="hljs-function">(<span class="hljs-params">resmgr: resourceManager.ResourceManager</span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getDistance</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">initImage</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span>, buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">setPath</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, path: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">saveImageDataBaseToLocal</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, path: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getImageCount</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getVolume</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div>     <div class="p">      建立ArkTS接口与C++接口之间的映射。      <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>napi_property_descriptor desc[] = {</li><li>    {<span class="hljs-string">"init"</span>, <span class="hljs-literal">nullptr</span>, Global::Init, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"start"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiOnPageAppear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"show"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiOnPageShow, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"hide"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiOnPageHide, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"update"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiOnPageUpdate, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"stop"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiOnPageDisappear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"getDistance"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiGetDistance, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"initImage"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiInitImage, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"setPath"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiSetPath, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"saveImageDataBaseToLocal"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiSaveImageDataBaseToLocal, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>     napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"getImageCount"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiGetImageCount, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    {<span class="hljs-string">"getVolume"</span>, <span class="hljs-literal">nullptr</span>, NapiManager::NapiGetVolume, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}</li><li>};</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section161403203499">创建UI界面<i class="anchor-icon anchor-icon-link" anchorid="section161403203499" tips="复制节点链接"></i></h3>          <p>创建一个UI界面，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件用于显示相机预览画面，并定时触发每一帧绘制。</p>     <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此代码可参考示例代码：ARSample/entry/src/main/ets/pages/ARWorld.ets。</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptAction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { deviceInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li><span class="hljs-keyword">import</span> arEngineDemo <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ARWorldBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">ARWorld</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ARWorld</span> {</li><li>  <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentMillisecond</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">interval</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isUpdate</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponentId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'ARWorld'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">resMgr</span>: resourceManager.<span class="hljs-property">ResourceManager</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">numberOfPlans</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">rotation</span>: <span class="hljs-built_in">number</span> = deviceInfo.<span class="hljs-property">deviceType</span> === <span class="hljs-string">'tablet'</span> ? <span class="hljs-number">3</span> : <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-title class_">XComponent</span>({ <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>, <span class="hljs-attr">libraryname</span>: <span class="hljs-string">'entry'</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">alignRules</span>({</li><li>            <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>            <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>          })</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">interval</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isUpdate</span>) {</li><li>                <span class="hljs-comment">// 每一帧通过调用AR Engine的Native API update来更新计算结果</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">numberOfPlans</span> = arEngineDemo.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">planeNum</span>();</li><li>              }</li><li>            }, <span class="hljs-number">33</span>) <span class="hljs-comment">// 将帧速率设置为30fps（每33ms刷新一次帧）</span></li><li>          })</li><li>          .<span class="hljs-title function_">onDestroy</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">interval</span>);</li><li>          })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      arEngineDemo.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resMgr</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Int32Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>([<span class="hljs-number">1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">rotation</span>]);</li><li>      arEngineDemo.<span class="hljs-title function_">start</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>, config);</li><li>    })</li><li>    .<span class="hljs-title function_">onWillDisappear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      arEngineDemo.<span class="hljs-title function_">stop</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">onShown</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isUpdate</span> = <span class="hljs-literal">true</span>;</li><li>      arEngineDemo.<span class="hljs-title function_">show</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isUpdate</span> = <span class="hljs-literal">false</span>;</li><li>      arEngineDemo.<span class="hljs-title function_">hide</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentId</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span> = context.<span class="hljs-property">pathStack</span>;</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">messageNotification</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">promptAction</span>: <span class="hljs-title class_">PromptAction</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>();</li><li>    promptAction.<span class="hljs-title function_">showToast</span>({</li><li>      <span class="hljs-attr">message</span>: <span class="hljs-string">'当前特征点较少，无法识别平面，请移动相机。'</span>,</li><li>      <span class="hljs-attr">bottom</span>: <span class="hljs-number">300</span></li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">planeNum</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">numberOfPlans</span> &lt; <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-comment">// 平面数量少于1</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">tempMillisecond</span>: <span class="hljs-built_in">number</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>      <span class="hljs-comment">// 为首次启动的时间分配一个值</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentMillisecond</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentMillisecond</span> = tempMillisecond;</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 当识别平面时间超过10s，则展示一个弹窗</span></li><li>      <span class="hljs-keyword">if</span> (tempMillisecond - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentMillisecond</span> &gt; <span class="hljs-number">10000</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">messageNotification</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentMillisecond</span> = <span class="hljs-number">0</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentMillisecond</span> = <span class="hljs-number">0</span>;</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section183721115521">引入AR Engine<i class="anchor-icon anchor-icon-link" anchorid="section183721115521" tips="复制节点链接"></i></h3>          <p>开发者可参考管理AR会话章节的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-c-arsession#section1410827131110">引入AR Engine</a>。</p>    </div>    <div class="tiledSection">     <h3 id="section1973114294619">创建AR场景<i class="anchor-icon anchor-icon-link" anchorid="section1973114294619" tips="复制节点链接"></i></h3>          <ol>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga47713cb18234569e03b5216b6c8442d3" target="_blank">HMS_AREngine_ARSession_Create</a>函数创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga2dbf3585f50628750ec855501c043650" target="_blank">AREngine_ARSession</a>会话。您可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-c-arsession">管理AR会话</a>创建ARSession。</li>      <li>配置AR会话及预览尺寸。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 【可选】创建一个拥有合理默认配置的配置对象。</span></li><li>AREngine_ARConfig *arConfig = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARConfig_Create</span>(arSession, &amp;arConfig);</li><li><span class="hljs-comment">// 【可选】配置AREngine_ARSession会话。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARSession_Configure</span>(arSession, arConfig);</li><li><span class="hljs-comment">// 【可选】释放指定的配置对象的内存空间。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARConfig_Destroy</span>(arConfig);</li><li>
</li><li><span class="hljs-comment">// 创建一个新的AREngine_ARFrame对象。</span></li><li>AREngine_ARFrame *arFrame = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARFrame_Create</span>(arSession, &amp;arFrame);</li><li><span class="hljs-comment">// 预览区域的实际宽高，如使用xComponent组件显示，则该宽和高是xComponent的宽和高，如果不一致，会导致显示相机预览出错。</span></li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">1440</span>;</li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">1080</span>;</li><li><span class="hljs-comment">// 显示旋转常量，值为AREngine_ARPoseType中定义的枚举值。</span></li><li>AREngine_ARPoseType displayRotation = ARENGINE_POSE_TYPE_IDENTITY;</li><li><span class="hljs-comment">// 设置显示的宽和高（以像素为单位）。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARSession_SetDisplayGeometry</span>(arSession, displayRotation, width, height);</li></ol></pre></div></div></li>      <li>通过OpenGL接口获取纹理ID       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过openGL接口获取纹理ID.</span></li><li>GLuint textureId = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;textureId);</li></ol></pre></div></div></li>      <li>设置OpenGL纹理，存储相机预览流数据。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置可用于存储相机预览流数据的openGL纹理。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARSession_SetCameraGLTexture</span>(arSession, textureId );</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section1786472673419">获取平面<i class="anchor-icon anchor-icon-link" anchorid="section1786472673419" tips="复制节点链接"></i></h3>          <ol>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga1d1cacf372a8011a439f0e4e76994259" target="_blank">HMS_AREngine_ARSession_Update</a>函数更新当前<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gaf35f728a1179ef54a3eba9f1cf021719" target="_blank">AREngine_ARFrame</a>对象。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取帧数据AREngine_ARFrame。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARSession_Update</span>(arSession, arFrame);</li></ol></pre></div></div></li>      <li>获取相机的视图矩阵和相机的投影矩阵，用于后续渲染。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据AREngine_ARFrame对象可以获取相机对象AREngine_ARCamera。</span></li><li>AREngine_ARCamera *arCamera = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARFrame_AcquireCamera</span>(arSession, arFrame, &amp;arCamera);</li><li><span class="hljs-comment">// 获取最新帧中相机的视图矩阵。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARCamera_GetViewMatrix</span>(arSession, arCamera, glm::<span class="hljs-built_in">value_ptr</span>(*viewMat), <span class="hljs-number">16</span>);</li><li><span class="hljs-comment">// 获取用于在相机图像上层渲染虚拟内容的投影矩阵，可用于相机坐标系到裁剪坐标系转换。Near (0.1) Far (100)。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARCamera_GetProjectionMatrix</span>(arSession, arCamera, {<span class="hljs-number">0.1f</span>, <span class="hljs-number">100.f</span>}, glm::<span class="hljs-built_in">value_ptr</span>(*projectionMat), <span class="hljs-number">16</span>);</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>这里直接获取相机的视图矩阵和相机的投影矩阵，是为了便于渲染。获取相机运动中的位姿变化，还可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga00df108c4ba187967a10e9c4d2e27d3a" target="_blank">HMS_AREngine_ARCamera_GetPose</a>函数配合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga1ee66c006ffe8255cc04f2a24c277709" target="_blank">HMS_AREngine_ARPose_GetPoseRaw</a>函数进行获取。详细可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-c-get-pose#section1894312892612">获取设备当前位姿</a>。</p>        </div></div></div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gac5b39338f95317671d8de6d4f409cf9c" target="_blank">HMS_AREngine_ARSession_GetAllTrackables</a>函数获取平面列表。详细可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-c-get-plane">检测环境中的平面</a>章节。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取当前检测到的平面列表。</span></li><li>AREngine_ARTrackableList *planeList = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 创建一个可跟踪对象列表。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARTrackableList_Create</span>(arSession, &amp;planeList);</li><li><span class="hljs-comment">// 获取所有指定类型为ARENGINE_TRACKABLE_PLANE的可跟踪对象集合。</span></li><li>AREngine_ARTrackableType planeTrackedType = ARENGINE_TRACKABLE_PLANE;</li><li><span class="hljs-built_in">HMS_AREngine_ARSession_GetAllTrackables</span>(arSession, planeTrackedType, planeList);</li><li><span class="hljs-type">int32_t</span> planeListSize = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 获取此列表中的可跟踪对象的数量。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARTrackableList_GetSize</span>(arSession, planeList, &amp;planeListSize);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; planeListSize; ++i) {</li><li>    AREngine_ARTrackable *arTrackable = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 从可跟踪列表中获取指定index的对象。</span></li><li>    <span class="hljs-built_in">HMS_AREngine_ARTrackableList_AcquireItem</span>(arSession, planeList, i, &amp;arTrackable);</li><li>    AREngine_ARPlane *arPlane = <span class="hljs-built_in">reinterpret_cast</span>&lt;AREngine_ARPlane*&gt;(arTrackable);</li><li>    <span class="hljs-comment">// 获取当前可跟踪对象的跟踪状态。如果状态为：ARENGINE_TRACKING_STATE_TRACKING（可跟踪状态）才进行绘制。</span></li><li>    AREngine_ARTrackingState outTrackingState;</li><li>    <span class="hljs-built_in">HMS_AREngine_ARTrackable_GetTrackingState</span>(arSession, arTrackable, &amp;outTrackingState);</li><li>    AREngine_ARPlane *subsumePlane = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 获取平面的父平面（一个平面被另一个平面合并时，会产生父平面），如果无父平面返回为NULL。</span></li><li>     <span class="hljs-built_in">HMS_AREngine_ARPlane_AcquireSubsumedBy</span>(arSession, arPlane, &amp;subsumePlane);</li><li>    <span class="hljs-keyword">if</span> (subsumePlane != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">HMS_AREngine_ARTrackable_Release</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;AREngine_ARTrackable*&gt;(subsumePlane));</li><li>        <span class="hljs-comment">// 如果当前平面有父平面，则当前平面不进行展示。否则会出现双平面。</span></li><li>        <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 跟踪状态为：ARENGINE_TRACKING_STATE_TRACKING时才进行绘制。</span></li><li>    <span class="hljs-keyword">if</span> (AREngine_ARTrackingState::ARENGINE_TRACKING_STATE_TRACKING != outTrackingState) {</li><li>        <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 进行平面绘制。</span></li><li>}</li><li><span class="hljs-built_in">HMS_AREngine_ARTrackableList_Destroy</span>(planeList);</li><li>planeList = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga3537ce62e6a92dcdbddff0f39de0fae3" target="_blank">HMS_AREngine_ARPlane_GetPolygon</a>函数获取平面的二维顶点坐标数组，用于绘制平面边界。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取检测到平面的二维顶点数组大小。</span></li><li><span class="hljs-type">int32_t</span> polygonLength = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARPlane_GetPolygonSize</span>(arSession, arPlane, &amp;polygonLength);</li><li>
</li><li><span class="hljs-comment">// 获取检测到平面的二维顶点数组，格式为[x1，z1，x2，z2，...]。</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> verticesSize = polygonLength / <span class="hljs-number">2</span>;</li><li><span class="hljs-function">std::vector&lt;glm::vec2&gt; <span class="hljs-title">raw_vertices</span><span class="hljs-params">(verticesSize)</span></span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARPlane_GetPolygon</span>(arSession, arPlane, glm::<span class="hljs-built_in">value_ptr</span>(raw_vertices.<span class="hljs-built_in">front</span>()), polygonLength);</li><li>
</li><li><span class="hljs-comment">// 局部坐标系顶点坐标。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; verticesSize; ++i) {</li><li>    vertices.<span class="hljs-built_in">emplace_back</span>(raw_vertices[i].x, raw_vertices[i].y, <span class="hljs-number">0.75f</span>);</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga3537ce62e6a92dcdbddff0f39de0fae3" target="_blank">HMS_AREngine_ARPlane_GetPolygon</a>函数获取平面的二维顶点坐标数组格式为[x1，z1，x2，z2，...]。这些值均在平面局部坐标系的x-z平面中定义，须先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gabbb03027afb984be8542d00d2eebd063" target="_blank">HMS_AREngine_ARPlane_GetCenterPose</a>函数获取从平面的局部坐标系到世界坐标系转换的位姿数据，然后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#ga787f4daf9efd13c79737ef18cef6d7c7" target="_blank">HMS_AREngine_ARPose_GetMatrix</a>函数将位姿数据转换成4X4的矩阵，该矩阵与局部坐标系的坐标点做乘法，可以得到局部坐标系到世界坐标系的转换。</p>        </div></div></div></li>      <li>将平面的二维顶点坐标转换到世界坐标系，并绘制平面。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取从平面的局部坐标系到世界坐标系转换的位姿信息。</span></li><li>AREngine_ARPose *scopedArPose = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARPose_Create</span>(arSession, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;scopedArPose);</li><li><span class="hljs-built_in">HMS_AREngine_ARPlane_GetCenterPose</span>(arSession, arPlane, scopedArPose);</li><li>
</li><li><span class="hljs-comment">// 将位姿数据转换成4X4的矩阵，outMatrixColMajor4x4为存放数组，其中的数据按照列优先存储.</span></li><li><span class="hljs-comment">// 该矩阵与局部坐标系的坐标点做乘法，可以得到局部坐标系到世界坐标系的转换。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARPose_GetMatrix</span>(arSession, scopedArPose, glm::<span class="hljs-built_in">value_ptr</span>(modelMat), <span class="hljs-number">16</span>);</li><li><span class="hljs-built_in">HMS_AREngine_ARPose_Destroy</span>(scopedArPose);</li><li>
</li><li><span class="hljs-comment">// 构筑绘制渲染平面所需的数据。</span></li><li><span class="hljs-comment">// 生成三角形。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; verticesSize - <span class="hljs-number">1</span>; ++i) {</li><li>    triangles.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">0</span>);</li><li>    triangles.<span class="hljs-built_in">push_back</span>(i);</li><li>    triangles.<span class="hljs-built_in">push_back</span>(i + <span class="hljs-number">1</span>);</li><li>}</li><li><span class="hljs-comment">// 生成平面包围线。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; verticesSize; ++i) {</li><li>    lines.<span class="hljs-built_in">push_back</span>(i);</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section15166650154413">点击屏幕<i class="anchor-icon anchor-icon-link" anchorid="section15166650154413" tips="复制节点链接"></i></h3>          <ol>      <li>用户点击屏幕后，基于点击事件获取屏幕坐标。可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-nativexcomponent-native-xcomponent" target="_blank">Native XComponent</a>       <p>添加头文件：native_interface_xcomponent.h。</p>       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ace/xcomponent/native_interface_xcomponent.h&gt;</span></span></li></ol></pre></div></div>       <div class="p">        通过点击事件获取屏幕点击坐标。        <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">float</span> pixelX= <span class="hljs-number">0.0f</span>;</li><li><span class="hljs-type">float</span> pixelY= <span class="hljs-number">0.0f</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeXComponent_GetTouchEvent</span>(component, window, &amp;mTouchEvent);</li><li>
</li><li><span class="hljs-keyword">if</span> (ret == OH_NATIVEXCOMPONENT_RESULT_SUCCESS) {</li><li>    <span class="hljs-keyword">if</span> (mTouchEvent.type == OH_NATIVEXCOMPONENT_DOWN) {</li><li>        pixelX= mTouchEvent.touchPoints[<span class="hljs-number">0</span>].x;</li><li>    pixelY= mTouchEvent.touchPoints[<span class="hljs-number">0</span>].y;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>       </div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gad9377f19261d5bbc2044497729b4e0df" target="_blank">HMS_AREngine_ARFrame_HitTest</a>函数进行碰撞检测，结果存放在碰撞检测结果列表中。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个命中检测结果对象列表，arSession为创建AR场景步骤中创建的会话对象。</span></li><li>AREngine_ARHitResultList *hitResultList = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARHitResultList_Create</span>(arSession, &amp;hitResultList);</li><li>
</li><li><span class="hljs-comment">// 获取命中检测结果对象列表，arFrame为创建AR场景步骤中创建的帧对象，pixelX/pixelY为屏幕点坐标。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARFrame_HitTest</span>(arSession, arFrame, pixelX, pixelY, hitResultList);</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>碰撞结果按照交点与设备的距离从近到远进行排序，存放在碰撞结果列表中。</p>        </div></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section16528153017483">放置虚拟物体<i class="anchor-icon anchor-icon-link" anchorid="section16528153017483" tips="复制节点链接"></i></h3>          <ol>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gaf165c7a1c9ae003cac2a1c2ac2e5e5c4" target="_blank">HMS_AREngine_ARHitResultList_GetItem</a>函数遍历碰撞检测结果列表，获取命中的可跟踪对象。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建命中检测结果对象。</span></li><li>AREngine_ARHitResult *arHit = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARHitResult_Create</span>(arSession, &amp;arHit);</li><li>
</li><li><span class="hljs-comment">// 获取第一个命中检测结果对象。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARHitResultList_GetItem</span>(arSession, hitResultList, <span class="hljs-number">0</span>, arHit);</li><li>
</li><li><span class="hljs-comment">// 获取被命中的可追踪对象。</span></li><li>AREngine_ARTrackable *arHitTrackable = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARHitResult_AcquireTrackable</span>(arSession, arHit, &amp;arHitTrackable);</li></ol></pre></div></div></li>      <li>判断碰撞结果是否存在于平面内部。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>AREngine_ARTrackableType ar_trackable_type = ARENGINE_TRACKABLE_INVALID;</li><li><span class="hljs-built_in">HMS_AREngine_ARTrackable_GetType</span>(arSession, arTrackable, &amp;ar_trackable_type);</li><li><span class="hljs-keyword">if</span> (ARENGINE_TRACKABLE_PLANE == ar_trackable_type) {</li><li>    AREngine_ARPose *arPose = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">HMS_AREngine_ARPose_Create</span>(arSession, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;arPose);</li><li>    <span class="hljs-built_in">HMS_AREngine_ARHitResult_GetHitPose</span>(arSession, arHit, arPose);</li><li>    <span class="hljs-comment">// 判断位姿是否位于平面的多边形范围内。0表示不在范围内，非0表示在范围内。</span></li><li>    <span class="hljs-built_in">HMS_AREngine_ARPlane_IsPoseInPolygon</span>(arSession, arPlane, arPose, &amp;inPolygon);</li><li>    <span class="hljs-built_in">HMS_AREngine_ARPose_Destroy</span>(arPose);</li><li>    <span class="hljs-keyword">if</span> (!inPolygon) {</li><li>    <span class="hljs-comment">// 不在平面内，就跳过当前平面。</span></li><li>    <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>在碰撞结果位置创建一个新的锚点，并基于此锚点放置虚拟模型。       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在碰撞命中位置创建一个新的锚点。</span></li><li>AREngine_ARAnchor *anchor = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARHitResult_AcquireNewAnchor</span>(arSession, arHitResult, &amp;anchor);</li><li>
</li><li><span class="hljs-comment">// 判断锚点的可跟踪状态</span></li><li>AREngine_ARTrackingState trackingState = ARENGINE_TRACKING_STATE_STOPPED;</li><li><span class="hljs-built_in">HMS_AREngine_ARAnchor_GetTrackingState</span>(arSession, anchor, &amp;trackingState);</li><li><span class="hljs-keyword">if</span> (trackingState != ARENGINE_TRACKING_STATE_TRACKING) {</li><li>    <span class="hljs-built_in">HMS_AREngine_ARAnchor_Release</span>(anchor);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li></ol></pre></div></div></li>      <li>绘制模型。       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-capi-arengine#gad937acfc5d49f0909bdd84677bb0731a" target="_blank">HMS_AREngine_ARAnchor_GetPose</a>函数获取锚点位姿，并基于该位姿绘制虚拟模型。</p>       <div _ngcontent-tia-c106="" class="highlight-div"><div _ngcontent-tia-c106="" class="highlight-div-header"><div _ngcontent-tia-c106="" class="highlight-div-header-left"><div _ngcontent-tia-c106="" class="handle-button expand-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tia-c106="" class="highlight-div-header-right"><div _ngcontent-tia-c106="" class="handle-button ai-button"></div><div _ngcontent-tia-c106="" class="handle-button line-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tia-c106="" class="handle-button theme-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tia-c106="" class="handle-button copy-button"><div _ngcontent-tia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tia-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取锚点的位姿。</span></li><li>AREngine_ARPose *pose = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">HMS_AREngine_ARPose_Create</span>(arSession, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;pose);</li><li><span class="hljs-built_in">HMS_AREngine_ARAnchor_GetPose</span>(arSession, anchor, pose);</li><li><span class="hljs-comment">// 将位姿数据转换成4X4的矩阵modelMat。</span></li><li><span class="hljs-built_in">HMS_AREngine_ARPose_GetMatrix</span>(arSession, pose, glm::<span class="hljs-built_in">value_ptr</span>(modelMat), <span class="hljs-number">16</span>);</li><li><span class="hljs-built_in">HMS_AREngine_ARPose_Destroy</span>(pose);</li><li><span class="hljs-comment">// 绘制虚拟模型。</span></li><li><span class="hljs-comment">// 开发者可以使用OpenGL进行模型绘制，可参考示例代码：world_render_manager.cpp及world_object_renderer.cpp。</span></li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>