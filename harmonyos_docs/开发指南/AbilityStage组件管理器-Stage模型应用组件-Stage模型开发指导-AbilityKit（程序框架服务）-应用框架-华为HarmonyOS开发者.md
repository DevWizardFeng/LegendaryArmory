<h1 _ngcontent-guc-c119="" class="doc-title ng-star-inserted" title="AbilityStage组件管理器"> AbilityStage组件管理器 </h1>

<div _ngcontent-guc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage" target="_blank">AbilityStage</a>是一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-package-overview#应用的多module设计机制">Module</a>级别的组件管理器，应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hap-package">HAP</a>在首次加载时会创建一个AbilityStage实例，可以对该Module进行初始化等操作。AbilityStage与Module一一对应，即一个Module拥有一个AbilityStage。</p>     <p>AbilityStage拥有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#oncreate" target="_blank">onCreate()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#ondestroy12" target="_blank">onDestroy()</a>生命周期回调和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onacceptwant" target="_blank">onAcceptWant()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onconfigurationupdate" target="_blank">onConfigurationUpdate()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onmemorylevel" target="_blank">onMemoryLevel()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onnewprocessrequest11" target="_blank">onNewProcessRequest()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onpreparetermination15" target="_blank">onPrepareTermination()</a>等事件回调。</p>     <ul>      <li>       <p>onCreate()生命周期回调：在开始加载对应Module的第一个应用组件（如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility组件</a>或具体扩展能力的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-extensionability" target="_blank">ExtensionAbility组件</a>）实例之前会先创建AbilityStage，并在AbilityStage创建完成之后执行其onCreate()生命周期回调。AbilityStage模块提供在Module加载的时候，通知开发者，可以在此进行该Module的初始化（如资源预加载、线程创建等）。</p></li>      <li>       <p>onAcceptWant()事件回调：UIAbility<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-launch-type#specified启动模式">指定实例模式（specified）</a>启动时候触发的事件回调，具体使用请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-launch-type">UIAbility启动模式综述</a>。</p></li>      <li>       <p>onConfigurationUpdate()事件回调：当系统环境变量（例如系统语言、深浅色等）发生变更时触发的事件回调，配置项均定义在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-configuration" target="_blank">Configuration</a>类中。</p></li>      <li>       <p>onMemoryLevel()事件回调：当系统调整内存时触发的事件回调。应用被切换到后台时，系统会将在后台的应用保留在缓存中。即使应用处于缓存中，也会影响系统整体性能。当系统资源不足时，系统会通过多种方式从应用中回收内存，必要时会完全停止应用，从而释放内存用于执行关键任务。为了进一步保持系统内存的平衡，避免系统停止用户的应用进程，可以在AbilityStage中的onMemoryLevel()生命周期回调中订阅系统内存的变化情况，释放不必要的资源。</p></li>      <li>       <p>onNewProcessRequest()事件回调：UIAbility启动时触发的事件回调。通过该回调，开发者可以指定每个UIAbility启动时是否在独立的进程中创建。该回调返回一个开发者自定义字符串标识，如果返回的字符串标识为开发者曾创建的，则复用该标识所对应的进程，否则创建新的进程。需要注意该回调需要配合在module.json5中声明<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#abilities标签">isolationProcess</a>字段为true。</p></li>      <li>       <p>onPrepareTermination()事件回调：当应用被用户关闭时调用，可用于询问用户选择立即执行操作还是取消操作。开发者通过在回调中返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilityconstant#preparetermination15" target="_blank">AbilityConstant.PrepareTermination</a>中定义的枚举类型通知系统是否继续执行关闭动作。</p></li>      <li>       <p>onDestroy()生命周期回调：当对应Module的最后一个Ability实例退出后触发。此方法仅在应用正常销毁时触发。当应用程序异常退出或被终止时，将不会调用此方法。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="创建abilitystage文件" class="firsth2">创建AbilityStage文件<i class="anchor-icon anchor-icon-link" anchorid="创建abilitystage文件" tips="复制节点链接"></i></h3>          <p>DevEco Studio默认工程中未自动生成AbilityStage，如需要使用AbilityStage的能力，可以手动新建一个AbilityStage文件，具体步骤如下。</p>     <ol>      <li>       <p>在工程Module对应的ets目录下，右键选择“New &gt; Directory”，新建一个目录并命名为myabilitystage。</p></li>      <li>       <p>在myabilitystage目录，右键选择“New &gt; ArkTS File”，新建一个文件并命名为MyAbilityStage.ets。</p></li>      <li>       <p>打开MyAbilityStage.ets文件，导入AbilityStage的依赖包，自定义类继承AbilityStage并加上需要的生命周期回调，示例中增加了一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#oncreate" target="_blank">onCreate()</a>生命周期回调。</p>       <div _ngcontent-guc-c106="" class="highlight-div"><div _ngcontent-guc-c106="" class="highlight-div-header"><div _ngcontent-guc-c106="" class="highlight-div-header-left"><div _ngcontent-guc-c106="" class="handle-button expand-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-guc-c106="" class="highlight-div-header-right"><div _ngcontent-guc-c106="" class="handle-button ai-button"></div><div _ngcontent-guc-c106="" class="handle-button line-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-guc-c106="" class="handle-button theme-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-guc-c106="" class="handle-button copy-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-guc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityStage</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbilityStage</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 应用HAP首次加载时触发，可以在此执行该Module的初始化操作（例如资源预加载、线程创建等）。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onAcceptWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-comment">// 仅specified模式下触发</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'MyAbilityStage'</span>;</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file">module.json5配置文件</a>中，通过配置 srcEntry 参数来指定模块对应的代码路径，以作为HAP加载的入口。</p>       <div _ngcontent-guc-c106="" class="highlight-div"><div _ngcontent-guc-c106="" class="highlight-div-header"><div _ngcontent-guc-c106="" class="highlight-div-header-left"><div _ngcontent-guc-c106="" class="handle-button expand-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-guc-c106="" class="highlight-div-header-right"><div _ngcontent-guc-c106="" class="handle-button ai-button"></div><div _ngcontent-guc-c106="" class="handle-button line-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-guc-c106="" class="handle-button theme-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-guc-c106="" class="handle-button copy-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-guc-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/myabilitystage/MyAbilityStage.ets"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="监听系统环境变量的变化">监听系统环境变量的变化<i class="anchor-icon anchor-icon-link" anchorid="监听系统环境变量的变化" tips="复制节点链接"></i></h3>          <p>下面以监听系统环境变量的变化的开发场景为例，介绍AbilityStage组件回调函数的使用。</p>     <ul>      <li>       <p>在onCreate()生命周期中，通过EnvironmentCallback来监听系统环境变化，例如系统语言、深浅色模式、屏幕方向、字体大小缩放比例、字体粗细缩放比例等信息。</p></li>      <li>       <p>当系统环境变量发生变更时，会触发EnvironmentCallback中的onConfigurationUpdated()回调，并打印相关信息。</p></li>      <li>       <p>通过关闭应用进程，可以触发AbilityStage的onDestroy()生命周期回调。</p>       <div _ngcontent-guc-c106="" class="highlight-div"><div _ngcontent-guc-c106="" class="highlight-div-header"><div _ngcontent-guc-c106="" class="highlight-div-header-left"><div _ngcontent-guc-c106="" class="handle-button expand-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-guc-c106="" class="highlight-div-header-right"><div _ngcontent-guc-c106="" class="handle-button ai-button"></div><div _ngcontent-guc-c106="" class="handle-button line-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-guc-c106="" class="handle-button theme-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-guc-c106="" class="handle-button copy-button"><div _ngcontent-guc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-guc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">EnvironmentCallback</span>, <span class="hljs-title class_">AbilityStage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbilityStage</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AbilityStage onCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">envCallback</span>: <span class="hljs-title class_">EnvironmentCallback</span> = {</li><li>      <span class="hljs-title function_">onConfigurationUpdated</span>(<span class="hljs-params">config</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`envCallback onConfigurationUpdated success: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(config)}</span>`</span>);</li><li>        <span class="hljs-keyword">let</span> language = config.<span class="hljs-property">language</span>; <span class="hljs-comment">//应用程序的当前语言</span></li><li>        <span class="hljs-keyword">let</span> colorMode = config.<span class="hljs-property">colorMode</span>; <span class="hljs-comment">//深浅色模式</span></li><li>        <span class="hljs-keyword">let</span> direction = config.<span class="hljs-property">direction</span>; <span class="hljs-comment">//屏幕方向</span></li><li>        <span class="hljs-keyword">let</span> fontSizeScale = config.<span class="hljs-property">fontSizeScale</span>; <span class="hljs-comment">//字体大小缩放比例</span></li><li>        <span class="hljs-keyword">let</span> fontWeightScale = config.<span class="hljs-property">fontWeightScale</span>; <span class="hljs-comment">//字体粗细缩放比例</span></li><li>      },</li><li>      <span class="hljs-title function_">onMemoryLevel</span>(<span class="hljs-params">level</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onMemoryLevel level: <span class="hljs-subst">${level}</span>`</span>);</li><li>      }</li><li>    };</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> applicationContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>();</li><li>      <span class="hljs-keyword">let</span> callbackId = applicationContext.<span class="hljs-title function_">on</span>(<span class="hljs-string">'environment'</span>, envCallback);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`callbackId: <span class="hljs-subst">${callbackId}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (paramError) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error: <span class="hljs-subst">${(paramError <span class="hljs-keyword">as</span> BusinessError).code}</span>, <span class="hljs-subst">${(paramError <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 通过onDestroy()方法，可以监听到Ability的销毁事件。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AbilityStage onDestroy'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>