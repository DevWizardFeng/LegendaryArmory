<h1 _ngcontent-syw-c119="" class="doc-title ng-star-inserted" title="App Killed（应用终止）检测"> App Killed（应用终止）检测 </h1>

<div _ngcontent-syw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>应用闪退指应用在使用过程中突然异常终止。当应用行为异常，比如消耗过多CPU、内存等系统资源时，系统为了保持整机健康状态，会按照规则挑选应用进行管控，通常通过服务进程向应用发送SIGKILL信号（信号值是9）来实施终止的。操作系统对SIGKILL的默认行为是不生成栈日志等维测信息的，导致应用闪退时faultlogger中无日志。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p>应用退出通常包含以下几种情况：</p>     <ol>      <li>       <p>应用自身发生异常或主动抛出异常，例如因SIGSEGV、SIGABRT触发的CPP_CRASH异常，系统可监控并记录维测日志。</p></li>      <li>       <p>用户主动终止应用，例如在任务列表中点击清理按钮以清除所有应用，或上划清除单个应用，不会生成栈等维测日志。</p></li>      <li>       <p>应用开发者主动调用exit系统调用时，不会生成栈等维测日志。</p></li>      <li>       <p>应用发生主线程堵塞，导致界面冻结，通常会生成APP_FREEZE日志。</p></li>      <li>       <p>资源使用过度将导致系统对应用进行管控，并提供详细的维测信息。例如，应用发生内存泄漏时，通常会生成资源泄漏类的维测日志。开发者可以通过HiAppEvent订阅RESOURCE_OVERLIMIT获取对应的事件和日志。</p></li>      <li>       <p>系统对应用进行管控时，部分场景无法提供详细的维测信息，比如LowMemoryKiller、应用的RSS内存超过4G、快速泄漏等。</p></li>     </ol>     <p>本节主要覆盖在场景5和6中因SIGKILL信号导致的应用终止。</p>    </div>    <div class="tiledSection">     <h2 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>内核和服务进程都会监控系统资源。</p></li>      <li>       <p>发现异常后，选择应用进行管控。</p></li>      <li>       <p>系统触发管控，终止应用时会添加系统事件打点。</p></li>      <li>       <p>打点事件中包含uid、包名、前后台信息、终止原因和维测信息。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="约束和限制">约束和限制<i class="anchor-icon anchor-icon-link" anchorid="约束和限制" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>应用需先通过HiAppEvent订阅，才能接收终止事件。</p></li>      <li>       <p>终止事件以异步的方式传递给应用，应用需在下次启动时才能接收到。</p></li>      <li>       <p>系统的管控行为会随着版本演进而不断新增，不保证当前的管控机制是系统的全部。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="触发场景">触发场景<i class="anchor-icon anchor-icon-link" anchorid="触发场景" tips="复制节点链接"></i></h2>          <p>系统终止应用，有以下的场景:</p>     <ol>      <li>       <p>应用的内存、CPU和IO类负载超过一定限额，文件句柄和线程数量超标。</p></li>      <li>       <p>整机低内存时，会根据内存使用情况和优先级终止应用。</p></li>      <li>       <p>功耗类检查，包括应用Binder调用导致频繁唤醒、音频播放或录音导致系统无法冻结、GPS或蓝牙等外设使用异常问题。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="感知方式">感知方式<i class="anchor-icon anchor-icon-link" anchorid="感知方式" tips="复制节点链接"></i></h2>          <p>应用可以通过两种方式感知到被异常终止。</p>     <ol>      <li>       <p>从元能力的Ability的onCreate回调参数中获取终止原因。具体为LaunchParam启动参数中的LastExitReason字段，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilityconstant#lastexitreason" target="_blank">元能力LastExitReason章节</a>。</p></li>      <li>       <p>通过HiAppEvent订阅APP_KILLED事件。订阅方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-app-killed-events">HiAppEvent章节</a>。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="分析思路和分析步骤">分析思路和分析步骤<i class="anchor-icon anchor-icon-link" anchorid="分析思路和分析步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>从Ability的onCreate回调参数中获取终止原因。</p>       <p>可以参考下表进行处理。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.5.1.1" valign="top" width="25%">lastExitReason(enum)</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.5.1.2" valign="top" width="25%">lastExitMessage(string)</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.5.1.3" valign="top" width="25%">产生原因</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.5.1.4" valign="top" width="25%">处理策略</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="25%">APP_FREEZE</td>           <td class="cellrowborder" valign="top" width="25%">APP_FREEZE</td>           <td class="cellrowborder" valign="top" width="25%">由于watchdog检测出应用Freeze故障，导致应用程序退出。</td>           <td class="cellrowborder" valign="top" width="25%">通过HiAppEvent订阅APP_FREEZE事件，到APP_FREEZE事件中去匹配。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">CPU Highload</td>           <td class="cellrowborder" valign="top" width="25%">CPU高负载。</td>           <td class="cellrowborder" valign="top" width="25%">尝试降低应用自身的CPU负载。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">CPU_EXT Highload</td>           <td class="cellrowborder" valign="top" width="25%">快速CPU负载检测。</td>           <td class="cellrowborder" valign="top" width="25%">尝试降低应用自身的CPU负载。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">IO Manager Control</td>           <td class="cellrowborder" valign="top" width="25%">I/O管控。</td>           <td class="cellrowborder" valign="top" width="25%">尝试降低应用自身的I/O。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">App Memory Deterioration</td>           <td class="cellrowborder" valign="top" width="25%">应用内存超限劣化。</td>           <td class="cellrowborder" valign="top" width="25%">尝试通过HiAppEvent订阅RESOURCE_OVERLIMIT获取更多日志。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">Temperature Control</td>           <td class="cellrowborder" valign="top" width="25%">温度管控。</td>           <td class="cellrowborder" valign="top" width="25%">尝试降低应用自身的CPU负载。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">RESOURCE_CONTROL</td>           <td class="cellrowborder" valign="top" width="25%">Memory Pressure</td>           <td class="cellrowborder" valign="top" width="25%">整机低内存触发，按优先级由低到高终止应用。</td>           <td class="cellrowborder" valign="top" width="25%">尝试降低应用自身的内存占用，以减少被整机管控策略选中的概率。</td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p>通过HiAppEvent订阅APP_KILLED事件。</p>       <p>通过APP_KILLED事件，可以获取终止原因、应用前后台等关键信息，对照下表进行处理：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.3.1.6.1.1" valign="top" width="20%">reason(string)</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.3.1.6.1.2" valign="top" width="20%">产生原因</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.3.1.6.1.3" valign="top" width="20%">处理策略</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.3.1.6.1.4" valign="top" width="20%">是否应用自身异常触发管控</th>           <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.3.1.6.1.5" valign="top" width="20%">是否有关联事件</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="20%">LowMemoryKill</td>           <td class="cellrowborder" valign="top" width="20%">同前面的lastExitMessage值为Memory Pressure场景，即整机低内存触发，优先级由低到高终止应用。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用自身的内存占用，以减少被整机终止策略选中的概率。</td>           <td class="cellrowborder" valign="top" width="20%">否</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">SwapFull</td>           <td class="cellrowborder" valign="top" width="20%">Swap交换空间接近占满，可能存在个别进程内存泄漏，或者是后台进程个数太多。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用自身的内存占用，以减少被整机管控策略选中的概率。</td>           <td class="cellrowborder" valign="top" width="20%">否</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">ResourceLeak(IonLeak)</td>           <td class="cellrowborder" valign="top" width="20%">应用占用的ION内存超标。</td>           <td class="cellrowborder" valign="top" width="20%">尝试通过HiAppEvent订阅RESOURCE_OVERLIMIT获取更多的ION内存日志，找到泄漏点后，降低应用自身的ION内存占用，一般来说是Image组件或者Pixmap泄漏导致。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">是</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">ResourceLeak(GpuRsLeak)</td>           <td class="cellrowborder" valign="top" width="20%">应用的ArkUI组件在render_service服务进程占用的GPU内存超标。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用ArkUI组件的GPU内存占用。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">ResourceLeak(GpuLeak)</td>           <td class="cellrowborder" valign="top" width="20%">应用在本进程内占用的GPU内存（即自渲染产生的GPU内存）超标。</td>           <td class="cellrowborder" valign="top" width="20%">尝试通过HiAppEvent订阅RESOURCE_OVERLIMIT获取更多的GPU内存日志，找到泄漏点后，降低应用自渲染（使用XComponent组件）的GPU内存占用。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">是</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">ResourceLeak(AshmemLeak)</td>           <td class="cellrowborder" valign="top" width="20%">应用占用的ashmem内存超标。</td>           <td class="cellrowborder" valign="top" width="20%">尝试通过HiAppEvent订阅RESOURCE_OVERLIMIT获取更多的ashmem内存日志，找到泄漏点后，降低应用自身的ashmem内存占用，一般来说是Image组件或者Pixmap泄漏导致。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">是</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">IllegalAudioRendererBySuspend</td>           <td class="cellrowborder" valign="top" width="20%">未申请合理的后台任务，但是后台有大量音频播放。</td>           <td class="cellrowborder" valign="top" width="20%">应用退至后台时，应避免不必要的后台音频播放，或者合理使用后台任务，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview">后台任务开发服务</a>。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">PowerSaveClean</td>           <td class="cellrowborder" valign="top" width="20%">整机切换到省电模式或应急模式。</td>           <td class="cellrowborder" valign="top" width="20%">无需处理。</td>           <td class="cellrowborder" valign="top" width="20%">否</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">RssThresholdKiller</td>           <td class="cellrowborder" valign="top" width="20%">应用的RSS内存超一定阈值。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用自身的内存占用，避免出现RSS内存超过阈值的情况。</td>           <td class="cellrowborder" valign="top" width="20%">是</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">OomKiller</td>           <td class="cellrowborder" valign="top" width="20%">整机低内存，触发了内核管控，按照一定策略终止应用。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用自身的内存占用，以减少被整机管控策略选中的概率。</td>           <td class="cellrowborder" valign="top" width="20%">否</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="20%">CpaKiller</td>           <td class="cellrowborder" valign="top" width="20%">DRM(Digital Right Management)业务申请内存但是内存不足时，会按照一定策略终止进程以回收内存。</td>           <td class="cellrowborder" valign="top" width="20%">尝试降低应用自身的内存占用，以减少被整机管控策略选中的概率。</td>           <td class="cellrowborder" valign="top" width="20%">否</td>           <td class="cellrowborder" valign="top" width="20%">否</td>          </tr>                 </tbody></table></div>       </div></li>     </ol>    </div>   </div>   <div></div></div>