<h1 _ngcontent-wwc-c119="" class="doc-title ng-star-inserted" title="AppStorage：应用全局的UI状态存储"> AppStorage：应用全局的UI状态存储 </h1>

<div _ngcontent-wwc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在阅读本文档前，建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state-management-overview">状态管理概述</a>，从而对状态管理框架中AppStorage的定位有一个宏观了解。</p>    <p>AppStorage是与应用进程绑定的全局UI状态存储中心，由UI框架在应用启动时创建，将UI状态数据存储于运行内存，实现应用级全局状态共享。</p>    <p>作为应用的“中枢”，AppStorage是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-persiststorage">持久化数据PersistentStorage</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-environment">环境变量Environment</a>与UI交互的中转桥梁。其核心价值在于为开发者提供跨ability的大范围UI状态数据共享能力。</p>    <p>AppStorage提供了API接口，允许开发者在自定义组件外手动触发AppStorage对应属性的增、删、改、查操作。建议配合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-state-management#appstorage" target="_blank">AppStorage API文档</a>阅读。最佳实践请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-status-management" target="_blank">状态管理最佳实践</a>。</p>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>AppStorage是在应用启动时创建的单例，用于提供应用状态数据的中心存储。这些状态数据在应用级别可访问。AppStorage在应用运行过程中保留其属性。</p>     <p>AppStorage中保存的属性通过唯一的字符串类型属性名（key）访问，该属性可以和UI组件同步，且可以在应用业务逻辑中被访问。</p>     <p>AppStorage支持应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/thread-model-stage">主线程</a>内多个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>实例间的UI状态数据共享。</p>     <p>AppStorage中的属性通过唯一的字符串类型key值访问，支持与UI组件同步，并可在应用业务逻辑中被访问。其支持应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/thread-model-stage">主线程</a>内多个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>实例间的UI状态数据共享。</p>     <p>AppStorage中的属性可以被双向同步，并具有不同的功能，比如数据持久化（详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-persiststorage">PersistentStorage</a>）。这些UI状态是通过业务逻辑实现，与UI解耦，如果希望这些UI状态在UI中使用，需要用到<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storageprop">@StorageProp</a>和<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storagelink">@StorageLink</a>。</p>    </div>    <div class="tiledSection">     <h2 id="storageprop">@StorageProp<i class="anchor-icon anchor-icon-link" anchorid="storageprop" tips="复制节点链接"></i></h2>          <p>@StorageProp与AppStorage中对应的属性建立单向数据同步。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 11开始，该装饰器支持在元服务中使用。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰器使用规则说明" class="firsth2">装饰器使用规则说明<i class="anchor-icon anchor-icon-link" anchorid="装饰器使用规则说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">@StorageProp变量装饰器</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">装饰器参数</td>         <td class="cellrowborder" valign="top" width="50%">          <p>常量字符串，必填（字符串需要有引号）。</p>          <p><strong>说明：</strong></p>          <p>使用null和undefined作为key时，会隐式转换为对应的字符串，不建议该用法。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">          <p>Object、class、string、number、boolean、enum类型，以及这些类型的数组。</p>          <p>API Version 12及以上支持Map、Set、Date、undefined和null类型以及这些类型的联合类型，示例见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#appstorage支持联合类型">AppStorage支持联合类型</a>。</p>          <p>嵌套类型的场景请参考<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#观察变化和行为表现">观察变化和行为表现</a>。</p>          <p><strong>说明：</strong></p>          <p>变量类型必须被指定，建议和AppStorage中对应属性类型相同，否则会发生类型隐式转换，从而导致应用行为异常。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">不允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">不支持装饰Function类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">同步类型</td>         <td class="cellrowborder" valign="top" width="50%">          <p>单向同步：从AppStorage的对应属性到组件的状态变量。</p>          <p>组件本地的修改是允许的，但是AppStorage中给定的属性一旦发生变化，将覆盖本地的修改。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">被装饰变量的初始值</td>         <td class="cellrowborder" valign="top" width="50%">必须本地初始化，如果AppStorage实例中不存在属性，则用该初始值初始化该属性，并存入AppStorage中。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="变量的传递访问规则说明">变量的传递/访问规则说明<i class="anchor-icon anchor-icon-link" anchorid="变量的传递访问规则说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.8.2.1.3.1.1" valign="top" width="50%">传递/访问</th>         <th align="left" class="cellrowborder" id="mcps1.3.8.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">从父节点初始化和更新</td>         <td class="cellrowborder" valign="top" width="50%">禁止从父节点初始化和更新@StorageProp。仅支持使用AppStorage中对应key的属性进行初始化，如果不存在对应key，则使用本地默认值进行初始化。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">初始化子节点</td>         <td class="cellrowborder" valign="top" width="50%">支持，可用于初始化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Provide</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">是否支持组件外访问</td>         <td class="cellrowborder" valign="top" width="50%">否。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>图1</strong> @StorageProp初始化规则图示</p>     <p><span><img originheight="358" originwidth="843" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114957.71499452675208302953277745877092:50001231000000:2800:BF90586B71E5762E6D8EF518D6280ECE36ED522229F0ED8B6FCD150931BE67CE.png" width="843" height="358"></span></p>    </div>    <div class="tiledSection">     <h3 id="观察变化和行为表现">观察变化和行为表现<i class="anchor-icon anchor-icon-link" anchorid="观察变化和行为表现" tips="复制节点链接"></i></h3>          <p><strong>观察变化</strong></p>     <ul>      <li>       <p>当装饰的类型为boolean、string、number时，可以观察到数值的变化。</p></li>      <li>       <p>当装饰的数据类型为class或者Object时，可以观察到对象整体赋值和属性变化（详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#从ui内部使用appstorage">从ui内部使用appstorage</a>）。</p></li>      <li>       <p>当装饰的对象是数组时，可以观察到数组添加、删除、更新数组单元的变化。</p></li>      <li>       <p>当装饰的对象是Date时，可以观察到Date整体的赋值，以及通过调用Date的接口setFullYear、setMonth、setDate、setHours、setMinutes、setSeconds、setMilliseconds、setTime、setUTCFullYear、setUTCMonth、setUTCDate、setUTCHours、setUTCMinutes、setUTCSeconds、setUTCMilliseconds更新Date的属性。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰date类型变量">装饰Date类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Map时，可以观察到Map整体的赋值，以及通过调用Map的接口set、clear、delete更新Map的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰map类型变量">装饰Map类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Set时，可以观察到Set整体的赋值，以及通过调用Set的接口add、clear、delete更新Set的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰set类型变量">装饰Set类型变量</a>。</p></li>     </ul>     <p><strong>框架行为</strong></p>     <ol>      <li>       <p>@StorageProp(key)装饰的数值发生变化，不会同步写回AppStorage对应的属性；变化会触发自定义组件重新渲染，并且该变动仅作用于当前组件的私有成员变量，其他绑定该key的数据不会同步改变。</p></li>      <li>       <p>当AppStorage中对应key的属性发生改变时，所有@StorageProp(key)装饰的变量都会同步更新，本地的修改将被覆盖。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="storagelink">@StorageLink<i class="anchor-icon anchor-icon-link" anchorid="storagelink" tips="复制节点链接"></i></h2>          <p>@StorageLink与AppStorage中对应的属性建立双向数据同步。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 11开始，该装饰器支持在元服务中使用。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰器使用规则说明-1" class="firsth2">装饰器使用规则说明<i class="anchor-icon anchor-icon-link" anchorid="装饰器使用规则说明-1" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.11.2.1.3.1.1" valign="top" width="50%">@StorageLink变量装饰器</th>         <th align="left" class="cellrowborder" id="mcps1.3.11.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">装饰器参数</td>         <td class="cellrowborder" valign="top" width="50%">          <p>key：常量字符串，必填（字符串需要有引号）。</p>          <p><strong>注意：</strong></p>          <p>使用null和undefined作为key时，会隐式转换为对应的字符串，不建议该用法。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">          <p>Object、class、string、number、boolean、enum类型，以及这些类型的数组。</p>          <p>API Version 12及以上支持Map、Set、Date、undefined和null类型以及这些类型的联合类型，示例见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#appstorage支持联合类型">AppStorage支持联合类型</a>。</p>          <p>嵌套类型的场景请参考<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#观察变化和行为表现-1">观察变化和行为表现</a>。</p>          <p><strong>注意：</strong></p>          <p>变量类型必须被指定，建议和AppStorage中对应属性类型相同，否则会发生类型隐式转换，从而导致应用行为异常。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">不允许装饰的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">不支持装饰Function类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">同步类型</td>         <td class="cellrowborder" valign="top" width="50%">双向同步：从AppStorage的对应属性到自定义组件，从自定义组件到AppStorage对应属性。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">被装饰变量的初始值</td>         <td class="cellrowborder" valign="top" width="50%">必须本地初始化，如果AppStorage实例中不存在属性，则用该初始值初始化该属性，并存入AppStorage中。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="变量的传递访问规则说明-1">变量的传递/访问规则说明<i class="anchor-icon anchor-icon-link" anchorid="变量的传递访问规则说明-1" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.1" valign="top" width="50%">传递/访问</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">从父节点初始化和更新</td>         <td class="cellrowborder" valign="top" width="50%">禁止。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">初始化子节点</td>         <td class="cellrowborder" valign="top" width="50%">支持，可用于初始化常规变量、@State、@Link、@Prop、@Provide。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">是否支持组件外访问</td>         <td class="cellrowborder" valign="top" width="50%">否。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>图2</strong> @StorageLink初始化规则图示</p>     <p><span><img originheight="358" originwidth="874" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114958.02689548627864923631044082449398:50001231000000:2800:15F17AD4033C5FFF6137726D9777BA449F57C7629749BB691CCA0B19E552103C.png" width="874" height="358"></span></p>    </div>    <div class="tiledSection">     <h3 id="观察变化和行为表现-1">观察变化和行为表现<i class="anchor-icon anchor-icon-link" anchorid="观察变化和行为表现-1" tips="复制节点链接"></i></h3>          <p><strong>观察变化</strong></p>     <ul>      <li>       <p>装饰的数据类型为boolean、string、number时，可以观察到数值变化。</p></li>      <li>       <p>装饰的数据类型为class或Object时，可以观察到对象整体赋值和属性变化。（详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#从ui内部使用appstorage">从ui内部使用appstorage</a>）。</p></li>      <li>       <p>当装饰的对象是数组时，可以观察到数组添加、删除、更新数组单元的变化。</p></li>      <li>       <p>当装饰的对象是Date时，可以观察到Date整体的赋值，以及通过调用Date的接口setFullYear, setMonth, setDate, setHours, setMinutes, setSeconds, setMilliseconds, setTime, setUTCFullYear, setUTCMonth, setUTCDate, setUTCHours, setUTCMinutes, setUTCSeconds, setUTCMilliseconds 更新Date的属性。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰date类型变量">装饰Date类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Map时，可以观察到Map整体的赋值，以及通过调用Map的接口set、clear、delete更新Map的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰map类型变量">装饰Map类型变量</a>。</p></li>      <li>       <p>当装饰的变量是Set时，可以观察到Set的整体赋值，以及通过调用Set的接口add、clear、delete更新Set的值。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#装饰set类型变量">装饰Set类型变量</a>。</p></li>     </ul>     <p><strong>框架行为</strong></p>     <ol>      <li>       <p>当@StorageLink(key)装饰的数值发生变化时，修改将被同步回AppStorage对应key的属性中。</p></li>      <li>       <p>AppStorage中key对应的数据一旦改变，其绑定的所有的数据（包括双向@StorageLink和单向@StorageProp）都将被同步修改。</p></li>      <li>       <p>@StorageLink(key)装饰的数据是状态变量，其变化不仅会同步到AppStorage，还会触发自定义组件的重新渲染。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="限制条件">限制条件<i class="anchor-icon anchor-icon-link" anchorid="限制条件" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>@StorageProp/@StorageLink的参数必须为string类型，否则编译期会报错。</p>       <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-number">47</span>);</li><li>
</li><li><span class="hljs-comment">// 错误写法，编译报错</span></li><li><span class="hljs-meta">@StorageProp</span>() <span class="hljs-attr">storageProp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li><span class="hljs-meta">@StorageLink</span>() <span class="hljs-attr">storageLink</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-comment">// 正确写法</span></li><li><span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-attr">storageProp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-attr">storageLink</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li></ol></pre></div></div></li>      <li>       <p>@StorageProp与@StorageLink不支持装饰Function类型的变量，框架会抛出运行时错误。</p></li>      <li>       <p>AppStorage与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-persiststorage">PersistentStorage</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-environment">Environment</a>配合使用时，需要注意以下几点：</p>       <ol>        <li>         <p>在AppStorage中创建属性后，调用PersistentStorage.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-state-management#persistpropdeprecated" target="_blank">persistProp</a>接口时，会使用AppStorage中已存在的值，并覆盖PersistentStorage中的同名属性。因此，建议使用相反的调用顺序。反例可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-persiststorage#在persistentstorage之前访问appstorage中的属性">在PersistentStorage之前访问AppStorage中的属性</a>。</p></li>        <li>         <p>如果在AppStorage中已创建属性，再调用Environment.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-state-management#envprop10" target="_blank">envProp</a>创建同名属性，会调用失败。因为AppStorage已有同名属性，Environment环境变量不会再写入AppStorage中，所以建议不要在AppStorage中使用Environment预置环境变量名。</p></li>       </ol></li>      <li>       <p>状态装饰器装饰的变量，改变会引起UI的渲染更新。如果改变的变量仅用于消息传递，不用于UI更新，推荐使用emitter方式。具体示例可见<a href="/consumer/cn/doc/harmonyos-guides/arkts-appstorage#不建议借助storagelink的双向同步机制实现事件通知">不建议借助@StorageLink的双向同步机制实现事件通知</a>。</p></li>      <li>       <p>AppStorage同一进程内共享，UIAbility和UIExtensionAbility是两个进程，所以在UIExtensionAbility中不共享主进程的AppStorage。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="从应用逻辑使用appstorage和localstorage" class="firsth2">从应用逻辑使用AppStorage和LocalStorage<i class="anchor-icon anchor-icon-link" anchorid="从应用逻辑使用appstorage和localstorage" tips="复制节点链接"></i></h3>          <p>AppStorage是单例，其所有API均为静态方法，使用方法类似于LocalStorage中对应的非静态方法。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-number">47</span>);</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>,<span class="hljs-number">17</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">propA</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'propA'</span>); <span class="hljs-comment">// propA in AppStorage == 47, propA in LocalStorage == 17</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">link1</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">link</span>(<span class="hljs-string">'propA'</span>); <span class="hljs-comment">// link1.get() == 47</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">link2</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">link</span>(<span class="hljs-string">'propA'</span>); <span class="hljs-comment">// link2.get() == 47</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">prop</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">prop</span>(<span class="hljs-string">'propA'</span>); <span class="hljs-comment">// prop.get() == 47</span></li><li>
</li><li>link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">48</span>); <span class="hljs-comment">// 双向同步: link1.get() == link2.get() == prop.get() == 48</span></li><li>prop.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 单向同步: prop.get() == 1; 但 link1.get() == link2.get() == 48</span></li><li>link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">49</span>); <span class="hljs-comment">// 双向同步: link1.get() == link2.get() == prop.get() == 49</span></li><li>
</li><li>storage.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>) <span class="hljs-comment">// == 17</span></li><li>storage.<span class="hljs-title function_">set</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-number">101</span>);</li><li>storage.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>) <span class="hljs-comment">// == 101</span></li><li>
</li><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>) <span class="hljs-comment">// == 49</span></li><li>link1.<span class="hljs-title function_">get</span>() <span class="hljs-comment">// == 49</span></li><li>link2.<span class="hljs-title function_">get</span>() <span class="hljs-comment">// == 49</span></li><li>prop.<span class="hljs-title function_">get</span>() <span class="hljs-comment">// == 49</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="从ui内部使用appstorage">从UI内部使用AppStorage<i class="anchor-icon anchor-icon-link" anchorid="从ui内部使用appstorage" tips="复制节点链接"></i></h3>          <p>@StorageLink与AppStorage配合使用，通过AppStorage中的属性创建双向数据同步。</p>     <p>@StorageProp与AppStorage配合使用，通过AppStorage中的属性创建单向数据同步。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> {</li><li>  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">code: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = code;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-number">47</span>);</li><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propB'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">50</span>));</li><li><span class="hljs-keyword">let</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'linkA'</span>, <span class="hljs-number">48</span>);</li><li>storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'linkB'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">100</span>));</li><li>
</li><li><span class="hljs-meta">@Entry</span>(storage)</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-attr">storageLink</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-attr">storageProp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'propB'</span>) <span class="hljs-attr">storageLinkObject</span>: <span class="hljs-title class_">Data</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propB'</span>) <span class="hljs-attr">storagePropObject</span>: <span class="hljs-title class_">Data</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">1</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-comment">// @StorageLink与AppStorage建立双向联系，更改数据会同步回AppStorage中key为'propA'的值</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`storageLink <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.storageLink}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">storageLink</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-comment">// @StorageProp与AppStorage建立单向联系，更改数据不会同步回AppStorage中key为'propA'的值</span></li><li>      <span class="hljs-comment">// 但能被AppStorage的set/setorCreate更新值</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`storageProp <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.storageProp}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">storageProp</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-comment">// AppStorage的API虽然能获取值，但是不具有刷新UI的能力，日志能看到数值更改</span></li><li>      <span class="hljs-comment">// 依赖@StorageLink/@StorageProp才能建立起与自定义组件的联系，刷新UI</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`change by AppStorage: <span class="hljs-subst">${AppStorage.get&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>)}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Appstorage.get: <span class="hljs-subst">${AppStorage.get&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>)}</span>`</span>);</li><li>          <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">set</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'propA'</span>, <span class="hljs-number">100</span>);</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`storageLinkObject <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.storageLinkObject.code}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">storageLinkObject</span>.<span class="hljs-property">code</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`storagePropObject <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.storagePropObject.code}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">storagePropObject</span>.<span class="hljs-property">code</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="appstorage支持联合类型">AppStorage支持联合类型<i class="anchor-icon anchor-icon-link" anchorid="appstorage支持联合类型" tips="复制节点链接"></i></h3>          <p>在下面的示例中，变量linkA的类型为number | null，变量linkB的类型为number | undefined。Text组件初始化分别显示为null和undefined，点击切换为数字，再次点击切换回null和undefined。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">StorageLinkComponent</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'linkA'</span>) <span class="hljs-attr">linkA</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'linkB'</span>) <span class="hljs-attr">linkB</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'@StorageLink接口初始化，@StorageLink取值'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.linkA}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkA</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkA</span> = <span class="hljs-literal">null</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkA</span> = <span class="hljs-number">1</span>;</li><li>      })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.linkB}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkB</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkB</span> = <span class="hljs-literal">undefined</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">linkB</span> = <span class="hljs-number">1</span>;</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">3</span>).<span class="hljs-title function_">borderColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">StoragePropComponent</span> {</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-attr">propA</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propB'</span>) <span class="hljs-attr">propB</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'@StorageProp接口初始化，@StorageProp取值'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.propA}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">propA</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">propA</span> = <span class="hljs-literal">null</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">propA</span> = <span class="hljs-number">1</span>;</li><li>      })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.propB}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">propB</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">propB</span> = <span class="hljs-literal">undefined</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">propB</span> = <span class="hljs-number">1</span>;</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">3</span>).<span class="hljs-title function_">borderColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">StorageLinkComponent</span>()</li><li>        <span class="hljs-title class_">StoragePropComponent</span>()</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰date类型变量">装饰Date类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰date类型变量" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 12开始，AppStorage支持Date类型。</p>      </div></div></div>     <p>在下面的示例中，@StorageLink装饰的selectedDate类型为Date。点击Button改变selectedDate的值，视图会随之刷新。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">DateSample</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'date'</span>) <span class="hljs-attr">selectedDate</span>: <span class="hljs-title class_">Date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2021-08-08'</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set selectedDate to 2023-07-08'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'date'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2023-07-08'</span>));</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the year by 1'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setFullYear</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getFullYear</span>() + <span class="hljs-number">1</span>);</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the month by 1'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setMonth</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>);</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'increase the day by 1'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">setDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>);</li><li>        })</li><li>      <span class="hljs-title class_">DatePicker</span>({</li><li>        <span class="hljs-attr">start</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'1970-1-1'</span>),</li><li>        <span class="hljs-attr">end</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2100-1-1'</span>),</li><li>        <span class="hljs-attr">selected</span>: $$this.<span class="hljs-property">selectedDate</span></li><li>      })</li><li>    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰map类型变量">装饰Map类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰map类型变量" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 12开始，AppStorage支持Map类型。</p>      </div></div></div>     <p>在下面的示例中，@StorageLink装饰的message类型为Map&lt;number, string&gt;，点击Button改变message的值，视图会随之刷新。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MapSample</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'map'</span>) <span class="hljs-attr">message</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span>], [<span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">3</span>, <span class="hljs-string">'c'</span>]]);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>]</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">0</span>]}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">1</span>]}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Divider</span>()</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'init map'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-number">0</span>, <span class="hljs-string">'a'</span>], [<span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">3</span>, <span class="hljs-string">'c'</span>]]);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set new one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">4</span>, <span class="hljs-string">'d'</span>);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">clear</span>();</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'replace the existing one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'aa'</span>);</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete the existing one'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-string">'map'</span>)?.<span class="hljs-title function_">delete</span>(<span class="hljs-number">0</span>);</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="装饰set类型变量">装饰Set类型变量<i class="anchor-icon anchor-icon-link" anchorid="装饰set类型变量" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 12开始，AppStorage支持Set类型。</p>      </div></div></div>     <p>在下面的示例中，@StorageLink装饰的memberSet类型为Set&lt;number&gt;，点击Button改变memberSet的值，视图会随之刷新。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">SetSample</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'set'</span>) <span class="hljs-attr">memberSet</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">memberSet</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>]</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">0</span>]}</span>`</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          <span class="hljs-title class_">Divider</span>()</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'init set'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">memberSet</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set new one'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt;&gt;(<span class="hljs-string">'set'</span>)?.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">memberSet</span>.<span class="hljs-title function_">clear</span>();</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete the first one'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">memberSet</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-number">0</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="appstorage使用建议">AppStorage使用建议<i class="anchor-icon anchor-icon-link" anchorid="appstorage使用建议" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="不建议借助storagelink的双向同步机制实现事件通知" class="firsth2">不建议借助@StorageLink的双向同步机制实现事件通知<i class="anchor-icon anchor-icon-link" anchorid="不建议借助storagelink的双向同步机制实现事件通知" tips="复制节点链接"></i></h3>          <p>不建议使用@StorageLink和AppStorage的双向同步机制来实现事件通知。AppStorage中的变量可能绑定在多个页面的组件中，但事件通知不一定需要通知到所有这些组件。此外，当这些@StorageLink装饰的变量在UI中使用时，会触发UI刷新，造成不必要的性能影响。</p>     <p>示例代码中，TapImage中的点击事件会触发AppStorage中tapIndex对应属性的改变。由于@StorageLink是双向同步的，修改会同步回AppStorage中，因此所有绑定AppStorage的tapIndex自定义组件都能感知到tapIndex的变化。使用@Watch监听到tapIndex的变化后，修改状态变量tapColor，从而触发UI刷新（此处tapIndex未直接绑定在UI上，因此tapIndex的变化不会直接触发UI刷新）。</p>     <p>使用该机制实现事件通知时，应确保AppStorage中的变量不直接被绑定到UI上，同时控制<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-watch">@Watch</a>函数的复杂度。如果@Watch函数执行时间过长，会影响UI刷新效率。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewData</span> {</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span>;</li><li>  <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span>, uri: Resource</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span> = uri;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Gallery</span> {</li><li>  <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>  <span class="hljs-attr">dataList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ViewData</span>&gt; = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'flower'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>))];</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Grid</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataList</span>, <span class="hljs-function">(<span class="hljs-params">item: ViewData, index?: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">GridItem</span>() {</li><li>            <span class="hljs-title class_">TapImage</span>({</li><li>              <span class="hljs-attr">uri</span>: item.<span class="hljs-property">uri</span>,</li><li>              <span class="hljs-attr">index</span>: index</li><li>            })</li><li>          }.<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>
</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: ViewData, index?: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item) + index;</li><li>        })</li><li>      }.<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>    }</li><li>
</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">TapImage</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'tapIndex'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onTapIndexChange'</span>) <span class="hljs-attr">tapIndex</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">tapColor</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span> = {</li><li>    <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">moduleName</span>: <span class="hljs-string">''</span>,</li><li>    <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span></li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 判断是否被选中</span></li><li>  <span class="hljs-title function_">onTapIndexChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`tapindex: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tapIndex}</span>, index: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.index}</span>, red`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`tapindex: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tapIndex}</span>, index: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.index}</span>, black`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Cover</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">style</span>: <span class="hljs-title class_">BorderStyle</span>.<span class="hljs-property">Dotted</span>, <span class="hljs-attr">color</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapColor</span> })</li><li>    }</li><li>
</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>相比借助@StorageLink的双向同步机制实现事件通知，开发者可以使用emit订阅某个事件并接收事件回调的方式来减少开销，增强代码的可读性。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>emit接口不支持在Previewer预览器中使用。</p>      </div></div></div>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { emitter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">nextId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewData</span> {</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span>;</li><li>  <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span>, uri: Resource</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span> = uri;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = nextId++;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Gallery</span> {</li><li>  <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>  <span class="hljs-attr">dataList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ViewData</span>&gt; = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'flower'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>))];</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">preIndex</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Grid</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataList</span>, <span class="hljs-function">(<span class="hljs-params">item: ViewData</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">GridItem</span>() {</li><li>            <span class="hljs-title class_">TapImage</span>({</li><li>              <span class="hljs-attr">uri</span>: item.<span class="hljs-property">uri</span>,</li><li>              <span class="hljs-attr">index</span>: item.<span class="hljs-property">id</span></li><li>            })</li><li>          }.<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">preIndex</span> === item.<span class="hljs-property">id</span>) {</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">innerEvent</span>: emitter.<span class="hljs-property">InnerEvent</span> = { <span class="hljs-attr">eventId</span>: item.<span class="hljs-property">id</span> };</li><li>            <span class="hljs-comment">// 选中态：黑变红</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">eventData</span>: emitter.<span class="hljs-property">EventData</span> = {</li><li>              <span class="hljs-attr">data</span>: {</li><li>                <span class="hljs-string">'colorTag'</span>: <span class="hljs-number">1</span></li><li>              }</li><li>            };</li><li>            emitter.<span class="hljs-title function_">emit</span>(innerEvent, eventData);</li><li>
</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">preIndex</span> != -<span class="hljs-number">1</span>) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`preIndex: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.preIndex}</span>, index: <span class="hljs-subst">${item.id}</span>, black`</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">innerEvent</span>: emitter.<span class="hljs-property">InnerEvent</span> = { <span class="hljs-attr">eventId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">preIndex</span> };</li><li>              <span class="hljs-comment">// 取消选中态：红变黑</span></li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">eventData</span>: emitter.<span class="hljs-property">EventData</span> = {</li><li>                <span class="hljs-attr">data</span>: {</li><li>                  <span class="hljs-string">'colorTag'</span>: <span class="hljs-number">0</span></li><li>                }</li><li>              };</li><li>              emitter.<span class="hljs-title function_">emit</span>(innerEvent, eventData);</li><li>            }</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">preIndex</span> = item.<span class="hljs-property">id</span>;</li><li>          })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: ViewData</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item))</li><li>      }.<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>    }</li><li>
</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">TapImage</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">tapColor</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span> = {</li><li>    <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">moduleName</span>: <span class="hljs-string">''</span>,</li><li>    <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span></li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">onTapIndexChange</span>(<span class="hljs-params">colorTag: emitter.EventData</span>) {</li><li>    <span class="hljs-keyword">if</span> (colorTag.<span class="hljs-property">data</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapColor</span> = colorTag.<span class="hljs-property">data</span>.<span class="hljs-property">colorTag</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">//定义事件ID</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">innerEvent</span>: emitter.<span class="hljs-property">InnerEvent</span> = { <span class="hljs-attr">eventId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> };</li><li>    emitter.<span class="hljs-title function_">on</span>(innerEvent, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTapIndexChange</span>(data);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Cover</span>)</li><li>        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">style</span>: <span class="hljs-title class_">BorderStyle</span>.<span class="hljs-property">Dotted</span>, <span class="hljs-attr">color</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapColor</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上通知事件逻辑简单，也可以简化成三元表达式。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewData</span> {</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span>;</li><li>  <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span>, uri: Resource</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span> = uri;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Gallery</span> {</li><li>  <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>  <span class="hljs-attr">dataList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ViewData</span>&gt; = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'flower'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewData</span>(<span class="hljs-string">'OMG'</span>, $r(<span class="hljs-string">'app.media.icon'</span>))];</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Grid</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataList</span>, <span class="hljs-function">(<span class="hljs-params">item: ViewData, index?: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">GridItem</span>() {</li><li>            <span class="hljs-title class_">TapImage</span>({</li><li>              <span class="hljs-attr">uri</span>: item.<span class="hljs-property">uri</span>,</li><li>              <span class="hljs-attr">index</span>: index</li><li>            })</li><li>          }.<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>
</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: ViewData, index?: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item) + index;</li><li>        })</li><li>      }.<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>    }</li><li>
</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">TapImage</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'tapIndex'</span>) <span class="hljs-attr">tapIndex</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uri</span>: <span class="hljs-title class_">Resource</span> = {</li><li>    <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">moduleName</span>: <span class="hljs-string">''</span>,</li><li>    <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span></li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uri</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Cover</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">border</span>({</li><li>          <span class="hljs-attr">width</span>: <span class="hljs-number">5</span>,</li><li>          <span class="hljs-attr">style</span>: <span class="hljs-title class_">BorderStyle</span>.<span class="hljs-property">Dotted</span>,</li><li>          <span class="hljs-attr">color</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">tapIndex</span>) ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span></li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="storageprop和appstorage接口配合使用时需要注意更新规则">@StorageProp和AppStorage接口配合使用时，需要注意更新规则<i class="anchor-icon anchor-icon-link" anchorid="storageprop和appstorage接口配合使用时需要注意更新规则" tips="复制节点链接"></i></h3>          <p>使用setOrCreate/set接口更新key的值时，如果值相同，setOrCreate不会通知@StorageLink/@StorageProp更新，但因为@StorageProp本身有数据副本，更改值不会同步给AppStorage，这会导致开发者误认己通过AppStorage改了值，但实际上未通知@StorageProp更新值的情况。</p>     <p>示例如下。</p>     <div _ngcontent-wwc-c106="" class="highlight-div"><div _ngcontent-wwc-c106="" class="highlight-div-header"><div _ngcontent-wwc-c106="" class="highlight-div-header-left"><div _ngcontent-wwc-c106="" class="handle-button expand-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wwc-c106="" class="highlight-div-header-right"><div _ngcontent-wwc-c106="" class="handle-button ai-button"></div><div _ngcontent-wwc-c106="" class="handle-button line-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wwc-c106="" class="handle-button theme-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wwc-c106="" class="handle-button copy-button"><div _ngcontent-wwc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wwc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-literal">false</span>);</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'propA'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onChange'</span>) <span class="hljs-attr">propA</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">onChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`propA change`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">propA</span> = <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.propA}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'propA'</span>, <span class="hljs-literal">false</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`propA: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.propA}</span>`</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上述示例，在点击事件之前，propA的值已经在本地被更改为true，而AppStorage中存的值仍为false。当点击事件通过setOrCreate接口尝试更新propA的值为false时，由于AppStorage中的值为false，两者相等，不会触发更新同步，因此@StorageProp的值仍为true。</p>     <p>实现二者同步有以下两种方式：</p>     <ol>      <li>将@StorageProp更改为@StorageLink。</li>      <li>本地更改值的方式变为使用AppStorage.setOrCreate('propA', true)的方式。</li>     </ol>    </div>   </div>   <div></div></div>