<h1 _ngcontent-gds-c119="" class="doc-title ng-star-inserted" title="ArkUI瀑布流渲染场景"> ArkUI瀑布流渲染场景 </h1>

<div _ngcontent-gds-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>此处提供使用任务池<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>提升<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow" target="_blank">WaterFlow瀑布流</a>渲染性能的开发指导。UI线程查询数据库数据，并将数据渲染到瀑布流组件，数据过大时会导致UI线程长时间等待，影响用户体验。因此，我们可以将数据查询操作放到子线程中，并通过TaskPool的接口返回数据给UI线程。</p>    <p>本示例说明以下场景：</p>    <ul>     <li>模拟子线程<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/batch-database-operations-guide">读取数据库数据</a>并返回给UI线程。</li>     <li>UI线程感知到数据更新，将子线程返回的数据渲染到瀑布流组件。</li>    </ul>    <ol>     <li>      <p>定义一个接口，用于子线程查询数据库并将数据返回给UI线程。</p>      <div _ngcontent-gds-c106="" class="highlight-div"><div _ngcontent-gds-c106="" class="highlight-div-header"><div _ngcontent-gds-c106="" class="highlight-div-header-left"><div _ngcontent-gds-c106="" class="handle-button expand-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gds-c106="" class="highlight-div-header-right"><div _ngcontent-gds-c106="" class="handle-button ai-button"></div><div _ngcontent-gds-c106="" class="handle-button line-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gds-c106="" class="handle-button theme-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gds-c106="" class="handle-button copy-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Mock.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { fillImg } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Index'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"TaskPoolTest-this is query"</span>);</li><li>  <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-number">33</span>);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">33</span>; i++) {</li><li>    result[i] = <span class="hljs-string">'Image'</span> + i;</li><li>  }</li><li>  taskpool.<span class="hljs-property">Task</span>.<span class="hljs-title function_">sendData</span>(result);</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImgFromDB</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">//此处模拟查询数据库，并返回数据</span></li><li>  <span class="hljs-keyword">let</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(query);</li><li>  task.<span class="hljs-title function_">onReceiveData</span>(fillImg);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task);</li><li>}</li></ol></pre></div></div></li>     <li>      <p>封装一个瀑布流组件数据源，用于瀑布流组件加载数据。</p>      <div _ngcontent-gds-c106="" class="highlight-div"><div _ngcontent-gds-c106="" class="highlight-div-header"><div _ngcontent-gds-c106="" class="highlight-div-header-left"><div _ngcontent-gds-c106="" class="handle-button expand-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gds-c106="" class="highlight-div-header-right"><div _ngcontent-gds-c106="" class="handle-button ai-button"></div><div _ngcontent-gds-c106="" class="handle-button line-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gds-c106="" class="handle-button theme-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gds-c106="" class="handle-button copy-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// WaterFlowDataSource.ets</span></li><li>
</li><li><span class="hljs-comment">// 实现IDataSource接口的对象，用于瀑布流组件加载数据</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaterFlowDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IDataSource</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">dataArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">DataChangeListener</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">push</span>(i);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取索引对应的数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getData</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>[index];</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通知控制器数据重新加载</span></li><li>  <span class="hljs-title function_">notifyDataReload</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataReloaded</span>();</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通知控制器数据增加</span></li><li>  <span class="hljs-title function_">notifyDataAdd</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataAdd</span>(index);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通知控制器数据变化</span></li><li>  <span class="hljs-title function_">notifyDataChange</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataChange</span>(index);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通知控制器数据删除</span></li><li>  <span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataDelete</span>(index);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通知控制器数据位置变化</span></li><li>  <span class="hljs-title function_">notifyDataMove</span>(<span class="hljs-attr">from</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">to</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataMove</span>(<span class="hljs-keyword">from</span>, to);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">//通知控制器数据批量修改</span></li><li>  <span class="hljs-title function_">notifyDatasetChange</span>(<span class="hljs-attr">operations</span>: <span class="hljs-title class_">DataOperation</span>[]): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDatasetChange</span>(operations);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取数据总数</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注册改变数据的控制器</span></li><li>  <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener) &lt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(listener);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注销改变数据的控制器</span></li><li>  <span class="hljs-title function_">unregisterDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> pos = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener);</li><li>    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 增加数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">add1stItem</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataAdd</span>(<span class="hljs-number">0</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 在数据尾部增加一个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">addLastItem</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataAdd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 在指定索引位置增加一个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">addItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataAdd</span>(index);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 删除第一个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">delete1stItem</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-number">0</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 删除第二个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">delete2ndItem</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-number">1</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 删除最后一个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">deleteLastItem</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 在指定索引位置删除一个元素</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">deleteItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(index);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 重新加载数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reload</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataReload</span>();</li><li>  }</li><li>}</li></ol></pre></div></div></li>     <li>      <p>在应用冷启动阶段，调用getImgFromDB()接口，将数据查询操作放到子线程中。在img接收到子线程返回的数据后，将数据渲染到瀑布流组件。</p>      <div _ngcontent-gds-c106="" class="highlight-div"><div _ngcontent-gds-c106="" class="highlight-div-header"><div _ngcontent-gds-c106="" class="highlight-div-header-left"><div _ngcontent-gds-c106="" class="handle-button expand-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gds-c106="" class="highlight-div-header-right"><div _ngcontent-gds-c106="" class="handle-button ai-button"></div><div _ngcontent-gds-c106="" class="handle-button line-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gds-c106="" class="handle-button theme-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gds-c106="" class="handle-button copy-button"><div _ngcontent-gds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./WaterFlowDataSource'</span>;</li><li><span class="hljs-keyword">import</span> { getImgFromDB } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Mock'</span>;</li><li>
</li><li><span class="hljs-comment">// 模拟图片数组</span></li><li><span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-number">33</span>);</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fillImg</span>(<span class="hljs-params">imgArr : <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) {</li><li>  img = imgArr;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WaterFlowDemo</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">minSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">80</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">maxSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">180</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">fontSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">24</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">colors</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">0xFFC0CB</span>, <span class="hljs-number">0xDA70D6</span>, <span class="hljs-number">0x6B8E23</span>, <span class="hljs-number">0x6A5ACD</span>, <span class="hljs-number">0x00FFFF</span>, <span class="hljs-number">0x00FF7F</span>];</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>();</li><li>  <span class="hljs-attr">dataSource</span>: <span class="hljs-title class_">WaterFlowDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaterFlowDataSource</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemWidthArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemHeightArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-comment">// 计算FlowItem宽/高</span></li><li>  <span class="hljs-title function_">getSize</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> ret = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>);</li><li>    <span class="hljs-keyword">return</span> (ret &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">minSize</span> ? ret : <span class="hljs-variable language_">this</span>.<span class="hljs-property">minSize</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置FlowItem的宽/高数组</span></li><li>  <span class="hljs-title function_">setItemSizeArray</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSize</span>());</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSize</span>());</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setItemSizeArray</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title function_">itemFoot</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Footer`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">align</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">2</span> });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"ArkUI WaterFlow Demo"</span>)</li><li>        .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">()=&gt;</span>{</li><li>          <span class="hljs-title function_">getImgFromDB</span>();</li><li>        })</li><li>      <span class="hljs-title class_">WaterFlow</span>() {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">FlowItem</span>() {</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">"N"</span> + item)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-string">'16'</span>)</li><li>                .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>
</li><li>                });</li><li>              <span class="hljs-comment">// 为了模拟图片加载，使用Text组件显示，正常加载jpg文件时，可以直接使用Image组件，参考Image(this.img[item % 33]).objectFit(ImageFit.Contain).width('100%').layoutWeight(1)</span></li><li>              <span class="hljs-keyword">if</span> (img[item % <span class="hljs-number">33</span>] == <span class="hljs-literal">null</span>) {</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">"图片加载中..."</span>)</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                  .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>);</li><li>              }</li><li>              <span class="hljs-title class_">Text</span>(img[item % <span class="hljs-number">33</span>])</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>);</li><li>            }</li><li>          }</li><li>          .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 即将触底时提前增加数据</span></li><li>            <span class="hljs-keyword">if</span> (item + <span class="hljs-number">20</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addLastItem</span>();</li><li>              }</li><li>            }</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>[item % <span class="hljs-number">100</span>])</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[item % <span class="hljs-number">5</span>])</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">"1fr 1fr"</span>)</li><li>      .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">10</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFAEEE0</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">onReachStart</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'TaskPoolTest-waterFlow reach start'</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">onScrollStart</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'TaskPoolTest-waterFlow scroll start'</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">onScrollStop</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'TaskPoolTest-waterFlow scroll stop'</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">onScrollFrameBegin</span>(<span class="hljs-function">(<span class="hljs-params">offset: <span class="hljs-built_in">number</span>, state: ScrollState</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'TaskPoolTest-waterFlow scrollFrameBegin offset: '</span> + offset + <span class="hljs-string">' state: '</span> + state.<span class="hljs-title function_">toString</span>());</li><li>        <span class="hljs-keyword">return</span> { <span class="hljs-attr">offsetRemain</span>: offset };</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>