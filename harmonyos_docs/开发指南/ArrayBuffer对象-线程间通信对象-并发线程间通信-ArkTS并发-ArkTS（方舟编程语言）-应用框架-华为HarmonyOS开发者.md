<h1 _ngcontent-qju-c119="" class="doc-title ng-star-inserted" title="ArrayBuffer对象"> ArrayBuffer对象 </h1>

<div _ngcontent-qju-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ArrayBuffer包含两部分：底层存储数据的Native内存区域，以及封装操作的JS对象壳。JS对象壳分配在虚拟机的本地堆（LocalHeap）中。跨线程传递时，JS对象壳需要序列化和反序列化拷贝传递，而Native内存区域可以通过拷贝或转移的方式传递。</p> <p>Native内存使用拷贝方式（递归遍历）传输时，传输后两个线程可以独立访问ArrayBuffer。此方式需要重建JS壳和拷贝Native内存，传输效率较低。通信过程如下图所示：</p> <p><span><img originheight="393" originwidth="944" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114921.93328199992990660441595453734816:50001231000000:2800:53F8E2413D1E24ADE4BA1B4FA39153BD36B9D5C6F4AC09EF5D8B957516269CC3.png" width="920" height="383.00847457627117"></span></p> <p>Native内存使用转移方式传输时，传输后原线程将无法使用此ArrayBuffer对象。跨线程时只需重建JS壳，Native内存无需拷贝，从而提高效率。通信过程如下图所示：</p> <p><span><img originheight="366" originwidth="944" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114921.94405297609237214467429834355960:50001231000000:2800:9A4F2763CAA83F221EFEAAA9C2DD92A22CDC40D26A2FEB240D563AD58B1B673C.png" width="920" height="356.6949152542373"></span></p> <p>ArrayBuffer可以用来表示图片等资源，在应用开发中，处理图片（如调整亮度、饱和度、大小等）会比较耗时，为了避免长时间阻塞UI主线程，可以将图片传递到子线程中进行处理。采用转移方式传递ArrayBuffer可提高传输性能，但原线程将无法再访问该ArrayBuffer对象。如果两个线程都需要访问该对象，只能采用拷贝方式。反之，建议采用转移方式以提升性能。</p> <p>以下将通过具体的代码案例分别介绍拷贝和转移两种方式，实现图片跨ArkTS线程传输。</p>  <div class="tiledSection"><h2 id="arraybuffer拷贝传输方式">ArrayBuffer拷贝传输方式<i class="anchor-icon anchor-icon-link" anchorid="arraybuffer拷贝传输方式" tips="复制节点链接"></i></h2><p>在ArkTS中，TaskPool传递ArrayBuffer数据时，默认采用转移方式。通过调用setTransferList()接口，可以指定部分数据的传递方式为转移方式，其他部分数据可以切换为拷贝方式。</p> <p>首先，实现一个处理ArrayBuffer的接口，该接口在Task中执行。</p> <p>然后，通过拷贝方式将ArrayBuffer数据传递到Task中，并进行处理。</p> <p>最后，UI主线程接收到Task执行完毕后返回的ArrayBuffer数据，进行拼接并展示。</p> <div _ngcontent-qju-c106="" class="highlight-div"><div _ngcontent-qju-c106="" class="highlight-div-header"><div _ngcontent-qju-c106="" class="highlight-div-header-left"><div _ngcontent-qju-c106="" class="handle-button expand-button"><div _ngcontent-qju-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qju-c106="" class="highlight-div-header-right"><div _ngcontent-qju-c106="" class="handle-button ai-button"></div><div _ngcontent-qju-c106="" class="handle-button line-button"><div _ngcontent-qju-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qju-c106="" class="handle-button theme-button"><div _ngcontent-qju-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qju-c106="" class="handle-button copy-button"><div _ngcontent-qju-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qju-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">adjustImageValue</span>(<span class="hljs-params">arrayBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-title class_">ArrayBuffer</span> {</li><li>  <span class="hljs-comment">// 对arrayBuffer进行操作，返回值默认转移</span></li><li>  <span class="hljs-keyword">return</span> arrayBuffer;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createImageTask</span>(<span class="hljs-params">arrayBuffer: <span class="hljs-built_in">ArrayBuffer</span>, isParamsByTransfer: <span class="hljs-built_in">boolean</span></span>): taskpool.<span class="hljs-property">Task</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(adjustImageValue, arrayBuffer);</li><li>  <span class="hljs-comment">// 是否使用转移方式</span></li><li>  <span class="hljs-keyword">if</span> (!isParamsByTransfer) {</li><li>    <span class="hljs-comment">// 传递空数组[]，全部arrayBuffer参数传递均采用拷贝方式</span></li><li>    task.<span class="hljs-title function_">setTransferList</span>([]);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> task;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> taskNum = <span class="hljs-number">4</span>;</li><li>          <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);</li><li>          <span class="hljs-keyword">let</span> taskPoolGroup = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">TaskGroup</span>();</li><li>          <span class="hljs-comment">// 创建taskNum个Task</span></li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; i &lt; taskNum; i++) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">arrayBufferSlice</span>: <span class="hljs-title class_">ArrayBuffer</span> = arrayBuffer.<span class="hljs-title function_">slice</span>(arrayBuffer.<span class="hljs-property">byteLength</span> / taskNum * i, arrayBuffer.<span class="hljs-property">byteLength</span> / taskNum * (i + <span class="hljs-number">1</span>));</li><li>            <span class="hljs-comment">// 使用拷贝方式传入ArrayBuffer，所以isParamsByTransfer为false</span></li><li>            taskPoolGroup.<span class="hljs-title function_">addTask</span>(<span class="hljs-title function_">createImageTask</span>(arrayBufferSlice, <span class="hljs-literal">false</span>));</li><li>          }</li><li>          <span class="hljs-comment">// 执行Task</span></li><li>          taskpool.<span class="hljs-title function_">execute</span>(taskPoolGroup).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// 返回结果，对数组拼接，获得最终结果</span></li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e.<span class="hljs-property">message</span>);</li><li>          })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="arraybuffer转移传输方式">ArrayBuffer转移传输方式<i class="anchor-icon anchor-icon-link" anchorid="arraybuffer转移传输方式" tips="复制节点链接"></i></h2><p>在TaskPool中，传递ArrayBuffer数据时，默认使用转移方式，原线程将无法再使用已传输给子线程的ArrayBuffer。 在上文示例的基础上去除task.setTransferList接口调用，即在createImageTask的第二个参数传入true，就可以实现转移方式的传输。</p> </div> </div> <div></div></div>