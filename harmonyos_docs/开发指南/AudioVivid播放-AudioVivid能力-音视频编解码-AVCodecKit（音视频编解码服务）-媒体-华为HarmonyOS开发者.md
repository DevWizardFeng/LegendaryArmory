<h1 _ngcontent-pxw-c119="" class="doc-title ng-star-inserted" title="Audio Vivid播放"> Audio Vivid播放 </h1>

<div _ngcontent-pxw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在获取到解码后的Audio Vivid的PCM数据和元数据之后，可以调用OHAudio的相关播放接口，进行Audio Vivid格式音源的渲染播放。详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio" target="_blank">OHAudio API参考</a>。</p> <div class="tiledSection"><h2 id="section0281526123914">在CMake脚本中链接到动态库<i class="anchor-icon anchor-icon-link" anchorid="section0281526123914" tips="复制节点链接"></i></h2><div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libohaudio.so)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section14548942143912">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="section14548942143912" tips="复制节点链接"></i></h2><div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiorenderer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiostreambuilder.h&gt;</span></span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section154782419168">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section154782419168" tips="复制节点链接"></i></h2><p>开发者可以通过以下几个步骤来实现一个简单的播放功能。</p> <ol><li>创建构造器。<p>OHAudio提供OH_AudioStreamBuilder接口，遵循构造器设计模式，用于构建音频流。在Audio Vivid播放场景下，需要选择OH_AudioStream_Type为AUDIOSTREAM_TYPE_RENDERER，创建一个渲染播放类型的音频构造器。</p> <div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStreamBuilder* builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, AUDIOSTREAM_TYPE_RENDERER);</li></ol></pre></div></div> </li><li>配置音频流参数。<p>创建音频播放构造器后，可以设置音频流所需要的参数，可以参考以下案例。</p> <p>Audio Vivid音源搭配系统空间音频渲染算法，播放效果和体验最佳。系统会根据输出音频流的工作场景（OH_AudioStream_Usage），选择使用对应的空间音频渲染效果，当前支持的工作场景包括音乐、电影和有声读物。</p> <div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置音频采样率为48000Hz</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSamplingRate</span>(builder, <span class="hljs-number">48000</span>);</li><li><span class="hljs-comment">// 设置音频声道为10 （假定输入Audio Vivid音源是5.1.2声床 + 2对象格式）</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelCount</span>(builder, <span class="hljs-number">10</span>);</li><li><span class="hljs-comment">// 设置音频声道布局为5.1.2 （声道布局只考虑声床，若想使用默认声道布局，可以传入 CH_LAYOUT_UNKNOWN 参数）</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelLayout</span>(builder, CH_LAYOUT_5POINT1POINT2);</li><li><span class="hljs-comment">// 设置音频采样格式</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSampleFormat</span>(builder, AUDIOSTREAM_SAMPLE_S16LE);</li><li><span class="hljs-comment">// 设置音频流的编码类型为Audio Vivid编码类型</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetEncodingType</span>(builder, AUDIOSTREAM_ENCODING_TYPE_AUDIOVIVID);</li><li><span class="hljs-comment">// 设置输出音频流的工作场景，根据实际工作场景选择音乐、电影、有声读物等类型</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererInfo</span>(builder, AUDIOSTREAM_USAGE_MUSIC);</li></ol></pre></div></div> </li><li>设置音频回调函数。<p>OHAudio使用回调模式进行音频流数据的写入，以及各种音频事件的上报，应用可以按需选择需要监听的音频事件。</p> <div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义音频流事件函数</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnStreamEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioStream_Event event)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据event表示的音频流事件信息，更新播放器状态和界面</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新播放器状态和界面</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义异常回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnError</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioStream_Result error)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据error表示的音频异常信息，做出相应的处理</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义同时写入PCM数据和元数据函数</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnWriteDataWithMetadata</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* audioData,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> audioDataSize,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* metadata,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> metadataSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的PCM数据和元数据，分别按audioDataSize和metadataSize写入buffer</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>调用系统的注册监听接口，将上述定义好的回调函数进行配置。</p> <p>为了避免不可预期的行为，在设置音频回调函数时，请确认OH_AudioRenderer_Callbacks的每一个回调都被自定义的回调方法或空指针初始化。</p> <p>对于Audio Vivid播放场景，需要另外使用OH_AudioRenderer_WriteDataWithMetadataCallback进行PCM和元数据写入。</p> <div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置回调函数</span></li><li>OH_AudioRenderer_Callbacks callbacks;</li><li><span class="hljs-comment">// Audio Vivid播放时，该回调可以置空，使用元数据回调方式进行数据写入</span></li><li>callbacks.OH_AudioRenderer_OnWriteData = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 对音频流事件进行监听，如果不需要，可以使用 nullptr 赋值</span></li><li>callbacks.OH_AudioRenderer_OnStreamEvent = MyOnStreamEvent;</li><li><span class="hljs-comment">// 对音频中断事件进行监听，如果不需要，可以使用 nullptr 赋值</span></li><li>callbacks.OH_AudioRenderer_OnInterruptEvent = MyOnInterruptEvent;</li><li><span class="hljs-comment">// 对音频异常事件进行监听，如果不需要，可以使用 nullptr 赋值</span></li><li>callbacks.OH_AudioRenderer_OnError = MyOnError;</li><li>
</li><li><span class="hljs-comment">//设置输出音频流的回调</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererCallback</span>(builder, callbacks, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li><span class="hljs-comment">// 配置回调函数</span></li><li>OH_AudioRenderer_WriteDataWithMetadataCallback metadataCallback = MyOnWriteDataWithMetadata;</li><li><span class="hljs-comment">// 设置同时写入PCM数据和元数据的回调</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetWriteDataWithMetadataCallback</span>(builder, metadataCallback, <span class="hljs-literal">nullptr</span>);</li></ol></pre></div></div> </li><li>使用配置好的构造器，构造播放音频流。<div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>OH_AudioRenderer* audioRenderer;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_GenerateRenderer</span>(builder, &amp;audioRenderer);</li></ol></pre></div></div> </li><li>使用音频流。<p>可以使用以下接口，实现对音频流的控制，完成开始播放、暂停播放、停止播放、清除缓存等基本操作。</p> <p>在不再使用该条音频流时，可以释放播放实例，以便更好地管理内存。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.5.3.1.3.1.1" valign="top" width="78.16%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.5.3.1.3.1.2" valign="top" width="21.84%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="78.16%"><p>OH_AudioRenderer_Start</p> </td> <td class="cellrowborder" valign="top" width="21.84%"><p>开始播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="78.16%"><p>OH_AudioRenderer_Pause</p> </td> <td class="cellrowborder" valign="top" width="21.84%"><p>暂停播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="78.16%"><p>OH_AudioRenderer_Stop</p> </td> <td class="cellrowborder" valign="top" width="21.84%"><p>停止播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="78.16%"><p>OH_AudioRenderer_Flush</p> </td> <td class="cellrowborder" valign="top" width="21.84%"><p>释放缓存数据</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="78.16%"><p>OH_AudioRenderer_Release</p> </td> <td class="cellrowborder" valign="top" width="21.84%"><p>释放播放实例</p> </td> </tr>  </tbody></table></div> </div> </li><li>释放构造器。<p>当构造器不再使用时，需要释放相关资源。</p> <div _ngcontent-pxw-c106="" class="highlight-div"><div _ngcontent-pxw-c106="" class="highlight-div-header"><div _ngcontent-pxw-c106="" class="highlight-div-header-left"><div _ngcontent-pxw-c106="" class="handle-button expand-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxw-c106="" class="highlight-div-header-right"><div _ngcontent-pxw-c106="" class="handle-button ai-button"></div><div _ngcontent-pxw-c106="" class="handle-button line-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxw-c106="" class="handle-button theme-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxw-c106="" class="handle-button copy-button"><div _ngcontent-pxw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>