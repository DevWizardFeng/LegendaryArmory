<h1 _ngcontent-kra-c119="" class="doc-title ng-star-inserted" title="Audio Vivid解封装"> Audio Vivid解封装 </h1>

<div _ngcontent-kra-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>获取到Audio Vivid封装的mp4文件后，先调用解封装相关接口，选中音频轨，读取每一帧Audio Vivid，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audiovivid-audiodecoder">送入解码器中</a>。详细的API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/avcodec-module" target="_blank">音频解封装API参考</a>。</p> <div class="tiledSection"><h2 id="section0281526123914">在CMake脚本中链接到动态库<i class="anchor-icon anchor-icon-link" anchorid="section0281526123914" tips="复制节点链接"></i></h2><div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC </li><li>libnative_media_codecbase.so libnative_media_core.so </li><li>libnative_media_acodec.so libnative_media_avdemuxer.so libnative_media_avsource.so</li><li>)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section14548942143912">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="section14548942143912" tips="复制节点链接"></i></h2><div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//解封装头文件</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/native_avdemuxer.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// 解封装解码传递信息结构体</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AudioSampleInfo</span> {</li><li>std::string audioCodecMime = <span class="hljs-string">""</span>;</li><li><span class="hljs-type">int32_t</span> audioSampleFormat = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> audioSampleRate = <span class="hljs-number">0</span>; </li><li><span class="hljs-type">int32_t</span> audioChannelCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int64_t</span> audioChannelLayout = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint8_t</span> audioCodecConfig[<span class="hljs-number">100</span>] = {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">size_t</span> audioCodecSize = <span class="hljs-number">0</span>;</li><li>};</li><li>
</li><li>AudioSampleInfo  info;</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section10808558144211">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section10808558144211" tips="复制节点链接"></i></h2><ol><li>创建解封装实例。<div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ts code获取fd和size</span></li><li><span class="hljs-keyword">let</span> inputFile = fs.<span class="hljs-title function_">openSync</span>(filepath,fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li><span class="hljs-keyword">if</span> (inputFile) {</li><li>    <span class="hljs-keyword">let</span> inputFileState = fs.<span class="hljs-title function_">statSync</span>(inputFile.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-keyword">let</span> inputFileSize = inputFileState.<span class="hljs-property">size</span>;</li><li>}</li></ol></pre></div></div> <div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//C++ code</span></li><li><span class="hljs-variable">OH_AVSource</span> *<span class="hljs-variable">source</span> = <span class="hljs-title function_">OH_AVSource_CreateWithFD</span>(<span class="hljs-variable">inputFd</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">inputFileSize</span>);</li><li><span class="hljs-variable">OH_AVDemuxer</span> *<span class="hljs-variable">demuxer</span> = <span class="hljs-title function_">OH_AVDemuxer_CreateWithSource</span>(<span class="hljs-variable">source</span>);</li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">sourceFormat</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVSource_GetSourceFormat</span>(<span class="hljs-title class_">source_</span>), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">trackCount</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">sourceFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_TRACK_COUNT</span>, &amp;<span class="hljs-title class_">trackCount</span>);</li></ol></pre></div></div> </li><li>选中音频轨。<div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">trackCount</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">sourceFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_TRACK_COUNT</span>, &amp;<span class="hljs-title class_">trackCount</span>);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-variable">int32_t</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">index</span> &lt; <span class="hljs-title class_">trackCount</span>; <span class="hljs-title class_">index</span>++) {</li><li><span class="hljs-variable">int</span> <span class="hljs-variable">trackType</span> = -<span class="hljs-number">1</span>;</li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">trackFormat</span> =</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVSource_GetTrackFormat</span>(<span class="hljs-title class_">source_</span>, <span class="hljs-title class_">index</span>), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-comment">// 获取轨道类型</span></li><li><span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_TRACK_TYPE</span>, &amp;<span class="hljs-title class_">trackType</span>);</li><li><span class="hljs-comment">// 判断当前轨道为音频轨</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">trackType</span> == <span class="hljs-variable">MEDIA_TYPE_AUD</span>) { </li><li>    <span class="hljs-comment">// 选中音频轨</span></li><li>    <span class="hljs-title function_">OH_AVDemuxer_SelectTrackByID</span>(<span class="hljs-variable">demuxer</span>, <span class="hljs-variable">index</span>);</li><li>    <span class="hljs-comment">// 获取位深</span></li><li>    <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_AUDIO_SAMPLE_FORMAT</span>, &amp;<span class="hljs-title class_">info</span>.<span class="hljs-variable">audioSampleFormat</span>);</li><li>    <span class="hljs-comment">// 获取声道数</span></li><li>    <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_AUD_CHANNEL_COUNT</span>, &amp;<span class="hljs-title class_">info</span>.<span class="hljs-variable">audioChannelCount</span>);</li><li>    <span class="hljs-comment">// 获取声道布局</span></li><li>    <span class="hljs-title function_">OH_AVFormat_GetLongValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_CHANNEL_LAYOUT</span>, &amp;<span class="hljs-title class_">info</span>.<span class="hljs-variable">audioChannelLayout</span>);</li><li>    <span class="hljs-comment">// 获取采样率</span></li><li>    <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_AUD_SAMPLE_RATE</span>, &amp;<span class="hljs-title class_">info</span>.<span class="hljs-variable">audioSampleRate</span>);</li><li>    <span class="hljs-comment">// 获取额外配置信息</span></li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_AVFormat_GetBuffer</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_CODEC_CONFIG</span>, &amp;<span class="hljs-title class_">addr</span>, &amp;<span class="hljs-title class_">info</span>.<span class="hljs-variable">audioCodecSize</span>);</li><li>    <span class="hljs-title function_">memcpy</span>((<span class="hljs-variable">void</span> *)<span class="hljs-variable">info</span>.<span class="hljs-variable">audioCodecConfig</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-variable">addr</span>, <span class="hljs-variable">info</span>.<span class="hljs-variable">audioCodecSize</span>);</li><li>    <span class="hljs-comment">// 获取解码器类型</span></li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">audioCodecMime</span>;</li><li>    <span class="hljs-title function_">OH_AVFormat_GetStringValue</span>(<span class="hljs-variable">trackFormat</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_CODEC_MIME</span>, <span class="hljs-title class_">const_cast</span>&lt;<span class="hljs-title class_">char</span> <span class="hljs-keyword">const</span> **&gt;(&amp;<span class="hljs-title class_">audioCodecMime</span>));</li><li>    <span class="hljs-variable">info</span>.<span class="hljs-variable">audioCodecMime</span> = <span class="hljs-variable">audioCodecMime</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">trackId</span> = <span class="hljs-variable">index</span>;</li><li>    <span class="hljs-keyword">break</span>;</li><li>    }</li><li>}</li></ol></pre></div></div> </li><li>读取每一帧数据。<div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AVBuffer *buffer;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVDemuxer_ReadSampleBuffer</span>(demuxer, trackId, buffer);</li></ol></pre></div></div> </li><li>释放解封装实例。<div _ngcontent-kra-c106="" class="highlight-div"><div _ngcontent-kra-c106="" class="highlight-div-header"><div _ngcontent-kra-c106="" class="highlight-div-header-left"><div _ngcontent-kra-c106="" class="handle-button expand-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kra-c106="" class="highlight-div-header-right"><div _ngcontent-kra-c106="" class="handle-button ai-button"></div><div _ngcontent-kra-c106="" class="handle-button line-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kra-c106="" class="handle-button theme-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kra-c106="" class="handle-button copy-button"><div _ngcontent-kra-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kra-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Release</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (demuxer != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_AVDemuxer_Destroy</span>(demuxer);</li><li>        demuxer = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (source != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_AVSource_Destroy</span>(source);</li><li>        source = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>