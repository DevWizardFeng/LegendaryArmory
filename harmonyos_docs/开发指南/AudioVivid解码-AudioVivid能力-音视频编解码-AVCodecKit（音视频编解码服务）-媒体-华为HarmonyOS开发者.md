<h1 _ngcontent-mhi-c119="" class="doc-title ng-star-inserted" title="Audio Vivid解码"> Audio Vivid解码 </h1>

<div _ngcontent-mhi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>获取解封装后的数据，送入解码器中，使用解码器获取PCM和Metadata元数据。详细的API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/avcodec-module" target="_blank">音频解码API参考</a>。</p> <p>Audio Vivid解码当前支持的规格如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.3.1.3.1.1" valign="top" width="50%"><p>支持采样率</p> </th> <td class="cellrowborder" valign="top" width="50%"><p>32000，44100，48000，96000，192000</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.3.1.3.2.1" valign="top" width="50%"><p>支持码率范围</p> </th> <td class="cellrowborder" valign="top" width="50%"><p>16000~3075000</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.3.1.3.3.1" valign="top" width="50%"><p>支持声道数</p> </th> <td class="cellrowborder" valign="top" width="50%"><p>1~16</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.3.1.3.4.1" valign="top" width="50%"><p>支持的位深</p> </th> <td class="cellrowborder" valign="top" width="50%"><p>S16，S24</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section0281526123914">在CMake脚本中链接到动态库<i class="anchor-icon anchor-icon-link" anchorid="section0281526123914" tips="复制节点链接"></i></h2><div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC </li><li>libnative_media_codecbase.so libnative_media_core.so </li><li>libnative_media_acodec.so libnative_media_avdemuxer.so libnative_media_avsource.so</li><li>)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section14548942143912">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="section14548942143912" tips="复制节点链接"></i></h2><div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//解封装头文件</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/native_avdemuxer.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// 解封装解码传递信息结构体</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AudioSampleInfo</span> {</li><li>std::string audioCodecMime = <span class="hljs-string">""</span>;</li><li><span class="hljs-type">int32_t</span> audioSampleFormat = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> audioSampleRate = <span class="hljs-number">0</span>; </li><li><span class="hljs-type">int32_t</span> audioChannelCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int64_t</span> audioChannelLayout = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint8_t</span> audioCodecConfig[<span class="hljs-number">100</span>] = {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">size_t</span> audioCodecSize = <span class="hljs-number">0</span>;</li><li>};</li><li>
</li><li>AudioSampleInfo  info;</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section145092197477">定义相关实例<i class="anchor-icon anchor-icon-link" anchorid="section145092197477" tips="复制节点链接"></i></h2><p><strong>定义CodecBufferInfo</strong></p> <p>解码码流的属性定义，为后面传给播放的码流数据封装。</p> <div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">bufferIndex</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">uintptr_t</span> *<span class="hljs-variable">buffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">bufferAddr</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">attr</span> = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>};</li><li>
</li><li>    <span class="hljs-title function_">CodecBufferInfo</span>(<span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span>) : <span class="hljs-title class_">bufferAddr</span>(<span class="hljs-title class_">addr</span>){};</li><li>    <span class="hljs-title function_">CodecBufferInfo</span>(<span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span>, <span class="hljs-variable">int32_t</span> <span class="hljs-variable">bufferSize</span>)</li><li>        : <span class="hljs-title class_">bufferAddr</span>(<span class="hljs-title class_">addr</span>), <span class="hljs-title function_">attr</span>({<span class="hljs-number">0</span>, <span class="hljs-variable">bufferSize</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>}){};</li><li>    <span class="hljs-title function_">CodecBufferInfo</span>(<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">argBufferIndex</span>, <span class="hljs-variable">OH_AVMemory</span> *<span class="hljs-variable">argBuffer</span>, <span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">argAttr</span>)</li><li>        : <span class="hljs-title class_">bufferIndex</span>(<span class="hljs-title class_">argBufferIndex</span>), <span class="hljs-title function_">buffer</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uintptr_t</span> *&gt;(<span class="hljs-variable">argBuffer</span>)), <span class="hljs-title function_">attr</span>(<span class="hljs-variable">argAttr</span>){};</li><li>    <span class="hljs-title function_">CodecBufferInfo</span>(<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">argBufferIndex</span>, <span class="hljs-variable">OH_AVMemory</span> *<span class="hljs-variable">argBuffer</span>)</li><li>        : <span class="hljs-title class_">bufferIndex</span>(<span class="hljs-title class_">argBufferIndex</span>), <span class="hljs-title function_">buffer</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uintptr_t</span> *&gt;(<span class="hljs-variable">argBuffer</span>)){};</li><li>    <span class="hljs-title function_">CodecBufferInfo</span>(<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">argBufferIndex</span>, <span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">argBuffer</span>)</li><li>        : <span class="hljs-title class_">bufferIndex</span>(<span class="hljs-title class_">argBufferIndex</span>), <span class="hljs-title function_">buffer</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uintptr_t</span> *&gt;(<span class="hljs-variable">argBuffer</span>)) {</li><li>        <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">argBuffer</span>, &amp;<span class="hljs-title class_">attr</span>);</li><li>    };</li><li>};</li></ol></pre></div></div> <p><strong>定义解码工作队列</strong></p> <div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodecUserData</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">SampleInfo</span> *<span class="hljs-variable">sampleInfo</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// 输入帧数</span></li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">inputFrameCount_</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 输入队列锁，防止多线程同时操作输入队列</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">inputMutex_</span>;</li><li>    <span class="hljs-comment">// 输入线程的条件变量，当输入队列为空时用于阻塞输入线程</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">inputCond_</span>;</li><li>    <span class="hljs-comment">// 输入buffer队列，存放编解码器传给用户用来写入输入数据的buffer</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">inputBufferInfoQueue_</span>;</li><li>
</li><li>    <span class="hljs-comment">// 输出帧数</span></li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">outputFrameCount_</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 输出队列锁，防止多线程同时操作输出队列</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">outputMutex_</span>;</li><li>    <span class="hljs-comment">// 输出线程的条件变量，当输出队列为空时用于阻塞输出线程</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">outputCond_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">renderMutex_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">renderCond_</span>;</li><li>    <span class="hljs-comment">// 输出buffer队列，存放编解码器传给用户用来存放输出数据的buffer</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">outputBufferInfoQueue_</span>;</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">AudioDecoder</span>&gt; <span class="hljs-title class_">audioCodec_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">char</span>&gt; <span class="hljs-title class_">renderQueue_</span>;</li><li>
</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">ClearQueue</span>() {</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">inputMutex_</span>);</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">emptyQueue</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;();</li><li>            <span class="hljs-variable">inputBufferInfoQueue_</span>.<span class="hljs-title function_">swap</span>(<span class="hljs-variable">emptyQueue</span>);</li><li>        }</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">outputMutex_</span>);</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">emptyQueue</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;();</li><li>            <span class="hljs-variable">outputBufferInfoQueue_</span>.<span class="hljs-title function_">swap</span>(<span class="hljs-variable">emptyQueue</span>);</li><li>        }</li><li>    }</li><li>};</li></ol></pre></div></div> <p><strong>定义回调函数</strong></p> <div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleCallback</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-comment">// 报错回调函数，当编解码器内部报错时调用，返回给用户相应错误码</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnCodecError</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">int32_t</span> <span class="hljs-variable">errorCode</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-comment">// 参数修改回调函数，当编解码器参数被修改时调用，返回给用户被修改后的format参数</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnCodecFormatChange</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-comment">// 输入回调函数，当编解码器需要输入时调用，返回给用户用来写入输入数据的buffer及其对应的index</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnNeedInputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">buffer</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-comment">// 输出回调函数，当编解码器生成新的输出数据时调用，返回给用户用来存放输出数据的buffer及其对应的index</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnNewOutputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">buffer</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>);</li><li>};</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecError</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">errorCode</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">errorCode</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">userData</span>;</li><li>}</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecFormatChange</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-variable">OH_AVFormat</span> <span class="hljs-variable">*format</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>}</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-title class_">uint32_t</span> <span class="hljs-title class_">index</span>, <span class="hljs-variable">OH_AVBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">userData</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    <span class="hljs-variable">CodecUserData</span> *<span class="hljs-variable">codecUserData</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">CodecUserData</span> *&gt;(<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputMutex_</span>);</li><li>    <span class="hljs-comment">// 将输入buffer存放到输入队列中</span></li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue_</span>.<span class="hljs-title class_">emplace</span>(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-comment">// 通知输入线程开始运行</span></li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputCond_</span>.<span class="hljs-title class_">notify_all</span>();</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-title class_">uint32_t</span> <span class="hljs-title class_">index</span>, <span class="hljs-variable">OH_AVBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">userData</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    <span class="hljs-variable">CodecUserData</span> *<span class="hljs-variable">codecUserData</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">CodecUserData</span> *&gt;(<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputMutex_</span>);</li><li>    <span class="hljs-comment">// 将输出buffer存放到输出队列中</span></li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue_</span>.<span class="hljs-title class_">emplace</span>(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-comment">// 通知输出线程开始运行</span></li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputCond_</span>.<span class="hljs-title class_">notify_all</span>();</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section593724325010">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section593724325010" tips="复制节点链接"></i></h2><ol><li>创建解码实例。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建解码器</span></li><li><span class="hljs-variable">OH_AVCodec</span> * <span class="hljs-variable">decoder</span> = <span class="hljs-title function_">OH_AudioCodec_CreateByMime</span>(<span class="hljs-variable">info</span>.<span class="hljs-variable">audioCodecMime</span>,<span class="hljs-keyword">false</span>);</li><li>
</li><li><span class="hljs-comment">// 参数配置</span></li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUDIO_SAMPLE_FORMAT</span>, <span class="hljs-variable">SAMPLE_S16LE</span>); <span class="hljs-comment">//或者S24LE</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUD_CHANNEL_COUNT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioChannelCount</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUD_SAMPLE_RATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioSampleRate</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AAC_IS_ADTS</span>, <span class="hljs-number">1</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-number">96422</span>);<span class="hljs-comment">//码率，当前作为参考，解封装也可以获取到</span></li><li><span class="hljs-title function_">OH_AVFormat_SetBuffer</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_CODEC_CONFIG</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioCodecConfig</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioCodecSize</span>);</li><li><span class="hljs-variable">bool</span> <span class="hljs-variable">res</span> = <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_CHANNEL_LAYOUT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioChannelLayout</span>);</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Configure</span>(<span class="hljs-variable">decoder</span>, <span class="hljs-variable">format</span>);</li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li><li><span class="hljs-variable">format</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li><span class="hljs-comment">// 设置回调，用于输入输出buffer准备完毕后由系统回调出来</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_RegisterCallback</span>(<span class="hljs-variable">decoder</span>,</li><li>    {<span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecFormatChange</span>,</li><li>     <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>},<span class="hljs-variable">codecUserData</span>);</li><li><span class="hljs-comment">// 准备回调和参数设置完毕后通知系统解码器准备好了，下一步准备启动。</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Prepare</span>(<span class="hljs-variable">decoder</span>)</li></ol></pre></div></div> </li><li>音频写入解码器。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">PushInputData</span><span class="hljs-params">(CodecBufferInfo &amp;info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int32_t</span>  ret = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;OH_AVBuffer *&gt;(info.buffer), &amp;info.attr);</li><li>    ret = <span class="hljs-built_in">OH_AudioCodec_PushInputBuffer</span>(decoder, info.bufferIndex);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </li><li>释放使用过的输出码流。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">AudioDecoder::FreeOutputData</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> bufferIndex)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">0</span>;</li><li>    ret = <span class="hljs-built_in">OH_AudioCodec_FreeOutputBuffer</span>(decoder, bufferIndex);</li><li>    <span class="hljs-keyword">return</span> ret ;</li><li>}</li></ol></pre></div></div> </li><li>音频写入线程。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">CodecUserData</span>*<span class="hljs-variable">audioDecContext_</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">CodecUserData</span>;</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">AudioDecInputThread</span>()</li><li>{</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">isStarted_</span>){</li><li>           <span class="hljs-keyword">return</span>;  </li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputMutex_</span>);</li><li>        <span class="hljs-comment">// 阻塞输入线程，直到程序运行结束，或者输入队列不为空</span></li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputCond_</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue_</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">isStarted_</span> || <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue_</span>.<span class="hljs-title class_">empty</span>()){</li><li>           <span class="hljs-keyword">return</span>;  </li><li>        }</li><li>        <span class="hljs-comment">// 获取输入buffer</span></li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue_</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue_</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">inputFrameCount_</span>++;</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-comment">// 从解封装器中读取一帧数据写入输入buffer</span></li><li>        <span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">ReadSample</span>(<span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">GetAudioTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>), <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">audioDecoder_</span>-&gt;<span class="hljs-title class_">PushInputData</span>(<span class="hljs-title class_">bufferInfo</span>);</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">ret</span> != <span class="hljs-number">0</span>){</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>){</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// StartRelease();</span></li><li>}</li></ol></pre></div></div> </li><li>音频解码输出线程。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">AudioDecOutputThread</span>()</li><li>{</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">isStarted_</span>){</li><li>           <span class="hljs-keyword">return</span>;  </li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputMutex_</span>);</li><li>        <span class="hljs-comment">// 阻塞输出线程，直到程序运行结束，或者输出队列不为空</span></li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputCond_</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue_</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">isStarted_</span> || <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue_</span>.<span class="hljs-title class_">empty</span>()){</li><li>           <span class="hljs-keyword">return</span>;  </li><li>        }</li><li>        <span class="hljs-comment">// 获取输出buffer</span></li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue_</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue_</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>){</li><li>           <span class="hljs-keyword">return</span>;  </li><li>        }</li><li>        <span class="hljs-variable">audioDecContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount_</span>++;</li><li>        <span class="hljs-comment">// 获取解码后的pcm数据</span></li><li>        <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">source</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OH_AVBuffer</span> *&gt;(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">buffer</span>));</li><li>        <span class="hljs-variable">OH_AVFormat</span> * <span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVBuffer_GetParameter</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OH_AVBuffer</span> *&gt;(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">buffer</span>));</li><li>        <span class="hljs-variable">uint8_t</span> * <span class="hljs-variable">metadata</span>;</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span>;</li><li>        <span class="hljs-comment">// </span><strong><span class="hljs-comment">获取元数据</span></strong></li><li>        <span class="hljs-title function_">OH_AVFormat_GetBuffer</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUDIO_VIVID_METADATA</span>, &amp;<span class="hljs-title class_">metadata</span>, &amp;<span class="hljs-title class_">size</span>); </li><li>#<span class="hljs-variable">ifdef</span> <span class="hljs-variable">DEBUG_DECODE</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioOutputFile_</span>.<span class="hljs-title function_">is_open</span>()) {</li><li>            <span class="hljs-variable">audioOutputFile_</span>.<span class="hljs-title function_">write</span>((<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>*)<span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OH_AVBuffer</span> *&gt;(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">buffer</span>)), <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>);</li><li>        }</li><li>#<span class="hljs-variable">endif</span></li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">audioDecoder_</span>-&gt;<span class="hljs-title class_">FreeOutputData</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>);</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">ret</span> != <span class="hljs-number">0</span>){</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div> </li><li>启动解码。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AudioCodec_Start</span>(decoder);</li></ol></pre></div></div> </li><li>停止和释放实例。<div _ngcontent-mhi-c106="" class="highlight-div"><div _ngcontent-mhi-c106="" class="highlight-div-header"><div _ngcontent-mhi-c106="" class="highlight-div-header-left"><div _ngcontent-mhi-c106="" class="handle-button expand-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mhi-c106="" class="highlight-div-header-right"><div _ngcontent-mhi-c106="" class="handle-button ai-button"></div><div _ngcontent-mhi-c106="" class="handle-button line-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mhi-c106="" class="handle-button theme-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mhi-c106="" class="handle-button copy-button"><div _ngcontent-mhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioCodec_Stop</span>(decoder);</li><li><span class="hljs-built_in">OH_AudioCodec_Destroy</span>(decoder);</li><li>decoder = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>