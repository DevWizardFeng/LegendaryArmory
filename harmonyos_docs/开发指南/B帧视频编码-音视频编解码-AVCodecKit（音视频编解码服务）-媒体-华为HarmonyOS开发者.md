<h1 _ngcontent-ffy-c119="" class="doc-title ng-star-inserted" title="B帧视频编码"> B帧视频编码 </h1>

<div _ngcontent-ffy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 20开始，支持B帧视频编码。</p>    <p><strong>双向预测帧</strong>，又叫B帧（B frame），是视频编码标准中定义的主要帧类型之一。B帧与P帧的主要差别在于P帧仅支持前向预测，而B帧支持双向预测。</p>    <p>B帧编码预测过程同时利用前后帧的信息，可以显著降低信号的时域冗余，具有更高的压缩效率。</p>    <p>使能B帧的影响：</p>    <ul>     <li>使能B帧，会导致P帧编码时域参考帧的距离增加，可能影响P帧的压缩率和画质；一般在时域较复杂的场景要联合考虑P帧和B帧的综合影响；</li>     <li>使能B帧，也会增加编码和解码的端到端时延。</li>    </ul>    <div class="tiledSection">     <h2 id="适用场景">适用场景<i class="anchor-icon anchor-icon-link" anchorid="适用场景" tips="复制节点链接"></i></h2>          <ul>      <li>录像场景</li>      <li>编辑导出场景</li>      <li>视频转码场景</li>      <li>非低时延直播场景</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="约束和限制">约束和限制<i class="anchor-icon anchor-icon-link" anchorid="约束和限制" tips="复制节点链接"></i></h2>          <ul>      <li><strong>支持的平台</strong>：该能力与平台能力有关，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcapability-h#oh_avcapability_isfeaturesupported" target="_blank">OH_AVCapability_IsFeatureSupported</a>接口查询系统支持情况。</li>      <li><strong>支持的API版本</strong>：API20及以后。</li>      <li><strong>支持的编码器</strong>：该能力与编码器能力有关，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcapability-h#oh_avcodec_getcapabilitybycategory" target="_blank">OH_AVCodec_GetCapabilityByCategory</a>接口查询支持情况。</li>      <li><strong>支持的码控模式</strong>：VBR、CBR、SQR、CQ。</li>      <li>不支持与时域可分层视频编码共同使能。</li>      <li>不支持与长期参考帧共同使能。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口介绍">接口介绍<i class="anchor-icon anchor-icon-link" anchorid="接口介绍" tips="复制节点链接"></i></h2>          <p>支持B帧编码特性需要在初始阶段配置，全程生效，不支持动态修改。</p>     <p>开发配置参数如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.8.4.1.4.1.1" valign="top" width="33.33333333333333%">配置参数</th>         <th align="left" class="cellrowborder" id="mcps1.3.8.4.1.4.1.2" valign="top" width="33.33333333333333%">语义</th>         <th align="left" class="cellrowborder" id="mcps1.3.8.4.1.4.1.3" valign="top" width="33.33333333333333%">格式</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_MD_KEY_VIDEO_ENCODER_ENABLE_B_FRAME</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>视频编码使能B帧参数。</p>          <p>在配置阶段配置，仅特性支持才会真正使能成功。</p></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">int</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_MD_KEY_VIDEO_ENCODER_MAX_B_FRAMES</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>视频编码支持最大B帧数量。</p>          <p>该接口仅供查询。</p></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">int</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>基础编码功能请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>开发指南，下面仅针对B帧编码做具体说明。</p>     <ol>      <li>       <p>在初始阶段创建编码实例时，校验当前视频编码器是否支持B帧编码特性。</p>       <div _ngcontent-ffy-c106="" class="highlight-div"><div _ngcontent-ffy-c106="" class="highlight-div-header"><div _ngcontent-ffy-c106="" class="highlight-div-header-left"><div _ngcontent-ffy-c106="" class="handle-button expand-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ffy-c106="" class="highlight-div-header-right"><div _ngcontent-ffy-c106="" class="handle-button ai-button"></div><div _ngcontent-ffy-c106="" class="handle-button line-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ffy-c106="" class="handle-button theme-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ffy-c106="" class="handle-button copy-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ffy-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-go" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1.1 获取对应视频编码器能力实例，此处以H.265为例。</span></li><li>OH_AVCapability *<span class="hljs-built_in">cap</span> = OH_AVCodec_GetCapabilityByCategory(OH_AVCODEC_MIMETYPE_VIDEO_HEVC, <span class="hljs-literal">true</span>, HARDWARE);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">cap</span> != nullptr) {</li><li>    OH_LOG_INFO(<span class="hljs-string">"Get codec Capability success!"</span>);</li><li>    <span class="hljs-comment">// 1.2 通过特性能力查询接口校验是否支持B帧编码特性。</span></li><li>    <span class="hljs-type">bool</span> isSupported = OH_AVCapability_IsFeatureSupported(<span class="hljs-built_in">cap</span>, VIDEO_ENCODER_B_FRAME);</li><li>    int32_t supportedMaxBFrameCount = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (isSupported) {</li><li>        OH_LOG_INFO(<span class="hljs-string">"Feature VIDEO_ENCODER_B_FRAME is Supported!"</span>);</li><li>        <span class="hljs-comment">// 1.3 确定支持的最大B帧数量。</span></li><li>        OH_AVFormat *property = OH_AVCapability_GetFeatureProperties(<span class="hljs-built_in">cap</span>, VIDEO_ENCODER_B_FRAME);</li><li>        OH_AVFormat_GetIntValue(property, OH_MD_KEY_VIDEO_ENCODER_MAX_B_FRAMES, &amp;supportedMaxBFrameCount);</li><li>        OH_LOG_INFO(<span class="hljs-string">"Get supportedMaxBFrameCount,value is %{public}d!"</span>, supportedMaxBFrameCount);</li><li>        <span class="hljs-comment">// 1.4 销毁临时AVFormat。</span></li><li>        OH_AVFormat_Destroy(property);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(<span class="hljs-string">"Feature VIDEO_ENCODER_B_FRAME is not Supported!"</span>);</li><li>    }</li><li>} <span class="hljs-keyword">else</span> {</li><li>    OH_LOG_ERROR(<span class="hljs-string">"codec Capability is null!"</span>);</li><li>}</li></ol></pre></div></div>       <p>若支持，则可以使能B帧编码特性。</p></li>      <li>       <p>在配置阶段，配置使能B帧编码特性的参数。</p>       <div _ngcontent-ffy-c106="" class="highlight-div"><div _ngcontent-ffy-c106="" class="highlight-div-header"><div _ngcontent-ffy-c106="" class="highlight-div-header-left"><div _ngcontent-ffy-c106="" class="handle-button expand-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ffy-c106="" class="highlight-div-header-right"><div _ngcontent-ffy-c106="" class="handle-button ai-button"></div><div _ngcontent-ffy-c106="" class="handle-button line-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ffy-c106="" class="handle-button theme-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ffy-c106="" class="handle-button copy-button"><div _ngcontent-ffy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ffy-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>// <span class="hljs-number">2.1</span> 创建配置用临时AVFormat。</li><li>OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create();</li><li><span class="hljs-regexp">//</span> <span class="hljs-number">2.2</span> 填充使能参数键值对。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_ENCODER_ENABLE_B_FRAME, <span class="hljs-number">1</span>);</li><li><span class="hljs-regexp">//</span> <span class="hljs-number">2.3</span> 参数配置。</li><li>int32_t ret = OH_VideoEncoder_Configure(videoEnc, <span class="hljs-keyword">format</span>);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-regexp">//</span> 异常处理。</li><li>}</li><li>// <span class="hljs-number">2.4</span> 配置完成后销毁临时AVFormat。</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>);</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ul>          <li>使能B帧编码功能在configure环节是弱校验，如果参数配置有误或者编码器不支持特性仍会返回AV_ERR_OK，但会打印Warning信息。请结合码流产物和运行日志判断是否真实使能。</li>          <li>在使能B帧编码时，实际编码码流中的B帧结构和B帧数量依赖平台能力。</li>         </ul>        </div></div></div></li>     </ol>    </div>   </div>   <div></div></div>