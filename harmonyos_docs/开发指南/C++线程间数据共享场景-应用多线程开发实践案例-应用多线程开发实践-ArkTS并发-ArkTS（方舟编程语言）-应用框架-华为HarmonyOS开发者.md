<h1 _ngcontent-ppa-c119="" class="doc-title ng-star-inserted" title="C++线程间数据共享场景"> C++线程间数据共享场景 </h1>

<div _ngcontent-ppa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在C++层进行多线程并发计算时，需要在每个C++线程上创建ArkTS执行环境，直接调用API。这样可以避免在非UI主线程回调时等待UI主线程的API调用结果。同时，还需要在C++线程之间共享和操作Sendable对象。</p>    <p>为了支持此类场景，C++线程需要能够创建并调用ArkTS，同时支持对Sendable对象进行多线程共享和操作。</p>    <div class="tiledSection">     <h2 id="在c线程上调用arkts能力">在C++线程上调用ArkTS能力<i class="anchor-icon anchor-icon-link" anchorid="在c线程上调用arkts能力" tips="复制节点链接"></i></h2>          <p>使用Node-API接口在C++线程中创建ArkTS运行环境并调用的方法，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-ark-runtime">使用Node-API接口创建ArkTS运行时环境</a>。</p>     <p>核心代码片段如下所示：</p>     <p>ArkTS文件定义。</p>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SendableObjTest.ets</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableObjTest</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">newSendable</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>实现Native加载ArkTS模块的能力。</p>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">CreateArkRuntimeFunc</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 1. 创建基础运行环境</span></li><li>    napi_env env = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status ret = <span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 2. 加载自定义模块，假定SendableObjTest中提供创建sendable对象的方法newSendable</span></li><li>    napi_value test = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"entry/src/main/ets/pages/SendableObjTest"</span>, <span class="hljs-string">"com.example.myapplication/entry"</span>, &amp;test);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    napi_value sendableObjTest = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_get_named_property</span>(env, test, <span class="hljs-string">"SendableObjTest"</span>, &amp;sendableObjTest);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 3. 使用ArkTS中的newSendable，假设sendableObjTest中有一个函数newSendable能返回sendable对象</span></li><li>    napi_value newSendable = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_get_named_property</span>(env, sendableObjTest, <span class="hljs-string">"newSendable"</span>, &amp;newSendable);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 4. 调用newSendable函数返回新创建的sendable对象，并保存在result中</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_call_function</span>(env, sendableObjTest, newSendable, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 5. 获取ArkTS返回的结果</span></li><li>    <span class="hljs-type">int</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, result, &amp;value0);</li><li>    <span class="hljs-keyword">if</span> (value0 != <span class="hljs-number">1024</span>) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 6. 销毁ArkTS环境</span></li><li>    ret = <span class="hljs-built_in">napi_destroy_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>     <p>主要步骤包括：创建执行环境、加载模块、查找并调用模块函数（或直接通过Node-API接口创建Sendable对象），最后销毁执行环境。加载模块的详细信息，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-load-module-with-info">使用Node-API接口进行模块加载</a>。查找并调用函数及更多Node-API接口能力，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/napi" target="_blank">Node-API</a>。</p>    </div>    <div class="tiledSection">     <h2 id="在c线程之间操作sendable共享对象">在C++线程之间操作Sendable共享对象<i class="anchor-icon anchor-icon-link" anchorid="在c线程之间操作sendable共享对象" tips="复制节点链接"></i></h2>          <p>在C++中调用ArkTS能力后，需要通过序列化和反序列化跨线程传递。napi_value不是多线程安全的，不能直接在多线程之间操作和共享。</p>     <p>下面代码例子说明了如何序列化和反序列化传递对象，注意因为Sendable共享对象是引用传递，所以序列化不会产生另外一份拷贝数据，而是直接传递对象引用到反序列化线程，所以在性能上相比非Sendable对象的序列化和反序列化更为高效。</p>     <p>ArkTS文件定义。</p>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SendableObjTest.ets</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableObjTest</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">newSendable</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在Native中实现两个线程的序列化和反序列化Sendable的逻辑。</p>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">void</span> *serializationData = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">CreateEnvAndSendSendable</span><span class="hljs-params">(<span class="hljs-type">void</span> *)</span> </span>{</li><li>    <span class="hljs-comment">// 1. 创建基础运行环境</span></li><li>    napi_env env = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status ret = <span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 2. 加载自定义模块，假定SendableObjTest中提供创建sendable对象的方法newSendable</span></li><li>    napi_value test = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"entry/src/main/ets/pages/SendableObjTest"</span>, <span class="hljs-string">"com.example.myapplication/entry"</span>,</li><li>                                     &amp;test);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    napi_value sendableObjTest = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_get_named_property</span>(env, test, <span class="hljs-string">"SendableObjTest"</span>, &amp;sendableObjTest);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 3. 使用ArkTS中的newSendable，假设sendableObjTest中有一个函数newSendable能返回sendable对象</span></li><li>    napi_value newSendable = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_get_named_property</span>(env, sendableObjTest, <span class="hljs-string">"newSendable"</span>, &amp;newSendable);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 4. 调用newSendable函数返回新创建的sendable对象，并保存在result中</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_call_function</span>(env, sendableObjTest, newSendable, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 5. 序列化sendable对象</span></li><li>    napi_value undefined;</li><li>    <span class="hljs-built_in">napi_get_undefined</span>(env, &amp;undefined);</li><li>    ret = <span class="hljs-built_in">napi_serialize</span>(env, result, undefined, undefined, &amp;serializationData);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">CreateEnvAndReceiveSendable</span><span class="hljs-params">(<span class="hljs-type">void</span> *)</span> </span>{</li><li>    <span class="hljs-comment">// 1. 创建基础运行环境</span></li><li>    napi_env env = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status ret = <span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 2. 反序列化获取sendable共享对象，结果保存在result中，这个result就可以通过napi接口进行各种操作了</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">napi_deserialize</span>(env, serializationData, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 3. 删除序列化数据</span></li><li>    ret = <span class="hljs-built_in">napi_delete_serialization_data</span>(env, serializationData);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, result, &amp;valuetype0);</li><li>    <span class="hljs-keyword">if</span> (valuetype0 != napi_number) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-type">int</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, result, &amp;value0);</li><li>    <span class="hljs-keyword">if</span> (value0 != <span class="hljs-number">1024</span>) {</li><li>        std::<span class="hljs-built_in">abort</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestSendSendable</span><span class="hljs-params">([[maybe_unused]] napi_env env, [[maybe_unused]] napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(CreateEnvAndSendSendable, <span class="hljs-literal">nullptr</span>)</span></span>;</li><li>    t1.<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(CreateEnvAndReceiveSendable, <span class="hljs-literal">nullptr</span>)</span></span>;</li><li>    t2.<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"testSendSendable"</span>, <span class="hljs-literal">nullptr</span>, TestSendSendable, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testSendSendable</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;</li></ol></pre></div></div>     <p>UI主线程发起调用。</p>     <div _ngcontent-ppa-c106="" class="highlight-div"><div _ngcontent-ppa-c106="" class="highlight-div-header"><div _ngcontent-ppa-c106="" class="highlight-div-header-left"><div _ngcontent-ppa-c106="" class="handle-button expand-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppa-c106="" class="highlight-div-header-right"><div _ngcontent-ppa-c106="" class="handle-button ai-button"></div><div _ngcontent-ppa-c106="" class="handle-button line-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppa-c106="" class="handle-button theme-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppa-c106="" class="handle-button copy-button"><div _ngcontent-ppa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableObjTest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SendableObjTest'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">SendableObjTest</span>.<span class="hljs-title function_">newSendable</span>()</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test send Sendable begin'</span>);</li><li>            testNapi.<span class="hljs-title function_">testSendSendable</span>();</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test send Sendable end'</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>整个过程主要包括的逻辑实现为：</p>     <ol>      <li>       <p>在UI主线程中创建ArkTS运行环境，并发起一个C++子线程创建Sendable对象，保存到result中，然后将result引用的Sendable对象序列化到全局序列化数据serializationData中。</p></li>      <li>       <p>当这些流程完成后，发起另外一个C++子线程，并在这个新的线程中创建ArkTS运行环境。然后再通过反序列化接口从serializationData中反序列化出UI主线程创建的Sendable对象，并保存到result中，从而实现了Sendable对象的跨C++线程传递。反序列化完成后，需要销毁反序列化数据避免内存泄露。这时UI主线程和子线程都同时持有这个Sendable共享对象，即可通过Node-API进行对象操作，比如读写或者传递到ArkTS层等。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>操作对象需要符合Sendable对象的规则，具体可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/sendable-constraints">Sendable使用规则与约束</a>。</p>        </div></div></div></li>     </ol>    </div>   </div>   <div></div></div>