<h1 _ngcontent-ksl-c119="" class="doc-title ng-star-inserted" title="CMAC(C/C++)"> CMAC(C/C++) </h1>

<div _ngcontent-ksl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>CMAC是基于对称密钥分组加密算法的消息认证码（Cipher-based Message Authentication Code），目前支持3DES加密算法的消息认证方法。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>仅支持在智能穿戴设备（Wearable）使用。</p> </div></div></div> <div class="tiledSection"><h2 id="section656084835913">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section656084835913" tips="复制节点链接"></i></h2><p><strong>生成密钥</strong></p> <ol><li>获取生成密钥算法参数配置。</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_generatekeyitem" target="_blank">OH_Huks_GenerateKeyItem</a>生成密钥，支持的规格是128比特长度的密钥。</li></ol> <p>除此之外，开发者也可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview#支持的算法" target="_blank">密钥导入</a>的规格介绍，导入已有的密钥。</p> <p><strong>执行CMAC</strong></p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-param-h#oh_huks_initparamset" target="_blank">OH_Huks_InitParamSet</a>获取算法参数配置。</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_initsession" target="_blank">OH_Huks_InitSession</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_finishsession" target="_blank">OH_Huks_FinishSession</a>计算MAC值。</li></ol> <div _ngcontent-ksl-c106="" class="highlight-div"><div _ngcontent-ksl-c106="" class="highlight-div-header"><div _ngcontent-ksl-c106="" class="highlight-div-header-left"><div _ngcontent-ksl-c106="" class="handle-button expand-button"><div _ngcontent-ksl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksl-c106="" class="highlight-div-header-right"><div _ngcontent-ksl-c106="" class="handle-button ai-button"></div><div _ngcontent-ksl-c106="" class="handle-button line-button"><div _ngcontent-ksl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksl-c106="" class="handle-button theme-button"><div _ngcontent-ksl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksl-c106="" class="handle-button copy-button"><div _ngcontent-ksl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_type.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> CMAC_COMMON_SIZE = <span class=""><span class="hljs-number">8</span></span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> IV_SIZE = <span class="hljs-number">8</span>; </li><li><span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> IV[IV_SIZE] = { <span class=""><span class="hljs-number">0</span></span> };</li><li>
</li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">InitParamSet</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_Huks_ParamSet **paramSet, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Param *params, <span class="hljs-type">uint32_t</span> paramCount)</span></span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_AddParams</span>(*paramSet, params, paramCount);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_BuildParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_genParams[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_3DES</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_3DES_KEY_SIZE_128</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_MAC</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_cmacParams[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_CMAC</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_3DES_KEY_SIZE_128</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_MAC</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_BLOCK_MODE,</li><li>        .uint32Param = OH_HUKS_MODE_CBC</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PADDING,</li><li>        .uint32Param = OH_HUKS_PADDING_ISO_IEC_9797_1</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_IV,</li><li>        .blob = {</li><li>            .<span class="">size</span> = IV_SIZE,</li><li>            .data = (<span class="hljs-type">uint8_t</span> *)IV</li><li>        }</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">HksCmacTest</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *keyAlias, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_ParamSet *cmacParamSet,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *inData, <span class="hljs-keyword">struct</span> OH_Huks_Blob *outData)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint8_t</span> handleE[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)] = {<span class=""><span class="hljs-number">0</span></span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> handle = {<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>), handleE};</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitSession</span>(keyAlias, cmacParamSet, &amp;handle, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_FinishSession</span>(&amp;handle, cmacParamSet, inData, outData);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CmacKey</span><span class="hljs-params">(napi_env env</span></span><span class=""><span class="hljs-function"><span class="hljs-params">, </span></span></span><span class="hljs-function"><span class="hljs-params">napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> tmpKeyAlias[] = <span class=""><span class="hljs-string">"test_cmac"</span></span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> keyAlias = { (<span class="hljs-type">uint32_t</span>)<span class=""><span class="hljs-built_in">strlen</span></span>(tmpKeyAlias), (<span class="hljs-type">uint8_t</span> *)tmpKeyAlias };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *genParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *cmacParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Huks_Result ohResult;</li><li>    <span class="hljs-keyword">do</span> {</li><li><em>      <span class="hljs-comment">/*</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">       * 1.1 获取生成密钥算法参数配置</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">       */</span></em></li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;genParamSet, g_genParams, <span class="hljs-built_in">sizeof</span>(g_genParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li><em>       <span class="hljs-comment">/*       </span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        * 1.2 调用OH_Huks_GenerateKeyItem</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        */</span></em></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;keyAlias, genParamSet, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li><em>       <span class="hljs-comment">/*</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        * 2.1. 获取CMAC算法参数配置</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        */</span></em></li><li>        <span class="hljs-type">char</span> tmpInData[] = <span class=""><span class="hljs-string">"CMAC_INDATA"</span></span>;</li><li>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> inData = { (<span class="hljs-type">uint32_t</span>)<span class=""><span class="hljs-built_in">strlen</span></span>(tmpInData), (<span class="hljs-type">uint8_t</span> *)tmpInData };</li><li>        <span class="hljs-type">uint8_t</span> mac[CMAC_COMMON_SIZE] = {<span class=""> <span class="hljs-number">0</span></span> };</li><li>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> macData= {CMAC_COMMON_SIZE, mac};</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;cmacParamSet, g_cmacParams, <span class="hljs-built_in">sizeof</span>(g_cmacParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li><em>       <span class="hljs-comment">/*</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        * 2.2 调用initSession和finishSession计算MAC</span></em><span class="hljs-comment"></span></li><li><span class="hljs-comment"></span><em><span class="hljs-comment">        */</span></em></li><li>        ohResult = <span class="hljs-built_in">HksCmacTest</span>(&amp;keyAlias, cmacParamSet, &amp;inData, &amp;macData);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    } <span class="hljs-keyword">while</span> (<span class=""><span class="hljs-number">0</span></span>);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;cmacParamSet);</li><li>    </li><li>    napi_value ret;</li><li><span class="">    <span class="hljs-built_in">napi_create_int32</span></span>(env, ohResult.errorCode, &amp;ret);</li><li><span class="">    <span class="hljs-keyword">return</span></span> ret;</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>