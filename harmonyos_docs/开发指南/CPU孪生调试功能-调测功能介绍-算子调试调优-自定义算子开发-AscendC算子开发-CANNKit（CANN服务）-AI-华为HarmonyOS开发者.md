<h1 _ngcontent-wsa-c119="" class="doc-title ng-star-inserted" title="CPU孪生调试功能"> CPU孪生调试功能 </h1>

<div _ngcontent-wsa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1953mcpsimp">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section1953mcpsimp" tips="复制节点链接"></i></h2><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>当开发者需要快速进行代码逻辑调试，可优先选择算子CPU调测。使用通用的打印、gdb调测手段，快速定位代码问题。</li></ul> <ul><li>在NPU板端上板运行之前，可优先选择算子CPU调测初步定位算子精度问题，提高算子NPU上板成功率。</li></ul> </div></div></div> <p>CPU孪生调试主要基于开发者输入生成编译所需的二进制bin文件，然后自动执行算子编译和运行，该阶段支持的调测项如表1所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>CPU调测功能列表</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.4.2.3.1.1" valign="top" width="27%"><p>功能名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.4.2.3.1.2" valign="top" width="73%"><p>功能说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="27%"><p>自动精度比对</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>若开发者配置了标杆数据（golden数据），工具会自动将实际调测运行结果与标杆数据进行精度比对。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>printf/PRINTF功能</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>支持屏显打印Scalar数据，如常量、字符串等信息，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-printf">printf/PRINTF功能</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>DumpTensor功能</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>支持dump Tensor数据，功能和产物与NPU上板dump功能类似，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-dumptensor">DumpTensor功能</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>DumpAccChkPoint功能</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>支持dump偏移位置的Tensor数据，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-dumpaccchkpoint">DumpAccChkPoint功能</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>assert功能</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>支持屏显打印断言，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-assert">assert功能</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>CCE指令流打印</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>默认开启，CCE指令流文件参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cpu-twin-debugging#section2040mcpsimp">产物说明</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="27%"><p>gdb调试</p> </td> <td class="cellrowborder" valign="top" width="73%"><p>可使用gdb单步调试算子计算精度。具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-gdb">gdb调试</a>。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section2019mcpsimp">使用方法（命令行）<i class="anchor-icon anchor-icon-link" anchorid="section2019mcpsimp" tips="复制节点链接"></i></h2><p>通过命令行进行CPU调测的关键步骤如下。</p> <ol><li><span>完成环境搭建，并准备好输入/标杆数据文件。</span></li><li><span>执行如下命令进行CPU调测，这里仅提供关键参数项示例，其他参数请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section28071649102319">CPU调测参数</a>按需设置。</span><p></p><div _ngcontent-wsa-c106="" class="highlight-div"><div _ngcontent-wsa-c106="" class="highlight-div-header"><div _ngcontent-wsa-c106="" class="highlight-div-header-left"><div _ngcontent-wsa-c106="" class="handle-button expand-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wsa-c106="" class="highlight-div-header-right"><div _ngcontent-wsa-c106="" class="handle-button ai-button"></div><div _ngcontent-wsa-c106="" class="handle-button line-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wsa-c106="" class="handle-button theme-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wsa-c106="" class="handle-button copy-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wsa-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>ascendebug kernel <strong>--backend</strong> cpu --chip-version ${chip_version} <strong>--repo-type</strong> customize <strong>--json-file </strong>${op_config_json_file}<strong> --core-type</strong> ${core_type} <strong>--work-dir</strong> ${work_dir} ... {其他参数}</li></ol></pre></div></div> <p>CPU调测涉及的所有参数可通过<strong>ascendebug kernel -h</strong>或<strong>ascendebug kernel --help</strong>查看。</p> <p></p></li><li><span>查看结果文件，详细说明参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cpu-twin-debugging#section2040mcpsimp">产物说明</a>。</span></li></ol> </div> <div class="tiledSection"><h2 id="section2040mcpsimp">产物说明<i class="anchor-icon anchor-icon-link" anchorid="section2040mcpsimp" tips="复制节点链接"></i></h2><p>CPU调测结果存放在${root}/${work_dir}/cpu路径下，其中${root}表示当前操作路径，${work_dir}表示调测工作空间，默认为/debug_workspace/${op_type}目录，${op_type}为算子名。目录结构示例如下。</p> <div _ngcontent-wsa-c106="" class="highlight-div"><div _ngcontent-wsa-c106="" class="highlight-div-header"><div _ngcontent-wsa-c106="" class="highlight-div-header-left"><div _ngcontent-wsa-c106="" class="handle-button expand-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wsa-c106="" class="highlight-div-header-right"><div _ngcontent-wsa-c106="" class="handle-button ai-button"></div><div _ngcontent-wsa-c106="" class="handle-button line-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wsa-c106="" class="handle-button theme-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wsa-c106="" class="handle-button copy-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wsa-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>├ ${op_type}                    // 算子名 </li><li>├── cpu </li><li>│   ├── build               // 存放CPU编译生成的中间文件 </li><li>│   │   ├── cceprint      // 存放cce 指令流输出文件的目录</li><li>│   │   │   └── auto_gen_add_custom_kernel_0_0_mix.cce // cce指令流文件</li><li>│       ├── xxx_cpu         // CPU编译生成的算子可执行程序 </li><li>│   ├── output              // 存放CPU编译运行的输出文件及精度比对结果 </li><li>│       ├── <strong>y.bin</strong>           // 运行输出原始数据 </li><li>│       ├──<strong> y.txt</strong>           // 精度比对结果文件 </li><li>│   ├── src                 // 存放CPU编译生成的临时代码文件 </li><li>│       ├── CMakeLists.txt </li><li>│       ├── data_definition.txt </li><li>│       ├── add_custom_main.cpp </li><li>│       ├── add_custom_tiling.h  </li><li>│       ├── _gen_kernel_${op_type}.cpp </li><li>│   ├── dump               // dump文件落盘目录 </li><li>│       ├── PARSER_${timestamp} </li><li>│           ├── dump_data     </li><li>│               ├──0                     // core number </li><li>│                   ├──index_1           // index是dump接口的desc唯一标识值 </li><li>│                       ├──core_0_index_1_loop_0.bin </li><li>│                       ├──core_0_index_1_loop_0.txt   </li></ol></pre></div></div> <ul><li id="zh-cn_topic_0000002119118721_li2051mcpsimp"><strong>查看精度比对结果</strong><ol><li>在output目录下，查看是否生成输出文件(bin)和精度比对文件(txt)。</li><li>根据精度比对文件(txt)，确认算子精度比对结果。<p>精度比对结果输出样例如下，主要展示两份数据的均值、部分误差对比以及成功/失败的最终比对结论。若结果是失败，会将最大误差的部分数据展示出来。</p> <div _ngcontent-wsa-c106="" class="highlight-div"><div _ngcontent-wsa-c106="" class="highlight-div-header"><div _ngcontent-wsa-c106="" class="highlight-div-header-left"><div _ngcontent-wsa-c106="" class="handle-button expand-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wsa-c106="" class="highlight-div-header-right"><div _ngcontent-wsa-c106="" class="handle-button ai-button"></div><div _ngcontent-wsa-c106="" class="handle-button line-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wsa-c106="" class="handle-button theme-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wsa-c106="" class="handle-button copy-button"><div _ngcontent-wsa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wsa-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>data_cmp mean is -1.41e-05 data_gd mean is -1.41e-05 </li><li> split_count:2359296.0; max_diff_hd:0.1; </li><li> --------------------------------------------------------------------------------------- </li><li>   Loop           ExpectOut        RealOut         FpDiff         RateDiff </li><li> --------------------------------------------------------------------------------------- </li><li> 00000001         0.0395813       0.0395813       0.0000000       0.0000000 </li><li> 00000002         0.0160980       0.0160980       0.0000000       0.0000000 </li><li> 00000003         -0.0443420      -0.0443420      0.0000000       0.0000000 </li><li> 00000004         -0.0847778      -0.0847778      0.0000000       0.0000000 </li><li> 00000005         -0.0066605      -0.0066605      0.0000000       0.0000000 </li><li> 00000006         0.0880737       0.0880737       0.0000000       0.0000000 </li><li> 00000007         0.0848389       0.0848389       0.0000000       0.0000000 </li><li> 00000008         0.1083374       0.1083374       0.0000000       0.0000000 </li><li> 00000009         0.0838623       0.0838623       0.0000000       0.0000000 </li><li> 00000010         0.0887451       0.0887451       0.0000000       0.0000000 </li><li> 00000011         0.0572205       0.0572205       0.0000000       0.0000000 </li><li> 00000012         0.0741577       0.0741577       0.0000000       0.0000000 </li><li> 00000013         -0.0762329      -0.0762329      0.0000000       0.0000000 </li><li> 00000014         -0.0957642      -0.0957642      0.0000000       0.0000000 </li><li> 00000015         0.0102234       0.0102234       0.0000000       0.0000000 </li><li>   ...               ...             ...             ...             ... </li><li> --------------------------------------------------------------------------------------- </li><li> DiffThd           PctThd          PctRlt          Result </li><li> --------------------------------------------------------------------------------------- </li><li> 0.0050            99.50%          100.000000%     Pass </li><li> Success Success Success Success Success</li></ol></pre></div></div> </li></ol> </li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>精度比对结果说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.5.2.3.1.1" valign="top" width="24%"><p>信息项</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.5.2.3.1.2" valign="top" width="76%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="24%"><p>data_cmp mean</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>运行输出数据的均值信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>data_gd mean</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>标杆数据的均值信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>split_count</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>统计输出数据的个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>max_diff_hd</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>输出数据和golden数据的最大误差值阈值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>详细对比数据展示（部分）</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>Loop（数据位置）、ExpectOut（期望输出值）、RealOut（实际输出值）、FpDiff （绝对误差值）、RateDiff（相对误差值）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>整体对比结果展示</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>DiffThd（相对误差值阈值）、PctThd （精度达标数据占比阈值）、PctRlt（实际精度达标数据占比）、Result（对比结果）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24%"><p>Error Line展示项</p> </td> <td class="cellrowborder" valign="top" width="76%"><p>若精度比对结果为Failed，会追加展示部分误差较大的数据的详细信息，信息格式与<a href="/consumer/cn/doc/harmonyos-guides/cannkit-cpu-twin-debugging#zh-cn_topic_0000002119118721_li2051mcpsimp">精度比对结果</a>一致。</p> </td> </tr>  </tbody></table></div> </div> <ul><li><strong>（可选）查看dump结果</strong><p>若开启<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-dumptensor">DumpTensor功能</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-dumpaccchkpoint">DumpAccChkPoint功能</a>，结果文件存放在dump目录下，结果目录具体介绍参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-function-dumptensor#section2903mcpsimp">产物说明</a>。</p> </li></ul> </div> </div> <div></div></div>