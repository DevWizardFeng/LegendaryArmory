<h1 _ngcontent-afx-c119="" class="doc-title ng-star-inserted" title="CPU密集型任务开发指导 (TaskPool和Worker)"> CPU密集型任务开发指导 (TaskPool和Worker) </h1>

<div _ngcontent-afx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>CPU密集型任务是指需要占用系统资源进行大量计算的任务，这类任务需要长时间运行，会阻塞线程中其他事件的处理，因此不适合在UI主线程中执行。例如图像处理、视频编码、数据分析等。</p>    <p>基于多线程并发机制处理CPU密集型任务可以提高CPU利用率，提升应用程序响应速度。</p>    <p>当任务不需要长时间（3分钟）占用后台线程，而是一个个独立的任务时，推荐使用TaskPool，反之推荐使用Worker。</p>    <p>接下来将分别以图像直方图处理和后台长时间模型预测任务为例进行说明。</p>    <div class="tiledSection">     <h2 id="使用taskpool进行图像直方图处理">使用TaskPool进行图像直方图处理<i class="anchor-icon anchor-icon-link" anchorid="使用taskpool进行图像直方图处理" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>实现图像处理的业务逻辑。</p></li>      <li>       <p>对数据进行分段，并通过任务组发起关联任务调度。</p>       <p>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskgroup10" target="_blank">TaskGroup</a>，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#addtask10" target="_blank">addTask()</a>添加对应的任务，然后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskpoolexecute10" target="_blank">execute()</a>执行任务组，并指定为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#priority" target="_blank">高优先级</a>。在当前任务组所有任务结束后，会将直方图处理结果同时返回。</p></li>      <li>       <p>汇总处理结果数组。</p></li>     </ol>     <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">imageProcessing</span>(<span class="hljs-params">dataSlice: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-title class_">ArrayBuffer</span> {</li><li>  <span class="hljs-comment">// 步骤1: 具体的图像处理操作及其他耗时操作</span></li><li>  <span class="hljs-keyword">return</span> dataSlice;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">histogramStatistic</span>(<span class="hljs-params">pixelBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// 步骤2: 分成三段并发调度</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">number</span>: <span class="hljs-built_in">number</span> = pixelBuffer.<span class="hljs-property">byteLength</span> / <span class="hljs-number">3</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer1</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">number</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer2</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span> * <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer3</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-built_in">number</span> * <span class="hljs-number">2</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">group</span>: taskpool.<span class="hljs-property">TaskGroup</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">TaskGroup</span>();</li><li>  group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer1);</li><li>  group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer2);</li><li>  group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer3);</li><li>
</li><li>  taskpool.<span class="hljs-title function_">execute</span>(group, taskpool.<span class="hljs-property">Priority</span>.<span class="hljs-property">HIGH</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 步骤3: 结果数组汇总处理</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'execute group success'</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">24</span>);</li><li>            <span class="hljs-title function_">histogramStatistic</span>(buffer);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="使用worker进行长时间数据分析">使用Worker进行长时间数据分析<i class="anchor-icon anchor-icon-link" anchorid="使用worker进行长时间数据分析" tips="复制节点链接"></i></h2>          <p>本文通过某地区提供的房价数据训练一个简易的房价预测模型，该模型支持通过输入房屋面积和房间数量去预测该区域的房价，模型需要长时间运行，房价预测需要使用前面的模型运行结果，因此需要使用Worker。</p>     <ol>      <li>       <p>DevEco Studio提供了Worker创建的模板，创建一个Worker线程，例如命名为“MyWorker”。</p>       <p><span><img originheight="471" originwidth="460" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114910.64969516015731525002325490190237:50001231000000:2800:258BF73D4EFF8A4CBC6A320E7EBF4F2E8C0BD345AC00B816AB38065E6BF0091A.png" width="460" height="471"></span></p></li>      <li>       <p>在宿主线程中首先调用ThreadWorker的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#constructor9" target="_blank">constructor()</a>方法创建Worker对象；然后通过注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#属性-1" target="_blank">onmessage()</a>回调接收Worker线程发送过来的消息；最后通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#postmessage9" target="_blank">postMessage()</a>方法向Worker线程发送消息。</p>       <p>例如，向Worker线程发送训练和预测的消息，并接收Worker线程发送回来的消息。</p>       <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorEvent</span>, <span class="hljs-title class_">MessageEvents</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerInstance</span>: worker.<span class="hljs-property">ThreadWorker</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/MyWorker.ets'</span>);</li><li>
</li><li><span class="hljs-keyword">let</span> done = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-comment">// 接收Worker子线程的结果</span></li><li>workerInstance.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event: MessageEvents</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'MyWorker.ets onmessage'</span>);</li><li>  <span class="hljs-keyword">if</span> (!done) {</li><li>    workerInstance.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-string">'type'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'value'</span>: <span class="hljs-number">0</span> });</li><li>    done = <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>
</li><li>workerInstance.<span class="hljs-property">onAllErrors</span> = <span class="hljs-function">(<span class="hljs-params">err: ErrorEvent</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 接收Worker子线程的错误信息</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 向Worker子线程发送训练消息</span></li><li>workerInstance.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-string">'type'</span>: <span class="hljs-number">0</span> });</li></ol></pre></div></div></li>      <li>       <p>在MyWorker.ets文件中绑定Worker对象，当前线程即为Worker线程。在Worker线程中通过注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#属性-2" target="_blank">onmessage()</a>回调接收宿主线程发送的消息，并通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#postmessage9-2" target="_blank">postMessage()</a>方法向宿主线程发送消息。</p>       <p>例如，在Worker线程中定义预测模型及其训练过程，并与宿主线程进行信息交互。</p>       <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// MyWorker.ets</span></li><li><span class="hljs-keyword">import</span> { worker, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, <span class="hljs-title class_">MessageEvents</span>, <span class="hljs-title class_">ErrorEvent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li>
</li><li><span class="hljs-comment">// 定义训练模型及结果</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt;;</li><li><span class="hljs-comment">// 定义预测函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li> <span class="hljs-keyword">return</span> result[x];</li><li>}</li><li><span class="hljs-comment">// 定义优化器训练过程</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li> result = [<span class="hljs-number">0</span>];</li><li>}</li><li><span class="hljs-comment">// Worker线程的onmessage逻辑</span></li><li>workerPort.<span class="hljs-property">onmessage</span> = (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvents</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li> <span class="hljs-comment">// 根据传输的数据的type选择进行操作</span></li><li> <span class="hljs-keyword">switch</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) {</li><li>  <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:</li><li>  <span class="hljs-comment">// 进行训练</span></li><li>   <span class="hljs-title function_">optimize</span>();</li><li>  <span class="hljs-comment">// 训练之后发送宿主线程训练成功的消息</span></li><li>   workerPort.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'message'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'train success.'</span> });</li><li>   <span class="hljs-keyword">break</span>;</li><li>  <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</li><li>  <span class="hljs-comment">// 执行预测</span></li><li>   <span class="hljs-keyword">const</span> <span class="hljs-attr">output</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title function_">predict</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">value</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>);</li><li>  <span class="hljs-comment">// 发送宿主线程预测的结果</span></li><li>   workerPort.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'predict'</span>, <span class="hljs-attr">value</span>: output });</li><li>   <span class="hljs-keyword">break</span>;</li><li>  <span class="hljs-attr">default</span>:</li><li>   workerPort.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'message'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'send message is invalid'</span> });</li><li>   <span class="hljs-keyword">break</span>;</li><li> }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在Worker线程中完成任务后，可以执行销毁操作。销毁方式有两种：一是在宿主线程中销毁Worker线程；二是在Worker线程中主动销毁。</p>       <p>在宿主线程中通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#属性-1" target="_blank">onexit()</a>回调定义Worker线程销毁后的处理逻辑。</p>       <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-comment">// Worker线程销毁后，执行onexit回调方法</span></li><li>workerInstance.<span class="hljs-property">onexit</span> = (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"main thread terminate"</span>);</li><li>}</li></ol></pre></div></div>       <p>方式一：在宿主线程中通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#terminate9" target="_blank">terminate()</a>方法销毁Worker线程，并终止Worker接收消息。</p>       <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-comment">// 销毁Worker线程</span></li><li>workerInstance.<span class="hljs-title function_">terminate</span>();</li></ol></pre></div></div>       <p>方式二：在Worker线程中通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#close9" target="_blank">close()</a>方法主动销毁Worker线程，并终止Worker接收消息。</p>       <div _ngcontent-afx-c106="" class="highlight-div"><div _ngcontent-afx-c106="" class="highlight-div-header"><div _ngcontent-afx-c106="" class="highlight-div-header-left"><div _ngcontent-afx-c106="" class="handle-button expand-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afx-c106="" class="highlight-div-header-right"><div _ngcontent-afx-c106="" class="handle-button ai-button"></div><div _ngcontent-afx-c106="" class="handle-button line-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afx-c106="" class="handle-button theme-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afx-c106="" class="handle-button copy-button"><div _ngcontent-afx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// MyWorker.ets</span></li><li><span class="hljs-comment">// 销毁线程</span></li><li>workerPort.<span class="hljs-title function_">close</span>();</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>