<h1 _ngcontent-xch-c119="" class="doc-title ng-star-inserted" title="CPU特性"> CPU特性 </h1>

<div _ngcontent-xch-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>CPU特性是CPU提供的一些硬件扩展。开发者可以通过调用指令，设置特殊寄存器来使用这些CPU特性，例如ARMv7a架构上的VFP-v32d32、NEON、IDIV、AES等CPU特性。很多CPU特性是可选的，不同厂商的CPU通常有不同的特性。</p> <p>在HarmonyOS原生库开发中，如何使用CPU特性？如何在代码中处理CPU特性相关的代码？本章节将提供一些方法，以便帮助开发者开发出既能保持兼容性，又能利用CPU特有能力的应用。</p> <p>HarmonyOS系统当前没有提供获取CPU特性的接口，开发者可以导入现有开源社区的库函数，具体可以参考如下的例子；也可直接读取/proc/cpuinfo，或者调用libc getauxval(AT_HWCAP)接口来获取设备的CPU特性。</p>  <div class="tiledSection"><h2 id="使用建议">使用建议<i class="anchor-icon anchor-icon-link" anchorid="使用建议" tips="复制节点链接"></i></h2><ol><li><p>在HarmonyOS系统C++工程中引入开源库，下载<a href="https://github.com/google/cpu_features" target="_blank">cpu_features库</a>，解压到工程的cpp目录下，解压后的文件名改为cpu_features。如下以DevEco Studio C++模版示例应用举例：</p>  <ul><li>解压后目录结构如下<div _ngcontent-xch-c106="" class="highlight-div"><div _ngcontent-xch-c106="" class="highlight-div-header"><div _ngcontent-xch-c106="" class="highlight-div-header-left"><div _ngcontent-xch-c106="" class="handle-button expand-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xch-c106="" class="highlight-div-header-right"><div _ngcontent-xch-c106="" class="handle-button ai-button"></div><div _ngcontent-xch-c106="" class="handle-button line-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xch-c106="" class="handle-button theme-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xch-c106="" class="handle-button copy-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xch-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>MyApplication</li><li>  |-- entry</li><li>   |-- src</li><li>        |-- main</li><li>             |-- cpp</li><li>                 |--cpu_features</li><li>                 |--CMakeLists.txt</li><li>                 |--hello.cpp</li></ol></pre></div></div>  </li><li>在CMakeLists.txt添加导入目录<div _ngcontent-xch-c106="" class="highlight-div"><div _ngcontent-xch-c106="" class="highlight-div-header"><div _ngcontent-xch-c106="" class="highlight-div-header-left"><div _ngcontent-xch-c106="" class="handle-button expand-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xch-c106="" class="highlight-div-header-right"><div _ngcontent-xch-c106="" class="handle-button ai-button"></div><div _ngcontent-xch-c106="" class="handle-button line-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xch-c106="" class="handle-button theme-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xch-c106="" class="handle-button copy-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xch-c106="" class="highlight-scroll-div"><pre class="makefile prettyprint linenums hljs language-makefile" hw-language="makefile" data-highlighted="yes"><ol class="linenums"><li>add_subdirectory(cpu_features) <span class="hljs-comment"># 添加子目录到工程</span></li><li>target_link_libraries(entry PUBLIC cpu_features) <span class="hljs-comment"># 添加需要链接依赖的库文件</span></li></ol></pre></div></div>  </li></ul>  </li><li><p>在代码中加入判断CPU特性支持能力语句，如下以支持ARM与AARCH64两种架构举例：</p>  <div _ngcontent-xch-c106="" class="highlight-div"><div _ngcontent-xch-c106="" class="highlight-div-header"><div _ngcontent-xch-c106="" class="highlight-div-header-left"><div _ngcontent-xch-c106="" class="handle-button expand-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xch-c106="" class="highlight-div-header-right"><div _ngcontent-xch-c106="" class="handle-button ai-button"></div><div _ngcontent-xch-c106="" class="handle-button line-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xch-c106="" class="handle-button theme-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xch-c106="" class="handle-button copy-button"><div _ngcontent-xch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xch-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// 包含CPU架构目标检测头文件</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"cpu_features_macros.h"</span></span></li><li><span class="hljs-comment">// 在ARM架构上，这个宏在上面头文件中根据目标自动定义</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined (CPU_FEATURES_ARCH_ARM)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"cpuinfo_arm.h"</span> <span class="hljs-comment">// 包含ARM架构的cpuinfo头文件</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined (CPU_FEATURES_ARCH_AARCH64)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"cpuinfo_aarch64.h"</span> <span class="hljs-comment">// 包含ARM64架构的cpuinfo头文件</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li><span class="hljs-comment">// C++代码, 需要添加`using namespace cpu_features;`</span></li><li><span class="hljs-comment">// 根据不同架构，获取相应的CPU特性信息；</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined (CPU_FEATURES_ARCH_ARM)</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> ArmFeatures features = <span class="hljs-built_in">GetArmInfo</span>().features;</li><li><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined (CPU_FEATURES_ARCH_AARCH64)</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> Aarch64Features features = <span class="hljs-built_in">GetAarch64Info</span>().features;</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{</li><li>  <span class="hljs-comment">// 根据features的字段进行支持CPU features的特性判断</span></li><li>  <span class="hljs-keyword">if</span> (features.aes) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>  <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">  <p>cpu_features库实际上是通过/proc/cpuinfo，与getauxval接口从内核中读取对应的CPU特性信息，有可能由于应用沙盒的原因导致无法读取对应的信息，注意错误处理。</p>  </div></div></div>  </li></ol> </div> </div> <div></div></div>