<h1 _ngcontent-jol-c119="" class="doc-title ng-star-inserted" title="CreateVecIndex"> CreateVecIndex </h1>

<div _ngcontent-jol-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section0351044135014">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section0351044135014" tips="复制节点链接"></i></h2><p>以firstValue为起始值创建向量索引。</p> </div> <div class="tiledSection"><h2 id="section136104495014">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section136104495014" tips="复制节点链接"></i></h2><div class="p">tensor前n个数据计算：<div _ngcontent-jol-c106="" class="highlight-div"><div _ngcontent-jol-c106="" class="highlight-div-header"><div _ngcontent-jol-c106="" class="highlight-div-header-left"><div _ngcontent-jol-c106="" class="handle-button expand-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jol-c106="" class="highlight-div-header-right"><div _ngcontent-jol-c106="" class="handle-button ai-button"></div><div _ngcontent-jol-c106="" class="handle-button line-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jol-c106="" class="handle-button theme-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jol-c106="" class="handle-button copy-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jol-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CreateVecIndex</span><span class="hljs-params">(LocalTensor&lt;T&gt; dstLocal, <span class="hljs-type">const</span> T &amp;firstValue, <span class="hljs-type">uint32_t</span> calCount)</span></span></li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h2 id="section1237164417501">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section1237164417501" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.1" valign="top" width="16.16%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.2" valign="top" width="14.14%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.3" valign="top" width="69.69999999999999%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.16%"><p>dstLocal</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> <p>Kirin9020系列处理器，支持的数据类型为：int8/int16/int32/float16/float</p> <p>KirinX90系列处理器，支持的数据类型为：int8/int16/int32/float16/float</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>firstValue</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>索引的第一个数值，数据类型需与dstLocal中元素的数据类型保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>calCount</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>输入数据元素个数。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section15810447506">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section15810447506" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> <div class="tiledSection"><h2 id="section1558104413503">注意事项<i class="anchor-icon anchor-icon-link" anchorid="section1558104413503" tips="复制节点链接"></i></h2><ul><li>操作数地址偏移对齐要求请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-general-constraints">通用约束</a>。</li><li>firstValue需保证不超出dstLocal中元素数据类型对应的大小范围。</li></ul> </div> <div class="tiledSection"><h2 id="section75913440504">返回值<i class="anchor-icon anchor-icon-link" anchorid="section75913440504" tips="复制节点链接"></i></h2><p>无</p> </div> <div class="tiledSection"><h2 id="section185914475020">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section185914475020" tips="复制节点链接"></i></h2><p>本样例中只展示Compute流程中的部分代码。如果开发者需要运行样例代码，请将该代码段拷贝并替换<a href="/consumer/cn/doc/harmonyos-guides/cannkit-data-createvecindex#section76120447501">样例模板</a>中Compute函数相关代码片段即可。</p> <div class="p">tensor前n个数据计算样例：<div _ngcontent-jol-c106="" class="highlight-div"><div _ngcontent-jol-c106="" class="highlight-div-header"><div _ngcontent-jol-c106="" class="highlight-div-header-left"><div _ngcontent-jol-c106="" class="handle-button expand-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jol-c106="" class="highlight-div-header-right"><div _ngcontent-jol-c106="" class="handle-button ai-button"></div><div _ngcontent-jol-c106="" class="handle-button line-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jol-c106="" class="handle-button theme-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jol-c106="" class="handle-button copy-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jol-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>AscendC::<span class="hljs-built_in">CreateVecIndex</span>(dstLocal, (T)<span class="hljs-number">0</span>, <span class="hljs-number">128</span>);</li></ol></pre></div></div> </div> <p>结果示例如下。</p> <div _ngcontent-jol-c106="" class="highlight-div"><div _ngcontent-jol-c106="" class="highlight-div-header"><div _ngcontent-jol-c106="" class="highlight-div-header-left"><div _ngcontent-jol-c106="" class="handle-button expand-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jol-c106="" class="highlight-div-header-right"><div _ngcontent-jol-c106="" class="handle-button ai-button"></div><div _ngcontent-jol-c106="" class="handle-button line-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jol-c106="" class="handle-button theme-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jol-c106="" class="handle-button copy-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jol-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>输入数据（firstValue）：0  </li><li>输出数据（dstLocal）：[0 1 2 ... 127]</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section76120447501">样例模板<i class="anchor-icon anchor-icon-link" anchorid="section76120447501" tips="复制节点链接"></i></h2><div _ngcontent-jol-c106="" class="highlight-div"><div _ngcontent-jol-c106="" class="highlight-div-header"><div _ngcontent-jol-c106="" class="highlight-div-header-left"><div _ngcontent-jol-c106="" class="handle-button expand-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jol-c106="" class="highlight-div-header-right"><div _ngcontent-jol-c106="" class="handle-button ai-button"></div><div _ngcontent-jol-c106="" class="handle-button line-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jol-c106="" class="handle-button theme-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jol-c106="" class="handle-button copy-button"><div _ngcontent-jol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jol-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateVecIndexTest</span> { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">CreateVecIndexTest</span><span class="hljs-params">()</span> </span>{} </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR dstGm, <span class="hljs-type">uint64_t</span> mask, <span class="hljs-type">uint8_t</span> repeatTimes, </span></span></li><li><span class="hljs-function">        <span class="hljs-type">uint16_t</span> dstBlkStride, <span class="hljs-type">uint8_t</span> dstRepStride)</span> </li><li><span class="hljs-function">    </span>{ </li><li>        m_mask = mask; </li><li>        m_repeatTimes = repeatTimes; </li><li>        m_dstBlkStride = dstBlkStride; </li><li>        m_dstRepStride = dstRepStride; </li><li>        m_elementCount = m_dstBlkStride * m_dstRepStride * <span class="hljs-number">32</span> * m_repeatTimes / <span class="hljs-built_in">sizeof</span>(T); </li><li>        m_dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ T*)dstGm); </li><li>        m_pipe.<span class="hljs-built_in">InitBuffer</span>(m_queOut, <span class="hljs-number">1</span>, m_dstBlkStride * m_dstRepStride * <span class="hljs-number">32</span> * m_repeatTimes); </li><li>        m_pipe.<span class="hljs-built_in">InitBuffer</span>(m_queTmp, <span class="hljs-number">1</span>, <span class="hljs-number">1024</span>); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// Do not need CopyIn</span></li><li>        <span class="hljs-built_in">Compute</span>(); </li><li>        <span class="hljs-built_in">CopyOut</span>(); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>
</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;T&gt; dstLocal = m_queOut.<span class="hljs-built_in">AllocTensor</span>&lt;T&gt;(); </li><li>        AscendC::LocalTensor&lt;<span class="hljs-type">uint8_t</span>&gt; tmpLocal = m_queTmp.<span class="hljs-built_in">AllocTensor</span>&lt;<span class="hljs-type">uint8_t</span>&gt;(); </li><li>        AscendC::<span class="hljs-built_in">Duplicate</span>(dstLocal, (T)<span class="hljs-number">0</span>, m_elementCount); </li><li>        AscendC::<span class="hljs-built_in">PipeBarrier</span>&lt;PIPE_ALL&gt;(); </li><li>        AscendC::<span class="hljs-built_in">CreateVecIndex</span>(dstLocal, (T)<span class="hljs-number">0</span>, m_repeatTimes * <span class="hljs-number">256</span> / <span class="hljs-built_in">sizeof</span>(T)); </li><li>        m_queOut.<span class="hljs-built_in">EnQue</span>(dstLocal); </li><li>        m_queTmp.<span class="hljs-built_in">FreeTensor</span>(tmpLocal); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;T&gt; dstLocal = m_queOut.<span class="hljs-built_in">DeQue</span>&lt;T&gt;(); </li><li> </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(m_dstGlobal, dstLocal, m_elementCount); </li><li>        m_queOut.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    AscendC::TPipe m_pipe; </li><li>    <span class="hljs-type">uint32_t</span> m_elementCount; </li><li>    <span class="hljs-type">uint32_t</span> m_mask; </li><li>    <span class="hljs-type">uint32_t</span> m_repeatTimes; </li><li>    <span class="hljs-type">uint32_t</span> m_dstBlkStride; </li><li>    <span class="hljs-type">uint32_t</span> m_dstRepStride; </li><li>    AscendC::GlobalTensor&lt;T&gt; m_dstGlobal; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; m_queOut; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; m_queTmp; </li><li>}; <span class="hljs-comment">// class CreateVecIndexTest </span></li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">testCreateVecIndex</span><span class="hljs-params">(GM_ADDR dstGm, <span class="hljs-type">uint64_t</span> mask, <span class="hljs-type">uint8_t</span> repeatTimes, </span></span></li><li><span class="hljs-function">        <span class="hljs-type">uint16_t</span> dstBlkStride, <span class="hljs-type">uint8_t</span> dstRepStride)</span> </li><li><span class="hljs-function"></span>{ </li><li>    CreateVecIndexTest&lt;T&gt; op; </li><li>    op.<span class="hljs-built_in">Init</span>(dstGm, mask, repeatTimes, dstBlkStride, dstRepStride); </li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>