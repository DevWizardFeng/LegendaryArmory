<h1 _ngcontent-gby-c119="" class="doc-title ng-star-inserted" title="E类加密数据库的使用 (ArkTS)"> E类加密数据库的使用 (ArkTS) </h1>

<div _ngcontent-gby-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>从安全角度考虑，为满足部分敏感数据的安全特性，提供了E类加密数据库的方案以提高锁屏下数据的安全性。存有敏感信息的应用在申请ohos.permission.PROTECT_SCREEN_LOCK_DATA权限后会在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-contextconstant#areamode" target="_blank">EL5</a>路径下创建一个E类数据库。在锁屏的情况下（未调用Access接口获取保留文件密钥）会触发文件密钥的销毁，此时E类数据库不可读写。当锁屏解锁后，密钥会恢复，E类数据库恢复正常读写操作。这样的设计可以有效防止用户数据的泄露。</p>     <p>在锁屏的情况下，应用程序仍然可以继续写入数据。由于此时E类数据库不可读写，这可能会导致数据丢失。为了解决这个问题，当前提供了一种方案：在锁屏的情况下，将数据存储在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-contextconstant#areamode" target="_blank">EL2</a>路径下的C类数据库中。当解锁后，再将数据迁移到E类数据库中。这样可以确保数据在锁屏期间的安全性和完整性。</p>     <p>键值型数据库和关系型数据库均支持E类加密数据库。</p>    </div>    <div class="tiledSection">     <h2 id="实现机制">实现机制<i class="anchor-icon anchor-icon-link" anchorid="实现机制" tips="复制节点链接"></i></h2>          <p>通过封装Mover类、Store类、SecretKeyObserver类和ECStoreManager类实现应用数据库密钥加锁和解锁状态下E类数据库和C类数据库的切换和操作。</p>     <p>Mover类：提供数据库数据迁移接口，在锁屏解锁后，若C类数据库中有数据，使用该接口将数据迁移到E类数据库。</p>     <p>Store类：提供了获取数据库，在数据库中插入数据、删除数据、更新数据和获取当前数据数量的接口。</p>     <p>SecretKeyObserver类：提供了获取当前密钥状态的接口，在密钥销毁后，关闭E类数据库。</p>     <p>ECStoreManager类：用于管理应用的E类数据库和C类数据库。</p>    </div>    <div class="tiledSection">     <h2 id="配置权限">配置权限<i class="anchor-icon anchor-icon-link" anchorid="配置权限" tips="复制节点链接"></i></h2>          <p>使用EL5路径下的数据库，需要配置ohos.permission.PROTECT_SCREEN_LOCK_DATA权限。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.json5</span></li><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.PROTECT_SCREEN_LOCK_DATA"</span></li><li>      }</li><li>    ]</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="键值型数据库e类加密">键值型数据库E类加密<i class="anchor-icon anchor-icon-link" anchorid="键值型数据库e类加密" tips="复制节点链接"></i></h2>          <p>本章节提供键值型数据库的E类加密数据库使用方式，提供<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#mover">Mover</a>类、<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#store">Store</a>类、<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#secretkeyobserver">SecretKeyObserver</a>类和<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#ecstoremanager">ECStoreManager</a>类的具体实现，并在<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#entryability">EntryAbility</a>和<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#index按键事件">index按键事件</a>中展示这几个类的使用方式。</p>    </div>    <div class="tiledSection">     <h3 id="mover" class="firsth2">Mover<i class="anchor-icon anchor-icon-link" anchorid="mover" tips="复制节点链接"></i></h3>          <p>提供数据库数据迁移接口，在锁屏解锁后，若C类数据库中存在数据，使用该接口将数据迁移到E类数据库。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Mover.ts</span></li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mover</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">move</span>(<span class="hljs-attr">eStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>, <span class="hljs-attr">cStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (eStore != <span class="hljs-literal">null</span> &amp;&amp; cStore != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">entries</span>: distributedKVStore.<span class="hljs-property">Entry</span>[] = <span class="hljs-keyword">await</span> cStore.<span class="hljs-title function_">getEntries</span>(<span class="hljs-string">'key_test_string'</span>);</li><li>      <span class="hljs-keyword">await</span> eStore.<span class="hljs-title function_">putBatch</span>(entries);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry move success`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="store">Store<i class="anchor-icon anchor-icon-link" anchorid="store" tips="复制节点链接"></i></h3>          <p>提供了获取数据库，在数据库中插入数据、删除数据、更新数据和获取当前数据数量的接口。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Store.ts</span></li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">kvManager</span>: distributedKVStore.<span class="hljs-property">KVManager</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreInfo</span> {</li><li>  <span class="hljs-attr">kvManagerConfig</span>: distributedKVStore.<span class="hljs-property">KVManagerConfig</span>;</li><li>  <span class="hljs-attr">storeId</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">option</span>: distributedKVStore.<span class="hljs-property">Options</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getECStore</span>(<span class="hljs-attr">storeInfo</span>: <span class="hljs-title class_">StoreInfo</span>): <span class="hljs-title class_">Promise</span>&lt;distributedKVStore.<span class="hljs-property">SingleKVStore</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      kvManager = distributedKVStore.<span class="hljs-title function_">createKVManager</span>(storeInfo.<span class="hljs-property">kvManagerConfig</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in creating KVManager"</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create KVManager.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (kvManager !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> | <span class="hljs-literal">null</span>;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        kvStore = <span class="hljs-keyword">await</span> kvManager.<span class="hljs-property">getKVStore</span>&lt;distributedKVStore.<span class="hljs-property">SingleKVStore</span>&gt;(storeInfo.<span class="hljs-property">storeId</span>, storeInfo.<span class="hljs-property">option</span>);</li><li>        <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry succeeded in getting store : <span class="hljs-subst">${storeInfo.storeId}</span>`</span>);</li><li>          <span class="hljs-keyword">return</span> kvStore;</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">putOnedata</span>(<span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEY_TEST_STRING_ELEMENT</span> = <span class="hljs-string">'key_test_string'</span> + <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VALUE_TEST_STRING_ELEMENT</span> = <span class="hljs-string">'value_test_string'</span> + <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());</li><li>      <span class="hljs-keyword">try</span> {</li><li>        kvStore.<span class="hljs-title function_">put</span>(<span class="hljs-variable constant_">KEY_TEST_STRING_ELEMENT</span>, <span class="hljs-variable constant_">VALUE_TEST_STRING_ELEMENT</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to put data. Code:<span class="hljs-subst">${err.code}</span>,message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry Succeeded in putting data.<span class="hljs-subst">${KEY_TEST_STRING_ELEMENT}</span>`</span>);</li><li>        });</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getDataNum</span>(<span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">resultSet</span>: distributedKVStore.<span class="hljs-property">KVStoreResultSet</span>;</li><li>      kvStore.<span class="hljs-title function_">getResultSet</span>(<span class="hljs-string">"key_test_string"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: distributedKVStore.KVStoreResultSet</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry Succeeded in getting result set num <span class="hljs-subst">${result.getCount()}</span>`</span>);</li><li>        resultSet = result;</li><li>        <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">null</span>) {</li><li>          kvStore.<span class="hljs-title function_">closeResultSet</span>(resultSet).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in closing result set'</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to close resultset.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        }</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get resultset.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">deleteOnedata</span>(<span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">undefined</span>) {</li><li>      kvStore.<span class="hljs-title function_">getEntries</span>(<span class="hljs-string">'key_test_string'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, entries: distributedKVStore.Entry[]</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get Entries.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">null</span> &amp;&amp; entries.<span class="hljs-property">length</span> != <span class="hljs-number">0</span>) {</li><li>          kvStore.<span class="hljs-title function_">delete</span>(entries[<span class="hljs-number">0</span>].<span class="hljs-property">key</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (err != <span class="hljs-literal">undefined</span>) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ECDB_Encry Succeeded in deleting'</span>);</li><li>          });</li><li>        }</li><li>      });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateOnedata</span>(<span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">undefined</span>) {</li><li>      kvStore.<span class="hljs-title function_">getEntries</span>(<span class="hljs-string">'key_test_string'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">entries</span>: distributedKVStore.<span class="hljs-property">Entry</span>[]) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (err != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get Entries.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (kvStore != <span class="hljs-literal">null</span> &amp;&amp; entries.<span class="hljs-property">length</span> != <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry old data:<span class="hljs-subst">${entries[<span class="hljs-number">0</span>].key}</span>,value :<span class="hljs-subst">${entries[<span class="hljs-number">0</span>].value.value.toString()}</span>`</span>)</li><li>          <span class="hljs-keyword">await</span> kvStore.<span class="hljs-title function_">put</span>(entries[<span class="hljs-number">0</span>].<span class="hljs-property">key</span>, <span class="hljs-string">"new value_test_string"</span> + <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) + <span class="hljs-string">'new'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to put.code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry update success`</span>)</li><li>      });</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="secretkeyobserver">SecretKeyObserver<i class="anchor-icon anchor-icon-link" anchorid="secretkeyobserver" tips="复制节点链接"></i></h3>          <p>该类提供了获取当前密钥状态的接口，在密钥销毁后，关闭E类数据库。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SecretKeyObserver.ts</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECStoreManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ECStoreManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SecretStatus</span> {</li><li>  <span class="hljs-title class_">Lock</span>,</li><li>  <span class="hljs-title class_">UnLock</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecretKeyObserver</span> {</li><li>  <span class="hljs-title function_">onLock</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">Lock</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeManager</span>.<span class="hljs-title function_">closeEStore</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onUnLock</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getCurrentStatus</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initialize</span>(<span class="hljs-attr">storeManager</span>: <span class="hljs-title class_">ECStoreManager</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeManager</span> = storeManager;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateLockStatus</span>(<span class="hljs-params">code: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (code === <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">Lock</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onLock</span>();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = code;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 初始获取锁屏状态</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lockStatus</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">storeManager</span>: <span class="hljs-title class_">ECStoreManager</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> lockObserve = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeyObserver</span>();</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="ecstoremanager">ECStoreManager<i class="anchor-icon anchor-icon-link" anchorid="ecstoremanager" tips="复制节点链接"></i></h3>          <p>ECStoreManager类用于管理应用的E类数据库和C类数据库。支持配置数据库信息、配置迁移函数的信息，可根据密钥状态为应用提供相应的数据库句柄，并提供了关闭E类数据库、数据迁移完成后销毁C类数据库等接口。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ECStoreManager.ts</span></li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Mover</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Mover'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StoreInfo</span>, <span class="hljs-title class_">Store</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Store'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecretStatus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SecretKeyObserver'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Store</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ECStoreManager</span> {</li><li>  <span class="hljs-title function_">config</span>(<span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span>, <span class="hljs-attr">other</span>: <span class="hljs-title class_">StoreInfo</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span> = cInfo;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span> = other;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">configDataMover</span>(<span class="hljs-attr">mover</span>: <span class="hljs-title class_">Mover</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mover</span> = mover;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getCurrentStore</span>(<span class="hljs-attr">screenStatus</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;distributedKVStore.<span class="hljs-property">SingleKVStore</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry GetCurrentStore start screenStatus: <span class="hljs-subst">${screenStatus}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (screenStatus == <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">getECStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to GetECStore.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-comment">// 解锁状态 获取e类库</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> != <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mover</span>.<span class="hljs-title function_">move</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span>);</li><li>        }</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteCStore</span>();</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry Data migration is complete. Destroy cstore`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span> = <span class="hljs-literal">false</span>;</li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 加锁状态 获取c类库</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span> = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">getECStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to GetECStore.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">closeEStore</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> kvManager = distributedKVStore.<span class="hljs-title function_">createKVManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span>.<span class="hljs-property">kvManagerConfig</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in creating KVManager"</span>);</li><li>      <span class="hljs-keyword">if</span> (kvManager != <span class="hljs-literal">undefined</span>) {</li><li>        kvManager.<span class="hljs-title function_">closeKVStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span>.<span class="hljs-property">kvManagerConfig</span>.<span class="hljs-property">bundleName</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span>.<span class="hljs-property">storeId</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> = <span class="hljs-literal">null</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry close EStore success`</span>)</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create KVManager.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">deleteCStore</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> kvManager = distributedKVStore.<span class="hljs-title function_">createKVManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>.<span class="hljs-property">kvManagerConfig</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in creating KVManager"</span>);</li><li>      <span class="hljs-keyword">if</span> (kvManager != <span class="hljs-literal">undefined</span>) {</li><li>        kvManager.<span class="hljs-title function_">deleteKVStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>.<span class="hljs-property">kvManagerConfig</span>.<span class="hljs-property">bundleName</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>.<span class="hljs-property">storeId</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span> = <span class="hljs-literal">null</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ECDB_Encry delete cStore success"</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create KVManager.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">eStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">eInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">needMove</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mover</span>: <span class="hljs-title class_">Mover</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="entryability">EntryAbility<i class="anchor-icon anchor-icon-link" anchorid="entryability" tips="复制节点链接"></i></h3>          <p>模拟应用启动期间，注册对COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED公共事件的监听，并配置相应的数据库信息、密钥状态信息等。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, application, contextConstant, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECStoreManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ECStoreManager'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StoreInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Store'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Mover</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Mover'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecretKeyObserver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SecretKeyObserver'</span>;</li><li><span class="hljs-keyword">import</span> { commonEventManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> storeManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECStoreManager</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> e_secretKeyObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeyObserver</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> mover = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mover</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">subscriber</span>: commonEventManager.<span class="hljs-property">CommonEventSubscriber</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCB</span>(<span class="hljs-params">err: BusinessError, commonEventSubscriber: commonEventManager.CommonEventSubscriber</span>) {</li><li>  <span class="hljs-keyword">if</span> (!err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ECDB_Encry createSubscriber'</span>);</li><li>    subscriber = commonEventSubscriber;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      commonEventManager.<span class="hljs-title function_">subscribe</span>(subscriber, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, data: commonEventManager.CommonEventData</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry SubscribeCB <span class="hljs-subst">${data.code}</span>`</span>);</li><li>          e_secretKeyObserver.<span class="hljs-title function_">updateLockStatus</span>(data.<span class="hljs-property">code</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createSubscriber failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">eInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> cContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    cInfo = {</li><li>      <span class="hljs-string">"kvManagerConfig"</span>: {</li><li>        <span class="hljs-attr">context</span>: cContext,</li><li>        <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.ecstoredemo'</span>,</li><li>      },</li><li>      <span class="hljs-string">"storeId"</span>: <span class="hljs-string">"cstore"</span>,</li><li>      <span class="hljs-string">"option"</span>: {</li><li>        <span class="hljs-attr">createIfMissing</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-attr">backup</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-attr">autoSync</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-comment">// kvStoreType不填时，默认创建多设备协同数据库</span></li><li>        <span class="hljs-attr">kvStoreType</span>: distributedKVStore.<span class="hljs-property">KVStoreType</span>.<span class="hljs-property">SINGLE_VERSION</span>,</li><li>        <span class="hljs-comment">// 多设备协同数据库：kvStoreType: distributedKVStore.KVStoreType.DEVICE_COLLABORATION</span></li><li>        <span class="hljs-attr">securityLevel</span>: distributedKVStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span></li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">let</span> eContext = <span class="hljs-keyword">await</span> application.<span class="hljs-title function_">createModuleContext</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>,<span class="hljs-string">"entry"</span>);</li><li>    eContext.<span class="hljs-property">area</span> = contextConstant.<span class="hljs-property">AreaMode</span>.<span class="hljs-property">EL5</span>;</li><li>    eInfo = {</li><li>      <span class="hljs-string">"kvManagerConfig"</span>: {</li><li>        <span class="hljs-attr">context</span>: eContext,</li><li>        <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.ecstoredemo'</span>,</li><li>      },</li><li>      <span class="hljs-string">"storeId"</span>: <span class="hljs-string">"estore"</span>,</li><li>      <span class="hljs-string">"option"</span>: {</li><li>        <span class="hljs-attr">createIfMissing</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-attr">backup</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-attr">autoSync</span>: <span class="hljs-literal">false</span>,</li><li>        <span class="hljs-comment">// kvStoreType不填时，默认创建多设备协同数据库</span></li><li>        <span class="hljs-attr">kvStoreType</span>: distributedKVStore.<span class="hljs-property">KVStoreType</span>.<span class="hljs-property">SINGLE_VERSION</span>,</li><li>        <span class="hljs-comment">// 多设备协同数据库：kvStoreType: distributedKVStore.KVStoreType.DEVICE_COLLABORATION</span></li><li>        <span class="hljs-attr">securityLevel</span>: distributedKVStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span></li><li>      }</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry store area : estore:<span class="hljs-subst">${eContext.area}</span>,cstore<span class="hljs-subst">${cContext.area}</span>`</span>);</li><li>    <span class="hljs-comment">// 监听COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED事件 code == 1解锁状态，code==0加锁状态</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      commonEventManager.<span class="hljs-title function_">createSubscriber</span>({</li><li>        <span class="hljs-attr">events</span>: [<span class="hljs-string">'COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED'</span>]</li><li>      }, createCB);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry success subscribe`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createSubscriber failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    storeManager.<span class="hljs-title function_">config</span>(cInfo, eInfo);</li><li>    storeManager.<span class="hljs-title function_">configDataMover</span>(mover);</li><li>    e_secretKeyObserver.<span class="hljs-title function_">initialize</span>(storeManager);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="index按键事件">Index按键事件<i class="anchor-icon anchor-icon-link" anchorid="index按键事件" tips="复制节点链接"></i></h3>          <p>使用Button按钮，通过点击按钮来模拟应用操作数据库，如插入数据、删除数据、更新数据和获取数据数量的操作等，展示数据库基本的增删改查能力。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { storeManager, e_secretKeyObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">"../entryability/EntryAbility"</span>;</li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Store</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../entryability/Store'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> storeOption = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Store</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">lockStatus</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'加锁/解锁'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (lockStatus) {</li><li>            e_secretKeyObserver.<span class="hljs-title function_">onLock</span>();</li><li>            lockStatus = <span class="hljs-number">0</span>;</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            e_secretKeyObserver.<span class="hljs-title function_">onUnLock</span>();</li><li>            lockStatus = <span class="hljs-number">1</span>;</li><li>          }</li><li>          lockStatus ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"解锁"</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"加锁"</span>;</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-string">"5"</span>);</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'store type'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>() ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"estore"</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"cstore"</span>;</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-string">"5"</span>);</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"put"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">putOnedata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Get"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">getDataNum</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"delete"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">deleteOnedata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"update"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">updateOnedata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="关系型数据库e类加密">关系型数据库E类加密<i class="anchor-icon anchor-icon-link" anchorid="关系型数据库e类加密" tips="复制节点链接"></i></h2>          <p>本章节提供关系型数据库的E类加密数据库使用方式，提供<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#mover-1">Mover</a>类，<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#store-1">Store</a>类，<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#secretkeyobserver-1">SecretKeyObserver</a>类和<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#ecstoremanager-1">ECStoreManager</a>类的具体实现，并在<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#entryability-1">EntryAbility</a>和<a href="/consumer/cn/doc/harmonyos-guides/encrypted_estore_guidelines#index按键事件-1">index按键事件</a>中展示这几个类的使用方式。</p>    </div>    <div class="tiledSection">     <h3 id="mover-1" class="firsth2">Mover<i class="anchor-icon anchor-icon-link" anchorid="mover-1" tips="复制节点链接"></i></h3>          <p>提供数据库数据迁移接口，在锁屏解锁后，若C类数据库中有数据，使用该接口将数据迁移到E类数据库。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Mover.ts</span></li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mover</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">eStore: relationalStore.RdbStore, cStore: relationalStore.RdbStore</span>) {</li><li>    <span class="hljs-keyword">if</span> (eStore != <span class="hljs-literal">null</span> &amp;&amp; cStore != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">let</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'employee'</span>);</li><li>      <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> cStore.<span class="hljs-title function_">query</span>(predicates);</li><li>      <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>()) {</li><li>        <span class="hljs-keyword">let</span> bucket = resultSet.<span class="hljs-title function_">getRow</span>();</li><li>        <span class="hljs-keyword">await</span> eStore.<span class="hljs-title function_">insert</span>(<span class="hljs-string">'employee'</span>, bucket);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="store-1">Store<i class="anchor-icon anchor-icon-link" anchorid="store-1" tips="复制节点链接"></i></h3>          <p>提供了获取数据库，在数据库中插入数据、删除数据、更新数据和获取当前数据数量的接口。其中StoreInfo类用于存储获取数据库相关信息。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Store.ts</span></li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreInfo</span> {</li><li>  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>;</li><li>  <span class="hljs-attr">config</span>: relationalStore.<span class="hljs-property">StoreConfig</span>;</li><li>  <span class="hljs-attr">storeId</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> id = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SQL_CREATE_TABLE</span> = <span class="hljs-string">'CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB)'</span>;</li><li>
</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getECStore</span>(<span class="hljs-attr">storeInfo</span>: <span class="hljs-title class_">StoreInfo</span>): <span class="hljs-title class_">Promise</span>&lt;relationalStore.<span class="hljs-property">RdbStore</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">rdbStore</span>: relationalStore.<span class="hljs-property">RdbStore</span> | <span class="hljs-literal">null</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      rdbStore = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(storeInfo.<span class="hljs-property">context</span>, storeInfo.<span class="hljs-property">config</span>);</li><li>      <span class="hljs-keyword">if</span> (rdbStore.<span class="hljs-property">version</span> == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">await</span> rdbStore.<span class="hljs-title function_">executeSql</span>(<span class="hljs-variable constant_">SQL_CREATE_TABLE</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry succeeded in getting Store ：<span class="hljs-subst">${storeInfo.storeId}</span>`</span>);</li><li>        rdbStore.<span class="hljs-property">version</span> = <span class="hljs-number">1</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> rdbStore;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">putOnedata</span>(<span class="hljs-params">rdbStore: relationalStore.RdbStore</span>) {</li><li>    <span class="hljs-keyword">if</span> (rdbStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">valueBucket</span>: relationalStore.<span class="hljs-property">ValuesBucket</span> = {</li><li>        <span class="hljs-attr">ID</span>: id++,</li><li>        <span class="hljs-attr">NAME</span>: <span class="hljs-string">'Lisa'</span>,</li><li>        <span class="hljs-attr">AGE</span>: <span class="hljs-number">18</span>,</li><li>        <span class="hljs-attr">SALARY</span>: <span class="hljs-number">100.5</span>,</li><li>        <span class="hljs-attr">CODES</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]),</li><li>      };</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">await</span> rdbStore.<span class="hljs-title function_">insert</span>(<span class="hljs-string">"EMPLOYEE"</span>, valueBucket);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry insert success`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getDataNum</span>(<span class="hljs-params">rdbStore: relationalStore.RdbStore</span>) {</li><li>    <span class="hljs-keyword">if</span> (rdbStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>        <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> rdbStore.<span class="hljs-title function_">query</span>(predicates);</li><li>        <span class="hljs-keyword">let</span> count = resultSet.<span class="hljs-property">rowCount</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry getdatanum success count : <span class="hljs-subst">${count}</span>`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">deleteAlldata</span>(<span class="hljs-params">rdbStore: relationalStore.RdbStore</span>) {</li><li>    <span class="hljs-keyword">if</span> (rdbStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>        predicates.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'AGE'</span>, <span class="hljs-number">18</span>);</li><li>        <span class="hljs-keyword">await</span> rdbStore.<span class="hljs-title function_">delete</span>(predicates);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry delete Success`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateOnedata</span>(<span class="hljs-params">rdbStore: relationalStore.RdbStore</span>) {</li><li>    <span class="hljs-keyword">if</span> (rdbStore != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>        predicates.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'NAME'</span>, <span class="hljs-string">'Lisa'</span>);</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">valueBucket</span>: relationalStore.<span class="hljs-property">ValuesBucket</span> = {</li><li>          <span class="hljs-attr">NAME</span>: <span class="hljs-string">'Anna'</span>,</li><li>          <span class="hljs-attr">SALARY</span>: <span class="hljs-number">100.5</span>,</li><li>          <span class="hljs-attr">CODES</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]),</li><li>        };</li><li>        <span class="hljs-keyword">await</span> rdbStore.<span class="hljs-title function_">update</span>(valueBucket, predicates);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry update success`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="secretkeyobserver-1">SecretKeyObserver<i class="anchor-icon anchor-icon-link" anchorid="secretkeyobserver-1" tips="复制节点链接"></i></h3>          <p>该类提供了获取当前密钥状态的接口，在密钥销毁后，关闭E类数据库。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SecretKeyObserver.ts</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECStoreManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ECStoreManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SecretStatus</span> {</li><li>  <span class="hljs-title class_">Lock</span>,</li><li>  <span class="hljs-title class_">UnLock</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecretKeyObserver</span> {</li><li>  <span class="hljs-title function_">onLock</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">Lock</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeManager</span>.<span class="hljs-title function_">closeEStore</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onUnLock</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getCurrentStatus</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initialize</span>(<span class="hljs-attr">storeManager</span>: <span class="hljs-title class_">ECStoreManager</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeManager</span> = storeManager;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateLockStatus</span>(<span class="hljs-params">code: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> === <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">Lock</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onLock</span>();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockStatus</span> = code;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lockStatus</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">storeManager</span>: <span class="hljs-title class_">ECStoreManager</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> lockObserve = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeyObserver</span>();</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="ecstoremanager-1">ECStoreManager<i class="anchor-icon anchor-icon-link" anchorid="ecstoremanager-1" tips="复制节点链接"></i></h3>          <p>ECStoreManager类用于管理应用的E类数据库和C类数据库。支持配置数据库信息、配置迁移函数的信息，可根据密钥状态为应用提供相应的数据库句柄，并提供了关闭E类数据库、数据迁移完成后销毁C类数据库等接口。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ECStoreManager.ts</span></li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Mover</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Mover'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StoreInfo</span>, <span class="hljs-title class_">Store</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Store'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecretStatus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SecretKeyObserver'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Store</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ECStoreManager</span> {</li><li>  <span class="hljs-title function_">config</span>(<span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span>, <span class="hljs-attr">other</span>: <span class="hljs-title class_">StoreInfo</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span> = cInfo;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span> = other;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">configDataMover</span>(<span class="hljs-attr">mover</span>: <span class="hljs-title class_">Mover</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mover</span> = mover;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getCurrentStore</span>(<span class="hljs-attr">screenStatus</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;relationalStore.<span class="hljs-property">RdbStore</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (screenStatus === <span class="hljs-title class_">SecretStatus</span>.<span class="hljs-property">UnLock</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">getECStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eInfo</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to GetECStore.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-comment">// 解锁状态 获取e类库</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> != <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mover</span>.<span class="hljs-title function_">move</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry cstore data move to estore success`</span>);</li><li>        }</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteCStore</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span> = <span class="hljs-literal">false</span>;</li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 加锁状态 获取c类库</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">needMove</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span> = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">getECStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to GetECStore.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cStore</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">closeEStore</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eStore</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">deleteCStore</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cInfo</span>.<span class="hljs-property">storeId</span>)</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create KVManager.code is <span class="hljs-subst">${error.code}</span>,message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">eStore</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cStore</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">eInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">needMove</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mover</span>: <span class="hljs-title class_">Mover</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="entryability-1">EntryAbility<i class="anchor-icon anchor-icon-link" anchorid="entryability-1" tips="复制节点链接"></i></h3>          <p>模拟在应用启动期间，注册对COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED公共事件的监听，并配置相应的数据库信息、密钥状态信息等。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, contextConstant, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, application } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECStoreManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ECStoreManager'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StoreInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Store'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Mover</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Mover'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecretKeyObserver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SecretKeyObserver'</span>;</li><li><span class="hljs-keyword">import</span> { commonEventManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> storeManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECStoreManager</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> e_secretKeyObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeyObserver</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> mover = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mover</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">subscriber</span>: commonEventManager.<span class="hljs-property">CommonEventSubscriber</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCB</span>(<span class="hljs-params">err: BusinessError, commonEventSubscriber: commonEventManager.CommonEventSubscriber</span>) {</li><li>  <span class="hljs-keyword">if</span> (!err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ECDB_Encry createSubscriber'</span>);</li><li>    subscriber = commonEventSubscriber;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      commonEventManager.<span class="hljs-title function_">subscribe</span>(subscriber, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, data: commonEventManager.CommonEventData</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry SubscribeCB <span class="hljs-subst">${data.code}</span>`</span>);</li><li>          e_secretKeyObserver.<span class="hljs-title function_">updateLockStatus</span>(data.<span class="hljs-property">code</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createSubscriber failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">cInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">eInfo</span>: <span class="hljs-title class_">StoreInfo</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> cContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    cInfo = {</li><li>      <span class="hljs-attr">context</span>: cContext,</li><li>      <span class="hljs-attr">config</span>: {</li><li>        <span class="hljs-attr">name</span>: <span class="hljs-string">'cstore.db'</span>,</li><li>        <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      },</li><li>      <span class="hljs-attr">storeId</span>: <span class="hljs-string">"cstore.db"</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> eContext = <span class="hljs-keyword">await</span> application.<span class="hljs-title function_">createModuleContext</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">"entry"</span>);</li><li>    eContext.<span class="hljs-property">area</span> = contextConstant.<span class="hljs-property">AreaMode</span>.<span class="hljs-property">EL5</span>;</li><li>    eInfo = {</li><li>      <span class="hljs-attr">context</span>: eContext,</li><li>      <span class="hljs-attr">config</span>: {</li><li>        <span class="hljs-attr">name</span>: <span class="hljs-string">'estore.db'</span>,</li><li>        <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      },</li><li>      <span class="hljs-attr">storeId</span>: <span class="hljs-string">"estore.db"</span>,</li><li>    };</li><li>    <span class="hljs-comment">// 监听COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED事件 code == 1解锁状态，code==0加锁状态</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry store area : estore:<span class="hljs-subst">${eContext.area}</span>,cstore<span class="hljs-subst">${cContext.area}</span>`</span>)</li><li>    <span class="hljs-keyword">try</span> {</li><li>      commonEventManager.<span class="hljs-title function_">createSubscriber</span>({</li><li>        <span class="hljs-attr">events</span>: [<span class="hljs-string">'COMMON_EVENT_SCREEN_LOCK_FILE_ACCESS_STATE_CHANGED'</span>]</li><li>      }, createCB);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry success subscribe`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createSubscriber failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    storeManager.<span class="hljs-title function_">config</span>(cInfo, eInfo);</li><li>    storeManager.<span class="hljs-title function_">configDataMover</span>(mover);</li><li>    e_secretKeyObserver.<span class="hljs-title function_">initialize</span>(storeManager);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="index按键事件-1">Index按键事件<i class="anchor-icon anchor-icon-link" anchorid="index按键事件-1" tips="复制节点链接"></i></h3>          <p>使用Button按钮，通过点击按钮来模拟应用操作数据库，如插入数据、删除数据、更新数据和获取数据数量的操作等，展示数据库基本的增删改查能力。</p>     <div _ngcontent-gby-c106="" class="highlight-div"><div _ngcontent-gby-c106="" class="highlight-div-header"><div _ngcontent-gby-c106="" class="highlight-div-header-left"><div _ngcontent-gby-c106="" class="handle-button expand-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gby-c106="" class="highlight-div-header-right"><div _ngcontent-gby-c106="" class="handle-button ai-button"></div><div _ngcontent-gby-c106="" class="handle-button line-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gby-c106="" class="handle-button theme-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gby-c106="" class="handle-button copy-button"><div _ngcontent-gby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gby-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { storeManager, e_secretKeyObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">"../entryability/EntryAbility"</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Store</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../entryability/Store'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> storeOption = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Store</span>();</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">lockStatus</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'加锁/解锁'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (lockStatus) {</li><li>            e_secretKeyObserver.<span class="hljs-title function_">onLock</span>();</li><li>            lockStatus = <span class="hljs-number">0</span>;</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            e_secretKeyObserver.<span class="hljs-title function_">onUnLock</span>();</li><li>            lockStatus = <span class="hljs-number">1</span>;</li><li>          }</li><li>          lockStatus ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"解锁"</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"加锁"</span>;</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-string">"5"</span>);</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'store type'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>() ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"estore"</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"cstore"</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ECDB_Encry current store : <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message}</span>`</span>);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-string">"5"</span>);</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"put"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">putOnedata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Get"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">getDataNum</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"delete"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">deleteAlldata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"update"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> storeManager.<span class="hljs-title function_">getCurrentStore</span>(e_secretKeyObserver.<span class="hljs-title function_">getCurrentStatus</span>());</li><li>          storeOption.<span class="hljs-title function_">updateOnedata</span>(store);</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>