<h1 _ngcontent-ngq-c119="" class="doc-title ng-star-inserted" title="FIDO免密身份认证"> FIDO免密身份认证 </h1>

<div _ngcontent-ngq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section2960852143012">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section2960852143012" tips="复制节点链接"></i></h2>          <ul>      <li>开通FIDO免密身份认证功能，使用用户已有的生物特征开通FIDO免密身份认证能力。</li>      <li>使用FIDO免密身份认证功能，使用用户已开通的生物特征进行FIDO免密身份认证。</li>      <li>关闭FIDO免密身份认证功能，使用用户已开通的生物特征注销FIDO免密身份认证能力。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section19938114051115">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section19938114051115" tips="复制节点链接"></i></h2>          <p>在开发FIDO免密身份认证功能前，开发者应了解以下基本概念：</p>     <ul>      <li>FIDO协议       <p>FIDO（Fast Identity Online）是一套身份认证框架协议，它由FIDO联盟推出并持续维护。FIDO规范定义了一套在线身份认证的技术架构。</p></li>      <li>UAF身份认证框架       <p>UAF（Universal Authentication Framework）意为通用身份认证框架，目的是通过生物识别（如指纹识别）和加密技术方式，为用户提供无密码的身份认证体验。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section1956803415413">相关权限<i class="anchor-icon anchor-icon-link" anchorid="section1956803415413" tips="复制节点链接"></i></h2>          <ul>      <li>获取生物识别权限：ohos.permission.ACCESS_BIOMETRIC。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section1150719113128">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section1150719113128" tips="复制节点链接"></i></h2>          <div class="p">      需满足以下条件，才能使用该功能。      <ul>       <li>移动端设备需要支持生物特征（指纹/3D人脸），查询当前移动端设备是否支持ATL4级别的认证可信等级。        <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span>  <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { userAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UserAuthenticationKit'</span>;</li><li><span class="hljs-comment">// 示例，查询设备人脸识别是否支持ATL4级别的认证可信等级</span></li><li><span class="hljs-keyword">try</span> {</li><li>    userAuth.<span class="hljs-title function_">getAvailableStatus</span>(userAuth.<span class="hljs-property">UserAuthType</span>.<span class="hljs-property">FACE</span>, userAuth.<span class="hljs-property">AuthTrustLevel</span>.<span class="hljs-property">ATL4</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'current auth trust level is supported'</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`current auth trust level is not supported. Code is <span class="hljs-subst">${err?.code}</span>, message is <span class="hljs-subst">${err?.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>       <li>FIDO服务需要联网，以便提供完整的在线身份校验服务。应用在调用本服务API前，需将FIDO服务联网行为向用户明示，并且取得用户同意。</li>      </ul>     </div>    </div>    <div class="tiledSection">     <h2 id="section12611620155710">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section12611620155710" tips="复制节点链接"></i></h2>          <p><span><img height="677.3025" originheight="6600" originwidth="5100" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115014.81683489443650041137872843148146:50001231000000:2800:AD37463B9A1E2C931AFC726030250CE3C14954B31F937A2D660E2B7A18A9C247.png" title="点击放大" width="523.6875"></span></p>    </div>    <div class="tiledSection">     <h2 id="section1891506162020">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1891506162020" tips="复制节点链接"></i></h2>          <p>业务进行FIDO免密身份认证功能的开通、使用和关闭。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <caption>        <b>表1 </b>FIDO免密身份认证接口功能介绍       </caption>       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.1" valign="top" width="60.050000000000004%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.2" valign="top" width="39.95%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section144826162913" target="_blank">discover</a>(context: common.Context): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section11682103284015" target="_blank">DiscoveryData</a>&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>发现设备的认证能力，返回当前设备软件支持的认证器数据</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section86041155123616" target="_blank">checkPolicy</a>(context: common.Context, uafRequest: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section2134351143710" target="_blank">UAFMessage</a>): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>检测用户策略的开启状态</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section7520171415134" target="_blank">processUAFOperation</a>(context: common.Context, uafRequest: UAFMessage, channelBindings?: ChannelBinding): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section2134351143710" target="_blank">UAFMessage</a>&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>用户UAF操作接口，处理UAF协议消息</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section4815641306" target="_blank">notifyUAFResult</a>(context: common.Context, uafResponse: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-fido-api#section2134351143710" target="_blank">UAFMessage</a>): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>开通结果通知接口</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section515314319217">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section515314319217" tips="复制节点链接"></i></h2>          <ol>      <li>需要业务方自行根据FIDO标准协议部署FIDO服务器。</li>      <li>导入相关模块。       <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fido } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.OnlineAuthenticationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;</li></ol></pre></div></div></li>      <li>开通FIDO免密身份认证。       <ol>        <li>初始化认证器信息。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用this.uiContext需要获取页面UIAbility的Context，一个页面获取一次即可</span></li><li><strong><span class="hljs-comment">// </span></strong><span class="hljs-comment">方法：uiContext:common.UIAbilityContext = getHostContext(this) as common.UIAbilityContext;</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用discover方法初始化认证器信息</span></li><li>  <span class="hljs-keyword">let</span> discoverData = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">discover</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call discover. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务端，获取策略检查报文，检查用户开通状态。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// uafMessage为FIDO服务端获取的策略检查报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uafAuthMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  策略检查报文格式: [{"header":{"upv":{"major":1,"minor":0},"op":"Auth","appID":"","serverData":"test server data"},"challenge":"test challenge","policy":{"accepted":[[{"aaid":["001B#1001"],"keyIDs":["test keyIDs"],"authenticationAlgorithms":[1]}]]}}]</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: uafMessage, <span class="hljs-comment">// 从服务端获取的检查策略报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">isRegistered</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 检查是否已经开启FIDO认证</span></li><li>  <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">checkPolicy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, uafAuthMessage);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  isRegistered = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call checkPolicy. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断状态，进行相应处理</span></li><li>}</li><li><span class="hljs-keyword">if</span> (isRegistered) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"has registered, no need to register again."</span>);</li><li>  <span class="hljs-comment">// 已注册，业务根据需要执行后续流程</span></li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务端，获取注册报文，调用processUAFOperation接口进行FIDO注册。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// regMessage为从FIDO服务端获取的注册报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uafRegMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li> <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  注册报文格式: [{"header":{"upv":{"major":1,"minor":0},"op":"Reg","appID":"","serverData":"test server data"},"challenge":"test challenge","username":"test user name","policy":{"accepted":[[{"aaid":["001B#1001"],"attachmentHint":1,"authenticationAlgorithms":[1],"authenticatorVersion":1}]]}}]</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: regMessage, <span class="hljs-comment">// 从服务端获取的注册报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li><li><span class="hljs-comment">// 传递通道绑定参数（可选）</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">channelBinding</span>: fido.<span class="hljs-property">ChannelBinding</span> = {};</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用processUAFOperation接口进行FIDO注册</span></li><li>  <span class="hljs-keyword">let</span> messageResp = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">processUAFOperation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, uafRegMessage, channelBinding);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call processUAFOperation. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li></ol></pre></div></div></li>        <li>发送注册响应报文至FIDO服务端进行验证并获取注册结果报文。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// notifyMessage为从FIDO服务端获取的注册结果报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">notifyMessage</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">notifyUafMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  响应报文格式: {"authenticatorsSucceeded":[{"description":"Attention completed successfully.","aaid":"001B#1001","keyID":"test keyID"}]}</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: notifyMessage, <span class="hljs-comment">// 从服务端获取的注册结果报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li></ol></pre></div></div></li>        <li>调用notifyUAFResult进行注册结果通知。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用notifyUAFResult进行注册结果通知</span></li><li>  fido.<span class="hljs-title function_">notifyUAFResult</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, notifyUafMessage).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">notify</span> =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in doing notifyUAFResult."</span>);</li><li>  })</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call notifyUAFResult. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li></ol></pre></div></div></li>       </ol></li>      <li>使用FIDO免密身份认证。       <ol>        <li>初始化认证器信息（如果已执行过初始化操作，则无需重复执行）。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取当前界面的context</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用discover方法初始化认证器信息</span></li><li>  <span class="hljs-keyword">let</span> discoverData = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">discover</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call discover. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务端，获取策略检查报文，检查用户开启状态。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// uafMessage为从FIDO服务器获取的策略检查报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uafAuthMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  策略检查报文格式: [{"header":{"upv":{"major":1,"minor":0},"op":"Auth","appID":"","serverData":"test server data"},"challenge":"test challenge","policy":{"accepted":[[{"aaid":["001B#1001"],"keyIDs":["test keyIDs"],"authenticationAlgorithms":[1]}]]}}]</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: uafMessage, <span class="hljs-comment">// 从服务端获取的检查策略报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">isRegistered</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 检查是否已经开启FIDO认证</span></li><li>  <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">checkPolicy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, uafAuthMessage);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  isRegistered = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call checkPolicy. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断状态，进行相应处理</span></li><li>}</li><li><span class="hljs-keyword">if</span> (isRegistered) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"has registered, no need to register again."</span>);</li><li>  <span class="hljs-comment">// 已注册，业务根据需要执行后续流程</span></li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务端，获取认证报文，调用processUAFOperation接口进行FIDO认证。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// regMessage为从FIDO服务器获取的认证报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uafRegMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  认证报文格式: [{"header":{"upv":{"major":1,"minor":0},"op":"Auth","appID":"","serverData":"test server data"},"challenge":"test challenge","policy":{"accepted":[[{"aaid":["001B#1001"],"keyIDs":["test keyIDs"],"authenticationAlgorithms":[1]}]]}}]</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: regMessage, <span class="hljs-comment">// 从服务端获取的认证报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li><li><span class="hljs-comment">// 传递通道绑定参数（可选）</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">channelBinding</span>: fido.<span class="hljs-property">ChannelBinding</span> = {};</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用processUAFOperation接口进行FIDO认证</span></li><li>  <span class="hljs-keyword">let</span> messageResp = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">processUAFOperation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, uafRegMessage, channelBinding);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call processUAFOperation. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li><li> <span class="hljs-comment">//发送认证响应报文至FIDO服务端进行验证并返回认证结果</span></li></ol></pre></div></div></li>       </ol></li>      <li>关闭FIDO免密身份认证。       <ol>        <li>初始化认证器信息（如果已执行过初始化操作，则无需重复执行）。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用discover方法初始化认证器信息</span></li><li>  <span class="hljs-keyword">let</span> discoverData = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">discover</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call discover. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务端，获取注销报文，调用processUAFOperation接口进行FIDO注销。         <div _ngcontent-ngq-c106="" class="highlight-div"><div _ngcontent-ngq-c106="" class="highlight-div-header"><div _ngcontent-ngq-c106="" class="highlight-div-header-left"><div _ngcontent-ngq-c106="" class="handle-button expand-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngq-c106="" class="highlight-div-header-right"><div _ngcontent-ngq-c106="" class="handle-button ai-button"></div><div _ngcontent-ngq-c106="" class="handle-button line-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngq-c106="" class="handle-button theme-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngq-c106="" class="handle-button copy-button"><div _ngcontent-ngq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// deregMessage为从FIDO服务器获取的注销报文</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uafRegMessage</span>: fido.<span class="hljs-property">UAFMessage</span> = {</li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  注销报文格式:  [{"header":{"upv":{"major":1,"minor":0},"op":"Dereg","appID":""},"authenticators":[{"aaid":"001B#1001","keyID":"test keyID"}]}]</span></li><li><span class="hljs-comment">  */</span></li><li>  <span class="hljs-attr">uafProtocolMessage</span>: deregMessage, <span class="hljs-comment">// 从服务端获取的注销报文</span></li><li>  <span class="hljs-attr">additionalData</span>: <span class="hljs-string">""</span> <span class="hljs-comment">// 附加信息（可选）</span></li><li>};</li><li><span class="hljs-comment">// 传递通道绑定参数（可选）</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">channelBinding</span>: fido.<span class="hljs-property">ChannelBinding</span> = {};</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 调用processUAFOperation接口进行FIDO注销</span></li><li>  <span class="hljs-keyword">let</span> messageResp = <span class="hljs-keyword">await</span> fido.<span class="hljs-title function_">processUAFOperation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, uafRegMessage, channelBinding);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to call processUAFOperation. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理</span></li><li>}</li><li> <span class="hljs-comment">//发送认证响应报文至FIDO服务端进行验证并返回认证结果</span></li></ol></pre></div></div></li>       </ol></li>     </ol>    </div>   </div>   <div></div></div>