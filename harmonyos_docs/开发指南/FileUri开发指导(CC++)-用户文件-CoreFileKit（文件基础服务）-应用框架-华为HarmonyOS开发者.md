<h1 _ngcontent-xbj-c119="" class="doc-title ng-star-inserted" title="FileUri开发指导(C/C++)"> FileUri开发指导(C/C++) </h1>

<div _ngcontent-xbj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>FileUri提供了关于文件URI的基本操作，将URI转换成对应的沙箱路径、将应用沙箱路径转换成对应应用自己的URI、获取URI所在目录路径的URI等接口能力，方便应用对文件分享业务中URI的访问。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p><strong>结果集</strong>：满足使用场景的路径或URI。</p>    </div>    <div class="tiledSection">     <h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>URI转路径时，URI来源建议使用系统能力获取，例如：picker、剪切板、拖拽、及系统提供的路径转URI接口等系统能力返回的URI；如果转换应用或用户拼接的URI，则转换后的路径可能无法访问。</p></li>      <li>       <p>为保证数据的准确性，在转换或判断过程中应保持单对象处理。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>接口的详细说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-file-uri-h" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">FileManagement_ErrCode OH_FileUri_GetUriFromPath(const char *path, unsigned int length, char **result)</td>         <td class="cellrowborder" valign="top" width="50%">通过传入的path生成应用自己的URI。将path转URI时，path中的中文及非数字字母的特殊字符会被编码为对应的ASCII码，并拼接在URI中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">FileManagement_ErrCode OH_FileUri_GetPathFromUri(const char *uri, unsigned int length, char **result)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>将uri转换成对应的沙箱路径。</p>          <p>1. uri转路径过程中会将uri中存在的ASCII码进行解码后拼接在原处，非系统接口生成的uri中可能存在ASCII码解析范围之外的字符，导致字符串无法正常拼接。</p>          <p>2. 转换处理遵循系统约定的字符串替换规则（规则可能随系统演进而变化），转换过程中不进行路径校验操作，无法保证转换结果的可访问性。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">FileManagement_ErrCode OH_FileUri_GetFullDirectoryUri(const char *uri, unsigned int length, char **result)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>获取所在路径uri。</p>          <p>1. uri指向文件则返回所在路径的uri。</p>          <p>2. uri指向目录则不处理直接返回原串。</p>          <p>3. uri指向的文件不存在或属性获取失败则返回空串。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">bool OH_FileUri_IsValidUri(const char *uri, unsigned int length)</td>         <td class="cellrowborder" valign="top" width="50%">判断传入的uri的格式是否正确。仅校验uri是否满足系统定义的格式规范，不校验uri的有效性。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">FileManagement_ErrCode OH_FileUri_GetFileName(const char *uri, unsigned int length, char **result)</td>         <td class="cellrowborder" valign="top" width="50%">通过传入的uri获取到对应的文件名称（如果文件名中存在ASCII码将会被解码处理后拼接在原处）。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p><strong>在CMake脚本中链接动态库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(sample PUBLIC libohfileuri.so)</li></ol></pre></div></div>     <p><strong>添加头文件</strong></p>     <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;filemanagement/file_uri/oh_file_uri.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p>调用OH_FileUri_GetUriFromPath接口，在接口中malloc的内存需要在使用完后释放，因此需要free对应的内存。示例代码如下所示：</p>       <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OH_FileUri_GetUriFromPathExample</span><span class="hljs-params">()</span> {</li><li>    <span class="hljs-type">char</span> *path = <span class="hljs-string">"/data/storage/el2/base/files/test.txt"</span>;</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = <span class="hljs-built_in">strlen</span>(path);</li><li>    <span class="hljs-type">char</span> *uriResult = <span class="hljs-literal">NULL</span>;</li><li>    FileManagement_ErrCode ret = OH_FileUri_GetUriFromPath(path, length ,&amp;uriResult);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span> &amp;&amp; uriResult !=<span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pathUri=%s"</span>, uriResult); <span class="hljs-comment">// 应用a获取到的URI为：file://com.example.demo/data/storage/el2/base/files/test.txt</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (uriResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">free</span>(uriResult);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_FileUri_GetPathFromUri通过URI转成对应的路径，在接口中malloc的内存需要在使用完后释放，因此需要free对应的内存。示例代码如下所示。</p>       <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OH_FileUri_GetPathFromUriExample</span><span class="hljs-params">()</span> {</li><li>    <span class="hljs-type">char</span> *uri = <span class="hljs-string">"file://com.example.demo/data/storage/el2/base/files/test.txt"</span>;</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = <span class="hljs-built_in">strlen</span>(uri);</li><li>    <span class="hljs-type">char</span> *pathResult = <span class="hljs-literal">NULL</span>;</li><li>    FileManagement_ErrCode ret = OH_FileUri_GetPathFromUri(uri, length, &amp;pathResult);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span> &amp;&amp; pathResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pathResult=%s"</span>, pathResult); <span class="hljs-comment">// PathResult值为：/data/storage/el2/base/files/test.txt</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (pathResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">free</span>(pathResult);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_FileUri_GetFullDirectoryUri获取URI所在路径的URI，在接口中malloc的内存需要在使用完后释放，因此需要free对应的内存。示例代码如下所示。</p>       <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OH_FileUri_GetFullDirectoryUriExample</span><span class="hljs-params">()</span> {</li><li>    <span class="hljs-type">char</span> *uri = <span class="hljs-string">"file://com.example.demo/data/storage/el2/base/files/test.txt"</span>;</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = <span class="hljs-built_in">strlen</span>(uri);</li><li>    <span class="hljs-type">char</span> *uriResult = <span class="hljs-literal">NULL</span>;</li><li>    FileManagement_ErrCode ret = OH_FileUri_GetFullDirectoryUri(uri, length, &amp;uriResult);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span> &amp;&amp; uriResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pathUri=%s"</span>,uriResult);<span class="hljs-comment">//URI所在路径的URI：file://com.example.demo/data/storage/el2/base/files/</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (uriResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">free</span>(uriResult);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>可以调用OH_FileUri_IsValidUri接口进行URI格式验证。 示例代码如下所示。</p>       <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li> </li><li> <span class="hljs-type">void</span> <span class="hljs-title function_">OH_FileUri_IsValidUriExample</span><span class="hljs-params">()</span> {</li><li>     <span class="hljs-type">char</span> *uri = <span class="hljs-string">"file://com.example.demo/data/storage/el2/base/files/test.txt"</span>;</li><li>     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = <span class="hljs-built_in">strlen</span>(uri);</li><li>     <span class="hljs-type">bool</span> flags = OH_FileUri_IsValidUri(uri, length);</li><li>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The URI is valid? flags=%d"</span>, flags);</li><li> }</li></ol></pre></div></div></li>      <li>       <p>调用OH_FileUri_GetFileName获取URI中的文件名称，在接口中malloc的内存需要在使用完后释放，因此需要free对应的内存。示例代码如下所示。</p>       <div _ngcontent-xbj-c106="" class="highlight-div"><div _ngcontent-xbj-c106="" class="highlight-div-header"><div _ngcontent-xbj-c106="" class="highlight-div-header-left"><div _ngcontent-xbj-c106="" class="handle-button expand-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xbj-c106="" class="highlight-div-header-right"><div _ngcontent-xbj-c106="" class="handle-button ai-button"></div><div _ngcontent-xbj-c106="" class="handle-button line-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xbj-c106="" class="handle-button theme-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xbj-c106="" class="handle-button copy-button"><div _ngcontent-xbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xbj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OH_FileUri_GetFileNameExample</span><span class="hljs-params">()</span> {</li><li>    <span class="hljs-type">char</span> *uri = <span class="hljs-string">"file://com.example.demo/data/storage/el2/base/files/test.txt"</span>;</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = <span class="hljs-built_in">strlen</span>(uri);</li><li>    <span class="hljs-type">char</span> *uriResult = <span class="hljs-literal">NULL</span>;</li><li>    FileManagement_ErrCode ret = OH_FileUri_GetFileName(uri, length, &amp;uriResult);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span> &amp;&amp; uriResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pathUri=%s"</span>,uriResult);<span class="hljs-comment">//获取到URI中的文件名：test.txt</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (uriResult != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">free</span>(uriResult);</li><li>    }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>