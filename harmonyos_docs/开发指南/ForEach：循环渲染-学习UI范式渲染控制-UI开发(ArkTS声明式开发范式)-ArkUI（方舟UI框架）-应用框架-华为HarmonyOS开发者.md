<h1 _ngcontent-umf-c119="" class="doc-title ng-star-inserted" title="ForEach：循环渲染"> ForEach：循环渲染 </h1>

<div _ngcontent-umf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>ForEach接口基于数组循环渲染，需要与容器组件配合使用，且接口返回的组件应当是允许包含在ForEach父容器组件中的子组件。例如，ListItem组件要求ForEach的父容器组件必须为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List组件</a>。</p>    <p>API参数说明见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-foreach" target="_blank">ForEach API参数说明</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>从API version 9开始，该接口支持在ArkTS卡片中使用。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="键值生成规则">键值生成规则<i class="anchor-icon anchor-icon-link" anchorid="键值生成规则" tips="复制节点链接"></i></h2>          <p>在ForEach循环渲染过程中，系统会为每个数组元素生成一个唯一且持久的键值，用于标识对应的组件。当键值变化时，ArkUI框架会视为该数组元素已被替换或修改，并会基于新的键值创建一个新的组件。</p>     <p>ForEach提供了一个名为keyGenerator的参数，这是一个函数，开发者可以通过它自定义键值的生成规则。如果开发者没有定义keyGenerator函数，则ArkUI框架会使用默认的键值生成函数，即(item: Object, index: number) =&gt; { return index + '__' + JSON.stringify(item); }。</p>     <p>ArkUI框架对于ForEach的键值生成有一套特定的判断规则，这主要与itemGenerator函数和keyGenerator函数的第二个参数index有关。具体的键值生成规则判断逻辑如下图所示。</p>     <p><strong>图1</strong> ForEach键值生成规则</p>     <p><span><img originheight="430" originwidth="600" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114826.77341278160195320952889516383134:50001231000000:2800:8ADF1C1D06A588CF244D1D9B56D9CE1EAEBD0F0EFDE2CFFFEAD33A7F2C84A9E3.png" width="600" height="430"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>ArkUI框架会对重复的键值发出运行时警告。在UI更新时，如果出现重复的键值，框架可能无法正常工作，具体请参见<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染结果非预期">渲染结果非预期</a>。</li>        <li>不建议在键值中包含数据项索引index，这可能会导致<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染结果非预期">渲染结果非预期</a>和<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染性能降低">渲染性能降低</a>。</li>        <li>如果开发者在itemGenerator函数中声明了index参数，但未在keyGenerator函数中声明index参数，框架会在keyGenerator函数返回值的基础上拼接index，作为最终的键值，这将会引发上述第二点中的问题。为避免此现象，请在keyGenerator函数中声明index参数。</li>       </ol>      </div></div></div>     <p>键值生成示例:</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChildItemType</span> {</li><li>  <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ChildItemType</span>&gt; = [</li><li>    { <span class="hljs-attr">str</span>: <span class="hljs-string">'one'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> },</li><li>    { <span class="hljs-attr">str</span>: <span class="hljs-string">'two'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">2</span> },</li><li>    { <span class="hljs-attr">str</span>: <span class="hljs-string">'three'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">3</span> }</li><li>  ];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: ChildItemType, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">str</span>: item.<span class="hljs-property">str</span>, <span class="hljs-attr">num</span>: index }) <span class="hljs-comment">// 组件生成函数中使用index参数</span></li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: ChildItemType, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">return</span> item.<span class="hljs-property">str</span>; <span class="hljs-comment">// 建议在键值生成函数中使用与UI界面相关的数据属性str</span></li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">str</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在上述示例中，当组件生成函数声明index时，建议键值生成函数也声明index参数，以避免渲染性能降低和渲染结果非预期。同时建议在键值生成函数实现中使用与UI相关的数据属性，在本示例中，数据属性str与UI界面显示相关，因此建议将其作为键值生成函数的返回值。</p>    </div>    <div class="tiledSection">     <h2 id="组件创建规则">组件创建规则<i class="anchor-icon anchor-icon-link" anchorid="组件创建规则" tips="复制节点链接"></i></h2>          <p>在确定键值生成规则后，ForEach的第二个参数itemGenerator函数会根据键值生成规则为数据源的每个数组项创建组件。组件的创建包括两种情况：<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#首次渲染">ForEach首次渲染</a>和<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#非首次渲染">ForEach非首次渲染</a>。</p>    </div>    <div class="tiledSection">     <h3 id="首次渲染" class="firsth2">首次渲染<i class="anchor-icon anchor-icon-link" anchorid="首次渲染" tips="复制节点链接"></i></h3>          <p>在ForEach首次渲染时，会根据前述键值生成规则为数据源的每个数组项生成唯一键值，并创建相应的组件。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>运行效果如下图所示。</p>     <p><strong>图2</strong> ForEach数据项不存在相同键值案例首次渲染运行效果图</p>     <p><span><img originheight="260" originwidth="526" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114826.94616116859096646468388232826373:50001231000000:2800:9890FF817A6E6A9F7524FADAC627094CFFBEEC9F0BD6904C42B74700DD602082.png" width="526" height="260"></span></p>     <p>在上述代码中，keyGenerator函数的返回值是item。在ForEach渲染循环时，为数组项依次生成键值one、two和three，并创建对应的ChildItem组件渲染到界面上。</p>     <p>当不同数组项生成的键值相同时，框架的行为是未定义的。例如，在以下代码中，ForEach渲染相同的数据项two时，只创建了一个ChildItem组件，而没有创建多个具有相同键值的组件。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>运行效果如下图所示。</p>     <p><strong>图3</strong> ForEach数据源存在相同值案例首次渲染运行效果图</p>     <p><span><img originheight="260" originwidth="526" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114826.61309215185696824614098731647024:50001231000000:2800:B58E18108AC55D19344451BE7AC3585D0BE4FF8BB380C2C6370E0C6247DBB8DE.png" width="526" height="260"></span></p>     <p>在该示例中，最终键值生成规则为item。当ForEach遍历数据源simpleList，遍历到索引为1的two时，创建键值为two的组件并记录。当遍历到索引为2的two时，当前项的键值也为two，此时不再创建新的组件。</p>    </div>    <div class="tiledSection">     <h3 id="非首次渲染">非首次渲染<i class="anchor-icon anchor-icon-link" anchorid="非首次渲染" tips="复制节点链接"></i></h3>          <p>在ForEach组件进行非首次渲染时，它会检查新生成的键值是否在上次渲染中已经存在。如果键值不存在，则会创建一个新的组件；如果键值存在，则不会创建新的组件，而是直接渲染该键值所对应的组件。例如，在以下的代码示例中，通过点击事件修改了数组的第三项值为"new three"，这将触发ForEach组件进行非首次渲染。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'点击修改第3个数组项的值'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>[<span class="hljs-number">2</span>] = <span class="hljs-string">'new three'</span>;</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>            .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>运行效果如下图所示。</p>     <p><strong>图4</strong> ForEach非首次渲染案例运行效果图</p>     <p><span><img originheight="179" originwidth="300" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114826.41696372631922314649902190736692:50001231000000:2800:1A2D06DFAAF69419C2F98400B009BB42B0F7418F9B7DB2511CB984AA9BA853C7.gif" width="300" height="179"></span></p>     <p>从本例可以看出<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a>能够监听到简单数据类型数组simpleList数组项的变化。</p>     <ol>      <li>当simpleList数组项发生变化时，会触发ForEach重新渲染。</li>      <li>ForEach遍历新的数据源['one', 'two', 'new three']，并生成对应的键值one、two和new three。</li>      <li>其中，键值one和two在上次渲染中已经存在，所以 ForEach 复用了对应的组件并进行了渲染。对于第三个数组项 "new three"，由于其通过键值生成规则 item 生成的键值new three在上次渲染中不存在，因此 ForEach 为该数组项创建了一个新的组件。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>          <p>ForEach组件在开发过程中的主要应用场景包括：<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#数据源不变">数据源不变</a>、<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#数据源数组项发生变化">数据源数组项发生变化</a>（如插入、删除操作）、<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#数据源数组项子属性变化">数据源数组项子属性变化</a>。</p>    </div>    <div class="tiledSection">     <h3 id="数据源不变" class="firsth2">数据源不变<i class="anchor-icon anchor-icon-link" anchorid="数据源不变" tips="复制节点链接"></i></h3>          <p>在数据源保持不变的场景中，数据源可以直接采用基本数据类型。例如，页面加载状态时，可以使用骨架屏列表进行渲染展示。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleList</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">ArticleSkeletonView</span>()</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">textArea</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span> | Resource | <span class="hljs-built_in">string</span> = <span class="hljs-string">'100%'</span>, height: <span class="hljs-built_in">number</span> | Resource | <span class="hljs-built_in">string</span> = <span class="hljs-string">'100%'</span></span>) {</li><li>  <span class="hljs-title class_">Row</span>()</li><li>    .<span class="hljs-title function_">width</span>(width)</li><li>    .<span class="hljs-title function_">height</span>(height)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF2F3F4'</span>)</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleSkeletonView</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title function_">textArea</span>(<span class="hljs-number">80</span>, <span class="hljs-number">80</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title function_">textArea</span>(<span class="hljs-string">'60%'</span>, <span class="hljs-number">20</span>)</li><li>        <span class="hljs-title function_">textArea</span>(<span class="hljs-string">'50%'</span>, <span class="hljs-number">20</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFECECEC'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">120</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>运行效果如下图所示。</p>     <p><strong>图5</strong> 骨架屏运行效果图</p>     <p><span><img originheight="700" originwidth="339" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.10386747734649855213567923896608:50001231000000:2800:90E102E804B8171C17D054111099FE9CF4CB7D2E9F9BD20CE102623918F28C81.png" width="339" height="700"></span></p>     <p>在本示例中，采用数据项item作为键值生成规则，由于数据源simpleList的数组项各不相同，因此能够保证键值的唯一性。</p>    </div>    <div class="tiledSection">     <h3 id="数据源数组项发生变化">数据源数组项发生变化<i class="anchor-icon anchor-icon-link" anchorid="数据源数组项发生变化" tips="复制节点链接"></i></h3>          <p>在数据源数组项发生变化的场景下，如数组插入、删除操作或者数组项索引位置交换时，数据源应为对象数组类型，并使用对象的唯一ID作为键值。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">brief</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, title: <span class="hljs-built_in">string</span>, brief: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">brief</span> = brief;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleListView</span> {</li><li>  <span class="hljs-attr">isListReachEnd</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">articleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Article</span>&gt; = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'001'</span>, <span class="hljs-string">'第1篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'002'</span>, <span class="hljs-string">'第2篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'003'</span>, <span class="hljs-string">'第3篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'004'</span>, <span class="hljs-string">'第4篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'005'</span>, <span class="hljs-string">'第5篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'006'</span>, <span class="hljs-string">'第6篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>)</li><li>  ];</li><li>
</li><li>  <span class="hljs-title function_">loadMoreArticles</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'007'</span>, <span class="hljs-string">'加载的新文章'</span>, <span class="hljs-string">'文章简介内容'</span>));</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title class_">List</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">ArticleCard</span>({ <span class="hljs-attr">article</span>: item })</li><li>              .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> item.<span class="hljs-property">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">onReachEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isListReachEnd</span> = <span class="hljs-literal">true</span>;</li><li>      })</li><li>      .<span class="hljs-title function_">parallelGesture</span>(</li><li>        <span class="hljs-title class_">PanGesture</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">Up</span>, <span class="hljs-attr">distance</span>: <span class="hljs-number">80</span> })</li><li>          .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isListReachEnd</span>) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadMoreArticles</span>();</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">isListReachEnd</span> = <span class="hljs-literal">false</span>;</li><li>            }</li><li>          })</li><li>      )</li><li>      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleCard</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">article</span>: <span class="hljs-title class_">Article</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">title</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">brief</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFECECEC'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">120</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>初始运行效果（左图）和手势上滑加载后效果（右图）如下图所示。</p>     <p><strong>图6</strong> 数据源数组项变化案例运行效果图</p>     <p><span><img originheight="700" originwidth="690" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.49281633132989231167465858924557:50001231000000:2800:4DCF5E4E76DCBECB2EDC69303CEDC6B78CE7483D6FD90AF6EB289316FCF8EADD.png" width="690" height="700"></span></p>     <p>在本示例中，ArticleCard组件作为ArticleListView组件的子组件，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>装饰器接收一个Article对象，用于渲染文章卡片。</p>     <ol>      <li>当列表滚动到底部且手势滑动距离超过80vp时，触发loadMoreArticles()函数。此函数在articleList数据源尾部添加新数据项，增加数据源长度。</li>      <li>数据源被@State装饰器修饰，ArkUI框架能够感知数据源长度的变化并触发ForEach进行重新渲染。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="数据源数组项子属性变化">数据源数组项子属性变化<i class="anchor-icon anchor-icon-link" anchorid="数据源数组项子属性变化" tips="复制节点链接"></i></h3>          <p>当数据源的数组项为对象数据类型，并且只修改某个数组项的属性值时，由于数据源为复杂数据类型，ArkUI框架无法监听到@State装饰器修饰的数据源数组项的属性变化，从而无法触发ForEach的重新渲染。为实现ForEach子组件重新渲染，需要结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed和@ObjectLink</a>装饰器使用。例如，在文章列表卡片上点击“点赞”按钮，从而修改文章的点赞数量。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">brief</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">isLiked</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-attr">likesCount</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, title: <span class="hljs-built_in">string</span>, brief: <span class="hljs-built_in">string</span>, isLiked: <span class="hljs-built_in">boolean</span>, likesCount: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">brief</span> = brief;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLiked</span> = isLiked;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">likesCount</span> = likesCount;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleListView</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">articleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Article</span>&gt; = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'001'</span>, <span class="hljs-string">'第0篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'002'</span>, <span class="hljs-string">'第1篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'003'</span>, <span class="hljs-string">'第2篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'004'</span>, <span class="hljs-string">'第4篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'005'</span>, <span class="hljs-string">'第5篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'006'</span>, <span class="hljs-string">'第6篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>  ];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">List</span>() {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">ArticleCard</span>({</li><li>            <span class="hljs-attr">article</span>: item</li><li>          })</li><li>            .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>        }</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> item.<span class="hljs-property">id</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleCard</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">article</span>: <span class="hljs-title class_">Article</span>;</li><li>
</li><li>  <span class="hljs-title function_">handleLiked</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> + <span class="hljs-number">1</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> - <span class="hljs-number">1</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">title</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">brief</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>
</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-comment">// 此处app.media.iconLiked'，'app.media.iconUnLiked'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>          <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> ? $r(<span class="hljs-string">'app.media.iconLiked'</span>) : $r(<span class="hljs-string">'app.media.iconUnLiked'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">8</span> })</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span>.<span class="hljs-title function_">toString</span>())</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleLiked</span>())</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFECECEC'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">120</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上述代码的初始运行效果（左图）和点击第1个文章卡片上的点赞图标后的运行效果（右图）如下图所示。</p>     <p><strong>图7</strong> 数据源数组项子属性变化案例运行效果图</p>     <p><span><img originheight="700" originwidth="693" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.77436752077664691250224523309442:50001231000000:2800:84178D2ADC0DB37C038D0CBD2E544210263371579134C12DBDB9FC457A9F710A.png" width="693" height="700"></span></p>     <p>在本示例中，Article类被@Observed装饰器修饰。父组件ArticleListView传入Article对象实例给子组件ArticleCard，子组件使用@ObjectLink装饰器接收该实例。</p>     <ol>      <li>当点击第1个文章卡片上的点赞图标时，会触发ArticleCard组件的handleLiked函数。该函数修改第1个卡片对应组件里article实例的isLiked和likesCount属性值。</li>      <li>article实例是@ObjectLink装饰的状态变量，其属性值变化，会触发ArticleCard组件渲染，此时读取的isLiked和likesCount为修改后的新值。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="拖拽排序">拖拽排序<i class="anchor-icon anchor-icon-link" anchorid="拖拽排序" tips="复制节点链接"></i></h3>          <p>在List组件下使用ForEach，并设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-sorting#onmove" target="_blank">onMove</a>事件，每次迭代生成一个ListItem时，可以使能拖拽排序。拖拽排序离手后，如果组件位置发生变化，将触发onMove事件，上报组件移动原始索引号和目标索引号。在onMove事件中，需要根据上报的起始索引号和目标索引号修改数据源。数据源修改前后，要保持每个数据的键值不变，只是顺序发生变化，才能保证落位动画正常执行。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ForEachSort</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">arr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 点击此按钮会触发ForEach重新渲染</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Add one item'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'10'</span>);</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>
</li><li>      <span class="hljs-title class_">List</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">Text</span>(item.<span class="hljs-title function_">toString</span>())</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>              .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span> })</li><li>          }.<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFFFFFFF'</span>)</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>          .<span class="hljs-title function_">onMove</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">from</span>: <span class="hljs-built_in">number</span>, to: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// 以下两行代码是为了确保拖拽后屏幕上组件的顺序与数组arr中每一项的顺序保持一致。</span></li><li>            <span class="hljs-comment">// 若注释以下两行，第一步拖拽排序，第二步在arr末尾插入一项，触发ForEach渲染，此时屏上组件的顺序会跟数组arr中每一项的顺序一致，而不是维持第一步拖拽后的顺序，意味着拖拽排序在ForEach渲染后失效了。</span></li><li>            <span class="hljs-keyword">let</span> tmp = <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-keyword">from</span>, <span class="hljs-number">1</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>.<span class="hljs-title function_">splice</span>(to, <span class="hljs-number">0</span>, tmp[<span class="hljs-number">0</span>]);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFDCDCDC'</span>)</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>.<span class="hljs-title function_">push</span>(i.<span class="hljs-title function_">toString</span>());</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>图8</strong> ForEach拖拽排序效果图</p>     <p><span><img originheight="577" originwidth="264" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.54653059444381969240759466879065:50001231000000:2800:CCCDB1442E0E8BB4DE89A0698F32FC961D78221E2D5D01E93B8DC02F677C1E6A.gif" class="notEnlarge" width="264" height="577"></span></p>     <p>注释掉onMove事件调用中的两行代码，点击Add one item触发渲染后的效果如下图所示。</p>     <p><strong>图9</strong> ForEach拖拽排序效果在重新渲染后没有保留</p>     <p><span><img originheight="447" originwidth="266" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.22137270838003367314115323874708:50001231000000:2800:C6D072E7BC98C4237A657635C5A05F70CC20DCE94A0910E101975FE766FC4A90.png" class="notEnlarge" width="266" height="447"></span></p>    </div>    <div class="tiledSection">     <h2 id="使用建议">使用建议<i class="anchor-icon anchor-icon-link" anchorid="使用建议" tips="复制节点链接"></i></h2>          <ul>      <li>为满足键值的唯一性，对于对象数据类型，建议使用对象数据中的唯一id作为键值。</li>      <li>不建议在键值中包含数据项索引index，可能会导致<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染结果非预期">渲染结果非预期</a>和<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染性能降低">渲染性能降低</a>。如果确实需要使用index，例如列表通过index进行条件渲染，开发者需接受ForEach在数据源变更后重新创建组件导致的性能损耗。</li>      <li>基本类型数组的数据项没有唯一ID属性。如果使用数据项作为键值，必须确保数据项无重复。对于数据源会变化的场景，建议将基本类型数组转换为具有唯一ID属性的Object类型数组，再使用唯一ID属性作为键值。</li>      <li>对于以上限制规则，index参数存在的意义为：index是开发者保证键值唯一性的最终手段；对数据项进行修改时，由于itemGenerator中的item参数是不可修改的，所以须用index索引值对数据源进行修改，进而触发UI重新渲染。</li>      <li>ForEach在滚动容器组件 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-grid" target="_blank">Grid</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-swiper" target="_blank">Swiper</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow" target="_blank">WaterFlow</a> 内使用的时候，不建议与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-lazyforeach">LazyForEach</a> 同时使用。</li>      <li>在大量子组件的场景下，ForEach可能会导致卡顿。请考虑使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-lazyforeach">LazyForEach</a>替代。最佳实践请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-lazyforeach-optimization" target="_blank">使用懒加载优化性能</a>。</li>      <li>当数组项为对象类型时，不建议用内容相同的数组项替换旧项。若数组项发生变更但键值未变，会导致<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#数据变化不渲染">数据变化不渲染</a>。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>          <p>对ForEach键值的错误使用会导致功能和性能问题。详见案例<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染结果非预期">渲染结果非预期</a>和<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#渲染性能降低">渲染性能降低</a>。</p>    </div>    <div class="tiledSection">     <h3 id="渲染结果非预期" class="firsth2">渲染结果非预期<i class="anchor-icon anchor-icon-link" anchorid="渲染结果非预期" tips="复制节点链接"></i></h3>          <p>在本示例中，通过设置ForEach的第三个参数KeyGenerator函数，自定义键值生成规则为数据源的索引index的字符串类型值。当点击父组件Parent中“在第1项后插入新项”文本组件后，界面会出现非预期的结果。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'在第1项后插入新项'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'new item'</span>);</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>上述代码的初始渲染效果和点击“在第1项后插入新项”文本组件后的渲染效果如下图所示。</p>     <p><strong>图10</strong> 渲染结果非预期运行效果图</p>     <p><span><img originheight="275" originwidth="470" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.33061419185693958193661700296764:50001231000000:2800:49038FBB30030F89421C74367AFACA4DB2F727C4E16643BC6F9665FDAAF1BBA8.gif" width="470" height="275"></span></p>     <p>ForEach在首次渲染时，创建的键值依次为"0"、"1"、"2"。</p>     <p>插入新项后，数据源simpleList变为['one', 'new item', 'two', 'three']，框架监听到@State装饰的数据源长度变化触发ForEach重新渲染。</p>     <p>ForEach依次遍历新数据源，遍历数据项"one"时生成键值"0"，存在相同键值，因此不创建新组件。继续遍历数据项"new item"时生成键值"1"，存在相同键值，因此不创建新组件。继续遍历数据项"two"生成键值"2"，存在相同键值，因此不创建新组件。最后遍历数据项"three"时生成键值"3"，不存在相同键值，创建内容为"three"的新组件并渲染。</p>     <p>从以上可以看出，当键值包含数据项索引index时，期望的界面渲染结果为['one', 'new item', 'two', 'three']，而实际的渲染结果为['one', 'two', 'three', 'three']，不符合开发者预期。因此，开发者在使用ForEach时应避免键值包含索引index。</p>    </div>    <div class="tiledSection">     <h3 id="渲染性能降低">渲染性能降低<i class="anchor-icon anchor-icon-link" anchorid="渲染性能降低" tips="复制节点链接"></i></h3>          <p>在本示例中，ForEach的第三个参数KeyGenerator函数缺省。根据上述<a href="/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-foreach#键值生成规则">键值生成规则</a>，此例使用框架默认的键值，即最终键值为字符串index + '__' + JSON.stringify(item)。点击文本组件“在第1项后插入新项”后，ForEach将为第2个数组项及后面的所有数据项重新创建组件。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'在第1项后插入新项'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'new item'</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[onClick]: simpleList is [<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.simpleList.join(<span class="hljs-string">', '</span>)}</span>]`</span>);</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[aboutToAppear]: item is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上代码的初始渲染效果和点击"在第1项后插入新项"文本组件后的渲染效果如下图所示。</p>     <p><strong>图11</strong> 渲染性能降低案例运行效果图</p>     <p><span><img originheight="360" originwidth="470" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.42763890170408103507412031798969:50001231000000:2800:08834C3A2686B5B9A91C0A1340303AEF481FB2ADD956F5941F17684E374D300D.gif" width="470" height="360"></span></p>     <p>点击“在第1项后插入新项”文本组件后，DevEco Studio的日志打印结果如下所示。</p>     <p><strong>图12</strong> 渲染性能降低案例日志打印图</p>     <p><span><img originheight="85" originwidth="1193" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.48371876955394848174733645524053:50001231000000:2800:811CB36732ABEB00CF418CB25DD25507BCD86F095253CD34BB713858C189355D.png" width="920" height="65.54903604358759"></span></p>     <p>插入新项后，ForEach为new item、 two、 three三个数组项创建了对应的ChildItem组件，并执行了组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttoappear" target="_blank">aboutToAppear()</a>生命周期函数。这是因为：</p>     <ol>      <li>ForEach首次渲染时，生成的键值依次为0__one、1__two和2__three。</li>      <li>插入新项后，数据源simpleList变为['one', 'new item', 'two', 'three']，ArkUI框架监听到@State装饰的数据源长度变化触发ForEach重新渲染。</li>      <li>ForEach依次遍历新数据源，遍历数据项one时生成键值0__one，键值已存在，因此不创建新组件。继续遍历数据项new item时生成键值1__new item，不存在相同键值，创建内容为new item的新组件并渲染。继续遍历数据项two生成键值2__two，不存在相同键值，创建内容为two的新组件并渲染。最后遍历数据项three时生成键值3__three，不存在相同键值，创建内容为three的新组件并渲染。</li>     </ol>     <p>尽管本例中界面渲染结果符合预期，但在每次向数组中间插入新数组项时，ForEach会为该数组项及其后面的所有数组项重新创建组件。当数据源数据量较大或组件结构复杂时，组件无法复用会导致性能下降。因此，不建议省略第三个参数KeyGenerator函数，也不建议在键值中使用数据项索引index。</p>     <p>正确渲染并保证效率的ForEach写法是：</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>}, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)  <span class="hljs-comment">// 需要保证key唯一</span></li></ol></pre></div></div>     <p>提供了第三个参数KeyGenerator，在这个例子中，对数据源的不同数据项生成不同的key，并且对同一个数据项每次生成相同的key。</p>    </div>    <div class="tiledSection">     <h3 id="数据变化不渲染">数据变化不渲染<i class="anchor-icon anchor-icon-link" anchorid="数据变化不渲染" tips="复制节点链接"></i></h3>          <p>点击按钮Like/UnLike first article，第一个组件会切换点赞手势和后面的点赞数量，但是点击按钮Replace first article之后再点击按钮Like/UnLike first article就不生效了。原因是替换articleList[0]之后，articleList状态变量发生变化，触发ForEach重新渲染，但是新的articleList[0]生成的key没有变，ForEach不会将数据更新同步给子组件，因此第一个组件仍然绑定旧的articleList[0]。新articleList[0]的属性发生变更，第一个组件感知不到，不会重新渲染。点击点赞手势，会触发渲染。因为变更的是跟组件绑定的数组项的属性，组件会感知并重新渲染。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">brief</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">isLiked</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-attr">likesCount</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, title: <span class="hljs-built_in">string</span>, brief: <span class="hljs-built_in">string</span>, isLiked: <span class="hljs-built_in">boolean</span>, likesCount: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">brief</span> = brief;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLiked</span> = isLiked;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">likesCount</span> = likesCount;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleListView</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">articleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Article</span>&gt; = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'001'</span>, <span class="hljs-string">'第0篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'002'</span>, <span class="hljs-string">'第1篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'003'</span>, <span class="hljs-string">'第2篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'004'</span>, <span class="hljs-string">'第4篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'005'</span>, <span class="hljs-string">'第5篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'006'</span>, <span class="hljs-string">'第6篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>),</li><li>  ];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Replace first article'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>(<span class="hljs-string">'001'</span>, <span class="hljs-string">'第0篇文章'</span>, <span class="hljs-string">'文章简介内容'</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">100</span>);</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Like/Unlike first article'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">isLiked</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">isLiked</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">likesCount</span> =</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">isLiked</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">likesCount</span> + <span class="hljs-number">1</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">likesCount</span> - <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>
</li><li>      <span class="hljs-title class_">List</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">articleList</span>, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">ArticleCard</span>({</li><li>              <span class="hljs-attr">article</span>: item</li><li>            })</li><li>              .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: Article</span>) =&gt;</span> item.<span class="hljs-property">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ArticleCard</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">article</span>: <span class="hljs-title class_">Article</span>;</li><li>
</li><li>  <span class="hljs-title function_">handleLiked</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> + <span class="hljs-number">1</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span> - <span class="hljs-number">1</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">title</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">brief</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })</li><li>
</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-comment">// 此处app.media.iconLiked'，'app.media.iconUnLiked'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>          <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">isLiked</span> ? $r(<span class="hljs-string">'app.media.iconLiked'</span>) : $r(<span class="hljs-string">'app.media.iconUnLiked'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">8</span> })</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">article</span>.<span class="hljs-property">likesCount</span>.<span class="hljs-title function_">toString</span>())</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleLiked</span>())</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFECECEC'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">120</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>图13</strong> 数据变化不渲染</p>     <p><span><img originheight="759" originwidth="338" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.34799978781063052296937926467821:50001231000000:2800:7870374513E80574FAE3ADDB2CFDD4FF8C91972E5A9938BB372EB94E16F4C308.png" width="338" height="759"></span></p>    </div>    <div class="tiledSection">     <h3 id="非必要内存消耗">非必要内存消耗<i class="anchor-icon anchor-icon-link" anchorid="非必要内存消耗" tips="复制节点链接"></i></h3>          <p>如果开发者没有定义keyGenerator函数，则ArkUI框架会使用默认的键值生成函数，即(item: Object, index: number) =&gt; { return index + '__' + JSON.stringify(item); }。当item是复杂对象时，将其JSON序列化会得到长字符串，占用更多的内存。</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> {</li><li>  <span class="hljs-attr">longStr</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">longStr: <span class="hljs-built_in">string</span>, key: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">longStr</span> = longStr;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Data</span>&gt; = [];</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> longStr = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2000</span>; i++) {</li><li>      longStr += i.<span class="hljs-title function_">toString</span>();</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">3000</span>; index++) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Data</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(longStr, <span class="hljs-string">'a'</span> + index.<span class="hljs-title function_">toString</span>());</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>.<span class="hljs-title function_">push</span>(data);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">List</span>() {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: Data</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Text</span>(item.<span class="hljs-property">key</span>)</li><li>        }</li><li>      }</li><li>        <span class="hljs-comment">// 如果不定义下面的keyGenerator函数，则ArkUI框架会使用默认的键值生成函数</span></li><li>        , <span class="hljs-function">(<span class="hljs-params">item: Data</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">return</span> item.<span class="hljs-property">key</span>;</li><li>        }</li><li>      )</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>对比自定义keyGenerator函数和使用默认键值生成函数两种情况下的内存占用（通过DevEco-&gt;Profiler-&gt;Realtime Monitor工具，可以获取相关进程的内存数据）。自定义keyGenerator函数，这个示例代码的内存占用降低了约70MB。</p>     <p><strong>图14</strong> 使用默认键值生成函数下的内存占用</p>     <p><span><img originheight="486" originwidth="708" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.30969264854284860570951171849000:50001231000000:2800:C3B2CE306C82977A4C9EA1096FD9C8C9EE5ADBEA18B9BDC78F877D68A50D30F7.png" width="708" height="486"></span></p>     <p><strong>图15</strong> 自定义键值生成函数下的内存占用</p>     <p><span><img originheight="489" originwidth="709" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.47571942577095846389135919624013:50001231000000:2800:2B01EDCBE18867215BBC5D31E24C20BCD5D5B54D8BDF20B71AA26D8F37E9E637.png" width="709" height="489"></span></p>    </div>    <div class="tiledSection">     <h3 id="键值生成失败">键值生成失败<i class="anchor-icon anchor-icon-link" anchorid="键值生成失败" tips="复制节点链接"></i></h3>          <p>如果开发者没有定义keyGenerator函数，则ArkUI框架会使用默认的键值生成函数，即(item: Object, index: number) =&gt; { return index + '__' + JSON.stringify(item); }。然而，JSON.stringify序列化在某些数据结构上会失败，导致应用发生jscrash并退出。例如，bigint无法被JSON.stringify序列化：</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> {</li><li>  <span class="hljs-attr">content</span>: <span class="hljs-built_in">bigint</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">content: <span class="hljs-built_in">bigint</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">simpleList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Data</span>&gt; = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">1234567890123456789n</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">2345678910987654321n</span>)];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleList</span>, <span class="hljs-function">(<span class="hljs-params">item: Data</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ChildItem</span>({ <span class="hljs-attr">item</span>: item.<span class="hljs-property">content</span>.<span class="hljs-title function_">toString</span>() })</li><li>        }</li><li>          <span class="hljs-comment">// 如果不定义下面的keyGenerator函数，则ArkUI框架会使用默认的键值生成函数</span></li><li>          <span class="hljs-comment">// Data中的content: bigint在JSON序列化时失败</span></li><li>          , <span class="hljs-function">(<span class="hljs-params">item: Data</span>) =&gt;</span> item.<span class="hljs-property">content</span>.<span class="hljs-title function_">toString</span>()</li><li>        )</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>开发者定义keyGenerator函数，应用正常启动：</p>     <p><span><img originheight="316" originwidth="231" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114827.65960484064121156353353518009375:50001231000000:2800:1668FDC4D9AB513488D13E4E0C5D2EDFB9877CBE2C567A09FBC7E09DB5A97E9F.png" class="notEnlarge" width="231" height="316"></span></p>     <p>使用默认的键值生成函数，应用发生jscrash：</p>     <div _ngcontent-umf-c106="" class="highlight-div"><div _ngcontent-umf-c106="" class="highlight-div-header"><div _ngcontent-umf-c106="" class="highlight-div-header-left"><div _ngcontent-umf-c106="" class="handle-button expand-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umf-c106="" class="highlight-div-header-right"><div _ngcontent-umf-c106="" class="handle-button ai-button"></div><div _ngcontent-umf-c106="" class="handle-button line-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umf-c106="" class="handle-button theme-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umf-c106="" class="handle-button copy-button"><div _ngcontent-umf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:@<span class="hljs-title class_">Component</span> <span class="hljs-string">'Parent'</span>[<span class="hljs-number">4</span>]: <span class="hljs-title class_">ForEach</span> <span class="hljs-title class_">id</span> <span class="hljs-number">7</span>: <span class="hljs-title class_">use</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">default</span> <span class="hljs-title class_">id</span> <span class="hljs-title class_">generator</span> <span class="hljs-title class_">function</span> <span class="hljs-title class_">not</span> <span class="hljs-title class_">possible</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">provided</span> <span class="hljs-title class_">data</span> <span class="hljs-title class_">structure</span>. <span class="hljs-title class_">Need</span> <span class="hljs-title class_">to</span> <span class="hljs-title class_">specify</span> <span class="hljs-title class_">id</span> <span class="hljs-title class_">generator</span> <span class="hljs-title class_">function</span> (<span class="hljs-title class_">ForEach</span> <span class="hljs-number">3</span><span class="hljs-title class_">rd</span> <span class="hljs-title class_">parameter</span>). <span class="hljs-title class_">Application</span> <span class="hljs-title class_">Error</span>!</li><li><span class="hljs-variable">Stacktrace</span>:</li><li>    ...</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">anonymous</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">Index</span>.<span class="hljs-variable">ets</span>:<span class="hljs-number">18</span>:<span class="hljs-number">52</span>)</li></ol></pre></div></div>    </div>   </div>   <div></div></div>