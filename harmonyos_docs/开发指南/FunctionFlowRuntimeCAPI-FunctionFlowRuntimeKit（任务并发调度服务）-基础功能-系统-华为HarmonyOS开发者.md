<h1 _ngcontent-fut-c119="" class="doc-title ng-star-inserted" title="Function Flow Runtime C API"> Function Flow Runtime C API </h1>

<div _ngcontent-fut-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="任务管理">任务管理<i class="anchor-icon anchor-icon-link" anchorid="任务管理" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_deps_t" class="firsth2">ffrt_deps_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_deps_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    ffrt_dependence_data,</li><li>    ffrt_dependence_task,</li><li>} <span class="hljs-type">ffrt_dependence_type_t</span>;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">ffrt_dependence_type_t</span> type;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>* ptr;</li><li>} <span class="hljs-type">ffrt_dependence_t</span>;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">uint32_t</span> len;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">ffrt_dependence_t</span>* items;</li><li>} <span class="hljs-type">ffrt_deps_t</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>len：数据依赖个数。</li><li>items：数据依赖数组，数据长度等于len。</li><li>ptr：数据地址。</li><li>type：区分数据和task_handle。</li></ul> <p><strong>描述</strong></p> <p>ffrt_dependence_t作用等同C++的dependence，ffrt_deps_t作用等同C++的std::vector&lt;dependence&gt;。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建数据依赖</span></li><li><span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">ffrt_dependence_t</span> data_dependence[<span class="hljs-number">1</span>];</li><li>data_dependence[<span class="hljs-number">0</span>].type = ffrt_dependence_data;</li><li>data_dependence[<span class="hljs-number">0</span>].ptr = &amp;x;</li><li><span class="hljs-type">ffrt_deps_t</span> data_deps;</li><li>data_deps.len = <span class="hljs-number">1</span>;</li><li>data_deps.items = data_dependence;</li><li>
</li><li><span class="hljs-comment">// 创建任务依赖</span></li><li><span class="hljs-type">ffrt_task_handle_t</span> task = ffrt_submit_h_base(user_function_header, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;attr);</li><li><span class="hljs-type">ffrt_dependence_t</span> task_dependence[<span class="hljs-number">1</span>];</li><li>task_dependence[<span class="hljs-number">0</span>].type = ffrt_dependence_task;</li><li>task_dependence[<span class="hljs-number">0</span>].ptr = task;</li><li><span class="hljs-type">ffrt_deps_t</span> task_deps;</li><li>task_deps.len = <span class="hljs-number">1</span>;</li><li>task_deps.items = task_dependence;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_task_attr_t">ffrt_task_attr_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_task_attr_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">uint32_t</span> storage[(ffrt_task_attr_storage_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];</li><li>} <span class="hljs-type">ffrt_task_attr_t</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>任务的属性描述，在提交普通任务或者队列任务时，可以通过ffrt_task_attr_t来配置其属性。</p> <p><strong>方法</strong></p> <p><strong>ffrt_task_attr_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_task_attr_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>初始化一个ffrt_task_attr_t对象。</li></ul> <p><strong>ffrt_task_attr_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>描述</p> <ul><li>销毁一个ffrt_task_attr_t对象。</li></ul> <p><strong>ffrt_task_attr_set_name</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_set_name</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li><li>name：任务的名称。</li></ul> <p>描述</p> <ul><li>设置任务的名称，名称是用于维测信息打印的一种有效信息。</li></ul> <p><strong>ffrt_task_attr_get_name</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title function_">ffrt_task_attr_get_name</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>任务的名称。</li></ul> <p>描述</p> <ul><li>获取设置的任务名称。</li></ul> <p><strong>ffrt_task_attr_set_qos</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_set_qos</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr, <span class="hljs-type">ffrt_qos_t</span> qos)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li><li>qos：QoS等级。</li></ul> <p>描述</p> <ul><li>设置任务的QoS等级，QoS等级影响任务执行时的系统资源供给。不设置QoS的情况下，队列任务默认继承队列的QoS等级，普通任务默认设置为ffrt_qos_default。</li></ul> <p><strong>ffrt_task_attr_get_qos</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_qos_t</span> <span class="hljs-title function_">ffrt_task_attr_get_qos</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>QoS等级。</li></ul> <p>描述</p> <ul><li>获取设置的QoS等级。</li></ul> <p><strong>ffrt_task_attr_set_delay</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_set_delay</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr, <span class="hljs-type">uint64_t</span> delay_us)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li><li>delay_us：调度延迟，单位为微秒。</li></ul> <p>描述</p> <ul><li>设置任务的调度延迟，任务会在延迟间隔之后才调度执行。不设置的情况下，默认延迟为零。</li><li>设置任务的调度延迟后，任务的输入输出依赖关系不再生效。</li></ul> <p><strong>ffrt_task_attr_get_delay</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">uint64_t</span> <span class="hljs-title function_">ffrt_task_attr_get_delay</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>调度延迟。</li></ul> <p>描述</p> <ul><li>获取设置的调度延迟。</li></ul> <p><strong>ffrt_task_attr_set_queue_priority</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_set_queue_priority</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr, <span class="hljs-type">ffrt_queue_priority_t</span> priority)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li><li>priority：任务优先级。</li></ul> <p>描述</p> <ul><li>设置任务的优先级，目前仅并发队列任务支持优先级功能，同一个并发队列中按照优先级顺序来调度任务。不设置的情况下，任务默认优先级ffrt_queue_priority_low。</li></ul> <p><strong>ffrt_task_attr_get_queue_priority</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_queue_priority_t</span> <span class="hljs-title function_">ffrt_task_attr_get_queue_priority</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>任务优先级。</li></ul> <p>描述</p> <ul><li>获取设置的优先级。</li></ul> <p><strong>ffrt_task_attr_set_stack_size</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_attr_set_stack_size</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_attr_t</span>* attr, <span class="hljs-type">uint64_t</span> size)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li><li>size：协程栈大小，单位为字节。</li></ul> <p>描述</p> <ul><li>设置任务的协程栈大小，影响任务执行过程中最大的调用栈使用空间上限。在不设置的情况下，默认的协程栈大小为1MB。</li></ul> <p><strong>ffrt_task_attr_get_stack_size</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">uint64_t</span> <span class="hljs-title function_">ffrt_task_attr_get_stack_size</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：ffrt_task_attr_t对象指针。</li></ul> <p>返回值</p> <ul><li>协程栈大小。</li></ul> <p>描述</p> <ul><li>获取设置的协程栈大小。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 提交一个普通任务，其名称为"sample_task"，QoS等级为background，调度时延为1ms，协程栈大小为2MB</span></li><li><span class="hljs-type">ffrt_task_attr_t</span> attr;</li><li>ffrt_task_attr_init(&amp;attr);</li><li>ffrt_task_attr_set_name(&amp;attr, <span class="hljs-string">"sample_task"</span>);</li><li>ffrt_task_attr_set_qos(&amp;attr, ffrt_qos_background);</li><li>ffrt_task_attr_set_delay(&amp;attr, <span class="hljs-number">1000</span>);</li><li>ffrt_task_attr_set_stack_size(&amp;attr, <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);</li><li>ffrt_submit_base(user_function_header, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;attr);</li><li>ffrt_task_attr_destroy(&amp;attr);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_alloc_auto_managed_function_storage_base">ffrt_alloc_auto_managed_function_storage_base<i class="anchor-icon anchor-icon-link" anchorid="ffrt_alloc_auto_managed_function_storage_base" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    ffrt_function_kind_general,</li><li>    ffrt_function_kind_queue,</li><li>} <span class="hljs-type">ffrt_function_kind_t</span>;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span><span class="hljs-params">(*<span class="hljs-type">ffrt_function_t</span>)</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">ffrt_function_t</span> exec;</li><li>    <span class="hljs-type">ffrt_function_t</span> destroy;</li><li>    <span class="hljs-type">uint64_t</span> reserve[<span class="hljs-number">2</span>];</li><li>} <span class="hljs-type">ffrt_function_header_t</span>;</li><li>
</li><li>FFRT_C_API <span class="hljs-type">void</span> *<span class="hljs-title function_">ffrt_alloc_auto_managed_function_storage_base</span><span class="hljs-params">(<span class="hljs-type">ffrt_function_kind_t</span> kind)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>kind：提交普通任务选择ffrt_function_kind_general，提交队列任务选择ffrt_function_kind_queue。</li><li>exec：任务实际执行调用的函数指针。</li><li>destroy：任务完成后调用的函数指针，可用于资源清理等用途。</li><li>reserve：内部预留空间，用户请勿使用该成员。</li></ul> <p><strong>返回值</strong></p> <ul><li>返回存储用户任务执行体的指针。</li></ul> <p><strong>描述</strong></p> <p>分配了一块内存空间，内存空间头部为ffrt_function_header_t结构体（返回指针可转换为ffrt_function_header_t*指针使用）。头部后留有64字节的可用空间，用户可自定义使用该空间，通常用于入参或返回值的存储。</p> <p><strong>样例</strong></p> <ul><li><p>样例1：生成一个不带参数和返回值的任务执行体：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"foo\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">after_foo</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"after_foo\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-type">ffrt_function_header_t</span>* func = (<span class="hljs-type">ffrt_function_header_t</span>*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>
</li><li>    func-&gt;exec = foo;</li><li>    func-&gt;destroy = after_foo;</li><li>
</li><li>    ffrt_submit_base(func, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    ffrt_wait();</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>样例2：生成一个带参数和返回值的任务执行体：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"foo: x = %d, y = %d\n"</span>, x, y);</li><li>    <span class="hljs-keyword">return</span> x + y;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">after_foo</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"after_foo\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 用户自定义任务执行体，可携带参数和返回值</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">ffrt_function_header_t</span> header; <span class="hljs-comment">// 头部内存为ffrt_function_header_t</span></li><li>    <span class="hljs-type">int</span> arg1; <span class="hljs-comment">// 参数1</span></li><li>    <span class="hljs-type">int</span> arg2; <span class="hljs-comment">// 参数2</span></li><li>    <span class="hljs-type">int</span> ret; <span class="hljs-comment">// 返回值</span></li><li>} user_defined_function;</li><li>
</li><li><span class="hljs-comment">// 将foo包装成void(*)(void*)的exec函数类型</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">exec_func_wrapper</span><span class="hljs-params">(<span class="hljs-type">void</span>* header)</span></li><li>{</li><li>    user_defined_function* func = (user_defined_function*)header;</li><li>    func-&gt;ret = foo(func-&gt;arg1, func-&gt;arg2); <span class="hljs-comment">// 内部展开真正的foo函数，传递参数，获取返回值</span></li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    user_defined_function* func = (user_defined_function*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>
</li><li>    func-&gt;header.exec = exec_func_wrapper;</li><li>    func-&gt;header.destroy = after_foo;</li><li>    func-&gt;arg1 = <span class="hljs-number">1</span>;</li><li>    func-&gt;arg2 = <span class="hljs-number">2</span>;</li><li>
</li><li>    ffrt_submit_base((<span class="hljs-type">ffrt_function_header_t</span>*)func, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    ffrt_wait();</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ret = %d\n"</span>, func-&gt;ret);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li></ul> </div>  <div class="tiledSection"><h3 id="ffrt_submit_base">ffrt_submit_base<i class="anchor-icon anchor-icon-link" anchorid="ffrt_submit_base" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_submit_base</span><span class="hljs-params">(<span class="hljs-type">ffrt_function_header_t</span>* f, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* in_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* out_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>f：用户的任务执行体，可以是原生的ffrt_function_header_t类型，也可以基于ffrt_function_header_t自定义拓展类型。</li><li>in_deps：任务的输入数据依赖。输入数据依赖通常以实际数据的地址表达，也支持ffrt_task_handle_t作为一种特殊输入依赖。</li><li>out_deps：任务的输出数据依赖。输出数据依赖通常以实际数据的地址表达，不支持ffrt_task_handle_t。</li><li>attr：任务的属性设置。</li></ul> <p><strong>描述</strong></p> <p>提交一个普通任务，任务支持相关属性设置，在输入依赖解除后任务可调度执行，任务执行完成后解除输出依赖。</p> <p><strong>样例</strong></p> <ul><li><p>样例1：提交带属性的任务：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"foo\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">after_foo</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"after_foo\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-comment">// 提交一个任务</span></li><li>    <span class="hljs-type">ffrt_function_header_t</span>* func = (<span class="hljs-type">ffrt_function_header_t</span>*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>    func-&gt;exec = foo;</li><li>    func-&gt;destroy = after_foo;</li><li>    ffrt_submit_base(func, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    <span class="hljs-comment">// 提交一个带属性的任务</span></li><li>    <span class="hljs-type">ffrt_task_attr_t</span> attr;</li><li>    ffrt_task_attr_init(&amp;attr);</li><li>    ffrt_task_attr_set_name(&amp;attr, <span class="hljs-string">"sample_task"</span>);</li><li>    ffrt_task_attr_set_qos(&amp;attr, ffrt_qos_background);</li><li>    ffrt_submit_base(func, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;attr);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>样例2：提交带数据依赖的任务：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 提交两个带数据依赖的任务，任务间存在Read-After-Write依赖关系</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">cos_func</span><span class="hljs-params">(<span class="hljs-type">float</span>* x, <span class="hljs-type">float</span>* y)</span></li><li>{</li><li>    *y = <span class="hljs-built_in">cos</span>(*x);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">tan_func</span><span class="hljs-params">(<span class="hljs-type">float</span>* y, <span class="hljs-type">float</span>* z)</span></li><li>{</li><li>    *z = <span class="hljs-built_in">tan</span>(*y);</li><li>}</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">ffrt_function_header_t</span> header;</li><li>    <span class="hljs-type">float</span>* arg1; <span class="hljs-comment">// 参数1</span></li><li>    <span class="hljs-type">float</span>* arg2; <span class="hljs-comment">// 参数2</span></li><li>} user_defined_function;</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">cos_func_wrapper</span><span class="hljs-params">(<span class="hljs-type">void</span>* header)</span></li><li>{</li><li>    user_defined_function* func = (user_defined_function*)header;</li><li>    cos_func(func-&gt;arg1, func-&gt;arg2);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">tan_func_wrapper</span><span class="hljs-params">(<span class="hljs-type">void</span>* header)</span></li><li>{</li><li>    user_defined_function* func = (user_defined_function*)header;</li><li>    tan_func(func-&gt;arg1, func-&gt;arg2);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">(<span class="hljs-type">void</span>* header)</span> {}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-type">float</span> x = <span class="hljs-number">0.5f</span>, y, z;</li><li>
</li><li>    user_defined_function* func1 = (user_defined_function*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>    func1-&gt;header.exec = cos_func_wrapper;</li><li>    func1-&gt;header.destroy = destroy;</li><li>    func1-&gt;arg1 = &amp;x;</li><li>    func1-&gt;arg2 = &amp;y;</li><li>
</li><li>    user_defined_function* func2 = (user_defined_function*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>    func2-&gt;header.exec = tan_func_wrapper;</li><li>    func2-&gt;header.destroy = destroy;</li><li>    func2-&gt;arg1 = &amp;y;</li><li>    func2-&gt;arg2 = &amp;z;</li><li>
</li><li>    <span class="hljs-type">ffrt_dependence_t</span> dependence_x[<span class="hljs-number">1</span>];</li><li>    dependence_x[<span class="hljs-number">0</span>].type = ffrt_dependence_data;</li><li>    dependence_x[<span class="hljs-number">0</span>].ptr = &amp;x;</li><li>    <span class="hljs-type">ffrt_deps_t</span> deps_x;</li><li>    deps_x.len = <span class="hljs-number">1</span>;</li><li>    deps_x.items = dependence_x;</li><li>    <span class="hljs-type">ffrt_dependence_t</span> dependence_y[<span class="hljs-number">1</span>];</li><li>    dependence_y[<span class="hljs-number">0</span>].type = ffrt_dependence_data;</li><li>    dependence_y[<span class="hljs-number">0</span>].ptr = &amp;y;</li><li>    <span class="hljs-type">ffrt_deps_t</span> deps_y;</li><li>    deps_y.len = <span class="hljs-number">1</span>;</li><li>    deps_y.items = dependence_y;</li><li>    <span class="hljs-type">ffrt_dependence_t</span> dependence_z[<span class="hljs-number">1</span>];</li><li>    dependence_z[<span class="hljs-number">0</span>].type = ffrt_dependence_data;</li><li>    dependence_z[<span class="hljs-number">0</span>].ptr = &amp;z;</li><li>    <span class="hljs-type">ffrt_deps_t</span> deps_z;</li><li>    deps_z.len = <span class="hljs-number">1</span>;</li><li>    deps_z.items = dependence_z;</li><li>
</li><li>    ffrt_submit_base((<span class="hljs-type">ffrt_function_header_t</span>*)func1, &amp;deps_x, &amp;deps_y, <span class="hljs-literal">NULL</span>);</li><li>    ffrt_submit_base((<span class="hljs-type">ffrt_function_header_t</span>*)func2, &amp;deps_y, &amp;deps_z, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    ffrt_wait();</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"x = %f, y = %f, z = %f\n"</span>, x, y, z);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li></ul> </div>  <div class="tiledSection"><h3 id="ffrt_submit_f">ffrt_submit_f<i class="anchor-icon anchor-icon-link" anchorid="ffrt_submit_f" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_submit_f</span><span class="hljs-params">(<span class="hljs-type">ffrt_function_t</span> func, <span class="hljs-type">void</span>* arg, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* in_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* out_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>func：指定的任务函数。</li><li>arg：传递给任务函数的参数。</li><li>in_deps：任务的输入数据依赖。输入数据依赖通常以实际数据的地址表达，也支持ffrt_task_handle_t作为一种特殊输入依赖。</li><li>out_deps：任务的输出数据依赖。输出数据依赖通常以实际数据的地址表达，不支持ffrt_task_handle_t。</li><li>attr：任务的属性设置。</li></ul> <p><strong>描述</strong></p> <p>ffrt_submit_f接口是ffrt_submit_base接口的简化包装形式。当任务不需要销毁回调函数时，接口内部将任务函数及其参数包装成通用任务结构，再调用ffrt_submit_base接口提交任务。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 待提交执行的函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnePlusForTest</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (*<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>*&gt;(arg)) += <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">ffrt_submit_f</span>(OnePlusForTest, &amp;a, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    <span class="hljs-built_in">ffrt_wait</span>();</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"a = %d\n"</span>, a);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_submit_h_base">ffrt_submit_h_base<i class="anchor-icon anchor-icon-link" anchorid="ffrt_submit_h_base" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* <span class="hljs-type">ffrt_task_handle_t</span>;</li><li>
</li><li>FFRT_C_API <span class="hljs-type">ffrt_task_handle_t</span> <span class="hljs-title function_">ffrt_submit_h_base</span><span class="hljs-params">(<span class="hljs-type">ffrt_function_header_t</span>* f, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* in_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* out_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>f：用户的任务执行体，可以是原生的ffrt_function_header_t类型，也可以基于ffrt_function_header_t自定义拓展类型。</li><li>in_deps：任务的输入数据依赖。输入数据依赖通常以实际数据的地址表达，也支持ffrt_task_handle_t作为一种特殊输入依赖。</li><li>out_deps：任务的输出数据依赖。输出数据依赖通常以实际数据的地址表达，不支持ffrt_task_handle_t。</li><li>attr：任务的属性设置。</li></ul> <p><strong>返回值</strong></p> <ul><li>ffrt_task_handle_t任务的句柄。</li></ul> <p><strong>描述</strong></p> <p>相比于ffrt_submit_base接口，增加了任务句柄的返回值。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 提交一个任务，获取任务句柄</span></li><li><span class="hljs-type">ffrt_function_header_t</span>* func = (<span class="hljs-type">ffrt_function_header_t</span>*)ffrt_alloc_auto_managed_function_storage_base(ffrt_function_kind_general);</li><li>func-&gt;exec = foo;</li><li>func-&gt;destroy = after_foo;</li><li><span class="hljs-type">ffrt_task_handle_t</span> t = ffrt_submit_h_base(func, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li><span class="hljs-comment">// 注意C API的ffrt_task_handle_t需要用户调用ffrt_task_handle_destroy显式销毁</span></li><li>ffrt_task_handle_destroy(t);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_submit_h_f">ffrt_submit_h_f<i class="anchor-icon anchor-icon-link" anchorid="ffrt_submit_h_f" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* <span class="hljs-type">ffrt_task_handle_t</span>;</li><li>
</li><li>FFRT_C_API <span class="hljs-type">ffrt_task_handle_t</span> <span class="hljs-title function_">ffrt_submit_h_f</span><span class="hljs-params">(<span class="hljs-type">ffrt_function_t</span> func, <span class="hljs-type">void</span>* arg, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* in_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* out_deps, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>func：指定的任务函数。</li><li>arg：传递给任务函数的参数。</li><li>in_deps：任务的输入数据依赖。输入数据依赖通常以实际数据的地址表达，也支持ffrt_task_handle_t作为一种特殊输入依赖。</li><li>out_deps：任务的输出数据依赖。输出数据依赖通常以实际数据的地址表达，不支持ffrt_task_handle_t。</li><li>attr：任务的属性设置。</li></ul> <p><strong>返回值</strong></p> <ul><li>ffrt_task_handle_t任务的句柄。</li></ul> <p><strong>描述</strong></p> <p>相比于ffrt_submit_f接口，增加了任务句柄的返回值。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/task.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 待提交执行的函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnePlusForTest</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (*<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>*&gt;(arg)) += <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task = <span class="hljs-built_in">ffrt_submit_h_f</span>(OnePlusForTest, &amp;a, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">ffrt_dependence_t</span>&gt; wait_deps = {{ffrt_dependence_task, task}};</li><li>    <span class="hljs-type">ffrt_deps_t</span> wait{<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(wait_deps.<span class="hljs-built_in">size</span>()), wait_deps.<span class="hljs-built_in">data</span>()};</li><li>    <span class="hljs-built_in">ffrt_wait_deps</span>(&amp;wait);</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"a = %d\n"</span>, a);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_task_handle_inc_ref">ffrt_task_handle_inc_ref<i class="anchor-icon anchor-icon-link" anchorid="ffrt_task_handle_inc_ref" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">uint32_t</span> <span class="hljs-title function_">ffrt_task_handle_inc_ref</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> handle)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>handle：任务句柄。</li></ul> <p><strong>返回值</strong></p> <ul><li>任务的引用计数。</li></ul> <p><strong>描述</strong></p> <p>通过任务句柄增加对应任务的引用计数，每次调用引用计数加一。用于控制任务的生命周期使用，当引用计数不为零时，对应的任务资源不会被释放。注意ffrt_submit_h_base返回的ffrt_task_handle_t默认已有一个引用计数。通过ffrt_task_handle_destroy销毁ffrt_task_handle_t时默认减去一个引用计数。</p> </div>  <div class="tiledSection"><h3 id="ffrt_task_handle_dec_ref">ffrt_task_handle_dec_ref<i class="anchor-icon anchor-icon-link" anchorid="ffrt_task_handle_dec_ref" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">uint32_t</span> <span class="hljs-title function_">ffrt_task_handle_dec_ref</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> handle)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>handle：任务句柄。</li></ul> <p><strong>返回值</strong></p> <ul><li>任务的引用计数。</li></ul> <p><strong>描述</strong></p> <p>通过任务句柄减去对应任务的引用计数，每次调用引用计数减一。</p> </div>  <div class="tiledSection"><h3 id="ffrt_task_handle_destroy">ffrt_task_handle_destroy<i class="anchor-icon anchor-icon-link" anchorid="ffrt_task_handle_destroy" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_task_handle_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> handle)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>handle：任务句柄。</li></ul> <p><strong>描述</strong></p> <p>销毁任务句柄，同时默认减去一个任务引用计数。</p> </div>  <div class="tiledSection"><h3 id="ffrt_wait">ffrt_wait<i class="anchor-icon anchor-icon-link" anchorid="ffrt_wait" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_wait</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>同步等待所有前序提交的同级任务完成。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 同步三个任务完成</span></li><li>ffrt_submit_base(func1, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>ffrt_submit_base(func2, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>ffrt_submit_base(func3, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>ffrt_wait();</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_wait_deps">ffrt_wait_deps<i class="anchor-icon anchor-icon-link" anchorid="ffrt_wait_deps" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_wait_deps</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_deps_t</span>* deps)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>deps：需要同步的数据依赖。</li></ul> <p><strong>描述</strong></p> <p>同步对应的数据依赖解除。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 构建x的数据依赖</span></li><li><span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">ffrt_dependence_t</span> dependence[<span class="hljs-number">1</span>];</li><li>dependence[<span class="hljs-number">0</span>].type = ffrt_dependence_data;</li><li>dependence[<span class="hljs-number">0</span>].ptr = &amp;x;</li><li><span class="hljs-type">ffrt_deps_t</span> deps;</li><li>deps.len = <span class="hljs-number">1</span>;</li><li>deps.items = dependence;</li><li>
</li><li><span class="hljs-comment">// 提交一个写任务</span></li><li>ffrt_submit_base(func, <span class="hljs-literal">NULL</span>, &amp;deps, <span class="hljs-literal">NULL</span>);</li><li>
</li><li><span class="hljs-comment">// 同步写任务解除数据依赖</span></li><li>ffrt_wait_deps(&amp;deps);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_this_task_update_qos">ffrt_this_task_update_qos<i class="anchor-icon anchor-icon-link" anchorid="ffrt_this_task_update_qos" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_this_task_update_qos</span><span class="hljs-params">(<span class="hljs-type">ffrt_qos_t</span> qos)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>qos：QoS等级。</li></ul> <p><strong>返回值</strong></p> <ul><li>0表示成功，1表示失败。</li></ul> <p><strong>描述</strong></p> <p>在任务执行过程中，动态修改任务的QoS等级。注意该接口在任务的函数闭包内使用，修改的是当前正在执行的任务的QoS等级，接口调用会使任务先挂起一次再恢复执行。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 一个qos_background的任务执行过程中动态修改QoS等级</span></li><li>ffrt::submit([]() {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-type">int</span> ret = ffrt_this_task_update_qos(ffrt_qos_user_initiated);</li><li>    <span class="hljs-comment">// ...</span></li><li>}, ffrt::task_attr().qos(ffrt::qos_background));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_this_task_get_qos">ffrt_this_task_get_qos<i class="anchor-icon anchor-icon-link" anchorid="ffrt_this_task_get_qos" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_qos_t</span> <span class="hljs-title function_">ffrt_this_task_get_qos</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;</li></ol></pre></div></div> <p><strong>返回值</strong></p> <ul><li>QoS等级。</li></ul> <p><strong>描述</strong></p> <p>获取当前正在执行任务的QoS等级。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 一个任务执行过程中动态获取其QoS等级</span></li><li>ffrt::submit([]() {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 获取的qos等于ffrt_qos_background</span></li><li>    <span class="hljs-type">ffrt_qos_t</span> qos = ffrt_this_task_get_qos();</li><li>    <span class="hljs-comment">// ...</span></li><li>}, ffrt::task_attr().qos(ffrt::qos_background));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_this_task_get_id">ffrt_this_task_get_id<i class="anchor-icon anchor-icon-link" anchorid="ffrt_this_task_get_id" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">uint64_t</span> <span class="hljs-title function_">ffrt_this_task_get_id</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;</li></ol></pre></div></div> <p><strong>返回值</strong></p> <ul><li>任务的id。</li></ul> <p><strong>描述</strong></p> <p>获取当前正在执行任务的id。</p> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 一个任务执行过程中动态获取其任务id</span></li><li>ffrt::submit([]() {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 获取的唯一任务id</span></li><li>    <span class="hljs-type">uint64_t</span> task_id = ffrt_this_task_get_id();</li><li>    <span class="hljs-comment">// ...</span></li><li>}, ffrt::task_attr().qos(ffrt::qos_background));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="任务队列">任务队列<i class="anchor-icon anchor-icon-link" anchorid="任务队列" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_queue_attr_t" class="firsth2">ffrt_queue_attr_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_queue_attr_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">uint32_t</span> storage[(ffrt_queue_attr_storage_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];</li><li>} <span class="hljs-type">ffrt_queue_attr_t</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>用于配置队列的属性，如 QoS、超时时间、回调函数和最大并发数。</p> <p><strong>方法</strong></p> <p><strong>ffrt_queue_attr_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_queue_attr_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>返回0表示成功，其他值表示失败。</li></ul> <p>描述</p> <ul><li>初始化队列属性对象。</li></ul> <p><strong>ffrt_queue_attr_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>描述</p> <ul><li>销毁队列属性对象。</li></ul> <p><strong>ffrt_queue_attr_set_qos</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_set_qos</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr, <span class="hljs-type">ffrt_qos_t</span> qos)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li><li>qos：QoS等级。</li></ul> <p>描述</p> <ul><li>设置队列的QoS等级。</li></ul> <p><strong>ffrt_queue_attr_get_qos</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_qos_t</span> <span class="hljs-title function_">ffrt_queue_attr_get_qos</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>返回当前QoS等级。</li></ul> <p>描述</p> <ul><li>获取当前属性中设置的QoS等级。</li></ul> <p><strong>ffrt_queue_attr_set_timeout</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_set_timeout</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr, <span class="hljs-type">uint64_t</span> timeout_us)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li><li>timeout_us：超时时间（微秒）。</li></ul> <p>描述</p> <ul><li>设置队列的超时时间（以微秒为单位）。</li></ul> <p><strong>ffrt_queue_attr_get_timeout</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">ffrt_queue_attr_get_timeout</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>返回当前超时阈值（微秒）。</li></ul> <p>描述</p> <ul><li>获取当前属性中设置的超时时间。</li></ul> <p><strong>ffrt_queue_attr_set_callback</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_set_callback</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr, <span class="hljs-type">ffrt_function_header_t</span>* f)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li><li>f：是任务执行器的指针，描述了该CPU任务如何执行和销毁。</li></ul> <p>描述</p> <ul><li>设置检测到队列任务超时后执行的回调函数。</li><li>不建议在f中调用exit函数，可能导致未定义行为。</li></ul> <p><strong>ffrt_queue_attr_get_callback</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_function_header_t</span>* <span class="hljs-title function_">ffrt_queue_attr_get_callback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>返回任务执行器的指针，描述了该CPU任务如何执行和销毁。</li></ul> <p>描述</p> <ul><li>获取当前属性中设置的超时回调函数。</li></ul> <p><strong>ffrt_queue_attr_set_max_concurrency</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_set_max_concurrency</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr, <span class="hljs-type">const</span> <span class="hljs-type">int</span> max_concurrency)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li><li>max_concurrency：最大并发数。</li></ul> <p>描述</p> <ul><li>设置队列的最大并发数（仅支持并发队列）。</li></ul> <p><strong>ffrt_queue_attr_get_max_concurrency</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_queue_attr_get_max_concurrency</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>返回当前最大并发数。</li></ul> <p>描述</p> <ul><li>获取当前属性中设置的最大并发数（仅支持并发队列）。</li></ul> <p><strong>ffrt_queue_attr_set_thread_mode</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_attr_set_thread_mode</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_attr_t</span>* attr, <span class="hljs-type">bool</span> mode)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li><li>mode：设置队列任务运行方式。true表示以线程模式运行，false表示以协程模式运行。</li></ul> <p>描述</p> <ul><li>设置队列中的任务是以协程模式还是以线程模式运行。默认以协程模式运行。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_queue_attr_get_thread_mode</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> <span class="hljs-title function_">ffrt_queue_attr_get_thread_mode</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：队列属性指针。</li></ul> <p>返回值</p> <ul><li>true表示以线程模式运行，false表示以协程模式运行。</li></ul> <p>描述</p> <ul><li>获取队列中的任务是以协程模式还是以线程模式运行。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/queue.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">ffrt_queue_attr_t</span> queue_attr;</li><li>    <span class="hljs-comment">// 初始化队列属性，必需</span></li><li>    <span class="hljs-built_in">ffrt_queue_attr_init</span>(&amp;queue_attr);</li><li>
</li><li>    <span class="hljs-built_in">ffrt_queue_attr_set_qos</span>(&amp;queue_attr, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(ffrt_qos_utility));</li><li>
</li><li>    <span class="hljs-built_in">ffrt_queue_attr_set_timeout</span>(&amp;queue_attr, <span class="hljs-number">10000</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li>    std::function&lt;<span class="hljs-type">void</span>()&gt;&amp;&amp; basicFunc = [&amp;x]() { x += <span class="hljs-number">1</span>; };</li><li>    <span class="hljs-type">ffrt_function_header_t</span>* func = <span class="hljs-built_in">ffrt_queue_attr_get_callback</span>(&amp;queue_attr);</li><li>
</li><li>    <span class="hljs-built_in">ffrt_queue_attr_set_callback</span>(&amp;queue_attr, ffrt::<span class="hljs-built_in">create_function_wrapper</span>(basicFunc, ffrt_function_kind_queue));</li><li>    <span class="hljs-comment">// 销毁队列属性，必需</span></li><li>    <span class="hljs-built_in">ffrt_queue_attr_destroy</span>(&amp;queue_attr);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_queue_t">ffrt_queue_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_queue_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* <span class="hljs-type">ffrt_queue_t</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>队列指针，提供一系列C接口支持队列任务的提交、取消、等待和排队任务数量查询。</p> <p><strong>方法</strong></p> <p><strong>ffrt_queue_create</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_queue_t</span> <span class="hljs-title function_">ffrt_queue_create</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_type_t</span> type, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_queue_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>type：队列类型（如ffrt_queue_serial或ffrt_queue_concurrent）。</li><li>name：队列名称。</li><li>attr：队列属性。</li></ul> <p>返回值</p> <ul><li>ffrt_queue_t：成功则返回一个非空的队列句柄；否则返回空指针。</li></ul> <p>描述</p> <ul><li>创建指定类型和名称的队列。</li></ul> <p><strong>ffrt_queue_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：队列的句柄。</li></ul> <p>描述</p> <ul><li>销毁一个队列。</li></ul> <p><strong>ffrt_queue_submit</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_submit</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>, <span class="hljs-type">ffrt_function_header_t</span>* f, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：队列的句柄。</li><li>f：任务执行器的指针，描述了该CPU任务如何执行和销毁。</li><li>attr：任务属性。</li></ul> <p>描述</p> <ul><li>提交任务到队列中。</li></ul> <p><strong>ffrt_queue_submit_f</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_submit_f</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>, <span class="hljs-type">ffrt_function_t</span> func, <span class="hljs-type">void</span>* arg, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：队列的句柄。</li><li>func：指定的任务函数。</li><li>arg：传递给任务函数的参数。</li><li>attr：任务属性。</li></ul> <p>描述</p> <ul><li>当任务不需要销毁回调函数时，提交任务到队列中。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_queue_submit_h</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_task_handle_t</span> <span class="hljs-title function_">ffrt_queue_submit_h</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>, <span class="hljs-type">ffrt_function_header_t</span>* f, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：队列的句柄。</li><li>f：任务执行器的指针，描述了该CPU任务如何执行和销毁。</li><li>attr：任务属性。</li></ul> <p>返回值</p> <ul><li>ffrt_task_handle_t：成功则返回一个非空的任务句柄；否则返回空指针。</li></ul> <p>描述</p> <ul><li>提交任务到队列中，并返回任务句柄。</li></ul> <p><strong>ffrt_queue_submit_h_f</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_task_handle_t</span> <span class="hljs-title function_">ffrt_queue_submit_h_f</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>, <span class="hljs-type">ffrt_function_t</span> func, <span class="hljs-type">void</span>* arg, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_task_attr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：队列的句柄。</li><li>func：指定的任务函数。</li><li>arg：传递给任务函数的参数。</li><li>attr：任务属性。</li></ul> <p>返回值</p> <ul><li>ffrt_task_handle_t：成功则返回一个非空的任务句柄；否则返回空指针。</li></ul> <p>描述</p> <ul><li>当任务不需要销毁回调函数时，提交任务到队列中，并返回任务句柄。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_queue_wait</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_queue_wait</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> handle)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>ffrt_task_handle_t：任务句柄。</li></ul> <p>描述</p> <ul><li>等待一个队列任务完成。</li></ul> <p><strong>ffrt_queue_cancel</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_queue_cancel</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> handle)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>ffrt_task_handle_t：任务句柄。</li></ul> <p>返回值</p> <ul><li>返回0表示成功，其他值表示失败。</li></ul> <p>描述</p> <ul><li>取消一个队列任务。</li></ul> <p><strong>ffrt_get_main_queue</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_queue_t</span> <span class="hljs-title function_">ffrt_get_main_queue</span><span class="hljs-params">()</span>;</li></ol></pre></div></div> <p>返回值</p> <ul><li>主线程队列。</li></ul> <p>描述</p> <ul><li>获取主线程队列，用于FFRT线程与主线程通信。</li></ul> <p><strong>ffrt_get_current_queue</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_queue_t</span> <span class="hljs-title function_">ffrt_get_current_queue</span><span class="hljs-params">()</span>;</li></ol></pre></div></div> <p>返回值</p> <ul><li>ArkTS Worker线程任务队列。</li></ul> <p>描述</p> <ul><li>此接口已于API 18版本后废弃，不建议继续使用。</li><li>获取ArkTS Worker线程队列，用于FFRT线程与ArkTS Worker线程通信。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/queue.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">ffrt_queue_attr_t</span> queue_attr;</li><li>    <span class="hljs-comment">// 1、初始化队列属性，必需</span></li><li>    (<span class="hljs-type">void</span>)<span class="hljs-built_in">ffrt_queue_attr_init</span>(&amp;queue_attr);</li><li>
</li><li>    <span class="hljs-comment">// 2、创建串行队列，并返回队列句柄queue_handle</span></li><li>    <span class="hljs-type">ffrt_queue_t</span> queue_handle = <span class="hljs-built_in">ffrt_queue_create</span>(ffrt_queue_serial, <span class="hljs-string">"test_queue"</span>, &amp;queue_attr);</li><li>
</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;</li><li>    std::function&lt;<span class="hljs-type">void</span>()&gt;&amp;&amp; basicFunc = [&amp;result]() { result += <span class="hljs-number">1</span>; };</li><li>
</li><li>    <span class="hljs-comment">// 3、提交串行任务</span></li><li>    <span class="hljs-built_in">ffrt_queue_submit</span>(queue_handle, ffrt::<span class="hljs-built_in">create_function_wrapper</span>(basicFunc, ffrt_function_kind_queue), <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 4、提交串行任务，并返回任务句柄</span></li><li>    <span class="hljs-type">ffrt_task_handle_t</span> t1 = <span class="hljs-built_in">ffrt_queue_submit_h</span>(queue_handle, ffrt::<span class="hljs-built_in">create_function_wrapper</span>(basicFunc, ffrt_function_kind_queue), <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 5、等待指定任务执行完成</span></li><li>    <span class="hljs-built_in">ffrt_queue_wait</span>(t1);</li><li>
</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> t2 = <span class="hljs-built_in">ffrt_queue_submit_h</span>(queue_handle, ffrt::<span class="hljs-built_in">create_function_wrapper</span>(basicFunc, ffrt_function_kind_queue), <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 6、取消句柄为 t2 的任务</span></li><li>    <span class="hljs-built_in">ffrt_queue_cancel</span>(t2);</li><li>
</li><li>    <span class="hljs-comment">// 7、销毁提交给串行队列任务的句柄 t1 和 t2，必需</span></li><li>    <span class="hljs-built_in">ffrt_task_handle_destroy</span>(t1);</li><li>    <span class="hljs-built_in">ffrt_task_handle_destroy</span>(t2);</li><li>    <span class="hljs-comment">// 8、销毁队列属性，必需</span></li><li>    <span class="hljs-built_in">ffrt_queue_attr_destroy</span>(&amp;queue_attr);</li><li>    <span class="hljs-comment">// 9、销毁队列句柄，必需</span></li><li>    <span class="hljs-built_in">ffrt_queue_destroy</span>(queue_handle);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="同步原语">同步原语<i class="anchor-icon anchor-icon-link" anchorid="同步原语" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_mutexattr_t" class="firsth2">ffrt_mutexattr_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_mutexattr_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    ffrt_error = <span class="hljs-number">-1</span>,</li><li>    ffrt_success = <span class="hljs-number">0</span>,</li><li>    ffrt_error_nomem = ENOMEM,</li><li>    ffrt_error_timedout = ETIMEDOUT,</li><li>    ffrt_error_busy = EBUSY,</li><li>    ffrt_error_inval = EINVAL</li><li>} <span class="hljs-type">ffrt_error_t</span>;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    ffrt_mutex_normal = <span class="hljs-number">0</span>,</li><li>    ffrt_mutex_recursive = <span class="hljs-number">2</span>,</li><li>    ffrt_mutex_default = ffrt_mutex_normal</li><li>} ffrt_mutex_type;</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_mutexattr_t</span>;</span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_settype</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr, <span class="hljs-type">int</span> type)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_gettype</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr, <span class="hljs-type">int</span>* type)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>FFRT提供的类似pthread mutexattr的性能实现。</li></ul> <p><strong>方法</strong></p> <p><strong>ffrt_mutexattr_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：FFRT锁属性。</li></ul> <p>返回值</p> <ul><li>attr不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>初始化mutexattr。</li></ul> <p><strong>ffrt_mutexattr_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：FFRT锁属性。</li></ul> <p>返回值</p> <ul><li>attr不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>销毁mutexattr。</li></ul> <p><strong>ffrt_mutexattr_settype</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_settype</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr, <span class="hljs-type">int</span> type)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：FFRT锁属性。</li><li>type：FFRT锁类型，当前仅支持互斥锁ffrt_mutex_normal和递归锁ffrt_mutex_recursive。</li></ul> <p>返回值</p> <ul><li>attr不为空且type有效返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>设置FFRT锁属性。</li></ul> <p><strong>ffrt_mutexattr_gettype</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutexattr_gettype</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutexattr_t</span>* attr, <span class="hljs-type">int</span>* type)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>attr：FFRT锁属性。</li><li>type：FFRT锁类型指针。</li></ul> <p>返回值</p> <ul><li>attr和type均不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>获取FFRT锁属性。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ffrt_mutexattr_t</span> attr;</li><li><span class="hljs-comment">// 初始化锁属性</span></li><li>ffrt_mutexattr_init(&amp;attr);</li><li><span class="hljs-comment">// 设置为互斥锁</span></li><li>ffrt_mutexattr_settype(&amp;attr, ffrt_mutex_normal);</li><li><span class="hljs-comment">// 设置为递归锁</span></li><li>ffrt_mutexattr_settype(&amp;attr, ffrt_mutex_recursive);</li><li><span class="hljs-comment">// 获取锁类型</span></li><li><span class="hljs-type">int</span> type = ffrt_mutex_default;</li><li>ffrt_mutexattr_gettype(&amp;attr, &amp;type);</li><li><span class="hljs-comment">// 销毁锁属性</span></li><li>ffrt_mutexattr_destroy(&amp;attr);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_mutex_t">ffrt_mutex_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_mutex_t" tips="复制节点链接"></i></h3><ul><li>FFRT提供的类似pthread_mutex_t的性能实现，但不支持类似PTHREAD_MUTEX_INITIALIZER的初始化。</li></ul> <p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_mutex_t</span>;</span></li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_mutexattr_t</span>;</span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_lock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_unlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_trylock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>该接口支持在FFRT任务内部调用，也支持在FFRT任务外部调用。</li><li>该接口能够避免pthread传统的pthread_mutex_t在抢不到锁时陷入内核态的问题，在使用得当的条件下将会有更好的性能。</li><li>C API中的ffrt_mutexattr_t需要用户调用ffrt_mutexattr_init和ffrt_mutexattr_destroy显示创建和销毁，否则其行为是未定义的。</li><li>C API中的ffrt_mutex_t需要用户调用ffrt_mutex_init和ffrt_mutex_destroy显式创建和销毁，否则其行为是未定义的。</li><li>C API中的ffrt_mutex_t对象的置空和销毁由用户完成，对同一个ffrt_mutex_t仅能调用一次ffrt_mutex_destroy，重复对同一个ffrt_mutex_t调用ffrt_mutex_destroy，其行为是未定义的。</li><li>C API中的同一个ffrt_mutexattr_t只能调用一次ffrt_mutexattr_init和ffrt_mutexattr_destroy，重复调用其行为是未定义的。</li><li>用户需要在调用ffrt_mutex_init之后和调用ffrt_mutex_destroy之前显示调用ffrt_mutexattr_destroy。</li><li>在ffrt_mutex_destroy之后再对ffrt_mutex_t进行访问，其行为是未定义的。</li></ul> <p><strong>方法</strong></p> <p><strong>ffrt_mutex_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_mutexattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>mutex：指向所操作的锁指针。</li><li>attr：FFRT锁属性，attr的有效值范围是：空指针或等于ffrt_mutex_normal代表互斥锁，ffrt_mutex_recursive代表递归锁。</li></ul> <p>返回值</p> <ul><li>如果mutex不为空且attr在有效值范围内返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>初始化FFRT锁。</li></ul> <p><strong>ffrt_mutex_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>mutex：指向所操作的锁指针。</li></ul> <p>返回值</p> <ul><li>mutex不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的互斥锁/递归锁进行销毁操作。</li></ul> <p><strong>ffrt_mutex_lock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_lock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>mutex：指向所操作的锁指针。</li></ul> <p>返回值</p> <ul><li>mutex不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的互斥锁/递归锁进行加锁操作，该方法会阻塞当前任务直到能成功获得锁。</li></ul> <p><strong>ffrt_mutex_unlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_unlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>mutex：指向所操作的锁指针。</li></ul> <p>返回值</p> <ul><li>mutex不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的互斥锁/递归锁进行解锁操作。</li></ul> <p><strong>ffrt_mutex_trylock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_mutex_trylock</span><span class="hljs-params">(<span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>mutex：指向所操作的锁指针。</li></ul> <p>返回值</p> <ul><li>mutex为空返回ffrt_error_inval，mutex不为空且持锁成功返回ffrt_success，mutex不为空且持锁失败返回ffrt_error_busy。</li></ul> <p>描述</p> <ul><li>对指定的互斥锁/递归锁进行尝试加锁操作。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/mutex.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">ffrt_mutexattr_t</span> attr;</li><li>    <span class="hljs-type">ffrt_mutex_t</span> lock;</li><li>    <span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int</span> type = ffrt_mutex_default;</li><li>    <span class="hljs-built_in">ffrt_mutexattr_init</span>(&amp;attr);</li><li>    <span class="hljs-built_in">ffrt_mutexattr_settype</span>(&amp;attr, ffrt_mutex_recursive);</li><li>    <span class="hljs-built_in">ffrt_mutexattr_gettype</span>(&amp;attr, &amp;type);</li><li>    <span class="hljs-built_in">ffrt_mutex_init</span>(&amp;lock, &amp;attr);</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_mutex_lock</span>(&amp;lock);</li><li>        <span class="hljs-built_in">ffrt_mutex_trylock</span>(&amp;lock);</li><li>        sum++;</li><li>        <span class="hljs-built_in">ffrt_mutex_lock</span>(&amp;lock);</li><li>        <span class="hljs-built_in">ffrt_mutex_trylock</span>(&amp;lock);</li><li>        sum++;</li><li>        <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock);</li><li>        <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock);</li><li>        <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock);</li><li>        <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock);</li><li>        }, {}, {});</li><li>
</li><li>    ffrt::<span class="hljs-built_in">wait</span>();</li><li>
</li><li>    <span class="hljs-built_in">ffrt_mutexattr_destroy</span>(&amp;attr);</li><li>    <span class="hljs-built_in">ffrt_mutex_destroy</span>(&amp;lock);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_rwlock_t">ffrt_rwlock_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_rwlock_t" tips="复制节点链接"></i></h3><ul><li>FFRT提供的类似pthread_rwlock_t的性能实现。</li></ul> <p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_rwlock_t</span>;</span></li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_rwlockattr_t</span>;</span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_rwlockattr_t</span>* attr)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_wrlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_rdlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_trywrlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_tryrdlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_unlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>该接口支持在FFRT任务内部调用，也支持在FFRT任务外部调用。</li><li>该接口能够避免pthread传统的pthread_rwlock_t在ffrt使用场景下睡眠不释放线程的问题，在使用得当的条件下将会有更好的性能。</li><li>C API中的ffrt_rwlock_t需要用户调用ffrt_rwlock_init和ffrt_rwlock_destroy显式创建和销毁，否则其行为是未定义的。</li><li>C API中的ffrt_rwlockattr_t需要用户调用ffrt_rwlock_init时此参数传参必须为空指针。</li><li>C API中的ffrt_rwlock_t对象的置空和销毁由用户完成，对同一个ffrt_rwlock_t仅能调用一次ffrt_rwlock_destroy，重复对同一个ffrt_rwlock_t调用ffrt_rwlock_destroy，其行为是未定义的。</li><li>在ffrt_rwlock_destroy之后再对ffrt_rwlock_t进行访问，其行为是未定义的。</li></ul> <p><strong>方法</strong></p> <p><strong>ffrt_rwlock_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_rwlockattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li><li>attr：指向所操作的读写锁属性指针，仅支持默认模式，即attr设定为空指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空，且attr为空则返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>初始化读写锁。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_wrlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_wrlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定读写锁加写锁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_rdlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_rdlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定读写锁加读锁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_trywrlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_trywrlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空且没有其他线程持有读写锁返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的读写锁进行尝试加写锁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_tryrdlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_tryrdlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空且没有其他线程持有写锁则返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的读写锁进行尝试加读锁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_unlock</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_unlock</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的读写锁进行解锁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_rwlock_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_rwlock_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_rwlock_t</span>* rwlock)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>rwlock：指向所操作的读写锁指针。</li></ul> <p>返回值</p> <ul><li>rwlock不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>对指定的读写锁进行销毁操作。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 18开始，支持该接口。</p>  </div></div></div> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/shared_mutex.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/sleep.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">ffrt_rwlock_t</span> rwlock;</li><li>    <span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">ffrt_rwlock_init</span>(&amp;rwlock, <span class="hljs-literal">nullptr</span>);</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_rwlock_wrlock</span>(&amp;rwlock);</li><li>        <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">10</span>);</li><li>        x++;</li><li>        <span class="hljs-built_in">ffrt_rwlock_unlock</span>(&amp;rwlock);</li><li>    },{},{});</li><li>
</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">2</span>);</li><li>        <span class="hljs-built_in">ffrt_rwlock_rdlock</span>(&amp;rwlock);</li><li>        <span class="hljs-built_in">ffrt_rwlock_unlock</span>(&amp;rwlock);</li><li>    },{},{});</li><li>
</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">2</span>);</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">ffrt_rwlock_trywrlock</span>(&amp;rwlock)){</li><li>            x++;</li><li>            <span class="hljs-built_in">ffrt_rwlock_unlock</span>(&amp;rwlock);</li><li>        }</li><li>    },{},{});</li><li>
</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">2</span>);</li><li>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">ffrt_rwlock_tryrdlock</span>(&amp;rwlock)){</li><li>            <span class="hljs-built_in">ffrt_rwlock_unlock</span>(&amp;rwlock);</li><li>        }</li><li>    },{},{});</li><li>
</li><li>    ffrt::<span class="hljs-built_in">wait</span>();</li><li>
</li><li>    <span class="hljs-built_in">ffrt_rwlock_destroy</span>(&amp;rwlock);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="ffrt_cond_t">ffrt_cond_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_cond_t" tips="复制节点链接"></i></h3><ul><li>FFRT提供的类似pthread信号量的性能实现，但不支持类似PTHREAD_COND_INITIALIZER的初始化。</li></ul> <p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    ffrt_error = <span class="hljs-number">-1</span>,</li><li>    ffrt_success = <span class="hljs-number">0</span>,</li><li>    ffrt_error_nomem = ENOMEM,</li><li>    ffrt_error_timedout = ETIMEDOUT,</li><li>    ffrt_error_busy = EBUSY,</li><li>    ffrt_error_inval = EINVAL</li><li>} <span class="hljs-type">ffrt_error_t</span>;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-type">uint32_t</span> storage[(ffrt_cond_storage_size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>) - <span class="hljs-number">1</span>) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];</li><li>} <span class="hljs-type">ffrt_cond_t</span>;</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_condattr_t</span>* attr)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_signal</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_broadcast</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_wait</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>*cond, <span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_timedwait</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond, <span class="hljs-type">ffrt_mutex_t</span>* mutex, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec* time_point)</span>;</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>该接口支持在FFRT任务内部调用，也支持在FFRT任务外部调用。</li><li>该功能能够避免传统的pthread_cond_t在条件不满足时陷入内核的问题，在使用得当的条件下将会有更好的性能。</li><li>注意：C API 中的ffrt_cond_t需要用户调用ffrt_cond_init和ffrt_cond_destroy显式创建和销毁，而C++ API 中依赖构造和析构自动完成。</li><li>注意：C API 中的ffrt_cond_t对象的置空和销毁由用户完成，对同一个ffrt_cond_t仅能调用一次ffrt_cond_destroy，重复对同一个ffrt_cond_t调用ffrt_cond_destroy，其行为是未定义的。</li><li>注意：在ffrt_cond_destroy之后再对ffrt_cond_t进行访问，其行为是未定义的。</li></ul> <p><strong>方法</strong></p> <p><strong>ffrt_cond_init</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond, <span class="hljs-type">const</span> <span class="hljs-type">ffrt_condattr_t</span>* attr)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li><li>attr：属性设定，空指针表示使用默认属性。</li></ul> <p>返回值</p> <ul><li>cond不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>初始化FFRT条件变量。</li></ul> <p><strong>ffrt_cond_destroy</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li></ul> <p>返回值</p> <ul><li>cond不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>销毁FFRT条件变量。</li></ul> <p><strong>ffrt_cond_signal</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_signal</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li></ul> <p>返回值</p> <ul><li>cond不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>该方法用于唤醒一个等待条件变量的任务。</li></ul> <p><strong>ffrt_cond_broadcast</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_broadcast</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li></ul> <p>返回值</p> <ul><li>cond不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>该方法用于唤醒所有等待条件变量的任务。</li></ul> <p><strong>ffrt_cond_wait</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_wait</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond, <span class="hljs-type">ffrt_mutex_t</span>* mutex)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li><li>mutex：指向要在阻塞期间解锁的互斥锁的指针。</li></ul> <p>返回值</p> <ul><li>cond和mutex均不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>方法用于在条件变量上等待。任务在调用该方法时会释放传入的互斥量，并进入等待状态，直到另一个任务通知条件变量，才会重新获取互斥量并继续执行。</li><li>此方法通常与ffrt_mutex_lock或ffrt_mutex_trylock一起使用，确保在进入等待状态之前已经持有互斥量。</li></ul> <p><strong>ffrt_cond_timedwait</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_cond_timedwait</span><span class="hljs-params">(<span class="hljs-type">ffrt_cond_t</span>* cond, <span class="hljs-type">ffrt_mutex_t</span>* mutex, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec* time_point)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>cond：指向所操作的信号量的指针。</li><li>mutex：指向要在阻塞期间解锁的互斥锁的指针。</li><li>time_point：指向指定等待时限时间的对象的指针。</li></ul> <p>返回值</p> <ul><li>cond和mutex和time_point均不为空返回ffrt_success，否则返回ffrt_error_inval。</li></ul> <p>描述</p> <ul><li>该方法用于在条件变量上等待，直到指定的超时时间到达。</li><li>与ffrt_cond_wait不同，ffrt_cond_timedwait方法允许任务在条件变量上等待一段时间，如果在指定时间内没有收到通知，任务将被唤醒该函数返回。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/condition_variable.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/mutex.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/sleep.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> <span class="hljs-built_in">timeoutms_to_tm</span>(<span class="hljs-type">int</span> timeout_ms) {</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> ts;</li><li>    <span class="hljs-built_in">clock_gettime</span>(CLOCK_REALTIME, &amp;ts);</li><li>    ts.tv_sec += timeout_ms / <span class="hljs-number">1000</span>;</li><li>    ts.tv_nsec += (timeout_ms % <span class="hljs-number">1000</span>) * <span class="hljs-number">1000000</span>;</li><li>    <span class="hljs-keyword">if</span> (ts.tv_nsec &gt;= <span class="hljs-number">1000000000</span>) {</li><li>        ts.tv_sec += <span class="hljs-number">1</span>;</li><li>        ts.tv_nsec -= <span class="hljs-number">1000000000</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ts;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">ffrt_cond_t</span> cond;</li><li>    <span class="hljs-type">ffrt_mutex_t</span> lock_;</li><li>    <span class="hljs-built_in">ffrt_cond_init</span>(&amp;cond, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">ffrt_mutex_init</span>(&amp;lock_, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {</li><li>        ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>            <span class="hljs-type">int</span> timeout = <span class="hljs-number">2000</span>;</li><li>            <span class="hljs-keyword">struct</span> timespec tm = <span class="hljs-built_in">timeoutms_to_tm</span>(timeout);</li><li>            <span class="hljs-built_in">ffrt_mutex_lock</span>(&amp;lock_);</li><li>            <span class="hljs-keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();</li><li>            <span class="hljs-built_in">ffrt_cond_timedwait</span>(&amp;cond, &amp;lock_, &amp;tm);</li><li>            <span class="hljs-keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();</li><li>            a = <span class="hljs-number">123</span>;</li><li>            <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock_);</li><li>            std::chrono::duration&lt;<span class="hljs-type">double</span>, std::milli&gt; elapsed = end - start;</li><li>            <span class="hljs-type">double</span> t = elapsed.<span class="hljs-built_in">count</span>();</li><li>            std::cout &lt;&lt; <span class="hljs-string">"ffrt_cond_timedwait "</span> &lt;&lt; t &lt;&lt; <span class="hljs-string">" ms"</span> &lt;&lt; std::endl;</li><li>            }, {}, {});</li><li>    }</li><li>
</li><li>    ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>        <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>);</li><li>        <span class="hljs-built_in">ffrt_mutex_lock</span>(&amp;lock_);</li><li>        a = <span class="hljs-number">5</span>;</li><li>        <span class="hljs-built_in">ffrt_cond_broadcast</span>(&amp;cond);</li><li>        <span class="hljs-built_in">ffrt_mutex_unlock</span>(&amp;lock_);</li><li>        }, {}, {});</li><li>    ffrt::<span class="hljs-built_in">wait</span>();</li><li>    <span class="hljs-built_in">ffrt_cond_destroy</span>(&amp;cond);</li><li>    <span class="hljs-built_in">ffrt_mutex_destroy</span>(&amp;lock_);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="阻塞原语">阻塞原语<i class="anchor-icon anchor-icon-link" anchorid="阻塞原语" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_usleep" class="firsth2">ffrt_usleep<i class="anchor-icon anchor-icon-link" anchorid="ffrt_usleep" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_usleep</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> usec)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>usec：睡眠的微秒数。</li></ul> <p><strong>描述</strong></p> <ul><li>该接口支持在FFRT任务内部调用，也支持在FFRT任务外部调用。</li><li>FFRT提供的类似C11 sleep和Linux usleep的性能实现。</li><li>该接口睡眠精度为微秒。</li><li>该功能能够避免传统的sleep睡眠时陷入内核的问题，在使用得当的条件下将会有更好的性能。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/sleep.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    ffrt::<span class="hljs-built_in">submit</span>([=]() { <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">10</span>); }, {}, {});</li><li>    ffrt::<span class="hljs-built_in">wait</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="协同原语">协同原语<i class="anchor-icon anchor-icon-link" anchorid="协同原语" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_yield" class="firsth2">ffrt_yield<i class="anchor-icon anchor-icon-link" anchorid="ffrt_yield" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_yield</span><span class="hljs-params">()</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>该接口支持在FFRT任务内部调用，也支持在FFRT任务外部调用。</li><li>当前任务主动让出CPU执行资源，允许其他可执行的任务运行，如果没有其他可执行的任务，yield无效。</li><li>此函数的确切行为取决于实现，特别是使用中的FFRT调度程序的机制和系统状态。</li></ul> <p><strong>样例</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/sleep.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> count = <span class="hljs-number">12</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {</li><li>        ffrt::<span class="hljs-built_in">submit</span>([&amp;]() {</li><li>            <span class="hljs-built_in">ffrt_usleep</span>(<span class="hljs-number">100</span>);</li><li>            std::cout &lt;&lt; <span class="hljs-string">"test"</span> &lt;&lt; std::endl;</li><li>            <span class="hljs-built_in">ffrt_yield</span>();</li><li>        }, {}, {});</li><li>    }</li><li>    ffrt::<span class="hljs-built_in">wait</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="定时器">定时器<i class="anchor-icon anchor-icon-link" anchorid="定时器" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_timer_t" class="firsth2">ffrt_timer_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_timer_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> <span class="hljs-type">ffrt_timer_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*ffrt_timer_cb)</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>提供定时器相关的功能。</p> <p><strong>方法</strong></p> <p><strong>ffrt_timer_start</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_timer_t</span> <span class="hljs-title function_">ffrt_timer_start</span><span class="hljs-params">(<span class="hljs-type">ffrt_qos_t</span> qos, <span class="hljs-type">uint64_t</span> timeout, <span class="hljs-type">void</span>* data, ffrt_timer_cb cb, <span class="hljs-type">bool</span> repeat)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>qos：QoS等级。</li><li>timeout：定时器时间，单位是毫秒。</li><li>cb：到期后的回调函数。</li><li>data：回调函数的输入参数。</li><li>repeat：是否循环定时器。</li></ul> <p>返回值</p> <ul><li>ffrt_timer_t定时器句柄。</li></ul> <p>描述</p> <ul><li>启动一个定时器，定时器到期且未被取消的话，执行回调函数。如果设置repeat为true，定时器到期后会重复设置。</li><li>不建议在cb中调用exit函数，可能导致未定义行为。</li></ul> <p><strong>ffrt_timer_stop</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_timer_stop</span><span class="hljs-params">(<span class="hljs-type">ffrt_qos_t</span> qos, <span class="hljs-type">ffrt_timer_t</span> handle)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>qos：QoS等级。</li><li>handle：定时器句柄。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>取消一个定时器，和ffrt_timer_start配对使用。</li><li>为阻塞接口，请避免在回调函数callback内使用，防止死锁或同步问题，当传入的handle对应的callback正在执行时，该函数会等待callback完成后再继续执行。</li></ul> <p><strong>样例</strong></p> <ul><li><p>样例1：使用单次定时器：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/timer.h"</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">test_fun</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></li><li>{</li><li>    *(<span class="hljs-type">int</span> *)data += <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> (*cb)(<span class="hljs-type">void</span> *) = test_fun;</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">void</span> *data = &amp;x;</li><li>    <span class="hljs-type">uint64_t</span> timeout = <span class="hljs-number">200</span>;</li><li>    <span class="hljs-comment">// 启动定时器，在200ms后执行回调函数</span></li><li>    <span class="hljs-type">int</span> handle = ffrt_timer_start(ffrt_qos_default, timeout, data, cb, <span class="hljs-literal">false</span>);</li><li>    usleep(<span class="hljs-number">300000</span>);</li><li>    <span class="hljs-comment">// 定时器已经执行，取消无效</span></li><li>    ffrt_timer_stop(ffrt_qos_default, handle);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"data: %d\n"</span>, x); <span class="hljs-comment">// x值变成1</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>样例2：使用循环定时器：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/timer.h"</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">test_fun</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></li><li>{</li><li>    *(<span class="hljs-type">int</span> *)data += <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> (*cb)(<span class="hljs-type">void</span> *) = test_fun;</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">void</span> *data = &amp;x;</li><li>    <span class="hljs-type">uint64_t</span> timeout = <span class="hljs-number">200</span>;</li><li>    <span class="hljs-comment">// 启动循环定时器，每间隔200ms执行回调函数</span></li><li>    <span class="hljs-type">int</span> handle = ffrt_timer_start(ffrt_qos_default, timeout, data, cb, <span class="hljs-literal">true</span>);</li><li>    usleep(<span class="hljs-number">500000</span>);</li><li>    <span class="hljs-comment">// 取消循环定时器</span></li><li>    ffrt_timer_stop(ffrt_qos_default, handle);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"data: %d\n"</span>, x); <span class="hljs-comment">// x的值变成2</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li></ul> </div>  <div class="tiledSection"><h2 id="循环">循环<i class="anchor-icon anchor-icon-link" anchorid="循环" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_loop_t" class="firsth2">ffrt_loop_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_loop_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>* <span class="hljs-type">ffrt_loop_t</span>;</li></ol></pre></div></div> <p><strong>描述</strong></p> <p>提供循环相关的功能。</p> <p><strong>方法</strong></p> <p><strong>ffrt_loop_create</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_loop_t</span> <span class="hljs-title function_">ffrt_loop_create</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span>)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>queue：loop需要绑定一个FFRT并发队列使用。</li></ul> <p>返回值</p> <ul><li>ffrt_loop_t对象。</li></ul> <p>描述</p> <ul><li>创建一个loop，需要绑定一个并发队列存储任务，用户可以向队列中提交任务使其在loop中执行。</li></ul> <p><strong>ffrt_loop_destroy</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_loop_destroy</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>销毁一个loop，同时和队列解除绑定。</li></ul> <p><strong>ffrt_loop_run</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_loop_run</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>启动一个loop，调用此方法的线程会同步执行loop，在loop中会执行队列的任务、监听poller事件触发、监听timer定时器触发。</li></ul> <p><strong>ffrt_loop_stop</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_loop_stop</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li></ul> <p>描述</p> <ul><li>停止一个loop，调用此方法使执行loop的线程退出循环。</li></ul> <p><strong>ffrt_loop_epoll_ctl</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_loop_epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-type">uint32_t</span> events, <span class="hljs-type">void</span> *data, ffrt_poller_cb cb)</span></li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li><li>op：fd操作符，参考epoll_ctl的操作类型。</li><li>fd：事件描述符。</li><li>events：事件，参考epoll_ctl的事件类型。</li><li>data：回调函数的入参。</li><li>cb：回调函数。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>管理loop上的监听fd事件，事件的监听和回调执行在loop线程上处理。</li><li>不建议在cb中调用exit函数，可能导致未定义行为。</li></ul> <p><strong>ffrt_loop_timer_start</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">ffrt_timer_t</span> <span class="hljs-title function_">ffrt_loop_timer_start</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop, <span class="hljs-type">uint64_t</span> timeout, <span class="hljs-type">void</span>* data, ffrt_timer_cb cb, <span class="hljs-type">bool</span> repeat)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li><li>timeout：定时器时间，单位是毫秒。</li><li>cb：到期后的回调函数。</li><li>data：回调函数的输入参数。</li><li>repeat：是否循环定时器。</li></ul> <p>返回值</p> <ul><li>ffrt_timer_t定时器句柄。</li></ul> <p>描述</p> <ul><li>在loop上启动一个定时器，用法和ffrt_timer_start一致，只是定时器的监听和回调执行在loop线程上处理。</li><li>不建议在cb中调用exit函数，可能导致未定义行为。</li></ul> <p><strong>ffrt_loop_timer_stop</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_loop_timer_stop</span><span class="hljs-params">(<span class="hljs-type">ffrt_loop_t</span> loop, <span class="hljs-type">ffrt_timer_t</span> handle)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>loop：loop对象。</li><li>handle：定时器句柄。</li></ul> <p>返回值</p> <ul><li>0表示成功，-1表示失败。</li></ul> <p>描述</p> <ul><li>取消一个定时器，用法和ffrt_timer_stop一致。</li></ul> <p><strong>样例</strong></p> <ul><li><p>样例1：循环与并发队列：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/loop.h"</span></span></li><li>
</li><li><span class="hljs-type">void</span>* <span class="hljs-title function_">ThreadFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span></li><li>{</li><li>    <span class="hljs-type">int</span> ret = ffrt_loop_run(p);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"loop normal operation."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-comment">// 创建并发队列</span></li><li>    <span class="hljs-type">ffrt_queue_attr_t</span> queue_attr;</li><li>    (<span class="hljs-type">void</span>)ffrt_queue_attr_init(&amp;queue_attr);</li><li>    <span class="hljs-type">ffrt_queue_t</span> queue_handle = ffrt_queue_create(ffrt_queue_concurrent, <span class="hljs-string">"test_queue"</span>, &amp;queue_attr);</li><li>
</li><li>    <span class="hljs-comment">// 创建loop</span></li><li>    <span class="hljs-type">ffrt_loop_t</span> loop = ffrt_loop_create(queue_handle);</li><li>
</li><li>    <span class="hljs-comment">// 启动独立线程来执行loop</span></li><li>    <span class="hljs-type">pthread_t</span> thread;</li><li>    <span class="hljs-type">int</span> ret = pthread_create(&amp;thread, <span class="hljs-number">0</span>, ThreadFunc, loop);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pthread_create failed!"</span>);</li><li>        ffrt_loop_destroy(loop);</li><li>        ffrt_queue_attr_destroy(&amp;queue_attr);</li><li>        ffrt_queue_destroy(queue_handle);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 终止并销毁loop</span></li><li>    ffrt_loop_stop(loop);</li><li>    ffrt_loop_destroy(loop);</li><li>
</li><li>    <span class="hljs-comment">// 销毁并发队列</span></li><li>    ffrt_queue_attr_destroy(&amp;queue_attr);</li><li>    ffrt_queue_destroy(queue_handle);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>样例2：循环、并发队列和定时器：</p>  <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/eventfd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/loop.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/cpp/task.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">ThreadFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">ffrt_loop_run</span>(p);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">test_fun</span><span class="hljs-params">(<span class="hljs-type">void</span>* data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    *(<span class="hljs-type">int</span>*)data += <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-title">void</span> <span class="hljs-params">(*cb)</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span> </span>= test_fun;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testCallBack</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> events)</span> </span>{}</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">TestData</span> {</li><li>    <span class="hljs-type">int</span> fd;</li><li>    <span class="hljs-type">uint64_t</span> expected;</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建并发队列</span></li><li>    <span class="hljs-type">ffrt_queue_attr_t</span> queue_attr;</li><li>    (<span class="hljs-type">void</span>)<span class="hljs-built_in">ffrt_queue_attr_init</span>(&amp;queue_attr);</li><li>    <span class="hljs-type">ffrt_queue_t</span> queue_handle = <span class="hljs-built_in">ffrt_queue_create</span>(ffrt_queue_concurrent, <span class="hljs-string">"test_queue"</span>, &amp;queue_attr);</li><li>
</li><li>    <span class="hljs-comment">// 创建loop</span></li><li>    <span class="hljs-keyword">auto</span> loop = <span class="hljs-built_in">ffrt_loop_create</span>(queue_handle);</li><li>    <span class="hljs-type">int</span> result1 = <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-comment">// 向loop队列提交一个任务</span></li><li>    std::function&lt;<span class="hljs-type">void</span>()&gt; &amp;&amp;basicFunc1 = [&amp;result1]() { result1 += <span class="hljs-number">10</span>; };</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task = <span class="hljs-built_in">ffrt_queue_submit_h</span>(queue_handle, ffrt::<span class="hljs-built_in">create_function_wrapper</span>(basicFunc1, ffrt_function_kind_queue), <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 启动独立线程来执行loop</span></li><li>    <span class="hljs-type">pthread_t</span> thread;</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">pthread_create</span>(&amp;thread, <span class="hljs-number">0</span>, ThreadFunc, loop);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"pthread_create failed!"</span>);</li><li>        <span class="hljs-built_in">ffrt_loop_destroy</span>(loop);</li><li>        <span class="hljs-built_in">ffrt_queue_attr_destroy</span>(&amp;queue_attr);</li><li>        <span class="hljs-built_in">ffrt_queue_destroy</span>(queue_handle);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int</span>* xf = &amp;x;</li><li>    <span class="hljs-type">void</span>* data = xf;</li><li>    <span class="hljs-type">uint64_t</span> timeout1 = <span class="hljs-number">20</span>;</li><li>    <span class="hljs-type">uint64_t</span> timeout2 = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-type">uint64_t</span> expected = <span class="hljs-number">0xabacadae</span>;</li><li>
</li><li>    <span class="hljs-type">int</span> testFd = <span class="hljs-built_in">eventfd</span>(<span class="hljs-number">0</span>, EFD_NONBLOCK | EFD_CLOEXEC);</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TestData</span> testData {.fd = testFd, .expected = expected};</li><li>
</li><li>    <span class="hljs-comment">// 向loop注册一个定时器</span></li><li>    <span class="hljs-type">ffrt_timer_t</span> timeHandle = <span class="hljs-built_in">ffrt_loop_timer_start</span>(loop, timeout1, data, cb, <span class="hljs-literal">false</span>);</li><li>
</li><li>    <span class="hljs-comment">// 向loop注册一个fd监听</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">ffrt_loop_epoll_ctl</span>(loop, EPOLL_CTL_ADD, testFd, EPOLLIN, (<span class="hljs-type">void</span>*)(&amp;testData), testCallBack);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ffrt_loop_epoll_ctl执行成功。\n"</span>);</li><li>    }</li><li>    <span class="hljs-type">ssize_t</span> n = <span class="hljs-built_in">write</span>(testFd, &amp;expected, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>));</li><li>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">25000</span>);</li><li>    <span class="hljs-comment">// 删除fd监听</span></li><li>    <span class="hljs-built_in">ffrt_loop_epoll_ctl</span>(loop, EPOLL_CTL_DEL, testFd, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 终止loop</span></li><li>    <span class="hljs-built_in">ffrt_loop_stop</span>(loop);</li><li>    <span class="hljs-built_in">pthread_join</span>(thread, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 删除定时器</span></li><li>    <span class="hljs-built_in">ffrt_loop_timer_stop</span>(loop, timeHandle);</li><li>
</li><li>    <span class="hljs-comment">// 销毁loop</span></li><li>    ret = <span class="hljs-built_in">ffrt_loop_destroy</span>(loop);</li><li>
</li><li>    <span class="hljs-comment">// 销毁并发队列</span></li><li>    <span class="hljs-built_in">ffrt_queue_attr_destroy</span>(&amp;queue_attr);</li><li>    <span class="hljs-built_in">ffrt_queue_destroy</span>(queue_handle);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>  </li></ul> </div>  <div class="tiledSection"><h2 id="纤程">纤程<i class="anchor-icon anchor-icon-link" anchorid="纤程" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="ffrt_fiber_t" class="firsth2">ffrt_fiber_t<i class="anchor-icon anchor-icon-link" anchorid="ffrt_fiber_t" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ffrt_fiber_t</span>;</span></li></ol></pre></div></div> <p><strong>描述</strong></p> <ul><li>纤程是一种轻量级的用户态线程，用于在用户空间内实现高效的任务调度和上下文切换。</li><li>ffrt_fiber_t为纤程存储实体类型，用于保存和恢复执行上下文。</li></ul> <p><strong>方法</strong></p> <p><strong>ffrt_fiber_init</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">int</span> <span class="hljs-title function_">ffrt_fiber_init</span><span class="hljs-params">(<span class="hljs-type">ffrt_fiber_t</span>* fiber, <span class="hljs-type">void</span>(*func)(<span class="hljs-type">void</span>*), <span class="hljs-type">void</span>* arg, <span class="hljs-type">void</span>* <span class="hljs-built_in">stack</span>, <span class="hljs-type">size_t</span> stack_size)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>fiber：纤程指针。</li><li>func：纤程启动时的函数指针入口。</li><li>arg：纤程启动时的函数入参。</li><li>stack：纤程运行时使用的栈空间起始地址。</li><li>stack_size：纤程栈大小，单位为字节。</li></ul> <p>返回值</p> <ul><li>初始化成功返回ffrt_success，否则返回ffrt_error。</li><li>返回错误的常见原因是stack_size不满足最小栈空间限制（不同平台存在差异），建议设置栈空间大小为4KB或以上。</li></ul> <p>描述</p> <ul><li>该函数用于初始化纤程，需要传入启动纤程的函数指针和入参，以及运行时使用的栈空间，纤程不管理任何的内存，栈的生命周期由调用方管理。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> <p><strong>ffrt_fiber_switch</strong></p> <p>声明</p> <div _ngcontent-fut-c106="" class="highlight-div"><div _ngcontent-fut-c106="" class="highlight-div-header"><div _ngcontent-fut-c106="" class="highlight-div-header-left"><div _ngcontent-fut-c106="" class="handle-button expand-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fut-c106="" class="highlight-div-header-right"><div _ngcontent-fut-c106="" class="handle-button ai-button"></div><div _ngcontent-fut-c106="" class="handle-button line-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fut-c106="" class="handle-button theme-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fut-c106="" class="handle-button copy-button"><div _ngcontent-fut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fut-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>FFRT_C_API <span class="hljs-type">void</span> <span class="hljs-title function_">ffrt_fiber_switch</span><span class="hljs-params">(<span class="hljs-type">ffrt_fiber_t</span>* from, <span class="hljs-type">ffrt_fiber_t</span>* to)</span>;</li></ol></pre></div></div> <p>参数</p> <ul><li>from：调用该函数的线程会暂停当前任务的执行，并保存当前上下文到from指向的纤程。</li><li>to：将to指向的纤程恢复到当前上下文，调用该函数的线程将执行to对应的任务。</li></ul> <p>描述</p> <ul><li>切换纤程上下文时，调用该函数的线程会暂停当前任务，保存上下文到from纤程，并恢复to纤程上下文，执行to对应的任务。</li><li>注意：本接口不校验from、to的有效性，调用方需自行校验地址有效性，否则会导致该进程崩溃。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>从API version 20开始，支持该接口。</p>  </div></div></div> </div> </div> <div></div></div>