<h1 _ngcontent-ikn-c119="" class="doc-title ng-star-inserted" title="Function Flow Runtime并发队列(C)"> Function Flow Runtime并发队列(C) </h1>

<div _ngcontent-ikn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2><p>FFRT并发队列提供了设置任务优先级（Priority）和队列并发度的能力，使得队列中的任务能同时在多个线程上执行，获得更高的并行效果。</p> <ul><li><strong>队列并发度</strong>：通过队列最大并发度设置，可以控制同一时刻同时执行的任务数量。这有助于避免任务并发过多对系统资源造成冲击，从而保证系统的稳定性和性能。</li><li><strong>任务优先级</strong>：用户可以为每个任务设置优先级，不同的任务将严格按照优先级进行调度和执行。相同优先级的任务按照排队顺序执行，高优先级的任务将优先于低优先级的任务执行，确保关键任务能够及时处理。</li></ul> </div>  <div class="tiledSection"><h2 id="示例银行服务系统">示例：银行服务系统<i class="anchor-icon anchor-icon-link" anchorid="示例银行服务系统" tips="复制节点链接"></i></h2><p>举例实现一个银行服务系统，每个客户向系统提交一个服务请求，可以区分普通用户和VIP用户，VIP用户的服务请求可以优先得到执行。</p> <p>银行系统中有2个窗口，可以并行取出用户提交的服务请求办理。可以利用FFRT的并行队列范式做如下建模：</p> <ul><li><strong>排队逻辑</strong>：并行队列。</li><li><strong>服务窗口</strong>：并行队列的并发度，同时也对应FFRT Worker数量。</li><li><strong>用户等级</strong>：并行队列任务优先级。</li></ul> <p>实现代码如下所示：</p> <div _ngcontent-ikn-c106="" class="highlight-div"><div _ngcontent-ikn-c106="" class="highlight-div-header"><div _ngcontent-ikn-c106="" class="highlight-div-header-left"><div _ngcontent-ikn-c106="" class="handle-button expand-button"><div _ngcontent-ikn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ikn-c106="" class="highlight-div-header-right"><div _ngcontent-ikn-c106="" class="handle-button ai-button"></div><div _ngcontent-ikn-c106="" class="handle-button line-button"><div _ngcontent-ikn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ikn-c106="" class="handle-button theme-button"><div _ngcontent-ikn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ikn-c106="" class="handle-button copy-button"><div _ngcontent-ikn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ikn-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/ffrt.h"</span> <span class="hljs-comment">// 来自 OpenHarmony 第三方库 "@ppd/ffrt"</span></span></li><li>
</li><li><span class="hljs-type">ffrt_queue_t</span> <span class="hljs-title function_">create_bank_system</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> concurrency)</span></li><li>{</li><li>    <span class="hljs-type">ffrt_queue_attr_t</span> queue_attr;</li><li>    (<span class="hljs-type">void</span>)ffrt_queue_attr_init(&amp;queue_attr);</li><li>    ffrt_queue_attr_set_max_concurrency(&amp;queue_attr, concurrency);</li><li>
</li><li>    <span class="hljs-comment">// 创建一个并发队列</span></li><li>    <span class="hljs-type">ffrt_queue_t</span> <span class="hljs-built_in">queue</span> = ffrt_queue_create(ffrt_queue_concurrent, name, &amp;queue_attr);</li><li>
</li><li>    <span class="hljs-comment">// 队列创建完后需要销毁队列属性</span></li><li>    ffrt_queue_attr_destroy(&amp;queue_attr);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">queue</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create queue failed\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create bank system successfully\n"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">queue</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">destroy_bank_system</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> queue_handle)</span></li><li>{</li><li>    ffrt_queue_destroy(queue_handle);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"destroy bank system successfully\n"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">bank_business</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></li><li>{</li><li>    usleep(<span class="hljs-number">100</span> * <span class="hljs-number">1000</span>);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)arg;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"saving or withdraw for %s\n"</span>, data);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 封装提交队列任务函数</span></li><li><span class="hljs-type">ffrt_task_handle_t</span> <span class="hljs-title function_">commit_request</span><span class="hljs-params">(<span class="hljs-type">ffrt_queue_t</span> bank, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *), <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name,</span></li><li><span class="hljs-params">    <span class="hljs-type">ffrt_queue_priority_t</span> level, <span class="hljs-type">int</span> delay)</span></li><li>{</li><li>    <span class="hljs-type">ffrt_task_attr_t</span> task_attr;</li><li>    (<span class="hljs-type">void</span>)ffrt_task_attr_init(&amp;task_attr);</li><li>    ffrt_task_attr_set_name(&amp;task_attr, name);</li><li>    ffrt_task_attr_set_queue_priority(&amp;task_attr, level);</li><li>    ffrt_task_attr_set_delay(&amp;task_attr, delay);</li><li>
</li><li>    <span class="hljs-keyword">return</span> ffrt_queue_submit_h_f(bank, func, name, &amp;task_attr);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 封装取消队列任务函数</span></li><li><span class="hljs-type">int</span> <span class="hljs-title function_">cancel_request</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> request)</span></li><li>{</li><li>    <span class="hljs-keyword">return</span> ffrt_queue_cancel(request);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 封装等待队列任务函数</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">wait_for_request</span><span class="hljs-params">(<span class="hljs-type">ffrt_task_handle_t</span> task)</span></li><li>{</li><li>    ffrt_queue_wait(task);</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-type">ffrt_queue_t</span> bank = create_bank_system(<span class="hljs-string">"Bank"</span>, <span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">if</span> (!bank) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create bank system failed\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task1 = commit_request(bank, bank_business, <span class="hljs-string">"customer1"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task2 = commit_request(bank, bank_business, <span class="hljs-string">"customer2"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// VIP享受更优先的服务</span></li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task3 = commit_request(bank, bank_business, <span class="hljs-string">"customer3 VIP"</span>, ffrt_queue_priority_high, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task4 = commit_request(bank, bank_business, <span class="hljs-string">"customer4"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">ffrt_task_handle_t</span> task5 = commit_request(bank, bank_business, <span class="hljs-string">"customer5"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>
</li><li>    <span class="hljs-comment">// 取消客户4的服务</span></li><li>    cancel_request(task4);</li><li>
</li><li>    <span class="hljs-comment">// 等待所有的客户服务完成</span></li><li>    wait_for_request(task5);</li><li>    destroy_bank_system(bank);</li><li>
</li><li>    ffrt_task_handle_destroy(task1);</li><li>    ffrt_task_handle_destroy(task2);</li><li>    ffrt_task_handle_destroy(task3);</li><li>    ffrt_task_handle_destroy(task4);</li><li>    ffrt_task_handle_destroy(task5);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>ffrt_queue_submit_h_f接口可以接收裸函数指针任务作为参数，如果任务存在前后处理可以参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_alloc_auto_managed_function_storage_base">ffrt_alloc_auto_managed_function_storage_base</a>函数查看如何构造任务结构体。</p>  </div></div></div> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2><p>上述样例中涉及到主要的FFRT的接口包括：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_queue_t">ffrt_queue_create</a></td> <td class="cellrowborder" valign="top" width="50%">创建队列。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_queue_t">ffrt_queue_destroy</a></td> <td class="cellrowborder" valign="top" width="50%">销毁队列。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_task_attr_t">ffrt_task_attr_set_queue_priority</a></td> <td class="cellrowborder" valign="top" width="50%">设置队列任务优先级。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_queue_attr_t">ffrt_queue_attr_set_max_concurrency</a></td> <td class="cellrowborder" valign="top" width="50%">设置并发队列的并发度。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-api-guideline-c#ffrt_queue_t">ffrt_queue_submit_h_f</a></td> <td class="cellrowborder" valign="top" width="50%"><p>向队列提交一个任务。</p> <p><strong>说明</strong>：从API version 20开始，支持该接口。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <ul><li>如何使用FFRT C++ API详见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-development-guideline#using-ffrt-c-api-1">FFRT C++接口三方库使用指导</a>。</li><li>使用FFRT C接口或C++接口时，都可以通过FFRT C++接口三方库简化头文件包含，即使用#include "ffrt/ffrt.h"头文件包含语句。</li></ul>  </div></div></div> </div>  <div class="tiledSection"><h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2><ol><li>ffrt_queue_attr_t必须先调用ffrt_queue_attr_init初始化后再设置/获取属性，不再使用后需要显式调用ffrt_queue_attr_destroy释放资源。</li><li>ffrt_queue_t必须在进程退出前显式调用ffrt_queue_destroy释放资源。</li><li>并发队列最大并发度建议控制在合理范围内，配置过大超过Worker线程数没有意义，配置过小可能导致系统资源利用率不足。</li></ol> </div> </div> <div></div></div>