<h1 _ngcontent-wyr-c119="" class="doc-title ng-star-inserted" title="Function Flow Runtime并发队列(C++)"> Function Flow Runtime并发队列(C++) </h1>

<div _ngcontent-wyr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2><p>FFRT并发队列提供了设置任务优先级（Priority）和队列并发度的能力，使得队列中的任务能同时在多个线程上执行，获得更高的并行效果。</p> <ul><li><strong>队列并发度</strong>：通过队列最大并发度设置，可以控制同一时刻同时执行的任务数量。这有助于避免任务并发过多对系统资源造成冲击，从而保证系统的稳定性和性能。</li><li><strong>任务优先级</strong>：用户可以为每个任务设置优先级，不同的任务将严格按照优先级进行调度和执行。相同优先级的任务按照排队顺序执行，高优先级的任务将优先于低优先级的任务执行，确保关键任务能够及时处理。</li></ul> </div>  <div class="tiledSection"><h2 id="示例银行服务系统">示例：银行服务系统<i class="anchor-icon anchor-icon-link" anchorid="示例银行服务系统" tips="复制节点链接"></i></h2><p>举例实现一个银行服务系统，每个客户向系统提交一个服务请求，可以区分普通用户和VIP用户，VIP用户的服务请求可以优先得到执行。</p> <p>银行系统中有2个窗口，可以并行取出用户提交的服务请求办理。可以利用FFRT的并行队列范式做如下建模：</p> <ul><li><strong>排队逻辑</strong>：并行队列。</li><li><strong>服务窗口</strong>：并行队列的并发度，同时也对应FFRT Worker数量。</li><li><strong>用户等级</strong>：并行队列任务优先级。</li></ul> <p>实现代码如下所示：</p> <div _ngcontent-wyr-c106="" class="highlight-div"><div _ngcontent-wyr-c106="" class="highlight-div-header"><div _ngcontent-wyr-c106="" class="highlight-div-header-left"><div _ngcontent-wyr-c106="" class="handle-button expand-button"><div _ngcontent-wyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyr-c106="" class="highlight-div-header-right"><div _ngcontent-wyr-c106="" class="handle-button ai-button"></div><div _ngcontent-wyr-c106="" class="handle-button line-button"><div _ngcontent-wyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyr-c106="" class="handle-button theme-button"><div _ngcontent-wyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyr-c106="" class="handle-button copy-button"><div _ngcontent-wyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ffrt/ffrt.h"</span> <span class="hljs-comment">// 来自 OpenHarmony 第三方库 "@ppd/ffrt"</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankQueueSystem</span> {</li><li><span class="hljs-keyword">private</span>:</li><li>    std::unique_ptr&lt;ffrt::queue&gt; queue_;</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">BankQueueSystem</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> concurrency)</li><li>    {</li><li>        queue_ = std::<span class="hljs-built_in">make_unique</span>&lt;ffrt::queue&gt;(</li><li>            ffrt::queue_concurrent, name, ffrt::<span class="hljs-built_in">queue_attr</span>().<span class="hljs-built_in">max_concurrency</span>(concurrency));</li><li>        std::cout &lt;&lt; <span class="hljs-string">"bank system has been initialized"</span> &lt;&lt; std::endl;</li><li>    }</li><li>
</li><li>    ~<span class="hljs-built_in">BankQueueSystem</span>()</li><li>    {</li><li>        queue_ = <span class="hljs-literal">nullptr</span>;</li><li>        std::cout &lt;&lt; <span class="hljs-string">"bank system has been destroyed"</span> &lt;&lt; std::endl;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 开始排队，即提交队列任务</span></li><li>    <span class="hljs-function">ffrt::task_handle <span class="hljs-title">Enter</span><span class="hljs-params">(<span class="hljs-type">const</span> std::function&lt;<span class="hljs-type">void</span>()&gt;&amp; func, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">ffrt_queue_priority_t</span> level, <span class="hljs-type">int</span> delay)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> queue_-&gt;<span class="hljs-built_in">submit_h</span>(func, ffrt::<span class="hljs-built_in">task_attr</span>().<span class="hljs-built_in">name</span>(name).<span class="hljs-built_in">priority</span>(level).<span class="hljs-built_in">delay</span>(delay));</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 退出排队，即取消队列任务</span></li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Exit</span><span class="hljs-params">(<span class="hljs-type">const</span> ffrt::task_handle &amp;t)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> queue_-&gt;<span class="hljs-built_in">cancel</span>(t);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 等待排队，即等待队列任务</span></li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Wait</span><span class="hljs-params">(<span class="hljs-type">const</span> ffrt::task_handle&amp; handle)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        queue_-&gt;<span class="hljs-built_in">wait</span>(handle);</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BankBusiness</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">100</span> * <span class="hljs-number">1000</span>);</li><li>    std::cout &lt;&lt; <span class="hljs-string">"saving or withdraw ordinary customer"</span> &lt;&lt; std::endl;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BankBusinessVIP</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">100</span> * <span class="hljs-number">1000</span>);</li><li>    std::cout &lt;&lt; <span class="hljs-string">"saving or withdraw VIP"</span> &lt;&lt; std::endl;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">BankQueueSystem <span class="hljs-title">bankQueue</span><span class="hljs-params">(<span class="hljs-string">"Bank"</span>, <span class="hljs-number">2</span>)</span></span>;</li><li>
</li><li>    <span class="hljs-keyword">auto</span> task1 = bankQueue.<span class="hljs-built_in">Enter</span>(BankBusiness, <span class="hljs-string">"customer1"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">auto</span> task2 = bankQueue.<span class="hljs-built_in">Enter</span>(BankBusiness, <span class="hljs-string">"customer2"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// VIP享受更优先的服务</span></li><li>    <span class="hljs-keyword">auto</span> task3 = bankQueue.<span class="hljs-built_in">Enter</span>(BankBusinessVIP, <span class="hljs-string">"customer3 vip"</span>, ffrt_queue_priority_high, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">auto</span> task4 = bankQueue.<span class="hljs-built_in">Enter</span>(BankBusiness, <span class="hljs-string">"customer4"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">auto</span> task5 = bankQueue.<span class="hljs-built_in">Enter</span>(BankBusiness, <span class="hljs-string">"customer5"</span>, ffrt_queue_priority_low, <span class="hljs-number">0</span>);</li><li>
</li><li>    <span class="hljs-comment">// 取消客户4的服务</span></li><li>    bankQueue.<span class="hljs-built_in">Exit</span>(task4);</li><li>
</li><li>    <span class="hljs-comment">// 等待所有的客户服务完成</span></li><li>    bankQueue.<span class="hljs-built_in">Wait</span>(task5);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2><p>上述样例中涉及到主要的FFRT的接口包括：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">class <a href="https://gitcode.com/openharmony/resourceschedule_ffrt/blob/master/docs/ffrt-api-guideline-cpp.md#task_attr" target="_blank">task_attr</a></td> <td class="cellrowborder" valign="top" width="50%">任务属性类。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">class <a href="https://gitcode.com/openharmony/resourceschedule_ffrt/blob/master/docs/ffrt-api-guideline-cpp.md#queue_attr" target="_blank">queue_attr</a></td> <td class="cellrowborder" valign="top" width="50%">队列属性类。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">class <a href="https://gitcode.com/openharmony/resourceschedule_ffrt/blob/master/docs/ffrt-api-guideline-cpp.md#queue" target="_blank">queue</a></td> <td class="cellrowborder" valign="top" width="50%">队列类。</td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <ul><li>如何使用FFRT C++ API详见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-development-guideline#using-ffrt-c-api-1">FFRT C++接口三方库使用指导</a>。</li><li>使用FFRT C接口或C++接口时，都可以通过FFRT C++接口三方库简化头文件包含，即使用#include "ffrt/ffrt.h"头文件包含语句。</li></ul>  </div></div></div> </div>  <div class="tiledSection"><h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2><p>并发队列最大并发度建议控制在合理范围内，配置过大超过Worker线程数没有意义，配置过小可能导致系统资源利用率不足。</p> </div> </div> <div></div></div>