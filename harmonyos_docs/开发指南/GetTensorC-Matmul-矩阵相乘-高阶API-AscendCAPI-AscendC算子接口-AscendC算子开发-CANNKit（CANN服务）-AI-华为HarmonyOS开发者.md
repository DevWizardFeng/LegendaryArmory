<h1 _ngcontent-owi-c119="" class="doc-title ng-star-inserted" title="GetTensorC"> GetTensorC </h1>

<div _ngcontent-owi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section777918719144">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section777918719144" tips="复制节点链接"></i></h2><p>Iterate后，获取一块C矩阵片，可以直接输出到GM tensor中。</p> <p>该接口和Iterate接口配合使用，用于在调用Iterate完成迭代计算后，获取一片baseM * baseN大小的矩阵分片。</p> <p>迭代获取C矩阵分片的过程分为同步和异步两种模式：</p> <ul><li><strong>同步：</strong>执行完一次Iterate后执行一次GetTensorC，需要同步等待C矩阵分片获取完成。</li><li><strong>异步：</strong>调用Iterate后，无需立即调用GetTensorC同步等待，可以先执行其他逻辑，待需要获取结果时再调用GetTensorC。异步方式可以减少同步等待，提高并行度，开发者对计算性能要求较高时，可以选用该方式。</li></ul> </div> <div class="tiledSection"><h2 id="section1378016771415">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section1378016771415" tips="复制节点链接"></i></h2><ul><li>获取C矩阵，输出至GM<div _ngcontent-owi-c106="" class="highlight-div"><div _ngcontent-owi-c106="" class="highlight-div-header"><div _ngcontent-owi-c106="" class="highlight-div-header-left"><div _ngcontent-owi-c106="" class="handle-button expand-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owi-c106="" class="highlight-div-header-right"><div _ngcontent-owi-c106="" class="handle-button ai-button"></div><div _ngcontent-owi-c106="" class="handle-button line-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owi-c106="" class="handle-button theme-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owi-c106="" class="handle-button copy-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">bool</span> sync = <span class="hljs-literal">true</span>&gt;</li><li>__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-built_in">GetTensorC</span>(<span class="hljs-type">const</span> GlobalTensor&lt;DstT&gt;&amp; gm, <span class="hljs-type">uint8_t</span> enAtomic = <span class="hljs-number">0</span>, <span class="hljs-type">bool</span> enSequentialWrite = <span class="hljs-literal">false</span>)</li></ol></pre></div></div> <ul><li>支持同步模式</li><li>支持异步模式</li></ul> </li><li>获取API接口返回的GM上的C矩阵，后续使用过程由开发者自行控制<p>提供该接口支持返回API框架申请的GM上的C矩阵，由开发者自行控制后续使用过程。</p> <p>支持异步模式：</p> <p>以下接口中的doPad、height、width、srcGap、dstGap参数待废弃，使用过程中无需传入，保持默认值即可。</p> <div _ngcontent-owi-c106="" class="highlight-div"><div _ngcontent-owi-c106="" class="highlight-div-header"><div _ngcontent-owi-c106="" class="highlight-div-header-left"><div _ngcontent-owi-c106="" class="handle-button expand-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owi-c106="" class="highlight-div-header-right"><div _ngcontent-owi-c106="" class="handle-button ai-button"></div><div _ngcontent-owi-c106="" class="handle-button line-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owi-c106="" class="handle-button theme-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owi-c106="" class="handle-button copy-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">bool</span> sync = <span class="hljs-literal">true</span>, <span class="hljs-type">bool</span> doPad = <span class="hljs-literal">false</span>&gt; </li><li>__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-built_in">GetTensorC</span>(<span class="hljs-type">const</span> LocalTensor&lt;DstT&gt;&amp; c, <span class="hljs-type">uint8_t</span> enAtomic = <span class="hljs-number">0</span>, <span class="hljs-type">bool</span> enSequentialWrite = <span class="hljs-literal">false</span>, <span class="hljs-type">uint32_t</span> height = <span class="hljs-number">0</span>, <span class="hljs-type">uint32_t</span> width = <span class="hljs-number">0</span>, <span class="hljs-type">uint32_t</span> srcGap = <span class="hljs-number">0</span>, <span class="hljs-type">uint32_t</span> dstGap = <span class="hljs-number">0</span>)</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section3803137201412">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section3803137201412" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>模板参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.3.1.1" valign="top" width="17.169999999999998%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.3.1.2" valign="top" width="82.83%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>sync</p> </td> <td class="cellrowborder" valign="top" width="82.83%"><p>设置同步或者异步模式：同步模式设置为true，异步模式设置为false。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>接口参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.2" valign="top" width="9.09%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.3" valign="top" width="73.74000000000001%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>gm</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>取出C矩阵到GM，数据格式可以为ND或NZ。</p> <p>Kirin9020系列处理器，支持的数据类型为：half</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>enAtomic</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>是否开启Atomic操作，默认值为0<strong>。</strong></p> <p>参数取值：</p> <p>0：不开启Atomic操作</p> <p>1：开启AtomicAdd累加操作</p> <p>2：开启AtomicMax求最大值操作</p> <p>3：开启AtomicMin求最小值操作</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>enSequentialWrite</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>是否开启连续写模式（连续写，写入[baseM, baseN]。非连续写，写入[singleCoreM, singleCoreN]中对应的位置），默认值false（非连续写模式）。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>非连续写模式，内部会按照迭代顺序算好偏移，开发者不需要关注。如果开发者需要自己决定排布顺序，可以选择连续写模式，自行按照自己设定的偏移进行搬运操作。</p> </div></div></div> </td> </tr>  </tbody></table></div> </div> <div class="fignone"><span class="figcap"><b>图1 </b>非连续写模式示意图</span><br><span><img height="185.964989" originheight="299" originwidth="842" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114331.05797731423869418202930725399876:50001231000000:2800:F4DB589B2E6DEF3AA3756002C90C66FB9A137EA26BABA116A9522C97714AE7C1.png" title="点击放大" width="523.6875"></span></div> <div class="fignone"><span class="figcap"><b>图2 </b>连续写模式示意图</span><br><span><img height="181.61136700000003" originheight="292" originwidth="842" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114331.82214333871246266947484788469839:50001231000000:2800:555911453EDFCD740A8AEE46BEB80439FC407ACA894EA7C76961BB73A62D52BE.png" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h2 id="section285220701418">返回值<i class="anchor-icon anchor-icon-link" anchorid="section285220701418" tips="复制节点链接"></i></h2><p>无</p> </div> <div class="tiledSection"><h2 id="section685214701411">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section685214701411" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> </div> <div class="tiledSection"><h2 id="section1585297181418">注意事项<i class="anchor-icon anchor-icon-link" anchorid="section1585297181418" tips="复制节点链接"></i></h2><p>传入的C矩阵地址空间大小需要保证不小于baseM * baseN。</p> </div> <div class="tiledSection"><h2 id="section1788067191416">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section1788067191416" tips="复制节点链接"></i></h2><ul><li>获取C矩阵，输出至GM，同步模式样例<div _ngcontent-owi-c106="" class="highlight-div"><div _ngcontent-owi-c106="" class="highlight-div-header"><div _ngcontent-owi-c106="" class="highlight-div-header-left"><div _ngcontent-owi-c106="" class="handle-button expand-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owi-c106="" class="highlight-div-header-right"><div _ngcontent-owi-c106="" class="handle-button ai-button"></div><div _ngcontent-owi-c106="" class="handle-button line-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owi-c106="" class="handle-button theme-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owi-c106="" class="handle-button copy-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">while</span> (mm.<span class="hljs-built_in">Iterate</span>()) {</li><li>mm.<span class="hljs-built_in">GetTensorC</span>(gm);</li><li>}</li></ol></pre></div></div> </li><li>获取API接口返回的GM上的C矩阵，手动拷贝至UB，异步模式样例<div _ngcontent-owi-c106="" class="highlight-div"><div _ngcontent-owi-c106="" class="highlight-div-header"><div _ngcontent-owi-c106="" class="highlight-div-header-left"><div _ngcontent-owi-c106="" class="handle-button expand-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owi-c106="" class="highlight-div-header-right"><div _ngcontent-owi-c106="" class="handle-button ai-button"></div><div _ngcontent-owi-c106="" class="handle-button line-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owi-c106="" class="handle-button theme-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owi-c106="" class="handle-button copy-button"><div _ngcontent-owi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// BaseM * BaseN = 128 *256</span></li><li>mm.<span class="hljs-built_in">SetTensorA</span>(gmA);</li><li>mm.<span class="hljs-built_in">SetTensorB</span>(gmB);</li><li>mm.<span class="hljs-built_in">SetTail</span>(singleM, singleN, singleK);</li><li>mm.<span class="hljs-keyword">template</span> <span class="hljs-built_in">Iterate</span>&lt;<span class="hljs-literal">false</span>&gt;();</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; singleM / baseM * singleN / baseN; ++i) {</li><li><span class="hljs-comment">// 获取每次计算的BaseM*BaseN的数据分配64*128大小的UB空间</span></li><li><span class="hljs-built_in">DataCopy</span>(local, global[<span class="hljs-number">64</span> * <span class="hljs-number">128</span> * i], <span class="hljs-number">64</span> * <span class="hljs-number">128</span>); <span class="hljs-comment">// 将GM的数据拷贝进UB中，进行后续的Vector操作</span></li><li><span class="hljs-comment">// ... Vector 操作</span></li><li>}</li></ol></pre></div></div> </li></ul> </div> </div> <div></div></div>