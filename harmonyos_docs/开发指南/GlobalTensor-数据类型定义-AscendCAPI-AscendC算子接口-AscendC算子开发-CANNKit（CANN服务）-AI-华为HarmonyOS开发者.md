<h1 _ngcontent-occ-c119="" class="doc-title ng-star-inserted" title="GlobalTensor"> GlobalTensor </h1>

<div _ngcontent-occ-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section8535mcpsimp">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section8535mcpsimp" tips="复制节点链接"></i></h2><p>GlobalTensor用来存放Global Memory（外部存储）的全局数据。</p> </div> <div class="tiledSection"><h2 id="section8538mcpsimp">定义原型<i class="anchor-icon anchor-icon-link" anchorid="section8538mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-occ-c106="" class="highlight-div"><div _ngcontent-occ-c106="" class="highlight-div-header"><div _ngcontent-occ-c106="" class="highlight-div-header-left"><div _ngcontent-occ-c106="" class="handle-button expand-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-occ-c106="" class="highlight-div-header-right"><div _ngcontent-occ-c106="" class="handle-button ai-button"></div><div _ngcontent-occ-c106="" class="handle-button line-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-occ-c106="" class="handle-button theme-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-occ-c106="" class="handle-button copy-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-occ-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalTensor</span> : <span class="hljs-keyword">public</span> BaseGlobalTensor&lt;T&gt; { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-keyword">using</span> PrimType = PrimT&lt;T&gt;; </li><li>    __aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-built_in">GlobalTensor</span>&lt;T&gt;() {} </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SetGlobalBuffer</span><span class="hljs-params">(__gm__ PrimType* buffer, <span class="hljs-type">uint64_t</span> bufferSize)</span></span>;  <span class="hljs-comment">// 传入全局数据的指针，并手动设置一个buffer size，初始化GlobalTensor </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SetGlobalBuffer</span><span class="hljs-params">(__gm__ PrimType* buffer)</span></span>;  <span class="hljs-comment">// 传入全局数据的指针，初始化GlobalTensor,可以不传入buffer size,但此时使用GetSize获取的长度是随机值 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> __gm__ PrimType* <span class="hljs-title">GetPhyAddr</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;   <span class="hljs-comment">// 返回全局数据的地址 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> __gm__ PrimType* <span class="hljs-title">GetPhyAddr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> offset)</span> <span class="hljs-type">const</span></span>;  <span class="hljs-comment">// 返回全局数据(指定偏移offset个元素)的地址 </span></li><li>    __aicore__ <span class="hljs-keyword">inline</span> __inout_pipe__(S) <span class="hljs-function">PrimType <span class="hljs-title">GetValue</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> offset)</span> <span class="hljs-type">const</span></span>;  <span class="hljs-comment">// 获取Tensor的相应偏移位置的值 </span></li><li>    __aicore__ <span class="hljs-keyword">inline</span> __inout_pipe__(S) <span class="hljs-function">__gm__ PrimType&amp; <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> offset)</span> <span class="hljs-type">const</span></span>;   <span class="hljs-comment">// 返回某个index位置的元素的引用 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SetValue</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> offset, PrimType value)</span></span>;  <span class="hljs-comment">// 设置Tensor相应偏移位置的值。 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">uint64_t</span> <span class="hljs-title">GetSize</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;  <span class="hljs-comment">// 返回Tensor中的element个数 </span></li><li>    __aicore__ <span class="hljs-keyword">inline</span> GlobalTensor <span class="hljs-keyword">operator</span>[](<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> offset) <span class="hljs-type">const</span>;  <span class="hljs-comment">// 指定偏移返回一个GlobalTensor，offset单位为element </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SetShapeInfo</span><span class="hljs-params">(<span class="hljs-type">const</span> ShapeInfo&amp; shapeInfo)</span></span>; </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> ShapeInfo <span class="hljs-title">GetShapeInfo</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>; </li><li>    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;CacheRwMode rwMode </span>= CacheRwMode::RW&gt; </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SetL2CacheHint</span><span class="hljs-params">(CacheMode mode)</span></span>;   <span class="hljs-comment">// 设置Tensor写入L2 Cache的模式（允许/禁止） </span></li><li>    <span class="hljs-comment">// ... </span></li><li>};</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section8541mcpsimp">函数说明<i class="anchor-icon anchor-icon-link" anchorid="section8541mcpsimp" tips="复制节点链接"></i></h2><p>类型T支持基础数据类型，但需要遵循使用此GlobalTensor的指令的数据类型支持情况。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>函数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.1" valign="top" width="14.000000000000002%"><p>函数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.2" valign="top" width="23%"><p>入参说明</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.3" valign="top" width="63%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>GetValue</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>offset：偏移量，单位为element</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>获取GlobalTensor中的某个值，返回T类型的立即数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>SetGlobalBuffer</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>buffer：主机侧传入的全局数据指针</p> <p>bufferSize：所包含的类型为T的数据个数，单位为element，需自行保证不会超出实际数据的长度</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>设置GlobalTensor的存储位置：buffer指向外部存储的起始地址，bufferSize为Tensor所占外部存储的大小，如指向的外部存储有连续256个int32_t，则其bufferSize为256。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>GetPhyAddr</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>返回GlobalTensor的地址，如果传入offset，则表示偏移offset个元素。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>GetSize</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>返回GlobalTensor的element个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>operator[]</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>offset：开发者指定的偏移位置</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>根据输入的offset偏移返回新的Tensor，offset的单位为element的个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>operator()</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>index:  下标索引</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>获取本GlobalTensor的第index个变量的引用。与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>的operator()类似。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>SetShapeInfo</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>shapeInfo：ShapeInfo结构体</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>设置GlobalTensor的shapeInfo。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>GetShapeInfo</p> </td> <td class="cellrowborder" valign="top" width="23%"><p>无</p> </td> <td class="cellrowborder" valign="top" width="63%"><p>获取GlobalTensor的shapeInfo。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>Shape信息没有默认值，只有通过SetShapeInfo设置过Shape信息后，才可以调用该接口获取正确的ShapeInfo。</p> </div></div></div> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section8655mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section8655mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-occ-c106="" class="highlight-div"><div _ngcontent-occ-c106="" class="highlight-div-header"><div _ngcontent-occ-c106="" class="highlight-div-header-left"><div _ngcontent-occ-c106="" class="handle-button expand-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-occ-c106="" class="highlight-div-header-right"><div _ngcontent-occ-c106="" class="handle-button ai-button"></div><div _ngcontent-occ-c106="" class="handle-button line-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-occ-c106="" class="handle-button theme-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-occ-c106="" class="handle-button copy-button"><div _ngcontent-occ-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-occ-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span> *src_gm, __gm__ <span class="hljs-type">uint8_t</span> *dst_gm)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <span class="hljs-type">uint64_t</span> dataSize = <span class="hljs-number">256</span>; <span class="hljs-comment">// 设置input_global的大小为256 </span></li><li> </li><li>    AscendC::GlobalTensor&lt;<span class="hljs-type">int32_t</span>&gt; inputGlobal; <span class="hljs-comment">// 类型为int32_t </span></li><li>    <strong class="cpp">inputGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;__gm__ <span class="hljs-type">int32_t</span> *&gt;(src_gm), dataSize); <span class="hljs-comment">// 设置源操作数在Global Memory上的起始地址为src_gm，所占外部存储的大小为256个int32_t</span></strong><span class="hljs-comment"> </span></li><li> </li><li>    AscendC::LocalTensor&lt;<span class="hljs-type">int32_t</span>&gt; inputLocal = inQueueX.<span class="hljs-built_in">AllocTensor</span>&lt;<span class="hljs-type">int32_t</span>&gt;();     </li><li>    AscendC::<span class="hljs-built_in">DataCopy</span>(inputLocal, inputGlobal, dataSize); <span class="hljs-comment">// 将Global Memory上的inputGlobal拷贝到Local Memory的inputLocal上 </span></li><li>    <span class="hljs-comment">// ... </span></li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>