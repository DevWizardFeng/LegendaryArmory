<h1 _ngcontent-iia-c119="" class="doc-title ng-star-inserted" title="HCE卡模拟开发指南"> HCE卡模拟开发指南 </h1>

<div _ngcontent-iia-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>近场通信(Near Field Communication，NFC)是一种短距高频的无线电技术，在13.56MHz频率运行，通信距离一般在10厘米距离内。HCE(Host Card Emulation)，称为基于主机的卡模拟，表示不依赖安全单元芯片，电子设备上的应用程序模拟NFC卡片和NFC读卡器通信，实现NFC刷卡业务。</p>    </div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>应用程序模拟NFC卡片，和NFC读卡器通信完成NFC刷卡业务。从使用场景上，可以分成HCE应用前台刷卡和HCE应用后台刷卡。</p>     <ul>      <li>       <p>HCE应用前台刷卡</p>       <p>前台刷卡是指在触碰NFC读卡器之前，用户明确想使用在电子设备上打开特定的应用程序和NFC读卡器进行刷卡操作。当用户打开应用程序在前台，并且进入应用的刷卡页面时，电子设备触碰NFC读卡器后，会把刷卡交易数据分发给前台应用。若应用切换至后台或退出运行时，前台优先分发规则也随即被暂停。</p></li>      <li>       <p>HCE应用后台刷卡</p>       <p>后台刷卡是指不打开特定的HCE应用程序，当电子设备触碰NFC读卡器时，根据NFC读卡器选择的应用ID（Applet ID，AID，参考ISO/IEC 7816-4规范）匹配到HCE应用程序，并自动和匹配的HCE应用程序通信完成刷卡交易。如果NFC读卡器选择的应用ID，匹配到多个HCE应用程序时，说明存在冲突，需要用户打开指定的HCE应用，重新靠近NFC读卡器触发刷卡。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="hce应用刷卡的约束条件">HCE应用刷卡的约束条件<i class="anchor-icon anchor-icon-link" anchorid="hce应用刷卡的约束条件" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>基于刷卡安全性考虑，不论HCE应用是前台方式还是后台方式刷卡，均不支持电子设备在灭屏或熄屏状态下的HCE刷卡操作。</p></li>      <li>       <p>电子设备必须具备NFC控制器芯片，才支持HCE刷卡能力。对于是否具有NFC安全单元芯片，没有约束要求。</p></li>      <li>       <p>HCE应用程序需要声明NFC卡模拟权限，具体见示例。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>NFC卡模拟完整的API说明以及实例代码请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cardemulation" target="_blank">NFC卡模拟接口</a>。</p>     <p>完成HCE卡模拟功能，可能使用到下面的接口。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">start(elementName: ElementName, aidList: string[]): void</td>         <td class="cellrowborder" valign="top" width="50%">启动HCE业务功能。包括设置当前应用为前台优先，动态注册AID列表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">stop(elementName: ElementName): void</td>         <td class="cellrowborder" valign="top" width="50%">停止HCE业务功能。包括取消APDU数据接收的订阅、退出当前应用前台优先、释放动态注册的AID列表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'hceCmd', callback: AsyncCallback&lt;number[]&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">订阅回调，用于接收对端读卡设备发送的APDU数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">transmit(response: number[]): Promise&lt;void&gt;</td>         <td class="cellrowborder" valign="top" width="50%">发送APDU数据到对端读卡设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">off(type: 'hceCmd', callback?: AsyncCallback&lt;number[]&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">取消APDU数据接收的订阅。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发准备">开发准备<i class="anchor-icon anchor-icon-link" anchorid="开发准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="hce应用支持前台或后台刷卡的选择" class="firsth2">HCE应用支持前台或后台刷卡的选择<i class="anchor-icon anchor-icon-link" anchorid="hce应用支持前台或后台刷卡的选择" tips="复制节点链接"></i></h3>          <p>HCE应用开发者根据业务需要，可以选择实现前台刷卡或者后台刷卡。两种不同的刷卡方式，代码实现上会存在一些差异。</p>     <ul>      <li>       <p>HCE应用前台刷卡</p></li>     </ul>     <ol>      <li>在配置文件module.json5中，不需要静态声明NFC读卡器选择的应用ID（AID，参考ISO/IEC 7816-4规范），而是通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cardemulation#start9" target="_blank">start</a>来动态注册。</li>      <li>HCE应用的刷卡页面退出时，需要显性调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cardemulation#stop9" target="_blank">stop</a>来释放动态注册的AID刷卡配置项。</li>     </ol>     <ul>      <li>       <p>HCE应用后台刷卡</p></li>     </ul>     <ol>      <li>在配置文件module.json5中，需要静态声明NFC读卡器选择的应用ID（AID）。根据业务选择， 选择声明的AID是属于Payment类型，还是Other类型。</li>      <li>如果选择Payment类型，该HCE应用会在系统设置页面的NFC"默认付款应用"里出现。用户必须选择该HCE应用作为默认支付应用后，才能实现后台刷卡功能。由于提供了默认支付应用的选项， 因此Payment类型的HCE应用，不会出现多个冲突的情况。</li>      <li>如果选择Other类型，该HCE应用不会出现在系统设置页面的NFC"默认付款应用"里，但是多个HCE应用如果都声明了相同的Other类型的AID时，会出现冲突的可能。</li>      <li>HCE应用后台刷卡的实现，不需要调用接口start和stop。</li>     </ol>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>从API version 9之后的应用开发新增支持Stage模型，作为目前主推并长期演进的模型。</li>        <li>HCE示例代码的提供，全部按照Stage模型来说明。</li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="hce应用前台刷卡" class="firsth2">HCE应用前台刷卡<i class="anchor-icon anchor-icon-link" anchorid="hce应用前台刷卡" tips="复制节点链接"></i></h3>          <ol>      <li>在module.json5文件中声明NFC卡模拟权限，以及声明HCE特定的action。</li>      <li>import需要的NFC卡模拟模块和其他相关的模块。</li>      <li>判断设备是否支持NFC能力和HCE能力。</li>      <li>使能前台HCE应用程序优先处理NFC刷卡功能。</li>      <li>订阅HCE APDU数据的接收。</li>      <li>完成HCE刷卡APDU数据的接收和发送。</li>      <li>退出应用程序NFC刷卡页面时，退出前台优先功能。</li>     </ol>     <div _ngcontent-iia-c106="" class="highlight-div"><div _ngcontent-iia-c106="" class="highlight-div-header"><div _ngcontent-iia-c106="" class="highlight-div-header-left"><div _ngcontent-iia-c106="" class="handle-button expand-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iia-c106="" class="highlight-div-header-right"><div _ngcontent-iia-c106="" class="handle-button ai-button"></div><div _ngcontent-iia-c106="" class="handle-button line-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iia-c106="" class="handle-button theme-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iia-c106="" class="handle-button copy-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iia-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ts"</span>,</li><li>        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,</li><li>        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,</li><li>        <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"$color:start_window_background"</span>,</li><li>        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">"skills"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"entities"</span>: [</li><li>              <span class="hljs-string">"entity.system.home"</span></li><li>            ],</li><li>            <span class="hljs-string">"actions"</span>: [</li><li>              <span class="hljs-string">"ohos.want.action.home"</span>,</li><li>
</li><li>              <span class="hljs-comment">// actions必须包含"ohos.nfc.cardemulation.action.HOST_APDU_SERVICE"</span></li><li>              <span class="hljs-string">"ohos.nfc.cardemulation.action.HOST_APDU_SERVICE"</span></li><li>            ]</li><li>          }</li><li>        ]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-comment">// 添加使用NFC卡模拟需要的权限</span></li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.NFC_CARD_EMULATION"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:app_name"</span>,</li><li>      }</li><li>    ]</li></ol></pre></div></div>     <div _ngcontent-iia-c106="" class="highlight-div"><div _ngcontent-iia-c106="" class="highlight-div-header"><div _ngcontent-iia-c106="" class="highlight-div-header-left"><div _ngcontent-iia-c106="" class="handle-button expand-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iia-c106="" class="highlight-div-header-right"><div _ngcontent-iia-c106="" class="handle-button ai-button"></div><div _ngcontent-iia-c106="" class="handle-button line-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iia-c106="" class="handle-button theme-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iia-c106="" class="handle-button copy-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iia-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cardEmulation } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncCallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hceElementName</span>: bundleManager.<span class="hljs-property">ElementName</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hceService</span>: cardEmulation.<span class="hljs-property">HceService</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">hceCommandCb</span>: <span class="hljs-title class_">AsyncCallback</span>&lt;<span class="hljs-built_in">number</span>[]&gt; = <span class="hljs-function">(<span class="hljs-params">error: BusinessError, hceCommand: <span class="hljs-built_in">number</span>[]</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!error) {</li><li>    <span class="hljs-keyword">if</span> (hceCommand == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommandCb has invalid hceCommand.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 应用程序根据自己业务实现，检查接收到的指令内容，发送匹配的响应数据</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommand = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(hceCommand));</li><li>    <span class="hljs-keyword">let</span> responseData = [<span class="hljs-number">0x90</span>, <span class="hljs-number">0x00</span>]; <span class="hljs-comment">// 根据接收到的不同指令更改响应数据</span></li><li>    hceService.<span class="hljs-title function_">transmit</span>(responseData).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService transmit Promise success.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService transmit Promise error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommandCb error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 判断设备是否支持NFC能力和HCE能力</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Communication.NFC.Core"</span>)) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'nfc unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!cardEmulation.<span class="hljs-title function_">hasHceCapability</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hce unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// hceElementName中元素不能为空，通过want获取应用的elementname或按应用实际信息填写</span></li><li>    hceElementName = {</li><li>      <span class="hljs-attr">bundleName</span>: want.<span class="hljs-property">bundleName</span> ?? <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">abilityName</span>: want.<span class="hljs-property">abilityName</span> ?? <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">moduleName</span>: want.<span class="hljs-property">moduleName</span>,</li><li>    }</li><li>    hceService = <span class="hljs-keyword">new</span> cardEmulation.<span class="hljs-title class_">HceService</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 应用进入前台</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>    <span class="hljs-keyword">if</span> (hceElementName != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 调用接口使能前台HCE应用程序优先处理NFC刷卡功能</span></li><li>        <span class="hljs-keyword">let</span> aidList = [<span class="hljs-string">"A0000000031010"</span>, <span class="hljs-string">"A0000000031011"</span>]; <span class="hljs-comment">// 修改为正确的aid</span></li><li>        hceService.<span class="hljs-title function_">start</span>(hceElementName, aidList);</li><li>
</li><li>        <span class="hljs-comment">// 订阅HCE APDU数据的接收</span></li><li>        hceService.<span class="hljs-title function_">on</span>(<span class="hljs-string">'hceCmd'</span>, hceCommandCb);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService.start error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 应用退到后台</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>    <span class="hljs-comment">// 应用程序退出前台，停止HCE业务功能</span></li><li>    <span class="hljs-keyword">if</span> (hceElementName != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        hceService.<span class="hljs-title function_">stop</span>(hceElementName);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService.stop error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="hce应用后台刷卡">HCE应用后台刷卡<i class="anchor-icon anchor-icon-link" anchorid="hce应用后台刷卡" tips="复制节点链接"></i></h3>          <ol>      <li>在module.json5文件中声明NFC卡模拟权限，声明HCE特定的action，声明应用能够处理的AID。</li>      <li>import需要的NFC卡模拟模块和其他相关的模块。</li>      <li>判断设备是否支持NFC能力和HCE能力。</li>      <li>订阅HCE APDU数据的接收。</li>      <li>完成HCE刷卡APDU数据的接收和发送。</li>      <li>退出应用程序时，退出订阅功能。</li>     </ol>     <div _ngcontent-iia-c106="" class="highlight-div"><div _ngcontent-iia-c106="" class="highlight-div-header"><div _ngcontent-iia-c106="" class="highlight-div-header-left"><div _ngcontent-iia-c106="" class="handle-button expand-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iia-c106="" class="highlight-div-header-right"><div _ngcontent-iia-c106="" class="handle-button ai-button"></div><div _ngcontent-iia-c106="" class="handle-button line-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iia-c106="" class="handle-button theme-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iia-c106="" class="handle-button copy-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iia-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ts"</span>,</li><li>        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,</li><li>        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,</li><li>        <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"$color:start_window_background"</span>,</li><li>        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">"skills"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"entities"</span>: [</li><li>              <span class="hljs-string">"entity.system.home"</span></li><li>            ],</li><li>            <span class="hljs-string">"actions"</span>: [</li><li>              <span class="hljs-string">"ohos.want.action.home"</span>,</li><li>
</li><li>              <span class="hljs-comment">// actions必须包含"ohos.nfc.cardemulation.action.HOST_APDU_SERVICE"</span></li><li>              <span class="hljs-string">"ohos.nfc.cardemulation.action.HOST_APDU_SERVICE"</span></li><li>            ]</li><li>          }</li><li>        ],</li><li>
</li><li>        <span class="hljs-comment">// 根据业务需要至少定义一个Payment类型或Other类型的AID，可以定义多个</span></li><li>        <span class="hljs-string">"metadata"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"payment-aid"</span>,</li><li>            <span class="hljs-string">"value"</span>: <span class="hljs-string">"A0000000031010"</span> <span class="hljs-comment">// 定义Payment类型的AID</span></li><li>          },</li><li>          {</li><li>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"other-aid"</span>,</li><li>            <span class="hljs-string">"value"</span>: <span class="hljs-string">"A0000000031011"</span> <span class="hljs-comment">// 定义Other类型的AID</span></li><li>          }</li><li>        ]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-comment">// 添加使用NFC卡模拟需要的权限</span></li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.NFC_CARD_EMULATION"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:app_name"</span>,</li><li>      }</li><li>    ]</li></ol></pre></div></div>     <div _ngcontent-iia-c106="" class="highlight-div"><div _ngcontent-iia-c106="" class="highlight-div-header"><div _ngcontent-iia-c106="" class="highlight-div-header-left"><div _ngcontent-iia-c106="" class="handle-button expand-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iia-c106="" class="highlight-div-header-right"><div _ngcontent-iia-c106="" class="handle-button ai-button"></div><div _ngcontent-iia-c106="" class="handle-button line-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iia-c106="" class="handle-button theme-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iia-c106="" class="handle-button copy-button"><div _ngcontent-iia-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iia-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cardEmulation } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncCallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hceElementName</span>: bundleManager.<span class="hljs-property">ElementName</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hceService</span>: cardEmulation.<span class="hljs-property">HceService</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">hceCommandCb</span>: <span class="hljs-title class_">AsyncCallback</span>&lt;<span class="hljs-built_in">number</span>[]&gt; = <span class="hljs-function">(<span class="hljs-params">error: BusinessError, hceCommand: <span class="hljs-built_in">number</span>[]</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!error) {</li><li>    <span class="hljs-keyword">if</span> (hceCommand == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommandCb has invalid hceCommand.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 应用程序根据自己业务实现，检查接收到的指令内容，发送匹配的响应数据</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommand = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(hceCommand));</li><li>    <span class="hljs-keyword">let</span> responseData = [<span class="hljs-number">0x90</span>, <span class="hljs-number">0x00</span>]; <span class="hljs-comment">// 根据接收到的不同指令更改响应数据</span></li><li>    hceService.<span class="hljs-title function_">transmit</span>(responseData).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService transmit Promise success.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceService transmit Promise error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hceCommandCb error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 判断设备是否支持NFC能力和HCE能力</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Communication.NFC.Core"</span>)) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'nfc unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!cardEmulation.<span class="hljs-title function_">hasHceCapability</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'hce unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 应用程序被运行到前台时，订阅HCE刷卡数据的接收</span></li><li>    hceService = <span class="hljs-keyword">new</span> cardEmulation.<span class="hljs-title class_">HceService</span>();</li><li>    hceService.<span class="hljs-title function_">on</span>(<span class="hljs-string">'hceCmd'</span>, hceCommandCb);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 应用进入前台</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>    <span class="hljs-comment">// 退出应用程序，取消订阅接受HCE刷卡数据</span></li><li>    hceService.<span class="hljs-title function_">off</span>(<span class="hljs-string">'hceCmd'</span>, hceCommandCb);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>