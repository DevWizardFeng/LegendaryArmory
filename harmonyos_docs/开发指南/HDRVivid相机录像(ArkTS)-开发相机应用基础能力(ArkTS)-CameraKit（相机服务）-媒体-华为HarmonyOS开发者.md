<h1 _ngcontent-yjb-c119="" class="doc-title ng-star-inserted" title="HDR Vivid相机录像(ArkTS)"> HDR Vivid相机录像(ArkTS) </h1>

<div _ngcontent-yjb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HarmonyOS支持调用接口，录制HDR Vivid视频，可以拍出层次表现更细腻、光影细节更丰富的画面，提升画面质感，呈现更卓越的视觉效果。</p> <p>当前示例提供完整的HDR Vivid录像开发步骤，方便开发者实现录制HDR Vivid视频的功能。更多HDR Vivid的开发指导，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multimedia-hdr-vivid" target="_blank">使用HDR Vivid特性开发媒体应用</a>。</p> <p>在参考以下示例前，建议开发者查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-management" target="_blank">相机开发指导(ArkTS)</a>的具体章节，了解<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-input" target="_blank">设备输入</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-session-management" target="_blank">会话管理</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording" target="_blank">录像</a>等单个流程。</p> <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><ol><li><p>导入接口。</p> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { colorSpaceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics2D'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div> </li><li><p>获取预览、录像的配置项。</p> <p>HDR录像的输出格式需要设置成10bit的CAMERA_FORMAT_YCRCB_P010。具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>预览流与录像输出流的分辨率的宽高比要保持一致，如果设置XComponent组件中的Surface显示区域宽高比为1920:1080 = 16:9，则需要预览流中的分辨率的宽高比也为16:9，如分辨率选择640:360，或960:540，或1920:1080，以此类推。</p> </div></div></div> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPreviewProfile</span>(<span class="hljs-params">previewProfiles: <span class="hljs-built_in">Array</span>&lt;camera.Profile&gt;, size: camera.Size</span>): <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">Profile</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">Profile</span> = previewProfiles.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">profile: camera.Profile</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">return</span> profile.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCRCB_P010</span> &amp;&amp;</li><li>      profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> === size.<span class="hljs-property">width</span> &amp;&amp; profile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> == size.<span class="hljs-property">height</span></li><li>  });</li><li>  <span class="hljs-keyword">return</span> previewProfile;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getVideoProfile</span>(<span class="hljs-params">videoProfiles: <span class="hljs-built_in">Array</span>&lt;camera.VideoProfile&gt;, size: camera.Size</span>): <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">VideoProfile</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">VideoProfile</span> = videoProfiles.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">profile: camera.VideoProfile</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">return</span> profile.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCRCB_P010</span> &amp;&amp;</li><li>      profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> === size.<span class="hljs-property">width</span> &amp;&amp; profile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> == size.<span class="hljs-property">height</span></li><li>  });</li><li>  <span class="hljs-keyword">return</span> videoProfile;</li><li>}</li></ol></pre></div></div> </li><li><p>查询是否支持视频防抖。</p> <p>HDR录像需要支持视频防抖。</p> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">isVideoStabilizationModeSupported</span>(<span class="hljs-params">session: camera.VideoSession, mode: camera.VideoStabilizationMode</span>): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    isSupported = session.<span class="hljs-title function_">isVideoStabilizationModeSupported</span>(mode);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The isVideoStabilizationModeSupported call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> isSupported;</li><li>}</li></ol></pre></div></div> </li><li id="li1571792313165821"><p>设置视频防抖。</p> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setVideoStabilizationMode</span>(<span class="hljs-params">session: camera.VideoSession</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">mode</span>: camera.<span class="hljs-property">VideoStabilizationMode</span> = camera.<span class="hljs-property">VideoStabilizationMode</span>.<span class="hljs-property">AUTO</span>;</li><li>  <span class="hljs-comment">// 查询是否支持视频防抖</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-title function_">isVideoStabilizationModeSupported</span>(session, mode);</li><li>  <span class="hljs-keyword">if</span> (isSupported) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setVideoStabilizationMode: <span class="hljs-subst">${mode}</span>`</span>);</li><li>    <span class="hljs-comment">// 设置视频防抖</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      session.<span class="hljs-title function_">setVideoStabilizationMode</span>(mode);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setVideoStabilizationMode call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> activeVideoStabilizationMode = session.<span class="hljs-title function_">getActiveVideoStabilizationMode</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`activeVideoStabilizationMode: <span class="hljs-subst">${activeVideoStabilizationMode}</span>`</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`videoStabilizationMode: <span class="hljs-subst">${mode}</span> is not support`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><p>查询支持的色彩空间。</p> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-params">session: camera.VideoSession</span>): <span class="hljs-title class_">Array</span>&lt;colorSpaceManager.<span class="hljs-property">ColorSpace</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;colorSpaceManager.<span class="hljs-property">ColorSpace</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    colorSpaces = session.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The getSupportedColorSpaces call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> colorSpaces;</li><li>}</li></ol></pre></div></div> </li><li id="li632101462165821"><p>设置色彩空间。</p> <p>如果是SDR录像色彩空间需要设置为BT709_LIMIT，如果是HDR录像色彩空间需要设置为BT2020_HLG_LIMIT。具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace</a>。建议在提交会话配置之前调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace</a>。</p> <div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(<span class="hljs-params">session: camera.VideoSession, isHdr: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">colorSpace</span>: colorSpaceManager.<span class="hljs-property">ColorSpace</span> = isHdr? colorSpaceManager.<span class="hljs-property">ColorSpace</span>.<span class="hljs-property">BT2020_HLG_LIMIT</span> : colorSpaceManager.<span class="hljs-property">ColorSpace</span>.<span class="hljs-property">BT709_LIMIT</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;colorSpaceManager.<span class="hljs-property">ColorSpace</span>&gt; = session.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  <span class="hljs-keyword">let</span> isSupportedColorSpaces = colorSpaces.<span class="hljs-title function_">indexOf</span>(colorSpace) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (isSupportedColorSpaces) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setColorSpace: <span class="hljs-subst">${colorSpace}</span>`</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      session.<span class="hljs-title function_">setColorSpace</span>(colorSpace);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setColorSpace call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">activeColorSpace</span>:colorSpaceManager.<span class="hljs-property">ColorSpace</span> = session.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`activeColorSpace: <span class="hljs-subst">${activeColorSpace}</span>`</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`colorSpace: <span class="hljs-subst">${colorSpace}</span> is not support`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><p>实现HDR录像。</p> <p>在创建预览输出、录像输出前执行步骤2获取配置项，提交会话配置前执行步骤6设置色彩空间，提交会话配置后执行步骤4设置视频防抖，其余流程按照正常录像流程开发。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如需在提交会话配置后，设置视频防抖模式和色彩空间，为避免相机输出流配置异常，请先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-stabilization#setvideostabilizationmode11" target="_blank">setVideoStabilizationMode</a>方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-hdr-recording#li1571792313165821">4. 设置视频防抖</a>后，再通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace</a>方法完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-hdr-recording#li632101462165821">6.设置色彩空间</a>。</p> </div></div></div> <div class="p"><div _ngcontent-yjb-c106="" class="highlight-div"><div _ngcontent-yjb-c106="" class="highlight-div-header"><div _ngcontent-yjb-c106="" class="highlight-div-header-left"><div _ngcontent-yjb-c106="" class="handle-button expand-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yjb-c106="" class="highlight-div-header-right"><div _ngcontent-yjb-c106="" class="handle-button ai-button"></div><div _ngcontent-yjb-c106="" class="handle-button line-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yjb-c106="" class="handle-button theme-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yjb-c106="" class="handle-button copy-button"><div _ngcontent-yjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yjb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cameraHdrRecordingCase</span>(<span class="hljs-params">context: common.Context, surfaceId: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建CameraManager对象</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(context);</li><li>  <span class="hljs-keyword">if</span> (!cameraManager) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"camera.getCameraManager error"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听相机状态变化</span></li><li>  cameraManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'cameraStatus'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, cameraStatusInfo: camera.CameraStatusInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraStatus with errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`camera : <span class="hljs-subst">${cameraStatusInfo.camera.cameraId}</span>`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`status: <span class="hljs-subst">${cameraStatusInfo.status}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 获取相机列表</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    cameraArray = cameraManager.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getSupportedCameras call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (cameraArray.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraManager.getSupportedCameras error"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取支持的模式类型</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneModes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">SceneMode</span>&gt; = cameraManager.<span class="hljs-title function_">getSupportedSceneModes</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupportVideoMode</span>: <span class="hljs-built_in">boolean</span> = sceneModes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (!isSupportVideoMode) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'video mode not support'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取相机设备支持的输出流能力</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraOutputCap</span>: camera.<span class="hljs-property">CameraOutputCapability</span> = cameraManager.<span class="hljs-title function_">getSupportedOutputCapability</span>(cameraArray[<span class="hljs-number">0</span>], camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>  <span class="hljs-keyword">if</span> (!cameraOutputCap) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraManager.getSupportedOutputCapability error"</span>)</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"outputCapability: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cameraOutputCap));</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">Profile</span>&gt; = cameraOutputCap.<span class="hljs-property">previewProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!previewProfilesArray) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"createOutput previewProfilesArray == null || undefined"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">VideoProfile</span>&gt; = cameraOutputCap.<span class="hljs-property">videoProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!videoProfilesArray) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"createOutput videoProfilesArray == null || undefined"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// videoProfile的宽高需要与AVRecorderProfile的宽高保持一致，并且需要使用AVRecorderProfile锁支持的宽高</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoSize</span>: camera.<span class="hljs-property">Size</span> = {</li><li>    <span class="hljs-attr">width</span>: <span class="hljs-number">640</span>,</li><li>    <span class="hljs-attr">height</span>: <span class="hljs-number">480</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">Profile</span> = <span class="hljs-title function_">getPreviewProfile</span>(previewProfilesArray, videoSize);</li><li>  <span class="hljs-keyword">if</span> (!previewProfile) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'previewProfile is not found'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">VideoProfile</span> = <span class="hljs-title function_">getVideoProfile</span>(videoProfilesArray, videoSize);</li><li>  <span class="hljs-keyword">if</span> (!videoProfile) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'videoProfile is not found'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 配置参数以实际硬件设备支持的范围为准</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aVRecorderProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>    <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">48000</span>,</li><li>    <span class="hljs-attr">audioChannels</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>,</li><li>    <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>,</li><li>    <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>,</li><li>    <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">2000000</span>,</li><li>    <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_HEVC</span>,</li><li>    <span class="hljs-attr">videoFrameWidth</span>: videoSize.<span class="hljs-property">width</span>,</li><li>    <span class="hljs-attr">videoFrameHeight</span>: videoSize.<span class="hljs-property">height</span>,</li><li>    <span class="hljs-attr">videoFrameRate</span>: <span class="hljs-number">30</span>,</li><li>    <span class="hljs-attr">isHdr</span>: <span class="hljs-literal">true</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: photoAccessHelper.<span class="hljs-property">CreateOptions</span> = {</li><li>    <span class="hljs-attr">title</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>()</li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">accessHelper</span>: photoAccessHelper.<span class="hljs-property">PhotoAccessHelper</span> = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoUri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> accessHelper.<span class="hljs-title function_">createAsset</span>(photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">VIDEO</span>, <span class="hljs-string">'mp4'</span>, options);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(videoUri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aVRecorderConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>    <span class="hljs-attr">audioSourceType</span>: media.<span class="hljs-property">AudioSourceType</span>.<span class="hljs-property">AUDIO_SOURCE_TYPE_MIC</span>,</li><li>    <span class="hljs-attr">videoSourceType</span>: media.<span class="hljs-property">VideoSourceType</span>.<span class="hljs-property">VIDEO_SOURCE_TYPE_SURFACE_YUV</span>,</li><li>    <span class="hljs-attr">profile</span>: aVRecorderProfile,</li><li>    <span class="hljs-attr">url</span>: <span class="hljs-string">`fd://<span class="hljs-subst">${file.fd.toString()}</span>`</span>, <span class="hljs-comment">// 文件需先由调用者创建，赋予读写权限，将文件fd传给此参数，eg.fd://45--file:///data/media/01.mp4</span></li><li>    <span class="hljs-attr">rotation</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 合理值0、90、180、270，非合理值prepare接口将报错</span></li><li>    <span class="hljs-attr">location</span>: { <span class="hljs-attr">latitude</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">longitude</span>: <span class="hljs-number">130</span> }</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avRecorder</span>: media.<span class="hljs-property">AVRecorder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    avRecorder = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createAVRecorder call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (avRecorder === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">prepare</span>(aVRecorderConfig);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`prepare call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoSurfaceId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 该surfaceID用于传递给相机接口创造videoOutput</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSurfaceId = <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">getInputSurface</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getInputSurface call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (videoSurfaceId === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 创建VideoOutput对象</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoOutput</span>: camera.<span class="hljs-property">VideoOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoOutput = cameraManager.<span class="hljs-title function_">createVideoOutput</span>(videoProfile, videoSurfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the videoOutput instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (videoOutput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听视频输出错误信息</span></li><li>  videoOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Preview output error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">//创建会话</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoSession</span>: camera.<span class="hljs-property">VideoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (videoSession === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听session错误信息</span></li><li>  videoSession.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Video session error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 开始配置会话</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to beginConfig. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建相机输入流</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    cameraInput = cameraManager.<span class="hljs-title function_">createCameraInput</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to createCameraInput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (cameraInput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听cameraInput错误信息</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraDevice</span>: camera.<span class="hljs-property">CameraDevice</span> = cameraArray[<span class="hljs-number">0</span>];</li><li>  cameraInput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, cameraDevice, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Camera input error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 打开相机</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> cameraInput.<span class="hljs-title function_">open</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to open cameraInput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 向会话中添加相机输入流</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addInput</span>(cameraInput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add cameraInput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建预览输出流，其中参数 surfaceId 参考下面 XComponent 组件，预览流为XComponent组件提供的surface</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    previewOutput = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, surfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the PreviewOutput instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (previewOutput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 向会话中添加预览输出流</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addOutput</span>(previewOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add previewOutput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 向会话中添加录像输出流</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addOutput</span>(videoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add videoOutput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置色彩空间</span></li><li>  <span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(videoSession, <span class="hljs-literal">true</span>);</li><li>
</li><li>  <span class="hljs-comment">// 提交会话配置</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`videoSession commitConfig error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置视频防抖</span></li><li>  <span class="hljs-title function_">setVideoStabilizationMode</span>(videoSession);</li><li>
</li><li>  <span class="hljs-comment">// 启动会话</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`videoSession start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 启动录像输出流</span></li><li>  videoOutput.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the video output. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Callback invoked to indicate the video output start success.'</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 开始录像</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`avRecorder start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止录像输出流</span></li><li>  videoOutput.<span class="hljs-title function_">stop</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop the video output. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Callback invoked to indicate the video output stop success.'</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 停止录像</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">stop</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`avRecorder stop error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止当前会话</span></li><li>  <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">stop</span>();</li><li>
</li><li>  <span class="hljs-comment">// 关闭文件</span></li><li>  fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>
</li><li>  <span class="hljs-comment">// 释放相机输入流</span></li><li>  <span class="hljs-keyword">await</span> cameraInput.<span class="hljs-title function_">close</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放预览输出流</span></li><li>  <span class="hljs-keyword">await</span> previewOutput.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放录像输出流</span></li><li>  <span class="hljs-keyword">await</span> videoOutput.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放会话</span></li><li>  <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 会话置空</span></li><li>  videoSession = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre></div></div> </div> </li></ol> </div> </div> <div></div></div>