<h1 _ngcontent-aht-c119="" class="doc-title ng-star-inserted" title="HDR Vivid视频录制"> HDR Vivid视频录制 </h1>

<div _ngcontent-aht-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>开发者可以调用本模块的Native API接口，实现在视频录制中支持HDR Vivid标准。</p> <p>视频录制的主要流程是“相机采集 &gt; 编码 &gt; 封装成mp4文件”。</p> <div class="tiledSection"><h2 id="section56157693919">HDR Vivid视频编码<i class="anchor-icon anchor-icon-link" anchorid="section56157693919" tips="复制节点链接"></i></h2><p>应用创建H.265编码器，配置profile(main 10)相机底层包含HDR Vivid的surfacebuffer内容，编码器消费surfacebuffer编码生成对应码流。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>仅在Surface模式下支持HDR Vivid视频编码。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section5151218133912" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section5151218133912" tips="复制节点链接"></i></h3><div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avdemuxer.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avsource.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p> </div></div></div> <div class="tiledSection"><h3 id="section206mcpsimp">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section206mcpsimp" tips="复制节点链接"></i></h3><ol><li>添加头文件。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div> </li><li>创建编码器实例。<p>应用可以通过名称或媒体类型创建编码器。示例中的变量说明如下：</p> <ul><li>videoEnc：视频编码器实例的指针；</li><li>OH_AVCODEC_MIMETYPE_VIDEO_HEVC：HEVC格式视频编解码器。</li></ul> <div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过mimetype创建H.265编码器实例。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li></ol></pre></div></div> </li><li>配置异步回调函数。<div class="p">添加头文件：<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li></ol></pre></div></div> <div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-type">uint32_t</span> bufferIndex = <span class="hljs-number">0</span>;</li><li>    OH_AVBuffer *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">uint8_t</span> *bufferAddr = <span class="hljs-literal">nullptr</span>;</li><li>    OH_AVCodecBufferAttr attr = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, AVCODEC_BUFFER_FLAGS_NONE};</li><li>};</li><li>std::mutex outputMutex_;</li><li>std::condition_variable outputCond_;</li><li>std::queue&lt;CodecBufferInfo&gt; outputBufferInfoQueue_;</li><li>
</li><li><span class="hljs-comment">// 设置OH_AVCodecOnNewOutputBuffer回调函数，编码完成帧送入输出队列。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnNewOutputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(outputMutex_)</span></span>;</li><li>    outputBufferInfoQueue_.<span class="hljs-built_in">emplace</span>(index, buffer);</li><li>    outputCond_.<span class="hljs-built_in">notify_all</span>();</li><li>}</li></ol></pre></div></div> </div> <p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式" target="_blank">视频编码Surface模式</a>中的“步骤3：调用OH_VideoEncoder_RegisterCallback()设置回调函数”。</p> </li><li>配置编码器。<div class="p">可选配置视频帧宽度、频帧高度、视频颜色格式。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置编码Profile为MAIN10（必须）。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">profile</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">HEVC_PROFILE_MAIN_10</span>);</li><li><span class="hljs-comment">// 配置视频原色。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">primary</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT2020</span>);</li><li><span class="hljs-comment">// 配置传输特性。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">transfer</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_PQ</span>);<span class="hljs-comment">// PQ或者HLG。</span></li><li><span class="hljs-comment">// 配置最大矩阵系数。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">matrix</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_MatrixCoefficient</span>::<span class="hljs-title class_">MATRIX_COEFFICIENT_BT2020_CL</span>);</li><li><span class="hljs-comment">// 配置关键帧的间隔，单位为毫秒。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">iFrameInterval</span> = <span class="hljs-number">100</span>;</li><li>
</li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">profile</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">primary</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">transfer</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">matrix</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_I_FRAME_INTERVAL</span>, <span class="hljs-variable">iFrameInterval</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-number">1</span>);</li><li><span class="hljs-comment">// 配置编码器。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li></ol></pre></div></div> </div> </li><li>获取surface，并设置给相机。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式" target="_blank">视频编码Surface模式</a>中的“步骤6：获取surface”。</p> </li><li>调用OH_VideoEncoder_Start()启动编码器。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式" target="_blank">视频编码Surface模式</a>中的“步骤8：调用OH_VideoEncoder_Start()启动编码器”。</p> </li></ol> </div> <div class="tiledSection"><h2 id="section118657562539">HDR Vivid视频封装<i class="anchor-icon anchor-icon-link" anchorid="section118657562539" tips="复制节点链接"></i></h2><p>调用Muxer可以将HDR Vivid码流封装成文件，码流格式需指定为hevc码流，并设置宽、高、isHDRVivid信息。Color信息通常需要从编码获取并设置给封装器。</p> </div> <div class="tiledSection"><h3 id="section17133194210210" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section17133194210210" tips="复制节点链接"></i></h3><div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avmuxer.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p> </div></div></div> <div class="tiledSection"><h3 id="section249mcpsimp">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section249mcpsimp" tips="复制节点链接"></i></h3><ol><li>添加头文件。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avmuxer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li></ol></pre></div></div> </li><li>调用OH_AVMuxer_Create()创建封装器实例对象。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置封装格式为mp4。</span></li><li><span class="hljs-type">OH_AVOutputFormat</span> <span class="hljs-variable">outputFormat</span> <span class="hljs-operator">=</span> AV_OUTPUT_FORMAT_MPEG_4;</li><li><span class="hljs-comment">// 以读写方式创建fd。</span></li><li><span class="hljs-type">int32_t</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> open(<span class="hljs-string">"test.mp4"</span>, O_CREAT | O_RDWR | O_TRUNC, S_IRUSR | S_IWUSR);</li><li>OH_AVMuxer *muxer = OH_AVMuxer_Create(fd, outputFormat);</li></ol></pre></div></div> </li><li>添加视频轨，并指定类型为HDR Vivid类型。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int</span> <span class="hljs-variable">videoTrackId</span> = -<span class="hljs-number">1</span>;</li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">buffer</span> = ...; <span class="hljs-comment">// 编码config data，如果没有可以不传。</span></li><li><span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = ...;  <span class="hljs-comment">// 编码config data的长度，根据实际情况配置。</span></li><li>
</li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">formatVideo</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_CODEC_MIME</span>, <span class="hljs-variable">OH_AVCODEC_MIMETYPE_VIDEO_HEVC</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-number">1280</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-number">720</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-comment">// (可选)HDR Vivid视频封装时必填，指定为HDR Vivid视频。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_IS_HDR_VIVID</span>, <span class="hljs-number">1</span>);</li><li><span class="hljs-comment">// （可不设置，封装器从编码码流xps自动解析） 设置Color信息，如下。</span></li><li><span class="hljs-comment">// 这些信息也可以通过调用OH_VideoEncoder_GetOutputDescription(OH_AVCodec *codec)接口从编码器中获取。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-number">1</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT2020</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_PQ</span>); <span class="hljs-comment">// PQ或者HLG。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">formatVideo</span>, <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">OH_MatrixCoefficient</span>::<span class="hljs-title class_">MATRIX_COEFFICIENT_BT2020_CL</span>);</li><li>
</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVMuxer_AddTrack</span>(<span class="hljs-variable">muxer</span>, &amp;<span class="hljs-title class_">videoTrackId</span>, <span class="hljs-variable">formatVideo</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">videoTrackId</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 视频轨添加失败。</span></li><li>}</li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">formatVideo</span>); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section9884733235">处理视频帧数据<i class="anchor-icon anchor-icon-link" anchorid="section9884733235" tips="复制节点链接"></i></h2></div> <ol><li>写入封装数据。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// start后，才能开始写入数据。</span></li><li><span class="hljs-type">int</span> <span class="hljs-variable">trackId</span> <span class="hljs-operator">=</span> videoTrackId; <span class="hljs-comment">// 选择写的媒体轨。</span></li><li><span class="hljs-comment">// 取出回调函数OnNewOutputBuffer送入输出队列的帧buffer。</span></li><li><span class="hljs-type">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> <span class="hljs-operator">=</span> outputBufferInfoQueue_.front();</li><li>outputBufferInfoQueue_.pop();</li><li>ret = OH_AVMuxer_WriteSampleBuffer(muxer, trackId, bufferInfo.buffer);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div> </li><li>调用OH_VideoEncoder_FreeOutputBuffer()释放编码帧。<div _ngcontent-aht-c106="" class="highlight-div"><div _ngcontent-aht-c106="" class="highlight-div-header"><div _ngcontent-aht-c106="" class="highlight-div-header-left"><div _ngcontent-aht-c106="" class="handle-button expand-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aht-c106="" class="highlight-div-header-right"><div _ngcontent-aht-c106="" class="handle-button ai-button"></div><div _ngcontent-aht-c106="" class="handle-button line-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aht-c106="" class="handle-button theme-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aht-c106="" class="handle-button copy-button"><div _ngcontent-aht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放已完成写入的数据，index为对应输出队列的下标。</span></li><li>ret = OH_VideoEncoder_FreeOutputBuffer(videoEnc, bufferInfo.bufferIndex);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div> </li></ol> </div> <div></div></div>