<h1 _ngcontent-sag-c119="" class="doc-title ng-star-inserted" title="HDR Vivid视频播放"> HDR Vivid视频播放 </h1>

<div _ngcontent-sag-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>开发者可以调用本模块的Native API接口，实现在视频播放中支持HDR Vivid标准。</p> <p>视频播放的主要流程，是将视频文件“解封装 &gt; 解码 &gt; 送显/播放”。</p> <div class="tiledSection"><h2 id="section189714375125">HDR Vivid视频解析<i class="anchor-icon anchor-icon-link" anchorid="section189714375125" tips="复制节点链接"></i></h2><p>从视频文件中，可以解析出其是否为HDR Vivid视频，如果视频源为HDR Vivid视频，可以解析相关的信息，如元数据、颜色信息（Color）等。</p> </div> <div class="tiledSection"><h3 id="section1151820124146" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section1151820124146" tips="复制节点链接"></i></h3><div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avdemuxer.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avsource.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p> </div></div></div> <div class="tiledSection"><h3 id="section116mcpsimp">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section116mcpsimp" tips="复制节点链接"></i></h3><ol><li>添加头文件。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avdemuxer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avsource.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li></ol></pre></div></div> </li><li>文件解析器。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建文件操作符 fd，打开时对文件实例必须有读权限（filePath 为待解封装文件路径，需预置文件，保证路径指向的文件存在）。</span></li><li>std::string filePath = <span class="hljs-string">"test.mp4"</span>;</li><li><span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(filePath.<span class="hljs-built_in">c_str</span>(), O_RDONLY);</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> fileStatus {};</li><li><span class="hljs-comment">// 获取fileSize。</span></li><li><span class="hljs-type">size_t</span> fileSize = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(filePath.<span class="hljs-built_in">c_str</span>(), &amp;fileStatus) == <span class="hljs-number">0</span>) {</li><li>   fileSize = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(fileStatus.st_size);</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"get stat failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 为 fd 资源文件创建 source 资源实例。</span></li><li>OH_AVSource *source = <span class="hljs-built_in">OH_AVSource_CreateWithFD</span>(fd, <span class="hljs-number">0</span>, fileSize);</li><li><span class="hljs-keyword">if</span> (source == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create source failed"</span>);</li><li>   <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> </li><li>获取视频轨道信息，查询文件HDR类型。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> trackCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> audioTrackIndex = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> videoTrackIndex = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> trackType;</li></ol></pre></div></div> <div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 从文件 source 信息获取文件轨道数。</span></li><li>OH_AVFormat *sourceFormat = <span class="hljs-built_in">OH_AVSource_GetSourceFormat</span>(source);</li><li><span class="hljs-keyword">if</span> (sourceFormat == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"get source format failed"</span>);</li><li>   <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-type">bool</span> getTrackRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(sourceFormat, OH_MD_KEY_TRACK_COUNT, &amp;trackCount);</li><li><span class="hljs-keyword">if</span> (!getTrackRet) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(sourceFormat);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> index = <span class="hljs-number">0</span>; index &lt; (<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int32_t</span>&gt;(trackCount)); index++) {</li><li>   <span class="hljs-comment">// 获取轨道信息。</span></li><li>   OH_AVFormat *format = <span class="hljs-built_in">OH_AVSource_GetTrackFormat</span>(source, index);</li><li>   <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"get track format failed"</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>   }</li><li>   <span class="hljs-comment">// 判断轨道类型。</span></li><li>   <span class="hljs-built_in">static_cast</span>&lt;OH_MediaType&gt;(trackType) == OH_MediaType::MEDIA_TYPE_AUD ? audioTrackIndex = index : videoTrackIndex = index;</li><li>   <span class="hljs-comment">// 查询文件HDR类型，是否为HDR Vivid视频。</span></li><li>   <span class="hljs-type">int32_t</span> isHDRVivid = <span class="hljs-number">0</span>;</li><li>   <span class="hljs-type">bool</span> getHdrRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_IS_HDR_VIVID, &amp;isHDRVivid);</li><li>   <span class="hljs-keyword">if</span> (getHdrRet == <span class="hljs-literal">false</span> || isHDRVivid == <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"is not HDRVivid "</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>   }</li><li>   <span class="hljs-built_in">OH_AVFormat_Destroy</span>(format); <span class="hljs-comment">// 销毁。</span></li><li>}</li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section182234161516">HDR Vivid视频解码<i class="anchor-icon anchor-icon-link" anchorid="section182234161516" tips="复制节点链接"></i></h2><p>应用创建H.265解码器，并配置宽、高、format信息。解码器解析码流，生成对应的视频帧数据以及元数据。</p> <p>当前支持surface输出与buffer输出两种类型，差异如下：</p> <p>在接口调用的过程中，两种方式的接口调用方式基本一致，但存在以下差异点：</p> <ul><li>Surface模式下，应用在解码器就绪前，必须调用OH_VideoDecoder_SetSurface接口设置OHNativeWindow。</li><li>Buffer模式下，可以通过调用OH_AVBuffer_GetNativeBuffer接口将buffer转换为nativebuffer，再通过调用OH_NativeBuffer_GetMetadataValue接口获取元数据。</li></ul> </div> <div class="tiledSection"><h3 id="section569711101165" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section569711101165" tips="复制节点链接"></i></h3><div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p> </div></div></div> <div class="tiledSection"><h3 id="section144521438142011">定义基础结构<i class="anchor-icon anchor-icon-link" anchorid="section144521438142011" tips="复制节点链接"></i></h3></div> <p>本部分示例代码按照C++17标准编写，仅作参考。开发者可以参考此部分，定义自己的buffer对象。</p> <ol><li>添加头文件。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div> </li><li>解码器回调buffer的信息。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer): <span class="hljs-built_in">index</span>(index), <span class="hljs-built_in">buffer</span>(buffer), <span class="hljs-built_in">isValid</span>(<span class="hljs-literal">true</span>) {}</li><li>    <span class="hljs-comment">// 回调buffer。</span></li><li>    OH_AVBuffer *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 回调buffer对应的index。</span></li><li>    <span class="hljs-type">uint32_t</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 判断当前buffer信息是否有效。</span></li><li>    <span class="hljs-type">bool</span> isValid = <span class="hljs-literal">true</span>;</li><li>};</li></ol></pre></div></div> </li><li>解码输入输出队列。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodecBufferQueue</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-comment">// 将回调buffer的信息传入队列。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Enqueue</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">bufferInfo</span>);</li><li>        <span class="hljs-variable">cond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取回调buffer的信息。</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">Dequeue</span>(<span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">timeoutMs</span> = <span class="hljs-number">1000</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        (<span class="hljs-variable">void</span>)<span class="hljs-variable">cond_</span>.<span class="hljs-title function_">wait_for</span>(<span class="hljs-variable">lock</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-title class_">timeoutMs</span>), [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">bufferInfo</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空队列，之前的回调buffer设置为不可用。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Flush</span>()</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-keyword">while</span> (!<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>            <span class="hljs-comment">// Flush、Stop、Reset、Destroy操作之后，之前回调的buffer信息设置为无效。</span></li><li>            <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        }</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">mutex_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">cond_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;&gt; <span class="hljs-title class_">bufferQueue_</span>;</li><li>};</li></ol></pre></div></div> </li><li>全局变量。<div class="p">仅作参考，可以根据实际情况将其封装到对象中。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解码器实例指针。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 解码器同步锁。</span></li><li>std::shared_mutex codecMutex;</li><li><span class="hljs-comment">// 解码器输入队列。</span></li><li>CodecBufferQueue inQueue;</li><li><span class="hljs-comment">// 解码器输出队列。</span></li><li>CodecBufferQueue outQueue;</li></ol></pre></div></div> </div> </li></ol> <div class="tiledSection"><h3 id="section148mcpsimp">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section148mcpsimp" tips="复制节点链接"></i></h3><p><strong>Surface模式</strong></p> <ol><li>创建H.265解码器实例。<p>应用可以通过名称或媒体类型创建解码器。示例中的变量说明如下：</p> <ul><li>videoDec：视频解码器实例的指针。</li><li>OH_AVCODEC_MIMETYPE_VIDEO_HEVC：HEVC格式视频编解码器。</li></ul> <div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过mimetype创建H.265解码器实例。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li></ol></pre></div></div> </li><li>配置异步回调函数。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解码输入回调OH_AVCodecOnNeedInputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 输入帧的数据buffer和对应的index送入inQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div> <p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>中的“步骤-3：调用OH_VideoDecoder_RegisterCallback()设置回调函数”。</p> </li><li>配置解码器。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>中的“步骤-5：调用OH_VideoDecoder_Configure()配置解码器”。</p> </li><li>设置surface。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>中的“步骤-6：设置surface”。</p> </li><li>调用OH_VideoDecoder_Start()启动解码器。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>中的“步骤-8：调用OH_VideoDecoder_Start()启动解码器”。</p> </li></ol> <p></p> <p><strong>Buffer模式</strong></p> <ol><li>创建H.265解码器实例。<p>应用可以通过名称或媒体类型创建解码器。示例中的变量说明如下：</p> <ul><li>videoDec：视频解码器实例的指针。</li><li>OH_AVCODEC_MIMETYPE_VIDEO_HEVC：HEVC格式视频编解码器。</li></ul> <div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过mimetype创建H.265解码器实例。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li></ol></pre></div></div> </li><li>配置异步回调函数。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解码输入回调OH_AVCodecOnNeedInputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 输入帧的数据buffer和对应的index送入inQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码输出回调OH_AVCodecOnNewOutputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNewOutputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 完成帧的数据buffer和对应的index送入outQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    outQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div> <p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式" target="_blank">视频解码Buffer模式</a>中的“步骤-3：调用OH_VideoDecoder_RegisterCallback()设置回调函数”。</p> </li><li>配置解码器。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式" target="_blank">视频解码Buffer模式</a>中的“步骤-5：调用OH_VideoDecoder_Configure()配置解码器”。</p> </li><li>调用OH_VideoDecoder_Start()启动解码器。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式" target="_blank">视频解码Buffer模式</a>中的“步骤-7：调用OH_VideoDecoder_Start()启动解码器”。</p> </li><li>获取元数据。<p>在 CMake 脚本中链接动态库。</p> <div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_buffer.so)</li></ol></pre></div></div> <div class="p">添加头文件。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li></ol></pre></div></div> </div> <div class="p">示例代码如下：<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 元数据的大小。</span></li><li><span class="hljs-type">int32_t</span> size = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 元数据实例指针。</span></li><li><span class="hljs-type">uint8_t</span> *metadata = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 存储元数据的容器。</span></li><li>std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; meta;</li><li>
</li><li><span class="hljs-comment">// 取出回调函数OnNewOutputBuffer存到输出队列的帧buffer。</span></li><li>std::shared_ptr&lt;CodecBufferInfo&gt; bufferInfo = outQueue.<span class="hljs-built_in">Dequeue</span>();</li><li><span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li><span class="hljs-keyword">if</span> (bufferInfo == <span class="hljs-literal">nullptr</span> || !bufferInfo-&gt;isValid) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 获取OH_NativeBuffer指针实例。</span></li><li>OH_NativeBuffer *nativeBuffer = <span class="hljs-built_in">OH_AVBuffer_GetNativeBuffer</span>(bufferInfo.buffer);</li><li><span class="hljs-keyword">if</span> (nativeBuffer != <span class="hljs-literal">nullptr</span>){</li><li>    <span class="hljs-comment">// 获取static元数据。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_NativeBuffer_GetMetadataValue</span>(nativeBuffer, OH_HDR_STATIC_METADATA, &amp;size, &amp;metadata) != <span class="hljs-number">0</span>){</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>        meta.<span class="hljs-built_in">resize</span>(size);</li><li>        <span class="hljs-built_in">memcpy</span>(&amp;meta[<span class="hljs-number">0</span>], metadata, size);</li><li>        <span class="hljs-keyword">delete</span>[] metadata;</li><li>        metadata = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 获取dynamic元数据。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_NativeBuffer_GetMetadataValue</span>(nativeBuffer, OH_HDR_DYNAMIC_METADATA, &amp;size, &amp;metadata) != <span class="hljs-number">0</span>){</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>        meta.<span class="hljs-built_in">resize</span>(size);</li><li>        <span class="hljs-built_in">memcpy</span>(&amp;meta[<span class="hljs-number">0</span>], metadata, size);</li><li>        <span class="hljs-keyword">delete</span>[] metadata;</li><li>        metadata = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li><li><span class="hljs-comment">//销毁nativebuffer。</span></li><li><span class="hljs-keyword">if</span> (nativeBuffer != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">OH_NativeBuffer_Unreference</span>(nativeBuffer);</li><li>    nativeBuffer = <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div> </li></ol> </div> <div class="tiledSection"><h2 id="section085610241334">处理视频帧数据<i class="anchor-icon anchor-icon-link" anchorid="section085610241334" tips="复制节点链接"></i></h2><ol><li>解封装，循环获取帧数据。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">bool</span> <span class="hljs-variable">videoIsEnd</span> = <span class="hljs-keyword">false</span>;</li><li><span class="hljs-comment">// 为资源实例创建对应的解封装器。</span></li><li><span class="hljs-variable">OH_AVDemuxer</span> *<span class="hljs-variable">demuxer</span> = <span class="hljs-title function_">OH_AVDemuxer_CreateWithSource</span>(<span class="hljs-variable">source</span>);</li><li><span class="hljs-comment">// 取出回调函数OnNeedInputBuffer存到输入队列的帧buffer。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 解封装帧数据。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVDemuxer_ReadSampleBuffer</span>(<span class="hljs-variable">demuxer</span>, <span class="hljs-variable">videoTrackIndex</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> == <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>   <span class="hljs-comment">// 可通过buffer获取并处理视频帧数据。</span></li><li>    <span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li>    <span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">getBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">getBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">info</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">OH_AVCodecBufferFlags</span>::<span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>        <span class="hljs-variable">videoIsEnd</span> = <span class="hljs-keyword">true</span>;</li><li>    }</li><li>}</li></ol></pre></div></div> </li><li>将解封装后的视频帧数据送入解码输入队列。<div _ngcontent-sag-c106="" class="highlight-div"><div _ngcontent-sag-c106="" class="highlight-div-header"><div _ngcontent-sag-c106="" class="highlight-div-header-left"><div _ngcontent-sag-c106="" class="handle-button expand-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sag-c106="" class="highlight-div-header-right"><div _ngcontent-sag-c106="" class="handle-button ai-button"></div><div _ngcontent-sag-c106="" class="handle-button line-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sag-c106="" class="handle-button theme-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sag-c106="" class="handle-button copy-button"><div _ngcontent-sag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sag-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 送入解码输入队列进行解码，index为对应队列下标。</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_PushInputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div> <p>后续步骤具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding" target="_blank">视频解码</a>。</p> </li></ol> </div> </div> <div></div></div>