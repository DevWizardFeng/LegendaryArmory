<h1 _ngcontent-cnm-c119="" class="doc-title ng-star-inserted" title="HarmonyOS ABI"> HarmonyOS ABI </h1>

<div _ngcontent-cnm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HarmonyOS系统支持丰富的设备形态，支持多种架构指令集，支持多种操作系统内核；HarmonyOS遵循“OHOS”ABI定义，保持与社区ABI的一致性。</p> <p>本文定义了"OHOS" ABI（Application Binary Interface）的基础标准，包含如下方面。</p>  <div class="tiledSection"><h2 id="字节序和字宽">字节序和字宽<i class="anchor-icon anchor-icon-link" anchorid="字节序和字宽" tips="复制节点链接"></i></h2><p>"OHOS" ABI始终采用little-endian，32位系统采用ILP32，64位系统采用LP64。</p> </div>  <div class="tiledSection"><h2 id="过程调用规范">过程调用规范<i class="anchor-icon anchor-icon-link" anchorid="过程调用规范" tips="复制节点链接"></i></h2><p>过程调用规范（Procedure Call Standard）定义了函数调用的参数传递方式，寄存器使用规则，栈操作规则等；不同C++编译器，不同操作系统，不同架构都有可能采用不同的调用规则。详细内容请参考《<a href="https://www.agner.org/optimize/calling_conventions.pdf" target="_blank">不同C++编译器和操作系统的调用规范</a>》。架构相关的函数调用规范，请参考：</p> <ul><li><p>ARM相关的调用规范请参考《<a href="https://github.com/ARM-software/abi-aa/tree/main/aapcs32" target="_blank">ARM32过程调用标准</a>》。</p>  </li><li><p>ARM64相关的调用规范请参考《<a href="https://github.com/ARM-software/abi-aa/tree/main/aapcs64" target="_blank">ARM64过程调用标准</a>》。</p>  </li></ul> </div>  <div class="tiledSection"><h2 id="c-abi">C++ ABI<i class="anchor-icon anchor-icon-link" anchorid="c-abi" tips="复制节点链接"></i></h2><p>HarmonyOS系统采用llvm项目中的libc++作为C++运行时库，在系统侧使用libc++.so库来承载，应用侧使用libc++_shared.so来承载，两侧共用一套代码，采用不同的C++命名空间。C++的符号重整规则请参考《<a href="https://itanium-cxx-abi.github.io/cxx-abi/" target="_blank">Itanium C++ ABI</a>》。</p> </div>  <div class="tiledSection"><h2 id="浮点格式">浮点格式<i class="anchor-icon anchor-icon-link" anchorid="浮点格式" tips="复制节点链接"></i></h2><p>采用IEEE754作为浮点编码格式，针对long double的格式定义，将在<a href="/consumer/cn/doc/harmonyos-guides/ohos-abi#支持架构abi">支持架构ABI</a>具体说明。</p> </div>  <div class="tiledSection"><h2 id="可执行文件格式">可执行文件格式<i class="anchor-icon anchor-icon-link" anchorid="可执行文件格式" tips="复制节点链接"></i></h2><p>HarmonyOS系统采用ELF文件格式作为全系统的二进制文件格式，具体格式详情，请参考《<a href="https://refspecs.linuxfoundation.org/elf/gabi4+/contents.html" target="_blank">System V Application Binary Interface</a>》。CPU架构相关的格式定义，参考下面对应架构说明。</p> <ul><li><p>arm相关的elf文件格式定义请参考《<a href="https://github.com/ARM-software/abi-aa/tree/main/aaelf32" target="_blank">arm架构elf文件格式</a>》。</p>  </li><li><p>arm64相关elf文件格式定义请参考《<a href="https://github.com/ARM-software/abi-aa/tree/main/aaelf64" target="_blank">arm64架构elf文件格式</a>》。</p>  </li></ul> </div>  <div class="tiledSection"><h2 id="支持架构abi">支持架构ABI<i class="anchor-icon anchor-icon-link" anchorid="支持架构abi" tips="复制节点链接"></i></h2><p>下面介绍下当前“OHOS” ABI中支持的架构以及差异点。</p> </div>  <div class="tiledSection"><h3 id="armeabi-v7a" class="firsth2">armeabi-v7a<i class="anchor-icon anchor-icon-link" anchorid="armeabi-v7a" tips="复制节点链接"></i></h3><p>此ABI是以<a href="https://developer.arm.com/Architectures/ABI" target="_blank">《ARM架构应用二进制接口》</a>为基础制定，适用于32位armv7a架构的cpu，支持的核心包括Cortex-A5，Cortex-A7，Cortex-A8，Cortex-A9，Cortex-A12，Cortex-A15，以及Cortex-A17，支持arm32，thumb-2，VFPv3-D16指令。</p> <p>此ABI使用-mfloat-cpu=softfp作为强制浮点数调用规则，本身不影响实际指令是否使用硬件浮点指令。Neon指令等其他扩展在此ABI中是可选的，为了更好的兼容性，建议应用开发者采用-mfpu=softvfp来编译native库 。</p> <p>此ABI使用64位long double(IEEE binary64)。</p> <p>当前通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-ide">DevEco Studio构建NDK工程</a>时，不支持armeabi-v7a编译环境。如需要在HarmonyOS中使用该编译环境，需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-cmake">CMake方式构建</a>。</p> </div>  <div class="tiledSection"><h3 id="arm64-v8a">arm64-v8a<i class="anchor-icon anchor-icon-link" anchorid="arm64-v8a" tips="复制节点链接"></i></h3><p>此ABI是以《ARM架构应用二进制接口》为基础制定，支持AArch64指令集，默认支持neon特性。</p> <p>此ABI使用-mfloat-cpu=softfp作为强制浮点数调用规则。</p> <p>此ABI使用128位long double(IEEE binary128)。</p> </div>  <div class="tiledSection"><h3 id="x86_64">x86_64<i class="anchor-icon anchor-icon-link" anchorid="x86_64" tips="复制节点链接"></i></h3><p>此ABI是以Intel64和IA-32 ABI为基础，支持MMX、SSE、SSE2、SSE3、SSSE3、SSE4.1等指令，与x86相关的规范参考《System V Application Binary Interface》、《AMD64 Architecture Processor Supplement》。</p> <p>此ABI使用128位long double(IEEE binary128)，x86架构上很多平台采用float80格式，HarmonyOS仍然采用128bit形式。</p> </div>  <div class="tiledSection"><h2 id="在编译架构中指定abi">在编译架构中指定ABI<i class="anchor-icon anchor-icon-link" anchorid="在编译架构中指定abi" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="deveco-studio中设置" class="firsth2">DevEco Studio中设置<i class="anchor-icon anchor-icon-link" anchorid="deveco-studio中设置" tips="复制节点链接"></i></h3><p>在HarmonyOS的C++工程中，找到C++代码所在项目build-profile.json5文件buildOption/externalNativeOptions字段，添加abiFilters字段：</p> <div _ngcontent-cnm-c106="" class="highlight-div"><div _ngcontent-cnm-c106="" class="highlight-div-header"><div _ngcontent-cnm-c106="" class="highlight-div-header-left"><div _ngcontent-cnm-c106="" class="handle-button expand-button"><div _ngcontent-cnm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnm-c106="" class="highlight-div-header-right"><div _ngcontent-cnm-c106="" class="handle-button ai-button"></div><div _ngcontent-cnm-c106="" class="handle-button line-button"><div _ngcontent-cnm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnm-c106="" class="handle-button theme-button"><div _ngcontent-cnm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnm-c106="" class="handle-button copy-button"><div _ngcontent-cnm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnm-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"apiType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stageMode"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"buildOption"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"externalNativeOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/main/cpp/CMakeLists.txt"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"abiFilters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                <span class="hljs-string">"arm64-v8a"</span></li><li>            <span class="hljs-punctuation">]</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p><strong>注意</strong>：如果DevEco Studio中不设置abiFilters字段，则默认配置的指定架构为：arm64-v8a。</p> </div>  <div class="tiledSection"><h3 id="cmake中设置">cmake中设置<i class="anchor-icon anchor-icon-link" anchorid="cmake中设置" tips="复制节点链接"></i></h3><p>通过SDK CAPI开发native代码的时候，在build/cmake/ohos.toolchain.cmake中定义了HarmonyOS系统一些交叉编译常用的环境变量设置。其中OHOS_ARCH变量定义了当前目标编译的ABI，可以设置下面三个ABI中的一种，arm64-v8a，armeabi-v7a，x86_64。</p> </div> </div> <div></div></div>