<h1 _ngcontent-npc-c119="" class="doc-title ng-star-inserted" title="HiAppEvent常见问题"> HiAppEvent常见问题 </h1>

<div _ngcontent-npc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="查不到已通过hiappevent订阅的事件内容">查不到已通过HiAppEvent订阅的事件内容<i class="anchor-icon anchor-icon-link" anchorid="查不到已通过hiappevent订阅的事件内容" tips="复制节点链接"></i></h2>          <p><strong>问题现象</strong></p>     <p>在开发调试阶段，崩溃、应用冻屏等故障发生后，无法在DevEco Studio的HiLog窗口中获取已通过HiAppEvent订阅的事件内容。</p>     <p><strong>可能的原因&amp;解决措施</strong></p>     <p>发生崩溃、应用冻屏等故障后，应用已退出。</p>     <p>解决办法：再次启动应用，查看相应的事件内容。</p>    </div>    <div class="tiledSection">     <h2 id="无法获取external_log日志文件">无法获取external_log日志文件<i class="anchor-icon anchor-icon-link" anchorid="无法获取external_log日志文件" tips="复制节点链接"></i></h2>          <p><strong>问题现象</strong></p>     <p>Hilog中出现如下日志：</p>     <ul>      <li>       <p>eventInfo.params.external_log=[]</p></li>      <li>       <p>HiAppEvent file does not exist</p></li>     </ul>     <p><strong>可能的原因&amp;解决措施</strong></p>     <p><strong>情况一</strong>：</p>     <p>external_log日志文件所在目录的空间已达到上限。</p>     <p>external_log所在的目录为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory">应用沙箱目录</a>，目录空间受限。log_over_limit字段用于判断external_log日志文件所在目录的空间是否达到上限。如果log_over_limit的值为true，表示external_log日志文件所在目录空间已达到上限，事件包含的日志文件将无法写入。</p>     <p>external_log是一个字符串数组。例如：</p>     <p>external_log=["/data/storage/el2/log/hiappevent/APP_CRASH_时间戳_xxxx.log"]。</p>     <p><strong>可采取的解决措施</strong>：</p>     <p>参考<a href="/consumer/cn/doc/harmonyos-guides/hiappevent-faq#无法删除external_log日志文件">无法删除external_log日志文件</a>中的解决措施，清理历史日志文件。</p>     <p><strong>情况二</strong>：</p>     <p>部分系统事件（如启动耗时事件）本身没有external_log，因而没有external_log日志文件。</p>     <p><strong>可采取的解决措施</strong>：</p>     <p>查看对应的事件介绍章节，确认事件是否包含external_log：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/event-subscription-overview#系统事件">系统事件</a>。</p>     <p><strong>情况三</strong>：</p>     <p>事件发生在事件订阅之前。</p>     <p>在调用事件订阅接口addWatcher()前，没有开始监听系统事件。因此事件订阅之前的事件没有external_log日志文件。</p>     <p><strong>可采取的解决措施</strong>：</p>     <p>确认事件订阅与事件发生的时序关系。先事件订阅，然后事件发生，才能获取到事件的external_log日志文件。</p>     <p><strong>情况四</strong>：</p>     <p>系统事件没有触发成功。</p>     <p>如果系统事件没发生，就不会有external_log日志文件。</p>     <p><strong>可采取的解决措施</strong>：</p>     <p>查看系统事件的其他日志，确认系统事件是否已经触发成功。</p>     <p><strong>情况五</strong>：</p>     <p>external_log日志文件生成后又被删除了。</p>     <p>例如，在一个应用中，A和B两个模块都订阅了系统事件C。A模块处理完系统事件C的回调后，删除了external_log日志文件。随后B模块在系统事件C的回调中访问external_log日志文件，会提示日志文件不存在。</p>     <p><strong>可采取的解决措施</strong>：</p>     <p>检查其他模块是否已删除external_log日志文件。</p>    </div>    <div class="tiledSection">     <h2 id="无法删除external_log日志文件">无法删除external_log日志文件<i class="anchor-icon anchor-icon-link" anchorid="无法删除external_log日志文件" tips="复制节点链接"></i></h2>          <p><strong>问题现象</strong></p>     <p>external_log日志文件所在目录的空间已达到上限，但无法删除external_log日志文件。</p>     <p><strong>解决措施</strong></p>     <ul>      <li>       <p>开发者如果有权限访问设备的/data/app目录，可以手动删除external_log日志文件。文件目录为</p>       <p>/data/app/el2/100/log/应用包名/hiappevent（或resourcelimit或watchdog）。</p></li>      <li>       <p>开发者若没有权限访问设备的/data/app目录，可以在应用代码中删除external_log日志文件。代码示例如下。文件删除接口可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#fsunlink" target="_blank">fs.unlink</a>。</p></li>     </ul>     <p><strong>代码示例</strong></p>     <div _ngcontent-npc-c106="" class="highlight-div"><div _ngcontent-npc-c106="" class="highlight-div-header"><div _ngcontent-npc-c106="" class="highlight-div-header-left"><div _ngcontent-npc-c106="" class="handle-button expand-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-npc-c106="" class="highlight-div-header-right"><div _ngcontent-npc-c106="" class="handle-button ai-button"></div><div _ngcontent-npc-c106="" class="handle-button line-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-npc-c106="" class="handle-button theme-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-npc-c106="" class="handle-button copy-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-npc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>  hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>    <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"AppCrashWatcher"</span>,</li><li>    <span class="hljs-comment">// 订阅过滤条件，这里是订阅了系统事件中的崩溃事件</span></li><li>    <span class="hljs-attr">appEventFilters</span>: [</li><li>      {</li><li>        <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>        <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_CRASH</span>]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-comment">// 实现onReceive回调，监听到事件后实时回调</span></li><li>    <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>          <span class="hljs-comment">// 开发者可以获取到崩溃事件发生的时间戳</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.time=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'time'</span>])}</span>`</span>);</li><li>          <span class="hljs-comment">// 开发者可以获取到崩溃应用的包名</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.bundle_name=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'bundle_name'</span>])}</span>`</span>);</li><li>          <span class="hljs-comment">// 开发者可以获取到崩溃事件发生时的故障日志文件</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.external_log=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'external_log'</span>])}</span>`</span>);</li><li>
</li><li>          <span class="hljs-keyword">if</span> (eventInfo.<span class="hljs-property">params</span>[<span class="hljs-string">'external_log'</span>] != <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; eventInfo.<span class="hljs-property">params</span>[<span class="hljs-string">'external_log'</span>].<span class="hljs-property">length</span>; ++index) {</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">externalLog</span>: <span class="hljs-built_in">string</span> = eventInfo.<span class="hljs-property">params</span>[<span class="hljs-string">'external_log'</span>][index];</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`externalLog=<span class="hljs-subst">${externalLog}</span>`</span>);</li><li>              <span class="hljs-comment">// 验证访问权限：</span></li><li>              <span class="hljs-keyword">let</span> res = fs.<span class="hljs-title function_">accessSync</span>(externalLog);</li><li>              <span class="hljs-keyword">if</span> (res) {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent file exists`</span>);</li><li>              } <span class="hljs-keyword">else</span> {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent file does not exist`</span>);</li><li>              }</li><li>              <span class="hljs-comment">// 验证读写权限：</span></li><li>              fs.<span class="hljs-title function_">open</span>(externalLog, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">file: fs.File</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent file=<span class="hljs-subst">${externalLog}</span> fd=<span class="hljs-subst">${file.fd}</span>`</span>);</li><li>              fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>                <span class="hljs-string">`HiAppEvent open file=<span class="hljs-subst">${externalLog}</span> failed with error message=<span class="hljs-subst">${err.message}</span>, error code=<span class="hljs-subst">${err.code}</span>`</span>);</li><li>              });</li><li>              <span class="hljs-comment">// 删除external_log日志文件：</span></li><li>              fs.<span class="hljs-title function_">unlink</span>(externalLog).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"HiAppEvent remove file:"</span> + externalLog + <span class="hljs-string">" succeed"</span>);</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"HiAppEvent remove file:"</span> + externalLog + <span class="hljs-string">" failed with error message: "</span> + err.<span class="hljs-property">message</span> +</li><li>                <span class="hljs-string">", error code: "</span> + err.<span class="hljs-property">code</span>);</li><li>              });</li><li>            }</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  });</li></ol></pre></div></div>     <p>访问及删除external_log日志文件的日志：</p>     <div _ngcontent-npc-c106="" class="highlight-div"><div _ngcontent-npc-c106="" class="highlight-div-header"><div _ngcontent-npc-c106="" class="highlight-div-header-left"><div _ngcontent-npc-c106="" class="handle-button expand-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-npc-c106="" class="highlight-div-header-right"><div _ngcontent-npc-c106="" class="handle-button ai-button"></div><div _ngcontent-npc-c106="" class="handle-button line-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-npc-c106="" class="handle-button theme-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-npc-c106="" class="handle-button copy-button"><div _ngcontent-npc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-npc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>externalLog=/data/storage/el2/log/hiappevent/APP_CRASH_1751081104816_35595.log</li><li>HiAppEvent file exists</li><li>HiAppEvent file=/data/storage/el2/log/hiappevent/APP_CRASH_1751081104816_35595.log fd=61</li><li>HiAppEvent remove file:/data/storage/el2/log/hiappevent/APP_CRASH_1751081104816_35595.log succeed</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>external_log返回的路径是应用沙箱目录，非真实物理路径。应用有权限访问自己的沙箱目录。external_log日志空间受限，应用处理完日志文件后应及时删除。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="同一应用内事件的回调不区分线程进程">同一应用内，事件的回调不区分线程、进程<i class="anchor-icon anchor-icon-link" anchorid="同一应用内事件的回调不区分线程进程" tips="复制节点链接"></i></h2>          <p>例如，在同一个应用内，有A、B两个进程，进程A已调用addWatcher()接口订阅崩溃事件。如果进程B发生崩溃，进程A能收到进程B的崩溃回调。只要进程A和B的应用名一致即可。</p>     <p><strong>接口参考链接</strong></p>     <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventaddwatcher" target="_blank">hiAppEvent.addWatcher</a>。</p>    </div>   </div>   <div></div></div>