<h1 _ngcontent-xwm-c119="" class="doc-title ng-star-inserted" title="HiDebug接口使用示例(C/C++)"> HiDebug接口使用示例(C/C++) </h1>

<div _ngcontent-xwm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HiDebug C/C++接口功能独立，需要获取调试信息时直接调用。具体调用示例请参考下文。</p>  <div class="tiledSection"><h2 id="通用开发示例">通用开发示例<i class="anchor-icon anchor-icon-link" anchorid="通用开发示例" tips="复制节点链接"></i></h2><p>下文将展示如何在应用内调用HiDebug Ndk接口：</p> <p>步骤一：创建项目</p> <ol><li><p>使用DevEco Studio新建工程，选择“Native C++”选项。</p>  </li><li><p>编辑“CMakeLists.txt”文件，添加库依赖：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 新增动态库依赖libohhidebug<span class="hljs-selector-class">.so</span>和libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>（日志输出）</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libohhidebug.so)</li></ol></pre></div></div>  </li><li><p>编辑“napi_init.cpp”文件，导入依赖的文件，并定义LOG_TAG及测试方法：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hidebug/hidebug.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"testTag"</span></span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TestHiDebugNdk</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// todo 调用需测试的Ndk接口</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>  <p>将测试方法注册为ArkTS接口：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>      {<span class="hljs-string">"testHiDebugNdk"</span>, <span class="hljs-literal">nullptr</span>, TestHiDebugNdk, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div>  </li><li><p>编辑“index.d.ts”文件，定义ArkTS接口：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testHiDebugNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>  </li><li><p>编辑“Index.ets”文件，为Text组件添加点击事件。示例代码如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testHiDebugNdk"</span>)</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>          })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          <span class="hljs-comment">// 添加点击事件</span></li><li>          .<span class="hljs-title function_">onClick</span>(testNapi.<span class="hljs-property">testHiDebugNdk</span>);</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> <p>步骤二：运行工程</p> <p>点击DevEco Studio界面中的运行按钮，运行应用工程，然后点击“testHiDebugNdk”触发NDK接口调用。</p> </div>  <div class="tiledSection"><h3 id="获取线程cpu使用率" class="firsth2">获取线程CPU使用率<i class="anchor-icon anchor-icon-link" anchorid="获取线程cpu使用率" tips="复制节点链接"></i></h3><p>OH_HiDebug_GetAppThreadCpuUsage接口返回的数据为链表结构。使用完毕后，需通过OH_HiDebug_FreeThreadCpuUsage接口回收内存。详情请参考如下示例。</p> <ol><li><p>参考<a href="/consumer/cn/doc/harmonyos-guides/hidebug-guidelines-ndk#通用开发示例">通用开发示例</a>，并定义“TestHiDebugNdk”方法，在该方法中调用接口：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">TestHiDebugNdk</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>)</li><li> {</li><li>     <span class="hljs-variable">HiDebug_ThreadCpuUsagePtr</span> <span class="hljs-variable">cpuUsage</span> = <span class="hljs-title function_">OH_HiDebug_GetAppThreadCpuUsage</span>();</li><li>     <span class="hljs-keyword">if</span> (<span class="hljs-variable">cpuUsage</span> != <span class="hljs-variable">nullptr</span>) {</li><li>         <span class="hljs-keyword">do</span> {</li><li>             <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>,</li><li>                         <span class="hljs-string">"GetAppThreadCpuUsage: threadId %{public}d, cpuUsage: %{public}f"</span>, <span class="hljs-variable">cpuUsage</span>-&gt;<span class="hljs-title class_">threadId</span>, <span class="hljs-variable">cpuUsage</span>-&gt;<span class="hljs-title class_">cpuUsage</span>);</li><li>             <span class="hljs-variable">cpuUsage</span> = <span class="hljs-variable">cpuUsage</span>-&gt;<span class="hljs-title class_">next</span>; <span class="hljs-comment">// 获取下一个线程的cpu使用率对象指针。</span></li><li>         } <span class="hljs-keyword">while</span>(<span class="hljs-variable">cpuUsage</span> != <span class="hljs-variable">nullptr</span>);</li><li>         <span class="hljs-title function_">OH_HiDebug_FreeThreadCpuUsage</span>(&amp;<span class="hljs-title class_">cpuUsage</span>); <span class="hljs-comment">// 释放内存，防止内存泄露。</span></li><li>     }</li><li>     <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li> }</li></ol></pre></div></div>  </li><li><p>触发接口调用并查看控制台输出，日志输出示例如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="Text prettyprint linenums hljs language-Text" hw-language="Text" data-highlighted="yes"><ol class="linenums"><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15025, cpuUsage: 0.000762</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15143, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15144, cpuUsage: 0.000055</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15152, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15154, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15155, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15156, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15157, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15158, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15159, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15160, cpuUsage: 0.000033</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15161, cpuUsage: 0.000077</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15162, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15163, cpuUsage: 0.000033</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15171, cpuUsage: 0.000000</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15175, cpuUsage: 0.000011</li><li> 06-04 15:18:27.585   15025-15025   A00000/com.exa...ation/testTag  com.examp...lication  I     GetAppThreadCpuUsage: threadId 15176, cpuUsage: 0.000033</li></ol></pre></div></div>  </li></ol> </div>  <div class="tiledSection"><h3 id="获取堆栈信息">获取堆栈信息<i class="anchor-icon anchor-icon-link" anchorid="获取堆栈信息" tips="复制节点链接"></i></h3><p>下文展示如何在应用内使用HiDebug进行主线程栈回溯。</p> <p>步骤一：创建项目</p> <ol><li><p>使用DevEco Studio新建一个Native C++工程，并新增文件“test_backtrace.cpp”与“test_backtrace.h”，目录结构如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="yml prettyprint linenums hljs language-yaml" hw-language="yml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">entry:</span></li><li>  <span class="hljs-attr">src:</span></li><li>    <span class="hljs-attr">main:</span></li><li>      <span class="hljs-attr">cpp:</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">types:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-attr">libentry:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">index.d.ts</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">CMakeLists.txt</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">napi_init.cpp</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">test_backtrace.cpp</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">test_backtrace.h</span></li><li>      <span class="hljs-attr">ets:</span></li><li>        <span class="hljs-attr">pages:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-string">Index.ets</span></li></ol></pre></div></div>  </li><li><p>编辑“test_backtrace.h”文件，内容如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_TESTBACKTRACE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_TESTBACKTRACE_H</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitSignalHandle</span><span class="hljs-params">()</span></span>;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BacktraceFrames</span><span class="hljs-params">()</span></span>;</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_TESTBACKTRACE_H</span></span></li></ol></pre></div></div>  </li><li><p>编辑“test_backtrace.cpp”文件, 内容如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"test_backtrace.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csignal&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hidebug/hidebug.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FRAME_SIZE 256 <span class="hljs-comment">// 最大栈回溯深度，应根据业务场景调整该值。</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> {</li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>    std::condition_variable cv_; <span class="hljs-comment">// 用于控制线程与主线程的逻辑顺序。</span></li><li>    std::mutex mutex_; <span class="hljs-comment">// 用于控制线程与主线程的逻辑顺序。</span></li><li>    <span class="hljs-type">int</span> pcSize = <span class="hljs-number">-1</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackTraceObject</span> { <span class="hljs-comment">// 封装了抓栈过程中需要使用的资源，在使用过程中请注意线程安全和异步信号安全。</span></li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> BackTraceObject&amp; <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-built_in">BackTraceObject</span>(<span class="hljs-type">const</span> BackTraceObject&amp;) = <span class="hljs-keyword">delete</span>;</li><li>    BackTraceObject&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> BackTraceObject&amp;) = <span class="hljs-keyword">delete</span>;</li><li>    <span class="hljs-built_in">BackTraceObject</span>(BackTraceObject&amp;&amp;) = <span class="hljs-keyword">delete</span>;</li><li>    BackTraceObject&amp; <span class="hljs-keyword">operator</span>=(BackTraceObject&amp;&amp;) = <span class="hljs-keyword">delete</span>;</li><li>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Init</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> size)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Release</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">BackTraceFromFp</span><span class="hljs-params">(<span class="hljs-type">void</span>* startFp, <span class="hljs-type">int</span> size)</span></span>; <span class="hljs-comment">// 该函数异步信号安全。</span></li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SymbolicAddress</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span></span>; <span class="hljs-comment">// 该函数耗费性能，请避免频繁调用。</span></li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PrintStackFrame</span><span class="hljs-params">(<span class="hljs-type">void</span>* pc, <span class="hljs-type">const</span> HiDebug_StackFrame&amp; frame)</span></span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-built_in">BackTraceObject</span>() = <span class="hljs-keyword">default</span>;</li><li>    ~<span class="hljs-built_in">BackTraceObject</span>() = <span class="hljs-keyword">default</span>;</li><li>    HiDebug_Backtrace_Object backtraceObject_ = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">void</span>** pcs_ = <span class="hljs-literal">nullptr</span>;</li><li>};</li><li>
</li><li><span class="hljs-function">BackTraceObject&amp; <span class="hljs-title">BackTraceObject::GetInstance</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">// 单例模式，用于信号处理和请求抓栈线程的数据交互。注意该类非异步信号安全，业务逻辑应确保同一时刻仅单个线程访问。</span></li><li>    <span class="hljs-type">static</span> BackTraceObject instance;</li><li>    <span class="hljs-keyword">return</span> instance;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BackTraceObject::Init</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> size)</span> </span>{ <span class="hljs-comment">// 初始化资源。</span></li><li>    backtraceObject_ = <span class="hljs-built_in">OH_HiDebug_CreateBacktraceObject</span>();</li><li>    <span class="hljs-keyword">if</span> (backtraceObject_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    pcs_  = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">void</span>*[size]{<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-keyword">if</span> (pcs_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BackTraceObject::Release</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">// 释放资源。</span></li><li>    <span class="hljs-built_in">OH_HiDebug_DestroyBacktraceObject</span>(backtraceObject_);</li><li>    backtraceObject_ = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">delete</span>[] pcs_;</li><li>    pcs_ = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">BackTraceObject::BackTraceFromFp</span><span class="hljs-params">(<span class="hljs-type">void</span>* startFp, <span class="hljs-type">int</span> size)</span> </span>{ <span class="hljs-comment">// 栈回溯获取pc地址。</span></li><li>    <span class="hljs-keyword">if</span> (size &lt;= MAX_FRAME_SIZE) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">OH_HiDebug_BacktraceFromFp</span>(backtraceObject_, startFp, pcs_, size); <span class="hljs-comment">// OH_HiDebug_BacktraceFromFp接口调用示例。</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BackTraceObject::PrintStackFrame</span><span class="hljs-params">(<span class="hljs-type">void</span>* pc, <span class="hljs-type">const</span> HiDebug_StackFrame&amp; frame)</span> </span>{ <span class="hljs-comment">// 输出栈内容。</span></li><li>    <span class="hljs-keyword">if</span> (frame.type == HIDEBUG_STACK_FRAME_TYPE_JS) { <span class="hljs-comment">// 根据栈帧的类型，区分不同的栈帧输出方式。</span></li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"TestTag"</span>,</li><li>            <span class="hljs-string">"js stack frame info for pc: %{public}p is "</span></li><li>            <span class="hljs-string">"relativePc: %{public}p "</span></li><li>            <span class="hljs-string">"line: %{public}d "</span></li><li>            <span class="hljs-string">"column: %{public}d "</span></li><li>            <span class="hljs-string">"mapName: %{public}s "</span></li><li>            <span class="hljs-string">"functionName: %{public}s "</span></li><li>            <span class="hljs-string">"url: %{public}s "</span></li><li>            <span class="hljs-string">"packageName: %{public}s."</span>,</li><li>            pc,</li><li>            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(frame.frame.js.relativePc),</li><li>            frame.frame.js.line,</li><li>            frame.frame.js.column,</li><li>            frame.frame.js.mapName,</li><li>            frame.frame.js.functionName,</li><li>            frame.frame.js.url,</li><li>            frame.frame.js.packageName</li><li>        );</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"TestTag"</span>,</li><li>            <span class="hljs-string">"native stack frame info for pc: %{public}p is "</span></li><li>            <span class="hljs-string">"relativePc: %{public}p "</span></li><li>            <span class="hljs-string">"funcOffset: %{public}p "</span></li><li>            <span class="hljs-string">"mapName: %{public}s "</span></li><li>            <span class="hljs-string">"functionName: %{public}s "</span></li><li>            <span class="hljs-string">"buildId: %{public}s "</span></li><li>            <span class="hljs-string">"reserved: %{public}s."</span>,</li><li>            pc,</li><li>            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(frame.frame.native.relativePc),</li><li>            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(frame.frame.native.funcOffset),</li><li>            frame.frame.native.mapName,</li><li>            frame.frame.native.functionName,</li><li>            frame.frame.native.buildId,</li><li>            frame.frame.native.reserved</li><li>        );</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BackTraceObject::SymbolicAddress</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> </span>{ <span class="hljs-comment">// 栈解析接口。</span></li><li>    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= MAX_FRAME_SIZE) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_HiDebug_SymbolicAddress</span>(backtraceObject_, pcs_[index], <span class="hljs-keyword">this</span>, [](<span class="hljs-type">void</span>* pc, <span class="hljs-type">void</span>* arg, <span class="hljs-type">const</span> HiDebug_StackFrame* frame) {</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;BackTraceObject*&gt;(arg)-&gt;<span class="hljs-built_in">PrintStackFrame</span>(pc, *frame);</li><li>    }); <span class="hljs-comment">// 调用OH_HiDebug_SymbolicAddress接口解析栈。</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SignalHandler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig, <span class="hljs-type">siginfo_t</span> *si, <span class="hljs-type">void</span>* context)</span> </span>{ <span class="hljs-comment">// 信号处理函数。</span></li><li>    <span class="hljs-keyword">if</span> (sig != SIGUSR1) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> startFp = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">ucontext_t</span> *&gt;(context)-&gt;uc_mcontext.regs[<span class="hljs-number">29</span>]; <span class="hljs-comment">// 读取寄存器X29中存放的fp地址。</span></li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    pcSize = BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">BackTraceFromFp</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(startFp), MAX_FRAME_SIZE); <span class="hljs-comment">// 该函数异步信号安全，仅异步信号安全函数可在信号处理函数内使用。</span></li><li>    cv_.<span class="hljs-built_in">notify_all</span>(); <span class="hljs-comment">// 栈回溯结束，通知给请求回栈的线程。</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitSignalHandle</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">// 注册信号处理函数。</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sigaction</span> action{<span class="hljs-number">0</span>};</li><li>    <span class="hljs-built_in">sigfillset</span>(&amp;action.sa_mask);</li><li>    action.sa_sigaction = SignalHandler;</li><li>    action.sa_flags = SA_RESTART | SA_SIGINFO | SA_ONSTACK;</li><li>    <span class="hljs-built_in">sigaction</span>(SIGUSR1, &amp;action, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// 注意: 所使用的信号应避免与原有信号冲突。</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BacktraceFrames</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">// 该接口非线程安全，同一时刻只能由一个线程使用。</span></li><li>    <span class="hljs-keyword">if</span> (!BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">Init</span>(MAX_FRAME_SIZE)) { <span class="hljs-comment">// 注意：在调用栈回溯函数之前，需申请资源，且不可重复初始化。</span></li><li>        BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">Release</span>();</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_WARN, LOG_PRINT_DOMAIN, <span class="hljs-string">"TestTag"</span>, <span class="hljs-string">"failed init backtrace object."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    pcSize = <span class="hljs-number">-1</span>; <span class="hljs-comment">// 初始化pcSize为-1。</span></li><li>    <span class="hljs-type">siginfo_t</span> si{<span class="hljs-number">0</span>};</li><li>    si.si_signo = SIGUSR1;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">syscall</span>(SYS_rt_tgsigqueueinfo, <span class="hljs-built_in">getpid</span>(), <span class="hljs-built_in">getpid</span>(), si.si_signo, &amp;si) != <span class="hljs-number">0</span>) { <span class="hljs-comment">// 发送信号给主线程以触发信号处理函数。</span></li><li>        BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">Release</span>();</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"TestTag"</span>, <span class="hljs-string">"failed send sig"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    {</li><li>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>        cv_.<span class="hljs-built_in">wait</span>(lock, []{<span class="hljs-keyword">return</span> pcSize &gt;= <span class="hljs-number">0</span>;}); <span class="hljs-comment">// 等待主线程在信号处理函数内进行栈回溯。</span></li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pcSize; i++) {</li><li>        BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">SymbolicAddress</span>(i); <span class="hljs-comment">// 主线程获取pc后，对pc值进行栈解析。</span></li><li>    }</li><li>    BackTraceObject::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">Release</span>(); <span class="hljs-comment">// 栈回溯并且解析结束后，及时释放资源。</span></li><li>}</li></ol></pre></div></div>  </li><li><p>编辑“CMakeLists.txt”文件，添加库依赖：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 新增动态库依赖libohhidebug<span class="hljs-selector-class">.so</span>和libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>（日志输出）</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp test_backtrace.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libohhidebug.so)</li></ol></pre></div></div>  </li><li><p>编辑“napi_init.cpp”文件，导入依赖文件并定义测试方法。</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"test_backtrace.h"</span></span></li><li>
</li><li>__attribute((noinline)) __attribute((optnone)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestNativeFrames</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">TestNativeFrames</span>(i - <span class="hljs-number">1</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">//模拟主线程阻塞。</span></li><li>}</li><li>__attribute((noinline)) __attribute((optnone)) <span class="hljs-function">napi_value <span class="hljs-title">TestHiDebugNdk</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::<span class="hljs-built_in">thread</span>([]{</li><li>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));</li><li>        <span class="hljs-built_in">BacktraceFrames</span>();</li><li>    }).<span class="hljs-built_in">detach</span>(); <span class="hljs-comment">// 启用第二个线程，对主线程进行抓栈。</span></li><li>    <span class="hljs-built_in">TestNativeFrames</span>(<span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>  <p>注册“TestHiDebugNdk”为ArkTS接口并初始化主线程的信号处理函数:</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"testHiDebugNdk"</span>, <span class="hljs-literal">nullptr</span>, TestHiDebugNdk, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-built_in">InitSignalHandle</span>(); <span class="hljs-comment">// 初始化信号处理函数。</span></li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div>  </li><li><p>编辑“index.d.ts”文件，声明ArkTS接口：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testHiDebugNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>  </li><li><p>编辑“Index.ets”文件，添加触发接口调用的按钮，示例代码如下：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testJsFrame</span>(<span class="hljs-params">i : <span class="hljs-built_in">number</span></span>) : <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">testJsFrame</span>(i-<span class="hljs-number">1</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> testNapi.<span class="hljs-title function_">testHiDebugNdk</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">testJsFrame</span>(<span class="hljs-number">3</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> <p>步骤二：运行工程</p> <ol><li><p>点击DevEco Studio界面中的运行按钮，然后单击应用界面上的“Hello World”文本。</p>  </li><li><p>在DevEco Studio底部切换到“Log”窗口，设置日志过滤条件为“TestTag”，即可查看相关日志：</p>  <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="Text prettyprint linenums hljs language-Text" hw-language="Text" data-highlighted="yes"><ol class="linenums"><li>...</li><li>05-10 17:26:24.229 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I native stack frame info for pc: 0x5b3e193d24 is relativePc: 0xd3d24 funcOffset: 0x60 mapName: /data/storage/el1/bundle/libs/arm64/libc++_shared.so functionName: std::__n1::this_thread::sleep_for(std::__n1::chrono::duration&lt;long long, std::__n1::ratio&lt;1l, 1000000000l&gt;&gt; const&amp;) buildId: 459a4d9b28503b85a67ca37bda676b03da86e7d6 reserved: (null).</li><li>05-10 17:26:24.229 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I native stack frame info for pc: 0x5b3e208524 is relativePc: 0x8524 funcOffset: 0xbc mapName: /data/storage/el1/bundle/libs/arm64/libentry.so functionName: void std::__n1::this_thread::sleep_for&lt;long long, std::__n1::ratio&lt;1l, 1l&gt;&gt;(std::n1::chrono::duration&lt;long long, std::n1::ratio&lt;1l, 1l&gt;&gt; const&amp;) buildId: 18a155ee0e687664c5f2c552762efb5ff9ee3724 reserved: (null).</li><li>05-10 17:26:24.229 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I native stack frame info for pc: 0x5b3e208434 is relativePc: 0x8434 funcOffset: 0x68 mapName: /data/storage/el1/bundle/libs/arm64/libentry.so functionName: TestNativeFrames(int) buildId: 18a155ee0e687664c5f2c552762efb5ff9ee3724 reserved: (null).</li><li>05-10 17:26:24.229 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I native stack frame info for pc: 0x5b3e20840c is relativePc: 0x840c funcOffset: 0x40 mapName: /data/storage/el1/bundle/libs/arm64/libentry.so functionName: TestNativeFrames(int) buildId: 18a155ee0e687664c5f2c552762efb5ff9ee3724 reserved: (null).</li><li>05-10 17:26:24.229 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I native stack frame info for pc: 0x5b3e208654 is relativePc: 0x8654 funcOffset: 0xd4 mapName: /data/storage/el1/bundle/libs/arm64/libentry.so functionName: TestHiDebugNdk(napi_env*, napi_callback_info*) buildId: 18a155ee0e687664c5f2c552762efb5ff9ee3724 reserved: (null).</li><li>...</li><li>05-10 17:26:24.234 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I js stack frame info for pc: 0x5a3d773f92 is relativePc: 0x2f92 line: 17 column: 16 mapName: /data/storage/el1/bundle/entry.hap functionName: testJsFrame url: entry|entry|1.0.0|src/main/ets/pages/Index.ts packageName: .</li><li>05-10 17:26:24.235 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I js stack frame info for pc: 0x5a3d773f6c is relativePc: 0x2f6c line: 13 column: 16 mapName: /data/storage/el1/bundle/entry.hap functionName: testJsFrame url: entry|entry|1.0.0|src/main/ets/pages/Index.ts packageName: .</li><li>05-10 17:26:24.235 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I js stack frame info for pc: 0x5a3d773f6c is relativePc: 0x2f6c line: 13 column: 16 mapName: /data/storage/el1/bundle/entry.hap functionName: testJsFrame url: entry|entry|1.0.0|src/main/ets/pages/Index.ts packageName: .</li><li>05-10 17:26:24.235 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I js stack frame info for pc: 0x5a3d773f6c is relativePc: 0x2f6c line: 13 column: 16 mapName: /data/storage/el1/bundle/entry.hap functionName: testJsFrame url: entry|entry|1.0.0|src/main/ets/pages/Index.ts packageName: .</li><li>05-10 17:26:24.235 8324-8865 A0FF00/com.exa...ation/TestTag com.examp...lication I js stack frame info for pc: 0x5a3d7743f0 is relativePc: 0x33f0 line: 69 column: 17 mapName: /data/storage/el1/bundle/entry.hap functionName: anonymous url: entry|entry|1.0.0|src/main/ets/pages/Index.ts packageName: .</li><li>...</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>