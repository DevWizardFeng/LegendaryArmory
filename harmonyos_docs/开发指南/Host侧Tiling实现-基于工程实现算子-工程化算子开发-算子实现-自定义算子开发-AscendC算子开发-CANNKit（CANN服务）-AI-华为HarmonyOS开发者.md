<h1 _ngcontent-bpa-c119="" class="doc-title ng-star-inserted" title="Host侧Tiling实现"> Host侧Tiling实现 </h1>

<div _ngcontent-bpa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-implementation-overview">算子实现</a>章节已经介绍了host侧tiling核心的实现方法，本章节侧重于介绍接入DDK框架时编程模式和API的使用。</p> <p>大多数情况下，Local Memory的存储，无法完整的容纳算子的输入与输出，需要每次搬运一部分输入进行计算然后搬出，再搬运下一部分输入进行计算，直到得到完整的最终结果，这个数据切分、分块计算的过程称之为<strong>Tiling</strong>。根据算子的shape等信息来确定数据切分算法相关参数（比如每次搬运的块大小，以及总共循环多少次）的计算程序，称之为<strong>Tiling实现</strong>。</p> <p>Tiling实现完成后，获取到的Tiling切分算法相关参数，会传递给kernel侧，用于指导并行数据的切分。由于Tiling实现中完成的均为标量计算，AI Core并不擅长，所以我们将其独立出来放在host CPU上执行。</p> <div class="fignone"><span class="figcap"><b>图1 </b>Tiling实现的输入输出</span><br><span><img height="295.26" originheight="291" originwidth="215" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114314.79178013388807922385883071880788:50001231000000:2800:5394EE3220275F12F260143EE09B78C9A01C9A6B71810542333ED8EF19B6AFA3.png" width="219.45000000000002" class="notEnlarge"></span></div> <p>如上图所示，Tiling实现即为根据算子shape等信息来确定切分算法相关参数的过程，这里的算子shape等信息可以理解为是<strong>Tiling实现的输入</strong>，切分算法相关参数可以理解为是<strong>Tiling实现的输出</strong>。输入和输出都通过Tiling函数的参数（TilingContext* context上下文结构）来承载。也就是说，开发者可以从上下文结构中获取算子的输入、输出以及属性信息，也就是<strong>Tiling实现的输入</strong>，经过Tiling计算后，获取到TilingData数据结构（切分算法相关参数）、BlockDim变量、用于选择不同的kernel实现分支的TilingKey、算子workspace的大小，也就是<strong>Tiling实现的输出</strong>，并将这些输出设置到上下文结构中。</p> <div class="tiledSection"><h2 id="section1880311338550">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section1880311338550" tips="复制节点链接"></i></h2><p>TilingData、BlockDim、TilingKey、workspace这些概念的具体解释如下。</p> </div> <div class="tiledSection"><h3 id="section72131572313" class="firsth2">TilingData<i class="anchor-icon anchor-icon-link" anchorid="section72131572313" tips="复制节点链接"></i></h3><p>切分算法相关参数，比如每次搬运的块大小，以及总共循环多少次，通过结构体存储，由开发者自行设计。</p> <p>TilingData结构定义支持单结构定义方法，也支持结构体嵌套：</p> <ul><li>单结构定义方法，以平铺的形式定义：<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling { </li><li> <span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(MyAddTilingData)  <span class="hljs-comment">// 声明tiling结构名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field1);   <span class="hljs-comment">// 结构成员的类型和名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field2); </li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field3); </li><li> END_TILING_DATA_DEF; </li><li>   </li><li> <span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MyAdd, MyAddTilingData)  <span class="hljs-comment">// tiling结构注册给算子</span></li><li> }</li></ol></pre></div></div> </li><li>支持结构体嵌套：<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling { </li><li> <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(MyStruct1)  <span class="hljs-comment">// 声明结构1名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field1);   <span class="hljs-comment">// 结构成员的类型和名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field2);   <span class="hljs-comment">// 结构成员的类型和名字</span></li><li> END_TILING_DATA_DEF;  </li><li> <span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MyStruct1Op, MyStruct1) <span class="hljs-comment">// 注册结构体到&lt;op_type&gt;Op </span></li><li>  </li><li> <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(MyStruct2)  <span class="hljs-comment">// 声明结构2名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field3);   <span class="hljs-comment">// 结构成员的类型和名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field4);   <span class="hljs-comment">// 结构成员的类型和名字</span></li><li> END_TILING_DATA_DEF; </li><li> <span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MyStruct2Op, MyStruct2) <span class="hljs-comment">// 注册结构体到&lt;op_type&gt;Op </span></li><li>  </li><li> <span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(MyAddTilingData)  <span class="hljs-comment">// 声明tiling结构名字</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(MyStruct1, st1);   <span class="hljs-comment">// 结构成员的引用结构体</span></li><li>   <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(MyStruct2, st2);   <span class="hljs-comment">// 结构成员的引用结构体</span></li><li> END_TILING_DATA_DEF; </li><li> <span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MyAdd, MyAddTilingData)  <span class="hljs-comment">// tiling结构注册给算子</span></li><li> }</li></ol></pre></div></div> <p>Tiling实现函数中对tiling结构成员赋值的方式如下。</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>MyAddTilingData myTiling; </li><li>myTiling.st1.<span class="hljs-built_in">set_field1</span>(<span class="hljs-number">1</span>); </li><li>myTiling.st1.<span class="hljs-built_in">set_field2</span>(<span class="hljs-number">2</span>); </li><li>myTiling.st2.<span class="hljs-built_in">set_field3</span>(<span class="hljs-number">3</span>); </li><li>myTiling.st2.<span class="hljs-built_in">set_field4</span>(<span class="hljs-number">4</span>);</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section113316148251">BlockDim<i class="anchor-icon anchor-icon-link" anchorid="section113316148251" tips="复制节点链接"></i></h3><p>规定了核函数将会在几个核上执行。例如，需要计算8M的数据，每个核上计算1M的数据，BlockDim设置为8，但是为了充分利用硬件资源，一般将BlockDim设置为硬件平台的核数，根据核数进行数据切分。</p> <p>BlockDim是逻辑核的概念，取值范围为[1, 65535]。为了充分利用硬件资源，一般设置为物理核的核数或其倍数。对于耦合架构和分离架构，BlockDim在运行时的意义和设置规则有一些区别，具体说明如下。</p> <ul><li>耦合架构：由于其Vector、Cube单元是集成在一起的，BlockDim用于设置启动多个AICore核实例执行，不区分Vector、Cube。AI Core的核数可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaic">GetCoreNumAic</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaiv">GetCoreNumAiv</a>获取。</li></ul> <ul><li>分离架构：<ul><li>针对仅包含Vector计算的算子，BlockDim用于设置启动多少个Vector(AIV)实例执行，比如某款AI处理器上有40个Vector核，建议设置为40。</li></ul> <ul><li>针对仅包含Cube计算的算子，BlockDim用于设置启动多少个Cube(AIC)实例执行，比如某款AI处理器上有20个Cube核，建议设置为20。</li></ul> <ul><li>针对Vector/Cube融合计算的算子，启动时，按照AIV和AIC组合启动，BlockDim用于设置启动多少个组合执行，比如某款AI处理器上有40个Vector核和20个Cube核，一个组合是2个Vector核和1个Cube核，建议设置为20，此时会启动20个组合，即40个Vector核和20个Cube核。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>该场景下，设置的BlockDim逻辑核的核数不能超过物理核（2个Vector核和1个Cube核组合为1个物理核）的核数。</p> </div></div></div> </li></ul> <ul><li>AIC/AIV的核数分别通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaic">GetCoreNumAic</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaiv">GetCoreNumAiv</a>接口获取。</li></ul> <ul><li>Kirin9020/KirinX90仅支持BlockDim设为1。</li></ul> </li></ul> </div> <div class="tiledSection"><h3 id="section125815192611">TilingKey（可选）<i class="anchor-icon anchor-icon-link" anchorid="section125815192611" tips="复制节点链接"></i></h3><p>TilingKey是一个算子内为了区分不同的实现而将kernel代码进行区分的方法，该方法类似于C++的Template模板机制，可减少不必要的icache miss以及scalar耗时，有助于优化单次调用kernel的性能。不同的kernel实现分支可以通过TilingKey来标识，host侧设置TilingKey后，可以选择对应的分支。例如，一个算子在不同的shape下，有不同的算法逻辑，kernel侧可以通过TilingKey来选择不同的算法逻辑，在host侧Tiling算法也有差异，host/kernel侧通过相同的TilingKey进行关联。</p> <p>假如有如下kernel代码：</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (condition) { </li><li>   <span class="hljs-built_in">ProcessA</span>(); </li><li> } <span class="hljs-keyword">else</span> { </li><li>   <span class="hljs-built_in">ProcessB</span>(); </li><li> }</li></ol></pre></div></div> <p>如果函数ProcessA、ProcessB两个函数是个非常大的函数，那么上述代码在编译后会变得更大，而每次kernel运行只会选择1个分支，条件的判断和跳转在代码大到一定程度（16-32K，不同芯片存在差异）后会出现icache miss。通过TilingKey可以对这种情况进行优化，给2个kernel的处理函数设置不同的TilingKey 1和2：</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">1</span>)) { </li><li>   <span class="hljs-built_in">ProcessA</span>(); </li><li> } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">2</span>)) { </li><li>   <span class="hljs-built_in">ProcessB</span>(); </li><li> }</li></ol></pre></div></div> <p>这样device kernel编译时会自动识别到2个TilingKey并编译2个kernel入口函数，将条件判断进行常量折叠。同时需要和host tiling函数配合，判断走ProcessA的场景设置TilingKey为1，走ProcessB的场景设置TilingKey为2：</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> ge::graphStatus <span class="hljs-title">TilingFunc</span><span class="hljs-params">(gert::TilingContext* context)</span> </span></li><li><span class="hljs-function"> </span>{ </li><li>     <span class="hljs-comment">// To do sth </span></li><li>     <span class="hljs-keyword">if</span> (condition) { </li><li>         context-&gt;<span class="hljs-built_in">SetTilingKey</span>(<span class="hljs-number">1</span>); </li><li>     } <span class="hljs-keyword">else</span> { </li><li>         context-&gt;<span class="hljs-built_in">SetTilingKey</span>(<span class="hljs-number">2</span>); </li><li>     } </li><li>     <span class="hljs-keyword">return</span> ge::GRAPH_SUCCESS; </li><li> }</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>编译时，可以通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-project-compilation#zh-cn_topic_0000002119124453_li1753112716212">--tiling_keys</a>编译选项指定TilingKey，编译时只编译指定TilingKey相关的kernel代码，用于加速编译过程。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section7243192516275">WorkspaceSize（可选）<i class="anchor-icon anchor-icon-link" anchorid="section7243192516275" tips="复制节点链接"></i></h3><p>workspace是设备侧Global Memory上的一块内存。在Tiling函数中可以设置workspace的大小，框架侧会为其在申请对应大小的设备侧Global Memory，在对应的算子kernel侧实现时可以使用这块workspace内存。</p> <p>workspace内存分为两部分：AscendC API需要的workspace内存和算子实现使用到的workspace内存（按需）。</p> <ul><li>AscendC API需要预留workspace内存<p>API在计算过程需要一些workspace内存作为缓存，因此算子Tiling函数需要为API预留workspace内存，预留内存大小通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getlibapiworkspacesize">GetLibApiWorkSpaceSize</a>接口获取。</p> </li><li>算子实现使用到的workspace内存（按需）<p>算子内部需要通过额外的device内存进行数据交换或者缓存的时候才需要分配，根据算子计算的空间自行分配。</p> </li></ul> <p>整体的workspace内存就是上述两部分之和，在Tiling函数中设置方法如下。</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> workspaceSizes = context-&gt;<span class="hljs-built_in">GetWorkspaceSizes</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 只使用1块workspace </span></li><li>workspaceSizes[<span class="hljs-number">0</span>] = sysWorkspaceSize + usrWorkspaceSize;</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section4568mcpsimp">Tiling实现基本流程<i class="anchor-icon anchor-icon-link" anchorid="section4568mcpsimp" tips="复制节点链接"></i></h2><p>Tiling实现开发的流程图如下。</p> <div class="fignone"><span class="figcap"><b>图2 </b>Tiling开发流程图</span><br><span><img height="602.49" originheight="594" originwidth="481" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114314.34819957541889434019744063883312:50001231000000:2800:D515F5249C7500ACE6A8078EF5ABB26A118E8B1E1CABAC60B7AD30D0DB44FC62.png" title="点击放大" width="486.78000000000003"></span></div> <p>下面将从一个简单的Add算子为例介绍Tiling的实现流程。本样例中待处理数据的Shape大小可以平均分配到每个核上，并且可以对齐到一个datablock(32B)的大小。</p> <p><strong>首先</strong>完成算子TilingData结构定义头文件的编写，该文件命名为<em>“算子名称_tiling.h”</em>，位于算子工程的op_host目录下。样例代码如下。</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span> </span></li><li> </li><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(TilingData)               <span class="hljs-comment">// 注册一个tiling的类，以tiling的名字作为入参 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, totalLength); <span class="hljs-comment">// 添加tiling字段，总计算数据量 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, tileNum);     <span class="hljs-comment">// 添加tiling字段，每个核上总计算数据分块个数 </span></li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-comment">// 注册算子tilingdata类到对应的AddCustom算子 </span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(AddCustom, TilingData) </li><li>} </li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// ADD_CUSTOM_TILING_H</span></span></li></ol></pre></div></div> <p>具体的编写步骤如下。</p> <ol><li><span>代码框架编写，需要增加#ifndef...的判断条件，防止头文件的重复包含；需要包含register/tilingdata_base.h头文件，tilingdata_base.h中定义了多个用于tilingdata注册的宏。样例代码如下。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span> </span></li><li> </li><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-comment">// tiling结构定义和注册代码 </span></li><li><span class="hljs-comment">// ... </span></li><li>} </li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// ADD_CUSTOM_TILING_H</span></span></li></ol></pre></div></div> <p></p></li><li><span>TilingData参数设计，TilingData参数本质上是和并行数据切分相关的参数，本示例算子使用了2个tiling参数：totalLength、tileNum。totalLength是指需要计算的数据量大小，tileNum是指每个核上总计算数据分块个数。比如，totalLength这个参数传递到kernel侧后，可以通过除以参与计算的核数，得到每个核上的计算量，这样就完成了多核数据的切分。</span></li><li id="zh-cn_topic_0000002083404706_li5612175610125"><span>TilingData结构定义，通过BEGIN_TILING_DATA_DEF接口定义一个TilingData的类，通过TILING_DATA_FIELD_DEF接口增加TilingData的两个字段totalLength、tileNum，通过END_TILING_DATA_DEF接口结束TilingData定义。相关接口的详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tilingdata-structure-definition">TilingData结构定义</a>。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(TilingData)               <span class="hljs-comment">// 注册一个tiling的类，以tiling的名字作为入参 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, totalLength); <span class="hljs-comment">// 添加tiling字段，总计算数据量 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, tileNum);     <span class="hljs-comment">// 添加tiling字段，每个核上总计算数据分块个数 </span></li><li>END_TILING_DATA_DEF;</li></ol></pre></div></div> <p></p></li><li><span>注册TilingData结构，通过REGISTER_TILING_DATA_CLASS接口，注册TilingData类，和自定义算子相关联。REGISTER_TILING_DATA_CLASS第一个参数为op_type（算子类型），本样例中传入AddCustom，第二个参数为TilingData的类名。REGISTER_TILING_DATA_CLASS接口介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tilingdata-structure-registration">TilingData结构注册</a>。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册算子tilingdata类到对应的AddCustom算子 </span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(AddCustom, TilingData)</li></ol></pre></div></div> <p></p></li></ol> <p><strong>然后</strong>完成算子host实现cpp文件中Tiling函数实现，该文件命名为<em>“算子名称.cpp”</em>，位于算子工程的op_host目录下。样例代码如下。</p> <div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> BLOCK_DIM = <span class="hljs-number">1</span>; </li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> TILE_NUM = <span class="hljs-number">8</span>; </li><li><span class="hljs-function"><span class="hljs-type">static</span> ge::graphStatus <span class="hljs-title">TilingFunc</span><span class="hljs-params">(gert::TilingContext *context)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    TilingData tiling; </li><li>    <span class="hljs-type">uint32_t</span> totalLength = context-&gt;<span class="hljs-built_in">GetInputShape</span>(<span class="hljs-number">0</span>)-&gt;<span class="hljs-built_in">GetOriginShape</span>().<span class="hljs-built_in">GetShapeSize</span>(); </li><li>    context-&gt;<span class="hljs-built_in">SetBlockDim</span>(BLOCK_DIM); </li><li>    tiling.<span class="hljs-built_in">set_totalLength</span>(totalLength); </li><li>    tiling.<span class="hljs-built_in">set_tileNum</span>(TILE_NUM); </li><li>    tiling.<span class="hljs-built_in">SaveToBuffer</span>(context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetData</span>(), context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetCapacity</span>()); </li><li>    context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">SetDataSize</span>(tiling.<span class="hljs-built_in">GetDataSize</span>()); </li><li>    <span class="hljs-type">size_t</span> *currentWorkspace = context-&gt;<span class="hljs-built_in">GetWorkspaceSizes</span>(<span class="hljs-number">1</span>); </li><li>    currentWorkspace[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; </li><li>    <span class="hljs-keyword">return</span> ge::GRAPH_SUCCESS; </li><li>} </li><li>} <span class="hljs-comment">// namespace optiling</span></li></ol></pre></div></div> <p>具体步骤如下。</p> <ol><li><span>获取TilingContext的上下文，即Tiling函数的入参gert::TilingContext* context。</span></li><li><span>设置TilingData。上文<a href="/consumer/cn/doc/harmonyos-guides/cannkit-tiling-implementation-on-the-host#zh-cn_topic_0000002083404706_li5612175610125">步骤3</a>中，定义了TilingData的类，此时可以用TilingData定义一个具体的实例，通过调用TilingData类的set_+<em>field_name</em>接口来设置TilingData的字段值，通过调用TilingData类的SaveToBuffer接口完成TilingData的序列化和保存。</span><p></p><ol><li>通过上下文获取输入输出shape信息。本样例中通过TilingContext的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getinputshape">GetInputShape</a>接口获取输入的shape大小。<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取输入shape信息</span></li><li><span class="hljs-type">uint32_t</span> totalLength = context-&gt;<span class="hljs-built_in">GetInputShape</span>(<span class="hljs-number">0</span>)-&gt;<span class="hljs-built_in">GetOriginShape</span>().<span class="hljs-built_in">GetShapeSize</span>();</li></ol></pre></div></div> </li><li>设置TilingData。通过调用set_+<em>field_name</em>方法来设置TilingData的字段值。<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 用TilingData定义一个具体的实例</span></li><li>TilingData tiling; </li><li><span class="hljs-comment">// 设置TilingData </span></li><li>tiling.<span class="hljs-built_in">set_totalLength</span>(totalLength); </li><li>tiling.<span class="hljs-built_in">set_tileNum</span>(TILE_NUM);</li></ol></pre></div></div> </li><li>调用TilingData类的SaveToBuffer接口完成序列化并保存至TilingContext上下文。SaveToBuffer的第一个参数为存储Buffer的首地址，第二个参数为Buffer的长度。通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getrawtilingdata">GetRawTilingData</a>获取无类型的TilingData的地址，再通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tilingdata-getdata">GetData</a>获取数据指针，作为Buffer的首地址；通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getrawtilingdata">GetRawTilingData</a>获取无类型的TilingData的地址，再通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcapacity">GetCapacity</a>获取TilingData的长度，作为Buffer的长度。完成SaveToBuffer操作后需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-setdatasize">SetDataSize</a>设置TilingData的长度，该长度通过TilingData类的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getdatasize">GetDataSize</a>接口获取。<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 序列化并保存</span></li><li>tiling.<span class="hljs-built_in">SaveToBuffer</span>(context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetData</span>(), context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetCapacity</span>()); </li><li>context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">SetDataSize</span>(tiling.<span class="hljs-built_in">GetDataSize</span>());</li></ol></pre></div></div> </li></ol> <p></p></li><li><span>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-setblockdim">SetBlockDim</a>接口设置BlockDim。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>context-&gt;<span class="hljs-built_in">SetBlockDim</span>(BLOCK_DIM);</li></ol></pre></div></div> <p></p></li><li><span>（可选）通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-settilingkey">SetTilingKey</a>设置TilingKey。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>context-&gt;<span class="hljs-built_in">SetTilingKey</span>(<span class="hljs-number">1</span>);</li></ol></pre></div></div> <p></p></li><li><span>（可选）通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getworkspacesizes">GetWorkspaceSizes</a>获取workspace size指针，并设置size大小。此处仅作为举例，设置workspace的大小为0。</span><p></p><div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">size_t</span> *currentWorkspace = context-&gt;<span class="hljs-built_in">GetWorkspaceSizes</span>(<span class="hljs-number">1</span>); </li><li>currentWorkspace[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section10457718525">Tiling参数设计更多样例-属性信息通过TilingData传递<i class="anchor-icon anchor-icon-link" anchorid="section10457718525" tips="复制节点链接"></i></h2><p>如果算子包含属性信息，该属性信息可以通过TilingData传递到kernel侧，参与kernel侧算子核函数的计算。以ReduceMaxCustom算子为例，该算子用于对输入数据按维度dim返回最大值，并且返回索引。ReduceMaxCustom算子有两个属性，reduceDim和isKeepDim，reduceDim表示按照哪一个维度进行reduce操作；isKeepDim表示是否需要保持输出的维度与输入一样。本样例仅支持对最后一维做reduce操作，输入数据类型为half。</p> <ol><li>ReduceMaxCustom算子TilingData的定义如下。这里我们重点关注reduceAxisLen。参数reduceAxisLen表示获取reduceDim轴的长度，这里也就是最后一维的长度。该参数后续会通过TilingData传递到kernel侧参与计算。<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> REDUCE_MAX_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> REDUCE_MAX_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span> </span></li><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(ReduceMaxTilingData) </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, reduceAxisLen); <span class="hljs-comment">// 添加tiling字段，reduceDim轴的长度</span></li><li>  <span class="hljs-comment">// 其他TilingData参数的定义</span></li><li>  <span class="hljs-comment">// ... </span></li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-comment">// 注册算子tilingdata类到对应的ReduceMaxCustom算子</span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(ReduceMaxCustom, ReduceMaxTilingData) </li><li>} </li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// REDUCE_MAX_CUSTOM_TILING_H</span></span></li></ol></pre></div></div> </li><li>ReduceMaxCustom算子的Tiling实现如下。这里我们重点关注属性信息通过TilingData传递的过程：首先通过TilingContext上下文从attr获取reduceDim属性值；然后根据reduceDim属性值获取reduceDim轴的长度并设置到TilingData中。<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling {</li><li><span class="hljs-function"><span class="hljs-type">static</span> ge::graphStatus <span class="hljs-title">TilingFunc</span><span class="hljs-params">(gert::TilingContext *context)</span></span></li><li><span class="hljs-function"></span>{</li><li>    ReduceMaxTilingData tiling;</li><li>    <span class="hljs-comment">// 从attr获取reduceDim属性值，因为reduceDim是第一个属性，所以GetAttrPointer传入的索引值为获取reduceDim轴的长度</span></li><li>    <span class="hljs-type">const</span> gert::StorageShape *xShapePtr = context-&gt;<span class="hljs-built_in">GetInputShape</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">const</span> gert::Shape &amp;xShape = xShapePtr-&gt;<span class="hljs-built_in">GetStorageShape</span>();</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> reduceAxisLen = xShape.<span class="hljs-built_in">GetDim</span>(*reduceDim);</li><li>    <span class="hljs-comment">// 计算TilingData中除了reduceAxisLen之外其他成员变量的值</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 将reduceAxisLen设置到tiling结构体中，传递到kernel函数使用</span></li><li>    tiling.<span class="hljs-built_in">set_reduceAxisLen</span>(reduceAxisLen);</li><li>    <span class="hljs-comment">// 设置TilingData中除了reduceAxisLen之外其他成员变量的值</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// TilingData序列化保存</span></li><li>    tiling.<span class="hljs-built_in">SaveToBuffer</span>(context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetData</span>(), context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetCapacity</span>());</li><li>    context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">SetDataSize</span>(tiling.<span class="hljs-built_in">GetDataSize</span>());</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> ge::GRAPH_SUCCESS;</li><li>}</li><li>}  <span class="hljs-comment">// namespace optiling</span></li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section4639mcpsimp">Tiling参数设计更多样例-使用高阶API时配套的Tiling<i class="anchor-icon anchor-icon-link" anchorid="section4639mcpsimp" tips="复制节点链接"></i></h2><ol><li>首先进行tiling结构定义：<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(MyAddTilingData)  <span class="hljs-comment">// 声明tiling结构名字</span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(TCubeTiling, cubeTilingData);   <span class="hljs-comment">// 引用高阶API的tiling结构体</span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, field);   <span class="hljs-comment">// 结构成员的引用结构体</span></li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MyAdd, MyAddTilingData)  <span class="hljs-comment">// tiling结构注册给算子</span></li><li>}</li></ol></pre></div></div> </li><li>通过高阶API配套的tiling函数对tiling结构初始化：<div _ngcontent-bpa-c106="" class="highlight-div"><div _ngcontent-bpa-c106="" class="highlight-div-header"><div _ngcontent-bpa-c106="" class="highlight-div-header-left"><div _ngcontent-bpa-c106="" class="handle-button expand-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bpa-c106="" class="highlight-div-header-right"><div _ngcontent-bpa-c106="" class="handle-button ai-button"></div><div _ngcontent-bpa-c106="" class="handle-button line-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bpa-c106="" class="handle-button theme-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bpa-c106="" class="handle-button copy-button"><div _ngcontent-bpa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bpa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> ge::graphStatus <span class="hljs-title">TilingFunc</span><span class="hljs-params">(gert::TilingContext* context)</span> </span>{ </li><li>     <span class="hljs-type">int32_t</span> M = <span class="hljs-number">1024</span>; </li><li>     <span class="hljs-type">int32_t</span> N = <span class="hljs-number">640</span>; </li><li>     <span class="hljs-type">int32_t</span> K = <span class="hljs-number">256</span>; </li><li>     <span class="hljs-type">int32_t</span> baseM = <span class="hljs-number">128</span>; </li><li>     <span class="hljs-type">int32_t</span> baseN = <span class="hljs-number">128</span>; </li><li>     <span class="hljs-keyword">auto</span> ascendcPlatform = platform_ascendc::<span class="hljs-built_in">PlatformAscendC</span>(context-&gt;<span class="hljs-built_in">GetPlatformInfo</span>()); </li><li>     <span class="hljs-function">MultiCoreMatmulTiling <span class="hljs-title">cubeTiling</span><span class="hljs-params">(ascendcPlatform)</span></span>; </li><li>     cubeTiling.<span class="hljs-built_in">SetDim</span>(<span class="hljs-number">2</span>); </li><li>     cubeTiling.<span class="hljs-built_in">SetAType</span>(TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16); </li><li>     cubeTiling.<span class="hljs-built_in">SetBType</span>(TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16); </li><li>     cubeTiling.<span class="hljs-built_in">SetCType</span>(TPosition::LCM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT); </li><li>     cubeTiling.<span class="hljs-built_in">SetBiasType</span>(TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT); </li><li>     cubeTiling.<span class="hljs-built_in">SetShape</span>(M, N, K); </li><li>     cubeTiling.<span class="hljs-built_in">SetOrgShape</span>(M, N, K); </li><li>     cubeTiling.<span class="hljs-built_in">SetFixSplit</span>(baseM, baseN, <span class="hljs-number">-1</span>); </li><li>     cubeTiling.<span class="hljs-built_in">SetBias</span>(<span class="hljs-literal">true</span>); </li><li>     cubeTiling.<span class="hljs-built_in">SetBufferSpace</span>(<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>); </li><li>     MyAddTilingData tiling; </li><li>     <span class="hljs-keyword">if</span> (cubeTiling.<span class="hljs-built_in">GetTiling</span>(tiling.cubeTilingData) == <span class="hljs-number">-1</span>){ </li><li>         <span class="hljs-keyword">return</span> ge::GRAPH_FAILED; </li><li>     } </li><li>     <span class="hljs-comment">// To do sth </span></li><li> }</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>