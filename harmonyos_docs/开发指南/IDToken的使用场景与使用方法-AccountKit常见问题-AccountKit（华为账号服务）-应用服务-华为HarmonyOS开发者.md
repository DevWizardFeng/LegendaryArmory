<h1 _ngcontent-krg-c119="" class="doc-title ng-star-inserted" title="ID Token的使用场景与使用方法"> ID Token的使用场景与使用方法 </h1>

<div _ngcontent-krg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>ID Token是OIDC (<a href="https://openid.net/specs/openid-connect-core-1_0.html" target="_blank">OpenID Connect</a>) 协议相对于 OAuth 2.0 协议扩展的一个用户身份凭证。</p>    <p>ID Token 是 JWT Token格式，意味着：</p>    <p>1. 用户的身份信息直接被编码进了ID Token，不需要额外请求其他的资源来获取用户信息。</p>    <p>2. ID Token 可以验证其是华为账号服务颁发的，携带华为账号签名信息，验证签名可证明其没有被篡改过。</p>    <div class="tiledSection">     <h2 id="section1310261915566">使用场景<i class="anchor-icon anchor-icon-link" anchorid="section1310261915566" tips="复制节点链接"></i></h2>          <ol>      <li>应用无服务器，只有客户端，该场景下无法使用Authorization Code完成服务器侧的接口调用获取用户信息，需从ID Token中解析出用户信息；</li>      <li>应用有服务器，希望在服务器侧解析ID Token对应字段，获取用户信息。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section8259103295619">字段说明<i class="anchor-icon anchor-icon-link" anchorid="section8259103295619" tips="复制节点链接"></i></h2>          <p>ID Token是JWT Token格式数据，其中payload包含字段如下：</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.1" valign="top" width="30.826917308269174%">         <p>字段</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.2" valign="top" width="19.668033196680334%">         <p>参数类型</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.3" valign="top" width="18.678132186781323%">         <p>是否默认返回</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.4" valign="top" width="30.826917308269174%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>iss</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>固定值："https://accounts.huawei.com"。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>sub</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>即用户的UnionID。同一个开发者下的所有应用，此参数均相同。具体格式要求请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-9">OpenID和UnionID的格式说明</a>。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>aud</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>接收ID Token的Client ID。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>exp</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>number</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>ID Token的过期时间戳(10位)。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>iat</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>number</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>ID Token的生成时间戳(10位)。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>at_hash</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>Access Token的哈希值。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>azp</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>生成ID Token的Client ID。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>openid</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>是</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>用户OpenID。具体格式要求请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-9">OpenID和UnionID的格式说明</a>。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>nonce</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>否</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>防重放攻击随机值。详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section42261825935" target="_blank">LoginWithHuaweiIDRequest</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>的nonce字段说明。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>picture</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>否</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>用户头像图片链接。该字段返回场景：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>中的scopes包含profile。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>display_name</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>否</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>华为账号对应的昵称，没有昵称则取匿名化的邮箱或手机号。该字段返回场景：</p>         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>中的scopes包含profile。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>nickname</p></td>        <td class="cellrowborder" valign="top" width="19.668033196680334%">         <p>string</p></td>        <td class="cellrowborder" valign="top" width="18.678132186781323%">         <p>否</p></td>        <td class="cellrowborder" valign="top" width="30.826917308269174%">         <p>华为账号对应的昵称。该字段返回场景：</p>         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>中的scopes包含profile。</p></td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="section6924154019588">解析与验证<i class="anchor-icon anchor-icon-link" anchorid="section6924154019588" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1684141911591" class="firsth2"><strong>服务端解析与验证</strong><i class="anchor-icon anchor-icon-link" anchorid="section1684141911591" tips="复制节点链接"></i></h3>          <p>使用场景：有服务器应用。</p>     <p>对于有应用服务端的应用，推荐在服务端进行ID Token解析与验证，具体参考以下Maven工程依赖配置及Java示例代码。</p>     <p>Maven工程依赖：</p>     <div _ngcontent-krg-c106="" class="highlight-div"><div _ngcontent-krg-c106="" class="highlight-div-header"><div _ngcontent-krg-c106="" class="highlight-div-header-left"><div _ngcontent-krg-c106="" class="handle-button expand-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-krg-c106="" class="highlight-div-header-right"><div _ngcontent-krg-c106="" class="handle-button ai-button"></div><div _ngcontent-krg-c106="" class="handle-button line-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-krg-c106="" class="handle-button theme-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-krg-c106="" class="handle-button copy-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-krg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.51<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> </span><span class=""><span class="language-xml"><span class="hljs-comment">&lt;</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">!--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">此处替换为您项目需要的版本</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">&gt;</span></span></span><span class="language-xml"></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk18on<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.74<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> </span><span class=""><span class="language-xml"><span class="hljs-comment">&lt;</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">!--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">此处替换为您项目需要的版本</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">&gt;</span></span></span><span class="language-xml"></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> </span><span class=""><span class="language-xml"><span class="hljs-comment">&lt;</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">!--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">此处替换为您项目需要的版本</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">&gt;</span></span></span><span class="language-xml"></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jwks-rsa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.8.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> </span><span class=""><span class="language-xml"><span class="hljs-comment">&lt;</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">!--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">此处替换为您项目需要的版本</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">&gt;</span></span></span><span class="language-xml"></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> </span><span class=""><span class="language-xml"><span class="hljs-comment">&lt;</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">!--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">此处替换为您项目需要的版本</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">--</span></span></span><span class=""><span class="language-xml"><span class="hljs-comment">&gt;</span></span></span><span class="language-xml"></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span></li></ol></pre></div></div>     <p>Java代码示例：</p>     <div _ngcontent-krg-c106="" class="highlight-div"><div _ngcontent-krg-c106="" class="highlight-div-header"><div _ngcontent-krg-c106="" class="highlight-div-header-left"><div _ngcontent-krg-c106="" class="handle-button expand-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-krg-c106="" class="highlight-div-header-right"><div _ngcontent-krg-c106="" class="handle-button ai-button"></div><div _ngcontent-krg-c106="" class="handle-button line-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-krg-c106="" class="handle-button theme-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-krg-c106="" class="handle-button copy-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-krg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;</li><li><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONObject;</li><li><span class="hljs-keyword">import</span> com.auth0.jwk.InvalidPublicKeyException;</li><li><span class="hljs-keyword">import</span> com.auth0.jwk.Jwk;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.JWT;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.JWTVerifier;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.algorithms.Algorithm;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.exceptions.JWTDecodeException;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.exceptions.JWTVerificationException;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.exceptions.TokenExpiredException;</li><li><span class="hljs-keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</li><li><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;</li><li><span class="hljs-keyword">import</span> org.apache.http.HttpEntity;</li><li><span class="hljs-keyword">import</span> org.apache.http.client.config.RequestConfig;</li><li><span class="hljs-keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</li><li><span class="hljs-keyword">import</span> org.apache.http.client.methods.HttpGet;</li><li><span class="hljs-keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</li><li><span class="hljs-keyword">import</span> org.apache.http.impl.client.HttpClients;</li><li><span class="hljs-keyword">import</span> org.apache.http.util.EntityUtils;</li><li><span class="hljs-keyword">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</li><li><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;</li><li><span class="hljs-keyword">import</span> java.security.GeneralSecurityException;</li><li><span class="hljs-keyword">import</span> java.security.Security;</li><li><span class="hljs-keyword">import</span> java.security.Signature;</li><li><span class="hljs-keyword">import</span> java.security.interfaces.RSAPublicKey;</li><li><span class="hljs-keyword">import</span> java.util.ArrayList;</li><li><span class="hljs-keyword">import</span> java.util.HashMap;</li><li><span class="hljs-keyword">import</span> java.util.List;</li><li><span class="hljs-keyword">import</span> java.util.Map;</li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IDTokenParser</span> {</li><li>    <span class="hljs-comment">// 请替换为您的Client ID</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLIENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>;</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_PUBLIC_KEY_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;</li><li>    <span class="hljs-comment">// 缓存jwt公钥信息</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, RSAPublicKey&gt; keyId2PublicKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * JWK JSON Web Key端点，开发者可以从该端点获取最近两天的JWK</span></li><li><span class="hljs-comment">     * 公钥在24小时内更新。确保以下ID Token在24小时内生成</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CERT_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/certs"</span>;</li><li>    <span class="hljs-comment">// ID Token的issue</span></li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ID_TOKEN_ISSUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://accounts.huawei.com"</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALG_RS256</span> <span class="hljs-operator">=</span> <span class="hljs-string">"RS256"</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALG_PS256</span> <span class="hljs-operator">=</span> <span class="hljs-string">"PS256"</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-comment">// 由上述CLIENT_ID对应值生成的ID Token</span></li><li>        <span class="hljs-type">String</span> <span class="hljs-variable">idToken</span> <span class="hljs-operator">=</span> <span class="hljs-string">"</span><i><div class="varname_wrapper"><span class="varname"><span class="hljs-string">&lt;ID Token&gt;</span></span></div></i><span class="hljs-string">"</span>;</li><li>        <span class="hljs-type">IDTokenParser</span> <span class="hljs-variable">idTokenParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IDTokenParser</span>();</li><li>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">idTokenInfo</span> <span class="hljs-operator">=</span> idTokenParser.verifyAndParse(idToken);</li><li>        <span class="hljs-comment">// 解析获取ID Token中的数据，例：解析获取iss</span></li><li>        <span class="hljs-type">String</span> <span class="hljs-variable">iss</span> <span class="hljs-operator">=</span> idTokenInfo.getString(<span class="hljs-string">"iss"</span>);</li><li>    }</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 验证并解析ID Token</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> idToken idToken</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ID Token携带的信息</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception 异常</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">verifyAndParse</span><span class="hljs-params">(String idToken)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> JWT.decode(idToken);</li><li>            <span class="hljs-keyword">if</span> (!decoder.getIssuer().equals(ID_TOKEN_ISSUE)) {</li><li>                <span class="hljs-comment">// issuer校验不通过，抛出异常（异常类型可自行选择）</span></li><li>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"issuer no match"</span>);</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (decoder.getAudience().size() &gt; <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-keyword">if</span> (!decoder.getAudience().get(<span class="hljs-number">0</span>).equals(CLIENT_ID)) {</li><li>                    <span class="hljs-comment">// audience校验不通过，抛出异常（异常类型可自行选择）</span></li><li>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"audience no match"</span>);</li><li>                }</li><li>            }</li><li>            <span class="hljs-comment">// 获取ID Token签名使用的算法</span></li><li>            <span class="hljs-type">String</span> <span class="hljs-variable">alg</span> <span class="hljs-operator">=</span> decoder.getAlgorithm();</li><li>            <span class="hljs-keyword">if</span> (ALG_RS256.equals(alg)) {</li><li>                <span class="hljs-type">Algorithm</span> <span class="hljs-variable">algorithm</span> <span class="hljs-operator">=</span> Algorithm.RSA256(getRSAPublicKeyByKid(decoder.getKeyId()), <span class="hljs-literal">null</span>);</li><li>                <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(algorithm).build();</li><li>                <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSONObject.parseObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.decodeBase64(decoder.getPayload())));</li><li>                <span class="hljs-comment">// 验证签名</span></li><li>                verifier.verify(decoder);</li><li>                jsonObject.put(<span class="hljs-string">"alg"</span>, decoder.getAlgorithm());</li><li>                jsonObject.put(<span class="hljs-string">"typ"</span>, decoder.getType());</li><li>                jsonObject.put(<span class="hljs-string">"kid"</span>, decoder.getKeyId());</li><li>                <span class="hljs-keyword">return</span> jsonObject;</li><li>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ALG_PS256.equals(alg)) {</li><li>                <span class="hljs-type">PS256Algorithm</span> <span class="hljs-variable">algorithm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PS256Algorithm</span>(getRSAPublicKeyByKid(decoder.getKeyId()));</li><li>                <span class="hljs-type">boolean</span> <span class="hljs-variable">verifyResult</span> <span class="hljs-operator">=</span> algorithm.verify(decoder.getHeader(), decoder.getPayload(),</li><li>                    decoder.getSignature());</li><li>                <span class="hljs-keyword">if</span> (verifyResult) {</li><li>                    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSONObject.parseObject(</li><li>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.decodeBase64(decoder.getPayload())));</li><li>                    jsonObject.put(<span class="hljs-string">"alg"</span>, decoder.getAlgorithm());</li><li>                    jsonObject.put(<span class="hljs-string">"typ"</span>, decoder.getType());</li><li>                    jsonObject.put(<span class="hljs-string">"kid"</span>, decoder.getKeyId());</li><li>                    <span class="hljs-keyword">return</span> jsonObject;</li><li>                }</li><li>            }</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>        } <span class="hljs-keyword">catch</span> (JWTDecodeException e) {</li><li>            <span class="hljs-comment">// ID Token解析失败，此场景常见于ID Token格式不正确</span></li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ID Token decode failed"</span>);</li><li>        } <span class="hljs-keyword">catch</span> (TokenExpiredException e) {</li><li>            <span class="hljs-comment">// ID Token已过期</span></li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ID Token expired"</span>);</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 通过kid获取公钥信息，请缓存公钥信息，示例中采用map方式进行缓存，开发者可选择其它合适的方式进行缓存</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyId  keyId</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥信息</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InvalidPublicKeyException 异常</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">private</span> RSAPublicKey <span class="hljs-title function_">getRSAPublicKeyByKid</span><span class="hljs-params">(String keyId)</span> <span class="hljs-keyword">throws</span> InvalidPublicKeyException {</li><li>        <span class="hljs-keyword">if</span> (keyId2PublicKey.get(keyId) != <span class="hljs-literal">null</span>) {</li><li>            <span class="hljs-keyword">return</span> keyId2PublicKey.get(keyId);</li><li>        }</li><li>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> getJwks();</li><li>        <span class="hljs-keyword">if</span> (keys == <span class="hljs-literal">null</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (keyId2PublicKey.size() &gt; MAX_PUBLIC_KEY_SIZE) {</li><li>            keyId2PublicKey.clear();</li><li>        }</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keys.size(); i++) {</li><li>            <span class="hljs-type">String</span> <span class="hljs-variable">kid</span> <span class="hljs-operator">=</span> keys.getJSONObject(i).getString(<span class="hljs-string">"kid"</span>);</li><li>            <span class="hljs-type">String</span> <span class="hljs-variable">alg</span> <span class="hljs-operator">=</span> keys.getJSONObject(i).getString(<span class="hljs-string">"alg"</span>);</li><li>            <span class="hljs-keyword">if</span> (ALG_RS256.equals(alg) || ALG_PS256.equals(alg)) {</li><li>                keyId2PublicKey.put(kid, getRsaPublicKeyByJwk(keys.getJSONObject(i)));</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">return</span> keyId2PublicKey.get(keyId);</li><li>    }</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 从https://oauth-login.cloud.huawei.com/oauth2/v3/certs获取jwt公钥信息jwk</span></li><li><span class="hljs-comment">     * 因为jwk每天都会更新，所以需要缓存jwk</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JSONObject 公钥信息数组</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JSONArray <span class="hljs-title function_">getJwks</span><span class="hljs-params">()</span> {</li><li>        <span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();</li><li>        <span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(CERT_URL);</li><li>        <span class="hljs-type">RequestConfig</span> <span class="hljs-variable">requestConfig</span> <span class="hljs-operator">=</span> RequestConfig.custom()</li><li>            .setConnectTimeout(<span class="hljs-number">5000</span>)</li><li>            .setConnectionRequestTimeout(<span class="hljs-number">5000</span>)</li><li>            .setSocketTimeout(<span class="hljs-number">5000</span>)</li><li>            .build();</li><li>        httpGet.setConfig(requestConfig);</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-type">CloseableHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(httpGet);</li><li>            <span class="hljs-type">HttpEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> response.getEntity();</li><li>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> EntityUtils.toString(entity);</li><li>            <span class="hljs-keyword">return</span> JSONObject.parseObject(result).getJSONArray(<span class="hljs-string">"keys"</span>);</li><li>        } <span class="hljs-keyword">catch</span> (Exception e) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>        } <span class="hljs-keyword">finally</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != httpClient) {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                    httpClient.close();</li><li>                } <span class="hljs-keyword">catch</span> (Exception e) {</li><li>                    e.printStackTrace();</li><li>                }</li><li>            }</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 通过jwk获取公钥信息</span></li><li><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> RSAPublicKey 公钥信息</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RSAPublicKey <span class="hljs-title function_">getRsaPublicKeyByJwk</span><span class="hljs-params">(JSONObject jwkObject)</span> <span class="hljs-keyword">throws</span> InvalidPublicKeyException {</li><li>        Map&lt;String, Object&gt; additionalAttributes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();</li><li>        additionalAttributes.put(<span class="hljs-string">"n"</span>, jwkObject.getString(<span class="hljs-string">"n"</span>));</li><li>        additionalAttributes.put(<span class="hljs-string">"e"</span>, jwkObject.getString(<span class="hljs-string">"e"</span>));</li><li>        List&lt;String&gt; operations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();</li><li>        <span class="hljs-type">Jwk</span> <span class="hljs-variable">jwk</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jwk</span>(jwkObject.getString(<span class="hljs-string">"kid"</span>), jwkObject.getString(<span class="hljs-string">"kty"</span>), jwkObject.getString(<span class="hljs-string">"alg"</span>),</li><li>            jwkObject.getString(<span class="hljs-string">"use"</span>), operations, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, additionalAttributes);</li><li>        <span class="hljs-keyword">return</span> (RSAPublicKey) jwk.getPublicKey();</li><li>    }</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PS256Algorithm</span> {</li><li>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RSAPublicKey publicKey;</li><li>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">PS256Algorithm</span><span class="hljs-params">(RSAPublicKey publicKey)</span> {</li><li>            <span class="hljs-built_in">this</span>.publicKey = publicKey;</li><li>        }</li><li>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(String header, String payload, String signature)</span> <span class="hljs-keyword">throws</span> JWTVerificationException {</li><li>            <span class="hljs-type">byte</span>[] contentBytes = (header + <span class="hljs-string">'.'</span> + payload).getBytes(StandardCharsets.UTF_8);</li><li>            <span class="hljs-type">byte</span>[] signatureBytes = Base64.decodeBase64(signature);</li><li>            <span class="hljs-keyword">try</span> {</li><li>                Security.addProvider(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BouncyCastleProvider</span>());</li><li>                <span class="hljs-type">Signature</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">"SHA256WithRSA/PSS"</span>);</li><li>                sign.initVerify(publicKey);</li><li>                sign.update(contentBytes);</li><li>                <span class="hljs-keyword">return</span> sign.verify(signatureBytes);</li><li>            } <span class="hljs-keyword">catch</span> (GeneralSecurityException e) {</li><li>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JWTVerificationException</span>(<span class="hljs-string">"JWT verify failed"</span>);</li><li>            }</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section1198418315518"><strong>客户端解析与验证</strong><i class="anchor-icon anchor-icon-link" anchorid="section1198418315518" tips="复制节点链接"></i></h3>          <p>使用场景：无服务器应用。</p>     <div class="p">      对于无服务器应用，可在客户端获取ID Token后，进行本地解析与验证，解析后可获取用户数据，并验证签名，具体参考如下ArkTS代码示例，将获取的ID Token作为方法入参，并将代码中的CLIENT_ID替换为应用真实的Client ID：      <div _ngcontent-krg-c106="" class="highlight-div"><div _ngcontent-krg-c106="" class="highlight-div-header"><div _ngcontent-krg-c106="" class="highlight-div-header-left"><div _ngcontent-krg-c106="" class="handle-button expand-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-krg-c106="" class="highlight-div-header-right"><div _ngcontent-krg-c106="" class="handle-button ai-button"></div><div _ngcontent-krg-c106="" class="handle-button line-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-krg-c106="" class="handle-button theme-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-krg-c106="" class="handle-button copy-button"><div _ngcontent-krg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-krg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-title function_">decodeBase64</span>(<span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">return</span> buffer.<span class="hljs-title function_">from</span>(data, <span class="hljs-string">'base64'</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'utf8'</span>);</li><li>}</li><li><span class="hljs-comment">// 解析ID Token并验证</span></li><li><span class="hljs-title function_">decodeIdToken</span>(<span class="hljs-attr">idToken</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">const</span> parts = idToken.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);</li><li>  <span class="hljs-keyword">if</span> (parts.<span class="hljs-property">length</span> !== <span class="hljs-number">3</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">idTokenObj</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = {};</li><li>  <span class="hljs-comment">// ID Token头部</span></li><li>  idTokenObj[<span class="hljs-string">'header'</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decodeBase64</span>(parts[<span class="hljs-number">0</span>]));</li><li>  <span class="hljs-comment">// ID Token负载</span></li><li>  idTokenObj[<span class="hljs-string">'payload'</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decodeBase64</span>(parts[<span class="hljs-number">1</span>]));</li><li>  <span class="hljs-comment">// ID Token签名</span></li><li>  idTokenObj[<span class="hljs-string">'signature'</span>] = parts[<span class="hljs-number">2</span>];</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">header</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = idTokenObj[<span class="hljs-string">'header'</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;</li><li>  <span class="hljs-comment">// 从负载中解析出nonce等数据</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">payLoad</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = idTokenObj[<span class="hljs-string">'payload'</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">nonce</span>: <span class="hljs-built_in">string</span> = payLoad[<span class="hljs-string">'nonce'</span>];</li><li>  <span class="hljs-comment">// 应用Client ID，使用前请替换</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CLIENT_ID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'</span><span class=""><span class="hljs-string">&lt;</span></span><i><div class="varname_wrapper"><span class="varname"><span class="hljs-string">应用Client ID</span></span></div></i><span class=""><span class="hljs-string">&gt;</span></span><span class="hljs-string">'</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">ID_TOKEN_ISSUE</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'https://accounts.huawei.com'</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">iss</span>: <span class="hljs-built_in">string</span> = payLoad[<span class="hljs-string">'iss'</span>];</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">aud</span>: <span class="hljs-built_in">string</span> = payLoad[<span class="hljs-string">'aud'</span>];</li><li>  <span class="hljs-keyword">if</span>(iss !== <span class="hljs-variable constant_">ID_TOKEN_ISSUE</span>){</li><li>    <span class="hljs-comment">// 验证失败，开发者处理失败场景</span></li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to check iss'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span>(aud !== <span class="hljs-variable constant_">CLIENT_ID</span>){</li><li>    <span class="hljs-comment">// 验证失败，开发者处理失败场景</span></li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to check aud'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 验证签名</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkSignature</span>(idToken, header[<span class="hljs-string">'kid'</span>], header[<span class="hljs-string">'alg'</span>]);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">stringToUint8Array</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">tmpUint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">return</span> tmpUint8Array;</li><li>}</li><li><span class="hljs-comment">// 验签方法</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">checkSignature</span>(<span class="hljs-params">idToken: <span class="hljs-built_in">string</span>, kid: <span class="hljs-built_in">string</span>, alg: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (!idToken) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> parts = idToken.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);</li><li>  <span class="hljs-keyword">if</span> (parts.<span class="hljs-property">length</span> !== <span class="hljs-number">3</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> url = <span class="hljs-string">'https://oauth-login.cloud.huawei.com/oauth2/v3/certs'</span>;</li><li>  <span class="hljs-comment">// 创建http请求，应用需在module.json5文件中先申请“ohos.permission.INTERNET”网络权限，请求才能发送成功</span></li><li>  <span class="hljs-keyword">const</span> httpRequest = http.<span class="hljs-title function_">createHttp</span>();</li><li>  httpRequest.<span class="hljs-title function_">request</span>(url, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to httpRequest. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      httpRequest.<span class="hljs-title function_">destroy</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> nStr = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> eStr = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">keys</span>: <span class="hljs-built_in">object</span>[] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>)[<span class="hljs-string">"keys"</span>];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> keys) {</li><li>      <span class="hljs-keyword">if</span> (kid === item[<span class="hljs-string">'kid'</span>]) {</li><li>        nStr = item[<span class="hljs-string">'n'</span>];</li><li>        eStr = item[<span class="hljs-string">'e'</span>];</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">const</span> nBigInt = <span class="hljs-string">'0x'</span> + buffer.<span class="hljs-title function_">from</span>(nStr, <span class="hljs-string">"base64url"</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'hex'</span>);</li><li>    <span class="hljs-keyword">const</span> eBigInt = <span class="hljs-string">'0x'</span> + buffer.<span class="hljs-title function_">from</span>(eStr, <span class="hljs-string">"base64url"</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'hex'</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">dsaCommonSpec</span>: cryptoFramework.<span class="hljs-property">RSACommonParamsSpec</span> = {</li><li>      <span class="hljs-attr">algName</span>: <span class="hljs-string">"RSA"</span>,</li><li>      <span class="hljs-attr">specType</span>: cryptoFramework.<span class="hljs-property">AsyKeySpecType</span>.<span class="hljs-property">COMMON_PARAMS_SPEC</span>,</li><li>      <span class="hljs-attr">n</span>: <span class="hljs-title class_">BigInt</span>(nBigInt),</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">rsaKeyPairSpec</span>: cryptoFramework.<span class="hljs-property">RSAPubKeySpec</span> = {</li><li>      <span class="hljs-attr">algName</span>: <span class="hljs-string">"RSA"</span>,</li><li>      <span class="hljs-attr">specType</span>: cryptoFramework.<span class="hljs-property">AsyKeySpecType</span>.<span class="hljs-property">PUBLIC_KEY_SPEC</span>,</li><li>      <span class="hljs-attr">params</span>: dsaCommonSpec,</li><li>      <span class="hljs-attr">pk</span>: <span class="hljs-title class_">BigInt</span>(eBigInt),</li><li>    }</li><li>    <span class="hljs-keyword">const</span> asyKeyGeneratorBySpec = cryptoFramework.<span class="hljs-title function_">createAsyKeyGeneratorBySpec</span>(rsaKeyPairSpec);</li><li>    asyKeyGeneratorBySpec.<span class="hljs-title function_">generatePubKey</span>(<span class="hljs-keyword">async</span> (error, publicKey) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (error) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (publicKey === <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">const</span> idTokenSign = parts[<span class="hljs-number">2</span>];</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">idTokenSignArr</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(idTokenSign, <span class="hljs-string">"base64url"</span>).<span class="hljs-property">buffer</span>) };</li><li>      <span class="hljs-keyword">const</span> idToken = parts[<span class="hljs-number">0</span>] + <span class="hljs-string">'.'</span> + parts[<span class="hljs-number">1</span>];</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">idTokenArr</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stringToUint8Array</span>(idToken) };</li><li>      <span class="hljs-keyword">const</span> verifier = alg === <span class="hljs-string">'PS256'</span> ? cryptoFramework.<span class="hljs-title function_">createVerify</span>(<span class="hljs-string">"RSA2048|PSS|SHA256|MGF1_SHA256"</span>)</li><li>        : cryptoFramework.<span class="hljs-title function_">createVerify</span>(<span class="hljs-string">"RSA2048|PKCS1|SHA256"</span>);</li><li>      verifier.<span class="hljs-title function_">init</span>(publicKey, <span class="hljs-function">(<span class="hljs-params">initErr, result</span>) =&gt;</span> {</li><li>        verifier.<span class="hljs-title function_">verify</span>(idTokenArr, idTokenSignArr, <span class="hljs-function">(<span class="hljs-params">verifyErr, data</span>) =&gt;</span> {</li><li>          <span class="hljs-comment">// 打印验签结果，结果为true则验签通过</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'verify result is: %{public}s'</span>, data);</li><li>        });</li><li>      });</li><li>    })</li><li>    httpRequest.<span class="hljs-title function_">destroy</span>();</li><li>  });</li><li>}</li></ol></pre></div></div>     </div>    </div>   </div>   <div></div></div>