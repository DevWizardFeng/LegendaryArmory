<h1 _ngcontent-pvw-c119="" class="doc-title ng-star-inserted" title="I/O密集型任务开发指导 (TaskPool)"> I/O密集型任务开发指导 (TaskPool) </h1>

<div _ngcontent-pvw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用异步并发可以解决单次I/O任务阻塞的问题。对于I/O密集型任务，若线程中的其他任务仍可能被阻塞，建议采用多线程并发来处理。</p>    <p>I/O密集型任务的性能关键在于I/O操作的速度和效率，而非CPU的处理能力。这类任务需要频繁进行磁盘读写和网络通信。此处通过频繁读写系统文件来模拟I/O密集型并发任务的处理。</p>    <ol>     <li>定义并发函数，内部密集调用I/O能力。      <div _ngcontent-pvw-c106="" class="highlight-div"><div _ngcontent-pvw-c106="" class="highlight-div-header"><div _ngcontent-pvw-c106="" class="highlight-div-header-left"><div _ngcontent-pvw-c106="" class="handle-button expand-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pvw-c106="" class="highlight-div-header-right"><div _ngcontent-pvw-c106="" class="handle-button ai-button"></div><div _ngcontent-pvw-c106="" class="handle-button line-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pvw-c106="" class="handle-button theme-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pvw-c106="" class="handle-button copy-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pvw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// write.ets</span></li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 定义并发函数，内部频繁调用I/O能力</span></li><li><span class="hljs-comment">// 写入文件的实现</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span>, filePath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(filePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">write</span>(file.<span class="hljs-property">fd</span>, data);</li><li>  fileIo.<span class="hljs-title function_">close</span>(file);</li><li>}</li></ol></pre></div></div>      <div _ngcontent-pvw-c106="" class="highlight-div"><div _ngcontent-pvw-c106="" class="highlight-div-header"><div _ngcontent-pvw-c106="" class="highlight-div-header-left"><div _ngcontent-pvw-c106="" class="handle-button expand-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pvw-c106="" class="highlight-div-header-right"><div _ngcontent-pvw-c106="" class="handle-button ai-button"></div><div _ngcontent-pvw-c106="" class="handle-button line-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pvw-c106="" class="handle-button theme-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pvw-c106="" class="handle-button copy-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pvw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { write } <span class="hljs-keyword">from</span> <span class="hljs-string">'./write'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentTest</span>(<span class="hljs-params">context: common.UIAbilityContext</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 应用文件路径</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">filePath1</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">"/path1.txt"</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">filePath2</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">"/path2.txt"</span>;</li><li>  <span class="hljs-comment">// 循环写文件操作</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">fileList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  fileList.<span class="hljs-title function_">push</span>(filePath1);</li><li>  fileList.<span class="hljs-title function_">push</span>(filePath2);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; i &lt; fileList.<span class="hljs-property">length</span>; i++) {</li><li>    <span class="hljs-title function_">write</span>(<span class="hljs-string">'Hello World!'</span>, fileList[i]).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in writing the file. FileList: <span class="hljs-subst">${fileList[i]}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to write the file. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>    </ol>    <ol>     <li>      <p>使用TaskPool执行包含密集I/O的并发函数，通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskpoolexecute" target="_blank">execute()</a>方法执行任务，并在回调中处理调度结果。示例中获取filePath1和filePath2的方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径">获取应用文件路径</a>。在TaskPool中使用context时，需先在并发函数外部准备好，并通过参数传递给并发函数。</p>      <div _ngcontent-pvw-c106="" class="highlight-div"><div _ngcontent-pvw-c106="" class="highlight-div-header"><div _ngcontent-pvw-c106="" class="highlight-div-header-left"><div _ngcontent-pvw-c106="" class="handle-button expand-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pvw-c106="" class="highlight-div-header-right"><div _ngcontent-pvw-c106="" class="handle-button ai-button"></div><div _ngcontent-pvw-c106="" class="handle-button line-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pvw-c106="" class="handle-button theme-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pvw-c106="" class="handle-button copy-button"><div _ngcontent-pvw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pvw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>            <span class="hljs-comment">// 使用TaskPool执行包含密集I/O的并发函数</span></li><li>            <span class="hljs-comment">// 数组较大时，I/O密集型任务分发也会抢占UI主线程，需要使用多线程能力</span></li><li>            taskpool.<span class="hljs-title function_">execute</span>(concurrentTest, context).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-comment">// 调度结果处理</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"taskpool: execute success"</span>);</li><li>            })</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>