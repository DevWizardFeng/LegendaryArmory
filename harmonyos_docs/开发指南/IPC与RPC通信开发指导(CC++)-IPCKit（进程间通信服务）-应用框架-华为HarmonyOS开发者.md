<h1 _ngcontent-kty-c119="" class="doc-title ng-star-inserted" title="IPC与RPC通信开发指导(C/C++)"> IPC与RPC通信开发指导(C/C++) </h1>

<div _ngcontent-kty-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>IPC让运行在不同进程间的Proxy和Stub实现互相通信。IPC CAPI是IPC Kit提供的C语言接口。</p>     <p>IPC CAPI接口不直接提供获取通信代理对象的能力，该功能由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/abilitykit-overview">Ability Kit</a>提供。</p>     <p><span><img originheight="602" originwidth="1113" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114715.34956116722877466625377026927985:50001231000000:2800:78750563AD137DF1B84416D65AAB8882EF6E599DBC9CA966C5600A6B007436C2.png" width="920" height="497.61006289308176"></span></p>     <p>进程间IPC通道的建立，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/capi_nativechildprocess_development_guideline">Native子进程开发指导（C/C++）</a>。本文重点介绍IPC CAPI的使用。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p><strong>表1</strong> IPC CAPI侧关键接口</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">          <p>typedef int (*OH_OnRemoteRequestCallback)</p>          <p>(uint32_t code, const OHIPCParcel *data, OHIPCParcel *reply,</p>          <p>void *userData);</p></td>         <td class="cellrowborder" valign="top" width="50%">Stub端用于处理远端数据请求的回调函数。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OHIPCRemoteStub* OH_IPCRemoteStub_Create</p>          <p>(const char *descriptor, OH_OnRemoteRequestCallback requestCallback,</p>          <p>OH_OnRemoteDestroyCallback destroyCallback, void *userData);</p></td>         <td class="cellrowborder" valign="top" width="50%">创建OHIPCRemoteStub对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>int OH_IPCRemoteProxy_SendRequest(const OHIPCRemoteProxy *proxy,</p>          <p>uint32_t code, const OHIPCParcel *data, OHIPCParcel *reply,</p>          <p>const OH_IPC_MessageOption *option);</p></td>         <td class="cellrowborder" valign="top" width="50%">IPC消息发送函数。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">struct OHIPCRemoteProxy;</td>         <td class="cellrowborder" valign="top" width="50%">用于向远端发送请求的OHIPCRemoteProxy对象，需要依赖元能力接口返回。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OHIPCDeathRecipient* OH_IPCDeathRecipient_Create</p>          <p>(OH_OnDeathRecipientCallback deathRecipientCallback,</p>          <p>OH_OnDeathRecipientDestroyCallback destroyCallback,</p>          <p>void *userData);</p></td>         <td class="cellrowborder" valign="top" width="50%">创建用于监听远端OHIPCRemoteStub对象死亡的通知对象（OHIPCDeathRecipient对象）。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>int OH_IPCRemoteProxy_AddDeathRecipient(OHIPCRemoteProxy *proxy,</p>          <p>OHIPCDeathRecipient *recipient);</p></td>         <td class="cellrowborder" valign="top" width="50%">向OHIPCRemoteProxy对象注册死亡监听，用于接收远端OHIPCRemoteStub对象死亡时的回调通知。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ipckit" target="_blank">IPCKit</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>先创建服务端Stub对象，通过元能力获取其客户端代理Proxy对象，然后用Proxy对象与服务端Stub对象进行IPC通信，同时再注册远端对象的死亡通知回调，用于Proxy侧感知服务端Stub对象所在进程的死亡状态。</p>    </div>    <div class="tiledSection">     <h3 id="添加动态链接库" class="firsth2">添加动态链接库<i class="anchor-icon anchor-icon-link" anchorid="添加动态链接库" tips="复制节点链接"></i></h3>          <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li># ipc capi</li><li>libipc_capi.so</li><li># 元能力，ability capi</li><li>libchild_process.so</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="头文件">头文件<i class="anchor-icon anchor-icon-link" anchorid="头文件" tips="复制节点链接"></i></h3>          <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ipc capi</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;IPCKit/ipc_kit.h&gt;</span></span></li><li><span class="hljs-comment">// 元能力，ability capi。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;AbilityKit/native_child_process.h&gt;</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="异步调用场景">异步调用场景<i class="anchor-icon anchor-icon-link" anchorid="异步调用场景" tips="复制节点链接"></i></h3>          <p><strong>公共数据及函数定义</strong></p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;IPCKit/ipc_kit.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;AbilityKit/native_child_process.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0201</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"IPCCApiSample"</span></span></li><li>
</li><li><span class="hljs-keyword">enum</span> <span class="hljs-title class_">RequestCode</span> {</li><li>    ASYNC_ADD_CODE = <span class="hljs-number">1</span>,</li><li>    REQUEST_EXIT_CODE = <span class="hljs-number">2</span>,</li><li>    OTHER_CODE</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> MAX_MEMORY_SIZE = <span class="hljs-number">204800</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> std::string INTERFACE_DESCRIPTOR = <span class="hljs-string">"INTERFACE_DESCRIPTOR"</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> std::string NATIVE_REMOTE_STUB_TEST_TOKEN = <span class="hljs-string">"native.remote.stub"</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> std::string NATIVE_REMOTE_STUB_ASYNC_CALL_TEST_TOKEN = <span class="hljs-string">"native.remote.stub.async.call"</span>;</li><li>
</li><li><span class="hljs-comment">// 定义内存分配函数。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">LocalMemoryAllocator</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> len)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span> || len &gt; MAX_MEMORY_SIZE ) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">void</span> *buffer = <span class="hljs-built_in">malloc</span>(len);</li><li>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0</span>, len);</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>}</li></ol></pre></div></div>     <p><strong>服务端对象: IpcCApiStubTest</strong></p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">IpcCApiStubTest</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">IpcCApiStubTest</span><span class="hljs-params">()</span></span>;</li><li>    ~<span class="hljs-built_in">IpcCApiStubTest</span>();</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainProc</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function">OHIPCRemoteStub* <span class="hljs-title">GetRemoteStub</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">OnRemoteRequest</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> OHIPCParcel *data, OHIPCParcel *reply, <span class="hljs-type">void</span> *userData)</span></span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AsyncAdd</span><span class="hljs-params">(<span class="hljs-type">const</span> OHIPCParcel *data)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RequestExitChildProcess</span><span class="hljs-params">()</span></span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    OHIPCRemoteStub *stub_{ <span class="hljs-literal">nullptr</span> };</li><li>    std::mutex childMutex_;</li><li>    std::condition_variable childCondVar_;</li><li>};</li><li>
</li><li>IpcCApiStubTest::<span class="hljs-built_in">IpcCApiStubTest</span>() {</li><li>    <span class="hljs-comment">// 创建stub对象。</span></li><li>    stub_ = <span class="hljs-built_in">OH_IPCRemoteStub_Create</span>(INTERFACE_DESCRIPTOR.<span class="hljs-built_in">c_str</span>(), &amp;IpcCApiStubTest::OnRemoteRequest,</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-keyword">this</span>);</li><li>}</li><li>
</li><li>IpcCApiStubTest::~<span class="hljs-built_in">IpcCApiStubTest</span>() {</li><li>    <span class="hljs-keyword">if</span> (stub_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-comment">// 当stub对象不再使用时，销毁该对象。</span></li><li>        <span class="hljs-built_in">OH_IPCRemoteStub_Destroy</span>(stub_);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">IpcCApiStubTest::MainProc</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">autoLock</span><span class="hljs-params">(childMutex_)</span></span>;</li><li>    childCondVar_.<span class="hljs-built_in">wait</span>(autoLock);</li><li>}</li><li>
</li><li><span class="hljs-function">OHIPCRemoteStub* <span class="hljs-title">IpcCApiStubTest::GetRemoteStub</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">return</span> stub_;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 服务端的请求处理函数，客户端发送的请求在该函数中处理。</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiStubTest::OnRemoteRequest</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> OHIPCParcel *data, OHIPCParcel *reply, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-type">int</span> readLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">char</span> *token = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 根据客户端传过来的interfaceToken校验当前通信是否合法。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_IPCParcel_ReadInterfaceToken</span>(data, &amp;token, &amp;readLen, LocalMemoryAllocator) != OH_IPC_SUCCESS</li><li>        || NATIVE_REMOTE_STUB_TEST_TOKEN != token) {</li><li>        <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"check InterfaceToken failed"</span>);</li><li>            <span class="hljs-built_in">free</span>(token);</li><li>        }</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_WRITE_ERROR;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(token);</li><li>    <span class="hljs-keyword">auto</span> *stubTest = <span class="hljs-built_in">reinterpret_cast</span>&lt;IpcCApiStubTest *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (stubTest == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_IPC_CHECK_PARAM_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> rqCode = <span class="hljs-built_in">RequestCode</span>(code);</li><li>    <span class="hljs-keyword">switch</span> (rqCode) {</li><li>        <span class="hljs-keyword">case</span> ASYNC_ADD_CODE: {</li><li>            <span class="hljs-keyword">return</span> stubTest-&gt;<span class="hljs-built_in">AsyncAdd</span>(data);</li><li>        }</li><li>        <span class="hljs-keyword">case</span> REQUEST_EXIT_CODE: {</li><li>            <span class="hljs-keyword">return</span> stubTest-&gt;<span class="hljs-built_in">RequestExitChildProcess</span>();</li><li>        }</li><li>        <span class="hljs-keyword">default</span>:</li><li>            <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiStubTest::AsyncAdd</span><span class="hljs-params">(<span class="hljs-type">const</span> OHIPCParcel *data)</span> </span>{</li><li>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int</span> b = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"start async add a=%d,b=%d"</span>, a, b);</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">OH_IPCParcel_ReadInt32</span>(data, &amp;a) != OH_IPC_SUCCESS)</li><li>        || (<span class="hljs-built_in">OH_IPCParcel_ReadInt32</span>(data, &amp;b) != OH_IPC_SUCCESS)) {</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_READ_ERROR;</li><li>    }</li><li>    <span class="hljs-comment">// 此处获取proxy对象，用于后续的IPC通信调用。</span></li><li>    <span class="hljs-keyword">auto</span> proxyCallBack = <span class="hljs-built_in">OH_IPCParcel_ReadRemoteProxy</span>(data);</li><li>    <span class="hljs-keyword">if</span> (proxyCallBack == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_READ_ERROR;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"start create sendCallBack thread!"</span>);</li><li>    <span class="hljs-comment">// 此处开启线程异步完成功能实现并利用proxyCallBack完成结果响应，如果同步调用，则直接通过replyData写入响应结果即可。</span></li><li>    <span class="hljs-function">std::thread <span class="hljs-title">th</span><span class="hljs-params">([proxyCallBack, a, b] {</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">auto</span> data = OH_IPCParcel_Create();</span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</span></li><li><span class="hljs-function">            <span class="hljs-comment">// 当创建parcel失败，则销毁获取到的proxyCallBack对象。</span></span></li><li><span class="hljs-function">            OH_IPCRemoteProxy_Destroy(proxyCallBack);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">return</span>;</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        <span class="hljs-keyword">auto</span> reply = OH_IPCParcel_Create();</span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (reply == <span class="hljs-literal">nullptr</span>) {</span></li><li><span class="hljs-function">            OH_IPCParcel_Destroy(data);</span></li><li><span class="hljs-function">            OH_IPCRemoteProxy_Destroy(proxyCallBack);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">return</span>;</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (OH_IPCParcel_WriteInt32(data, a + b) != OH_IPC_SUCCESS) {</span></li><li><span class="hljs-function">            OH_IPCParcel_Destroy(data);</span></li><li><span class="hljs-function">            OH_IPCParcel_Destroy(reply);</span></li><li><span class="hljs-function">            OH_IPCRemoteProxy_Destroy(proxyCallBack);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">return</span>;</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 异步线程处理结果通过IPC同步调用方式返回给业务请求方。</span></span></li><li><span class="hljs-function">        OH_IPC_MessageOption option = { OH_IPC_REQUEST_MODE_SYNC, <span class="hljs-number">0</span> };</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"thread start sendCallBack!"</span>);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// 发送IPC通信请求。</span></span></li><li><span class="hljs-function">        <span class="hljs-type">int</span> ret = OH_IPCRemoteProxy_SendRequest(proxyCallBack, ASYNC_ADD_CODE, data, reply, &amp;option);</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"thread sendCallBack ret = %d"</span>, ret);</span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (ret != OH_IPC_SUCCESS) {</span></li><li><span class="hljs-function">            OH_IPCParcel_Destroy(data);</span></li><li><span class="hljs-function">            OH_IPCParcel_Destroy(reply);</span></li><li><span class="hljs-function">            OH_IPCRemoteProxy_Destroy(proxyCallBack);</span></li><li><span class="hljs-function">            <span class="hljs-keyword">return</span>;</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        OH_IPCRemoteProxy_Destroy(proxyCallBack);</span></li><li><span class="hljs-function">        OH_IPCParcel_Destroy(data);</span></li><li><span class="hljs-function">        OH_IPCParcel_Destroy(reply);</span></li><li><span class="hljs-function">    })</span>;</li><li>    th.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiStubTest::RequestExitChildProcess</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">autoLock</span><span class="hljs-params">(childMutex_)</span></span>;</li><li>    childCondVar_.<span class="hljs-built_in">notify_all</span>();</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li></ol></pre></div></div>     <p><strong>客户端代理对象: IpcCApiProxyTest</strong></p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 用户自定义错误码。</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> OH_IPC_CREATE_OBJECT_ERROR = OH_IPC_USER_ERROR_CODE_MIN + <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">IpcCApiProxyTest</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">IpcCApiProxyTest</span><span class="hljs-params">(OHIPCRemoteProxy *proxy)</span></span>;</li><li>    ~<span class="hljs-built_in">IpcCApiProxyTest</span>();</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AsyncAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> &amp;result)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RequestExitChildProcess</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ClearResource</span><span class="hljs-params">()</span></span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SendAsyncReply</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;replyValue)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">WaitForAsyncReply</span><span class="hljs-params">(<span class="hljs-type">int</span> timeOut)</span></span>;</li><li>    <span class="hljs-comment">// 注意：OnRemoteRequest方法是Stub对象需要实现的处理IPC请求消息的回调函数，Proxy侧不需要实现该函数。</span></li><li>    <span class="hljs-comment">// 此处的OnRemoteRequest是用来给异步回调对象（下文中的replyStub_）配套使用的处理IPC请求消息的回调函数。</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">OnRemoteRequest</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> OHIPCParcel *data,</span></span></li><li><span class="hljs-function">        OHIPCParcel *reply, <span class="hljs-type">void</span> *userData)</span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnDeathRecipientCB</span><span class="hljs-params">(<span class="hljs-type">void</span> *userData)</span></span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-type">int</span> asyncReply_{};</li><li>    std::mutex mutex_;</li><li>    std::condition_variable cv_;</li><li>    OHIPCRemoteProxy *proxy_{ <span class="hljs-literal">nullptr</span> };</li><li>    OHIPCRemoteStub *replyStub_{ <span class="hljs-literal">nullptr</span> };</li><li>    OHIPCDeathRecipient *deathRecipient_{ <span class="hljs-literal">nullptr</span> };</li><li>};</li><li>
</li><li>IpcCApiProxyTest::<span class="hljs-built_in">IpcCApiProxyTest</span>(OHIPCRemoteProxy *proxy) {</li><li>    <span class="hljs-keyword">if</span> (proxy == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"proxy is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    proxy_ = proxy;</li><li>    replyStub_ = <span class="hljs-built_in">OH_IPCRemoteStub_Create</span>(NATIVE_REMOTE_STUB_ASYNC_CALL_TEST_TOKEN.<span class="hljs-built_in">c_str</span>(), OnRemoteRequest,</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-keyword">if</span> (replyStub_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"create reply stub failed!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建死亡回调对象。</span></li><li>    deathRecipient_ = <span class="hljs-built_in">OH_IPCDeathRecipient_Create</span>(OnDeathRecipientCB, <span class="hljs-literal">nullptr</span>, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-keyword">if</span> (deathRecipient_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCDeathRecipient_Create failed!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 向Proxy注册死亡回调对象，用于感知服务端Stub对象的死亡状态。</span></li><li>    <span class="hljs-built_in">OH_IPCRemoteProxy_AddDeathRecipient</span>(proxy_, deathRecipient_);</li><li>}</li><li>
</li><li>IpcCApiProxyTest::~<span class="hljs-built_in">IpcCApiProxyTest</span>() {</li><li>    <span class="hljs-keyword">if</span> (proxy_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_IPCRemoteProxy_Destroy</span>(proxy_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (deathRecipient_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_IPCDeathRecipient_Destroy</span>(deathRecipient_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (replyStub_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_IPCRemoteStub_Destroy</span>(replyStub_);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiProxyTest::AsyncAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> &amp;result)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"start %d + %d"</span>, a, b);</li><li>    <span class="hljs-keyword">auto</span> data = <span class="hljs-built_in">OH_IPCParcel_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_IPC_CREATE_OBJECT_ERROR;</li><li>    }</li><li>    <span class="hljs-comment">// 写入接口校验token。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_IPCParcel_WriteInterfaceToken</span>(data, NATIVE_REMOTE_STUB_TEST_TOKEN.<span class="hljs-built_in">c_str</span>()) != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCParcel_WriteInterfaceToken failed!"</span>);</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_WRITE_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_IPCParcel_WriteInt32</span>(data, a) != OH_IPC_SUCCESS</li><li>        || <span class="hljs-built_in">OH_IPCParcel_WriteInt32</span>(data, b) != OH_IPC_SUCCESS</li><li>        || <span class="hljs-built_in">OH_IPCParcel_WriteRemoteStub</span>(data, replyStub_) != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_WRITE_ERROR;</li><li>    }</li><li>    <span class="hljs-comment">// 异步发送使用replyStub_进行响应结果接收，异步处理需要写入用于接收结果的OHIPCRemoteStub对象。</span></li><li>    OH_IPC_MessageOption option = { OH_IPC_REQUEST_MODE_ASYNC, <span class="hljs-number">0</span> };</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_IPCRemoteProxy_SendRequest</span>(proxy_, RequestCode::ASYNC_ADD_CODE, data, <span class="hljs-literal">nullptr</span>, &amp;option);</li><li>    <span class="hljs-keyword">if</span> (ret != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCRemoteProxy_SendRequest failed!"</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> TIMEOUT = <span class="hljs-number">3</span>;</li><li>    <span class="hljs-built_in">WaitForAsyncReply</span>(TIMEOUT);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"asyncReply_:%d"</span>, asyncReply_);</li><li>    result = asyncReply_;</li><li>    <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiProxyTest::RequestExitChildProcess</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> data = <span class="hljs-built_in">OH_IPCParcel_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_IPC_CREATE_OBJECT_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> reply = <span class="hljs-built_in">OH_IPCParcel_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (reply == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_CREATE_OBJECT_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_IPCParcel_WriteInterfaceToken</span>(data, NATIVE_REMOTE_STUB_TEST_TOKEN.<span class="hljs-built_in">c_str</span>()) != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCParcel_WriteInterfaceToken failed!"</span>);</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(reply);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_WRITE_ERROR;</li><li>    }</li><li>    OH_IPC_MessageOption option = { OH_IPC_REQUEST_MODE_SYNC, <span class="hljs-number">0</span> };</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_IPCRemoteProxy_SendRequest</span>(proxy_, RequestCode::REQUEST_EXIT_CODE, data, reply, &amp;option);</li><li>    <span class="hljs-keyword">if</span> (ret != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>        <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(reply);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCRemoteProxy_SendRequest failed!"</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(data);</li><li>    <span class="hljs-built_in">OH_IPCParcel_Destroy</span>(reply);</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">IpcCApiProxyTest::SendAsyncReply</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;replyValue)</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    asyncReply_ = replyValue;</li><li>    cv_.<span class="hljs-built_in">notify_all</span>();</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiProxyTest::WaitForAsyncReply</span><span class="hljs-params">(<span class="hljs-type">int</span> timeOut)</span> </span>{</li><li>    asyncReply_ = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    cv_.<span class="hljs-built_in">wait_for</span>(lck, std::chrono::<span class="hljs-built_in">seconds</span>(timeOut), [&amp;] {</li><li>        <span class="hljs-keyword">return</span> asyncReply_ != <span class="hljs-number">0</span>;</li><li>    });</li><li>    <span class="hljs-keyword">return</span> asyncReply_;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IpcCApiProxyTest::OnRemoteRequest</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> OHIPCParcel *data,</span></span></li><li><span class="hljs-function">        OHIPCParcel *reply, <span class="hljs-type">void</span> *userData)</span> {</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"start %u"</span>, code);</li><li>    <span class="hljs-keyword">auto</span> *proxyTest = <span class="hljs-built_in">reinterpret_cast</span>&lt;IpcCApiProxyTest *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (proxyTest == <span class="hljs-literal">nullptr</span> || code != <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span>&gt;(RequestCode::ASYNC_ADD_CODE)) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"check param failed!"</span>);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_CHECK_PARAM_ERROR;</li><li>    }</li><li>    <span class="hljs-type">int32_t</span> val = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_IPCParcel_ReadInt32</span>(data, &amp;val) != OH_IPC_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_IPCParcel_ReadInt32 failed!"</span>);</li><li>        <span class="hljs-keyword">return</span> OH_IPC_PARCEL_READ_ERROR;</li><li>    }</li><li>    proxyTest-&gt;<span class="hljs-built_in">SendAsyncReply</span>(val);</li><li>    <span class="hljs-keyword">return</span> OH_IPC_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">IpcCApiProxyTest::ClearResource</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// clear resource;</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">IpcCApiProxyTest::OnDeathRecipientCB</span><span class="hljs-params">(<span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> *proxyTest = <span class="hljs-built_in">reinterpret_cast</span>&lt;IpcCApiProxyTest *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (proxyTest != <span class="hljs-literal">nullptr</span>) {</li><li>        proxyTest-&gt;<span class="hljs-built_in">ClearResource</span>();</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"the stub is dead!"</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>服务端调用入口，服务端文件"libipcCapiDemo.so"</strong></p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>IpcCApiStubTest g_ipcStubObj;</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __cplusplus</span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {</li><li>
</li><li><span class="hljs-comment">// 服务需要实现如下函数，具体可参考元能力接口说明。</span></li><li><span class="hljs-function">OHIPCRemoteStub* <span class="hljs-title">NativeChildProcess_OnConnect</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NativeChildProcess_OnConnect"</span>);</li><li>    <span class="hljs-keyword">return</span> g_ipcStubObj.<span class="hljs-built_in">GetRemoteStub</span>();</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NativeChildProcess_MainProc</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NativeChildProcess_MainProc"</span>);</li><li>    g_ipcStubObj.<span class="hljs-built_in">MainProc</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NativeChildProcess_MainProc End"</span>);</li><li>}</li><li>
</li><li>}</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li></ol></pre></div></div>     <p><strong>客户端调用入口</strong></p>     <div _ngcontent-kty-c106="" class="highlight-div"><div _ngcontent-kty-c106="" class="highlight-div-header"><div _ngcontent-kty-c106="" class="highlight-div-header-left"><div _ngcontent-kty-c106="" class="handle-button expand-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kty-c106="" class="highlight-div-header-right"><div _ngcontent-kty-c106="" class="handle-button ai-button"></div><div _ngcontent-kty-c106="" class="handle-button line-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kty-c106="" class="handle-button theme-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kty-c106="" class="handle-button copy-button"><div _ngcontent-kty-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kty-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>IpcCApiProxyTest *g_ipcProxy = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-comment">// 元能力打通IPC通道回调接口。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnNativeChildProcessStarted</span><span class="hljs-params">(<span class="hljs-type">int</span> errCode, OHIPCRemoteProxy *remoteProxy)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnNativeChildProcessStarted proxy=%{public}p err=%{public}d"</span>, remoteProxy, errCode);</li><li>    <span class="hljs-keyword">if</span> (remoteProxy == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    g_ipcProxy = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-built_in">IpcCApiProxyTest</span>(remoteProxy);</li><li>    <span class="hljs-keyword">if</span> (g_ipcProxy == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_IPCRemoteProxy_Destroy</span>(remoteProxy);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Alloc IpcCApiProxyTest object failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> </span>{</li><li>    <span class="hljs-comment">// 调用元能力接口，创建子进程，并加载参数中指定的libipcCapiDemo.so文件，进程启动结果通过回调参数OnNativeChildProcessStarted异步通知，在该回调函数中获取Proxy对象。</span></li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_Ability_CreateNativeChildProcess</span>(<span class="hljs-string">"libipcCapiDemo.so"</span>, OnNativeChildProcessStarted);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (g_ipcProxy == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-type">int</span> a = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-type">int</span> b = <span class="hljs-number">3</span>;</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;</li><li>    ret = g_ipcProxy-&gt;<span class="hljs-built_in">AsyncAdd</span>(a, b, result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"AsyncAdd: %d + %d = %d, ret=%d"</span>, a, b, result, ret);</li><li>
</li><li>    <span class="hljs-comment">// 触发Stub侧进程退出。</span></li><li>    ret = g_ipcProxy-&gt;<span class="hljs-built_in">RequestExitChildProcess</span>();</li><li>    <span class="hljs-comment">// 此时，死亡通知回调函数（IpcCApiProxyTest::OnDeathRecipientCB）会被自动执行。</span></li><li>    <span class="hljs-keyword">if</span> (g_ipcProxy != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">delete</span> g_ipcProxy;</li><li>        g_ipcProxy = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>