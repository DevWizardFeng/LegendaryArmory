<h1 _ngcontent-xsb-c119="" class="doc-title ng-star-inserted" title="InitBufPool"> InitBufPool </h1>

<div _ngcontent-xsb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section27059mcpsimp">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section27059mcpsimp" tips="复制节点链接"></i></h2><p>通过Tpipe::InitBufPool接口可划分出整块资源，整块TbufPool资源可以继续通过TBufPool::InitBufPool接口划分成小块资源。</p> </div> <div class="tiledSection"><h2 id="section27062mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section27062mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-xsb-c106="" class="highlight-div"><div _ngcontent-xsb-c106="" class="highlight-div-header"><div _ngcontent-xsb-c106="" class="highlight-div-header-left"><div _ngcontent-xsb-c106="" class="handle-button expand-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsb-c106="" class="highlight-div-header-right"><div _ngcontent-xsb-c106="" class="handle-button ai-button"></div><div _ngcontent-xsb-c106="" class="handle-button line-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsb-c106="" class="handle-button theme-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsb-c106="" class="handle-button copy-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt; </li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">InitBufPool</span><span class="hljs-params">(T&amp; bufPool, <span class="hljs-type">uint32_t</span> len)</span> </span></li><li><span class="hljs-function"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> T, <span class="hljs-keyword">class</span> U&gt; </span></li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">InitBufPool</span><span class="hljs-params">(T&amp; bufPool, <span class="hljs-type">uint32_t</span> len, U&amp; shareBuf)</span></span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section27065mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section27065mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>InitBufPool(T&amp; bufPool, uint32_t len) 原型定义参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.1" valign="top" width="12.120000000000001%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.2" valign="top" width="12.120000000000001%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.3" valign="top" width="75.76%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>bufPool</p> </td> <td class="cellrowborder" valign="top" width="12.120000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75.76%"><p>新划分的资源池，类型为TBufPool。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>len</p> </td> <td class="cellrowborder" valign="top" width="12.120000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75.76%"><p>新划分资源池长度，单位为Byte，非32Bytes对齐会自动向上补齐至32Bytes对齐。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>InitBufPool(T&amp; bufPool, uint32_t len, U&amp; shareBuf) 原型定义参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.1" valign="top" width="12.120000000000001%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.2" valign="top" width="12.120000000000001%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.3" valign="top" width="75.76%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>bufPool</p> </td> <td class="cellrowborder" valign="top" width="12.120000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75.76%"><p>新划分的资源池，类型为TBufPool。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>len</p> </td> <td class="cellrowborder" valign="top" width="12.120000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75.76%"><p>新划分资源池长度，单位为Byte，非32Bytes对齐会自动向上补齐至32Bytes对齐。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>shareBuf</p> </td> <td class="cellrowborder" valign="top" width="12.120000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75.76%"><p>被复用资源池，类型为TBufPool，新划分资源池与被复用资源池共享起始地址及长度。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section27132mcpsimp">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section27132mcpsimp" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> <div class="tiledSection"><h2 id="section27138mcpsimp">注意事项<i class="anchor-icon anchor-icon-link" anchorid="section27138mcpsimp" tips="复制节点链接"></i></h2><ul><li>新划分的资源池与被复用资源池的物理内存需要一致，两者共享起始地址及长度。</li><li>输入长度需要小于等于被复用资源池长度。</li><li>其他泛用约束参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-initbufpool">InitBufPool</a>。</li></ul> </div> <div class="tiledSection"><h2 id="section27146mcpsimp">返回值<i class="anchor-icon anchor-icon-link" anchorid="section27146mcpsimp" tips="复制节点链接"></i></h2><p>无</p> </div> <div class="tiledSection"><h2 id="section27149mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section27149mcpsimp" tips="复制节点链接"></i></h2><p>数据量较大且内存有限时，无法一次完成所有数据搬运，需要拆分成多个阶段计算，每次计算使用其中的一部分数据，可以通过TBufPool资源池进行内存地址复用。本例中，从Tpipe划分出资源池tbufPool0，tbufPool0为src0Gm分配空间后，继续分配了资源池tbufPool1，指定tbufPool1与tbufPool2复用并分别运用于第一、二轮计算，此时tbufPool1及tbufPool2共享起始地址及长度。</p> <div _ngcontent-xsb-c106="" class="highlight-div"><div _ngcontent-xsb-c106="" class="highlight-div-header"><div _ngcontent-xsb-c106="" class="highlight-div-header-left"><div _ngcontent-xsb-c106="" class="handle-button expand-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsb-c106="" class="highlight-div-header-right"><div _ngcontent-xsb-c106="" class="handle-button ai-button"></div><div _ngcontent-xsb-c106="" class="handle-button line-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsb-c106="" class="handle-button theme-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsb-c106="" class="handle-button copy-button"><div _ngcontent-xsb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResetApi</span> { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">ResetApi</span><span class="hljs-params">()</span> </span>{} </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">src0Gm</span></span></em><span class="hljs-function"><span class="hljs-params">, __gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">src1Gm</span></span></em><span class="hljs-function"><span class="hljs-params">, __gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">dstGm</span></span></em><span class="hljs-function"><span class="hljs-params">)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        src0Global.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)<em>src0Gm</em>); </li><li>        src1Global.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)<em>src1Gm</em>); </li><li>        dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)<em>dstGm</em>); </li><li>        pipe.<span class="hljs-built_in">InitBufPool</span>(tbufPool0, <span class="hljs-number">131072</span>); </li><li>        tbufPool0.<span class="hljs-built_in">InitBuffer</span>(srcQue0, <span class="hljs-number">1</span>, <span class="hljs-number">65536</span>); <span class="hljs-comment">// Total src0 </span></li><li>        tbufPool0.<span class="hljs-built_in">InitBufPool</span>(tbufPool1, <span class="hljs-number">65536</span>); </li><li>        tbufPool0.<span class="hljs-built_in">InitBufPool</span>(tbufPool2, <span class="hljs-number">65536</span>, tbufPool1); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        tbufPool1.<span class="hljs-built_in">InitBuffer</span>(srcQue1, <span class="hljs-number">1</span>, <span class="hljs-number">32768</span>); </li><li>        tbufPool1.<span class="hljs-built_in">InitBuffer</span>(dstQue0, <span class="hljs-number">1</span>, <span class="hljs-number">32768</span>); </li><li>        <span class="hljs-built_in">CopyIn</span>(); </li><li>        <span class="hljs-built_in">Compute</span>(); </li><li>        <span class="hljs-built_in">CopyOut</span>(); </li><li>        tbufPool1.<span class="hljs-built_in">Reset</span>(); </li><li>        tbufPool2.<span class="hljs-built_in">InitBuffer</span>(srcQue2, <span class="hljs-number">1</span>, <span class="hljs-number">32768</span>); </li><li>        tbufPool2.<span class="hljs-built_in">InitBuffer</span>(dstQue1, <span class="hljs-number">1</span>, <span class="hljs-number">32768</span>); </li><li>        <span class="hljs-built_in">CopyIn1</span>(); </li><li>        <span class="hljs-built_in">Compute1</span>(); </li><li>        <span class="hljs-built_in">CopyOut1</span>(); </li><li>        tbufPool2.<span class="hljs-built_in">Reset</span>(); </li><li>        tbufPool0.<span class="hljs-built_in">Reset</span>(); </li><li>        pipe.<span class="hljs-built_in">Reset</span>(); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; src0Local = srcQue0.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; src1Local = srcQue1.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(src0Local, src0Global, <span class="hljs-number">16384</span>); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(src1Local, src1Global, <span class="hljs-number">16384</span>); </li><li>        srcQue0.<span class="hljs-built_in">EnQue</span>(src0Local); </li><li>        srcQue1.<span class="hljs-built_in">EnQue</span>(src1Local); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; src0Local = srcQue0.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; src1Local = srcQue1.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; dstLocal = dstQue0.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">Add</span>(dstLocal, src0Local, src1Local, <span class="hljs-number">16384</span>); </li><li>        dstQue0.<span class="hljs-built_in">EnQue</span>&lt;half&gt;(dstLocal); </li><li>        srcQue0.<span class="hljs-built_in">FreeTensor</span>(src0Local); </li><li>        srcQue1.<span class="hljs-built_in">FreeTensor</span>(src1Local); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; dstLocal = dstQue0.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(dstGlobal, dstLocal, <span class="hljs-number">16384</span>); </li><li>        dstQue0.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn1</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; src0Local = srcQue0.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; src1Local = srcQue2.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(src0Local, src0Global[<span class="hljs-number">16384</span>], <span class="hljs-number">16384</span>); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(src1Local, src1Global[<span class="hljs-number">16384</span>], <span class="hljs-number">16384</span>); </li><li>        srcQue0.<span class="hljs-built_in">EnQue</span>(src0Local); </li><li>        srcQue2.<span class="hljs-built_in">EnQue</span>(src1Local); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute1</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; src0Local = srcQue0.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; src1Local = srcQue2.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;half&gt; dstLocal = dstQue1.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">Add</span>(dstLocal, src0Local, src1Local, <span class="hljs-number">16384</span>); </li><li>        dstQue1.<span class="hljs-built_in">EnQue</span>&lt;half&gt;(dstLocal); </li><li>        srcQue0.<span class="hljs-built_in">FreeTensor</span>(src0Local); </li><li>        srcQue2.<span class="hljs-built_in">FreeTensor</span>(src1Local); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut1</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; dstLocal = dstQue1.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(dstGlobal[<span class="hljs-number">16384</span>], dstLocal, <span class="hljs-number">16384</span>); </li><li>        dstQue1.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    AscendC::TPipe pipe; </li><li>    AscendC::TBufPool&lt;AscendC::TPosition::VECCALC&gt; tbufPool0, tbufPool1, tbufPool2; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; srcQue0, srcQue1, srcQue2; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; dstQue0, dstQue1; </li><li>    AscendC::GlobalTensor&lt;half&gt; src0Global, src1Global, dstGlobal; </li><li>}; </li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">tbufpool_kernel</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">src0Gm</span></span></em><span class="hljs-function"><span class="hljs-params">, __gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">src1Gm</span></span></em><span class="hljs-function"><span class="hljs-params">, __gm__ <span class="hljs-type">uint8_t</span>* </span></span><em><span class="hljs-function"><span class="hljs-params">dstGm</span></span></em><span class="hljs-function"><span class="hljs-params">)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    ResetApi op; </li><li>    op.<span class="hljs-built_in">Init</span>(<em>src0Gm</em>, <em>src1Gm</em>, <em>dstGm</em>); </li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>