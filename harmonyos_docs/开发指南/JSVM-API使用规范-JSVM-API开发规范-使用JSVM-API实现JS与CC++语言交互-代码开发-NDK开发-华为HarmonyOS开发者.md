<h1 _ngcontent-bgi-c119="" class="doc-title ng-star-inserted" title="JSVM-API使用规范"> JSVM-API使用规范 </h1>

<div _ngcontent-bgi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="生命周期管理">生命周期管理<i class="anchor-icon anchor-icon-link" anchorid="生命周期管理" tips="复制节点链接"></i></h2><p><strong>【规则】</strong> 合理使用OH_JSVM_OpenHandleScope和OH_JSVM_CloseHandleScope管理JSVM_Value的生命周期，做到生命周期最小化，避免发生内存泄漏问题。</p> <p>每个JSVM_Value属于特定的HandleScope，HandleScope通过OH_JSVM_OpenHandleScope和OH_JSVM_CloseHandleScope来建立和关闭，HandleScope关闭后，所属的JSVM_Value就会自动释放。</p> <p><strong>注意事项</strong>：</p> <ol><li>JSVM_Value必须在HandleScope打开后才可创建(Node-API无该限制)，否则会造成应用崩溃；</li><li>JSVM_Value不能在其对应的HandleScope关闭后使用，如需持久化持有，需调用OH_JSVM_CreateReference转化为JSVM_Ref；</li><li>Scope(包括JSVM_VMScope、JSVM_EnvScope、JSVM_HandleScope)需逆序关闭，最先打开的Scope需最后关闭，否则可能造成应用崩溃；</li></ol> <p><strong>Scope关闭错误示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 未逆序关闭JSVM_VMScope，可能造成应用崩溃</span></li><li>JSVM_VM vm;</li><li>JSVM_CreateVMOptions options;</li><li><span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm);</li><li>
</li><li>JSVM_VMScope vmScope1, vmScope2;</li><li><span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope1);</li><li><span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope2);</li><li>
</li><li><span class="hljs-comment">// 正确顺序为先关闭vmScope2，再关闭vmScope1</span></li><li><span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope1);</li><li><span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope2);</li><li><span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li></ol></pre></div></div> <p><strong>C++使用封装</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">HandleScopeWrapper</span> {</li><li> <span class="hljs-keyword">public</span>:</li><li>  <span class="hljs-built_in">HandleScopeWrapper</span>(JSVM_Env env) : <span class="hljs-built_in">env</span>(env) {</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>  }</li><li>
</li><li>  ~<span class="hljs-built_in">HandleScopeWrapper</span>() {</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>  }</li><li>
</li><li>  <span class="hljs-built_in">HandleScopeWrapper</span>(<span class="hljs-type">const</span> HandleScopeWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  HandleScopeWrapper&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> HandleScopeWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-built_in">HandleScopeWrapper</span>(HandleScopeWrapper&amp;&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span>)</span> </span>= <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span>) = <span class="hljs-keyword">delete</span>;</li><li>
</li><li> <span class="hljs-keyword">protected</span>:</li><li>  JSVM_Env env;</li><li>  JSVM_HandleScope handleScope;</li><li>};</li></ol></pre></div></div> <p><strong>示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在for循环中频繁调用JSVM接口创建js对象时，要加handle_scope及时释放不再使用的资源。</span></li><li><span class="hljs-comment">// 下面例子中，每次循环结束局部变量res的生命周期已结束，因此加scope及时释放其持有的js对象，防止内存泄漏</span></li><li><span class="hljs-comment">// 每次for循环结束后，触发HandleScopeWrapper的析构函数，释放scope持有的js对象</span></li><li>for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++)</li><li>{</li><li>    HandleScopeWrapper <span class="hljs-built_in">scope</span>(env);</li><li>    JSVM_Value res;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;res);</li><li>    if (i == <span class="hljs-number">1000</span>) {</li><li>        <span class="hljs-comment">// break退出循环后会自动调用HandleScopeWrapper析构函数释放资源</span></li><li>        break;</li><li>    }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="多引擎实例上下文敏感">多引擎实例上下文敏感<i class="anchor-icon anchor-icon-link" anchorid="多引擎实例上下文敏感" tips="复制节点链接"></i></h2><p><strong>【规则】</strong> 多引擎实例（VM）场景下，禁止通过JSVM-API跨引擎实例访问JS对象。</p> <p>引擎实例是一个独立运行环境，JS对象创建访问等操作必须在同一个引擎实例中进行。若在不同引擎实例中操作同一个对象，可能会引发程序崩溃。引擎实例在接口中体现为JSVM_Env。</p> <p><strong>错误示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>// 线程<span class="hljs-number">1</span>执行，在env1创建<span class="hljs-built_in">string</span>对象，值为<span class="hljs-string">"value1"</span></li><li>OH_JSVM_CreateStringUtf8(env1, <span class="hljs-string">"value1"</span>, JSVM_AUTO_LENGTH , &amp;<span class="hljs-built_in">string</span>);</li><li>// 线程<span class="hljs-number">2</span>执行，在env2创建object对象，并将上述的<span class="hljs-built_in">string</span>对象设置到object对象中</li><li>JSVM_Status <span class="hljs-built_in">status</span> = OH_JSVM_CreateObject(env2, &amp;object);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">status</span> != JSVM_OK)</li><li>{</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-built_in">status</span> = OH_JSVM_SetNamedProperty(env2, object, <span class="hljs-string">"string1"</span>, <span class="hljs-built_in">string</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">status</span> != JSVM_OK)</li><li>{</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> <p>所有的JS对象都隶属于具体的某一JSVM_Env，不可将env1的对象，设置到env2中的对象中。在env2中一旦访问到env1的对象，程序可能会发生崩溃。</p> </div>  <div class="tiledSection"><h2 id="多线程共享引擎实例">多线程共享引擎实例<i class="anchor-icon anchor-icon-link" anchorid="多线程共享引擎实例" tips="复制节点链接"></i></h2><p><strong>【规则】</strong> 多线程同时使用同一个引擎实例的场景下，需要加锁使用。保证一个引擎实例在同一时刻只能在一个线程执行。多线程同一时刻同时使用引擎实例可能造成应用崩溃。</p> <p><strong>注意事项</strong>：</p> <ol><li>OH_JSVM_IsLocked的结果为<strong>当前线程</strong>是否持有引擎实例的锁，无需设置循环等待其他线程释放锁；</li><li>OH_JSVM_AcquireLock在同一线程中嵌套使用不会造成死锁；</li><li>使用OH_JSVM_ReleaseLock时需判断是否在最外层，避免同一线程中嵌套使用OH_JSVM_AcquireLock的场景下内层释放了整个线程的锁；</li><li>OH_JSVM_AcquireLock后需调用OH_JSVM_OpenHandleScope让引擎实例进入线程；OH_JSVM_ReleaseLock前需调用OH_JSVM_CloseHandleScope让引擎实例退出线程；</li><li>不同线程禁止嵌套使用引擎实例，如需临时切换线程使用引擎实例，请确保JSVM_Value已保存为JSVM_Ref，释放锁后对JSVM_Value将不可访问；</li><li>需注意资源获取的顺序为：锁 -&gt; VMScope -&gt; EnvScope -&gt; HandleScope，资源释放的顺序正好相反，错误的顺序可能导致程序崩溃。</li></ol> <p><strong>C++使用封装</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">LockWrapper</span> {</li><li> <span class="hljs-keyword">public</span>:</li><li>  <span class="hljs-comment">// 构造函数，获取锁、VMScope、EnvScope</span></li><li>  <span class="hljs-built_in">LockWrapper</span>(JSVM_Env env) : <span class="hljs-built_in">env</span>(env) {</li><li>    <span class="hljs-built_in">OH_JSVM_IsLocked</span>(env, &amp;isLocked);</li><li>    <span class="hljs-keyword">if</span> (!isLocked) {</li><li>      <span class="hljs-built_in">OH_JSVM_AcquireLock</span>(env);</li><li>      <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>      <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>      <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 析构函数，释放EnvScope、VMScope、锁</span></li><li>  ~<span class="hljs-built_in">LockWrapper</span>() {</li><li>    <span class="hljs-keyword">if</span> (!isLocked) {</li><li>      <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>      <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>      <span class="hljs-built_in">OH_JSVM_ReleaseLock</span>(env);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-built_in">LockWrapper</span>(<span class="hljs-type">const</span> LockWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  LockWrapper&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> LockWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-built_in">LockWrapper</span>(LockWrapper&amp;&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span>)</span> </span>= <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span>) = <span class="hljs-keyword">delete</span>;</li><li>
</li><li> <span class="hljs-keyword">private</span>:</li><li>  JSVM_Env env;</li><li>  JSVM_EnvScope envScope;</li><li>  JSVM_VMScope vmScope;</li><li>  JSVM_VM vm;</li><li>  <span class="hljs-type">bool</span> isLocked;</li><li>};</li></ol></pre></div></div> <p><strong>正确示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 该用例演示了多线程中使用vm</span></li><li><span class="hljs-comment">// t1线程先获取锁，并继续JSVM-API的调用</span></li><li><span class="hljs-comment">// t2线程会在获取锁处阻塞，直到t1线程执行结束释放锁后，t2线程继续执行，调用JSVM-API接口</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">Add</span>([[<span class="hljs-variable">maybe_unused</span>]] <span class="hljs-variable">napi_env</span> <span class="hljs-variable">_env</span>, [[<span class="hljs-variable">maybe_unused</span>]] <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">_info</span>) {</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_VM</span> <span class="hljs-variable">vm</span>;</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>;</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">int</span> <span class="hljs-variable">aa</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">aa</span> == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">OH_JSVM_Init</span>(<span class="hljs-variable">nullptr</span>);</li><li>        <span class="hljs-variable">aa</span>++;</li><li>        <span class="hljs-comment">// create vm</span></li><li>        <span class="hljs-variable">JSVM_CreateVMOptions</span> <span class="hljs-variable">options</span>;</li><li>        <span class="hljs-title function_">memset</span>(&amp;<span class="hljs-title class_">options</span>, <span class="hljs-number">0</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">options</span>));</li><li>        <span class="hljs-title function_">OH_JSVM_CreateVM</span>(&amp;<span class="hljs-title class_">options</span>, &amp;<span class="hljs-title class_">vm</span>);</li><li>        <span class="hljs-comment">// create env</span></li><li>        <span class="hljs-title function_">OH_JSVM_CreateEnv</span>(<span class="hljs-variable">vm</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">env</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">t1</span>([]() {</li><li>        <span class="hljs-variable">LockWrapper</span> <span class="hljs-title function_">lock</span>(<span class="hljs-variable">env</span>);</li><li>        <span class="hljs-variable">JSVM_HandleScope</span> <span class="hljs-variable">handleScope</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_OpenHandleScope</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">handleScope</span>);</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">value</span>;</li><li>        <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">rst</span> = <span class="hljs-title function_">OH_JSVM_CreateInt32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">32</span>, &amp;<span class="hljs-title class_">value</span>); <span class="hljs-comment">// 32: numerical value</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">rst</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t1 OH_JSVM_CreateInt32 suc"</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t1 OH_JSVM_CreateInt32 fail"</span>);</li><li>        }</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">num1</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetValueInt32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, &amp;<span class="hljs-title class_">num1</span>);</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t1 num1 = %{public}d"</span>, <span class="hljs-variable">num1</span>);</li><li>        <span class="hljs-title function_">OH_JSVM_CloseHandleScope</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">handleScope</span>);</li><li>    });</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">t2</span>([]() {</li><li>        <span class="hljs-variable">LockWrapper</span> <span class="hljs-title function_">lock</span>(<span class="hljs-variable">env</span>);</li><li>        <span class="hljs-variable">JSVM_HandleScope</span> <span class="hljs-variable">handleScope</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_OpenHandleScope</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">handleScope</span>);</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">value</span>;</li><li>        <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">rst</span> = <span class="hljs-title function_">OH_JSVM_CreateInt32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">32</span>, &amp;<span class="hljs-title class_">value</span>); <span class="hljs-comment">// 32: numerical value</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">rst</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t2 OH_JSVM_CreateInt32 suc"</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t2 OH_JSVM_CreateInt32 fail"</span>);</li><li>        }</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">num1</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetValueInt32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, &amp;<span class="hljs-title class_">num1</span>);</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"JSVM:t2 num1 = %{public}d"</span>, <span class="hljs-variable">num1</span>);</li><li>        <span class="hljs-title function_">OH_JSVM_CloseHandleScope</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">handleScope</span>);</li><li>    });</li><li>    <span class="hljs-variable">t1</span>.<span class="hljs-title function_">detach</span>();</li><li>    <span class="hljs-variable">t2</span>.<span class="hljs-title function_">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="获取js传入参数及其数量">获取JS传入参数及其数量<i class="anchor-icon anchor-icon-link" anchorid="获取js传入参数及其数量" tips="复制节点链接"></i></h2><p><strong>【规则】</strong> 当传入OH_JSVM_GetCbInfo的argv不为nullptr时，argv的长度必须大于等于传入argc声明的大小。</p> <p>当argv不为nullptr时，OH_JSVM_GetCbInfo会根据argc声明的数量将JS实际传入的参数写入argv。如果argc小于等于实际JS传入参数的数量，该接口仅会将声明的argc数量的参数写入argv；而当argc大于实际参数数量时，该接口会在argv的尾部填充undefined。</p> <p><strong>错误示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IncorrectDemo1</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// argc 未正确的初始化，其值为不确定的随机值，导致 argv 的长度可能小于 argc 声明的数量，数据越界。</span></li><li>    <span class="hljs-type">size_t</span> argc;</li><li>    JSVM_Value argv[<span class="hljs-number">10</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IncorrectDemo2</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// argc 声明的数量大于 argv 实际初始化的长度，导致 OH_JSVM_GetCbInfo 接口在写入 argv 时数据越界。</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">5</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>正确示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetArgvDemo1</span><span class="hljs-params">(napi_env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// argv 传入 nullptr 来获取传入参数真实数量</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// JS 传入参数为0，不执行后续逻辑</span></li><li>    <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建数组用以获取JS传入的参数</span></li><li>    JSVM_Value* argv = <span class="hljs-keyword">new</span> JSVM_Value[argc];</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 业务代码</span></li><li>    <span class="hljs-comment">// ... ...</span></li><li>    <span class="hljs-comment">// argv 为 new 创建的对象，在使用完成后手动释放</span></li><li>    <span class="hljs-keyword">delete</span>[] argv;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetArgvDemo2</span><span class="hljs-params">(napi_env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value* argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// OH_JSVM_GetCbInfo 会向 argv 中写入 argc 个 JS 传入参数或 undefined</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 业务代码</span></li><li>    <span class="hljs-comment">// ... ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="异常处理">异常处理<i class="anchor-icon anchor-icon-link" anchorid="异常处理" tips="复制节点链接"></i></h2><p><strong>【建议】</strong> JSVM-API接口调用发生异常需要及时处理，不能遗漏异常到后续逻辑，否则程序可能发生不可预期行为。</p> <p> 根据主从类型，异常处理可以分为两类：</p> <ol><li><p>JSVM 执行 C++ 回调函数（JS主，Native从）时发生 C++ 异常，需往 JSVM 中抛出异常，下面用例描述了3种情况下 C++ 回调函数的写法。需要注意的是，回调函数中调用JSVM-API失败，如要向JSVM中抛异常，需保证JSVM中无等待处理的异常，也可以不抛出异常，JS的try-catch块可以捕获回调函数调用API失败产生的JS异常，见NativeFunctionExceptionDemo3。</p>  <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// JSVM主， Native从</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">throw</span>(<span class="hljs-string">"Do something failed"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Demo1: C++捕获到异常，抛出异常到JSVM中</span></li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">NativeFunctionExceptionDemo1</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-built_in">DoSomething</span>();</li><li>    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *ex) {</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, ex);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Demo2: JSVM-API调用失败，抛出异常到JSVM中</span></li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">NativeFunctionExceptionDemo2</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_Value JSBool = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">bool</span> value = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">auto</span> status = <span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, JSBool, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Get bool value failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Demo3：JSVM-API调用失败且在调用过程中已向JSVM中添加等待处理的异常，则无需再向JSVM中抛出异常</span></li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">NativeFunctionExceptionDemo3</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    std::string sourcecodestr = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">        throw Error('Error throw from js');</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>    JSVM_Value sourcecodevalue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, sourcecodestr.<span class="hljs-built_in">c_str</span>(), sourcecodestr.<span class="hljs-built_in">size</span>(), &amp;sourcecodevalue));</li><li>    JSVM_Script script;</li><li>    <span class="hljs-keyword">auto</span> status = <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, sourcecodevalue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"compile script failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 执行JS脚本，执行过程中抛出JS异常</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-type">bool</span> isPending = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-comment">// 如果已有异常，则无需再向JSVM中抛出异常；</span></li><li>        <span class="hljs-comment">// 如需处理并抛出新异常，需先处理JSVM中等待的异常</span></li><li>        <span class="hljs-keyword">if</span> (JSVM_OK == <span class="hljs-built_in">OH_JSVM_IsExceptionPending</span>((env), &amp;isPending) &amp;&amp; isPending) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Runscript failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 绑定NativeFunction到JSVM中，省略</span></li><li>std::string sourcecodestr = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    // consolelog需用户实现</span></li><li><span class="hljs-string">    try {</span></li><li><span class="hljs-string">        // 调用Native函数</span></li><li><span class="hljs-string">        NativeFunction()</span></li><li><span class="hljs-string">    } catch (e) {</span></li><li><span class="hljs-string">        // 处理Native中产生的异常</span></li><li><span class="hljs-string">        consolelog(e.message)</span></li><li><span class="hljs-string">    }</span></li><li><span class="hljs-string">)JS"</span>;</li><li>JSVM_Value sourcecodevalue = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, sourcecodestr.<span class="hljs-built_in">c_str</span>(), sourcecodestr.<span class="hljs-built_in">size</span>(), &amp;sourcecodevalue));</li><li>JSVM_Script script;</li><li><span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, sourcecodevalue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>JSVM_Value result;</li><li><span class="hljs-comment">// 执行JS脚本，JS调用Native方法</span></li><li><span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li></ol></pre></div></div>  </li><li><p>C++调用JSVM-API（Native主，JS从）失败，需清理JSVM中等待处理的异常，避免影响后续JSVM-API的执行，并设置C++异常处理分支（或抛出C++异常）。</p>  <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>std::string sourcecodestr = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    throw Error('Error throw from js');</span></li><li><span class="hljs-string">)JS"</span>;</li><li>JSVM_Value sourcecodevalue = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, sourcecodestr.<span class="hljs-built_in">c_str</span>(), sourcecodestr.<span class="hljs-built_in">size</span>(), &amp;sourcecodevalue);</li><li>JSVM_Script script;</li><li><span class="hljs-keyword">auto</span> status = <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, sourcecodevalue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li><span class="hljs-comment">// 异常处理分支</span></li><li><span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>    JSVM_Value error = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 获取并清理异常</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetAndClearLastException</span>((env), &amp;error));</li><li>    <span class="hljs-comment">// 处理异常，如打印信息，省略</span></li><li>    <span class="hljs-comment">// 抛出 C++ 异常或结束函数执行</span></li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-string">"JS Compile Error"</span>;</li><li>}</li><li>JSVM_Value result;</li><li><span class="hljs-comment">// 执行JS脚本，执行过程中抛出JS异常</span></li><li>status = <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li><span class="hljs-comment">// 异常分支处理</span></li><li><span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>    JSVM_Value error = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 获取并清理异常</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetAndClearLastException</span>((env), &amp;error));</li><li>    <span class="hljs-comment">// 处理异常，如打印信息，省略</span></li><li>    <span class="hljs-comment">// 抛出 C++ 异常或结束函数执行</span></li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-string">"JS RunScript Error"</span>;</li><li>}</li></ol></pre></div></div>  </li></ol> </div>  <div class="tiledSection"><h2 id="上下文绑定对象">上下文绑定对象<i class="anchor-icon anchor-icon-link" anchorid="上下文绑定对象" tips="复制节点链接"></i></h2><p><strong>【规则】</strong>：调用JSVM-API生成的JS函数、对象需绑定到上下文中才能从JS侧访问，OH_JSVM_CreateFunction接口中的const char *参数为创建函数的属性name，不代表上下文中指向该函数的名称。调用JSVM-API生成的类、对象同理。</p> <p><strong>示例</strong>：</p> <div _ngcontent-bgi-c106="" class="highlight-div"><div _ngcontent-bgi-c106="" class="highlight-div-header"><div _ngcontent-bgi-c106="" class="highlight-div-header-left"><div _ngcontent-bgi-c106="" class="handle-button expand-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bgi-c106="" class="highlight-div-header-right"><div _ngcontent-bgi-c106="" class="handle-button ai-button"></div><div _ngcontent-bgi-c106="" class="handle-button line-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bgi-c106="" class="handle-button theme-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bgi-c106="" class="handle-button copy-button"><div _ngcontent-bgi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bgi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">JSFunc</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">name</span> = <span class="hljs-string">"NativeFunction"</span>;</li><li><span class="hljs-variable">JSVM_CallbackStruct</span> <span class="hljs-variable">cb</span> = {<span class="hljs-variable">NativeFunction</span>, <span class="hljs-variable">nullptr</span>};</li><li><span class="hljs-comment">// 创建JS函数，该函数的属性 "name" 为 "NativeFunction"</span></li><li><span class="hljs-title function_">OH_JSVM_CreateFunction</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">name</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">name</span>), &amp;<span class="hljs-title class_">cb</span>, &amp;<span class="hljs-title class_">JSFunc</span>);</li><li><span class="hljs-comment">// 绑定函数到上下文</span></li><li><span class="hljs-comment">// 获取上下文的global对象</span></li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">global</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-title function_">OH_JSVM_GetGlobal</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">global</span>);</li><li><span class="hljs-comment">// 创建JS字符串"FunctionNameInJSContext"</span></li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">key</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateStringLatin1</span>(<span class="hljs-variable">env</span>, <span class="hljs-string">"FunctionNameInJSContext"</span>, <span class="hljs-variable">JSVM_AUTO_LENGTH</span>, &amp;<span class="hljs-title class_">key</span>);</li><li><span class="hljs-comment">// 设置global的属性"FunctionNameInJSContext"为JSFunc，将函数绑定到上下文中</span></li><li><span class="hljs-title function_">OH_JSVM_SetProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">global</span>, <span class="hljs-variable">key</span>, <span class="hljs-variable">JSFunc</span>);</li><li><span class="hljs-comment">// 在JS中调用函数</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">sourcecodestr</span> = <span class="hljs-variable">R</span><span class="hljs-string">"JS(</span></li><li><span class="hljs-string">    // consolelog需用户实现</span></li><li><span class="hljs-string">    FunctionNameInJSContext() // 调用成功</span></li><li><span class="hljs-string">    consolelog(FunctionNameInJSContext.name) // 打印 "</span><span class="hljs-variable">NativeFunction</span><span class="hljs-string">"</span></li><li><span class="hljs-string">    try {</span></li><li><span class="hljs-string">        NativeFunction() // 无法找到该函数，抛出异常</span></li><li><span class="hljs-string">    } catch (e) {</span></li><li><span class="hljs-string">        consolelog(e.message)</span></li><li><span class="hljs-string">    }</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> </div> </div> <div></div></div>