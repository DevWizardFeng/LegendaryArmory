<h1 _ngcontent-xna-c119="" class="doc-title ng-star-inserted" title="JSVM-API 内存泄漏问题定位指导"> JSVM-API 内存泄漏问题定位指导 </h1>

<div _ngcontent-xna-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>JSVM的内存占用包括Native内存占用(C/C++侧的内存占用)和底层的JS引擎的堆内存占用，JS引擎会维护一个堆来管理其生成的JS对象，其生命周期由JS引擎维护，除此之外的内存我们归为Native内存。用户在使用JSVM时，可能碰到这两种内存异常增长的情况。</p> <p>本文先介绍如何定性分析，然后分两个部分介绍如何定位Native内存泄漏和JS引擎堆内存泄漏。</p>  <div class="tiledSection"><h2 id="定性分析">定性分析<i class="anchor-icon anchor-icon-link" anchorid="定性分析" tips="复制节点链接"></i></h2><p>可以通过hdc连接设备，执行如下命令行的方式对目标应用的内存进行采样，比较一段时间内的内存变化情况，从而定性分析是Native内存泄漏还是JS内存。下图中Pss Total列，native heap对应Native内存占用，AnnonPage other对应js堆内存占用。</p> <div _ngcontent-xna-c106="" class="highlight-div"><div _ngcontent-xna-c106="" class="highlight-div-header"><div _ngcontent-xna-c106="" class="highlight-div-header-left"><div _ngcontent-xna-c106="" class="handle-button expand-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xna-c106="" class="highlight-div-header-right"><div _ngcontent-xna-c106="" class="handle-button ai-button"></div><div _ngcontent-xna-c106="" class="handle-button line-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xna-c106="" class="handle-button theme-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xna-c106="" class="handle-button copy-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xna-c106="" class="highlight-scroll-div"><pre class="hdc prettyprint linenums hljs language-scss" hw-language="hdc" data-highlighted="yes"><ol class="linenums"><li>hidumper <span class="hljs-attr">--mem</span> $(pidof dest_app)</li></ol></pre></div></div> <span><img originheight="991" originwidth="2321" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114339.96920535499129037816651801889236:50001231000000:2800:9900B8F01D1FF19B9B8FBC643391CF34B312FF1D754E6C67AFB12B88CDD9136C.png" width="920" height="392.813442481689"></span></div>  <div class="tiledSection"><h2 id="native内存泄漏定位">Native内存泄漏定位<i class="anchor-icon anchor-icon-link" anchorid="native内存泄漏定位" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="典型场景" class="firsth2">典型场景<i class="anchor-icon anchor-icon-link" anchorid="典型场景" tips="复制节点链接"></i></h3><ol><li>OH_JSVM_CreateReference 和 OH_JSVM_DeleteReference 接口没有成对调用，导致Reference没有被释放。</li></ol> <div _ngcontent-xna-c106="" class="highlight-div"><div _ngcontent-xna-c106="" class="highlight-div-header"><div _ngcontent-xna-c106="" class="highlight-div-header-left"><div _ngcontent-xna-c106="" class="handle-button expand-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xna-c106="" class="highlight-div-header-right"><div _ngcontent-xna-c106="" class="handle-button ai-button"></div><div _ngcontent-xna-c106="" class="handle-button line-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xna-c106="" class="handle-button theme-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xna-c106="" class="handle-button copy-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xna-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">obj</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateObject</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">obj</span>);</li><li><span class="hljs-comment">// 创建引用</span></li><li><span class="hljs-variable">JSVM_Ref</span> <span class="hljs-variable">reference</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateReference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">obj</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">reference</span>);</li><li>
</li><li><span class="hljs-comment">// 使用引用</span></li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">result</span>;</li><li><span class="hljs-title function_">OH_JSVM_GetReferenceValue</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">reference</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>
</li><li><span class="hljs-comment">// 未释放引用</span></li><li><span class="hljs-comment">// OH_JSVM_DeleteReference(env, reference);</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="定位步骤">定位步骤<i class="anchor-icon anchor-icon-link" anchorid="定位步骤" tips="复制节点链接"></i></h3><p>为了分析Native内存泄漏，可以借助DevEco Studio的内存分析模块，具体参考文档：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations-memory" target="_blank">内存分析及优化</a>。</p> <ol><li><p>使用Profiler的Allocation模块记录一段时间内的Native内存信息。</p>  <span><img originheight="1106" originwidth="2253" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114339.54597112843159867239015246073297:50001231000000:2800:21FC56135052960E677E5BAFD3DD89619FE149E8DACD3EAE56F89DD0E746376C.png" width="920" height="451.62893919218817"></span> </li><li><p>比较这段时间内"Created &amp; Existing"的内存变化情况，如果存在占比较大且Count较大的未释放内存，则怀疑存在内存泄漏，展开进一步查看调用栈。</p>  <span><img originheight="867" originwidth="3292" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114339.37829366675815342280553663641111:50001231000000:2800:CEF6FD3B1C439D57D7BC0EE3D6300FF37855AA595A53044B5C0B4087B42C4469.png" width="920" height="242.29647630619684"></span></li></ol> </div>  <div class="tiledSection"><h2 id="js引擎堆内存泄漏定位">JS引擎堆内存泄漏定位<i class="anchor-icon anchor-icon-link" anchorid="js引擎堆内存泄漏定位" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="典型场景-1" class="firsth2">典型场景<i class="anchor-icon anchor-icon-link" anchorid="典型场景-1" tips="复制节点链接"></i></h3><ol><li>全局变量滥用，导致dom元素未释放。</li></ol> <div _ngcontent-xna-c106="" class="highlight-div"><div _ngcontent-xna-c106="" class="highlight-div-header"><div _ngcontent-xna-c106="" class="highlight-div-header-left"><div _ngcontent-xna-c106="" class="handle-button expand-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xna-c106="" class="highlight-div-header-right"><div _ngcontent-xna-c106="" class="handle-button ai-button"></div><div _ngcontent-xna-c106="" class="handle-button line-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xna-c106="" class="handle-button theme-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xna-c106="" class="handle-button copy-button"><div _ngcontent-xna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xna-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> elements = [];</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createElements</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {</li><li>    <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);</li><li>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(el);</li><li>    elements.<span class="hljs-title function_">push</span>(el); <span class="hljs-comment">// 即使从 DOM 移除，数组仍保留引用</span></li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="定位步骤-1">定位步骤<i class="anchor-icon anchor-icon-link" anchorid="定位步骤-1" tips="复制节点链接"></i></h3><p>JSVM目前提供了OH_JSVM_OpenInspector开启inspector，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-debugger-cpuprofiler-heapsnapshot#使用-oh_jsvm_openinspector" target="_blank">使用OH_JSVM_OpenInspector</a>,在此基础上可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-debugger-cpuprofiler-heapsnapshot#使用-chrome-inspect-页面进行调试" target="_blank">使用 Chrome inspect 页面进行调试</a>。</p> <p>通过使用DevTools工具，对目标场景内的堆内存进行快照（快照前先点击上方的垃圾回收按钮进行垃圾回收），利用快照对比功能，找到未释放的JS对象和其所在源码中的位置，进一步指导定位堆内存未释放的原因。</p> <span><img originheight="923" originwidth="2118" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114339.73907022633797046731601571846035:50001231000000:2800:2999B81FB4A6802BA936A299985E74A3842A362FAF48B76D7119049CDC289DF4.png" width="920" height="400.9254013220019"></span></div> </div> <div></div></div>