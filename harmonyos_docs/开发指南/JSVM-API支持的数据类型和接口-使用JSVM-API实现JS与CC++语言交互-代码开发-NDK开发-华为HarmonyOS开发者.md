<h1 _ngcontent-ksu-c119="" class="doc-title ng-star-inserted" title="JSVM-API 支持的数据类型和接口"> JSVM-API 支持的数据类型和接口 </h1>

<div _ngcontent-ksu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="jsvm-api-的数据类型">JSVM-API 的数据类型<i class="anchor-icon anchor-icon-link" anchorid="jsvm-api-的数据类型" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="jsvm_status" class="firsth2">JSVM_Status<i class="anchor-icon anchor-icon-link" anchorid="jsvm_status" tips="复制节点链接"></i></h3><p>这是一个枚举数据类型，用来表示JSVM-API接口返回的状态信息。</p> <p>每调用一次JSVM-API函数，都会返回一个值，用来表示操作成功与否的相关信息。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> {</li><li>        JSVM_OK,                              <span class="hljs-comment">/* 成功状态 */</span></li><li>        JSVM_INVALID_ARG,                     <span class="hljs-comment">/* 无效的状态 */</span></li><li>        JSVM_OBJECT_EXPECTED,                 <span class="hljs-comment">/* 期待传入对象类型 */</span></li><li>        JSVM_STRING_EXPECTED,                 <span class="hljs-comment">/* 期待传入字符串类型 */</span></li><li>        JSVM_NAME_EXPECTED,                   <span class="hljs-comment">/* 期待传入名字 */</span></li><li>        JSVM_FUNCTION_EXPECTED,               <span class="hljs-comment">/* 期待传入函数类型 */</span></li><li>        JSVM_NUMBER_EXPECTED,                 <span class="hljs-comment">/* 期待传入数字类型 */</span></li><li>        JSVM_BOOL_EXPECTED,                   <span class="hljs-comment">/* 期待传入布尔类型 */</span></li><li>        JSVM_ARRAY_EXPECTED,                  <span class="hljs-comment">/* 期待传入数组类型 */</span></li><li>        JSVM_GENERIC_FAILURE,                 <span class="hljs-comment">/* 泛型失败状态 */</span></li><li>        JSVM_PENDING_EXCEPTION,               <span class="hljs-comment">/* 挂起异常状态 */</span></li><li>        JSVM_CANCELLED,                       <span class="hljs-comment">/* 取消状态 */</span></li><li>        JSVM_ESCAPE_CALLED_TWICE,             <span class="hljs-comment">/* 转义调用了2次 */</span></li><li>        JSVM_HANDLE_SCOPE_MISMATCH,           <span class="hljs-comment">/* 句柄作用域不匹配 */</span></li><li>        JSVM_CALLBACK_SCOPE_MISMATCH,         <span class="hljs-comment">/* 回调作用域不匹配 */</span></li><li>        JSVM_QUEUE_FULL,                      <span class="hljs-comment">/* 队列满 */</span></li><li>        JSVM_CLOSING,                         <span class="hljs-comment">/* 关闭中 */</span></li><li>        JSVM_BIGINT_EXPECTED,                 <span class="hljs-comment">/* 期望传入Bigint类型 */</span></li><li>        JSVM_DATE_EXPECTED,                   <span class="hljs-comment">/* 期望传入日期类型 */</span></li><li>        JSVM_ARRAYBUFFER_EXPECTED,            <span class="hljs-comment">/* 期望传入ArrayBuffer类型 */</span></li><li>        JSVM_DETACHABLE_ARRAYBUFFER_EXPECTED, <span class="hljs-comment">/* 可分离的数组缓冲区预期状态 */</span></li><li>        JSVM_WOULD_DEADLOCK,                  <span class="hljs-comment">/* 将死锁状态 */</span></li><li>        JSVM_NO_EXTERNAL_BUFFERS_ALLOWED,     <span class="hljs-comment">/* 不允许外部缓冲区 */</span></li><li>        JSVM_CANNOT_RUN_JS,                   <span class="hljs-comment">/* 不能执行JS */</span></li><li>        JSVM_INVALID_TYPE,                    <span class="hljs-comment">/* 非法类型 */</span></li><li>        JSVM_JIT_MODE_EXPECTED,                <span class="hljs-comment">/* 期望在JIT模式下执行 */</span></li><li>    } JSVM_Status;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="jsvm_extendederrorinfo">JSVM_ExtendedErrorInfo<i class="anchor-icon anchor-icon-link" anchorid="jsvm_extendederrorinfo" tips="复制节点链接"></i></h3><p>一个结构体，在调用函数不成功时存储了较为详细的错误信息。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* errorMessage;</li><li>    <span class="hljs-type">void</span>* engineReserved;</li><li>    <span class="hljs-type">uint32_t</span> engineErrorCode;</li><li>    JSVM_Status errorCode;</li><li>} JSVM_ExtendedErrorInfo;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="jsvm_value">JSVM_Value<i class="anchor-icon anchor-icon-link" anchorid="jsvm_value" tips="复制节点链接"></i></h3><p>在C++代码中，用于表示JavaScript值。</p> </div>  <div class="tiledSection"><h3 id="jsvm_env">JSVM_Env<i class="anchor-icon anchor-icon-link" anchorid="jsvm_env" tips="复制节点链接"></i></h3><ul><li><p>表示JSVM-API执行时的上下文，作为Native函数的参数传递给JSVM-API接口。</p>  </li><li><p>退出Native侧插件时，JSVM_Env将失效，该事件通过回调传递给OH_JSVM_SetInstanceData接口。</p>  </li><li><p>禁止缓存JSVM_Env，并禁止在不同Worker中传递JSVM_Env。</p>  </li><li><p>在不同线程间共享JSVM_Env时，要保证在线程切换时在前一个线程中关闭env scope并在新的线程中打开新的env scope，以保证threadlocal变量的线程隔离。</p>  </li></ul> </div>  <div class="tiledSection"><h3 id="jsvm_valuetype">JSVM_ValueType<i class="anchor-icon anchor-icon-link" anchorid="jsvm_valuetype" tips="复制节点链接"></i></h3><p>JSVM_Value的类型。包含了ECMAScript语言规范中定义的类型，其中JSVM_EXTERNAL表示外部数据类型。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> {</li><li>    JSVM_UNDEFINED,</li><li>    JSVM_NULL,</li><li>    JSVM_BOOLEAN,</li><li>    JSVM_NUMBER,</li><li>    JSVM_STRING,</li><li>    JSVM_SYMBOL,</li><li>    JSVM_OBJECT,</li><li>    JSVM_FUNCTION,</li><li>    JSVM_EXTERNAL,</li><li>    JSVM_BIGINT,</li><li>} JSVM_ValueType;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="jsvm_typedarraytype">JSVM_TypedarrayType<i class="anchor-icon anchor-icon-link" anchorid="jsvm_typedarraytype" tips="复制节点链接"></i></h3><p>TypedArray 的基本二进制标量数据类型。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> {</li><li>    JSVM_INT8_ARRAY,</li><li>    JSVM_UINT8_ARRAY,</li><li>    JSVM_UINT8_CLAMPED_ARRAY,</li><li>    JSVM_INT16_ARRAY,</li><li>    JSVM_UINT16_ARRAY,</li><li>    JSVM_INT32_ARRAY,</li><li>    JSVM_UINT32_ARRAY,</li><li>    JSVM_FLOAT32_ARRAY,</li><li>    JSVM_FLOAT64_ARRAY,</li><li>    JSVM_BIGINT64_ARRAY,</li><li>    JSVM_BIGUINT64_ARRAY,</li><li>} JSVM_TypedarrayType;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="jsvm_regexpflags">JSVM_RegExpFlags<i class="anchor-icon anchor-icon-link" anchorid="jsvm_regexpflags" tips="复制节点链接"></i></h3><p>正则表达式标志位。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">typedef</span> <span class="hljs-keyword">enum</span> {</li><li>    <span class="hljs-variable">JSVM_REGEXP_NONE</span> = <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_GLOBAL</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_IGNORE_CASE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_MULTILINE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_STICKY</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_UNICODE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_DOT_ALL</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_LINEAR</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_HAS_INDICES</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,</li><li>    <span class="hljs-variable">JSVM_REGEXP_UNICODE_SETS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>,</li><li>} <span class="hljs-variable">JSVM_RegExpFlags</span>;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="编译选项相关类型">编译选项相关类型<i class="anchor-icon anchor-icon-link" anchorid="编译选项相关类型" tips="复制节点链接"></i></h3><p><strong>JSVM_CompileOptions</strong></p> <p>配合 OH_JSVM_CompileScriptWithOptions 接口使用，是其参数中 options 数组的元素类型。</p> <p>其中：</p> <ul><li>id 代表这个编译选项的类型。</li><li>content 代表编译选项的内容。</li></ul> <p>id 的值和 content 的类型需对应使用，具体对应关系请参见各选项类型的介绍。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-comment">/** compile option id. */</span></li><li>    JSVM_CompileOptionId id;</li><li>    <span class="hljs-comment">/** option content. */</span></li><li>    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span></li><li>      <span class="hljs-comment">/** ptr type. */</span></li><li>      <span class="hljs-type">void</span> *ptr;</li><li>      <span class="hljs-comment">/** int type. */</span></li><li>      <span class="hljs-type">int</span> num;</li><li>      <span class="hljs-comment">/** bool type. */</span></li><li>      <span class="hljs-type">_Bool</span> boolean;</li><li>    } content;</li><li>} JSVM_CompileOptions;</li></ol></pre></div></div> <p><strong>JSVM_CompileOptionId</strong></p> <p>JSVM_CompileOptions 中的 id 对应类型，每个值有对应的 content 类型。JSVM_COMPILE_ENABLE_SOURCE_MAP 的类型为 bool，当 JSVM_ScriptOrigin 中的 sourceMapUrl 不为空时生效。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    <span class="hljs-comment">/** compile mode. */</span></li><li>    JSVM_COMPILE_MODE,</li><li>    <span class="hljs-comment">/** code cache content. */</span></li><li>    JSVM_COMPILE_CODE_CACHE,</li><li>    <span class="hljs-comment">/** script origin. */</span></li><li>    JSVM_COMPILE_SCRIPT_ORIGIN,</li><li>    <span class="hljs-comment">/** compile profile content. */</span></li><li>    JSVM_COMPILE_COMPILE_PROFILE,</li><li>    <span class="hljs-comment">/** switch for source map support. */</span></li><li>    JSVM_COMPILE_ENABLE_SOURCE_MAP,</li><li>} JSVM_CompileOptionId;</li></ol></pre></div></div> <p><strong>JSVM_CompileMode</strong></p> <p>当 id 为 JSVM_COMPILE_MODE 时，content 类型的每个值代表一种编译模式。</p> <ul><li>JSVM_COMPILE_MODE_DEFAULT : 默认的编译选项。</li><li>JSVM_COMPILE_MODE_CONSUME_CODE_CACHE : 消耗 codecache 进行编译。</li><li>JSVM_COMPILE_MODE_EAGER_COMPILE : 进行全量编译，不再进行 lazy compile。</li><li>JSVM_COMPILE_MODE_PRODUCE_COMPILE_PROFILE/JSVM_COMPILE_MODE_CONSUME_COMPILE_PROFILE : 当前暂无效果，请等待后续更新。</li></ul> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span></li><li>    <span class="hljs-comment">/** default mode. */</span></li><li>    JSVM_COMPILE_MODE_DEFAULT,</li><li>    <span class="hljs-comment">/** consume code cache. */</span></li><li>    JSVM_COMPILE_MODE_CONSUME_CODE_CACHE,</li><li>    <span class="hljs-comment">/** apply eager compile. */</span></li><li>    JSVM_COMPILE_MODE_EAGER_COMPILE,</li><li>    <span class="hljs-comment">/** preset for compile profile. */</span></li><li>    JSVM_COMPILE_MODE_PRODUCE_COMPILE_PROFILE,</li><li>    <span class="hljs-comment">/** consume compile profile. */</span></li><li>    JSVM_COMPILE_MODE_CONSUME_COMPILE_PROFILE,</li><li>} JSVM_CompileMode;</li></ol></pre></div></div> <p><strong>JSVM_CodeCache</strong></p> <p>当 id 为 JSVM_COMPILE_CODE_CACHE 时，content 的类型为：</p> <ul><li>cache : 指向 code cache 的指针。</li><li>length : 代表 code cache 的大小。</li></ul> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-comment">/** cache pointer. */</span></li><li>    <span class="hljs-type">uint8_t</span> *cache;</li><li>    <span class="hljs-comment">/** length. */</span></li><li>    <span class="hljs-type">size_t</span> length;</li><li>} JSVM_CodeCache;</li></ol></pre></div></div> <p><strong>JSVM_ScriptOrigin</strong></p> <p>当 id 为 JSVM_COMPILE_SCRIPT_ORIGIN 时，content 存放待编译脚本的源码信息。</p> <ul><li>sourceMapUrl : sourceMap 的路径，当前仅支持运行设备上的本地路径，可以为空。</li><li>resourceName : 待编译的 js script 的名字。</li></ul> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    <span class="hljs-comment">/** Sourcemap url. */</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sourceMapUrl;</li><li>    <span class="hljs-comment">/** Resource name. */</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* resourceName;</li><li>    <span class="hljs-comment">/** Resource line offset. */</span></li><li>    <span class="hljs-type">size_t</span> resourceLineOffset;</li><li>    <span class="hljs-comment">/** Resource column offset. */</span></li><li>    <span class="hljs-type">size_t</span> resourceColumnOffset;</li><li>} JSVM_ScriptOrigin;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="jsvm">JSVM<i class="anchor-icon anchor-icon-link" anchorid="jsvm" tips="复制节点链接"></i></h3></div>  <div class="tiledSection"><h3 id="内存管理类型">内存管理类型<i class="anchor-icon anchor-icon-link" anchorid="内存管理类型" tips="复制节点链接"></i></h3><p>JSVM-API 包含以下内存管理类型：</p> <p><strong>JSVM_HandleScope</strong></p> <p>JSVM_HandleScope 数据类型用于管理 JavaScript 对象的生命周期。它确保在指定范围内创建的 JavaScript 对象保持活动状态，直到该范围结束。这样可以防止使用已释放的对象，提高代码的可靠性和性能。</p> <p><strong>JSVM_EscapableHandleScope</strong></p> <ul><li><p>由 OH_JSVM_OpenEscapableHandleScope 接口创建，由 OH_JSVM_CloseEscapableHandleScope 接口关闭。</p>  </li><li><p>表示一种特殊类型的句柄范围，用于将在JSVM_EscapableHandleScope范围内创建的值返回给父scope。</p>  </li><li><p>用于 OH_JSVM_EscapeHandle 接口，将 JSVM_EscapableHandleScope 范围内的值提升为 JavaScript 对象，以便在外部作用域使用。</p>  </li></ul> <p><strong>JSVM_Ref</strong></p> <p>指向JSVM_Value，允许开发者管理JavaScript值的生命周期。</p> <p><strong>JSVM_TypeTag</strong></p> <p>该结构体定义了一个包含两个无符号64位整数的类型标签，用于标识一个JSVM-API值的类型信息。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>    <span class="hljs-type">uint64_t</span> lower;</li><li>    <span class="hljs-type">uint64_t</span> upper;</li><li>} JSVM_TypeTag;</li></ol></pre></div></div> <ul><li><p>存储了两个无符号64位整数的128位值，用它来标识JavaScript对象，确保它们属于某种类型。</p>  </li><li><p>比OH_JSVM_Instanceof更强的类型检查，如果对象的原型被操纵，OH_JSVM_Instanceof可能会报告误报。</p>  </li><li><p>JSVM_TypeTag 在与 OH_JSVM_Wrap 结合使用时最有用，因为它确保从包装对象检索的指针可以安全地转换为与先前应用于JavaScript对象的类型标签相对应的Native类型。</p>  </li></ul> </div>  <div class="tiledSection"><h3 id="回调类型">回调类型<i class="anchor-icon anchor-icon-link" anchorid="回调类型" tips="复制节点链接"></i></h3><p>JSVM-API包含以下回调类型：</p> <p><strong>JSVM_CallbackStruct</strong></p> <p>用户提供的 Native callback 的回调函数指针和数据，JSVM_CallbackStruct 将通过 JSVM-API 暴露给 JavaScript。例如，可以使用 OH_JSVM_CreateFunction 接口创建绑定到 Native callback 的 JS 函数，其中 Native callback 就是通过 JSVM_CallbackStruct 结构定义。除非在对象生命周期管理中有特殊要求，一般不在此 callback 中创建 handle 或者 callback scope。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>  <span class="hljs-built_in">JSVM_Value</span>(*callback)(JSVM_Env env, JSVM_CallbackInfo info);</li><li>  <span class="hljs-type">void</span>* data;</li><li>} JSVM_CallbackStruct;</li></ol></pre></div></div> <p><strong>JSVM_Callback</strong></p> <p>JSVM_CallbackStruct 指针类型的别名。</p> <p>定义如下:</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> JSVM_CallbackStruct* JSVM_Callback;</li></ol></pre></div></div> <p><strong>JSVM_CallbackInfo</strong></p> <p>用户定义的 Native callback，第一个参数类型是 JSVM_Env，第二个参数类型是 JSVM_CallbackInfo。JSVM_CallbackInfo 表示从 JS 侧调用到 Native 侧时携带的调用信息，如参数列表。在实现 Native callback 时，一般使用 OH_JSVM_GetCbInfo 接口从 JSVM_CallbackInfo 中获取调用信息。</p> <p><strong>JSVM_Finalize</strong></p> <p>函数指针，用于传入OH_JSVM_SetInstanceData、OH_JSVM_CreateExternal、OH_JSVM_Wrap等接口。JSVM_Finalize在对象被回收后会被调用，可用于在JavaScript对象被垃圾回收时释放Native对象。JSVM 不保证是否执行该回调函数，也不保证执行该回调函数的时机，<strong>开发者不应依赖于该回调的执行时机</strong>。</p> <p>写法如下：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*JSVM_Finalize)</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">void</span>* finalizeData, <span class="hljs-type">void</span>* finalizeHint)</span></span>;</li></ol></pre></div></div> <p><strong>JSVM_PropertyHandlerConfigurationStruct</strong></p> <p>当执行对象的getter、setter、deleter和enumerator操作时，对应的回调将会触发。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>typedef struct {</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericNamedPropertyGetterCallback)(JSVM_Env env,</li><li>                                                               JSVM_Value name,</li><li>                                                               JSVM_Value thisArg,</li><li>                                                               JSVM_Value namedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericNamedPropertySetterCallback)(JSVM_Env env,</li><li>                                                               JSVM_Value name,</li><li>                                                               JSVM_Value property,</li><li>                                                               JSVM_Value thisArg,</li><li>                                                               JSVM_Value namedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericNamedPropertyDeleterCallback)(JSVM_Env env,</li><li>                                                                JSVM_Value name,</li><li>                                                                JSVM_Value thisArg,</li><li>                                                                JSVM_Value namedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericNamedPropertyEnumeratorCallback)(JSVM_Env env,</li><li>                                                                   JSVM_Value thisArg,</li><li>                                                                   JSVM_Value namedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericIndexedPropertyGetterCallback)(JSVM_Env env,</li><li>                                                                JSVM_Value index,</li><li>                                                                JSVM_Value thisArg,</li><li>                                                                JSVM_Value indexedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericIndexedPropertySetterCallback)(JSVM_Env env,</li><li>                                                                 JSVM_Value index,</li><li>                                                                 JSVM_Value property,</li><li>                                                                 JSVM_Value thisArg,</li><li>                                                                 JSVM_Value indexedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericIndexedPropertyDeleterCallback)(JSVM_Env env,</li><li>                                                                  JSVM_Value index,</li><li>                                                                  JSVM_Value thisArg,</li><li>                                                                  JSVM_Value indexedPropertyData);</li><li>    <span class="hljs-built_in">JSVM_Value</span>(JSVM_CDECL* genericIndexedPropertyEnumeratorCallback)(JSVM_Env env,</li><li>                                                                     JSVM_Value thisArg,</li><li>                                                                     JSVM_Value indexedPropertyData);</li><li>    JSVM_Value namedPropertyData;</li><li>    JSVM_Value indexedPropertyData;</li><li>} JSVM_PropertyHandlerConfigurationStruct;</li></ol></pre></div></div> <p><strong>JSVM_PropertyHandlerCfg</strong></p> <p>包含属性监听回调的结构指针。</p> <p>基本用法如下:</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> JSVM_PropertyHandlerConfigurationStruct* JSVM_PropertyHandlerCfg;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="支持的jsvm-api接口">支持的JSVM-API接口<i class="anchor-icon anchor-icon-link" anchorid="支持的jsvm-api接口" tips="复制节点链接"></i></h2><p>标准JS引擎的能力通过JSVM-API提供。JSVM-API支持动态链接到不同版本的JS引擎库，从而为开发者屏蔽掉不同引擎接口的差异。JSVM-API提供引擎生命周期管理、JS context管理、JS代码执行、JS/C++互操作、执行环境快照、codecache等能力，具体可见下文。</p> </div>  <div class="tiledSection"><h3 id="使用-jsvm-api-接口创建引擎实例及-js-执行上下文环境" class="firsth2">使用 JSVM-API 接口创建引擎实例及 JS 执行上下文环境<i class="anchor-icon anchor-icon-link" anchorid="使用-jsvm-api-接口创建引擎实例及-js-执行上下文环境" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>执行JS代码需要先创建JavaScript VM，创建JS执行的上下文环境。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.14.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.14.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Init</td> <td class="cellrowborder" valign="top" width="50%">初始化JavaScript引擎实例</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateVM</td> <td class="cellrowborder" valign="top" width="50%">创建JavaScript引擎实例</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DestroyVM</td> <td class="cellrowborder" valign="top" width="50%">销毁JavaScript引擎实例</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenVMScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个新的VM scope，引擎实例只能在scope范围内使用，可以保证引擎实例不被销毁</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseVMScope</td> <td class="cellrowborder" valign="top" width="50%">关闭VM scope</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateEnv</td> <td class="cellrowborder" valign="top" width="50%">创建一个新的JS执行上下文环境，并注册指定的Native函数</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DestroyEnv</td> <td class="cellrowborder" valign="top" width="50%">销毁一个JS执行上下文环境</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenEnvScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个新的Env scope，Env只能在scope范围内使用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseEnvScope</td> <td class="cellrowborder" valign="top" width="50%">关闭Env scope</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenHandleScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个Handle scope，确保scope范围内的JSVM_Value不被GC回收</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseHandleScope</td> <td class="cellrowborder" valign="top" width="50%">关闭Handle scope</td> </tr>  </tbody></table></div> </div> <p><strong>JSVM_InitOptions 的使用描述</strong></p> <p>JSVM 提供了多种配置选项，允许开发者在执行 OH_JSVM_Init 时灵活配置其行为。可以通过 OH_JSVM_GetVMInfo 接口获取当前 JSVM 版本所对应的 V8 引擎版本。JSVM 中可支持的选项范围与对应的 V8 引擎版本可支持的选项范围保持一致。OH_JSVM_GetVMInfo 接口的使用参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-about-version">使用JSVM-API接口获取JSVM API的版本号</a>。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <ul><li>建议开发者在没有特殊需求的情况下，仅使用JSVM内部的默认配置选项。</li></ul>  </div></div></div> <p>场景示例：</p> <p>常规模式下初始化 VM 平台。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">NormalInit</span><span class="hljs-params">(<span class="hljs-type">bool</span> &amp;vmInit)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!vmInit) {</li><li>        <span class="hljs-comment">// JSVM only need init once</span></li><li>        JSVM_InitOptions initOptions;</li><li>        <span class="hljs-built_in">memset</span>(&amp;initOptions, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(initOptions));</li><li>        JSVM_Status cond = <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions);</li><li>        <span class="hljs-keyword">if</span>(cond == JSVM_OK) {</li><li>            vmInit = <span class="hljs-literal">true</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            vmInit = <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div> <p>场景示例：</p> <p>初始化低内存占用的 VM 平台。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">LowMemoryInit</span><span class="hljs-params">(<span class="hljs-type">bool</span> &amp;vmInit)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!vmInit) {</li><li>        <span class="hljs-comment">// JSVM only need init once</span></li><li>        JSVM_InitOptions initOptions;</li><li>        <span class="hljs-type">int</span> argc = <span class="hljs-number">4</span>;</li><li>        initOptions.argc = &amp;argc;</li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* argv[<span class="hljs-number">4</span>];</li><li>        argv[<span class="hljs-number">1</span>] = <span class="hljs-string">"--incremental-marking-hard-trigger=40"</span>;</li><li>        argv[<span class="hljs-number">2</span>] = <span class="hljs-string">"--min-semi-space-size=1"</span>;</li><li>        argv[<span class="hljs-number">3</span>] = <span class="hljs-string">"--max-semi-space-size=4"</span>;</li><li>        initOptions.argv = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(argv);</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions);</li><li>        vmInit = <span class="hljs-literal">true</span>;</li><li>    }</li><li>}</li></ol></pre></div></div> <p>场景示例：</p> <p>初始化低GC触发频次的 VM 平台。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">LowGCFrequencyInit</span><span class="hljs-params">(<span class="hljs-type">bool</span> &amp;vmInit)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!vmInit) {</li><li>        <span class="hljs-comment">// JSVM only need init once</span></li><li>        JSVM_InitOptions initOptions;</li><li>        <span class="hljs-type">int</span> argc = <span class="hljs-number">4</span>;</li><li>        initOptions.argc = &amp;argc;</li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* argv[<span class="hljs-number">4</span>];</li><li>        argv[<span class="hljs-number">1</span>] = <span class="hljs-string">"--incremental-marking-hard-trigger=80"</span>;</li><li>        argv[<span class="hljs-number">2</span>] = <span class="hljs-string">"--min-semi-space-size=16"</span>;</li><li>        argv[<span class="hljs-number">3</span>] = <span class="hljs-string">"--max-semi-space-size=16"</span>;</li><li>        initOptions.argv = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(argv);</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions);</li><li>        vmInit = <span class="hljs-literal">true</span>;</li><li>    }</li><li>}</li></ol></pre></div></div> <p>执行结果：</p> <p>使用以上三个接口可以分别初始化具备不同特性的 VM 平台。初始化之后，可以创建 VM 实例，并执行 JavaScript 脚本。</p> <p>相比 NormalInit 接口，LowGCFrequencyInit 接口初始化的VM平台 GC 触发频次更低。</p> <p>相比 NormalInit 接口，LowMemoryInit 接口初始化的VM平台内存占用更少。</p> <p><strong>创建 VM 实例</strong></p> <p>场景示例:</p> <p>创建及销毁 JavaScript 引擎实例，包含创建及销毁 JS 执行上下文环境</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> VM_INIT = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ConsoleInfo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">char</span> log[<span class="hljs-number">256</span>] = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-type">size_t</span> logLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], log, <span class="hljs-number">255</span>, &amp;logLength);</li><li>    log[<span class="hljs-number">255</span>] = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: %{public}s"</span>, log);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">Add</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-type">double</span> num1 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">double</span> num2 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">0</span>], &amp;num1);</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">1</span>], &amp;num2);</li><li>    JSVM_Value sum = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateDouble</span>(env, num1 + num2, &amp;sum);</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">MyJSVMDemo</span><span class="hljs-params">([[maybe_unused]] napi_env _env, [[maybe_unused]] napi_callback_info _info)</span> </span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">([]() {</span></span></li><li><span class="hljs-function">        <span class="hljs-comment">// 可以根据不同的业务需求初始化具备不同能力的 VM 平台：</span></span></li><li><span class="hljs-function">        <span class="hljs-comment">// 1. 初始化默认的 VM 平台：调用'NormalInit'接口。</span></span></li><li><span class="hljs-function">        <span class="hljs-comment">// 2. 初始化低内存占用的 VM 平台：调用'LowMemoryInit'接口。</span></span></li><li><span class="hljs-function">        <span class="hljs-comment">// 3. 初始化低 GC 触发频次的 VM 平台：调用'LowGCFrequencyInit'接口。</span></span></li><li><span class="hljs-function">        NormalInit(VM_INIT);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// create vm, and open vm scope</span></span></li><li><span class="hljs-function">        JSVM_VM vm;</span></li><li><span class="hljs-function">        JSVM_CreateVMOptions options;</span></li><li><span class="hljs-function">        memset(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(options));</span></li><li><span class="hljs-function">        OH_JSVM_CreateVM(&amp;options, &amp;vm);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        JSVM_VMScope vmScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenVMScope(vm, &amp;vmScope);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        JSVM_CallbackStruct param[] = {</span></li><li><span class="hljs-function">            {.data = <span class="hljs-literal">nullptr</span>, .callback = ConsoleInfo},</span></li><li><span class="hljs-function">            {.data = <span class="hljs-literal">nullptr</span>, .callback = Add},</span></li><li><span class="hljs-function">        };</span></li><li><span class="hljs-function">        JSVM_PropertyDescriptor descriptor[] = {</span></li><li><span class="hljs-function">            {<span class="hljs-string">"consoleinfo"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</span></li><li><span class="hljs-function">            {<span class="hljs-string">"add"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</span></li><li><span class="hljs-function">        };</span></li><li><span class="hljs-function">        <span class="hljs-comment">// create env, register native method, and open env scope</span></span></li><li><span class="hljs-function">        JSVM_Env env;</span></li><li><span class="hljs-function">        OH_JSVM_CreateEnv(vm, <span class="hljs-keyword">sizeof</span>(descriptor) / <span class="hljs-keyword">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        JSVM_EnvScope envScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenEnvScope(env, &amp;envScope);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        <span class="hljs-comment">// open handle scope</span></span></li><li><span class="hljs-function">        JSVM_HandleScope handleScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenHandleScope(env, &amp;handleScope);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        std::string sourceCodeStr = <span class="hljs-string">"\</span></span></li><li><span class="hljs-function">        {\</span></li><li><span class="hljs-function">            let value = add(4.96, 5.28);\</span></li><li><span class="hljs-function">            consoleinfo('Result is:' + value);\</span></li><li><span class="hljs-function">        }"</span>;</li><li><span class="hljs-function">        <span class="hljs-comment">// compile js script</span></span></li><li><span class="hljs-function">        JSVM_Value sourceCodeValue;</span></li><li><span class="hljs-function">        OH_JSVM_CreateStringUtf8(env, sourceCodeStr.c_str(), sourceCodeStr.size(), &amp;sourceCodeValue);</span></li><li><span class="hljs-function">        JSVM_Script script;</span></li><li><span class="hljs-function">        OH_JSVM_CompileScript(env, sourceCodeValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</span></li><li><span class="hljs-function">        JSVM_Value result;</span></li><li><span class="hljs-function">        <span class="hljs-comment">// run js script</span></span></li><li><span class="hljs-function">        OH_JSVM_RunScript(env, script, &amp;result);</span></li><li><span class="hljs-function">        JSVM_ValueType type;</span></li><li><span class="hljs-function">        OH_JSVM_Typeof(env, result, &amp;type);</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM API TEST type: %{public}d"</span>, type);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        <span class="hljs-comment">// exit vm and clean memory</span></span></li><li><span class="hljs-function">        OH_JSVM_CloseHandleScope(env, handleScope);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        OH_JSVM_CloseEnvScope(env, envScope);</span></li><li><span class="hljs-function">        OH_JSVM_DestroyEnv(env);</span></li><li><span class="hljs-function"></span></li><li><span class="hljs-function">        OH_JSVM_CloseVMScope(vm, vmScope);</span></li><li><span class="hljs-function">        OH_JSVM_DestroyVM(vm);</span></li><li><span class="hljs-function">    })</span>;</li><li>
</li><li>    t.<span class="hljs-built_in">detach</span>();</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="使用-jsvm-api-接口编译及执行-js-代码">使用 JSVM-API 接口编译及执行 JS 代码<i class="anchor-icon anchor-icon-link" anchorid="使用-jsvm-api-接口编译及执行-js-代码" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>编译及执行JS代码。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.15.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.15.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileScript</td> <td class="cellrowborder" valign="top" width="50%">编译JavaScript代码并返回绑定到当前环境的编译脚本</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileScriptWithOrigin</td> <td class="cellrowborder" valign="top" width="50%">编译JavaScript代码并返回绑定到当前环境的编译脚本，同时传入包括 sourceMapUrl 和源文件名在内的源代码信息，用于处理 source map 信息</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileScriptWithOptions</td> <td class="cellrowborder" valign="top" width="50%">通用的编译接口，通过传入 option 数组完成前面的 compile 接口全部功能，同时支持后续选项扩展</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateCodeCache</td> <td class="cellrowborder" valign="top" width="50%">为编译脚本创建code cache</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RunScript</td> <td class="cellrowborder" valign="top" width="50%">执行编译脚本，如果没有 JIT 权限支持，执行含wasm的脚本会失败，在特定场景下存在性能差异，并打印一行日志提示开发者</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>编译及执行 JS 代码（创建 VM 实例，注册函数，执行 JS，销毁 VM 实例）</p> <p>cpp 部分代码</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// 依赖libjsvm.so</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li>
</li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">Hello</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_Value output;</li><li>    <span class="hljs-type">void</span>* data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;data);</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, (<span class="hljs-type">char</span>*)data, <span class="hljs-built_in">strlen</span>((<span class="hljs-type">char</span>*)data), &amp;output);</li><li>    <span class="hljs-keyword">return</span> output;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct hello_cb = { Hello, (<span class="hljs-type">void</span>*)<span class="hljs-string">"Hello"</span> };</li><li>
</li><li><span class="hljs-type">static</span> string srcGlobal = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">const concat = (...args) =&gt; args.reduce((a, b) =&gt; a + b);</span></li><li><span class="hljs-string">)JS"</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunScriptWithOption</span><span class="hljs-params">(JSVM_Env env, string&amp; src,</span></span></li><li><span class="hljs-function">                                <span class="hljs-type">uint8_t</span>** dataPtr = <span class="hljs-literal">nullptr</span>,</span></li><li><span class="hljs-function">                                <span class="hljs-type">size_t</span>* lengthPtr = <span class="hljs-literal">nullptr</span>)</span> {</li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, src.<span class="hljs-built_in">c_str</span>(), src.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>    <span class="hljs-type">uint8_t</span>* data = dataPtr ? *dataPtr : <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">auto</span> compilMode = data ? JSVM_COMPILE_MODE_CONSUME_CODE_CACHE :  JSVM_COMPILE_MODE_DEFAULT;</li><li>    <span class="hljs-type">size_t</span> length = lengthPtr ? *lengthPtr : <span class="hljs-number">0</span>;</li><li>    JSVM_Script script;</li><li>    <span class="hljs-comment">// 编译js代码</span></li><li>    JSVM_ScriptOrigin origin {</li><li>        <span class="hljs-comment">// 以包名 helloworld 为例, 假如存在对应的 sourcemap, sourcemap 的路径可以是 /data/app/el2/100/base/com.example.helloworld/files/index.js.map</span></li><li>        .sourceMapUrl = <span class="hljs-string">"/data/app/el2/100/base/com.example.helloworld/files/index.js.map"</span>,</li><li>        <span class="hljs-comment">// 源文件名字</span></li><li>        .resourceName = <span class="hljs-string">"index.js"</span>,</li><li>        <span class="hljs-comment">// script 在源文件中的起始行列号</span></li><li>        .resourceLineOffset = <span class="hljs-number">0</span>,</li><li>        .resourceColumnOffset = <span class="hljs-number">0</span>,</li><li>    };</li><li>    JSVM_CompileOptions option[<span class="hljs-number">3</span>];</li><li>    option[<span class="hljs-number">0</span>] = {</li><li>        .id = JSVM_COMPILE_MODE,</li><li>        .content = { .num = compilMode }</li><li>    };</li><li>    JSVM_CodeCache codeCache = {</li><li>        .cache = data,</li><li>        .length = length</li><li>    };</li><li>    option[<span class="hljs-number">1</span>] = {</li><li>        .id = JSVM_COMPILE_CODE_CACHE,</li><li>        .content = { .ptr = &amp;codeCache }</li><li>    };</li><li>    <span class="hljs-comment">// JSVM_COMPILE_ENABLE_SOURCE_MAP 选项默认值为 false，若为 true 那么对应的 sourceMapUrl 必须不为空</span></li><li>    option[<span class="hljs-number">2</span>] = {</li><li>        .id = JSVM_COMPILE_ENABLE_SOURCE_MAP,</li><li>        .content = { .boolean = <span class="hljs-literal">true</span> }</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScriptWithOptions</span>(env, jsSrc, <span class="hljs-number">3</span>, option, &amp;script);</li><li>
</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 执行js代码</span></li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li>    <span class="hljs-type">char</span> resultStr[<span class="hljs-number">128</span>];</li><li>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, result, resultStr, <span class="hljs-number">128</span>, &amp;size);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunScript</span><span class="hljs-params">(JSVM_Env env, string&amp; src,</span></span></li><li><span class="hljs-function">                       <span class="hljs-type">bool</span> withOrigin = <span class="hljs-literal">false</span>,</span></li><li><span class="hljs-function">                       <span class="hljs-type">uint8_t</span>** dataPtr = <span class="hljs-literal">nullptr</span>,</span></li><li><span class="hljs-function">                       <span class="hljs-type">size_t</span>* lengthPtr = <span class="hljs-literal">nullptr</span>)</span> {</li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, src.<span class="hljs-built_in">c_str</span>(), src.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>    <span class="hljs-type">uint8_t</span>* data = dataPtr ? *dataPtr : <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> length = lengthPtr ? *lengthPtr : <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">bool</span> cacheRejected = <span class="hljs-literal">true</span>;</li><li>    JSVM_Script script;</li><li>    <span class="hljs-comment">// 编译js代码</span></li><li>    <span class="hljs-keyword">if</span> (withOrigin) {</li><li>        JSVM_ScriptOrigin origin {</li><li>            <span class="hljs-comment">// 以包名 helloworld 为例, 假如存在对应的 sourcemap, sourcemap 的路径可以是 /data/app/el2/100/base/com.example.helloworld/files/index.js.map</span></li><li>            .sourceMapUrl = <span class="hljs-string">"/data/app/el2/100/base/com.example.helloworld/files/index.js.map"</span>,</li><li>            <span class="hljs-comment">// 源文件名字</span></li><li>            .resourceName = <span class="hljs-string">"index.js"</span>,</li><li>            <span class="hljs-comment">// script 在源文件中的起始行列号</span></li><li>            .resourceLineOffset = <span class="hljs-number">0</span>,</li><li>            .resourceColumnOffset = <span class="hljs-number">0</span>,</li><li>        };</li><li>        <span class="hljs-built_in">OH_JSVM_CompileScriptWithOrigin</span>(env, jsSrc, data, length, <span class="hljs-literal">true</span>, &amp;cacheRejected, &amp;origin, &amp;script);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, data, length, <span class="hljs-literal">true</span>, &amp;cacheRejected, &amp;script);</li><li>    }</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Code cache is %s\n"</span>, cacheRejected ? <span class="hljs-string">"rejected"</span> : <span class="hljs-string">"used"</span>);</li><li>
</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 执行js代码</span></li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li>    <span class="hljs-type">char</span> resultStr[<span class="hljs-number">128</span>];</li><li>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, result, resultStr, <span class="hljs-number">128</span>, &amp;size);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RunWithOption</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>** dataPtr, <span class="hljs-type">size_t</span>* lengthPtr)</span> </span>{</li><li>    <span class="hljs-comment">// 创建虚拟机实例</span></li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm);</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>
</li><li>    JSVM_Env env;</li><li>    <span class="hljs-comment">// 将native函数注册成js可调用的方法，hello_cb中记录该native方法的指针和参数等信息</span></li><li>    JSVM_PropertyDescriptor descriptors[] = {</li><li>        { <span class="hljs-string">"hello"</span>, <span class="hljs-literal">NULL</span>, &amp;hello_cb, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT }</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">1</span>, descriptors, &amp;env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    <span class="hljs-comment">// 执行js源码src，src中可以包含任何js语法。也可以调用已注册的native方法。</span></li><li>    <span class="hljs-keyword">auto</span> src = srcGlobal + <span class="hljs-string">"concat(hello(), ', ', 'World', ' from RunWithOption!')"</span>;</li><li>    <span class="hljs-comment">// 其中使用新增接口，可以覆盖原有 Compile 系列接口的功能且具有拓展性</span></li><li>    <span class="hljs-built_in">RunScriptWithOption</span>(env, src, dataPtr, lengthPtr);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>
</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"RunWithOption: success: %{public}d"</span>, result);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RunWithOrigin</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> **dataPtr, <span class="hljs-type">size_t</span> *lengthPtr)</span> </span>{</li><li>    <span class="hljs-comment">// 创建虚拟机实例</span></li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    options.isForSnapshotting = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm);</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>
</li><li>    <span class="hljs-comment">// 从快照中创建env</span></li><li>    JSVM_Env env;</li><li>    <span class="hljs-comment">// 将native函数注册成js可调用的方法，hello_cb中记录该native方法的指针和参数等信息</span></li><li>    JSVM_PropertyDescriptor descriptors[] = {</li><li>        { <span class="hljs-string">"hello"</span>, <span class="hljs-literal">NULL</span>, &amp;hello_cb, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT }</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">1</span>, descriptors, &amp;env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    <span class="hljs-comment">// 执行js脚本，因为快照记录的env中定义了hello()，所以无需重新定义。dataPtr中如果保存了编译后的js脚本，就能直接执行js脚本，避免从源码重复编译。</span></li><li>    string src = <span class="hljs-string">"concat(hello(), ', ', 'World', ' from RunWithOrigin!')"</span>;</li><li>    <span class="hljs-built_in">RunScript</span>(env, src, <span class="hljs-literal">true</span>, dataPtr, lengthPtr);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>
</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"RunWithOrigin: success: %{public}d"</span>, result);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">RunDemo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">char</span>* str = <span class="hljs-string">"WithOrigin"</span>;</li><li>    <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strlen</span>(str);</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, str, len, &amp;result);</li><li>
</li><li>    <span class="hljs-type">uint8_t</span>* data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">bool</span> equal = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_StrictEquals</span>(env, args[<span class="hljs-number">0</span>], result, &amp;equal);</li><li>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> run = equal ? RunWithOrigin : RunWithOption;</li><li>    <span class="hljs-built_in">run</span>(&amp;data, &amp;length);</li><li>    <span class="hljs-keyword">delete</span>[] data;</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// RunDemo注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = RunDemo},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// RunDemo方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"RunDemo"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(RunDemo("WithOrigin"); RunDemo("WithOption"))JS"</span>;</li></ol></pre></div></div> <p>预期输出结果</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">RunWithOption</span>: <span class="hljs-attr">success</span>: <span class="hljs-number">1</span></li><li><span class="hljs-title class_">RunWithOrigin</span>: <span class="hljs-attr">success</span>: <span class="hljs-number">1</span></li></ol></pre></div></div> <p>OH_JSVM_CreateCodeCache接口用法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-about-code-cache">使用code cache加速编译</a>。</p> </div>  <div class="tiledSection"><h3 id="使用-jsvm-api-webassembly-接口编译-wasm-module">使用 JSVM-API WebAssembly 接口编译 wasm module<i class="anchor-icon anchor-icon-link" anchorid="使用-jsvm-api-webassembly-接口编译-wasm-module" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>JSVM-API WebAssembly 接口提供了 WebAssembly 字节码编译、WebAssembly 函数优化、WebAssembly cache 序列化和反序列化的能力。</p> <p>详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-about-wasm">使用 JSVM-API WebAssembly 接口</a>。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.16.6.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.16.6.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileWasmModule</td> <td class="cellrowborder" valign="top" width="50%">将 wasm 字节码同步编译为 wasm module。如果提供了 cache 参数，先尝试将 cache 反序列为 wasm module，反序列化失败时再执行编译。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileWasmFunction</td> <td class="cellrowborder" valign="top" width="50%">将 wasm module 中指定编号的函数编译为优化后的机器码，目前只使能了最高的优化等级，函数编号的合法性由接口调用者保证。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsWasmModuleObject</td> <td class="cellrowborder" valign="top" width="50%">判断传入的值是否是一个 wasm module。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateWasmCache</td> <td class="cellrowborder" valign="top" width="50%">将 wasm module 中的机器码序列化为 wasm cache，如果 wasm module 不包含机器码，则会序列化失败。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReleaseCache</td> <td class="cellrowborder" valign="top" width="50%">释放由 JSVM 接口生成的 cache。传入的 cacheType 和 cacheData 必须匹配，否则会产生未定义行为。</td> </tr>  </tbody></table></div> </div> <p><strong>场景示例</strong></p> <p>详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-about-wasm">使用 JSVM-API WebAssembly 接口</a>。</p> </div>  <div class="tiledSection"><h3 id="异常处理">异常处理<i class="anchor-icon anchor-icon-link" anchorid="异常处理" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>获取、抛出、清理JS异常。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.17.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.17.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Throw</td> <td class="cellrowborder" valign="top" width="50%">抛出一个JS值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ThrowTypeError</td> <td class="cellrowborder" valign="top" width="50%">抛出一个JS TypeError</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ThrowRangeError</td> <td class="cellrowborder" valign="top" width="50%">抛出一个JS RangeError</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsError</td> <td class="cellrowborder" valign="top" width="50%">判断JS值是否为JS异常</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateError</td> <td class="cellrowborder" valign="top" width="50%">创建一个JS异常</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateTypeError</td> <td class="cellrowborder" valign="top" width="50%">创建一个JS TypeError并返回</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateRangeError</td> <td class="cellrowborder" valign="top" width="50%">创建一个JS RangeError并返回</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ThrowError</td> <td class="cellrowborder" valign="top" width="50%">抛出一个JS异常</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetAndClearLastException</td> <td class="cellrowborder" valign="top" width="50%">清理并返回最后一个JS异常</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsExceptionPending</td> <td class="cellrowborder" valign="top" width="50%">判断当前是否有异常</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetLastErrorInfo</td> <td class="cellrowborder" valign="top" width="50%">获取最后一个异常的信息</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ThrowSyntaxError</td> <td class="cellrowborder" valign="top" width="50%">抛出一个JS SyntaxError</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSyntaxError</td> <td class="cellrowborder" valign="top" width="50%">创建一个JS SyntaxError并返回</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>以TypeError为例。创建、判断，并抛出JS TypeError。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value code = nullptr;</li><li>JSVM_Value message = nullptr;</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"500"</span>, JSVM_AUTO_LENGTH, &amp;code);</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"type error 500"</span>, JSVM_AUTO_LENGTH, &amp;message);</li><li>JSVM_Value error = nullptr;</li><li>OH_JSVM_CreateTypeError(<span class="hljs-built_in">env</span>, code, message, &amp;error);</li><li>bool isError = <span class="hljs-literal">false</span>;</li><li>OH_JSVM_IsError(<span class="hljs-built_in">env</span>, error, &amp;isError);</li><li>OH_JSVM_ThrowTypeError(<span class="hljs-built_in">env</span>, nullptr, <span class="hljs-string">"type error1"</span>);</li></ol></pre></div></div> <p>使用OH_JSVM_GetAndClearLastException后将异常信息以字符串形式打印</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (status != JSVM_OK) <span class="hljs-comment">// 当执行失败出现异常时</span></li><li>{</li><li>    <span class="hljs-type">bool</span> isPending = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">if</span> (JSVM_OK == <span class="hljs-built_in">OH_JSVM_IsExceptionPending</span>((env), &amp;isPending) &amp;&amp; isPending)</li><li>    {</li><li>        JSVM_Value error;</li><li>        <span class="hljs-keyword">if</span> (JSVM_OK == <span class="hljs-built_in">OH_JSVM_GetAndClearLastException</span>((env), &amp;error))</li><li>        {</li><li>            <span class="hljs-comment">// 获取异常堆栈</span></li><li>            JSVM_Value stack;</li><li>            <span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>((env), error, <span class="hljs-string">"stack"</span>, &amp;stack);</li><li>
</li><li>            JSVM_Value message;</li><li>            <span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>((env), error, <span class="hljs-string">"message"</span>, &amp;message);</li><li>
</li><li>            <span class="hljs-type">char</span> stackstr[<span class="hljs-number">256</span>];</li><li>            <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, stack, stackstr, <span class="hljs-number">256</span>, <span class="hljs-literal">nullptr</span>);</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM error stack: %{public}s"</span>, stackstr);</li><li>
</li><li>            <span class="hljs-type">char</span> messagestr[<span class="hljs-number">256</span>];</li><li>            <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, message, messagestr, <span class="hljs-number">256</span>, <span class="hljs-literal">nullptr</span>);</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM error message: %{public}s"</span>, messagestr);</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="对象生命周期管理">对象生命周期管理<i class="anchor-icon anchor-icon-link" anchorid="对象生命周期管理" tips="复制节点链接"></i></h3><p>在调用JSVM-API接口时，底层VM堆中的对象可能会作为JSVM_Values返回句柄。这些句柄必须在Native方法销毁或主动释放掉前，使其关联的对象处于“活动”状态，防止被引擎回收掉。</p> <p>当对象句柄被返回时，它们与一个“scope”相关联。默认作用域的生命周期与Native方法调用的生命周期相关联，这些句柄及关联的对象将在Native方法的生命周期内保持活动状态。</p> <p>然而，在许多情况下，句柄必须保持有效的时间范围并不与Native方法的生命周期相同。下面将介绍可用于更改句柄的生命周期的JSVM-API方法。</p> <p><strong>对象生命周期管理接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.18.6.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.18.6.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenHandleScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个新的scope，在关闭该scope之前创建的对象在scope范围内不会被GC回收</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseHandleScope</td> <td class="cellrowborder" valign="top" width="50%">关闭一个scope，在此scope范围内创建的对象在关闭scope后可以被GC回收</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenEscapableHandleScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个新的scope逃逸handle scope，在关闭该scope之前创建的对象与父作用域有相同的生命周期</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseEscapableHandleScope</td> <td class="cellrowborder" valign="top" width="50%">关闭一个scope，在此scope范围外创建的对象不受父作用域保护</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_EscapeHandle</td> <td class="cellrowborder" valign="top" width="50%">将 JavaScript 对象的句柄提升到外部作用域，确保在外部作用域中可以持续地使用该对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateReference</td> <td class="cellrowborder" valign="top" width="50%">以指定的引用计数为JavaScript对象创建一个新的引用，该引用将指向传入的对象，引用允许在不同的上下文中使用和共享对象，并且可以有效地监测对象的生命周期</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DeleteReference</td> <td class="cellrowborder" valign="top" width="50%">释放由 OH_JSVM_CreateReference 创建的引用，确保对象在不再被使用时能够被正确地释放和回收，避免内存泄漏</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReferenceRef</td> <td class="cellrowborder" valign="top" width="50%">增加由OH_JSVM_CreateReference 创建的引用的引用计数，以确保对象在有引用时不会被提前释放</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReferenceUnref</td> <td class="cellrowborder" valign="top" width="50%">减少由OH_JSVM_CreateReference 创建的引用的引用计数，以确保没有任何引用指向该对象时能正确地释放和回收</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetReferenceValue</td> <td class="cellrowborder" valign="top" width="50%">返回由 OH_JSVM_CreateReference 创建的引用的对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RetainScript</td> <td class="cellrowborder" valign="top" width="50%">持久化保存一个 JSVM_Script, 使其能够跨过当前 scope 使用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReleaseScript</td> <td class="cellrowborder" valign="top" width="50%">释放持久化保存过的 JSVM_Script，释放之后 JSVM_Script 不再可用，应当置为空</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>通过handle scope保护在scope范围内创建的对象在该范围内不被回收。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_HandleScope scope;</li><li>OH_JSVM_OpenHandleScope(<span class="hljs-built_in">env</span>, &amp;scope);</li><li>JSVM_Value obj = nullptr;</li><li>OH_JSVM_CreateObject(<span class="hljs-built_in">env</span>, &amp;obj);</li><li>OH_JSVM_CloseHandleScope(<span class="hljs-built_in">env</span>, scope);</li></ol></pre></div></div> <p>通过escapable handle scope保护在scope范围内创建的对象在父作用域范围内不被回收</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-sql" data-highlighted="yes"><ol class="linenums"><li>JSVM_EscapableHandleScope <span class="hljs-keyword">scope</span>;</li><li>JSVM_CALL(OH_JSVM_OpenEscapableHandleScope(env, <span class="hljs-operator">&amp;</span><span class="hljs-keyword">scope</span>));</li><li>JSVM_Value output <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>;</li><li>JSVM_Value escapee <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>;</li><li>JSVM_CALL(OH_JSVM_CreateObject(env, <span class="hljs-operator">&amp;</span>output));</li><li>JSVM_CALL(OH_JSVM_EscapeHandle(env, <span class="hljs-keyword">scope</span>, output, <span class="hljs-operator">&amp;</span>escapee));</li><li>JSVM_CALL(OH_JSVM_CloseEscapableHandleScope(env, <span class="hljs-keyword">scope</span>));</li><li><span class="hljs-keyword">return</span> escapee;</li></ol></pre></div></div> <p>通过CreateReference创建对象引用和释放</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">obj</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateObject</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">obj</span>);</li><li><span class="hljs-comment">// 创建引用</span></li><li><span class="hljs-variable">JSVM_Ref</span> <span class="hljs-variable">reference</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateReference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">obj</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">reference</span>);</li><li>
</li><li><span class="hljs-comment">// 使用引用</span></li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">result</span>;</li><li><span class="hljs-title function_">OH_JSVM_GetReferenceValue</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">reference</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>
</li><li><span class="hljs-comment">// 释放引用</span></li><li><span class="hljs-title function_">OH_JSVM_DeleteReference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">reference</span>);</li></ol></pre></div></div> <p>通过 RetainScript 持久化保存 JSVM_Script 并使用</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li>JSVM_HandleScope scope;</li><li>JSVM_CALL(OH_JSVM_OpenHandleScope(env, &amp;scope));</li><li>JSVM_Script script;</li><li>JSVM_Value jsSrc;</li><li>std::string src(<span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">let a = 37;</span></li><li><span class="hljs-string">a = a * 9;</span></li><li><span class="hljs-string">)JS"</span>);</li><li>JSVM_CALL(OH_JSVM_CreateStringUtf8(env, src.c_str(), src.size(), &amp;jsSrc));</li><li>JSVM_CALL(OH_JSVM_CompileScriptWithOptions(env, jsSrc, <span class="hljs-number">0</span>, nullptr, &amp;script));</li><li>JSVM_CALL(OH_JSVM_RetainScript(env, script));</li><li>JSVM_CALL(OH_JSVM_CloseHandleScope(env, scope));</li><li>
</li><li>// 使用JSVM_Script</li><li>JSVM_CALL(OH_JSVM_OpenHandleScope(env, &amp;scope));</li><li>JSVM_Value result;</li><li>JSVM_CALL(OH_JSVM_RunScript(env, script, &amp;result));</li><li>
</li><li>// 释放JSVM_Script，并置空</li><li>JSVM_CALL(OH_JSVM_ReleaseScript(env, script));</li><li>script = nullptr;</li><li>JSVM_CALL(OH_JSVM_CloseHandleScope(env, scope));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="创建js对象类型和基本类型">创建JS对象类型和基本类型<i class="anchor-icon anchor-icon-link" anchorid="创建js对象类型和基本类型" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>创建JS对象类型和基本类型。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.19.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.19.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateArray</td> <td class="cellrowborder" valign="top" width="50%">创建一个新的 JavaScript 数组对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateArrayWithLength</td> <td class="cellrowborder" valign="top" width="50%">创建一个指定长度的 JavaScript 数组对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">创建一个指定大小的 ArrayBuffer 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateDate</td> <td class="cellrowborder" valign="top" width="50%">创建了一个表示给定毫秒数的 Date 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateExternal</td> <td class="cellrowborder" valign="top" width="50%">创建一个包装了外部指针的 JavaScript 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateObject</td> <td class="cellrowborder" valign="top" width="50%">创建一个默认的JavaScript Object对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSymbol</td> <td class="cellrowborder" valign="top" width="50%">根据给定的描述符创建一个 Symbol 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SymbolFor</td> <td class="cellrowborder" valign="top" width="50%">在全局注册表中搜索具有给定描述的现有Symbol，如果该Symbol已经存在，它将被返回，否则将在注册表中创建一个新Symbol</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateTypedarray</td> <td class="cellrowborder" valign="top" width="50%">在现有的 ArrayBuffer 上创建一个 JavaScript TypedArray 对象，TypedArray 对象在底层数据缓冲区上提供类似数组的视图，其中每个元素都具有相同的底层二进制标量数据类型</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateDataview</td> <td class="cellrowborder" valign="top" width="50%">在现有的 ArrayBuffer 上创建一个 JavaScript DataView 对象，DataView 对象在底层数据缓冲区上提供类似数组的视图</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateInt32</td> <td class="cellrowborder" valign="top" width="50%">根据 Int32_t 类型对象创建 JavaScript number 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateUint32</td> <td class="cellrowborder" valign="top" width="50%">根据 Uint32_t 类型对象创建 JavaScript number 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateInt64</td> <td class="cellrowborder" valign="top" width="50%">根据 Int64_t 类型对象创建 JavaScript number 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateDouble</td> <td class="cellrowborder" valign="top" width="50%">根据 Double 类型对象创建 JavaScript number 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateBigintInt64</td> <td class="cellrowborder" valign="top" width="50%">根据 Int64 类型对象创建 JavaScript Bigint 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateBigintUint64</td> <td class="cellrowborder" valign="top" width="50%">根据 Uint64 类型对象创建 JavaScript Bigint 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateBigintWords</td> <td class="cellrowborder" valign="top" width="50%">根据给定的 Uint64_t 数组创建一个 JavaScript BigInt 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringLatin1</td> <td class="cellrowborder" valign="top" width="50%">根据 Latin-1 编码的字符串创建一个 JavaScript string 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringUtf16</td> <td class="cellrowborder" valign="top" width="50%">根据 Utf16 编码的字符串创建一个 JavaScript string 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringUtf8</td> <td class="cellrowborder" valign="top" width="50%">根据 Utf8 编码的字符串创建一个 JavaScript string 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateMap</td> <td class="cellrowborder" valign="top" width="50%">创建一个新的 JavaScript Map对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateRegExp</td> <td class="cellrowborder" valign="top" width="50%">根据输入的字符串创建一个JavaScript 正则对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSet</td> <td class="cellrowborder" valign="top" width="50%">创建一个新的 JavaScript Set对象</td> </tr>  </tbody></table></div> </div> <p>场景示例:</p> <p>创建指定长度的JavaScript数组。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>size_t arrayLength = 2;</li><li>JSVM_Value arr;</li><li>
</li><li>OH_JSVM_CreateArrayWithLength(<span class="hljs-built_in">env</span>, arrayLength, &amp;arr);</li><li><span class="hljs-keyword">for</span> (uint32_t i = 0; i &lt; arrayLength; i++)</li><li>{</li><li>    JSVM_Value element;</li><li>    OH_JSVM_CreateUint32(<span class="hljs-built_in">env</span>, i * 2, &amp;element);</li><li>    OH_JSVM_SetElement(<span class="hljs-built_in">env</span>, arr, i, element);</li><li>}</li></ol></pre></div></div> <p>创建TypedArray，以Int32Array为例：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value arrayBuffer = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">void</span> *arrayBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">size_t</span> arrayBufferSize = <span class="hljs-number">16</span>;</li><li><span class="hljs-type">size_t</span> typedArrayLength = <span class="hljs-number">4</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateArraybuffer</span>(env, arrayBufferSize, &amp;arrayBufferPtr, &amp;arrayBuffer);</li><li>
</li><li><span class="hljs-type">void</span> *tmpArrayBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">size_t</span> arrayBufferLength = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">OH_JSVM_GetArraybufferInfo</span>(env, arrayBuffer, &amp;tmpArrayBufferPtr, &amp;arrayBufferLength);</li><li>
</li><li>JSVM_Value result;</li><li><span class="hljs-built_in">OH_JSVM_CreateTypedarray</span>(env, JSVM_TypedarrayType::JSVM_INT32_ARRAY, typedArrayLength, arrayBuffer, <span class="hljs-number">0</span>, &amp;result);</li><li><span class="hljs-keyword">return</span> result;</li></ol></pre></div></div> <p>创建number和string：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *testStringStr = <span class="hljs-string">"test"</span>;</li><li>JSVM_Value testString = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, testStringStr, <span class="hljs-built_in">strlen</span>(testStringStr), &amp;testString);</li><li>
</li><li>JSVM_Value testNumber1 = <span class="hljs-literal">nullptr</span>;</li><li>JSVM_Value testNumber2 = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateDouble</span>(env, <span class="hljs-number">10.1</span>, &amp;testNumber1);</li><li><span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">10</span>, &amp;testNumber2);</li></ol></pre></div></div> <p>创建Map：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = nullptr;</li><li>OH_JSVM_CreateMap(<span class="hljs-built_in">env</span>, &amp;value);</li></ol></pre></div></div> <p>创建RegExp：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> testStr[] = <span class="hljs-string">"ab+c"</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, testStr, <span class="hljs-built_in">strlen</span>(testStr), &amp;value);</li><li>JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateRegExp</span>(env, value, JSVM_RegExpFlags::JSVM_REGEXP_GLOBAL, &amp;result);</li></ol></pre></div></div> <p>创建Set：</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = nullptr;</li><li>OH_JSVM_CreateSet(<span class="hljs-built_in">env</span>, &amp;value);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="从js类型获取c类型js类型信息">从JS类型获取C类型&amp;JS类型信息<i class="anchor-icon anchor-icon-link" anchorid="从js类型获取c类型js类型信息" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>从JS类型获取C类型&amp;JS类型信息。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.20.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetArrayLength</td> <td class="cellrowborder" valign="top" width="50%">返回 Array 对象的长度</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetArraybufferInfo</td> <td class="cellrowborder" valign="top" width="50%">检索 ArrayBuffer 的底层数据缓冲区及其长度</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetPrototype</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript 对象的原型</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetTypedarrayInfo</td> <td class="cellrowborder" valign="top" width="50%">获取 TypedArray（类型化数组）对象的信息</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetDataviewInfo</td> <td class="cellrowborder" valign="top" width="50%">获取 Dataview 对象的信息</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetDateValue</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript Date 的时间值的 Double 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueBool</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript Boolean 的 C 布尔基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueDouble</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript number 的 Double 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueBigintInt64</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript BigInt 的 Int64_t 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueBigintUint64</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript BigInt 的 Uint64_t 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueBigintWords</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript BigInt 对象的底层数据，即 BigInt 数据的字词表示</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueExternal</td> <td class="cellrowborder" valign="top" width="50%">获取先前传递给 OH_JSVM_CreateExternal 的外部数据指针</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueInt32</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript number 的 Int32 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueInt64</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript number 的 Int64 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringLatin1</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript string 对象的 Latin1 编码字符串</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringUtf8</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript string 对象的 Utf8 编码字符串</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringUtf16</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript string 对象的 Utf16 编码字符串</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueUint32</td> <td class="cellrowborder" valign="top" width="50%">获取给定 JavaScript number 的 Uint32 基础类型值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetBoolean</td> <td class="cellrowborder" valign="top" width="50%">返回用于表示给定布尔值的 JavaScript 单例对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetGlobal</td> <td class="cellrowborder" valign="top" width="50%">返回当前环境中的全局 global 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetNull</td> <td class="cellrowborder" valign="top" width="50%">返回 JavaScript null 对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetUndefined</td> <td class="cellrowborder" valign="top" width="50%">返回 JavaScript Undefined 对象</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>创建64位的 BigInt，并获取64位 Int 值。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int64_t</span> testValue = INT64_MAX;</li><li>JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateBigintInt64</span>(env, testValue, &amp;result);</li><li><span class="hljs-type">int64_t</span> resultValue = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">bool</span> flag = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_GetValueBigintInt64</span>(env, result, &amp;resultValue, &amp;flag);</li></ol></pre></div></div> <p>创建一个 Int32Array，并获取其长度、byteOffset 等信息。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value arrayBuffer = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">void</span> *arrayBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">size_t</span> arrayBufferSize = <span class="hljs-number">16</span>;</li><li><span class="hljs-type">size_t</span> typedArrayLength = <span class="hljs-number">4</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateArraybuffer</span>(env, arrayBufferSize, &amp;arrayBufferPtr, &amp;arrayBuffer);</li><li>
</li><li><span class="hljs-type">bool</span> isArrayBuffer = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_IsArraybuffer</span>(env, arrayBuffer, &amp;isArrayBuffer);</li><li>
</li><li>JSVM_Value result;</li><li><span class="hljs-built_in">OH_JSVM_CreateTypedarray</span>(env, JSVM_TypedarrayType::JSVM_INT32_ARRAY, typedArrayLength, arrayBuffer, <span class="hljs-number">0</span>, &amp;result);</li><li>
</li><li><span class="hljs-type">bool</span> isTypedArray = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_IsTypedarray</span>(env, result, &amp;isTypedArray);</li><li>
</li><li>
</li><li>JSVM_TypedarrayType type;</li><li><span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>JSVM_Value retArrayBuffer;</li><li><span class="hljs-type">size_t</span> byteOffset = <span class="hljs-number">-1</span>;</li><li><span class="hljs-built_in">OH_JSVM_GetTypedarrayInfo</span>(env, result, &amp;type, &amp;length, &amp;data, &amp;retArrayBuffer, &amp;byteOffset);</li><li>
</li><li>
</li><li><span class="hljs-type">bool</span> retIsArrayBuffer = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_IsArraybuffer</span>(env, retArrayBuffer, &amp;retIsArrayBuffer);</li><li><span class="hljs-type">void</span> *tmpArrayBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">size_t</span> arrayBufferLength = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">OH_JSVM_GetArraybufferInfo</span>(env, retArrayBuffer, &amp;tmpArrayBufferPtr, &amp;arrayBufferLength);</li></ol></pre></div></div> <p>根据 UTF-8 编码的 C 字符串创建一个 JavaScript 字符串，以及获取给定 JavaScript 字符串的 UTF-8 编码 C 字符串。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *testStringStr = <span class="hljs-string">"testString"</span>;</li><li>JSVM_Value testString = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, testStringStr, <span class="hljs-built_in">strlen</span>(testStringStr), &amp;testString));</li><li>
</li><li><span class="hljs-type">char</span> buffer[<span class="hljs-number">128</span>];</li><li><span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">128</span>;</li><li><span class="hljs-type">size_t</span> copied = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, testString, buffer, bufferSize, &amp;copied));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="js值操作和抽象操作">JS值操作和抽象操作<i class="anchor-icon anchor-icon-link" anchorid="js值操作和抽象操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>JS值操作和抽象操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.21.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CoerceToBool</td> <td class="cellrowborder" valign="top" width="50%">将目标值转换为 Boolean 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CoerceToNumber</td> <td class="cellrowborder" valign="top" width="50%">将目标值转换为 Number 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CoerceToObject</td> <td class="cellrowborder" valign="top" width="50%">将目标值转换为 Object 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CoerceToString</td> <td class="cellrowborder" valign="top" width="50%">将目标值转换为 String 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CoerceToBigInt</td> <td class="cellrowborder" valign="top" width="50%">将目标值转换为 BigInt 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Typeof</td> <td class="cellrowborder" valign="top" width="50%">返回 JavaScript 对象的类型</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Instanceof</td> <td class="cellrowborder" valign="top" width="50%">判断一个对象是否是某个构造函数的实例</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsArray</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 Array 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 ArrayBuffer 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsDate</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 Date 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsTypedarray</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 TypedArray 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsDataview</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 DataView 类型对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsUndefined</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Undefined。这相当于JS中的value === undefined。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsNull</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Null对象。这相当于JS中的value === null。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsNullOrUndefined</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Null或Undefined。这相当于JS中的value == null。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsBoolean</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Boolean。这相当于JS中的typeof value === 'boolean'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsNumber</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Number。这相当于JS中的typeof value === 'number'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsString</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为String。这相当于JS中的typeof value === 'string'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsSymbol</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Symbol。这相当于JS中的typeof value === 'symbol'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsFunction</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Function。这相当于JS中的typeof value === 'function'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsObject</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Object。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsBigInt</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为BigInt。这相当于JS中的typeof value === 'bigint'。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsConstructor</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为构造函数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsMap</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Map。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsSet</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为Set。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsRegExp</td> <td class="cellrowborder" valign="top" width="50%">此API检查传入的值是否为RegExp。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_StrictEquals</td> <td class="cellrowborder" valign="top" width="50%">判断两个 JSVM_Value 对象是否严格相等</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Equals</td> <td class="cellrowborder" valign="top" width="50%">判断两个 JSVM_Value 对象是否宽松相等</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DetachArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">调用 ArrayBuffer 对象的Detach操作</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsDetachedArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">检查给定的 ArrayBuffer 是否已被分离(detached)</td> </tr>  </tbody></table></div> </div> <p>场景示例:</p> <p>判断JS值是否为Array类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-php" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value <span class="hljs-keyword">array</span> = nullptr;</li><li><span class="hljs-title function_ invoke__">OH_JSVM_CreateArray</span>(env, &amp;<span class="hljs-keyword">array</span>);</li><li><span class="hljs-keyword">bool</span> isArray = <span class="hljs-literal">false</span>;</li><li><span class="hljs-title function_ invoke__">OH_JSVM_IsArray</span>(env, <span class="hljs-keyword">array</span>, &amp;isArray);</li></ol></pre></div></div> <p>将int32类型的目标值转换为string类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> num = <span class="hljs-number">123</span>;</li><li>JSVM_Value intValue;</li><li><span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, num, &amp;intValue);</li><li>JSVM_Value stringValue;</li><li><span class="hljs-built_in">OH_JSVM_CoerceToString</span>(env, intValue, &amp;stringValue);</li><li>
</li><li><span class="hljs-type">char</span> buffer[<span class="hljs-number">128</span>];</li><li><span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">128</span>;</li><li><span class="hljs-type">size_t</span> copied = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, stringValue, buffer, bufferSize, &amp;copied);</li><li><span class="hljs-comment">// buffer:"123";</span></li></ol></pre></div></div> <p>将boolean类型的目标值转换为bigint类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value boolValue;</li><li><span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, false, &amp;boolValue);</li><li>JSVM_Value bigIntValue;</li><li><span class="hljs-built_in">OH_JSVM_CoerceToBigInt</span>(env, boolValue, &amp;bigIntValue);</li></ol></pre></div></div> <p>判断两个JSVM_Value对象类型是否严格相同：先比较操作数类型，操作数类型不同就是不相等，操作数类型相同时，比较值是否相等，相等才返回true。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = nullptr;</li><li>JSVM_Value value1 = nullptr;</li><li>OH_JSVM_CreateArray(<span class="hljs-built_in">env</span>, &amp;value);</li><li>
</li><li>OH_JSVM_CreateInt32(<span class="hljs-built_in">env</span>, 10, &amp;value1);</li><li>bool isArray = <span class="hljs-literal">true</span>;</li><li>OH_JSVM_StrictEquals(<span class="hljs-built_in">env</span>, value, value, &amp;isArray);</li></ol></pre></div></div> <p>判断两个JSVM_Value对象类型是否宽松相同：判断两个操作数的类型是否相同，若不相同，且可以转换为相同的数据类型，转换为相同的数据类型后，值做严格相等比较，其他的都返回false。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_HandleScope handleScope;</li><li>OH_JSVM_OpenHandleScope(<span class="hljs-built_in">env</span>, &amp;handleScope);</li><li>const char testStr[] = <span class="hljs-string">"1"</span>;</li><li>JSVM_Value lhs = nullptr;</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, testStr, strlen(testStr), &amp;lhs);</li><li>JSVM_Value rhs;</li><li>OH_JSVM_CreateInt32(<span class="hljs-built_in">env</span>, 1, &amp;rhs);</li><li>bool isEquals = <span class="hljs-literal">false</span>;</li><li>OH_JSVM_Equals(<span class="hljs-built_in">env</span>, lhs, rhs, &amp;isEquals); // 这里isEquals的值是<span class="hljs-literal">true</span></li><li>OH_JSVM_CloseHandleScope(<span class="hljs-built_in">env</span>, handleScope);</li></ol></pre></div></div> <p>判断传入的JS值是否为构造函数</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">JSVM_Value <span class="hljs-title">SayHello</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li>JSVM_CallbackStruct param;</li><li>param.data = <span class="hljs-literal">nullptr</span>;</li><li>param.callback = SayHello;</li><li><span class="hljs-built_in">OH_JSVM_CreateFunction</span>(env, <span class="hljs-string">"func"</span>, JSVM_AUTO_LENGTH, &amp;param, &amp;value);</li><li><span class="hljs-type">bool</span> isConstructor = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_IsConstructor</span>(env, value, &amp;isConstructor); <span class="hljs-comment">// 这里isConstructor的值是true</span></li></ol></pre></div></div> <p>判断传入的JS值是否为Map类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = nullptr;</li><li>OH_JSVM_CreateMap(<span class="hljs-built_in">env</span>, &amp;value);</li><li>bool isMap = <span class="hljs-literal">false</span>;</li><li>OH_JSVM_IsMap(<span class="hljs-built_in">env</span>, value, &amp;isMap); // 这里isMap的值是<span class="hljs-literal">true</span></li></ol></pre></div></div> <p>判断传入的JS值是否为Set类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value;</li><li>OH_JSVM_CreateSet(<span class="hljs-built_in">env</span>, &amp;value);</li><li>bool isSet = <span class="hljs-literal">false</span>;</li><li>OH_JSVM_IsSet(<span class="hljs-built_in">env</span>, value, &amp;isSet); // 这里isSet的值是<span class="hljs-literal">true</span></li></ol></pre></div></div> <p>判断JS值是否为RegExp类型</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> testStr[] = <span class="hljs-string">"ab+c"</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, testStr, <span class="hljs-built_in">strlen</span>(testStr), &amp;value);</li><li>JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateRegExp</span>(env, value, JSVM_RegExpFlags::JSVM_REGEXP_GLOBAL, &amp;result);</li><li><span class="hljs-type">bool</span> isRegExp = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_IsRegExp</span>(env, result, &amp;isRegExp);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="js属性操作">JS属性操作<i class="anchor-icon anchor-icon-link" anchorid="js属性操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>JS对象属性的增加、删除、获取和判断。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.22.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.22.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetPropertyNames</td> <td class="cellrowborder" valign="top" width="50%">获取给定对象的所有可枚举属性名称, 结果变量将存储一个包含所有可枚举属性名称的JavaScript数组。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetAllPropertyNames</td> <td class="cellrowborder" valign="top" width="50%">获取给定对象的所有可用属性名称, 结果变量将存储一个包含所有可枚举属性名称的JavaScript数组。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetProperty</td> <td class="cellrowborder" valign="top" width="50%">为给定对象设置一个属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称，检索目标对象的属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_HasProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称，查询目标对象是否有此属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DeleteProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称，删除目标对象属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_HasOwnProperty</td> <td class="cellrowborder" valign="top" width="50%">检查目标对象是否具有指定的自有属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetNamedProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称为目标对象设置属性，此方法等效于使用从作为 utf8Name 传入的字符串创建的 JSVM_Value 调用 OH_JSVM_SetProperty。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetNamedProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称，检索目标对象的属性，此方法等效于使用从作为 utf8Name 传入的字符串创建的 JSVM_Value 调用 OH_JSVM_GetProperty。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_HasNamedProperty</td> <td class="cellrowborder" valign="top" width="50%">用给定的属性的名称，查询目标对象是否有此属性，此方法等效于使用从作为 utf8Name 传入的字符串创建的 JSVM_Value 调用 OH_JSVM_HasProperty。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetElement</td> <td class="cellrowborder" valign="top" width="50%">在给定对象的指定索引处设置元素。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetElement</td> <td class="cellrowborder" valign="top" width="50%">获取给定对象指定索引处的元素。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_HasElement</td> <td class="cellrowborder" valign="top" width="50%">若给定对象的指定索引处拥有属性，获取该元素。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DeleteElement</td> <td class="cellrowborder" valign="top" width="50%">尝试删除给定对象的指定索引处的元素。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineProperties</td> <td class="cellrowborder" valign="top" width="50%">批量的向给定对象中定义属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectFreeze</td> <td class="cellrowborder" valign="top" width="50%">冻结给定的对象,防止向其添加新属性，删除现有属性，防止更改现有属性的可枚举性、可配置性或可写性，并防止更改现有属性的值。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectSeal</td> <td class="cellrowborder" valign="top" width="50%">密封给定的对象。这可以防止向其添加新属性，以及将所有现有属性标记为不可配置。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectSetPrototypeOf</td> <td class="cellrowborder" valign="top" width="50%">为给定对象设置一个原型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectGetPrototypeOf</td> <td class="cellrowborder" valign="top" width="50%">获取给定JavaScript对象的原型。</td> </tr>  </tbody></table></div> </div> <p>场景示例:</p> <p>JS对象属性的增加、删除、获取和判断。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个空对象</span></li><li>JSVM_Value myObject = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;myObject);</li><li>
</li><li><span class="hljs-comment">// 设置属性</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *testNameStr = <span class="hljs-string">"John Doe"</span>;</li><li>JSVM_Value propValue = <span class="hljs-literal">nullptr</span>;</li><li>JSVM_Value key = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"name"</span>, JSVM_AUTO_LENGTH, &amp;key);</li><li><span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, testNameStr, <span class="hljs-built_in">strlen</span>(testNameStr), &amp;propValue);</li><li><span class="hljs-built_in">OH_JSVM_SetProperty</span>(env, myObject, key, propValue);</li><li>
</li><li><span class="hljs-comment">// 获取属性</span></li><li>JSVM_Value propResult = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, myObject, key, &amp;propResult);</li><li>
</li><li><span class="hljs-comment">// 检查属性是否存在</span></li><li><span class="hljs-type">bool</span> hasProperty = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">OH_JSVM_HasNamedProperty</span>(env, myObject, <span class="hljs-string">"name"</span>, &amp;hasProperty);</li><li>    <span class="hljs-comment">// 属性存在，做相应处理...</span></li><li>    <span class="hljs-keyword">if</span> (hasProperty)</li><li>    {</li><li>        <span class="hljs-comment">// 获取对象的所有属性名</span></li><li>        JSVM_Value propNames = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetPropertyNames</span>(env, myObject, &amp;propNames);</li><li>
</li><li>        <span class="hljs-type">bool</span> isArray = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_IsArray</span>(env, propNames, &amp;isArray);</li><li>
</li><li>        <span class="hljs-type">uint32_t</span> arrayLength = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetArrayLength</span>(env, propNames, &amp;arrayLength);</li><li>        <span class="hljs-comment">// 遍历属性元素</span></li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; arrayLength; i++)</li><li>        {</li><li>            <span class="hljs-type">bool</span> hasElement = <span class="hljs-literal">false</span>;</li><li>            <span class="hljs-built_in">OH_JSVM_HasElement</span>(env, propNames, i, &amp;hasElement);</li><li>
</li><li>            JSVM_Value propName = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-built_in">OH_JSVM_GetElement</span>(env, propNames, i, &amp;propName);</li><li>
</li><li>            <span class="hljs-type">bool</span> hasProp = <span class="hljs-literal">false</span>;</li><li>            <span class="hljs-built_in">OH_JSVM_HasProperty</span>(env, myObject, propName, &amp;hasProp);</li><li>
</li><li>            JSVM_Value propValue = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, myObject, propName, &amp;propValue);</li><li>        }</li><li>    }</li><li>
</li><li><span class="hljs-comment">// 删除属性</span></li><li><span class="hljs-built_in">OH_JSVM_DeleteProperty</span>(env, myObject, key, &amp;hasProperty);</li><li>
</li><li><span class="hljs-comment">// 设置对象原型</span></li><li>JSVM_Value value;</li><li><span class="hljs-built_in">OH_JSVM_CreateSet</span>(env, &amp;value);</li><li><span class="hljs-built_in">OH_JSVM_ObjectSetPrototypeOf</span>(env, myObject, value);</li><li>
</li><li><span class="hljs-comment">// 获取对象原型</span></li><li>JSVM_Value proto;</li><li><span class="hljs-built_in">OH_JSVM_ObjectGetPrototypeOf</span>(env, myObject, &amp;proto);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="js函数操作">JS函数操作<i class="anchor-icon anchor-icon-link" anchorid="js函数操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>JS函数操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.23.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.23.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CallFunction</td> <td class="cellrowborder" valign="top" width="50%">在C/C++侧调用JS方法</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateFunction</td> <td class="cellrowborder" valign="top" width="50%">用于创建JavaScript函数,用于从JavaScript环境中调用C/C++代码中的函数</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetCbInfo</td> <td class="cellrowborder" valign="top" width="50%">从给定的callback info中获取有关调用的详细信息，如参数和this指针</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetNewTarget</td> <td class="cellrowborder" valign="top" width="50%">获取构造函数调用的new.target</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_NewInstance</td> <td class="cellrowborder" valign="top" width="50%">通过给定的构造函数，构建一个实例</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateFunctionWithScript</td> <td class="cellrowborder" valign="top" width="50%">根据传入的函数体和函数参数列表，创建一个新的 JavaScript Function对象</td> </tr>  </tbody></table></div> </div> <p>场景示例:</p> <p>创建JavaScript函数操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">JSVM_Value <span class="hljs-title">SayHello</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello\n"</span>);</li><li>    JSVM_Value ret;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">2</span>, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">JsvmCreateFunction</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_CallbackStruct param;</li><li>    param.data = <span class="hljs-literal">nullptr</span>;</li><li>    param.callback = SayHello;</li><li>
</li><li>    JSVM_Value funcValue = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateFunction</span>(env, <span class="hljs-string">"func"</span>, JSVM_AUTO_LENGTH, &amp;param, &amp;funcValue);</li><li>    <span class="hljs-keyword">return</span> funcValue;</li><li>}</li></ol></pre></div></div> <p>在C/C++侧调用JS方法。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CallFunction</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Wrong number of arguments"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    JSVM_ValueType valuetype;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_Typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valuetype));</li><li>    <span class="hljs-keyword">if</span> (valuetype != JSVM_ValueType::JSVM_FUNCTION) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Wrong type of argment. Expects a function."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    JSVM_Value global;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;global));</li><li>
</li><li>    JSVM_Value ret;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CallFunction</span>(env, global, args[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;ret));</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> <p>创建JavaScript函数:</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>JSVM_Value script;</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"return a + b;"</span>, JSVM_AUTO_LENGTH, &amp;script);</li><li>JSVM_Value param1;</li><li>JSVM_Value param2;</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"a"</span>, JSVM_AUTO_LENGTH, &amp;param1);</li><li>OH_JSVM_CreateStringUtf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"b"</span>, JSVM_AUTO_LENGTH, &amp;param2);</li><li>JSVM_Value argus[] = {param1, param2};</li><li>JSVM_Value func;</li><li>OH_JSVM_CreateFunctionWithScript(<span class="hljs-built_in">env</span>, <span class="hljs-string">"add"</span>, JSVM_AUTO_LENGTH, 2, argus, script, &amp;func);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="对象绑定操作">对象绑定操作<i class="anchor-icon anchor-icon-link" anchorid="对象绑定操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>对象绑定操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.24.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.24.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineClass</td> <td class="cellrowborder" valign="top" width="50%">用于在JavaScript中定义一个类，并与对应的C类进行封装和交互。它提供了创建类的构造函数、定义属性和方法的能力，以及在C和JavaScript之间进行数据交互的支持。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Wrap</td> <td class="cellrowborder" valign="top" width="50%">在 JavaScript 对象中封装原生实例。稍后可以使用 OH_JSVM_Unwrap() 检索原生实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Unwrap</td> <td class="cellrowborder" valign="top" width="50%">使用 OH_JSVM_Wrap() 检索先前封装在 JavaScript 对象中的原生实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RemoveWrap</td> <td class="cellrowborder" valign="top" width="50%">检索先前封装在 JavaScript 对象中的原生实例并移除封装。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_TypeTagObject</td> <td class="cellrowborder" valign="top" width="50%">将 type_tag 指针的值与 JavaScript 对象或外部对象相关联。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CheckObjectTypeTag</td> <td class="cellrowborder" valign="top" width="50%">检查给定的类型标签是否与对象上的类型标签匹配。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AddFinalizer</td> <td class="cellrowborder" valign="top" width="50%">为对象添加 JSVM_Finalize 回调，以便在 JavaScript 对象被垃圾回收时调用来释放原生对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineClassWithPropertyHandler</td> <td class="cellrowborder" valign="top" width="50%">定义一个具有给定类名、构造函数、属性和回调处理程序的JavaScript类，并作为函数回调进行调用。属性操作包括getter、setter、deleter、enumerator等。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineClassWithOptions</td> <td class="cellrowborder" valign="top" width="50%">定义一个具有给定类名、构造函数、属性和回调处理程序、父类的JavaScript类，并根据传入了DefineClassOptions来决定是否需要为所定义的Class设置属性代理、预留internal-field槽位、为class作为函数进行调用时设置函数回调。</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>对象绑定操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> aa = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">AssertEqual</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>
</li><li>    <span class="hljs-type">bool</span> isStrictEquals = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_StrictEquals</span>(env, args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>], &amp;isStrictEquals);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestWrap</span><span class="hljs-params">(napi_env env1, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"testWrap start"</span>);</li><li>    JSVM_InitOptions init_options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;init_options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(init_options));</li><li>    <span class="hljs-keyword">if</span> (aa == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;init_options);</li><li>        aa++;</li><li>    }</li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm);</li><li>    JSVM_VMScope vm_scope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vm_scope);</li><li>    JSVM_Env env;</li><li>    JSVM_CallbackStruct param[<span class="hljs-number">1</span>];</li><li>    param[<span class="hljs-number">0</span>].data = <span class="hljs-literal">nullptr</span>;</li><li>    param[<span class="hljs-number">0</span>].callback = AssertEqual;</li><li>    JSVM_PropertyDescriptor descriptor[] = {</li><li>        {<span class="hljs-string">"assertEqual"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    JSVM_HandleScope handlescope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handlescope);</li><li>    JSVM_Value testClass = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_CallbackStruct param1;</li><li>    param1.data = <span class="hljs-literal">nullptr</span>;</li><li>    param1.callback = [](JSVM_Env env, JSVM_CallbackInfo info) -&gt; JSVM_Value {</li><li>        JSVM_Value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>        <span class="hljs-keyword">return</span> thisVar;</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_DefineClass</span>(env, <span class="hljs-string">"TestClass"</span>, JSVM_AUTO_LENGTH, &amp;param1, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;testClass);</li><li>
</li><li>    JSVM_Value instanceValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_NewInstance</span>(env, testClass, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;instanceValue);</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *testStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_Wrap</span>(</li><li>        env, instanceValue, (<span class="hljs-type">void</span> *)testStr, [](JSVM_Env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint) {}, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *tmpTestStr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_Unwrap</span>(env, instanceValue, (<span class="hljs-type">void</span> **)&amp;tmpTestStr);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *tmpTestStr1 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_RemoveWrap</span>(env, instanceValue, (<span class="hljs-type">void</span> **)&amp;tmpTestStr1);</li><li>    <span class="hljs-built_in">OH_JSVM_Unwrap</span>(env, instanceValue, (<span class="hljs-type">void</span> **)&amp;tmpTestStr1);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handlescope);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vm_scope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>    <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"testWrap pass"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>场景示例：</p> <p>对象绑定及监听拦截属性操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">int</span> <span class="hljs-variable">aa</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">hello</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_CallbackInfo</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">output</span>;</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetCbInfo</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">data</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, (<span class="hljs-variable">char</span> *)<span class="hljs-variable">data</span>, <span class="hljs-title function_">strlen</span>((<span class="hljs-variable">char</span> *)<span class="hljs-variable">data</span>), &amp;<span class="hljs-title class_">output</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">output</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_CallbackStruct</span> <span class="hljs-variable">hello_cb</span> = {<span class="hljs-variable">hello</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-string">"Hello"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">intptr_t</span> <span class="hljs-variable">externals</span>[] = {</li><li>    (<span class="hljs-variable">intptr_t</span>)&amp;<span class="hljs-title class_">hello_cb</span>,</li><li>    <span class="hljs-number">0</span>,</li><li>};</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">test1</span>() { <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"test1 called"</span>); }</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Test</span> {</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">ptr1</span>;</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">ptr2</span>;</li><li>};</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">assertEqual</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_CallbackInfo</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-title function_">JSVM_CALL</span>(<span class="hljs-title function_">OH_JSVM_GetCbInfo</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">NULL</span>, <span class="hljs-variable">NULL</span>));</li><li>
</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">isStrictEquals</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_StrictEquals</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">isStrictEquals</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">GetPropertyCbInfo</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由对象上的获取请求触发的</span></li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">strValue</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">strValue</span>, <span class="hljs-number">300</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr</span>[] = <span class="hljs-string">"new return value hahaha from name listening"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr</span>), &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"GetPropertyCbInfo wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">SetPropertyCbInfo</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">property</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由对象上的设置请求触发的</span></li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">strValue</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">strValue</span>, <span class="hljs-number">300</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr</span>[] = <span class="hljs-string">"new return value hahaha from name listening"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr</span>), &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"SetPropertyCbInfo wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">DeleterPropertyCbInfo</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由对象上的删除请求触发的</span></li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">strValue</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">strValue</span>, <span class="hljs-number">300</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">returnValue</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetBoolean</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">returnValue</span>, &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"DeleterPropertyCbInfo wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">EnumeratorPropertyCbInfo</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由获取对象上的所有属性请求触发的</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">testArray</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateArrayWithLength</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">2</span>, &amp;<span class="hljs-title class_">testArray</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr1</span>[] = <span class="hljs-string">"hahaha"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr1</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr1</span>), &amp;<span class="hljs-title class_">name1</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name2</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr2</span>[] = <span class="hljs-string">"heheheh"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr2</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr2</span>), &amp;<span class="hljs-title class_">name2</span>);</li><li>
</li><li>    <span class="hljs-title function_">OH_JSVM_SetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testArray</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">name1</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testArray</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">name2</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"EnumeratorPropertyCbInfo wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">IndexedPropertyGet</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由获取实例对象的索引属性触发的</span></li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">value</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">value</span>);</li><li>
</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr</span>[] = <span class="hljs-string">"new return value hahaha from index listening"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr</span>), &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"IndexedPropertyGet wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">IndexedPropertySet</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">property</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由设置实例对象的索引属性触发的</span></li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">value</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">value</span>);</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">str</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">property</span>, <span class="hljs-variable">str</span>, <span class="hljs-number">100</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">newStr</span>[] = <span class="hljs-string">"new return value hahaha from name listening"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">newStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">newStr</span>), &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"IndexedPropertySet wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">IndexedPropertyDeleter</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由删除实例对象的索引属性触发的</span></li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">value</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">value</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">newResult</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">returnValue</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetBoolean</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">returnValue</span>, &amp;<span class="hljs-title class_">newResult</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"IndexedPropertyDeleter wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">JSVM_Value</span> <span class="hljs-title function_">IndexedPropertyEnumerator</span>(<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisArg</span>, <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-comment">// 该回调是由获取对象上的所有索引属性请求触发的</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">testArray</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateArrayWithLength</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">2</span>, &amp;<span class="hljs-title class_">testArray</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">index1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">index1</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">index2</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">2</span>, &amp;<span class="hljs-title class_">index2</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testArray</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">index1</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testArray</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">index2</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">signBit</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">wordCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">wordsOut</span>[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span><span class="hljs-variable">ULL</span>, <span class="hljs-number">0</span><span class="hljs-variable">ULL</span>};</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_GetValueBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">signBit</span>, &amp;<span class="hljs-title class_">wordCount</span>, <span class="hljs-variable">wordsOut</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> == <span class="hljs-variable">JSVM_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"IndexedPropertyDeleter wordCount is %{public}zu"</span>, <span class="hljs-variable">wordCount</span>);</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">test</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">Test</span> *&gt;(<span class="hljs-variable">wordsOut</span>);</li><li>        <span class="hljs-variable">typedef</span> <span class="hljs-variable">void</span> (*<span class="hljs-variable">callTest1</span>)();</li><li>        <span class="hljs-variable">callTest1</span> <span class="hljs-variable">callTe</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">callTest1</span>&gt;(<span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span>);</li><li>        <span class="hljs-title function_">callTe</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">TestDefineClassWithProperty</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env1</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"TestDefineClassWithProperty start"</span>);</li><li>    <span class="hljs-variable">JSVM_InitOptions</span> <span class="hljs-variable">init_options</span>;</li><li>    <span class="hljs-title function_">memset</span>(&amp;<span class="hljs-title class_">init_options</span>, <span class="hljs-number">0</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">init_options</span>));</li><li>    <span class="hljs-variable">init_options</span>.<span class="hljs-variable">externalReferences</span> = <span class="hljs-variable">externals</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">aa</span> == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">OH_JSVM_Init</span>(&amp;<span class="hljs-title class_">init_options</span>);</li><li>        <span class="hljs-variable">aa</span>++;</li><li>    }</li><li>    <span class="hljs-variable">JSVM_VM</span> <span class="hljs-variable">vm</span>;</li><li>    <span class="hljs-variable">JSVM_CreateVMOptions</span> <span class="hljs-variable">options</span>;</li><li>    <span class="hljs-title function_">memset</span>(&amp;<span class="hljs-title class_">options</span>, <span class="hljs-number">0</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">options</span>));</li><li>    <span class="hljs-title function_">OH_JSVM_CreateVM</span>(&amp;<span class="hljs-title class_">options</span>, &amp;<span class="hljs-title class_">vm</span>);</li><li>    <span class="hljs-variable">JSVM_VMScope</span> <span class="hljs-variable">vm_scope</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_OpenVMScope</span>(<span class="hljs-variable">vm</span>, &amp;<span class="hljs-title class_">vm_scope</span>);</li><li>    <span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>;</li><li>    <span class="hljs-variable">JSVM_CallbackStruct</span> <span class="hljs-variable">param</span>[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">param</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">data</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">param</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">callback</span> = <span class="hljs-variable">assertEqual</span>;</li><li>    <span class="hljs-variable">JSVM_PropertyDescriptor</span> <span class="hljs-variable">descriptor</span>[] = {</li><li>        {<span class="hljs-string">"assertEqual"</span>, <span class="hljs-variable">NULL</span>, &amp;<span class="hljs-title class_">param</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">NULL</span>, <span class="hljs-variable">NULL</span>, <span class="hljs-variable">NULL</span>, <span class="hljs-variable">JSVM_DEFAULT</span>},</li><li>    };</li><li>    <span class="hljs-title function_">OH_JSVM_CreateEnv</span>(<span class="hljs-variable">vm</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">descriptor</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">descriptor</span>[<span class="hljs-number">0</span>]), <span class="hljs-variable">descriptor</span>, &amp;<span class="hljs-title class_">env</span>);</li><li>    <span class="hljs-variable">JSVM_EnvScope</span> <span class="hljs-variable">envScope</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_OpenEnvScope</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">envScope</span>);</li><li>    <span class="hljs-variable">JSVM_HandleScope</span> <span class="hljs-variable">handlescope</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_OpenHandleScope</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">handlescope</span>);</li><li>
</li><li>
</li><li>    <span class="hljs-variable">JSVM_CallbackStruct</span> <span class="hljs-variable">param1</span>;</li><li>    <span class="hljs-variable">param1</span>.<span class="hljs-variable">callback</span> = [](<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_CallbackInfo</span> <span class="hljs-variable">info</span>) -&gt; <span class="hljs-title class_">JSVM_Value</span> {</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisVar</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetCbInfo</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">thisVar</span>, <span class="hljs-variable">nullptr</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">thisVar</span>;</li><li>    };</li><li>    <span class="hljs-variable">param1</span>.<span class="hljs-variable">data</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">res</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">Test</span> *<span class="hljs-variable">test</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Test</span>();</li><li>    <span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr1</span> = (<span class="hljs-variable">void</span> *)<span class="hljs-variable">test1</span>;</li><li>    <span class="hljs-variable">test</span>-&gt;<span class="hljs-title class_">ptr2</span> = (<span class="hljs-variable">void</span> *)<span class="hljs-variable">test1</span>;</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_JSVM_CreateBigintWords 111 word count %{public}d"</span>,</li><li>                <span class="hljs-title function_">sizeof</span>(*<span class="hljs-variable">test</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint64_t</span>));</li><li>    <span class="hljs-variable">JSVM_Status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">OH_JSVM_CreateBigintWords</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-title class_">uint64_t</span> *&gt;(<span class="hljs-variable">test</span>), &amp;<span class="hljs-title class_">res</span>);</li><li>
</li><li>    <span class="hljs-comment">// 初始化propertyCfg</span></li><li>    <span class="hljs-variable">JSVM_PropertyHandlerConfigurationStruct</span> <span class="hljs-variable">propertyCfg</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericNamedPropertyGetterCallback</span> = <span class="hljs-variable">GetPropertyCbInfo</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericNamedPropertySetterCallback</span> = <span class="hljs-variable">SetPropertyCbInfo</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericNamedPropertyDeleterCallback</span> = <span class="hljs-variable">DeleterPropertyCbInfo</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericNamedPropertyEnumeratorCallback</span> = <span class="hljs-variable">EnumeratorPropertyCbInfo</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericIndexedPropertyGetterCallback</span> = <span class="hljs-variable">IndexedPropertyGet</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericIndexedPropertySetterCallback</span> = <span class="hljs-variable">IndexedPropertySet</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericIndexedPropertyDeleterCallback</span> = <span class="hljs-variable">IndexedPropertyDeleter</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">genericIndexedPropertyEnumeratorCallback</span> = <span class="hljs-variable">IndexedPropertyEnumerator</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">namedPropertyData</span> = <span class="hljs-variable">res</span>;</li><li>    <span class="hljs-variable">propertyCfg</span>.<span class="hljs-variable">indexedPropertyData</span> = <span class="hljs-variable">res</span>;</li><li>
</li><li>    <span class="hljs-variable">JSVM_CallbackStruct</span> <span class="hljs-variable">callbackStruct</span>;</li><li>    <span class="hljs-variable">callbackStruct</span>.<span class="hljs-variable">callback</span> = [](<span class="hljs-variable">JSVM_Env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_CallbackInfo</span> <span class="hljs-variable">info</span>) -&gt; <span class="hljs-title class_">JSVM_Value</span> {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"call as a function called"</span>);</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">thisVar</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-variable">void</span> *<span class="hljs-variable">innerData</span>;</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>];</li><li>        <span class="hljs-title function_">OH_JSVM_GetCbInfo</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, &amp;<span class="hljs-title class_">thisVar</span>, &amp;<span class="hljs-title class_">innerData</span>);</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"function call as function result is %{public}s"</span>, <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-variable">innerData</span>));</li><li>        <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetValueUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">ret</span>);</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> <span class="hljs-variable">testStr</span>[] = <span class="hljs-string">"hello world 111111"</span>;</li><li>        <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">setvalueName</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-title function_">JSVM_CALL</span>(<span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">testStr</span>), &amp;<span class="hljs-title class_">setvalueName</span>));</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">setvalueName</span>;</li><li>    };</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">data</span>[<span class="hljs-number">100</span>] = <span class="hljs-string">"1111 hello world"</span>;</li><li>    <span class="hljs-variable">callbackStruct</span>.<span class="hljs-variable">data</span> = <span class="hljs-variable">data</span>;</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">testWrapClass</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// 将属性的访问监听注册在propertyCfg中</span></li><li>    <span class="hljs-title function_">OH_JSVM_DefineClassWithPropertyHandler</span>(<span class="hljs-variable">env</span>, <span class="hljs-string">"TestWrapClass"</span>, <span class="hljs-variable">NAPI_AUTO_LENGTH</span>, &amp;<span class="hljs-title class_">param1</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">propertyCfg</span>,</li><li>                                           &amp;<span class="hljs-title class_">callbackStruct</span>, &amp;<span class="hljs-title class_">testWrapClass</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">instanceValue</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_NewInstance</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testWrapClass</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">instanceValue</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> <span class="hljs-variable">testStr</span>[] = <span class="hljs-string">"hello world"</span>;</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">setvalueName</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">testStr</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">testStr</span>), &amp;<span class="hljs-title class_">setvalueName</span>);</li><li>
</li><li>    <span class="hljs-comment">// 1. 名称属性回调</span></li><li>    <span class="hljs-comment">// 设置属性</span></li><li>    <span class="hljs-title function_">OH_JSVM_SetNamedProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-string">"str11"</span>, <span class="hljs-variable">setvalueName</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetNamedProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-string">"str123"</span>, <span class="hljs-variable">setvalueName</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取属性</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">valueName</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetNamedProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-string">"str11"</span>, &amp;<span class="hljs-title class_">valueName</span>);</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">str</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">valueName</span>, <span class="hljs-variable">str</span>, <span class="hljs-number">100</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取所有属性的名称</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">allPropertyNames</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetAllPropertyNames</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">JSVM_KEY_OWN_ONLY</span>,</li><li>                                <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">JSVM_KeyFilter</span>&gt;(<span class="hljs-variable">JSVM_KEY_ENUMERABLE</span> | <span class="hljs-variable">JSVM_KEY_SKIP_SYMBOLS</span>),</li><li>                                <span class="hljs-variable">JSVM_KEY_NUMBERS_TO_STRINGS</span>, &amp;<span class="hljs-title class_">allPropertyNames</span>);</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">nameSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetArrayLength</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">allPropertyNames</span>, &amp;<span class="hljs-title class_">nameSize</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">propertyName</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">nameSize</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-title function_">OH_JSVM_GetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">allPropertyNames</span>, <span class="hljs-variable">i</span>, &amp;<span class="hljs-title class_">propertyName</span>);</li><li>        <span class="hljs-variable">char</span> <span class="hljs-variable">str</span>[<span class="hljs-number">100</span>];</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">propertyName</span>, <span class="hljs-variable">str</span>, <span class="hljs-number">100</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 删除属性</span></li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-variable">propertyName</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">propertyChar</span>[] = <span class="hljs-string">"str11"</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">propertyChar</span>, <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">propertyChar</span>), &amp;<span class="hljs-title class_">propertyName</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_DeleteProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">propertyName</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>
</li><li>    <span class="hljs-comment">// 2. 索引属性回调</span></li><li>    <span class="hljs-comment">// 设置属性</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">jsIndex</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">jsIndex</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">jsIndex</span>, <span class="hljs-variable">setvalueName</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">jsIndex1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">index</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateUint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">jsIndex1</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">jsIndex1</span>, <span class="hljs-variable">setvalueName</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取属性</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">valueName1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">jsIndex</span>, &amp;<span class="hljs-title class_">valueName1</span>);</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">str1</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">size1</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">valueName1</span>, <span class="hljs-variable">str1</span>, <span class="hljs-number">100</span>, &amp;<span class="hljs-title class_">size1</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取所有属性的名称</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">allPropertyNames1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetAllPropertyNames</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">JSVM_KEY_OWN_ONLY</span>,</li><li>                                <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">JSVM_KeyFilter</span>&gt;(<span class="hljs-variable">JSVM_KEY_ENUMERABLE</span> | <span class="hljs-variable">JSVM_KEY_SKIP_SYMBOLS</span>),</li><li>                                <span class="hljs-variable">JSVM_KEY_NUMBERS_TO_STRINGS</span>, &amp;<span class="hljs-title class_">allPropertyNames1</span>);</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">nameSize1</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetArrayLength</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">allPropertyNames1</span>, &amp;<span class="hljs-title class_">nameSize1</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">propertyName1</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">nameSize1</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-title function_">OH_JSVM_GetElement</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">allPropertyNames1</span>, <span class="hljs-variable">i</span>, &amp;<span class="hljs-title class_">propertyName1</span>);</li><li>        <span class="hljs-variable">char</span> <span class="hljs-variable">str</span>[<span class="hljs-number">100</span>];</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">OH_JSVM_GetValueStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">propertyName1</span>, <span class="hljs-variable">str</span>, <span class="hljs-number">100</span>, &amp;<span class="hljs-title class_">size</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 删除属性</span></li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">result1</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_DeleteProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">instanceValue</span>, <span class="hljs-variable">jsIndex</span>, &amp;<span class="hljs-title class_">result1</span>);</li><li>
</li><li>    <span class="hljs-comment">// 3. 作为函数的回调</span></li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">gloablObj</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_GetGlobal</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">gloablObj</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_SetNamedProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">gloablObj</span>, <span class="hljs-string">"myTestInstance"</span>, <span class="hljs-variable">instanceValue</span>);</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"set property on global object"</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">innerSourcecodestr</span> = <span class="hljs-variable">R</span><span class="hljs-string">"(</span></li><li><span class="hljs-string">    {</span></li><li><span class="hljs-string">        let res = myTestInstance(12);</span></li><li><span class="hljs-string">    })"</span>;</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">innerSourcecodevalue</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">innerSourcecodestr</span>.<span class="hljs-title function_">c_str</span>(), <span class="hljs-variable">innerSourcecodestr</span>.<span class="hljs-title function_">size</span>(), &amp;<span class="hljs-title class_">innerSourcecodevalue</span>);</li><li>    <span class="hljs-variable">JSVM_Script</span> <span class="hljs-variable">innerscript</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CompileScript</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">innerSourcecodevalue</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">true</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">innerscript</span>);</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">innerResult</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_RunScript</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">innerscript</span>, &amp;<span class="hljs-title class_">innerResult</span>);</li><li>
</li><li>    <span class="hljs-title function_">OH_JSVM_CloseHandleScope</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">handlescope</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_CloseEnvScope</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">envScope</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_DestroyEnv</span>(<span class="hljs-variable">env</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_CloseVMScope</span>(<span class="hljs-variable">vm</span>, <span class="hljs-variable">vm_scope</span>);</li><li>    <span class="hljs-title function_">OH_JSVM_DestroyVM</span>(<span class="hljs-variable">vm</span>);</li><li>    <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"TestDefineClassWithProperty pass"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>场景示例：设置父类并通过DefineClassOptions设置监听拦截属性操作</p> <p>具体示例参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-about-class">使用JSVM-API接口进行class相关开发</a>。</p> </div>  <div class="tiledSection"><h3 id="版本管理">版本管理<i class="anchor-icon anchor-icon-link" anchorid="版本管理" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>获取当前版本信息。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.25.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.25.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetVersion</td> <td class="cellrowborder" valign="top" width="50%">返回JSVM运行时支持的最高JSVM API版本</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetVMInfo</td> <td class="cellrowborder" valign="top" width="50%">返回虚拟机的信息</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>获取当前版本信息。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-sql" data-highlighted="yes"><ol class="linenums"><li>JSVM_VMInfo <span class="hljs-keyword">result</span>;</li><li>OH_JSVM_GetVMInfo(<span class="hljs-operator">&amp;</span><span class="hljs-keyword">result</span>);</li><li>uint32_t versionId <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>OH_JSVM_GetVersion(env, <span class="hljs-operator">&amp;</span>versionId);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="内存管理">内存管理<i class="anchor-icon anchor-icon-link" anchorid="内存管理" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>内存管理。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.26.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.26.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AdjustExternalMemory</td> <td class="cellrowborder" valign="top" width="50%">将因JavaScript对象而保持活跃的外部分配的内存大小及时通知给底层虚拟机，虚拟机后续触发GC时，就会综合内外内存状态来判断是否进行全局GC。即增大外部内存分配，则会增大触发全局GC的概率；反之减少。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_MemoryPressureNotification</td> <td class="cellrowborder" valign="top" width="50%">通知虚拟机系统内存压力层级，并有选择地触发垃圾回收。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AllocateArrayBufferBackingStoreData</td> <td class="cellrowborder" valign="top" width="50%">申请一块 BackingStore 内存。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_FreeArrayBufferBackingStoreData</td> <td class="cellrowborder" valign="top" width="50%">释放 BackingStore 内存。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateArrayBufferFromBackingStoreData</td> <td class="cellrowborder" valign="top" width="50%">基于申请的 BackingStore 内存创建 array buffer。</td> </tr>  </tbody></table></div> </div>  <p>使用 BackingStore 属于高危操作，使用者需确保内存使用正确。请参考下方正确示例，谨慎操作。</p>  <p>场景示例：</p> <p>内存管理。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 分别在调用OH_JSVM_AdjustExternalMemory前后来查看底层虚拟机视角下外部分配的内存大小</span></li><li><span class="hljs-type">int64_t</span> result = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">OH_JSVM_AdjustExternalMemory</span>(env, <span class="hljs-number">0</span>, &amp;result); <span class="hljs-comment">// 假设外部分配内存的变化不变</span></li><li><span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Before AdjustExternalMemory: %{public}lld\n"</span>, result); <span class="hljs-comment">// 得到调整前的数值</span></li><li><span class="hljs-comment">// 调整外部分配的内存大小通知给底层虚拟机（此示例假设内存使用量增加）</span></li><li><span class="hljs-type">int64_t</span> memoryIncrease = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 增加 1 MB</span></li><li><span class="hljs-built_in">OH_JSVM_AdjustExternalMemory</span>(env, memoryIncrease, &amp;result);</li><li><span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"After AdjustExternalMemory: %{public}lld\n"</span>, result); <span class="hljs-comment">// 得到调整后的数值</span></li></ol></pre></div></div> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 打开一个Handle scope，在scope范围内申请大量内存来测试函数功能；</span></li><li><span class="hljs-comment">// 分别在“完成申请后”、“关闭scope后”和“调用OH_JSVM_MemoryPressureNotification后”三个节点查看内存状态</span></li><li><span class="hljs-variable">JSVM_HandleScope</span> <span class="hljs-variable">tmpscope</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-title function_">OH_JSVM_OpenHandleScope</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">tmpscope</span>);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">1000000</span>; ++<span class="hljs-title class_">i</span>) {</li><li>    <span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">obj</span>;</li><li>    <span class="hljs-title function_">OH_JSVM_CreateObject</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">obj</span>);</li><li>}</li><li><span class="hljs-variable">JSVM_HeapStatistics</span> <span class="hljs-variable">mem</span>;</li><li><span class="hljs-title function_">OH_JSVM_GetHeapStatistics</span>(<span class="hljs-variable">vm</span>, &amp;<span class="hljs-title class_">mem</span>); <span class="hljs-comment">// 获取虚拟机堆的统计数据</span></li><li><span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"%{public}zu\n"</span>, <span class="hljs-variable">mem</span>.<span class="hljs-variable">usedHeapSize</span>); <span class="hljs-comment">// 申请完成后，内存处于最大状态</span></li><li><span class="hljs-title function_">OH_JSVM_CloseHandleScope</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">tmpscope</span>); <span class="hljs-comment">// 关闭Handle scope</span></li><li>
</li><li><span class="hljs-title function_">OH_JSVM_GetHeapStatistics</span>(<span class="hljs-variable">vm</span>, &amp;<span class="hljs-title class_">mem</span>);</li><li><span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"%{public}zu\n"</span>, <span class="hljs-variable">mem</span>.<span class="hljs-variable">usedHeapSize</span>); <span class="hljs-comment">// 关闭scope后，GC并没有立即回收</span></li><li>
</li><li><span class="hljs-comment">// 通知虚拟机系统内存压力层级，并有选择地触发垃圾回收</span></li><li><span class="hljs-title function_">OH_JSVM_MemoryPressureNotification</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">JSVM_MEMORY_PRESSURE_LEVEL_CRITICAL</span>); <span class="hljs-comment">// 假设内存压力处于临界状态</span></li><li>
</li><li><span class="hljs-title function_">OH_JSVM_GetHeapStatistics</span>(<span class="hljs-variable">vm</span>, &amp;<span class="hljs-title class_">mem</span>);</li><li><span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"%{public}zu\n"</span>, <span class="hljs-variable">mem</span>.<span class="hljs-variable">usedHeapSize</span>); <span class="hljs-comment">// 触发垃圾回收后</span></li></ol></pre></div></div> <p>BackingStore 正确使用示例</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> *<span class="hljs-variable">backingStore</span>;</li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">arrayBuffer</span>;</li><li>
</li><li><span class="hljs-comment">// 申请一块大小为 100 字节的 BackingStore 内存</span></li><li><span class="hljs-title function_">OH_JSVM_AllocateArrayBufferBackingStoreData</span>(<span class="hljs-number">100</span>, <span class="hljs-variable">JSVM_ZERO_INITIALIZED</span>, &amp;<span class="hljs-title class_">backingStore</span>);</li><li>
</li><li><span class="hljs-comment">// 在之前申请的 BackingStore 上创建一个 ArrayBuffer，位置为距离 BackingStore 起始地址加 30 字节处，大小为 20 字节</span></li><li><span class="hljs-title function_">OH_JSVM_CreateArrayBufferFromBackingStoreData</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">backingStore</span>, <span class="hljs-number">100</span>, <span class="hljs-number">30</span>, <span class="hljs-number">20</span>, &amp;<span class="hljs-title class_">arrayBuffer</span>);</li><li>
</li><li><span class="hljs-comment">// 在 JS 中使用创建的 ArrayBuffer</span></li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">js_global</span>;</li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">name</span>;</li><li><span class="hljs-title function_">OH_JSVM_GetGlobal</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">js_global</span>);</li><li><span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-string">"buffer"</span>, <span class="hljs-variable">JSVM_AUTO_LENGTH</span>, &amp;<span class="hljs-title class_">name</span>);</li><li><span class="hljs-title function_">OH_JSVM_SetProperty</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">js_global</span>, <span class="hljs-variable">name</span>, <span class="hljs-variable">arrayBuffer</span>);</li><li>
</li><li><span class="hljs-variable">JSVM_Script</span> <span class="hljs-variable">script</span>;</li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">scriptString</span>;</li><li><span class="hljs-variable">JSVM_Value</span> <span class="hljs-variable">result</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">src</span> = <span class="hljs-variable">R</span><span class="hljs-string">"JS(</span></li><li><span class="hljs-string">function writeBuffer(data) {</span></li><li><span class="hljs-string">  let view = new Uint8Array(data);</span></li><li><span class="hljs-string">  // Write some values to the ArrayBuffer</span></li><li><span class="hljs-string">  for (let i = 0; i &lt; view.length; i++) {</span></li><li><span class="hljs-string">    view[i] = i % 256;</span></li><li><span class="hljs-string">  }</span></li><li><span class="hljs-string">}</span></li><li><span class="hljs-string">writeBuffer(buffer)</span></li><li><span class="hljs-string">)JS"</span>;</li><li><span class="hljs-title function_">OH_JSVM_CreateStringUtf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">src</span>, <span class="hljs-variable">JSVM_AUTO_LENGTH</span>, &amp;<span class="hljs-title class_">scriptString</span>);</li><li><span class="hljs-title function_">OH_JSVM_CompileScriptWithOptions</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">scriptString</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">script</span>);</li><li><span class="hljs-title function_">OH_JSVM_RunScript</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">script</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>
</li><li><span class="hljs-comment">// 检查 ArrayBuffer 的内容</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">array</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint8_t</span>*&gt;(<span class="hljs-variable">backingStore</span>);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-variable">auto</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">100</span>; ++<span class="hljs-title class_">i</span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">array</span>[<span class="hljs-variable">i</span>] != <span class="hljs-variable">i</span> % <span class="hljs-number">256</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 释放 array buffer. 注意对于这种方式创建的 ArrayBuffer, 在释放对应的 BackingStore 之前,</span></li><li><span class="hljs-comment">// 务必使用 OH_JSVM_DetachArraybuffer 将所有使用当前的 BackingStore 创建的 ArrayBuffer 释放</span></li><li><span class="hljs-comment">// 否则可能产生不可预测的内存问题，请谨慎使用</span></li><li><span class="hljs-title function_">OH_JSVM_DetachArraybuffer</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">arrayBuffer</span>);</li><li>
</li><li><span class="hljs-comment">// 释放申请的 backing store 内存</span></li><li><span class="hljs-title function_">OH_JSVM_FreeArrayBufferBackingStoreData</span>(<span class="hljs-variable">backingStore</span>);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="promise操作">Promise操作<i class="anchor-icon anchor-icon-link" anchorid="promise操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>Promise相关操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.27.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.27.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreatePromise</td> <td class="cellrowborder" valign="top" width="50%">创建一个延迟对象和一个JavaScript promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ResolveDeferred</td> <td class="cellrowborder" valign="top" width="50%">通过与之关联的延迟对象来解析JavaScript promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RejectDeferred</td> <td class="cellrowborder" valign="top" width="50%">通过与之关联的延迟对象来拒绝JavaScript Promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsPromise</td> <td class="cellrowborder" valign="top" width="50%">查询Promise是否为原生Promise对象</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>Promise相关操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_Deferred deferred;</li><li>JSVM_Value promise;</li><li><span class="hljs-built_in">OH_JSVM_CreatePromise</span>(env, &amp;deferred, &amp;promise);</li><li>
</li><li><span class="hljs-comment">// 模拟异步操作</span></li><li><span class="hljs-type">int</span> result = <span class="hljs-number">42</span>;</li><li><span class="hljs-type">bool</span> success = <span class="hljs-literal">true</span>;</li><li><span class="hljs-keyword">if</span> (success)</li><li>{</li><li>    <span class="hljs-comment">// 解析Promise，并传递结果</span></li><li>    JSVM_Value value;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, result, &amp;value);</li><li>    <span class="hljs-built_in">OH_JSVM_ResolveDeferred</span>(env, deferred, value);</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 拒绝Promise，并传递错误信息</span></li><li>    JSVM_Value code = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Value message = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"600"</span>, JSVM_AUTO_LENGTH, &amp;code);</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Async operation failed"</span>, JSVM_AUTO_LENGTH, &amp;message);</li><li>    JSVM_Value error = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateError</span>(env, code, message, &amp;error);</li><li>    <span class="hljs-built_in">OH_JSVM_RejectDeferred</span>(env, deferred, error);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="json操作">JSON操作<i class="anchor-icon anchor-icon-link" anchorid="json操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>JSON操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.28.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.28.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_JsonParse</td> <td class="cellrowborder" valign="top" width="50%">解析JSON字符串，并返回成功解析的值</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_JsonStringify</td> <td class="cellrowborder" valign="top" width="50%">将对象字符串化，并返回成功转换后的字符串</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>解析JSON操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-swift" data-highlighted="yes"><ol class="linenums"><li>std::string sourcecodestr <span class="hljs-operator">=</span> <span class="hljs-string">"{<span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>John<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>age<span class="hljs-subst">\"</span>: 30, <span class="hljs-subst">\"</span>city<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>New York<span class="hljs-subst">\"</span>}"</span> ;</li><li><span class="hljs-type">JSVM_Value</span> jsonString;</li><li><span class="hljs-type">OH_JSVM_CreateStringUtf8</span>(env, sourcecodestr.c_str(), sourcecodestr.size(), <span class="hljs-operator">&amp;</span>jsonString);</li><li><span class="hljs-type">JSVM_Value</span> result;</li><li><span class="hljs-type">OH_JSVM_JsonParse</span>(env, jsonString, <span class="hljs-operator">&amp;</span>result);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="创建和使用虚拟机的启动快照">创建和使用虚拟机的启动快照<i class="anchor-icon anchor-icon-link" anchorid="创建和使用虚拟机的启动快照" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>创建和使用虚拟机的启动快照。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.29.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.29.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSnapshot</td> <td class="cellrowborder" valign="top" width="50%">用于创建虚拟机的启动快照</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateEnvFromSnapshot</td> <td class="cellrowborder" valign="top" width="50%">基于启动快照创建jsvm环境</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-create-snapshot">创建和使用虚拟机的启动快照。</a></p> </div>  <div class="tiledSection"><h3 id="检查传入的值是否可调用">检查传入的值是否可调用<i class="anchor-icon anchor-icon-link" anchorid="检查传入的值是否可调用" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>检查传入的值是否可调用。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.30.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.30.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsCallable</td> <td class="cellrowborder" valign="top" width="50%">检查传入的值是否可调用</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>检查传入的值是否可调用。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">NapiIsCallable</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_Value value, rst;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">bool</span> isCallable = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, &amp;value, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_IsCallable</span>(env, value, &amp;isCallable));</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, isCallable, &amp;rst);</li><li>    <span class="hljs-keyword">return</span> rst;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">MyJSVMDemo</span><span class="hljs-params">([[maybe_unused]] napi_env _env, [[maybe_unused]] napi_callback_info _info)</span> </span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">([]() {</span></span></li><li><span class="hljs-function">        <span class="hljs-comment">// create vm, and open vm scope</span></span></li><li><span class="hljs-function">        JSVM_VM vm;</span></li><li><span class="hljs-function">        JSVM_CreateVMOptions options;</span></li><li><span class="hljs-function">        memset(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(options));</span></li><li><span class="hljs-function">        OH_JSVM_CreateVM(&amp;options, &amp;vm);</span></li><li><span class="hljs-function">        JSVM_VMScope vmScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenVMScope(vm, &amp;vmScope);</span></li><li><span class="hljs-function">        JSVM_CallbackStruct param[] = {</span></li><li><span class="hljs-function">            {.data = <span class="hljs-literal">nullptr</span>, .callback = NapiIsCallable},</span></li><li><span class="hljs-function">        };</span></li><li><span class="hljs-function">        JSVM_PropertyDescriptor descriptor[] = {</span></li><li><span class="hljs-function">            {<span class="hljs-string">"napiIsCallable"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</span></li><li><span class="hljs-function">        };</span></li><li><span class="hljs-function">        <span class="hljs-comment">// create env, register native method, and open env scope</span></span></li><li><span class="hljs-function">        JSVM_Env env;</span></li><li><span class="hljs-function">        OH_JSVM_CreateEnv(vm, <span class="hljs-keyword">sizeof</span>(descriptor) / <span class="hljs-keyword">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env);</span></li><li><span class="hljs-function">        JSVM_EnvScope envScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenEnvScope(env, &amp;envScope);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// open handle scope</span></span></li><li><span class="hljs-function">        JSVM_HandleScope handleScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenHandleScope(env, &amp;handleScope);</span></li><li><span class="hljs-function">        std::string sourceCodeStr = <span class="hljs-string">R"JS(</span></span></li><li><span class="hljs-function">        function addNumbers(num1, num2)</span></li><li><span class="hljs-function">        {</span></li><li><span class="hljs-function">            var rst= num1 + num2;</span></li><li><span class="hljs-function">            return rst;</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        let rst = napiIsCallable(addNumbers);</span></li><li><span class="hljs-function">        )JS"</span>;</li><li><span class="hljs-function">        <span class="hljs-comment">// compile js script</span></span></li><li><span class="hljs-function">        JSVM_Value sourceCodeValue;</span></li><li><span class="hljs-function">        OH_JSVM_CreateStringUtf8(env, sourceCodeStr.c_str(), sourceCodeStr.size(), &amp;sourceCodeValue);</span></li><li><span class="hljs-function">        JSVM_Script script;</span></li><li><span class="hljs-function">        OH_JSVM_CompileScript(env, sourceCodeValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</span></li><li><span class="hljs-function">        JSVM_Value result;</span></li><li><span class="hljs-function">        <span class="hljs-comment">// run js script</span></span></li><li><span class="hljs-function">        OH_JSVM_RunScript(env, script, &amp;result);</span></li><li><span class="hljs-function">        JSVM_ValueType type;</span></li><li><span class="hljs-function">        OH_JSVM_Typeof(env, result, &amp;type);</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM API TEST type: %{public}d"</span>, type);</span></li><li><span class="hljs-function">        <span class="hljs-comment">// exit vm and clean memory</span></span></li><li><span class="hljs-function">        OH_JSVM_CloseHandleScope(env, handleScope);</span></li><li><span class="hljs-function">        OH_JSVM_CloseEnvScope(env, envScope);</span></li><li><span class="hljs-function">        OH_JSVM_DestroyEnv(env);</span></li><li><span class="hljs-function">        OH_JSVM_CloseVMScope(vm, vmScope);</span></li><li><span class="hljs-function">        OH_JSVM_DestroyVM(vm);</span></li><li><span class="hljs-function">    })</span>;</li><li>    t.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="lock操作">Lock操作<i class="anchor-icon anchor-icon-link" anchorid="lock操作" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>Lock操作。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.31.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.31.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsLocked</td> <td class="cellrowborder" valign="top" width="50%">判断当前线程是否持有指定环境的锁</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AcquireLock</td> <td class="cellrowborder" valign="top" width="50%">获取指定环境的锁</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReleaseLock</td> <td class="cellrowborder" valign="top" width="50%">释放指定环境的锁</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>加锁解锁操作。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">LockWrapper</span> {</li><li> <span class="hljs-keyword">public</span>:</li><li>  <span class="hljs-built_in">LockWrapper</span>(JSVM_Env env) : <span class="hljs-built_in">env</span>(env) {</li><li>    <span class="hljs-built_in">OH_JSVM_IsLocked</span>(env, &amp;isLocked);</li><li>    <span class="hljs-keyword">if</span> (!isLocked) {</li><li>      <span class="hljs-built_in">OH_JSVM_AcquireLock</span>(env);</li><li>      <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>      <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>      <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    }</li><li>  }</li><li>
</li><li>  ~<span class="hljs-built_in">LockWrapper</span>() {</li><li>    <span class="hljs-keyword">if</span> (!isLocked) {</li><li>      <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>      <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>      <span class="hljs-built_in">OH_JSVM_ReleaseLock</span>(env);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-built_in">LockWrapper</span>(<span class="hljs-type">const</span> LockWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  LockWrapper&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> LockWrapper&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-built_in">LockWrapper</span>(LockWrapper&amp;&amp;) = <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span>)</span> </span>= <span class="hljs-keyword">delete</span>;</li><li>  <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span>) = <span class="hljs-keyword">delete</span>;</li><li>
</li><li> <span class="hljs-keyword">private</span>:</li><li>  JSVM_Env env;</li><li>  JSVM_EnvScope envScope;</li><li>  JSVM_VMScope vmScope;</li><li>  JSVM_VM vm;</li><li>  <span class="hljs-type">bool</span> isLocked;</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> aa = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">([[maybe_unused]] napi_env _env, [[maybe_unused]] napi_callback_info _info)</span> </span>{</li><li>    <span class="hljs-type">static</span> JSVM_VM vm;</li><li>    <span class="hljs-type">static</span> JSVM_Env env;</li><li>    <span class="hljs-keyword">if</span> (aa == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(<span class="hljs-literal">nullptr</span>);</li><li>        aa++;</li><li>        <span class="hljs-comment">// create vm</span></li><li>        JSVM_CreateVMOptions options;</li><li>        <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>        <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm);</li><li>        <span class="hljs-comment">// create env</span></li><li>        <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;env);</li><li>    }</li><li>
</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([]() {</span></span></li><li><span class="hljs-function">        LockWrapper lock(env);</span></li><li><span class="hljs-function">        JSVM_HandleScope handleScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenHandleScope(env, &amp;handleScope);</span></li><li><span class="hljs-function">        JSVM_Value value;</span></li><li><span class="hljs-function">        JSVM_Status rst = OH_JSVM_CreateInt32(env, <span class="hljs-number">32</span>, &amp;value); <span class="hljs-comment">// 32: numerical value</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (rst == JSVM_OK) {</span></li><li><span class="hljs-function">            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM:t1 OH_JSVM_CreateInt32 suc"</span>);</span></li><li><span class="hljs-function">        } <span class="hljs-keyword">else</span> {</span></li><li><span class="hljs-function">            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"JSVM:t1 OH_JSVM_CreateInt32 fail"</span>);</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        <span class="hljs-type">int32_t</span> num1 = <span class="hljs-number">0</span>;</span></li><li><span class="hljs-function">        OH_JSVM_GetValueInt32(env, value, &amp;num1);</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM:t1 num1 = %{public}d"</span>, num1);</span></li><li><span class="hljs-function">        OH_JSVM_CloseHandleScope(env, handleScope);</span></li><li><span class="hljs-function">    })</span>;</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([]() {</span></span></li><li><span class="hljs-function">        LockWrapper lock(env);</span></li><li><span class="hljs-function">        JSVM_HandleScope handleScope;</span></li><li><span class="hljs-function">        OH_JSVM_OpenHandleScope(env, &amp;handleScope);</span></li><li><span class="hljs-function">        JSVM_Value value;</span></li><li><span class="hljs-function">        JSVM_Status rst = OH_JSVM_CreateInt32(env, <span class="hljs-number">32</span>, &amp;value); <span class="hljs-comment">// 32: numerical value</span></span></li><li><span class="hljs-function">        <span class="hljs-keyword">if</span> (rst == JSVM_OK) {</span></li><li><span class="hljs-function">            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM:t2 OH_JSVM_CreateInt32 suc"</span>);</span></li><li><span class="hljs-function">        } <span class="hljs-keyword">else</span> {</span></li><li><span class="hljs-function">            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"JSVM:t2 OH_JSVM_CreateInt32 fail"</span>);</span></li><li><span class="hljs-function">        }</span></li><li><span class="hljs-function">        <span class="hljs-type">int32_t</span> num1 = <span class="hljs-number">0</span>;</span></li><li><span class="hljs-function">        OH_JSVM_GetValueInt32(env, value, &amp;num1);</span></li><li><span class="hljs-function">        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"JSVM:t2 num1 = %{public}d"</span>, num1);</span></li><li><span class="hljs-function">        OH_JSVM_CloseHandleScope(env, handleScope);</span></li><li><span class="hljs-function">    })</span>;</li><li>    t1.<span class="hljs-built_in">detach</span>();</li><li>    t2.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="设置与获取和当前运行的jsvm环境相关联的数据">设置与获取和当前运行的JSVM环境相关联的数据<i class="anchor-icon anchor-icon-link" anchorid="设置与获取和当前运行的jsvm环境相关联的数据" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>调用OH_JSVM_SetInstanceData接口，设置与当前运行的JSVM环境相关联的数据。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.32.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.32.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetInstanceData</td> <td class="cellrowborder" valign="top" width="50%">设置与当前运行的JSVM环境相关联的数据</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetInstanceData</td> <td class="cellrowborder" valign="top" width="50%">获取与当前运行的JSVM环境相关联的数据</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p>设置并获取与当前运行的JSVM环境相关联的数据。</p> <div _ngcontent-ksu-c106="" class="highlight-div"><div _ngcontent-ksu-c106="" class="highlight-div-header"><div _ngcontent-ksu-c106="" class="highlight-div-header-left"><div _ngcontent-ksu-c106="" class="handle-button expand-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ksu-c106="" class="highlight-div-header-right"><div _ngcontent-ksu-c106="" class="handle-button ai-button"></div><div _ngcontent-ksu-c106="" class="handle-button line-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ksu-c106="" class="handle-button theme-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ksu-c106="" class="handle-button copy-button"><div _ngcontent-ksu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ksu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM_VM vm;</li><li>JSVM_CreateVMOptions options;</li><li>JSVM_VMScope vm_scope;</li><li>JSVM_Env env;</li><li>JSVM_EnvScope envScope;</li><li>JSVM_HandleScope handlescope;</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> aa = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">InstanceData</span> {</li><li>    <span class="hljs-type">int32_t</span> value;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 初始化虚拟机，创建JSVM运行环境</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init_JSVM_environment</span><span class="hljs-params">()</span></span>{</li><li>    JSVM_InitOptions init_options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;init_options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(init_options));</li><li>    <span class="hljs-keyword">if</span> (aa == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;init_options);</li><li>        aa++;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm);</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vm_scope);</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;env);</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handlescope);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 退出虚拟机，释放对应的环境</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">close_JSVM_environment</span><span class="hljs-params">(napi_env env1, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handlescope);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vm_scope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>    napi_value result;</li><li>    <span class="hljs-type">char</span>* s = <span class="hljs-string">"ok"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_latin1</span>(env1, s, <span class="hljs-built_in">strlen</span>(s), &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">//清除和释放与实例相关联的内存资源</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InstanceFinalizeCallback</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">void</span> *finalizeData, <span class="hljs-type">void</span> *finalizeHint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (finalizeData) {</li><li>        InstanceData *data = <span class="hljs-built_in">reinterpret_cast</span>&lt;InstanceData *&gt;(finalizeData);</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        *(InstanceData **)finalizeData = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetInstanceData</span><span class="hljs-params">(napi_env env1, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    InstanceData *instanceData = <span class="hljs-built_in">reinterpret_cast</span>&lt;InstanceData *&gt;(<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(InstanceData)));</li><li>    <span class="hljs-keyword">if</span> (instanceData == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Memory allocation failed!\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">//用于获取回调函数参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env1, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env1, args[<span class="hljs-number">0</span>], &amp;valuetype0);</li><li>    <span class="hljs-type">int32_t</span> tmp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env1, args[<span class="hljs-number">0</span>], &amp;tmp);</li><li>    instanceData-&gt;value = tmp;</li><li>    <span class="hljs-comment">//将获得的参数与当前运行的JSVM环境关联起来</span></li><li>    <span class="hljs-built_in">OH_JSVM_SetInstanceData</span>(env, instanceData, InstanceFinalizeCallback, <span class="hljs-literal">nullptr</span>);</li><li>    InstanceData *resData = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">//获取与当前运行的JSVM环境相关联的数据</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetInstanceData</span>(env, (<span class="hljs-type">void</span> **)&amp;resData);</li><li>    napi_value result;</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env1, resData-&gt;value, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="任务队列">任务队列<i class="anchor-icon anchor-icon-link" anchorid="任务队列" tips="复制节点链接"></i></h3><p><strong>场景介绍</strong></p> <p>在虚拟机内部启动任务队列的运行，检查队列中是否有待处理的微任务。任务队列可由外部事件循环执行。</p> <p><strong>接口说明</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.33.5.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.33.5.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_PumpMessageLoop</td> <td class="cellrowborder" valign="top" width="50%">启动任务队列的运行</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_PerformMicrotaskCheckpoint</td> <td class="cellrowborder" valign="top" width="50%">执行任务队列里的微任务</td> </tr>  </tbody></table></div> </div> <p>场景示例：</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-execute_tasks">使用JSVM-API接口进行任务队列相关开发</a></p> </div> </div> <div></div></div>