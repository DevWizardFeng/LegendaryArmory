<h1 _ngcontent-iwe-c119="" class="doc-title ng-star-inserted" title="JSVM-API调试&amp;定位"> JSVM-API调试&amp;定位 </h1>

<div _ngcontent-iwe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>JSVM，即标准JS引擎，是严格遵守ECMAScript规范的JavaScript代码执行引擎。详情参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-jsvm" target="_blank">JSVM</a>。</p>    <p>基于JSVM的JS代码调试调优能力包括：Debugger、CPU Profiler、Heap Snapshot、Heap Statistics。涉及以下接口：</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.1" valign="top" width="50%">接口名</th>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.2" valign="top" width="50%">接口功能</th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetVM</td>        <td class="cellrowborder" valign="top" width="50%">获取给定环境的虚拟机实例。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetHeapStatistics</td>        <td class="cellrowborder" valign="top" width="50%">返回一组虚拟机堆的统计数据。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_StartCpuProfiler</td>        <td class="cellrowborder" valign="top" width="50%">创建并启动一个CPU profiler。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_StopCpuProfiler</td>        <td class="cellrowborder" valign="top" width="50%">停止CPU profiler并将结果输出到流。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_TakeHeapSnapshot</td>        <td class="cellrowborder" valign="top" width="50%">获取当前堆快照并将其输出到流。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenInspector</td>        <td class="cellrowborder" valign="top" width="50%">在指定的主机和端口上激活inspector，将用来调试JS代码。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenInspectorWithName</td>        <td class="cellrowborder" valign="top" width="50%">基于传入的 pid 和 name 激活 inspector。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseInspector</td>        <td class="cellrowborder" valign="top" width="50%">尝试关闭剩余的所有inspector连接。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">OH_JSVM_WaitForDebugger</td>        <td class="cellrowborder" valign="top" width="50%">等待主机与inspector建立socket连接，连接建立后程序将继续运行。执行Runtime.runIfWaitingForDebugger命令。</td>       </tr>           </tbody></table></div>    </div>    <p>本文将介绍调试方法、CPU Profiler使用方法和Heap Snapshot使用方法。</p>    <div class="tiledSection">     <h2 id="调试能力使用方法">调试能力使用方法<i class="anchor-icon anchor-icon-link" anchorid="调试能力使用方法" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="使用-oh_jsvm_openinspector" class="firsth2">使用 OH_JSVM_OpenInspector<i class="anchor-icon anchor-icon-link" anchorid="使用-oh_jsvm_openinspector" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在应用工程配置文件module.json中配置网络权限：</p>       <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$string:app_name"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-string">"FromAbility"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li></ol></pre></div></div></li>      <li>       <p>为避免debugger过程中的暂停被误报为无响应异常，可以开启DevEco Studio的Debug模式，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-debug-arkts-debug-V5" target="_blank">debug启动调试</a>（无需设置断点），或者可以在非主线程的其它线程中运行JSVM。</p>       <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在非主线程的其他线程中运行JSVM示例代码</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">testJSVMThread</span><span class="hljs-params">(TestJSVM)</span></span>;</li><li>    testJSVMThread.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span>  <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在执行JS代码之前，调用OH_JSVM_OpenInspector在指定的主机和端口上激活inspector，创建socket。例如OH_JSVM_OpenInspector(env, "localhost", 9225)，在端侧本机端口9225创建socket。</p></li>      <li>       <p>调用OH_JSVM_WaitForDebugger，等待建立socket连接。</p></li>      <li>       <p>检查端侧端口是否打开成功。hdc shell "netstat -anp | grep 9225"。结果为9225端口状态为“LISTEN"即可。</p></li>      <li>       <p>转发端口。hdc fport tcp:9229 tcp:9225。转发开发者个人计算机侧端口9229到端侧端口9225。结果为"Forwardport result:OK"即可。</p></li>      <li>       <p>在chrome浏览器地址栏输入"localhost:9229/json"，回车。获取端口连接信息。拷贝"devtoolsFrontendUrl"字段url内容到地址栏，回车，进入DevTools源码页，将看到在应用中通过OH_JSVM_RunScript执行的JS源码，此时暂停在第一行JS源码处。(注："devtoolsFrontendUrl"字段url只支持使用Chrome、Edge浏览器打开，不支持使用Firefox、Safari等浏览器打开。)</p></li>      <li>       <p>用户可在源码页打断点，通过按钮发出各种调试命令控制JS代码执行，并查看变量。</p></li>      <li>       <p>调用OH_JSVM_CloseInspector关闭inspector，结束socket连接。</p></li>     </ol>     <p><strong>示例代码</strong></p>     <p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p>     <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li><li>
</li><li><span class="hljs-comment">// 待调试的JS源码</span></li><li><span class="hljs-type">static</span> string srcDebugger = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">const concat = (...args) =&gt; args.reduce((a, b) =&gt; a + b);</span></li><li><span class="hljs-string">var dialogue = concat('"What ', 'is ', 'your ', 'name ', '?"');</span></li><li><span class="hljs-string">dialogue = concat(dialogue, ' --', '"My ', 'name ', 'is ', 'Bob ', '."');</span></li><li><span class="hljs-string">)JS"</span>;</li><li>
</li><li><span class="hljs-comment">// 开启debugger</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">EnableInspector</span><span class="hljs-params">(JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-comment">// 在指定的主机和端口上激活inspector，创建socket。</span></li><li>    <span class="hljs-built_in">OH_JSVM_OpenInspector</span>(env, <span class="hljs-string">"localhost"</span>, <span class="hljs-number">9225</span>);</li><li>    <span class="hljs-comment">// 等待建立socket连接。</span></li><li>    <span class="hljs-built_in">OH_JSVM_WaitForDebugger</span>(env, <span class="hljs-literal">true</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 关闭debugger</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">CloseInspector</span><span class="hljs-params">(JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-comment">// 关闭inspector，结束socket连接。</span></li><li>    <span class="hljs-built_in">OH_JSVM_CloseInspector</span>(env);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunScript</span><span class="hljs-params">(JSVM_Env env)</span> </span>{</li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcDebugger.<span class="hljs-built_in">c_str</span>(), srcDebugger.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>
</li><li>    JSVM_Value result;</li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span> </span>{</li><li>    JSVM_InitOptions initOptions{};</li><li>    <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions);</li><li>
</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm);</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>
</li><li>    JSVM_Env env;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;env);</li><li>    <span class="hljs-comment">// 执行JS代码之前打开debugger。</span></li><li>    <span class="hljs-built_in">EnableInspector</span>(env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>
</li><li>    <span class="hljs-comment">// 执行JS代码。</span></li><li>    <span class="hljs-built_in">RunScript</span>(env);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-comment">// 执行JS代码之后关闭debugger。</span></li><li>    <span class="hljs-built_in">CloseInspector</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="使用-oh_jsvm_openinspectorwithname">使用 OH_JSVM_OpenInspectorWithName<i class="anchor-icon anchor-icon-link" anchorid="使用-oh_jsvm_openinspectorwithname" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在应用工程配置文件module.json中配置网络权限：</p>       <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$string:app_name"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-string">"FromAbility"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li></ol></pre></div></div></li>      <li>       <p>为避免debugger过程中的暂停被误报为无响应异常，可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-debug-arkts-debug-V5" target="_blank">开启DevEco Studio的Debug模式</a>（无需设置断点），或者可以在非主线程的其他线程中运行JSVM。</p></li>      <li>       <p>打开 inspector 端口，连接 devtools 用于调试，其流程如下: 在执行JS代码之前，调用OH_JSVM_OpenInspector在指定的主机和端口上激活inspector，创建socket。例如OH_JSVM_OpenInspectorWithName(env, 123, "test")，创建 tcp socket 及其对应的 unixdomain 端口。</p></li>      <li>       <p>调用OH_JSVM_WaitForDebugger，等待建立socket连接。</p></li>      <li>       <p>检查端侧端口是否打开成功。hdc shell "cat /proc/net/unix | grep jsvm"。结果出现可用的 unix 端口即可，如: jsvm_devtools_remote_9229_123，其中 9229 为 tcp 端口号，123 为对应的 pid。</p></li>      <li>       <p>转发端口。hdc fport tcp:9229 tcp:9229。转发开发者个人计算机侧端口9229到端侧端口9229。结果为"Forwardport result:OK"即可。</p></li>      <li>       <p>在 chrome 浏览器地址栏输入 "localhost:9229/json"，回车。获取端口连接信息。打开Chrome开发者工具，拷贝"devtoolsFrontendUrl"字段url内容到地址栏，回车，进入DevTools源码页，将看到在应用中通过OH_JSVM_RunScript执行的JS源码，此时暂停在第一行JS源码处。(注："devtoolsFrontendUrl"字段url只支持使用Chrome、Edge浏览器打开，不支持使用Firefox、Safari等浏览器打开。)</p></li>      <li>       <p>用户可在源码页打断点，通过按钮发出各种调试命令控制JS代码执行，并查看变量。</p></li>      <li>       <p>调用OH_JSVM_CloseInspector关闭inspector，结束socket连接。</p></li>     </ol>     <p><strong>代码示例</strong></p>     <p>对应的 enable inspector 替换为下面的即可</p>     <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 开启debugger</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">EnableInspector</span><span class="hljs-params">(JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-comment">// 在指定的主机和端口上激活inspector，创建socket。</span></li><li>    <span class="hljs-built_in">OH_JSVM_OpenInspectorWithName</span>(env, <span class="hljs-number">123</span>, <span class="hljs-string">"test"</span>);</li><li>    <span class="hljs-comment">// 等待建立socket连接。</span></li><li>    <span class="hljs-built_in">OH_JSVM_WaitForDebugger</span>(env, <span class="hljs-literal">true</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="使用-chrome-inspect-页面进行调试">使用 Chrome inspect 页面进行调试<i class="anchor-icon anchor-icon-link" anchorid="使用-chrome-inspect-页面进行调试" tips="复制节点链接"></i></h3>          <p>除了使用上述打开"devtoolsFrontendUrl"字段url的方法调试代码之外，也可以直接通过Chrome浏览器的 chrome://inspect/#devices 页面进行调试。方法如下：</p>     <ol>      <li>Chrome浏览器中打开 chrome://inspect/#devices，勾选以下内容：<span><img originheight="315" originwidth="621" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114338.10289571617415150285302530678640:50001231000000:2800:CD8DB99C0DB9BEA5A9A459CFD32CFE5D6F27EA4E021B02189B4280A60BCDCC73.png" width="621" height="315"></span></li>      <li>       <p>执行端口转发命令：hdc fport [开发者个人计算机侧端口号] [端侧端口号]</p>       <p>例如：hdc fport tcp:9227 tcp:9226</p></li>      <li>点击Port forwarding按钮，左侧输入开发者个人计算机侧端口，右侧输入端侧端口号，点击done。如下图所示：<span><img originheight="478" originwidth="457" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114338.72633930188204910381277198752538:50001231000000:2800:2D4A8B50282EBB8CBF26FAA88939E79F690E0DD037B28472E1A96C6DB1C93C47.png" width="457" height="478"></span></li>      <li>点击Configure按钮，输入开发者个人计算机侧的端口号，如localhost:9227。如下图所示：<span><img originheight="420" originwidth="364" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114338.94102040005469348531485150248922:50001231000000:2800:32A9B4738BBA00CCAFC30C7D2FEDE0C6238BCE0E226C91D5B5467C0232DC7D39.png" width="364" height="420"></span></li>      <li>稍等片刻，会在target下出现调试的内容，点击inspect即可调试。如下图所示：<span><img originheight="355" originwidth="593" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114338.99320775602474279401977752820537:50001231000000:2800:38E88EAE3CA1DE2FA460384C1671509F8946F0378F36413799435C11A1F743DC.png" width="593" height="355"></span></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="使用-websocket-端口进行调试">使用 websocket 端口进行调试<i class="anchor-icon anchor-icon-link" anchorid="使用-websocket-端口进行调试" tips="复制节点链接"></i></h3>          <p>除了使用上述打开 "devtoolsFrontendUrl" 字段url的方法通过网页端 chrome devtools 调试代码之外，如果读者了解如何使用 CDP 协议代替网页端 devtools 功能，也可以通过连接 inspector 提供的 websocket 端口进行调试。</p>     <p>其中连接 websocket 的方法为，根据前面提供的网页端调试步骤，在做完端口映射之后（如映射到 9229 端口），在 chrome 浏览器地址栏输入 "localhost:9229/json"，回车，获取"webSocketDebuggerUrl" 字段所对应的 url，然后使用标准的 websocket 客户端连接这个 url 即可发送 CDP 调试协议进行调试。需要注意的是，当前版本 inspector 提供的websocket 端口仅支持接收 Text Frame, Ping Frame 和 Connection Close Frame，所有其他类型的帧都会被视为错误帧而导致 websocket 连接中断。</p>     <p>CDP 协议可以参考 chrome 的<a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank">官方文档</a></p>    </div>    <div class="tiledSection">     <h2 id="cpu-profiler及heap-snapshot使用方法">CPU Profiler及Heap Snapshot使用方法<i class="anchor-icon anchor-icon-link" anchorid="cpu-profiler及heap-snapshot使用方法" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="cpu-profiler接口使用方法" class="firsth2">CPU Profiler接口使用方法<i class="anchor-icon anchor-icon-link" anchorid="cpu-profiler接口使用方法" tips="复制节点链接"></i></h3>          <ol>      <li>在执行JS代码之前，调用OH_JSVM_StartCpuProfiler开始采样并返回JSVM_CpuProfiler。</li>      <li>在执行JS代码后，调用OH_JSVM_StopCpuProfiler，传入1中返回的JSVM_CpuProfiler，传入输出流回调及输出流指针。数据将会写入指定的输出流中。</li>      <li>输出数据为JSON字符串。可存入.cpuprofile文件中。该文件类型可导入Chrome浏览器-DevTools-JavaScript Profiler工具中解析成性能分析视图。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="heap-snapshot接口使用方法">Heap Snapshot接口使用方法<i class="anchor-icon anchor-icon-link" anchorid="heap-snapshot接口使用方法" tips="复制节点链接"></i></h3>          <ol>      <li>为分析某段JS代码的堆对象创建情况，可在执行JS代码前后，分别调用一次OH_JSVM_TakeHeapSnapshot。传入输出流回调及输出流指针。数据将会写入指定的输出流中。</li>      <li>输出数据可存入.heapsnapshot文件中。该文件类型可导入Chrome浏览器-DevTools-Memory工具中解析成内存分析视图。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h3>          <p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p>     <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li><li>
</li><li><span class="hljs-comment">// 待调优的JS代码。</span></li><li><span class="hljs-type">static</span> string srcProf = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">function sleep(delay) {</span></li><li><span class="hljs-string">    var start = (new Date()).getTime();</span></li><li><span class="hljs-string">    while ((new Date()).getTime() - start &lt; delay) {</span></li><li><span class="hljs-string">        continue;</span></li><li><span class="hljs-string">    }</span></li><li><span class="hljs-string">}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">function work3() {</span></li><li><span class="hljs-string">    sleep(300);</span></li><li><span class="hljs-string">}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">function work2() {</span></li><li><span class="hljs-string">    work3();</span></li><li><span class="hljs-string">    sleep(200);</span></li><li><span class="hljs-string">}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">function work1() {</span></li><li><span class="hljs-string">    work2();</span></li><li><span class="hljs-string">    sleep(100);</span></li><li><span class="hljs-string">}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">work1();</span></li><li><span class="hljs-string">)JS"</span>;</li><li>
</li><li><span class="hljs-comment">// 数据输出流回调，用户自定义，处理返回的调优数据，此处以写入文件为例。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">OutputStream</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> size, <span class="hljs-type">void</span> *streamData)</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> &amp;os = *<span class="hljs-built_in">reinterpret_cast</span>&lt;ofstream *&gt;(streamData);</li><li>    <span class="hljs-keyword">if</span> (data) {</li><li>        os.<span class="hljs-built_in">write</span>(data, size);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        os.<span class="hljs-built_in">close</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_CpuProfiler <span class="hljs-title">ProfilingBegin</span><span class="hljs-params">(JSVM_VM vm)</span> </span>{</li><li>    <span class="hljs-comment">// 文件输出流，保存调优数据，/data/storage/el2/base/files为沙箱路径。以包名为com.example.helloworld为例。</span></li><li>    <span class="hljs-comment">// 实际文件会保存到/data/app/el2/100/base/com.example.helloworld/files/heap-snapshot-begin.heapsnapshot。</span></li><li>    <span class="hljs-function">ofstream <span class="hljs-title">heapSnapshot</span><span class="hljs-params">(<span class="hljs-string">"/data/storage/el2/base/files/heap-snapshot-begin.heapsnapshot"</span>,</span></span></li><li><span class="hljs-function">                          ios::out | ios::binary | ios::trunc)</span>;</li><li>    <span class="hljs-comment">// 执行JS前获取一次Heap Snapshot数据。</span></li><li>    <span class="hljs-built_in">OH_JSVM_TakeHeapSnapshot</span>(vm, OutputStream, &amp;heapSnapshot);</li><li>    JSVM_CpuProfiler cpuProfiler;</li><li>    <span class="hljs-comment">// 开启CPU Profiler。</span></li><li>    <span class="hljs-built_in">OH_JSVM_StartCpuProfiler</span>(vm, &amp;cpuProfiler);</li><li>    <span class="hljs-keyword">return</span> cpuProfiler;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 关闭调优数据采集工具</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ProfilingEnd</span><span class="hljs-params">(JSVM_VM vm, JSVM_CpuProfiler cpuProfiler)</span> </span>{</li><li>    <span class="hljs-comment">// 文件输出流，保存调优数据，/data/storage/el2/base/files为沙箱路径。以包名为com.example.helloworld为例。</span></li><li>    <span class="hljs-comment">// 实际文件会保存到/data/app/el2/100/base/com.example.helloworld/files/cpu-profile.cpuprofile。</span></li><li>    <span class="hljs-function">ofstream <span class="hljs-title">cpuProfile</span><span class="hljs-params">(<span class="hljs-string">"/data/storage/el2/base/files/cpu-profile.cpuprofile"</span>,</span></span></li><li><span class="hljs-function">                        ios::out | ios::binary | ios::trunc)</span>;</li><li>    <span class="hljs-comment">// 关闭CPU Profiler，获取数据。</span></li><li>    <span class="hljs-built_in">OH_JSVM_StopCpuProfiler</span>(vm, cpuProfiler, OutputStream, &amp;cpuProfile);</li><li>    <span class="hljs-function">ofstream <span class="hljs-title">heapSnapshot</span><span class="hljs-params">(<span class="hljs-string">"/data/storage/el2/base/files/heap-snapshot-end.heapsnapshot"</span>,</span></span></li><li><span class="hljs-function">                              ios::out | ios::binary | ios::trunc)</span>;</li><li>    <span class="hljs-comment">// 执行JS后再获取一次Heap Snapshot数据，与执行前数据作对比，以分析内存问题或者进行内存调优。</span></li><li>    <span class="hljs-built_in">OH_JSVM_TakeHeapSnapshot</span>(vm, OutputStream, &amp;heapSnapshot);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">RunScriptWithStatistics</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>
</li><li>    <span class="hljs-comment">// 开始调优。</span></li><li>    <span class="hljs-keyword">auto</span> cpuProfiler = <span class="hljs-built_in">ProfilingBegin</span>(vm);</li><li>
</li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcProf.<span class="hljs-built_in">c_str</span>(), srcProf.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>
</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 执行JS代码。</span></li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>
</li><li>    <span class="hljs-comment">// 结束调优。</span></li><li>    <span class="hljs-built_in">ProfilingEnd</span>(vm, cpuProfiler);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = RunScriptWithStatistics},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// runScriptWithStatistics方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"runScriptWithStatistics"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div>     <p>样例测试JS</p>     <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(runScriptWithStatistics();)JS"</span>;</li></ol></pre></div></div>     <p>预计的输出结果：</p>     <div _ngcontent-iwe-c106="" class="highlight-div"><div _ngcontent-iwe-c106="" class="highlight-div-header"><div _ngcontent-iwe-c106="" class="highlight-div-header-left"><div _ngcontent-iwe-c106="" class="handle-button expand-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iwe-c106="" class="highlight-div-header-right"><div _ngcontent-iwe-c106="" class="handle-button ai-button"></div><div _ngcontent-iwe-c106="" class="handle-button line-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iwe-c106="" class="handle-button theme-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iwe-c106="" class="handle-button copy-button"><div _ngcontent-iwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iwe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>在对应鸿蒙设备内生成两个文件用于后续调优：</li><li>heap-snapshot-<span class="hljs-keyword">end</span>.heapsnapshot,</li><li>cpu-profile.cpuprofile</li><li>文件功能见上文接口使用方法介绍</li></ol></pre></div></div>    </div>   </div>   <div></div></div>