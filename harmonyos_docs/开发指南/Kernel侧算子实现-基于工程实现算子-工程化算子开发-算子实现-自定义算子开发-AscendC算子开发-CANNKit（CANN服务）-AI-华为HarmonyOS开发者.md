<h1 _ngcontent-lvf-c119="" class="doc-title ng-star-inserted" title="Kernel侧算子实现"> Kernel侧算子实现 </h1>

<div _ngcontent-lvf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-implementation-overview">算子实现</a>章节已经介绍了kernel侧算子核心的实现方法，本章节侧重于介绍接入DDK框架时编程模式和API的使用。</p> <div class="tiledSection"><h2 id="section4356mcpsimp">自动生成kernel侧算子实现模板<i class="anchor-icon anchor-icon-link" anchorid="section4356mcpsimp" tips="复制节点链接"></i></h2><p>在算子工程目录下的“op_kernel/xxx.cpp”文件中实现算子的核函数。核函数的定义模板已通过msOpGen工具自动生成，样例如下所示<strong>。注意这里参数的顺序按照“输入、输出、workspace、tiling”的顺序排布，开发者不要调整其顺序。</strong></p> <div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li>    <span class="hljs-built_in">GET_TILING_DATA</span>(tiling_data, tiling);<span class="hljs-comment">// 获取Tiling参数，详见下文介绍 </span></li><li>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> user kernel impl </span></li><li>}</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>算子原型定义中的输入和输出同名的情况下，自动生成的核函数中，输出参数增加ref后缀予以区分。示例如下。</p> <div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR x_ref, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li>     <span class="hljs-comment">// ... </span></li><li> }</li></ol></pre></div></div> </div></div></div> </div> <div class="tiledSection"><h2 id="section4365mcpsimp">GET_TILING_DATA获取Tiling参数<i class="anchor-icon anchor-icon-link" anchorid="section4365mcpsimp" tips="复制节点链接"></i></h2><p>提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-get-tiling-data">GET_TILING_DATA</a>，用于获取算子kernel入口函数传入的tiling信息，并填入注册的Tiling结构体中，此函数会以宏展开的方式进行编译。注意，对应的算子host实现中需要定义TilingData结构体，实现并注册计算TilingData的Tiling函数。具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tiling-implementation-on-the-host">Host侧Tiling实现</a>。</p> <p>核函数中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-get-tiling-data">GET_TILING_DATA</a>获取TilingData的样例如下。</p> <div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <strong><span class="hljs-built_in">GET_TILING_DATA</span>(tilingData, tiling);</strong> </li><li>    KernelAdd op; </li><li>    op.<span class="hljs-built_in">Init</span>(x, y, z, tilingData.totalLength, tilingData.tileNum); </li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">1</span>)) { </li><li>        op.<span class="hljs-built_in">Process</span>(); </li><li>    } </li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section4375mcpsimp">核函数内推导输入数据类型和格式<i class="anchor-icon anchor-icon-link" anchorid="section4375mcpsimp" tips="复制节点链接"></i></h2><p>算子工程在核函数内提供了DTYPE_&lt;Arg&gt;、ORIG_DTYPE_&lt;Arg&gt;、FORMAT_&lt;Arg&gt;三种宏用于推导核函数入参的数据类型、原始数据类型和数据格式。其中&lt;Arg&gt;会自动大写。样例如下。</p> <div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> T&gt; <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>{} </li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    DTYPE_X temp; </li><li>    <span class="hljs-built_in">func</span>&lt;DTYPE_Z&gt;(); </li><li>    <span class="hljs-keyword">if</span> (FORMAT_Y == FORMAT_ND) { </li><li>        <span class="hljs-comment">// ... </span></li><li>    } </li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section4379mcpsimp">输出shape依赖计算的算子kernel侧实现<i class="anchor-icon anchor-icon-link" anchorid="section4379mcpsimp" tips="复制节点链接"></i></h2><p>某些算子，比如NonZero（统计tensor中非零值的个数），计算完成前无法得知算子输出的shape信息，算子计算完成后才能获取。该类算子在原型定义时，需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-outputshapedependoncompute">OutputShapeDependOnCompute</a>接口进行标识，同时在算子核函数中将实际输出shape写入到出参中，便于框架侧基于该信息进行输出内存的管理。</p> <p>在核函数所有输出的最后增加一个GM_ADDR类型的输出参数，并在核函数计算完成后，将输出shape信息写入到该出参中。shape信息的排布格式如下，大小为<strong>n * (8 + 1)</strong>，每个元素的数据类型为<strong>uint64_t</strong>。其中n表示待刷新shape信息的输出个数，每个输出的shape信息都通过第1个元素来保存实际的shape维度(dim)，后续的8个元素来保存具体每个维度的shape信息。</p> <p class="msonormal"><span><img height="171.57000000000002" originheight="313" originwidth="948" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114312.47421111656051786988628464335102:50001231000000:2800:78321EEF3E92AC150B143A1B4E4FDA1C71585236CD34CA7EC9A918D625B815B5.png" title="点击放大" width="526.6800000000001"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>输出的顺序和原型定义中输出的顺序保持一致。</li></ul> <ul><li>对于uint64_t的输出数据类型（对于tensor而言），需要将dim的uint32_t的高位设置为1，表示以uint64_t类型解析该tensor。</li></ul> </div></div></div> <ul><li>如下示例中，算子中有一个输出依赖计算得出，输出tensor的数据类型为uint32_t，计算完成后，得到输出的shape为（32, 64），出参shape_out用于存放该shape信息，值为（2, 32, 64）。代码示例如下。<div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">xxx_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR shape_out, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li> <span class="hljs-comment">// ... </span></li><li>     <span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> SHAPEOUT_SIZE = <span class="hljs-number">9</span>; </li><li>     <span class="hljs-comment">// 输出数据为2维([32, 64])，tensor类型为uint32_t </span></li><li>     GlobalTensor&lt;<span class="hljs-type">uint64_t</span>&gt; shapeoutGlobal_uint32; </li><li>     shapeoutGlobal_uint32.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ <span class="hljs-type">uint64_t</span>*)shape_out, SHAPEOUT_SIZE); </li><li>     shapeoutGlobal_uint32.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>); </li><li>     shapeoutGlobal_uint32.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>); </li><li>     shapeoutGlobal_uint32.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>); </li><li> <span class="hljs-comment">// ... </span></li><li> }</li></ol></pre></div></div> </li><li>如下示例中，算子中有一个输出依赖计算得出，输出tensor的数据类型为uint64_t，计算完成后，得到输出的shape为（32, 64），出参shape_out用于存放该shape信息，值为（0x0000000010000000 | 2, 32, 64）。代码示例如下。<div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">xxx_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR shape_out, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li> <span class="hljs-comment">// ... </span></li><li>     <span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> SHAPEOUT_SIZE = <span class="hljs-number">9</span>; </li><li>     <span class="hljs-comment">// 输出数据为4维([1, 64, 128, 128])，tensor类型为uint64_t </span></li><li>     GlobalTensor&lt;<span class="hljs-type">uint64_t</span>&gt; shapeoutGlobal_uint64; </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ <span class="hljs-type">uint64_t</span>*)shape_out, SHAPEOUT_SIZE); </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x0000000010000000</span> | <span class="hljs-number">4</span>); </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>); </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>); </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>); </li><li>     shapeoutGlobal_uint64.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">4</span>, <span class="hljs-number">128</span>); </li><li> <span class="hljs-comment">// ... </span></li><li> }</li></ol></pre></div></div> </li><li>如下示例中，算子中有两个输出依赖计算得出，输出tensor的数据类型为uint64_t，计算完成后，得到输出的shape为（16, 32）和 （1, 16, 16, 32），出参shape_out用于存放该shape信息。示例如下。<div _ngcontent-lvf-c106="" class="highlight-div"><div _ngcontent-lvf-c106="" class="highlight-div-header"><div _ngcontent-lvf-c106="" class="highlight-div-header-left"><div _ngcontent-lvf-c106="" class="handle-button expand-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvf-c106="" class="highlight-div-header-right"><div _ngcontent-lvf-c106="" class="handle-button ai-button"></div><div _ngcontent-lvf-c106="" class="handle-button line-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvf-c106="" class="handle-button theme-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvf-c106="" class="handle-button copy-button"><div _ngcontent-lvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">xxx_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR shape_out, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li>     <span class="hljs-comment">// ... </span></li><li>     <span class="hljs-comment">// 有两个输出需要刷新shape，一个维度为2维[16, 32]，一个维度为4维[1, 16, 16, 32] </span></li><li>     <span class="hljs-comment">// tensor类型为uint64_t </span></li><li>     <span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> SHAPEOUT_SIZE_2 = <span class="hljs-number">18</span>; </li><li>     GlobalTensor&lt;<span class="hljs-type">uint64_t</span>&gt; shapeoutGlobal_uint64_2; </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ <span class="hljs-type">uint64_t</span>*)shape_out, SHAPEOUT_SIZE_2 ); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x0000000010000000</span> | <span class="hljs-number">2</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">1</span>, <span class="hljs-number">16</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>); </li><li>     <span class="hljs-comment">// index[3]~index[8]数据为占位</span></li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">9</span>, <span class="hljs-number">0x0000000010000000</span> | <span class="hljs-number">4</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">11</span>, <span class="hljs-number">16</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">12</span>, <span class="hljs-number">16</span>); </li><li>     shapeoutGlobal_uint64_2.<span class="hljs-built_in">SetValue</span>(<span class="hljs-number">13</span>, <span class="hljs-number">32</span>); </li><li>     <span class="hljs-comment">// ... </span></li><li> }</li></ol></pre></div></div> </li></ul> </div> </div> <div></div></div>