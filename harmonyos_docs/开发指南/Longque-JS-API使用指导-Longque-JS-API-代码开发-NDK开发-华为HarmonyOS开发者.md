<h1 _ngcontent-dqe-c119="" class="doc-title ng-star-inserted" title="Longque-JS-API使用指导"> Longque-JS-API使用指导 </h1>

<div _ngcontent-dqe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Longque JS API 由 Longque JS Engine 提供，适用于在 HarmonyOS 平台构建稳定、高性能的应用。所有 API 均位于 __Longque__ 对象下。接口的版本可通过 __Longque__.version 获得，开发者可使用该版本进行特性判断。</p> <p><strong>【注意】：Longque JS API 处于实验阶段，使用前请阅读本文档，评估其稳定性和兼容性。</strong></p>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">createDelegate</td> <td class="cellrowborder" valign="top" width="50%">创建委托</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="属性说明">属性说明<i class="anchor-icon anchor-icon-link" anchorid="属性说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" valign="top" width="50%">属性</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">version</td> <td class="cellrowborder" valign="top" width="50%">用于表示 Longque JS API 的版本</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">SKIP_PROTOTYPE_CHAIN</td> <td class="cellrowborder" valign="top" width="50%">createDelegate 的属性过滤器，表示只委托自身属性，不考虑原型链</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">SKIP_PREFIX_UNDERSCORE</td> <td class="cellrowborder" valign="top" width="50%">createDelegate 的属性过滤器，表示过滤掉名字以 '_' 开头的属性</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">SKIP_PREFIX_DOLLAR</td> <td class="cellrowborder" valign="top" width="50%">createDelegate 的属性过滤器，表示过滤掉名字以 '$' 开头的属性</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">SKIP_CONSTRUCTOR</td> <td class="cellrowborder" valign="top" width="50%">createDelegate 的属性过滤器，表示过滤掉 'constructor' 属性</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="createdelegate接口">createDelegate接口<i class="anchor-icon anchor-icon-link" anchorid="createdelegate接口" tips="复制节点链接"></i></h2> <p>接口引入版本 : 1</p>  </div>  <div class="tiledSection"><h3 id="接口描述" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.1.4.1.1" valign="top" width="33.33333333333333%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.4.1.2" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">createDelegate</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">创建委托</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">创建 underlyingObject 的委托对象，对委托对象的属性读写操作将映射至 underlyingObject。通过 initObject 指定初始委托对象，通过 propertyFilterFlags 指定属性过滤器。默认情况下，将映射 underlyingObject 及其原型链上所有可枚举的字符串键属性。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="参数">参数<i class="anchor-icon anchor-icon-link" anchorid="参数" tips="复制节点链接"></i></h3><p>(1) underlyingObject： 必选参数。表示被委托的底层对象。参数要求：</p> <ul><li>underlyingObject 必须是对象，否则会抛出 TypeError 异常。</li><li>若 underlyingObject 是代理对象，将抛出 TypeError 异常。</li><li>若未指定 SKIP_PROTOTYPE_CHAIN 过滤器，且 underlyingObject 原型链上存在代理对象，则抛出 TypeError 异常。</li></ul> <p>(2) initObject：可选参数。表示初始委托对象。若传入 undefined，表示不指定初始对象，将由接口自动创建。参数要求：</p> <ul><li>initObject 必须是对象，否则会抛出 TypeError 异常。</li><li>若 initObject 是代理对象，将抛出 TypeError 异常。</li><li>不能将委托对象作为 initObject，否则抛出 TypeError 异常。</li><li>若 initObject 是不可扩展的，则抛出 TypeError 异常。</li><li>若 initObject 中某些属性无法定义，将抛出 TypeError 异常，此时 initObject 中仅部分属性定义成功。</li></ul> <p>(3) propertyFilterFlags：可选参数。表示属性过滤器。如果传入的是 undefined，表示不指定过滤器。参数要求：</p> <ul><li>以下列出了当前支持的属性过滤器（未来可能扩展）。</li></ul> <div _ngcontent-dqe-c106="" class="highlight-div"><div _ngcontent-dqe-c106="" class="highlight-div-header"><div _ngcontent-dqe-c106="" class="highlight-div-header-left"><div _ngcontent-dqe-c106="" class="handle-button expand-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dqe-c106="" class="highlight-div-header-right"><div _ngcontent-dqe-c106="" class="handle-button ai-button"></div><div _ngcontent-dqe-c106="" class="handle-button line-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dqe-c106="" class="handle-button theme-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dqe-c106="" class="handle-button copy-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dqe-c106="" class="highlight-scroll-div"><pre class="sh prettyprint linenums hljs language-bash" hw-language="sh" data-highlighted="yes"><ol class="linenums"><li>__Longque__.SKIP_PROTOTYPE_CHAIN: 只委托 underlyingObject 自身属性，不考虑原型链</li><li>__Longque__.SKIP_PREFIX_UNDERSCORE: 过滤掉名字以 <span class="hljs-string">'_'</span> 开头的属性</li><li>__Longque__.SKIP_PREFIX_DOLLAR: 过滤掉名字以 <span class="hljs-string">'$'</span> 开头的属性</li><li>__Longque__.SKIP_CONSTRUCTOR: 过滤掉 <span class="hljs-string">'constructor'</span> 属性</li></ol></pre></div></div> <ul><li>必须使用列出的过滤器，否则接口行为未定义，可能导致代码兼容性问题。</li><li>所有过滤器均为 number 类型，可用 | 运算符同时指定多个。</li><li>若 propertyFilterFlags 非 number 类型，抛出 TypeError 异常。</li></ul> </div>  <div class="tiledSection"><h3 id="返回值">返回值<i class="anchor-icon anchor-icon-link" anchorid="返回值" tips="复制节点链接"></i></h3><p>只有接口在不抛出异常的情况下，才会正确返回：</p> <ul><li>若未指定初始委托对象，返回新创建的委托对象。</li><li>若已指定初始委托对象，返回该初始委托对象。</li></ul> </div>  <div class="tiledSection"><h3 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h3><p>(1) 委托对象的属性顺序可能与 for-in、Object.keys 方法的结果不一致，请勿依赖属性顺序。</p> <p>(2) 委托对象的实现是引擎内部机制。请勿依赖在委托对象上调用 Object.getOwnPropertyDescriptor、getOwnPropertyDescriptors、Reflect.getOwnPropertyDescriptor 等接口的返回结果。</p> </div>  <div class="tiledSection"><h3 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h3><p>本示例展示了在 JSVM 中使用 Longque JS API 的方式，JSVM-API 接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> <p>cpp部分代码：</p> <div _ngcontent-dqe-c106="" class="highlight-div"><div _ngcontent-dqe-c106="" class="highlight-div-header"><div _ngcontent-dqe-c106="" class="highlight-div-header-left"><div _ngcontent-dqe-c106="" class="handle-button expand-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dqe-c106="" class="highlight-div-header-right"><div _ngcontent-dqe-c106="" class="handle-button ai-button"></div><div _ngcontent-dqe-c106="" class="handle-button line-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dqe-c106="" class="handle-button theme-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dqe-c106="" class="handle-button copy-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dqe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 待执行的js代码</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *STR_TASK = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">  function createDelegateTest() {</span></li><li><span class="hljs-string">    var myobj = {</span></li><li><span class="hljs-string">      42: 0,</span></li><li><span class="hljs-string">      x: 1,</span></li><li><span class="hljs-string">      _y: 2,</span></li><li><span class="hljs-string">      $z:3</span></li><li><span class="hljs-string">    };</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    var proto = {</span></li><li><span class="hljs-string">      foo: 'foo'</span></li><li><span class="hljs-string">    };</span></li><li><span class="hljs-string">    Object.setPrototypeOf(myobj, proto);</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    var d1 = __Longque__.createDelegate(myobj, undefined);</span></li><li><span class="hljs-string">    consoleinfo(JSON.stringify(d1)); // {"42":0,"x":1,"_y":2,"$z":3,"foo":"foo"}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    const propertyFilterFlags = __Longque__.SKIP_PREFIX_UNDERSCORE | __Longque__.SKIP_PREFIX_DOLLAR;</span></li><li><span class="hljs-string">    var d2 = __Longque__.createDelegate(myobj, undefined, propertyFilterFlags);</span></li><li><span class="hljs-string">    consoleinfo(JSON.stringify(d2)); // {"42":0,"x":1,"foo":"foo"}</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    d2[42] = 100;</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    const newFilter = propertyFilterFlags | __Longque__.SKIP_PROTOTYPE_CHAIN;</span></li><li><span class="hljs-string">    var d3 = __Longque__.createDelegate(myobj, undefined, newFilter);</span></li><li><span class="hljs-string">    consoleinfo(JSON.stringify(d3)); // {"42":100,"x":1}</span></li><li><span class="hljs-string">  }</span></li><li><span class="hljs-string">  createDelegateTest();</span></li><li><span class="hljs-string">)JS"</span>;</li><li>
</li><li><span class="hljs-comment">// 保证js代码中的打印信息可以正常输出</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ConsoleInfo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">char</span> log[<span class="hljs-number">256</span>] = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-type">size_t</span> logLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], log, <span class="hljs-number">255</span>, &amp;logLength);</li><li>    log[<span class="hljs-number">255</span>] = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: %{public}s"</span>, log);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册consoleinfo的方法</span></li><li>JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = ConsoleInfo},</li><li>};</li><li>JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"consoleinfo"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span> </span>{</li><li>    JSVM_InitOptions init_options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;init_options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(init_options));</li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;init_options);</li><li>        g_aa++;</li><li>    }</li><li>    <span class="hljs-comment">// 创建JavaScript虚拟机实例,打开虚拟机作用域</span></li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm));</li><li>    JSVM_VMScope vm_scope;</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vm_scope));</li><li>
</li><li>    JSVM_Env env;</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env));</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    JSVM_HandleScope handlescope;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handlescope));</li><li>    JSVM_Value sourcecodevalue;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, STR_TASK, <span class="hljs-built_in">strlen</span>(STR_TASK), &amp;sourcecodevalue));</li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, sourcecodevalue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    JSVM_Value result;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-comment">// 关闭并销毁环境和虚拟机</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handlescope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vm_scope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>预期的输出:</p> <div _ngcontent-dqe-c106="" class="highlight-div"><div _ngcontent-dqe-c106="" class="highlight-div-header"><div _ngcontent-dqe-c106="" class="highlight-div-header-left"><div _ngcontent-dqe-c106="" class="handle-button expand-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dqe-c106="" class="highlight-div-header-right"><div _ngcontent-dqe-c106="" class="handle-button ai-button"></div><div _ngcontent-dqe-c106="" class="handle-button line-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dqe-c106="" class="handle-button theme-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dqe-c106="" class="handle-button copy-button"><div _ngcontent-dqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">API</span> <span class="hljs-variable">TEST</span>: {<span class="hljs-string">"42"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"_y"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"$z"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"foo"</span>:<span class="hljs-string">"foo"</span>}</li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">API</span> <span class="hljs-variable">TEST</span>: {<span class="hljs-string">"42"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"foo"</span>:<span class="hljs-string">"foo"</span>}</li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">API</span> <span class="hljs-variable">TEST</span>: {<span class="hljs-string">"42"</span>:<span class="hljs-number">100</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">1</span>}</li></ol></pre></div></div> </div> </div> <div></div></div>