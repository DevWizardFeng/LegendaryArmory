<h1 _ngcontent-sbj-c119="" class="doc-title ng-star-inserted" title="MVVM模式（状态管理V2）"> MVVM模式（状态管理V2） </h1>

<div _ngcontent-sbj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2><p>在应用开发中，UI的更新需要随着数据状态的变化进行实时同步，而这种同步往往决定了应用程序的性能和用户体验。为了解决数据与UI同步的复杂性，ArkUI采用了Model-View-ViewModel（MVVM）架构模式。MVVM将应用分为Model、View和ViewModel三个核心部分，实现数据、视图与逻辑的分离。通过这种模式，UI可以随着状态的变化自动更新，无需手动处理，从而高效管理数据和视图的绑定与更新。</p> <ul><li>Model：存储和管理应用数据及业务逻辑，不直接与用户界面交互。通常从后端接口获取数据，是应用程序的数据基础，确保数据的一致性和完整性。</li><li>View：负责用户界面展示数据并与用户交互，不包含任何业务逻辑。它通过绑定ViewModel层提供的数据来动态更新UI。</li><li>ViewModel：负责管理UI状态和交互逻辑。作为连接Model和View的桥梁，ViewModel监控Model数据的变化，通知View更新UI，同时处理用户交互事件并转换为数据操作。</li></ul> </div>  <div class="tiledSection"><h2 id="通过状态管理v2版本实现viewmodel">通过状态管理V2版本实现ViewModel<i class="anchor-icon anchor-icon-link" anchorid="通过状态管理v2版本实现viewmodel" tips="复制节点链接"></i></h2><p>在MVVM模式中，ViewModel负责管理数据状态，并在数据变化时自动更新视图。ArkUI的状态管理V2版本提供了丰富的装饰器和工具，帮助开发者在自定义组件之间共享数据，确保数据变化自动同步到UI。常用的状态管理装饰器包括@Local、@Param、@Event、@ObservedV2、@Trace等等。此外，V2还提供了AppStorageV2和PersistenceV2作为全局状态存储工具，用于应用间的状态共享和持久化存储。</p> <p>本节将通过一个简单的todolist示例，逐步引入和使用状态管理V2的装饰器及工具，从基础的静态任务列表开始，逐步扩展功能。每个步骤都基于上一步扩展，帮助开发者循序渐进地理解并掌握各个装饰器的使用方法。</p> </div>  <div class="tiledSection"><h3 id="基础示例" class="firsth2">基础示例<i class="anchor-icon anchor-icon-link" anchorid="基础示例" tips="复制节点链接"></i></h3><p>首先，从静态待办事项列表开始。在示例1中，任务是静态的，没有状态变化和动态交互。</p> <p><strong>示例1</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/1-Basic.ets</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Task1'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Task2'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Task3'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加local实现对组件内部状态观测">添加@Local，实现对组件内部状态观测<i class="anchor-icon anchor-icon-link" anchorid="添加local实现对组件内部状态观测" tips="复制节点链接"></i></h3><p>完成静态待办列表展示后，为了让用户能够更改任务的完成状态，需要使待办事项能够响应交互并动态更新显示。为此，引入@Local装饰器管理组件内部的状态。被@Local装饰的变量发生变化时，触发绑定的UI组件刷新。</p> <p>在示例2中，新增@Local装饰的isFinish属性代表任务是否完成。两个图标finished.png和unfinished.png用于展示任务完成或未完成的状态。点击待办事项时，isFinish状态切换，更新图标和文本删除线的效果。</p> <p><strong>示例2</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/2-Local.ets</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Task1'</span>)</li><li>          .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加param实现组件接受外部输入">添加@Param，实现组件接受外部输入<i class="anchor-icon anchor-icon-link" anchorid="添加param实现组件接受外部输入" tips="复制节点链接"></i></h3><p>实现任务本地状态切换后，为增强待办事项列表的灵活性，需要能够动态设置每个任务的名称，而不是固定在代码中。引入@Param装饰器后，子组件被装饰的变量可以接收父组件传入的值，实现单向数据同步。@Param默认只读，使用@Param @Once可在子组件中对传入的值进行本地更新。</p> <p>在示例3中，每个待办事项抽象为TaskItem组件。@Param修饰的taskName属性从父组件TodoList传入任务名称，使TaskItem组件灵活且可复用，能够接收并渲染不同的任务名称。@Param @Once装饰的isFinish属性接收初始值后，可在子组件内更新。</p> <p><strong>示例3</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/3-Param.ets</span></li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">TaskItem</span>({ <span class="hljs-attr">taskName</span>: <span class="hljs-string">'Task 1'</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-literal">false</span> })</li><li>      <span class="hljs-title class_">TaskItem</span>({ <span class="hljs-attr">taskName</span>: <span class="hljs-string">'Task 2'</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-literal">false</span> })</li><li>      <span class="hljs-title class_">TaskItem</span>({ <span class="hljs-attr">taskName</span>: <span class="hljs-string">'Task 3'</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-literal">false</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加event实现组件对外输出">添加@Event，实现组件对外输出<i class="anchor-icon anchor-icon-link" anchorid="添加event实现组件对外输出" tips="复制节点链接"></i></h3><p>实现任务名称动态设置后，任务列表内容固定。为了实现任务列表的动态扩展，需要增加任务项的添加和删除功能。为此，引入@Event装饰器，用于子组件向父组件输出数据。</p> <p>在示例4中，每个TaskItem增加了删除按钮，同时任务列表底部增加了添加新任务的功能。点击子组件TaskItem的“删除”按钮时，deleteTask事件会被触发并传递给父组件TodoList，父组件响应并移除任务。通过使用@Param和@Event，子组件不仅能接收父组件的数据，还能将事件传递回父组件，实现数据双向同步。</p> <p><strong>示例4</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/4-Event.ets</span></li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">tasks</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'task1'</span>,<span class="hljs-string">'task2'</span>,<span class="hljs-string">'task3'</span>];</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>, <span class="hljs-function">(<span class="hljs-params">task: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">taskName</span>: task,</li><li>            <span class="hljs-attr">isFinish</span>: <span class="hljs-literal">false</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(task), <span class="hljs-number">1</span>)</li><li>          })</li><li>      })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加repeat实现子组件复用">添加Repeat，实现子组件复用<i class="anchor-icon anchor-icon-link" anchorid="添加repeat实现子组件复用" tips="复制节点链接"></i></h3><p>添加任务增删功能后，任务列表项增加，需要高效渲染多个结构相同的子组件，提高界面性能。引入Repeat方法，优化任务列表渲染。</p> <p>Repeat支持两种场景：懒加载场景和非懒加载场景。</p> <ul><li>懒加载场景适用于大量数据的场景，在滚动类容器中按需加载组件，极大节省内存和提升渲染效率。</li><li>非懒加载场景适用于数据量较小的场景，一次性渲染所有组件，并在数据变化时仅更新需要变化的部分，避免整体重新渲染。</li></ul> <p>在示例5中，由于任务量较少，使用Repeat非懒加载场景。新建任务数组tasks，并使用Repeat方法迭代数组中的每一项，动态生成并复用TaskItem组件。任务增删时，这种方式能高效复用已有组件，避免重复渲染，提高界面响应速度和性能。这种机制有效地提高了代码的复用性和渲染效率。</p> <p><strong>示例5</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/5-Repeat.ets</span></li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">tasks</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'task1'</span>,<span class="hljs-string">'task2'</span>,<span class="hljs-string">'task3'</span>];</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>)</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">taskName</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">isFinish</span>: <span class="hljs-literal">false</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加observedv2trace实现类属性观测变化">添加@ObservedV2，@Trace，实现类属性观测变化<i class="anchor-icon anchor-icon-link" anchorid="添加observedv2trace实现类属性观测变化" tips="复制节点链接"></i></h3><p>实现多个功能后，任务列表管理变得复杂。为了有效处理任务数据的变化，特别是在多层嵌套结构中，需要确保属性变化能够被深度观测并自动更新UI。为此，引入了@ObservedV2和@Trace装饰器。与仅能观测对象及其第一层变化的@Local不同，@ObservedV2和@Trace适用于多层嵌套和继承等复杂场景。在@ObservedV2装饰的类中，@Trace装饰的属性变化时，会触发绑定的UI组件刷新。</p> <p>在示例6中，任务（Task）被抽象为一个类，并用@ObservedV2标记该类，用@Trace标记isFinish属性。TodoList组件嵌套了TaskItem，TaskItem又嵌套了Task。在最外层的TodoList中，添加了"全部完成"和"全部未完成"的按钮，每次点击这些按钮都会直接更新最内层Task类的isFinish属性。@ObservedV2和@Trace确保可以观察到对应isFinish UI组件的刷新，从而实现了对嵌套类属性的深度观测。</p> <p><strong>示例6</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/6-ObservedV2Trace.ets</span></li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span> (<span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span> = taskName;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = isFinish;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">''</span>, <span class="hljs-literal">false</span>);</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Task</span>[] = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task1'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task2'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task3'</span>, <span class="hljs-literal">false</span>),</li><li>  ];</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-params">ifFinish: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>) {</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">Task</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>)</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;Task&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部未完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>      }</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>, <span class="hljs-literal">false</span>));</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加monitorcomputed实现监听状态变量和计算属性">添加@Monitor，@Computed，实现监听状态变量和计算属性<i class="anchor-icon anchor-icon-link" anchorid="添加monitorcomputed实现监听状态变量和计算属性" tips="复制节点链接"></i></h3><p>在当前任务列表功能基础上，为了提升体验，可以增加一些额外的功能，如任务状态变化的监听和未完成任务数量的动态计算。为此，引入@Monitor和@Computed装饰器。@Monitor用于深度监听状态变量，在属性变化时触发自定义回调方法。@Computed用于装饰getter方法，检测被计算的属性变化。被计算的值变化时，仅计算一次，减少重复计算开销。</p> <p>在示例7中，使用@Monitor装饰器深度监听TaskItem中task的isFinish属性。当任务完成状态变化时，触发onTasksFinished回调，记录任务完成状态的变化。同时，新增对todolist中未完成任务数量的记录。使用@Computed装饰器定义tasksUnfinished，每当任务状态变化时自动重新计算。通过这两个装饰器，实现了状态变量的深度监听和高效的计算属性。</p> <p><strong>示例7</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/7-MonitorComputed.ets</span></li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span> (<span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span> = taskName;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = isFinish;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">''</span>, <span class="hljs-literal">false</span>);</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'task.isFinish'</span>)</li><li>  <span class="hljs-title function_">onTaskFinished</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'任务'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span> + <span class="hljs-string">'的完成状态从'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">before</span> + <span class="hljs-string">'变为了'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">now</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Task</span>[] = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task1'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task2'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task3'</span>, <span class="hljs-literal">false</span>),</li><li>  ];</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-params">ifFinish: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>) {</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tasksUnfinished</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> !task.<span class="hljs-property">isFinish</span>).<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`未完成任务：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasksUnfinished}</span>`</span>)</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">Task</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>)</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;Task&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部未完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>      }</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>, <span class="hljs-literal">false</span>));</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加appstoragev2实现应用全局ui状态存储">添加AppStorageV2，实现应用全局UI状态存储<i class="anchor-icon anchor-icon-link" anchorid="添加appstoragev2实现应用全局ui状态存储" tips="复制节点链接"></i></h3><p>随着待办事项功能的增强，应用涉及多个页面或功能模块时，需要在这些页面之间共享全局状态。例如：在待办事项应用中，新增一个设置页面与主界面联动。为实现跨页面的状态共享，引入AppStorageV2，用于在多个UIAbility实例之间存储和共享应用的全局状态。</p> <p>在这个示例中，新增了一个Ability，SettingAbility，用于加载设置页面SettingPage。SettingPage包含了一个Setting类，其中的showCompletedTask属性用于控制是否显示已完成的任务。用户可以通过一个开关切换该选项。两个Ability通过AppStorageV2共享设置数据，键为 "Setting"，对应的数据为Setting类。第一次通过connect连接Setting时，如果不存在存储的数据，会创建一个showCompletedTask默认为true的Setting实例。后续用户在设置页面修改设置后，主页面会根据这一设置更新任务列表的显示。通过AppStorageV2，实现了跨Ability、跨页面的数据共享。</p> <p><strong>示例8</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/8-AppStorageV2.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setting</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SettingPage'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span> (<span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span> = taskName;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = isFinish;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">''</span>, <span class="hljs-literal">false</span>);</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'task.isFinish'</span>)</li><li>  <span class="hljs-title function_">onTaskFinished</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'任务'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span> + <span class="hljs-string">'的完成状态从'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">before</span> + <span class="hljs-string">'变为了'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">now</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Task</span>[] = [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task1'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task2'</span>, <span class="hljs-literal">false</span>),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-string">'task3'</span>, <span class="hljs-literal">false</span>),</li><li>  ];</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-params">ifFinish: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>) {</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tasksUnfinished</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> !task.<span class="hljs-property">isFinish</span>).<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`未完成任务：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasksUnfinished}</span>`</span>)</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">Task</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> || !task.<span class="hljs-property">isFinish</span>))</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;Task&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部未完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'设置'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">wantInfo</span>: <span class="hljs-title class_">Want</span> = {</li><li>              <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// deviceId为空表示本设备。</span></li><li>              <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.statemgmtv2mvvm'</span>, <span class="hljs-comment">// 替换成AppScope/app.json5里的bundleName。</span></li><li>              <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'SettingAbility'</span>,</li><li>            };</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(wantInfo);</li><li>          })</li><li>      }</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>, <span class="hljs-literal">false</span>));</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SettingAbility的SettingPage页面代码。</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Setting</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">showCompletedTask</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">SettingPage</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'设置'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'显示已完成任务'</span>);</li><li>        <span class="hljs-title class_">Toggle</span>({ <span class="hljs-attr">type</span>: <span class="hljs-title class_">ToggleType</span>.<span class="hljs-property">Switch</span>, <span class="hljs-attr">isOn</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">isOn</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> = isOn;</li><li>          })</li><li>      }</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'返回待办'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">terminateSelf</span>())</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加persistencev2实现持久化ui状态存储">添加PersistenceV2，实现持久化UI状态存储<i class="anchor-icon anchor-icon-link" anchorid="添加persistencev2实现持久化ui状态存储" tips="复制节点链接"></i></h3><p>为了确保用户重新打开应用时能看到之前的任务状态，建议使用PersistenceV2进行数据持久化存储。PersistenceV2可将数据保存在设备磁盘上，与AppStorageV2的运行时内存相比，它能确保数据在应用关闭后再次启动时保持不变。</p> <p>在示例9中，创建了一个TaskList类，用于通过PersistenceV2持久化存储所有任务信息，键为"TaskList"，数据对应TaskList类。第一次通过connect连接TaskList时，如果没有数据，会创建一个默认tasks数组为空的新TaskList实例。在aboutToAppear生命周期函数中，连接到PersistenceV2的TaskList，若无存储任务数据，会从本地文件defaultTasks.json中加载任务并存储到PersistenceV2中。此后，每个任务的完成状态都会同步到PersistenceV2中。这样，即使应用关闭后再次打开，所有任务数据依旧保持不变，实现了持久化的应用状态存储功能。</p> <p><strong>示例9</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/9-PersistenceV2.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span>, <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setting</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SettingPage'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-comment">// 未实现构造函数，因为@Type当前不支持带参数的构造函数。</span></li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Todo'</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskList</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功。</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">Task</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Task</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tasks: Task[]</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = tasks;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">let</span> getJson = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'defaultTasks.json'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">textDecoderOptions</span>: util.<span class="hljs-property">TextDecoderOptions</span> = { ignoreBOM : <span class="hljs-literal">true</span> };</li><li>    <span class="hljs-keyword">let</span> textDecoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>,textDecoderOptions);</li><li>    <span class="hljs-keyword">let</span> result = textDecoder.<span class="hljs-title function_">decodeToString</span>(getJson);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> =<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">task: Task</span>)=&gt;</span>{</li><li>      <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>      newTask.<span class="hljs-property">taskName</span> = task.<span class="hljs-property">taskName</span>;</li><li>      newTask.<span class="hljs-property">isFinish</span> = task.<span class="hljs-property">isFinish</span>;</li><li>      <span class="hljs-keyword">return</span> newTask;</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'task.isFinish'</span>)</li><li>  <span class="hljs-title function_">onTaskFinished</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'任务'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span> + <span class="hljs-string">'的完成状态从'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">before</span> + <span class="hljs-string">'变为了'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">now</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">taskList</span>: <span class="hljs-title class_">TaskList</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskList</span>([]);</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">TaskList</span>, <span class="hljs-string">'TaskList'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskList</span>([]))!;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">loadTasks</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-params">ifFinish: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>) {</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tasksUnfinished</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> !task.<span class="hljs-property">isFinish</span>).<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`未完成任务：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasksUnfinished}</span>`</span>)</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">Task</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> || !task.<span class="hljs-property">isFinish</span>))</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;Task&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'全部未完成'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'设置'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">wantInfo</span>: <span class="hljs-title class_">Want</span> = {</li><li>              <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// deviceId为空表示本设备。</span></li><li>              <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.statemgmtv2mvvm'</span>, <span class="hljs-comment">// 替换成AppScope/app.json5里的bundleName。</span></li><li>              <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'SettingAbility'</span>,</li><li>            };</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(wantInfo);</li><li>          })</li><li>      }</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'增加事项'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>            newTask.<span class="hljs-property">taskName</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>JSON文件存放在src/main/resources/rawfile/defaultTasks.json路径下。</p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">[</span></li><li>  <span class="hljs-punctuation">{</span><span class="hljs-attr">"taskName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"学习ArkTS开发"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"isFinish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span><span class="hljs-attr">"taskName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"健身"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"isFinish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span><span class="hljs-attr">"taskName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"买水果"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"isFinish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span><span class="hljs-attr">"taskName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"取快递"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"isFinish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span><span class="hljs-attr">"taskName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"刷题"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"isFinish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="添加builder实现自定义构建函数">添加@Builder，实现自定义构建函数<i class="anchor-icon anchor-icon-link" anchorid="添加builder实现自定义构建函数" tips="复制节点链接"></i></h3><p>随着应用功能逐步扩展，代码中的某些UI元素开始重复，不仅增加了代码量，也让维护变得复杂。为解决此问题，建议使用@Builder装饰器，将重复的UI组件抽象为独立的构建方法，便于复用和代码模块化。</p> <p>在示例10中，通过使用@Builder定义的ActionButton方法，实现了按钮文字、样式和点击事件的统一管理，提高了代码的简洁性和可维护性。同时优化了界面组件的布局和样式，包括间距、颜色和尺寸等视觉元素，最终呈现出一个功能完善且界面简洁美观的待办事项应用。</p> <p><strong>示例10</strong></p> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/10-Builder.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span>, <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setting</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SettingPage'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li>  <span class="hljs-comment">// 未实现构造函数，因为@Type当前不支持带参数的构造函数。</span></li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Todo'</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ActionButton</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, onClick:() =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>  <span class="hljs-title class_">Button</span>(text, { <span class="hljs-attr">buttonStyle</span>: <span class="hljs-title class_">ButtonStyleMode</span>.<span class="hljs-property">NORMAL</span> })</li><li>    .<span class="hljs-title function_">onClick</span>(onClick)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">5</span> })</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskList</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功。</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">Task</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Task</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tasks: Task[]</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = tasks;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">let</span> getJson = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'defaultTasks.json'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">textDecoderOptions</span>: util.<span class="hljs-property">TextDecoderOptions</span> = { ignoreBOM : <span class="hljs-literal">true</span> };</li><li>    <span class="hljs-keyword">let</span> textDecoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>,textDecoderOptions);</li><li>    <span class="hljs-keyword">let</span> result = textDecoder.<span class="hljs-title function_">decodeToString</span>(getJson);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> =<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">task: Task</span>)=&gt;</span>{</li><li>      <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>      newTask.<span class="hljs-property">taskName</span> = task.<span class="hljs-property">taskName</span>;</li><li>      newTask.<span class="hljs-property">isFinish</span> = task.<span class="hljs-property">isFinish</span>;</li><li>      <span class="hljs-keyword">return</span> newTask;</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'task.isFinish'</span>)</li><li>  <span class="hljs-title function_">onTaskFinished</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'任务'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span> + <span class="hljs-string">'的完成状态从'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">before</span> + <span class="hljs-string">'变为了'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">now</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ left : <span class="hljs-number">15</span>, right : <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)</li><li>      <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'删除'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'7%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#90f1f3f5'</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">25</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">taskList</span>: <span class="hljs-title class_">TaskList</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">TaskList</span>, <span class="hljs-string">'TaskList'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskList</span>([]))!;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">loadTasks</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-params">ifFinish: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>) {</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tasksUnfinished</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> !task.<span class="hljs-property">isFinish</span>).<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`未完成任务：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasksUnfinished}</span>`</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">Task</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> || !task.<span class="hljs-property">isFinish</span>))</li><li>        .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;Task&gt;</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">TaskItem</span>({</li><li>            <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>            <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(obj.<span class="hljs-property">item</span>), <span class="hljs-number">1</span>)</li><li>          }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>        })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'全部完成'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'全部未完成'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'设置'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">wantInfo</span>: <span class="hljs-title class_">Want</span> = {</li><li>            <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// deviceId为空表示本设备。</span></li><li>            <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.statemgmtv2mvvm'</span>, <span class="hljs-comment">// 替换成AppScope/app.json5里的bundleName。</span></li><li>            <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'SettingAbility'</span>,</li><li>          };</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(wantInfo);</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">5</span> })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'+'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();</li><li>          newTask.<span class="hljs-property">taskName</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>        })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">15</span> })</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="效果图展示">效果图展示<i class="anchor-icon anchor-icon-link" anchorid="效果图展示" tips="复制节点链接"></i></h3><p><span><img originheight="726" originwidth="356" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114922.66984581312473333413952295452795:50001231000000:2800:E3706BB6C9206EFD1EB1AFF2F41158AE81976B3F6EF3E3DDDADDDFB72030C3FE.gif" width="356" height="726"></span></p> </div>  <div class="tiledSection"><h2 id="重构代码以符合mvvm架构">重构代码以符合MVVM架构<i class="anchor-icon anchor-icon-link" anchorid="重构代码以符合mvvm架构" tips="复制节点链接"></i></h2><p>前面的例子通过使用一系列的状态管理装饰器，实现了todolist中的数据同步与UI更新。然而，随着应用功能的复杂化，代码的结构变得难以维护，Model、View和ViewModel的职责没有完全分离，存在耦合。为了更好地组织代码和提升可维护性，使用MVVM模式重构代码，进一步将数据层（Model）、逻辑层（ViewModel）和展示层（View）分离。</p> </div>  <div class="tiledSection"><h3 id="重构后的代码结构" class="firsth2">重构后的代码结构<i class="anchor-icon anchor-icon-link" anchorid="重构后的代码结构" tips="复制节点链接"></i></h3><div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>/src</li><li>├── /main</li><li>│   ├── /ets</li><li>│   │   ├── /entryability</li><li>│   │   ├── /model</li><li>│   │   │   ├── TaskListModel.ets</li><li>│   │   │   └── TaskModel.ets</li><li>│   │   ├── /pages</li><li>│   │   │   ├── SettingPage.ets</li><li>│   │   │   └── TodoListPage.ets</li><li>│   │   ├── /settingability</li><li>│   │   ├── /view</li><li>│   │   │   ├── BottomView.ets</li><li>│   │   │   ├── ListView.ets</li><li>│   │   │   └── TitleView.ets</li><li>│   │   ├── /viewmodel</li><li>│   │   │   ├── TaskListViewModel.ets</li><li>│   │   │   └── TaskViewModel.ets</li><li>│   └── /resources</li><li>│       ├── ...</li><li>├─── ... </li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="model层">Model层<i class="anchor-icon anchor-icon-link" anchorid="model层" tips="复制节点链接"></i></h3><p>Model层负责管理应用的数据及其业务逻辑，通常与后端或数据存储进行交互。在todolist应用中，Model层的主要职责是存储任务数据、加载任务列表，并提供数据操作的接口，而不直接涉及UI展示。</p> <ul><li>TaskModel：单个任务的基本数据结构，包含任务名称和完成状态。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/model/TaskModel.ets</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskModel</span> {</li><li>  <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Todo'</span>;</li><li>  <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div> <ul><li>TaskListModel：任务的集合，提供从本地加载任务数据的功能。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/model/TaskListModel.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskModel</span> <span class="hljs-keyword">from</span><span class="hljs-string">'./TaskModel'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskListModel</span> {</li><li>  <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">TaskModel</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tasks: TaskModel[]</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = tasks;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params">context: common.UIAbilityContext</span>){</li><li>    <span class="hljs-keyword">let</span> getJson = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'defaultTasks.json'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">textDecoderOptions</span>: util.<span class="hljs-property">TextDecoderOptions</span> = { ignoreBOM : <span class="hljs-literal">true</span> };</li><li>    <span class="hljs-keyword">let</span> textDecoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>,textDecoderOptions);</li><li>    <span class="hljs-keyword">let</span> result = textDecoder.<span class="hljs-title function_">decodeToString</span>(getJson);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> =<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">task: TaskModel</span>)=&gt;</span>{</li><li>      <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskModel</span>();</li><li>      newTask.<span class="hljs-property">taskName</span> = task.<span class="hljs-property">taskName</span>;</li><li>      newTask.<span class="hljs-property">isFinish</span> = task.<span class="hljs-property">isFinish</span>;</li><li>      <span class="hljs-keyword">return</span> newTask;</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="viewmodel层">ViewModel层<i class="anchor-icon anchor-icon-link" anchorid="viewmodel层" tips="复制节点链接"></i></h3><p>ViewModel层管理UI状态和业务逻辑，连接Model和View。通过监控Model数据变化，处理应用逻辑，将数据同步到View层，从而实现UI的自动更新。使用ViewModel实现数据与视图解耦，提高代码可读性和可维护性。</p> <ul><li>TaskViewModel：封装单个任务的数据和状态变更逻辑，通过状态装饰器监控数据的变化。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/viewmodel/TaskViewModel.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/TaskModel'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskViewModel</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">taskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Todo'</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isFinish</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">updateTask</span>(<span class="hljs-params">task: TaskModel</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskName</span> = task.<span class="hljs-property">taskName</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = task.<span class="hljs-property">isFinish</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateIsFinish</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinish</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> <ul><li>TaskListViewModel：封装了任务列表以及管理功能，包括加载任务、批量更新任务状态，以及添加和删除任务。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/viewmodel/TaskListViewModel.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskListModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/TaskListModel'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskViewModel</span> <span class="hljs-keyword">from</span><span class="hljs-string">'./TaskViewModel'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskListViewModel</span> {</li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">TaskViewModel</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">TaskViewModel</span>[] = [];</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">let</span> taskList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskListModel</span>([]);</li><li>    <span class="hljs-keyword">await</span> taskList.<span class="hljs-title function_">loadTasks</span>(context);</li><li>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> taskList.<span class="hljs-property">tasks</span>){</li><li>      <span class="hljs-keyword">let</span> taskViewModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskViewModel</span>();</li><li>      taskViewModel.<span class="hljs-title function_">updateTask</span>(task);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(taskViewModel);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishAll</span>(<span class="hljs-attr">ifFinish</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> task <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>){</li><li>      task.<span class="hljs-property">isFinish</span> = ifFinish;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">addTask</span>(<span class="hljs-attr">newTask</span>: <span class="hljs-title class_">TaskViewModel</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">removeTask</span>(<span class="hljs-attr">removedTask</span>: <span class="hljs-title class_">TaskViewModel</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">indexOf</span>(removedTask), <span class="hljs-number">1</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="view层">View层<i class="anchor-icon anchor-icon-link" anchorid="view层" tips="复制节点链接"></i></h3><p>View层负责应用程序的UI展示和与用户的交互。它只关注如何渲染用户界面和展示数据，不包含业务逻辑。所有的数据状态和逻辑都来自ViewModel层，View层通过接收ViewModel传递的状态数据进行渲染，确保视图和数据分离。</p> <ul><li>TitleView：负责展示应用的标题和未完成任务的统计信息。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/TitleView.ets</span></li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">TitleView</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">tasksUnfinished</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'待办'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`未完成任务：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tasksUnfinished}</span>`</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <ul><li>ListView：负责展示任务列表，并根据Setting中的设置筛选是否显示已完成的任务。它依赖于TaskListViewModel来获取任务数据，并通过TaskItem组件进行渲染，包括任务的名称、完成状态以及删除按钮。通过TaskViewModel和TaskListViewModel实现用户的交互，如切换任务完成状态和删除任务。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/ListView.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/TaskViewModel'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskListViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/TaskListViewModel'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setting</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/SettingPage'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ActionButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./BottomView'</span>;</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TaskItem</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">TaskViewModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskViewModel</span>();</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'task.isFinish'</span>)</li><li>  <span class="hljs-title function_">onTaskFinished</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'任务'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span> + <span class="hljs-string">'的完成状态从'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">before</span> + <span class="hljs-string">'变为了'</span> + mon.<span class="hljs-title function_">value</span>()?.<span class="hljs-property">now</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 请开发者自行在src/main/resources/base/media路径下添加finished.png和unfinished.png两张图片，否则运行时会因资源缺失而报错。</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? $r(<span class="hljs-string">'app.media.finished'</span>) : $r(<span class="hljs-string">'app.media.unfinished'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">28</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">taskName</span>)</li><li>        .<span class="hljs-title function_">decoration</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-property">isFinish</span> ? <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">LineThrough</span> : <span class="hljs-title class_">TextDecorationType</span>.<span class="hljs-property">None</span> })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)</li><li>      <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'删除'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteTask</span>());</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'7%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#90f1f3f5'</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">25</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">task</span>.<span class="hljs-title function_">updateIsFinish</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">ListView</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">taskList</span>: <span class="hljs-title class_">TaskListViewModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskListViewModel</span>();</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Repeat</span>&lt;<span class="hljs-title class_">TaskViewModel</span>&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> || !task.<span class="hljs-property">isFinish</span>))</li><li>      .<span class="hljs-title function_">each</span>(<span class="hljs-function">(<span class="hljs-params">obj: RepeatItem&lt;TaskViewModel&gt;</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">TaskItem</span>({</li><li>          <span class="hljs-attr">task</span>: obj.<span class="hljs-property">item</span>,</li><li>          <span class="hljs-attr">deleteTask</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">removeTask</span>(obj.<span class="hljs-property">item</span>)</li><li>        }).<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>      })</li><li>  }</li><li>}</li></ol></pre></div></div> <ul><li>BottomView：负责提供与任务操作相关的按钮和输入框，如"全部完成"、"全部未完成"，"设置"三个按钮，以及添加新任务的输入框。点击"全部完成"和"全部未完成"时，通过TaskListViewModel更改所有任务的状态。点击"设置"按钮时，会导航到SettingAbility的设置页面。添加新任务时，通过TaskListViewModel新增任务到任务列表中。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/BottomView.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/TaskViewModel'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskListViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/TaskListViewModel'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span> <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ActionButton</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, onClick:() =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>  <span class="hljs-title class_">Button</span>(text, { <span class="hljs-attr">buttonStyle</span>: <span class="hljs-title class_">ButtonStyleMode</span>.<span class="hljs-property">NORMAL</span> })</li><li>    .<span class="hljs-title function_">onClick</span>(onClick)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">5</span> })</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">BottomView</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">taskList</span>: <span class="hljs-title class_">TaskListViewModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskListViewModel</span>();</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">newTaskName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'全部完成'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">true</span>))</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'全部未完成'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">finishAll</span>(<span class="hljs-literal">false</span>))</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'设置'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">wantInfo</span>: <span class="hljs-title class_">Want</span> = {</li><li>            <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// deviceId为空表示本设备。</span></li><li>            <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.statemgmtv2mvvm'</span>, <span class="hljs-comment">// 替换成AppScope/app.json5里的bundleName。</span></li><li>            <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'SettingAbility'</span>,</li><li>          };</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(wantInfo);</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">5</span> })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'添加新任务'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = value)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-title class_">ActionButton</span>(<span class="hljs-string">'+'</span>, (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> newTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskViewModel</span>();</li><li>          newTask.<span class="hljs-property">taskName</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">addTask</span>(newTask);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">newTaskName</span> = <span class="hljs-string">''</span>;</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <ul><li>TodoListPage：todolist的主页面，包含以上的三个View组件（TitleView、ListView、BottomView），用于统一展示待办事项的各个部分，管理任务列表和用户设置。TodoListPage负责从ViewModel中获取数据，并将数据传递给各个子View组件进行渲染，通过PersistenceV2持久化任务数据，确保数据在应用重启后仍能保持一致。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/TodoListPage.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskListViewModel</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/TaskListViewModel'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span>, <span class="hljs-title class_">PersistenceV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Setting</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/SettingPage'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">TitleView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../view/TitleView'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">ListView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../view/ListView'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">BottomView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../view/BottomView'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">TodoList</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">taskList</span>: <span class="hljs-title class_">TaskListViewModel</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">TaskListViewModel</span>, <span class="hljs-string">'TaskList'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskListViewModel</span>())!;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">TaskListViewModel</span>, <span class="hljs-string">'TaskList'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskListViewModel</span>())!;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">loadTasks</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">tasksUnfinished</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> !task.<span class="hljs-property">isFinish</span>).<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">TitleView</span>({ <span class="hljs-attr">tasksUnfinished</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksUnfinished</span> })</li><li>      <span class="hljs-title class_">ListView</span>({ <span class="hljs-attr">taskList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>, <span class="hljs-attr">setting</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span> });</li><li>      <span class="hljs-title class_">BottomView</span>({ <span class="hljs-attr">taskList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span> });</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">15</span> })</li><li>  }</li><li>}</li></ol></pre></div></div> <ul><li>SettingPage：设置页面，负责管理是否显示已完成任务的设置。通过AppStorageV2应用全局存储用户的设置，用户通过Toggle开关切换showCompletedTask状态。</li></ul> <div _ngcontent-sbj-c106="" class="highlight-div"><div _ngcontent-sbj-c106="" class="highlight-div-header"><div _ngcontent-sbj-c106="" class="highlight-div-header-left"><div _ngcontent-sbj-c106="" class="handle-button expand-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbj-c106="" class="highlight-div-header-right"><div _ngcontent-sbj-c106="" class="handle-button ai-button"></div><div _ngcontent-sbj-c106="" class="handle-button line-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbj-c106="" class="handle-button theme-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbj-c106="" class="handle-button copy-button"><div _ngcontent-sbj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/SettingPage.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStorageV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Setting</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">showCompletedTask</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">SettingPage</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">setting</span>: <span class="hljs-title class_">Setting</span> = <span class="hljs-title class_">AppStorageV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Setting</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setting</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>){</li><li>    <span class="hljs-title class_">Column</span>(){</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'设置'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'显示已完成任务'</span>);</li><li>        <span class="hljs-title class_">Toggle</span>({ <span class="hljs-attr">type</span>: <span class="hljs-title class_">ToggleType</span>.<span class="hljs-property">Switch</span>, <span class="hljs-attr">isOn</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> })</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">isOn</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">setting</span>.<span class="hljs-property">showCompletedTask</span> = isOn;</li><li>          })</li><li>      }</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'返回待办'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">terminateSelf</span>())</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="总结">总结<i class="anchor-icon anchor-icon-link" anchorid="总结" tips="复制节点链接"></i></h2><p>本指南通过待办事项应用示例，引入状态管理V2装饰器，并通过代码重构实现MVVM架构。最终将数据、业务逻辑和视图展示分层处理，使得代码结构更加清晰且易于维护。开发者通过正确应用Model、View和ViewModel分层结构，能够更好地理解和应用MVVM模式，进而在实际项目中提升开发效率、保证代码质量，并优化数据与UI的同步机制，简化整体开发流程。</p> </div>  <div class="tiledSection"><h2 id="代码示例">代码示例<i class="anchor-icon anchor-icon-link" anchorid="代码示例" tips="复制节点链接"></i></h2><p><a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/ArkUISample/StateMgmtV2MVVM/entry" target="_blank">完整源码</a></p> </div> </div> <div></div></div>