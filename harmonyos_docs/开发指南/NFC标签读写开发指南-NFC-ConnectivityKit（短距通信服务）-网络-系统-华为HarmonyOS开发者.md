<h1 _ngcontent-xwm-c119="" class="doc-title ng-star-inserted" title="NFC标签读写开发指南"> NFC标签读写开发指南 </h1>

<div _ngcontent-xwm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>近场通信(Near Field Communication，NFC)是一种短距高频的无线电技术，在13.56MHz频率运行，通信距离一般在10厘米距离内。电子设备可以通过NFC通信技术和NFC标签通信，从标签中读取数据，或写入数据到标签。</p>     <p>NFC标签支持一种或多种通信技术，具体技术如下：</p>     <ul>      <li>NfcA (也称为 ISO 14443-3A)</li>      <li>NfcB (也称为 ISO 14443-3B)</li>      <li>NfcF (也称为 JIS 6319-4)</li>      <li>NfcV (也称为 ISO 15693)</li>      <li>IsoDep (也称为 ISO 14443-4)</li>      <li>NDEF</li>      <li>MifareClassic</li>      <li>MifareUltralight</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>电子设备通过NFC天线位置触碰NFC标签卡片，完成NFC标签卡片的读取或写入。从使用场景上，可以分成NFC标签前台读写和NFC标签后台读写。</p>     <ul>      <li>       <p>NFC标签前台读写</p>       <p>前台读写是指在触碰NFC标签之前，用户先在电子设备上打开特定的应用程序，用户明确想使用所打开的应用程序和NFC标签进行读写操作。用户打开应用程序在前台，并且进入应用的刷卡页面之后，电子设备触碰NFC标签，只会把读取到的卡片分发给前台应用。</p></li>      <li>       <p>NFC标签后台读写</p>       <p>后台读写是指不打开特定的NFC标签应用程序，电子设备触碰发现NFC标签后，根据NFC标签的技术类型，分发给能够处理的应用程序。如果能匹配到多个应用程序，则弹出应用选择器列举出应用列表给用户手动选择。用户选择指定的应用后，自动跳转到应用程序的NFC标签读写卡页面。</p></li>      <li>       <p>标签读写约束条件</p>       <p>不管是前台读写，还是后台读写，电子设备能够发现NFC标签的前提条件是设备必须是亮屏和解锁状态。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>NFC标签读写完整的JS API说明以及实例代码请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-nfctag" target="_blank">NFC标签接口</a>。</p>     <p>获取不同技术类型标签对象的接口说明如下表，根据不同技术的标签对象来执行NFC标签的读写。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">getNfcA(tagInfo: TagInfo): NfcATag</td>         <td class="cellrowborder" valign="top" width="50%">获取NfcA技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getNfcB(tagInfo: TagInfo): NfcBTag</td>         <td class="cellrowborder" valign="top" width="50%">获取NfcB技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getNfcF(tagInfo: TagInfo): NfcFTag</td>         <td class="cellrowborder" valign="top" width="50%">获取NfcF技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getNfcV(tagInfo: TagInfo): NfcVTag</td>         <td class="cellrowborder" valign="top" width="50%">获取NfcV技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getIsoDep(tagInfo: TagInfo): IsoDepTag</td>         <td class="cellrowborder" valign="top" width="50%">获取IsoDep技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getNdef(tagInfo: TagInfo): NdefTag</td>         <td class="cellrowborder" valign="top" width="50%">获取NDEF技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getMifareClassic(tagInfo: TagInfo): MifareClassicTag</td>         <td class="cellrowborder" valign="top" width="50%">获取MifareClassic技术类型的标签对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getMifareUltralight(tagInfo: TagInfo): MifareUltralightTag</td>         <td class="cellrowborder" valign="top" width="50%">获取MifareUltralight技术类型的标签对象。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发准备">开发准备<i class="anchor-icon anchor-icon-link" anchorid="开发准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="nfc标签前台读写或后台读写的选择" class="firsth2">NFC标签前台读写或后台读写的选择<i class="anchor-icon anchor-icon-link" anchorid="nfc标签前台读写或后台读写的选择" tips="复制节点链接"></i></h3>          <p>NFC标签读写应用开发者根据业务需要，可以选择实现前台读卡或者后台读卡。两种不同的读卡方式，代码实现上会存在一些差异。</p>     <ul>      <li>       <p>NFC标签前台读写</p></li>     </ul>     <ol>      <li>在配置文件module.json5中，不需要静态声明过滤读取NFC标签的技术类型，而是通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-nfctag#tagregisterforegrounddispatch10" target="_blank">tag.registerForegroundDispatch</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-nfctag#tagon11" target="_blank">tag.on</a>来完成动态注册。</li>      <li>通过registerForegroundDispatch或on来动态注册前台读写标签时，入参中必须指定需要读取NFC标签的技术类型。</li>      <li>如果选择registerForegroundDispatch注册，当应用运行在前台并进入该页面，NFC的卡模拟功能在打开时，可以同时完成刷卡。如果选择tag.on注册，当应用运行在前台并进入该页面时，NFC的卡模拟是关闭的，无法同时进行刷卡功能。</li>      <li>当应用页面切换到后台时，需要显式调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-nfctag#tagunregisterforegrounddispatch10" target="_blank">tag.unregisterForegroundDispatch</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-nfctag#tagoff11" target="_blank">tag.off</a>来取消注册，退出前台读卡优先功能。</li>     </ol>     <ul>      <li>       <p>NFC标签后台读写</p></li>     </ul>     <ol>      <li>在配置文件module.json5中，需要静态声明过滤读取NFC标签的技术类型。根据业务需要至少定义一种读标签的技术类型，‘tag-tech/’是前缀，后面跟着技术类型描述。</li>      <li>技术类型的描述字符，必须完整匹配并区分大小写，需要严格匹配。</li>     </ol>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>从API version 9之后的应用开发新增支持Stage模型，作为目前主推并长期演进的模型。</li>        <li>NFC标签读写示例代码的提供，全部按照Stage模型来说明。</li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="前台读取标签" class="firsth2">前台读取标签<i class="anchor-icon anchor-icon-link" anchorid="前台读取标签" tips="复制节点链接"></i></h3>          <ol>      <li>在module.json5文件中声明NFC标签读取的权限，以及声明NFC标签特定的action。</li>      <li>import需要的tag模块和其他相关的模块。</li>      <li>判断设备是否支持NFC能力。</li>      <li>调用tag模块中前台优先的接口，使能前台应用程序优先处理所发现的NFC标签功能。</li>      <li>获取特定技术类型的NFC标签对象。</li>      <li>执行读写接口完成标签数据的读取或写入数据到标签。</li>      <li>退出应用程序NFC标签页面时，调用tag模块退出前台优先功能。</li>     </ol>     <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ts"</span>,</li><li>        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,</li><li>        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,</li><li>        <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"$color:start_window_background"</span>,</li><li>        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">"skills"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"entities"</span>: [</li><li>              <span class="hljs-string">"entity.system.home"</span></li><li>            ],</li><li>            <span class="hljs-string">"actions"</span>: [</li><li>              <span class="hljs-string">"ohos.want.action.home"</span>,</li><li>
</li><li>              <span class="hljs-comment">// actions必须包含"ohos.nfc.tag.action.TAG_FOUND"</span></li><li>              <span class="hljs-string">"ohos.nfc.tag.action.TAG_FOUND"</span></li><li>            ]</li><li>          }</li><li>        ]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-comment">// 添加NFC标签操作的权限</span></li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.NFC_TAG"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:app_name"</span>,</li><li>      }</li><li>    ]</li></ol></pre></div></div>     <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { tag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">nfcTagElementName</span>: bundleManager.<span class="hljs-property">ElementName</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">foregroundRegister</span>: <span class="hljs-built_in">boolean</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readerModeCb</span>(<span class="hljs-params">error: BusinessError, tagInfo: tag.TagInfo</span>) {</li><li>  <span class="hljs-keyword">if</span> (!error) {</li><li>    <span class="hljs-comment">// 获取特定技术类型的NFC标签对象</span></li><li>    <span class="hljs-keyword">if</span> (tagInfo == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb tagInfo is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">uid</span> == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb uid is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">technology</span> == <span class="hljs-literal">null</span> || tagInfo.<span class="hljs-property">technology</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb technology is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 标签里面可能支持多种技术类型，选择特定的技术类型接口，完成标签数据的读取或写入</span></li><li>    <span class="hljs-comment">// 下面示例代码，使用IsoDep完成标签数据的读取或写入</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isoDep</span>: tag.<span class="hljs-property">IsoDepTag</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tagInfo.<span class="hljs-property">technology</span>.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">technology</span>[i] == tag.<span class="hljs-property">ISO_DEP</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          isoDep = tag.<span class="hljs-title function_">getIsoDep</span>(tagInfo);</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb getIsoDep error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// 也可以按需选择其它类型的技术读写标签</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (isoDep == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb getIsoDep is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 使用IsoDep技术连接到NFC标签</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      isoDep.<span class="hljs-title function_">connect</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb isoDep.connect() error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!isoDep.<span class="hljs-title function_">isConnected</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb isoDep.isConnected() false.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 发送指令到已连接的标签，获取标签的响应数据</span></li><li>    <span class="hljs-keyword">let</span> cmdData = [<span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>]; <span class="hljs-comment">// 修改为正确的访问标签的指令数据</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      isoDep.<span class="hljs-title function_">transmit</span>(cmdData).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: <span class="hljs-built_in">number</span>[]</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb isoDep.transmit() response = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response));</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb isoDep.transmit() err = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (businessError) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb isoDep.transmit() businessError = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(businessError));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'readerModeCb readerModeCb error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 判断设备是否支持NFC能力</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Communication.NFC.Core"</span>)) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'nfc unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 根据应用程序信息，初始化正确的值</span></li><li>    nfcTagElementName = {</li><li>      <span class="hljs-attr">bundleName</span>: want.<span class="hljs-property">bundleName</span> ?? <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">abilityName</span>: want.<span class="hljs-property">abilityName</span> ?? <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">moduleName</span>: want.<span class="hljs-property">moduleName</span>,</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 应用进入前台，调用tag模块中前台优先的接口，使能前台应用程序优先处理所发现的NFC标签功能</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>    <span class="hljs-keyword">if</span> (nfcTagElementName != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 根据业务需要，选择需要读取标签的通信技术</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">techList</span>: <span class="hljs-built_in">number</span>[] = [tag.<span class="hljs-property">NFC_A</span>, tag.<span class="hljs-property">NFC_B</span>, tag.<span class="hljs-property">NFC_F</span>, tag.<span class="hljs-property">NFC_V</span>];</li><li>      <span class="hljs-keyword">try</span> {</li><li>        tag.<span class="hljs-title function_">on</span>(<span class="hljs-string">'readerMode'</span>, nfcTagElementName, techList, readerModeCb);</li><li>        foregroundRegister = <span class="hljs-literal">true</span>;</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'on readerMode error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>    <span class="hljs-comment">// 退出应用程序NFC标签页面时，调用tag模块退出前台优先功能</span></li><li>    <span class="hljs-keyword">if</span> (foregroundRegister) {</li><li>      foregroundRegister = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        tag.<span class="hljs-title function_">off</span>(<span class="hljs-string">'readerMode'</span>, nfcTagElementName);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'off readerMode error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="后台读取标签">后台读取标签<i class="anchor-icon anchor-icon-link" anchorid="后台读取标签" tips="复制节点链接"></i></h3>          <ol>      <li>在module.json5文件中声明NFC标签读取的权限，声明NFC标签特定的action，以及声明本应用程序的能够处理的NFC标签技术类型。</li>      <li>import需要的tag模块和其他相关的模块。</li>      <li>获取特定技术类型的NFC标签对象。</li>      <li>执行读写接口完成标签数据的读取或写入数据到标签。</li>     </ol>     <p>应用程序需要支持后台读卡时，需要在应用的属性配置文件中，声明与NFC相关的属性值。比如，在module.json5文件中，声明下面属性值。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>声明"actions"字段的内容填写，必须包含"ohos.nfc.tag.action.TAG_FOUND"，不能更改。</li>        <li>声明技术时"uris"中"type"字段的内容填写，前缀必须是"tag-tech/"，后面接着NfcA/NfcB/NfcF/NfcV/IsoDep/Ndef/MifareClassic/MifareUL/NdefFormatable"中的一个。如果存在多个"type"时，需要分行填写。填写错误会造成解析失败。</li>        <li>声明权限时"requestPermissions"中的"name"字段的内容填写，必须是"ohos.permission.NFC_TAG"，不能更改。</li>        <li>Wearable设备不支持后台读卡。</li>       </ol>      </div></div></div>     <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ts"</span>,</li><li>        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,</li><li>        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,</li><li>        <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"$media:icon"</span>,</li><li>        <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"$color:start_window_background"</span>,</li><li>        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">"skills"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"entities"</span>: [</li><li>              <span class="hljs-string">"entity.system.home"</span></li><li>            ],</li><li>            <span class="hljs-string">"actions"</span>: [</li><li>              <span class="hljs-string">"ohos.want.action.home"</span>,</li><li>
</li><li>              <span class="hljs-comment">// actions必须包含"ohos.nfc.tag.action.TAG_FOUND"</span></li><li>              <span class="hljs-string">"ohos.nfc.tag.action.TAG_FOUND"</span></li><li>            ],</li><li>
</li><li>            <span class="hljs-comment">// 根据业务需要至少定义一种读标签的技术类型，‘tag-tech/’是前缀，后面跟着技术类型描述</span></li><li>            <span class="hljs-string">"uris"</span>: [</li><li>              {</li><li>                  <span class="hljs-string">"type"</span>:<span class="hljs-string">"tag-tech/NfcA"</span></li><li>              },</li><li>              {</li><li>                  <span class="hljs-string">"type"</span>:<span class="hljs-string">"tag-tech/IsoDep"</span></li><li>              }</li><li>              <span class="hljs-comment">// 必要时可添加其他技术类型</span></li><li>              <span class="hljs-comment">// 例如: NfcB/NfcF/NfcV/Ndef/MifareClassic/MifareUL/NdefFormatable</span></li><li>            ]</li><li>          }</li><li>        ]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-comment">// 添加NFC标签操作的权限</span></li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.NFC_TAG"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:app_name"</span>,</li><li>      }</li><li>    ]</li></ol></pre></div></div>     <div _ngcontent-xwm-c106="" class="highlight-div"><div _ngcontent-xwm-c106="" class="highlight-div-header"><div _ngcontent-xwm-c106="" class="highlight-div-header-left"><div _ngcontent-xwm-c106="" class="handle-button expand-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xwm-c106="" class="highlight-div-header-right"><div _ngcontent-xwm-c106="" class="handle-button ai-button"></div><div _ngcontent-xwm-c106="" class="handle-button line-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xwm-c106="" class="handle-button theme-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xwm-c106="" class="handle-button copy-button"><div _ngcontent-xwm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xwm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { tag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取特定技术类型的NFC标签对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tagInfo</span>: tag.<span class="hljs-property">TagInfo</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      tagInfo = tag.<span class="hljs-title function_">getTagInfo</span>(want);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getTagInfo error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (tagInfo == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'tagInfo is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">uid</span> == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'uid is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">technology</span> == <span class="hljs-literal">null</span> || tagInfo.<span class="hljs-property">technology</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'technology is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 标签里面可能支持多种技术类型，选择特定的技术类型接口，完成标签数据的读取或写入</span></li><li>    <span class="hljs-comment">// 下面示例代码，使用IsoDep完成标签数据的读取或写入</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isoDep</span>: tag.<span class="hljs-property">IsoDepTag</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tagInfo.<span class="hljs-property">technology</span>.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">if</span> (tagInfo.<span class="hljs-property">technology</span>[i] == tag.<span class="hljs-property">ISO_DEP</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          isoDep = tag.<span class="hljs-title function_">getIsoDep</span>(tagInfo);</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getIsoDep error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// 也可以按需选择其它类型的技术读写标签</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (isoDep == <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getIsoDep is invalid'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 使用IsoDep技术连接到NFC标签</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      isoDep.<span class="hljs-title function_">connect</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'isoDep.connect() error = %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!isoDep.<span class="hljs-title function_">isConnected</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'isoDep.isConnected() false.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 发送指令到已连接的标签，获取标签的响应数据</span></li><li>    <span class="hljs-keyword">let</span> cmdData = [<span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>]; <span class="hljs-comment">// 修改为正确的访问标签的指令数据</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      isoDep.<span class="hljs-title function_">transmit</span>(cmdData).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: <span class="hljs-built_in">number</span>[]</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'isoDep.transmit() response = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response));</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'isoDep.transmit() err = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (businessError) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'isoDep.transmit() businessError = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(businessError));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>