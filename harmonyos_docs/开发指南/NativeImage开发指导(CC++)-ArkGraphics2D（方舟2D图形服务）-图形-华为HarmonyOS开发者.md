<h1 _ngcontent-utl-c119="" class="doc-title ng-star-inserted" title="NativeImage开发指导 (C/C++)"> NativeImage开发指导 (C/C++) </h1>

<div _ngcontent-utl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>NativeImage是提供<strong>Surface关联OpenGL外部纹理</strong>的模块，表示图形队列的消费者端。开发者可以通过NativeImage接口接收和使用Buffer，并将Buffer关联输出到OpenGL外部纹理。</p>     <p>针对NativeImage，常见的开发场景如下：</p>     <ul>      <li>通过NativeImage提供的Native API接口创建NativeImage实例作为消费者端，获取与该实例对应的NativeWindow作为生产者端。NativeWindow相关接口可用于填充Buffer内容并提交，NativeImage将Buffer内容更新到OpenGL外部纹理上。本模块需要配合NativeWindow、NativeBuffer、EGL、GLES3模块一起使用。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_Create (uint32_t textureId, uint32_t textureTarget)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个OH_NativeImage实例，该实例与OpenGL ES的纹理ID和纹理目标相关联。本接口需要与OH_NativeImage_Destroy接口配合使用，否则会存在内存泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_AcquireNativeWindow (OH_NativeImage *image)</td>         <td class="cellrowborder" valign="top" width="50%">获取与OH_NativeImage相关联的OHNativeWindow指针，该OHNativeWindow在调用OH_NativeImage_Destroy时会将其释放，不需要调用OH_NativeWindow_DestroyNativeWindow释放，否则会出现访问已释放内存错误，可能会导致崩溃。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_AttachContext (OH_NativeImage *image, uint32_t textureId)</td>         <td class="cellrowborder" valign="top" width="50%">将OH_NativeImage实例附加到当前OpenGL ES上下文，且该OpenGL ES纹理会绑定到 GL_TEXTURE_EXTERNAL_OES，并通过OH_NativeImage进行更新。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_DetachContext (OH_NativeImage *image)</td>         <td class="cellrowborder" valign="top" width="50%">将OH_NativeImage实例从当前OpenGL ES上下文分离。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_UpdateSurfaceImage (OH_NativeImage *image)</td>         <td class="cellrowborder" valign="top" width="50%">通过OH_NativeImage获取最新帧更新相关联的OpenGL ES纹理。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_GetTimestamp (OH_NativeImage *image)</td>         <td class="cellrowborder" valign="top" width="50%">获取最近调用OH_NativeImage_UpdateSurfaceImage的纹理图像的相关时间戳。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_GetTransformMatrixV2 (OH_NativeImage *image, float matrix[16])</td>         <td class="cellrowborder" valign="top" width="50%">获取最近调用OH_NativeImage_UpdateSurfaceImage的纹理图像的变化矩阵。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeImage_Destroy (OH_NativeImage **image)</td>         <td class="cellrowborder" valign="top" width="50%">销毁通过OH_NativeImage_Create创建的OH_NativeImage实例，销毁后该OH_NativeImage指针会被赋值为空。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-nativeimage" target="_blank">native_image</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下步骤描述了如何使用NativeImage提供的Native API接口，创建OH_NativeImage实例作为消费者端，将数据内容更新到OpenGL外部纹理上。</p>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libEGL.so</li><li>libGLESv3.so</li><li>libnative_image.so</li><li>libnative_window.so</li><li>libnative_buffer.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/egl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/eglext.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;GLES3/gl3.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;GLES2/gl2ext.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_image/native_image.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_window/external_window.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p><strong>初始化EGL环境</strong>。</p>       <p>这里提供一份初始化EGL环境的代码示例。XComponent模块的具体使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines">XComponent开发指导</a>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">using</span> <span class="hljs-variable">GetPlatformDisplayExt</span> = <span class="hljs-variable">PFNEGLGETPLATFORMDISPLAYEXTPROC</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">EGL_EXT_PLATFORM_WAYLAND</span> = <span class="hljs-string">"EGL_EXT_platform_wayland"</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">EGL_KHR_PLATFORM_WAYLAND</span> = <span class="hljs-string">"EGL_KHR_platform_wayland"</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-variable">int32_t</span> <span class="hljs-variable">EGL_CONTEXT_CLIENT_VERSION_NUM</span> = <span class="hljs-number">2</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-variable">char</span> <span class="hljs-variable">CHARACTER_WHITESPACE</span> = <span class="hljs-string">' '</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">CHARACTER_STRING_WHITESPACE</span> = <span class="hljs-string">" "</span>;</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">EGL_GET_PLATFORM_DISPLAY_EXT</span> = <span class="hljs-string">"eglGetPlatformDisplayEXT"</span>;</li><li><span class="hljs-variable">EGLContext</span> <span class="hljs-variable">eglContext_</span> = <span class="hljs-variable">EGL_NO_CONTEXT</span>;</li><li><span class="hljs-variable">EGLDisplay</span> <span class="hljs-variable">eglDisplay_</span> = <span class="hljs-variable">EGL_NO_DISPLAY</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">inline</span> <span class="hljs-variable">EGLConfig</span> <span class="hljs-variable">config_</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">inline</span> <span class="hljs-variable">EGLSurface</span> <span class="hljs-variable">eglSurface_</span>;</li><li><span class="hljs-comment">// 从XComponent中获取到的OHNativeWindow</span></li><li><span class="hljs-variable">OHNativeWindow</span> *<span class="hljs-variable">eglNativeWindow_</span>;</li><li>
</li><li><span class="hljs-comment">// 检查egl扩展</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">bool</span> <span class="hljs-title function_">CheckEglExtension</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">extensions</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">extension</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">extlen</span> = <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">extension</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">end</span> = <span class="hljs-variable">extensions</span> + <span class="hljs-title function_">strlen</span>(<span class="hljs-variable">extensions</span>);</li><li>
</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">extensions</span> &lt; <span class="hljs-title class_">end</span>) {</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">n</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">if</span> (*<span class="hljs-variable">extensions</span> == <span class="hljs-variable">CHARACTER_WHITESPACE</span>) {</li><li>            <span class="hljs-variable">extensions</span>++;</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-variable">n</span> = <span class="hljs-title function_">strcspn</span>(<span class="hljs-variable">extensions</span>, <span class="hljs-variable">CHARACTER_STRING_WHITESPACE</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">n</span> == <span class="hljs-variable">extlen</span> &amp;&amp; <span class="hljs-title function_">strncmp</span>(<span class="hljs-variable">extension</span>, <span class="hljs-variable">extensions</span>, <span class="hljs-variable">n</span>) == <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</li><li>        }</li><li>        <span class="hljs-variable">extensions</span> += <span class="hljs-variable">n</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取当前的显示设备</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">EGLDisplay</span> <span class="hljs-title function_">GetPlatformEglDisplay</span>(<span class="hljs-variable">EGLenum</span> <span class="hljs-variable">platform</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">native_display</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">EGLint</span> *<span class="hljs-variable">attrib_list</span>) {</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">GetPlatformDisplayExt</span> <span class="hljs-variable">eglGetPlatformDisplayExt</span> = <span class="hljs-variable">NULL</span>;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">eglGetPlatformDisplayExt</span>) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">extensions</span> = <span class="hljs-title function_">eglQueryString</span>(<span class="hljs-variable">EGL_NO_DISPLAY</span>, <span class="hljs-variable">EGL_EXTENSIONS</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">extensions</span> &amp;&amp; (<span class="hljs-title function_">CheckEglExtension</span>(<span class="hljs-variable">extensions</span>, <span class="hljs-variable">EGL_EXT_PLATFORM_WAYLAND</span>) ||</li><li>                           <span class="hljs-title function_">CheckEglExtension</span>(<span class="hljs-variable">extensions</span>, <span class="hljs-variable">EGL_KHR_PLATFORM_WAYLAND</span>))) {</li><li>            <span class="hljs-variable">eglGetPlatformDisplayExt</span> = (<span class="hljs-variable">GetPlatformDisplayExt</span>)<span class="hljs-title function_">eglGetProcAddress</span>(<span class="hljs-variable">EGL_GET_PLATFORM_DISPLAY_EXT</span>);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglGetPlatformDisplayExt</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">eglGetPlatformDisplayExt</span>(<span class="hljs-variable">platform</span>, <span class="hljs-variable">native_display</span>, <span class="hljs-variable">attrib_list</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">eglGetDisplay</span>((<span class="hljs-variable">EGLNativeDisplayType</span>)<span class="hljs-variable">native_display</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">InitEGLEnv</span>() {</li><li>    <span class="hljs-comment">// 获取当前的显示设备</span></li><li>    <span class="hljs-variable">eglDisplay_</span> = <span class="hljs-title function_">GetPlatformEglDisplay</span>(<span class="hljs-variable">EGL_PLATFORM_OHOS_KHR</span>, <span class="hljs-variable">EGL_DEFAULT_DISPLAY</span>, <span class="hljs-variable">NULL</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglDisplay_</span> == <span class="hljs-variable">EGL_NO_DISPLAY</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to create EGLDisplay gl errno : "</span> &lt;&lt; <span class="hljs-title class_">eglGetError</span>() &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">EGLint</span> <span class="hljs-variable">major</span>, <span class="hljs-variable">minor</span>;</li><li>    <span class="hljs-comment">// 初始化EGLDisplay</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">eglInitialize</span>(<span class="hljs-variable">eglDisplay_</span>, &amp;<span class="hljs-title class_">major</span>, &amp;<span class="hljs-title class_">minor</span>) == <span class="hljs-variable">EGL_FALSE</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to initialize EGLDisplay"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 绑定图形绘制的API为OpenGLES</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">eglBindAPI</span>(<span class="hljs-variable">EGL_OPENGL_ES_API</span>) == <span class="hljs-variable">EGL_FALSE</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to bind OpenGL ES API"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">unsigned</span> <span class="hljs-variable">int</span> <span class="hljs-variable">glRet</span>;</li><li>    <span class="hljs-variable">EGLint</span> <span class="hljs-variable">count</span>;</li><li>    <span class="hljs-variable">EGLint</span> <span class="hljs-variable">config_attribs</span>[] = {<span class="hljs-variable">EGL_SURFACE_TYPE</span>,</li><li>                               <span class="hljs-variable">EGL_WINDOW_BIT</span>,</li><li>                               <span class="hljs-variable">EGL_RED_SIZE</span>,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               <span class="hljs-variable">EGL_GREEN_SIZE</span>,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               <span class="hljs-variable">EGL_BLUE_SIZE</span>,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               <span class="hljs-variable">EGL_ALPHA_SIZE</span>,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               <span class="hljs-variable">EGL_RENDERABLE_TYPE</span>,</li><li>                               <span class="hljs-variable">EGL_OPENGL_ES3_BIT</span>,</li><li>                               <span class="hljs-variable">EGL_NONE</span>};</li><li>
</li><li>    <span class="hljs-comment">// 获取一个有效的系统配置信息</span></li><li>    <span class="hljs-variable">glRet</span> = <span class="hljs-title function_">eglChooseConfig</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">config_attribs</span>, &amp;<span class="hljs-title class_">config_</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">count</span>);</li><li>    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable">glRet</span> &amp;&amp; <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">count</span>) &gt;= <span class="hljs-number">1</span>)) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to eglChooseConfig"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">EGLint</span> <span class="hljs-variable">context_attribs</span>[] = {<span class="hljs-variable">EGL_CONTEXT_CLIENT_VERSION</span>, <span class="hljs-variable">EGL_CONTEXT_CLIENT_VERSION_NUM</span>, <span class="hljs-variable">EGL_NONE</span>};</li><li>
</li><li>    <span class="hljs-comment">// 创建上下文</span></li><li>    <span class="hljs-variable">eglContext_</span> = <span class="hljs-title function_">eglCreateContext</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">config_</span>, <span class="hljs-variable">EGL_NO_CONTEXT</span>, <span class="hljs-variable">context_attribs</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglContext_</span> == <span class="hljs-variable">EGL_NO_CONTEXT</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to create egl context, error:"</span> &lt;&lt; <span class="hljs-title class_">eglGetError</span>() &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建eglSurface</span></li><li>    <span class="hljs-variable">eglSurface_</span> = <span class="hljs-title function_">eglCreateWindowSurface</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">config_</span>, <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">EGLNativeWindowType</span>&gt;(<span class="hljs-variable">eglNativeWindow_</span>), <span class="hljs-variable">context_attribs</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglSurface_</span> == <span class="hljs-variable">EGL_NO_SURFACE</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Failed to create egl surface, error:"</span> &lt;&lt; <span class="hljs-title class_">eglGetError</span>() &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 关联上下文</span></li><li>    <span class="hljs-title function_">eglMakeCurrent</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">eglSurface_</span>, <span class="hljs-variable">eglSurface_</span>, <span class="hljs-variable">eglContext_</span>);</li><li>
</li><li>    <span class="hljs-comment">// EGL环境初始化完成</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Create EGL context successfully, version"</span> &lt;&lt; <span class="hljs-title class_">major</span> &lt;&lt; <span class="hljs-string">"."</span> &lt;&lt; <span class="hljs-title class_">minor</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p><strong>创建OH_NativeImage实例</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建 OpenGL 纹理</span></li><li><span class="hljs-variable">GLuint</span> <span class="hljs-variable">textureId</span>;</li><li><span class="hljs-title function_">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">textureId</span>);</li><li><span class="hljs-comment">// 创建 NativeImage 实例，关联 OpenGL 纹理</span></li><li><span class="hljs-variable">OH_NativeImage</span>* <span class="hljs-variable">image</span> = <span class="hljs-title function_">OH_NativeImage_Create</span>(<span class="hljs-variable">textureId</span>, <span class="hljs-variable">GL_TEXTURE_EXTERNAL_OES</span>);</li></ol></pre></div></div></li>      <li>       <p><strong>获取对应的数据生产者端NativeWindow</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取生产者NativeWindow</span></li><li>OHNativeWindow* nativeWindow = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(image);</li></ol></pre></div></div></li>      <li>       <p><strong>设置NativeWindow的宽高</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> code = SET_BUFFER_GEOMETRY;</li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">800</span>;</li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">600</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeWindow_NativeWindowHandleOpt</span>(nativeWindow, code, width, height);</li></ol></pre></div></div></li>      <li>       <p><strong>将生产的内容写入OHNativeWindowBuffer</strong>。</p>       <ol>        <li>         <p>从NativeWindow中获取OHNativeWindowBuffer。</p>         <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OHNativeWindowBuffer *buffer = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int</span> fenceFd;</li><li><span class="hljs-comment">// 通过 OH_NativeWindow_NativeWindowRequestBuffer 获取 OHNativeWindowBuffer 实例</span></li><li><span class="hljs-built_in">OH_NativeWindow_NativeWindowRequestBuffer</span>(nativeWindow, &amp;buffer, &amp;fenceFd);</li><li> </li><li>BufferHandle *handle = <span class="hljs-built_in">OH_NativeWindow_GetBufferHandleFromNative</span>(buffer);</li></ol></pre></div></div></li>        <li>         <p>将生产的内容写入OHNativeWindowBuffer。</p>         <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用系统mmap接口拿到bufferHandle的内存虚拟地址</span></li><li><span class="hljs-variable">void</span> *<span class="hljs-variable">mappedAddr</span> = <span class="hljs-title function_">mmap</span>(<span class="hljs-variable">handle</span>-&gt;<span class="hljs-title class_">virAddr</span>, <span class="hljs-variable">handle</span>-&gt;<span class="hljs-title class_">size</span>, <span class="hljs-variable">PROT_READ</span> | <span class="hljs-variable">PROT_WRITE</span>, <span class="hljs-variable">MAP_SHARED</span>, <span class="hljs-variable">handle</span>-&gt;<span class="hljs-title class_">fd</span>, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">mappedAddr</span> == <span class="hljs-variable">MAP_FAILED</span>) {</li><li>    <span class="hljs-comment">// mmap failed</span></li><li>}</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">value</span> = <span class="hljs-number">0x00</span>;</li><li><span class="hljs-variable">value</span>++;</li><li><span class="hljs-variable">uint32_t</span> *<span class="hljs-variable">pixel</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span> *&gt;(<span class="hljs-variable">mappedAddr</span>);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">x</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">x</span> &lt; <span class="hljs-title class_">width</span>; <span class="hljs-title class_">x</span>++) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">y</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">y</span> &lt; <span class="hljs-title class_">height</span>; <span class="hljs-title class_">y</span>++) {</li><li>        *<span class="hljs-variable">pixel</span>++ = <span class="hljs-variable">value</span>;</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 内存使用完记得去掉内存映射</span></li><li><span class="hljs-variable">int</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_">munmap</span>(<span class="hljs-variable">mappedAddr</span>, <span class="hljs-variable">handle</span>-&gt;<span class="hljs-title class_">size</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">result</span> == -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-comment">// munmap failed</span></li><li>}</li></ol></pre></div></div></li>        <li>         <p>将OHNativeWindowBuffer提交到NativeWindow。</p>         <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置刷新区域，如果Region中的Rect数组为nullptr,或者rectNumber为0，则认为OHNativeWindowBuffer全部内容有更改。</span></li><li>Region region{nullptr, <span class="hljs-number">0</span>};</li><li><span class="hljs-comment">// 通过OH_NativeWindow_NativeWindowFlushBuffer 提交给消费者使用，例如：显示在屏幕上。</span></li><li><span class="hljs-built_in">OH_NativeWindow_NativeWindowFlushBuffer</span>(nativeWindow, buffer, fenceFd, region);</li></ol></pre></div></div></li>       </ol></li>      <li>       <p><strong>更新内容到OpenGL纹理</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 更新内容到OpenGL纹理。</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_UpdateSurfaceImage</span>(<span class="hljs-variable">image</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"OH_NativeImage_UpdateSurfaceImage failed"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>}</li><li><span class="hljs-comment">// 获取最近调用OH_NativeImage_UpdateSurfaceImage的纹理图像的时间戳和变化矩阵。</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">timeStamp</span> = <span class="hljs-title function_">OH_NativeImage_GetTimestamp</span>(<span class="hljs-variable">image</span>);</li><li><span class="hljs-variable">float</span> <span class="hljs-variable">matrix</span>[<span class="hljs-number">16</span>];</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_GetTransformMatrixV2</span>(<span class="hljs-variable">image</span>, <span class="hljs-variable">matrix</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"OH_NativeImage_GetTransformMatrixV2 failed"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 对update绑定到对应textureId的纹理做对应的opengl后处理后，将纹理上屏</span></li><li><span class="hljs-variable">EGLBoolean</span> <span class="hljs-variable">eglRet</span> = <span class="hljs-title function_">eglSwapBuffers</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">eglSurface_</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">eglRet</span> == <span class="hljs-variable">EGL_FALSE</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"eglSwapBuffers failed"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p><strong>解绑OpenGL纹理，绑定到新的外部纹理上</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将OH_NativeImage实例从当前OpenGL ES上下文分离</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_DetachContext</span>(<span class="hljs-variable">image</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"OH_NativeImage_DetachContext failed"</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>}</li><li><span class="hljs-comment">// 将OH_NativeImage实例附加到当前OpenGL ES上下文, 且该OpenGL ES纹理会绑定到 GL_TEXTURE_EXTERNAL_OES, 并通过OH_NativeImage进行更新</span></li><li><span class="hljs-variable">GLuint</span> <span class="hljs-variable">textureId2</span>;</li><li><span class="hljs-title function_">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">textureId2</span>);</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_AttachContext</span>(<span class="hljs-variable">image</span>, <span class="hljs-variable">textureId2</span>);</li></ol></pre></div></div></li>      <li>       <p><strong>OH_NativeImage实例使用完需要销毁掉</strong>。</p>       <div _ngcontent-utl-c106="" class="highlight-div"><div _ngcontent-utl-c106="" class="highlight-div-header"><div _ngcontent-utl-c106="" class="highlight-div-header-left"><div _ngcontent-utl-c106="" class="handle-button expand-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-utl-c106="" class="highlight-div-header-right"><div _ngcontent-utl-c106="" class="handle-button ai-button"></div><div _ngcontent-utl-c106="" class="handle-button line-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-utl-c106="" class="handle-button theme-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-utl-c106="" class="handle-button copy-button"><div _ngcontent-utl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-utl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁OH_NativeImage实例</span></li><li><span class="hljs-built_in">OH_NativeImage_Destroy</span>(&amp;image);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>