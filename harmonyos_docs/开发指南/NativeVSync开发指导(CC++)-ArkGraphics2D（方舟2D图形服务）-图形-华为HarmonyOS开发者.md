<h1 _ngcontent-tvs-c119="" class="doc-title ng-star-inserted" title="NativeVSync开发指导 (C/C++)"> NativeVSync开发指导 (C/C++) </h1>

<div _ngcontent-tvs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>NativeVSync模块用来获取系统VSync信号，提供了OH_NativeVSync实例的创建、销毁以及设置VSync回调函数的能力，VSync信号到来时会调用已设置的VSync回调函数。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeVSync_Create (const char *name, unsigned int length)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个OH_NativeVSync实例，每次调用都会产生一个新的实例。本接口需要与OH_NativeVSync_Destroy接口配合使用，否则会存在内存泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeVSync_Destroy (OH_NativeVSync *nativeVsync)</td>         <td class="cellrowborder" valign="top" width="50%">销毁OH_NativeVSync实例。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeVSync_FrameCallback (long long timestamp, void *data)</td>         <td class="cellrowborder" valign="top" width="50%">回调函数的形式，timestamp表示时间戳，data为回调函数入参。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeVSync_RequestFrame (OH_NativeVSync *nativeVsync, OH_NativeVSync_FrameCallback callback, void *data)</td>         <td class="cellrowborder" valign="top" width="50%">请求下一次VSync信号，当信号到来时，调用回调函数callback。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-nativevsync" target="_blank">native_vsync</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下步骤描述了如何使用NativeVSync提供的Native API接口，创建和销毁OH_NativeVSync实例，以及如何设置VSync回调函数。</p>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libnative_vsync.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_vsync/native_vsync.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p><strong>首先需要准备一个VSync回调函数</strong>。</p>       <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> flag = <span class="hljs-literal">false</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnVSync</span><span class="hljs-params">(<span class="hljs-type">long</span> <span class="hljs-type">long</span> timestamp, <span class="hljs-type">void</span>* data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    flag = <span class="hljs-literal">true</span>;</li><li>    std::cout &lt;&lt; <span class="hljs-string">"OnVSync: "</span> &lt;&lt; timestamp &lt;&lt; std::endl;</li><li>}</li><li>OH_NativeVSync_FrameCallback callback = OnVSync; <span class="hljs-comment">// 回调函数必须是OH_NativeVSync_FrameCallback类型</span></li></ol></pre></div></div></li>      <li>       <p><strong>创建OH_NativeVSync实例</strong>。</p>       <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> name[] = <span class="hljs-string">"hello_vsync"</span>;</li><li>OH_NativeVSync* nativeVSync = <span class="hljs-built_in">OH_NativeVSync_Create</span>(name, <span class="hljs-built_in">strlen</span>(name));</li></ol></pre></div></div></li>      <li>       <p><strong>通过OH_NativeVSync实例设置VSync回调函数</strong>。</p>       <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li><span class="hljs-built_in">OH_NativeVSync_RequestFrame</span>(nativeVSync, callback, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">while</span> (!flag) { <span class="hljs-comment">// 判断flag值，上面的VSync回调函数被执行后才会跳出while循环，表示已经接收到VSync信号</span></li><li>    std::cout &lt;&lt; <span class="hljs-string">"wait for vsync!\n"</span>;</li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);</li><li>}</li><li>std::cout &lt;&lt; <span class="hljs-string">"vsync come, end this thread\n"</span>;</li></ol></pre></div></div></li>      <li>       <p><strong>销毁OH_NativeVSync实例</strong>。</p>       <div _ngcontent-tvs-c106="" class="highlight-div"><div _ngcontent-tvs-c106="" class="highlight-div-header"><div _ngcontent-tvs-c106="" class="highlight-div-header-left"><div _ngcontent-tvs-c106="" class="handle-button expand-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tvs-c106="" class="highlight-div-header-right"><div _ngcontent-tvs-c106="" class="handle-button ai-button"></div><div _ngcontent-tvs-c106="" class="handle-button line-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tvs-c106="" class="handle-button theme-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tvs-c106="" class="handle-button copy-button"><div _ngcontent-tvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tvs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_NativeVSync_Destroy</span>(nativeVSync); <span class="hljs-comment">// 如不需要接收VSync信号，请及时销毁OH_NativeVSync实例</span></li><li>nativeVSync = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 销毁后需要及时将OH_NativeVSync实例指针变量置空，避免销毁后继续使用导致野指针异常</span></li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>