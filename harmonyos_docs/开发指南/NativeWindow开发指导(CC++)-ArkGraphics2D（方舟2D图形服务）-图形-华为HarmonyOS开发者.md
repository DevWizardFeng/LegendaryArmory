<h1 _ngcontent-ppi-c119="" class="doc-title ng-star-inserted" title="NativeWindow开发指导 (C/C++)"> NativeWindow开发指导 (C/C++) </h1>

<div _ngcontent-ppi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>NativeWindow是<strong>本地平台化窗口</strong>，表示图形队列的生产者端。开发者可以通过NativeWindow接口进行申请和提交Buffer，配置Buffer属性信息。</p>     <p>针对NativeWindow，常见的开发场景如下：</p>     <ul>      <li>通过NativeWindow提供的Native API接口申请图形Buffer，并将生产图形内容写入图形Buffer，最终提交Buffer到图形队列。</li>      <li>在适配EGL层的eglswapbuffer接口时，进行申请和提交Buffer。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeWindow_NativeWindowRequestBuffer (OHNativeWindow *window, OHNativeWindowBuffer **buffer, int *fenceFd)</td>         <td class="cellrowborder" valign="top" width="50%">通过OHNativeWindow对象申请一块OHNativeWindowBuffer，用以内容生产。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeWindow_NativeWindowFlushBuffer (OHNativeWindow *window, OHNativeWindowBuffer *buffer, int fenceFd, Region region)</td>         <td class="cellrowborder" valign="top" width="50%">通过OHNativeWindow将生产好内容的OHNativeWindowBuffer放回到Buffer队列中，用以内容消费。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeWindow_NativeWindowHandleOpt (OHNativeWindow *window, int code,...)</td>         <td class="cellrowborder" valign="top" width="50%">设置/获取OHNativeWindow的属性，包括设置/获取宽高、内容格式等。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-nativewindow" target="_blank">native_window</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下步骤描述了如何使用NativeWindow提供的Native API接口，申请图形Buffer，并将生产图形内容写入图形Buffer后，最终提交Buffer到图形队列。</p>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libace_ndk.z.so</li><li>libnative_window.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/poll.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ace/xcomponent/native_interface_xcomponent.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_window/external_window.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p>获取OHNativeWindow实例。</p>       <p>可在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ent-native-xcomponent-oh-nativexcomponent-callback" target="_blank">OH_NativeXComponent_Callback</a>提供的接口中获取OHNativeWindow，下面提供一份代码示例。XComponent模块的具体使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines">XComponent开发指导</a>。</p>       <ol>        <li>         <p>在xxx.ets中添加一个XComponent组件。</p>         <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">XComponent</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'xcomponentId'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>, <span class="hljs-attr">libraryname</span>: <span class="hljs-string">'entry'</span>})</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-number">360</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">360</span>)</li></ol></pre></div></div></li>        <li>         <p>在 native c++ 层获取 NativeXComponent。</p>         <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>napi_value exportInstance = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 用来解析出被wrap了NativeXComponent指针的属性</span></li><li><span class="hljs-built_in">napi_get_named_property</span>(env, exports, OH_NATIVE_XCOMPONENT_OBJ, &amp;exportInstance);</li><li>OH_NativeXComponent *nativeXComponent = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 通过napi_unwrap接口，解析出NativeXComponent的实例指针</span></li><li><span class="hljs-built_in">napi_unwrap</span>(env, exportInstance, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>**&gt;(&amp;nativeXComponent));</li><li><span class="hljs-comment">// 获取XComponentId</span></li><li><span class="hljs-type">char</span> idStr[OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>] = {};</li><li><span class="hljs-type">uint64_t</span> idSize = OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>;</li><li><span class="hljs-built_in">OH_NativeXComponent_GetXComponentId</span>(nativeXComponent, idStr, &amp;idSize);</li></ol></pre></div></div></li>        <li>         <p>定义 OH_NativeXComponent_Callback。</p>         <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义回调函数</span></li><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">OnSurfaceCreatedCB</span>(OH_NativeXComponent* component, <span class="hljs-keyword">void</span>* <span class="hljs-variable language_">window</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可获取 OHNativeWindow 实例</span></li><li>    <span class="hljs-title class_">OHNativeWindow</span>* nativeWindow = static_cast&lt;<span class="hljs-title class_">OHNativeWindow</span>*&gt;(<span class="hljs-variable language_">window</span>);</li><li>    <span class="hljs-comment">// 此回调触发后，window默认引用计数会设置为1，若存在并发使用了window相关的接口和xcomponent析构的情况，</span></li><li>    <span class="hljs-comment">// 则需要通过OH_NativeWindow_NativeObjectReference和OH_NativeWindow_NativeObjectUnreference对window进行</span></li><li>    <span class="hljs-comment">// 手动引用计数加1和减1，防止xcomponent析构后，并发调用window相关接口触发野指针或空指针的崩溃。</span></li><li>}</li><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">OnSurfaceChangedCB</span>(OH_NativeXComponent* component, <span class="hljs-keyword">void</span>* <span class="hljs-variable language_">window</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可获取 OHNativeWindow 实例</span></li><li>    <span class="hljs-title class_">OHNativeWindow</span>* nativeWindow = static_cast&lt;<span class="hljs-title class_">OHNativeWindow</span>*&gt;(<span class="hljs-variable language_">window</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">OnSurfaceDestroyedCB</span>(OH_NativeXComponent* component, <span class="hljs-keyword">void</span>* <span class="hljs-variable language_">window</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可获取 OHNativeWindow 实例</span></li><li>    <span class="hljs-title class_">OHNativeWindow</span>* nativeWindow = static_cast&lt;<span class="hljs-title class_">OHNativeWindow</span>*&gt;(<span class="hljs-variable language_">window</span>);</li><li>    <span class="hljs-comment">// 此回调触发后，会将window进行引用计数减1的操作，当window的应用计数为0后，会触发window的析构，</span></li><li>    <span class="hljs-comment">// window析构后，不可再通过window进行接口调用，否则可能会触发野指针或空指针的崩溃。</span></li><li>}</li><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">DispatchTouchEventCB</span>(OH_NativeXComponent* component, <span class="hljs-keyword">void</span>* <span class="hljs-variable language_">window</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可获取 OHNativeWindow 实例</span></li><li>    <span class="hljs-title class_">OHNativeWindow</span>* nativeWindow = static_cast&lt;<span class="hljs-title class_">OHNativeWindow</span>*&gt;(<span class="hljs-variable language_">window</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>         <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化 OH_NativeXComponent_Callback</span></li><li>OH_NativeXComponent_Callback callback;</li><li>callback.OnSurfaceCreated = OnSurfaceCreatedCB;</li><li>callback.OnSurfaceChanged = OnSurfaceChangedCB;</li><li>callback.OnSurfaceDestroyed = OnSurfaceDestroyedCB;</li><li>callback.DispatchTouchEvent = DispatchTouchEventCB;</li></ol></pre></div></div></li>        <li>         <p>将OH_NativeXComponent_Callback 注册给 NativeXComponent。</p>         <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册回调函数</span></li><li><span class="hljs-built_in">OH_NativeXComponent_RegisterCallback</span>(nativeXComponent, &amp;callback);</li></ol></pre></div></div></li>       </ol></li>      <li>       <p>设置OHNativeWindowBuffer的属性。使用OH_NativeWindow_NativeWindowHandleOpt设置OHNativeWindowBuffer的属性（默认携带NATIVEBUFFER_USAGE_CPU_READ usage参数，如果不使用CPU读写数据，建议去除NATIVEBUFFER_USAGE_CPU_READ usage参数，具体可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-arkgraphics-2d-14" target="_blank">关闭CPU访问窗口缓冲区数据</a>）。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置 OHNativeWindowBuffer 的宽高</span></li><li><span class="hljs-type">int32_t</span> code = SET_BUFFER_GEOMETRY;</li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">0x100</span>;</li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">0x100</span>;</li><li><span class="hljs-comment">// 这里的nativeWindow是从上一步骤中的回调函数中获得的</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeWindow_NativeWindowHandleOpt</span>(nativeWindow, code, width, height);</li></ol></pre></div></div></li>      <li>       <p>从图形队列申请OHNativeWindowBuffer。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OHNativeWindowBuffer* buffer = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int</span> releaseFenceFd = <span class="hljs-number">-1</span>;</li><li><span class="hljs-comment">// 通过 OH_NativeWindow_NativeWindowRequestBuffer 获取 OHNativeWindowBuffer 实例</span></li><li>ret = <span class="hljs-built_in">OH_NativeWindow_NativeWindowRequestBuffer</span>(nativeWindow, &amp;buffer, &amp;releaseFenceFd);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span> || buffer == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 通过 OH_NativeWindow_GetBufferHandleFromNative 获取 buffer 的 handle</span></li><li>BufferHandle* bufferHandle = <span class="hljs-built_in">OH_NativeWindow_GetBufferHandleFromNative</span>(buffer);</li></ol></pre></div></div></li>      <li>       <p>内存映射mmap。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">sys</span>/<span class="hljs-title class_">mman</span>.<span class="hljs-title class_">h</span>&gt;</li><li>
</li><li><span class="hljs-comment">// 使用内存映射函数mmap将bufferHandle对应的共享内存映射到用户空间，可以通过映射出来的虚拟地址向bufferHandle中写入图像数据</span></li><li><span class="hljs-comment">// bufferHandle-&gt;virAddr是bufferHandle在共享内存中的起始地址，bufferHandle-&gt;size是bufferHandle在共享内存中的内存占用大小</span></li><li><span class="hljs-variable">void</span>* <span class="hljs-variable">mappedAddr</span> = <span class="hljs-title function_">mmap</span>(<span class="hljs-variable">bufferHandle</span>-&gt;<span class="hljs-title class_">virAddr</span>, <span class="hljs-variable">bufferHandle</span>-&gt;<span class="hljs-title class_">size</span>, <span class="hljs-variable">PROT_READ</span> | <span class="hljs-variable">PROT_WRITE</span>, <span class="hljs-variable">MAP_SHARED</span>, <span class="hljs-variable">bufferHandle</span>-&gt;<span class="hljs-title class_">fd</span>, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">mappedAddr</span> == <span class="hljs-variable">MAP_FAILED</span>) {</li><li>    <span class="hljs-comment">// mmap failed</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>将生产的内容写入OHNativeWindowBuffer，在这之前需要等待releaseFenceFd可用（注意releaseFenceFd不等于-1才需要调用poll）。如果没有等待releaseFenceFd事件的数据可用（POLLIN），则可能造成花屏、裂屏、HEBC（High Efficiency Bandwidth Compression，高效带宽压缩） fault等问题。releaseFenceFd是消费者进程创建的一个文件句柄，代表消费者消费buffer完毕，buffer可读，生产者可以开始填充buffer内容。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> retCode = <span class="hljs-number">-1</span>;</li><li><span class="hljs-type">uint32_t</span> timeout = <span class="hljs-number">3000</span>;</li><li><span class="hljs-keyword">if</span> (releaseFenceFd != <span class="hljs-number">-1</span>) {</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfds = {<span class="hljs-number">0</span>};</li><li>    pollfds.fd = releaseFenceFd;</li><li>    pollfds.events = POLLIN;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        retCode = <span class="hljs-built_in">poll</span>(&amp;pollfds, <span class="hljs-number">1</span>, timeout);</li><li>    } <span class="hljs-keyword">while</span> (retCode == <span class="hljs-number">-1</span> &amp;&amp; (errno == EINTR || errno == EAGAIN));</li><li>    <span class="hljs-built_in">close</span>(releaseFenceFd); <span class="hljs-comment">// 防止fd泄漏</span></li><li>}</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0x00</span>;</li><li>value++;</li><li><span class="hljs-type">uint32_t</span> *pixel = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint32_t</span> *&gt;(mappedAddr); <span class="hljs-comment">// 使用mmap获取到的地址来访问内存</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> y = <span class="hljs-number">0</span>;  y &lt; height; y++) {</li><li>        *pixel++ = value;</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>提交OHNativeWindowBuffer到图形队列。请注意OH_NativeWindow_NativeWindowFlushBuffer接口的acquireFenceFd不可以和OH_NativeWindow_NativeWindowRequestBuffer接口获取的releaseFenceFd相同，acquireFenceFd可传入默认值-1。acquireFenceFd是生产者需要传入的文件句柄，消费者获取到buffer后可根据生产者传入的acquireFenceFd决定何时去渲染并上屏buffer内容。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置刷新区域，如果Region中的Rect为nullptr,或者rectNumber为0，则认为OHNativeWindowBuffer全部有内容更改。</span></li><li>Region region{<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>};</li><li><span class="hljs-type">int</span> acquireFenceFd = <span class="hljs-number">-1</span>;</li><li><span class="hljs-comment">// 通过OH_NativeWindow_NativeWindowFlushBuffer 提交给消费者使用，例如：显示在屏幕上。</span></li><li><span class="hljs-built_in">OH_NativeWindow_NativeWindowFlushBuffer</span>(nativeWindow, buffer, acquireFenceFd, region);</li></ol></pre></div></div></li>      <li>       <p>取消内存映射munmap。</p>       <div _ngcontent-ppi-c106="" class="highlight-div"><div _ngcontent-ppi-c106="" class="highlight-div-header"><div _ngcontent-ppi-c106="" class="highlight-div-header-left"><div _ngcontent-ppi-c106="" class="handle-button expand-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ppi-c106="" class="highlight-div-header-right"><div _ngcontent-ppi-c106="" class="handle-button ai-button"></div><div _ngcontent-ppi-c106="" class="handle-button line-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ppi-c106="" class="handle-button theme-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ppi-c106="" class="handle-button copy-button"><div _ngcontent-ppi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ppi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 内存使用完记得去掉内存映射</span></li><li><span class="hljs-variable">int</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_">munmap</span>(<span class="hljs-variable">mappedAddr</span>, <span class="hljs-variable">bufferHandle</span>-&gt;<span class="hljs-title class_">size</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">result</span> == -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-comment">// munmap failed</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>