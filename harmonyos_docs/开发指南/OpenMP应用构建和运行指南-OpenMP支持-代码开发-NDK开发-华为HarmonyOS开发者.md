<h1 _ngcontent-pjm-c119="" class="doc-title ng-star-inserted" title="OpenMP应用构建和运行指南"> OpenMP应用构建和运行指南 </h1>

<div _ngcontent-pjm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HarmonyOS NDK中提供了OpenMP的动态库和静态库文件，支持开发者在Native应用中使用OpenMP。本文用于指导开发者在<a href="https://developer.huawei.com/consumer/cn/deveco-studio/" target="_blank">DevEco Studio</a>中调用库文件使用OpenMP的并行化能力，更详细的使用示例和API标准请查看官方文档<a href="https://clang.llvm.org/docs/OpenMPSupport.html" target="_blank">clang-OpenMPSupport</a>。</p>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="section1-创建native-c工程" class="firsth2">1. 创建Native C++工程<i class="anchor-icon anchor-icon-link" anchorid="section1-创建native-c工程" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/create-with-ndk">创建NDK工程</a></p> </div>  <div class="tiledSection"><h3 id="section2-添加依赖">2. 添加依赖<i class="anchor-icon anchor-icon-link" anchorid="section2-添加依赖" tips="复制节点链接"></i></h3><p>OpenMP库的引入可以通过静态链接和动态链接两种方式实现。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p><a href="https://www.openmp.org/spec-html/5.0/openmpsu15.html#x25-240001.5.1" target="_blank">OMPT(OpenMP Tools Interface)</a>工具目前仅支持静态链接时使用。</p>  </div></div></div> <p><strong>静态链接</strong></p> <p>（1）打开entry/src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加静态库libomp.a以及日志依赖libhilog_ndk.z.so。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="makelists prettyprint linenums hljs language-scss" hw-language="makelists" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libomp.a libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> <p>（2）打开entry/build-profile.json5，在buildOption-&gt;externalNativeOptions-&gt;cppFlags下添加编译参数"-static-openmp -fopenmp"。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="JSON prettyprint linenums hljs language-JSON" hw-language="JSON" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"buildOption"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"externalNativeOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/main/cpp/CMakeLists.txt"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"cppFlags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-static-openmp -fopenmp"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p><strong>动态链接</strong></p> <p>（1）打开entry/src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加动态库libomp.so以及日志依赖libhilog_ndk.z.so。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="makelists prettyprint linenums hljs language-scss" hw-language="makelists" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libomp.so libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> <p>（2）打开entry/build-profile.json5，在buildOption-&gt;externalNativeOptions-&gt;cppFlags下添加编译参数"-fopenmp"。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="JSON prettyprint linenums hljs language-JSON" hw-language="JSON" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"buildOption"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"externalNativeOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/main/cpp/CMakeLists.txt"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"cppFlags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-fopenmp"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p>（3）打开Sdk安装目录，在“{Sdk安装目录}{版本号}\HarmonyOS\native\llvm\lib\aarch64-linux-ohos”目录下找到libomp.so动态库文件，并将其拷贝到工程目录entry/libs/arm64-v8a文件夹。</p> </div>  <div class="tiledSection"><h3 id="section3-修改源文件">3. 修改源文件<i class="anchor-icon anchor-icon-link" anchorid="section3-修改源文件" tips="复制节点链接"></i></h3><p>（1）修改entry/src/main/cpp/napi_init.cpp，引入omp.h头文件，并添加OmpTest函数。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"omp.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200 <span class="hljs-comment">// 全局domain宏，标识业务领域</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span>  <span class="hljs-comment">// 全局tag宏，标识模块日志tag</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">OmpTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"=================Hello OpenMP test.===================="</span>);</li><li>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel</span></li><li>    {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Hello OpenMP!"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"ompTest"</span>, <span class="hljs-literal">nullptr</span>, OmpTest, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> <p>（2）修改entry/src/main/cpp/types/libentry/Index.d.ts，导出ompTest函数。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="TS prettyprint linenums hljs language-TS" hw-language="TS" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">ompTest</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>;</li></ol></pre></div></div> <p>（3）Ts侧调用，修改entry/src/main/ets/pages/Index.ets，调用ompTest函数。</p> <div _ngcontent-pjm-c106="" class="highlight-div"><div _ngcontent-pjm-c106="" class="highlight-div-header"><div _ngcontent-pjm-c106="" class="highlight-div-header-left"><div _ngcontent-pjm-c106="" class="handle-button expand-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjm-c106="" class="highlight-div-header-right"><div _ngcontent-pjm-c106="" class="handle-button ai-button"></div><div _ngcontent-pjm-c106="" class="handle-button line-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjm-c106="" class="handle-button theme-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjm-c106="" class="handle-button copy-button"><div _ngcontent-pjm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjm-c106="" class="highlight-scroll-div"><pre class="TS prettyprint linenums hljs language-TS" hw-language="TS" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello OpenMP'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            testNapi.<span class="hljs-title function_">ompTest</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="section4-运行并校验结果">4. 运行并校验结果<i class="anchor-icon anchor-icon-link" anchorid="section4-运行并校验结果" tips="复制节点链接"></i></h3><p>运行前请检查设备连接并配置好<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-signing-V5" target="_blank">Signature</a>信息。直接点击右上角运行按钮，应用启动后设备进入“Hello OpenMP”界面，点击“Hello OpenMP”标签，打开DevEco Studio下方“Log”查看页面，即可看到并行打印的“Hello OpenMP！”消息。</p> <p><span><img originheight="296" originwidth="771" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114336.00134756523563713867425097534937:50001231000000:2800:569BCDFE67297DF11DC96D4A39C8AF9C8FB0FE15ED9B9123ADB0803F78B5479B.png" width="771" height="296"></span></p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>OpenMP程序运行时，Hilog中会输出“dlopen_impl load library header failed for libarcher.so”的报错信息（如下图）。该报错信息中提到的libarcher.so，在OpenMP程序开启Tsan检测时才需要使用。目前HarmonyOS未支持OpenMP程序的Tsan检测能力，因此该错误信息可忽略，不影响程序正常运行。</p>  <p><span><img originheight="97" originwidth="1121" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114337.30228780932515027797885339061058:50001231000000:2800:04F297D3F242389B1304DEE32A23D0F601FB4DD44F01E02CD26E8F9374AD6A7D.png" width="920" height="79.60749330954505"></span></p>  </div></div></div> </div> </div> <div></div></div>