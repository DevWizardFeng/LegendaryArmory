<h1 _ngcontent-fsr-c119="" class="doc-title ng-star-inserted" title="ParseOpToGraphFn"> ParseOpToGraphFn </h1>

<div _ngcontent-fsr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section103066mcpsimp">函数功能<i class="anchor-icon anchor-icon-link" anchorid="section103066mcpsimp" tips="复制节点链接"></i></h2><p>注册实现算子一对多子图映射的函数，即将算子映射为多个算子。</p> </div> <div class="tiledSection"><h2 id="section103069mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section103069mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-fsr-c106="" class="highlight-div"><div _ngcontent-fsr-c106="" class="highlight-div-header"><div _ngcontent-fsr-c106="" class="highlight-div-header-left"><div _ngcontent-fsr-c106="" class="handle-button expand-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsr-c106="" class="highlight-div-header-right"><div _ngcontent-fsr-c106="" class="handle-button ai-button"></div><div _ngcontent-fsr-c106="" class="handle-button line-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsr-c106="" class="handle-button theme-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsr-c106="" class="handle-button copy-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">OpRegistrationData</span><strong><span class="hljs-function"> </span></strong><span class="hljs-function">&amp;<span class="hljs-title">ParseOpToGraphFn</span><span class="hljs-params">(<span class="hljs-type">const</span> ParseOpToGraphFunc &amp;parse_op_to_graph_fn)</span></span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section103074mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section103074mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.1" valign="top" width="32%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.2" valign="top" width="18%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.3" valign="top" width="50%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="32%"><p>parse_op_to_graph_fn</p> </td> <td class="cellrowborder" valign="top" width="18%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>实现算子一对多映射，进行子图构造的函数。</p> <p>请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-parseoptographfn#section103105mcpsimp">回调函数ParseOpToGraphFunc</a>。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section103099mcpsimp">约束说明<i class="anchor-icon anchor-icon-link" anchorid="section103099mcpsimp" tips="复制节点链接"></i></h2><p>实现一对多子图映射时，插件注册时首先需要将原始框架中的算子映射成AI处理器中的PartitionedCall算子，并在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-parseparamsbyoperatorfn">ParseParamsByOperatorFn</a>函数中使用“SetAttr”接口设置original_type。</p> <p>实现样例请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-parseoptographfn#section103144mcpsimp">调用示例</a>。</p> </div> <div class="tiledSection"><h2 id="section103105mcpsimp">回调函数ParseOpToGraphFunc<i class="anchor-icon anchor-icon-link" anchorid="section103105mcpsimp" tips="复制节点链接"></i></h2><p>开发者自定义并实现ParseOpToGraphFunc函数，通过IR模型构建方式完成一对多子图的构造。</p> <p>回调函数原型定义如下。</p> <div _ngcontent-fsr-c106="" class="highlight-div"><div _ngcontent-fsr-c106="" class="highlight-div-header"><div _ngcontent-fsr-c106="" class="highlight-div-header-left"><div _ngcontent-fsr-c106="" class="handle-button expand-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsr-c106="" class="highlight-div-header-right"><div _ngcontent-fsr-c106="" class="handle-button ai-button"></div><div _ngcontent-fsr-c106="" class="handle-button line-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsr-c106="" class="handle-button theme-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsr-c106="" class="handle-button copy-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Status  <span class="hljs-title">ParseOpToGraphFunc</span><span class="hljs-params">(<span class="hljs-type">const</span> ge::Operator &amp;op, ge::Graph &amp;graph)</span></span></li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.5.2.4.1.1" valign="top" width="24.75%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.2.4.1.2" valign="top" width="19.8%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.2.4.1.3" valign="top" width="55.45%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="24.75%"><p>op</p> </td> <td class="cellrowborder" valign="top" width="19.8%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="55.45%"><p>PartitionedCall算子数据结构，Operator类对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24.75%"><p>graph</p> </td> <td class="cellrowborder" valign="top" width="19.8%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="55.45%"><p>构造的子图。</p> </td> </tr>  </tbody></table></div> </div> <p>子图输入输出关系构建方式如下。</p> <ul><li>输入：通过添加Data节点标识，Data节点的index属性表示原节点的第index个输入边。</li><li>输出：通过Graph::SetOutputs()接口设置，该接口的入参为<strong>std::vector&lt;std::pair&lt;Operator, std::vector&lt;size_t&gt;&gt;&gt;</strong>，输出边按照设置的输出顺序相连。</li></ul> </div> <div class="tiledSection"><h2 id="section103144mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section103144mcpsimp" tips="复制节点链接"></i></h2><p>以将Add算子转换成Addn+Abs为例。</p> <p>实现Add算子到PartitionedCall算子的映射函数示例如下所示：</p> <div _ngcontent-fsr-c106="" class="highlight-div"><div _ngcontent-fsr-c106="" class="highlight-div-header"><div _ngcontent-fsr-c106="" class="highlight-div-header-left"><div _ngcontent-fsr-c106="" class="handle-button expand-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsr-c106="" class="highlight-div-header-right"><div _ngcontent-fsr-c106="" class="handle-button ai-button"></div><div _ngcontent-fsr-c106="" class="handle-button line-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsr-c106="" class="handle-button theme-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsr-c106="" class="handle-button copy-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Status <span class="hljs-title">ParseParams</span><span class="hljs-params">(<span class="hljs-type">const</span> ge::Operator &amp;op_src, ge::Operator&amp; op_dest)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <span class="hljs-comment">// ... </span></li><li>    op_dest.<span class="hljs-built_in">SetAttr</span>(<span class="hljs-string">"original_type"</span>, <span class="hljs-string">"ai.onnx::11::Add"</span>); </li><li>}</li></ol></pre></div></div> <p>一对多子图构造函数实现示例如下所示：</p> <div _ngcontent-fsr-c106="" class="highlight-div"><div _ngcontent-fsr-c106="" class="highlight-div-header"><div _ngcontent-fsr-c106="" class="highlight-div-header-left"><div _ngcontent-fsr-c106="" class="handle-button expand-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsr-c106="" class="highlight-div-header-right"><div _ngcontent-fsr-c106="" class="handle-button ai-button"></div><div _ngcontent-fsr-c106="" class="handle-button line-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsr-c106="" class="handle-button theme-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsr-c106="" class="handle-button copy-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> Status <span class="hljs-title">ParseOpToGraph</span><span class="hljs-params">(<span class="hljs-type">const</span> Operator &amp;op, Graph &amp;graph)</span> </span>{ </li><li>  <span class="hljs-keyword">auto</span> data_0 = op::<span class="hljs-built_in">Data</span>().<span class="hljs-built_in">set_attr_index</span>(<span class="hljs-number">0</span>); </li><li>  <span class="hljs-keyword">auto</span> data_1 = op::<span class="hljs-built_in">Data</span>().<span class="hljs-built_in">set_attr_index</span>(<span class="hljs-number">1</span>); </li><li>  <span class="hljs-keyword">auto</span> addn = op::<span class="hljs-built_in">AddN</span>(<span class="hljs-string">"addn_sum"</span>).<span class="hljs-built_in">create_dynamic_input_x</span>(<span class="hljs-number">2</span>) </li><li>      .<span class="hljs-built_in">set_dynamic_input_x</span>(<span class="hljs-number">0</span>, data_0) </li><li>      .<span class="hljs-built_in">set_dynamic_input_x</span>(<span class="hljs-number">1</span>, data_1) </li><li>      .<span class="hljs-built_in">set_attr_N</span>(<span class="hljs-number">2</span>); </li><li>  <span class="hljs-keyword">auto</span> abs = op::<span class="hljs-built_in">Abs</span>(<span class="hljs-string">"abs_sum"</span>).<span class="hljs-built_in">set_input_x</span>(addn); </li><li>  std::vector&lt;Operator&gt; inputs{data_0, data_1}; </li><li>  std::vector&lt;std::pair&lt;Operator, std::vector&lt;<span class="hljs-type">size_t</span>&gt;&gt;&gt; output_indexs; </li><li>  output_indexs.<span class="hljs-built_in">emplace_back</span>(abs, std::vector&lt;std::<span class="hljs-type">size_t</span>&gt;{<span class="hljs-number">0</span>}); </li><li>  graph.<span class="hljs-built_in">SetInputs</span>(inputs).<span class="hljs-built_in">SetOutputs</span>(output_indexs); </li><li>  <span class="hljs-keyword">return</span> domi::SUCCESS; </li><li>}</li></ol></pre></div></div> <p>进行注册：</p> <div _ngcontent-fsr-c106="" class="highlight-div"><div _ngcontent-fsr-c106="" class="highlight-div-header"><div _ngcontent-fsr-c106="" class="highlight-div-header-left"><div _ngcontent-fsr-c106="" class="handle-button expand-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fsr-c106="" class="highlight-div-header-right"><div _ngcontent-fsr-c106="" class="handle-button ai-button"></div><div _ngcontent-fsr-c106="" class="handle-button line-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fsr-c106="" class="handle-button theme-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fsr-c106="" class="handle-button copy-button"><div _ngcontent-fsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fsr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">REGISTER_CUSTOM_OP</span>(<span class="hljs-string">"PartitionedCall"</span>) </li><li>.<span class="hljs-built_in">FrameworkType</span>(xx) </li><li>.<span class="hljs-built_in">OriginOpType</span>(xx) </li><li>.<span class="hljs-built_in">ParseParamsByOperatorFn</span>(ParseParams) </li><li>.<span class="hljs-built_in">ParseOpToGraphFn</span>(ParseOpToGraph) </li><li>.<span class="hljs-built_in">ImplyType</span>(ImplyType::TVM);</li></ol></pre></div></div> <p>图为将Add算子进行一对多子图映射后的示例。</p> <div class="fignone"><span class="figcap"><b>图1 </b>一对多转换示意图</span><br><span><img height="176.89000000000001" originheight="275" originwidth="811" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114321.62597811328868852650551162247628:50001231000000:2800:43614143574B88850305A301FC21C9824B4AD9113939BC8084548746EE0FA2DC.png" title="点击放大" width="525.35"></span></div> </div> </div> <div></div></div>