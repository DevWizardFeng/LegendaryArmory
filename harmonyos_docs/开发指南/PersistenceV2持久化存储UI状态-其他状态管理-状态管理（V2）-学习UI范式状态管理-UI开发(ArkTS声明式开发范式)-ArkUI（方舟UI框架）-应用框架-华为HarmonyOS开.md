<h1 _ngcontent-kds-c119="" class="doc-title ng-star-inserted" title="PersistenceV2: 持久化存储UI状态"> PersistenceV2: 持久化存储UI状态 </h1>

<div _ngcontent-kds-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>为了增强状态管理框架对持久化存储UI的能力，开发者可以使用PersistenceV2存储持久化的数据。</p>    <p>PersistenceV2是应用程序中的可选单例对象。此对象的作用是持久化存储UI相关的数据，以确保这些属性在应用程序重新启动时的值与应用程序关闭时的值相同。</p>    <p>PersistenceV2提供状态变量持久化能力，开发者可以通过connect或者globalConnect绑定同一个key，在状态变量变化和应用冷启动时，实现持久化能力。</p>    <p>在阅读本文档前，建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-componentv2">@ComponentV2</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2和@Trace</a>，配合阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-statemanagement#persistencev2" target="_blank">PersistentV2-API文档</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>PersistenceV2从API version 12开始支持。</p>      <p>globalConnect从API version 18开始支持，行为和connect保持一致，唯一的区别为connect的底层存储路径为module级别的路径，而globalConnect的底层存储路径为应用级别，详细区别见使用场景<a href="/consumer/cn/doc/harmonyos-guides/arkts-new-persistencev2#在不同的module中使用connect和globalconnect">在不同的module中使用connect和globalConnect</a>。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>PersistenceV2是在应用UI启动时会被创建的单例。它的目的是提供应用状态数据的中心存储，这些状态数据在应用级别都是可访问的。数据通过唯一的键值字符串访问。不同于AppStorageV2，PersistenceV2还将最新数据存储在设备磁盘上（持久化）。这意味着，应用退出再次启动后，依然能保存选定的结果。</p>     <p>对于与PersistenceV2关联的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2</a>对象，该对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@Trace</a>属性的变化，会触发<strong>整个关联对象的自动持久化</strong>；非<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@Trace</a>属性的变化则不会，如有必要，可调用PersistenceV2 API手动持久化。请注意：被PersistenceV2持久化的类属性必须要有初值，否则不支持持久化。</p>     <p>PersistenceV2可以和UI组件同步，且可以在应用业务逻辑中被访问。</p>     <p>PersistenceV2支持应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/thread-model-stage">主线程</a>内多个UIAbility实例间的状态共享。</p>    </div>    <div class="tiledSection">     <h2 id="使用说明">使用说明<i class="anchor-icon anchor-icon-link" anchorid="使用说明" tips="复制节点链接"></i></h2>          <ul>      <li>connect：创建或获取存储的数据。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>1、关联<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed</a>对象时，由于该类型的name属性未定义，需要指定key或者自定义name属性。</p>       <p>2、数据存储路径为module级别，即哪个module调用了connect，数据副本存入对应module的持久化文件中。如果多个module使用相同的key，则数据为最先使用connect的module，并且PersistenceV2中的数据也会存入最先使用connect的module里。</p>       <p>3、因为存储路径在应用第一个ability启动时就已确定，为该ability所属的module。如果一个ability调用了connect，并且该ability能被不同的module拉起， 那么ability存在多少种启动方式，就会有多少份数据副本。</p>      </div></div></div>     <ul>      <li>globalConnect：创建或获取存储的数据。</li>      <li>remove：删除指定key的存储数据。删除PersistenceV2中不存在的key会报警告。</li>      <li>keys：返回所有PersistenceV2中的key。包括module级别存储路径和应用级别存储路径中的所有key。</li>      <li>save：手动持久化数据。</li>      <li>notifyOnError：响应序列化或反序列化失败的回调。将数据存入磁盘时，需要对数据进行序列化；当某个key序列化失败时，错误是不可预知的；可调用该接口捕获异常。</li>     </ul>     <p>以上接口详细描述请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-statemanagement" target="_blank">状态管理API指南</a>。</p>    </div>    <div class="tiledSection">     <h2 id="使用限制">使用限制<i class="anchor-icon anchor-icon-link" anchorid="使用限制" tips="复制节点链接"></i></h2>          <p>1、需要配合UI使用（UI线程），不能在其他线程使用，如不支持@Sendable。</p>     <p>2、不支持collections.Set、collections.Map等类型。</p>     <p>3、不支持非built-in类型，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>、NativePointer、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arraylist" target="_blank">ArrayList</a>等Native类型。</p>     <p>4、单个key支持数据大小约8k，过大会导致持久化失败。</p>     <p>5、持久化的数据必须是class对象，不支持容器类型（如Array、Set、Map），不支持built-in的构造对象（如Date、Number），不支持持久化基本类型（如string、number、boolean）。如果需要持久化非class对象，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/preferences-guidelines">Preferences</a>进行数据持久化。</p>     <p>6、不支持循环引用的对象。</p>     <p>7、只有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@Trace</a>的数据改变会触发自动持久化，如V1状态变量、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed</a>对象、普通数据的改变不会触发持久化。</p>     <p>8、不宜大量持久化数据，可能会导致页面卡顿。</p>     <p>9、connect和globalConnect不建议混用，如果混用，key不能一样，否则应用crash。</p>     <p>10、PersistenceV2必须与UI实例关联，持久化操作需在UI实例初始化完成后调用（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-windowstage#loadcontent9" target="_blank">loadContent</a>回调触发后）。</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-comment">// 以下为代码片段，需要开发者自己在EntryAbility.ets中补全</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 在EntryAbility外部定义class</span></li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Storage</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isPersist</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 在onWindowStageCreate的loadContent回调中调用PersistenceV2</span></li><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Storage</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Storage</span>());</li><li>  });</li><li>}</li></ol></pre></div></div>     <p>11、如果开发者对数据持久化能力有较强的诉求，例如持久化时机，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/preferences-guidelines">Preferences</a>进行数据持久化。注意：不允许混用PersistenceV2和Preferences，因为Preferences存储的数据不会有状态变量信息，反序列化的数据不能触发PersistenceV2的自动化存储。</p>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="在两个页面之间存储数据" class="firsth2">在两个页面之间存储数据<i class="anchor-icon anchor-icon-link" anchorid="在两个页面之间存储数据" tips="复制节点链接"></i></h3>          <p>数据页面</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 数据中心</span></li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">p1</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">p2</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">f</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li></ol></pre></div></div>     <p>页面1</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Page1.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Sample</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../Sample'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-comment">// 在PersistenceV2中创建一个key为Sample的键值对（如果存在，则返回PersistenceV2中的数据），并且和prop关联</span></li><li>  <span class="hljs-comment">// 对于需要换connect对象的prop属性，需要加@Local修饰（不建议对属性换connect的对象）</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">prop</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>  <span class="hljs-attr">pageStack</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageStack</span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Go to page2'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageStack</span>.<span class="hljs-title function_">pushPathByName</span>(<span class="hljs-string">'Page2'</span>, <span class="hljs-literal">null</span>);</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Page1 connect the key Sample'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 在PersistenceV2中创建一个key为Sample的键值对（如果存在，则返回PersistenceV2中的数据），并且和prop关联</span></li><li>            <span class="hljs-comment">// 不建议对prop属性换connect的对象</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Page1 remove the key Sample'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 从PersistenceV2中删除后，prop将不会再与key为Sample的值关联</span></li><li>            <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-title class_">Sample</span>);</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Page1 save the key Sample'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 如果处于connect状态，持久化key为Sample的键值对</span></li><li>            <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">save</span>(<span class="hljs-title class_">Sample</span>);</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Page1 add 1 to prop.p1: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.prop.f.p1}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span>.<span class="hljs-property">f</span>.<span class="hljs-property">p1</span>++;</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Page1 add 1 to prop.p2: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.prop.f.p2}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 页面不刷新，但是p2的值改变了</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span>.<span class="hljs-property">f</span>.<span class="hljs-property">p2</span>++;</li><li>          })</li><li>
</li><li>        <span class="hljs-comment">// 获取当前PersistenceV2里面的所有key</span></li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`all keys in PersistenceV2: <span class="hljs-subst">${PersistenceV2.keys()}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      }</li><li>      }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>页面2</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Page2.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Sample</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../Sample'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page2Builder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Page2</span>()</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page2</span> {</li><li>  <span class="hljs-comment">// 在PersistenceV2中创建一个key为Sample的键值对（如果存在，则返回PersistenceV2中的数据），并且和prop关联</span></li><li>  <span class="hljs-comment">// 对于需要换connect对象的prop属性，需要加@Local修饰（不建议对属性换connect的对象）</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">prop</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>  <span class="hljs-attr">pathStack</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Page2 connect the key Sample1'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 在PersistenceV2中创建一个key为Sample1的键值对（如果存在，则返回PersistenceV2中的数据），并且和prop关联</span></li><li>            <span class="hljs-comment">// 不建议对prop属性换connect的对象</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'Sample1'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Page2 add 1 to prop.p1: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.prop.f.p1}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span>.<span class="hljs-property">f</span>.<span class="hljs-property">p1</span>++;</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Page2 add 1 to prop.p2: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.prop.f.p2}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 页面不刷新，但是p2的值改变了；只有重新初始化才会改变</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prop</span>.<span class="hljs-property">f</span>.<span class="hljs-property">p2</span>++;</li><li>          })</li><li>
</li><li>        <span class="hljs-comment">// 获取当前PersistenceV2里面的所有key</span></li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`all keys in PersistenceV2: <span class="hljs-subst">${PersistenceV2.keys()}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pathStack</span> = context.<span class="hljs-property">pathStack</span>;</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用Navigation时，需要添加配置系统路由表文件src/main/resources/base/profile/route_map.json，并替换pageSourceFile为Page2页面的路径，并且在module.json5中添加："routerMap": "$profile:route_map"。</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"routerMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Page2"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"pageSourceFile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/ets/pages/Page2.ets"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"buildFunction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Page2Builder"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"description"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"PersistenceV2 example"</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="使用globalconnect存储数据">使用globalConnect存储数据<i class="anchor-icon anchor-icon-link" anchorid="使用globalconnect存储数据" tips="复制节点链接"></i></h3>          <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span>, <span class="hljs-title class_">ConnectOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { contextConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">childId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">father</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">refresh</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// key不传入尝试用为type的name作为key，加密参数不传入默认加密等级为EL2</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>()})!;</li><li>
</li><li>  <span class="hljs-comment">// 使用key:global1连接，传入加密等级为EL1</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p1</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>:<span class="hljs-string">'global1'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>(), <span class="hljs-attr">areaMode</span>: contextConstant.<span class="hljs-property">AreaMode</span>.<span class="hljs-property">EL1</span>})!;</li><li>
</li><li>  <span class="hljs-comment">// 使用key:global2连接，使用构造函数形式，加密参数不传入默认加密等级为EL2</span></li><li>  <span class="hljs-attr">options</span>: <span class="hljs-title class_">ConnectOptions</span>&lt;<span class="hljs-title class_">Sample</span>&gt; = {<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'global2'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>()};</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p2</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>)!;</li><li>
</li><li>  <span class="hljs-comment">// 使用key:global3连接，直接写加密数值，范围只能在0-4，否则运行会crash,例如加密设置为EL3</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p3</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>:<span class="hljs-string">'global3'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>(), <span class="hljs-attr">areaMode</span>: <span class="hljs-number">3</span>})!;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">/**************************** 显示数据 **************************/</span></li><li>      <span class="hljs-comment">// 被@Trace修饰的数据可以自动持久化进磁盘</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key Sample: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key global1: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key global2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key global3: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p3</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p3</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-comment">/**************************** keys接口 **************************/</span></li><li>      <span class="hljs-comment">// keys 本身不会刷新，需要借助状态变量刷新</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Persist keys: '</span> + <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">toString</span>() + <span class="hljs-string">' refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>
</li><li>      <span class="hljs-comment">/**************************** remove接口 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Remove key Sample: '</span> + <span class="hljs-string">'refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 删除这个key，会导致和p失去联系，之后p无法存储，即使reconnect</span></li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-title class_">Sample</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Remove key global1: '</span> + <span class="hljs-string">'refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 删除这个key，会导致和p失去联系，之后p无法存储，即使reconnect</span></li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'global1'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Remove key global2: '</span> + <span class="hljs-string">'refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 删除这个key，会导致和p失去联系，之后p无法存储，即使reconnect</span></li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'global2'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Remove key global3: '</span> + <span class="hljs-string">'refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 删除这个key，会导致和p失去联系，之后p无法存储，即使reconnect</span></li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'global3'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-comment">/**************************** reConnect **************************/</span></li><li>      <span class="hljs-comment">// 重新连接也无法和之前的状态变量建立联系，因此无法保存数据</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'ReConnect key global2: '</span> + <span class="hljs-string">'refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 删除这个key，会导致和p失去联系，之后p无法存储，即使reconnect</span></li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>
</li><li>      <span class="hljs-comment">/**************************** save接口 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'not save key Sample: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span>.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">' refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 未被@Trace保存的对象无法自动存储</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span> += <span class="hljs-number">1</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'save key Sample: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span>.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">' refresh: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 未被@Trace保存的对象无法自动存储，需要调用save存储</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span> += <span class="hljs-number">1</span>;</li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">save</span>(<span class="hljs-title class_">Sample</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="在不同的module中使用connect和globalconnect">在不同的module中使用connect和globalConnect<i class="anchor-icon anchor-icon-link" anchorid="在不同的module中使用connect和globalconnect" tips="复制节点链接"></i></h3>          <p><strong>connect的存储路径需要注意以下两点：</strong></p>     <p>1、connect使用module级别的存储路径，以最先启动的module的路径作为存储路径，从内存回写磁盘时会回写到第一个连接该module的路径。应用如果之后先从另一个module启动，则会以新module的路径作为存储路径。</p>     <p>2、当不同module使用相同的key时，哪个module先启动，数据就为哪个module中保存的键值对，回写到对应的module中。</p>     <p><strong>globalConnect的存储路径需要注意：</strong></p>     <p>globalConnect虽然是应用级别的路径，但是可以设置不同的加密分区，不同加密分区即代表不同的存储路径。connect不支持设置加密分区，但是module自身切换加密级别时，module存储路径也会切换成对应加密分区路径。</p>     <p>示例代码如下：开发者需要在项目基础上，新建一个module，并按照示例代码跳转到新module中。</p>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 模块1</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { contextConstant, common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">childId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">father</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">refresh</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 使用key:global1连接，传入加密等级为EL1</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p1</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>:<span class="hljs-string">'globalConnect1'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>()})!;</li><li>
</li><li>  <span class="hljs-comment">// 使用key:global2连接，使用构造函数形式，加密参数不传入默认加密等级为EL2</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p2</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'connect2'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">/**************************** 显示数据 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key globalConnect1: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key connect2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>
</li><li>      <span class="hljs-comment">/**************************** 跳转 **************************/</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'跳转newModule'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 不同module之间使用，建议使用globalConnect</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>          <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// deviceId为空代表本设备</span></li><li>          <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.myPersistenceV2'</span>, <span class="hljs-comment">// 在app.json5中查看</span></li><li>          <span class="hljs-attr">moduleName</span>: <span class="hljs-string">'newModule'</span>, <span class="hljs-comment">// 在需要跳转的module的module.json5中查看，非必选参数</span></li><li>          <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'NewModuleAbility'</span>,  <span class="hljs-comment">// 跳转启动的ability，在跳转模块对应的ability.ets文件中查看</span></li><li>          <span class="hljs-attr">uri</span>:<span class="hljs-string">'src/main/ets/pages/Index'</span></li><li>        }</li><li>        <span class="hljs-comment">// context为调用方UIAbility的UIAbilityContext</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(want).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'start ability success'</span>);</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`start ability failed. code is <span class="hljs-subst">${err.name}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">3</span>)</li><li>    .<span class="hljs-title function_">borderColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>    .<span class="hljs-title function_">margin</span>({<span class="hljs-attr">top</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">5</span>})</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 模块2</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { contextConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">childId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">father</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 使用key:global1连接，传入加密等级为EL1</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p1</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>:<span class="hljs-string">'globalConnect1'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>()})!;</li><li>
</li><li>  <span class="hljs-comment">// 使用key:global2连接，使用构造函数形式，加密参数不传入默认加密等级为EL2</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p2</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'connect2'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">/**************************** 显示数据 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key globalConnect1: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key connect2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>当开发者对newModule使用不同启动方式会有以下现象：</p>     <ul>      <li>开发者直接启动newModule，分别修改globalConnect1和connect2绑定的变量，例如将childId都改成5。</li>      <li>应用退出并清空后台，启动模块entry，通过跳转按键启动newModule，会发现globalConnect1值为5，而connect2值为1未修改。</li>      <li>globalConnect为应用级别存储，对于一个key，整个应用在对应加密分区只有一份存储路径；connect为module级别的存储路径，会因为module的启动方式不同而在各自的加密分区对应不同的存储路径。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="使用建议">使用建议<i class="anchor-icon anchor-icon-link" anchorid="使用建议" tips="复制节点链接"></i></h2>          <p>建议开发者使用新接口globalConnect创建和获取数据。globalConnect的存储规格和内存规格一致，对于应用只有一份，并且支持设置加密级别，不需要去切换ability的加密才能设置数据的加密级别。当然如果开发者应用不涉及多模块，保持使用connect也不会有影响。</p>    </div>    <div class="tiledSection">     <h3 id="connect向globalconnect迁移实现" class="firsth2">connect向globalConnect迁移实现<i class="anchor-icon anchor-icon-link" anchorid="connect向globalconnect迁移实现" tips="复制节点链接"></i></h3>          <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用connect存储数据</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">childId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">father</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">refresh</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 使用key:connect2存储</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'connect2'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">5</span>}) {</li><li>      <span class="hljs-comment">/**************************** 显示数据 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key connect2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>
</li><li>      <span class="hljs-comment">/**************************** save接口 **************************/</span></li><li>      <span class="hljs-comment">// 非状态变量需要借助状态变量refresh才能刷新</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'save key Sample: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span>.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">' refresh:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 未被@Trace保存的对象无法自动存储，需要调用save存储</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span> += <span class="hljs-number">1</span>;</li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">save</span>(<span class="hljs-string">'connect2'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-kds-c106="" class="highlight-div"><div _ngcontent-kds-c106="" class="highlight-div-header"><div _ngcontent-kds-c106="" class="highlight-div-header-left"><div _ngcontent-kds-c106="" class="handle-button expand-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kds-c106="" class="highlight-div-header-right"><div _ngcontent-kds-c106="" class="handle-button ai-button"></div><div _ngcontent-kds-c106="" class="handle-button line-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kds-c106="" class="handle-button theme-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kds-c106="" class="handle-button copy-button"><div _ngcontent-kds-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kds-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 迁移到globalConnect</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PersistenceV2</span>, <span class="hljs-title class_">Type</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 接受序列化失败的回调</span></li><li><span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">notifyOnError</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, reason: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`error key: <span class="hljs-subst">${key}</span>, reason: <span class="hljs-subst">${reason}</span>, message: <span class="hljs-subst">${msg}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleChild</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">childId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sample</span> {</li><li>  <span class="hljs-comment">// 对于复杂对象需要@Type修饰，确保序列化成功</span></li><li>  <span class="hljs-meta">@Type</span>(<span class="hljs-title class_">SampleChild</span>)</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">father</span>: <span class="hljs-title class_">SampleChild</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SampleChild</span>();</li><li>}</li><li>
</li><li><span class="hljs-comment">// 用于判断是否完成数据迁移的辅助数据</span></li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageState</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isCompleteMoving</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">move</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> movingState = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">StorageState</span>, <span class="hljs-attr">defaultCreator</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageState</span>()})!;</li><li>  <span class="hljs-keyword">if</span> (!movingState.<span class="hljs-property">isCompleteMoving</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-title class_">Sample</span>, <span class="hljs-string">'connect2'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>())!;</li><li>    <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'connect2'</span>);</li><li>    <span class="hljs-keyword">let</span> p1 = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'connect2'</span>, <span class="hljs-attr">defaultCreator</span>: <span class="hljs-function">() =&gt;</span> p})!;  <span class="hljs-comment">// 使用默认构造函数也可以</span></li><li>    <span class="hljs-comment">// 赋值数据，@Trace修饰的会自动保存</span></li><li>    p1.<span class="hljs-property">father</span> = p.<span class="hljs-property">father</span>;</li><li>    <span class="hljs-comment">// 将迁移标志设置为true</span></li><li>    movingState.<span class="hljs-property">isCompleteMoving</span> = <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">move</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">refresh</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 使用key:connect2存入数据</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Sample</span> = <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">globalConnect</span>({<span class="hljs-attr">type</span>: <span class="hljs-title class_">Sample</span>, <span class="hljs-attr">key</span>:<span class="hljs-string">'connect2'</span>, <span class="hljs-attr">defaultCreator</span>:<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sample</span>()})!;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">5</span>}) {</li><li>      <span class="hljs-comment">/**************************** 显示数据 **************************/</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Key connect2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span>.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">childId</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>
</li><li>      <span class="hljs-comment">/**************************** save接口 **************************/</span></li><li>      <span class="hljs-comment">// 非状态变量需要借助状态变量refresh才能刷新</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'save key connect2: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span>.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">' refresh:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 未被@Trace保存的对象无法自动存储，需要调用save存储</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span>.<span class="hljs-property">father</span>.<span class="hljs-property">groupId</span> += <span class="hljs-number">1</span>;</li><li>          <span class="hljs-title class_">PersistenceV2</span>.<span class="hljs-title function_">save</span>(<span class="hljs-string">'connect2'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>connect向globalConnect迁移，需要将key绑定的value赋值给globalConnect进行存储，之后当自定义组件使用globalConnect连接时，globalConnect绑定的数据即为之前使用connect保存的数据，开发者可以自定义move函数，并将其放在合适位置迁移即可。</p>    </div>   </div>   <div></div></div>