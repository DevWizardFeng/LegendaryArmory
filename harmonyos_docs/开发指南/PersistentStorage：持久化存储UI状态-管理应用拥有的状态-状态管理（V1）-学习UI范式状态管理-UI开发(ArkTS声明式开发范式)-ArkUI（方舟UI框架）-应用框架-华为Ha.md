<h1 _ngcontent-emf-c119="" class="doc-title ng-star-inserted" title="PersistentStorage：持久化存储UI状态"> PersistentStorage：持久化存储UI状态 </h1>

<div _ngcontent-emf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>PersistentStorage是应用程序中的可选单例对象。此对象的作用是持久化存储选定的AppStorage属性，以确保这些属性在应用程序重新启动时的值与应用程序关闭时的值相同。</p>    <p>PersistentStorage提供状态变量持久化的能力，但是需要注意，其持久化和读回UI的能力都需要依赖AppStorage。在阅读本文档前，建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage">AppStorage</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-state-management#persistentstorage" target="_blank">PersistentStorage API文档</a>。</p>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>PersistentStorage将选定的AppStorage属性保留在设备磁盘上。应用程序通过API，以决定哪些属性应借助PersistentStorage持久化。PersistentStorage和AppStorage中的属性建立了双向同步，UI和业务逻辑不直接访问PersistentStorage中的属性，所有属性访问都是对AppStorage的访问，AppStorage中的更改会自动同步到PersistentStorage。</p>     <p>PersistentStorage的存储路径为module级别，即哪个module调用了PersistentStorage，数据副本存入对应module的持久化文件中。如果多个module使用相同的key，则数据归属到最先使用PersistentStorage的module里。</p>     <p>PersistentStorage的存储路径在应用第一个ability启动时就已确定，为该ability所属的module。如果一个ability调用了PersistentStorage，并且该ability能被不同的module拉起，那么ability存在多少种启动方式，就会有多少份数据副本。</p>     <p>PersistentStorage功能上耦合了AppStorage，并且数据在不同module中使用也会有问题，因此推荐开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-persistencev2">PersistenceV2</a>的globalConnect接口替换掉PersistentStorage的persistProp接口。PersistentStorage向PersistenceV2迁移的方案见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-v1-v2-migration-application-and-others#persistentstorage-persistencev2">PersistentStorage-&gt;PersistenceV2</a>。</p>    </div>    <div class="tiledSection">     <h2 id="限制条件">限制条件<i class="anchor-icon anchor-icon-link" anchorid="限制条件" tips="复制节点链接"></i></h2>          <p>PersistentStorage允许的类型和值有：</p>     <ul>      <li>number，string，boolean，enum 等简单类型。</li>      <li>可以被JSON.stringify()和JSON.parse()重构的对象（但是对象中的成员方法不支持持久化）。</li>      <li>API version 12及以上支持Map类型，可以观察到Map整体的赋值，同时可通过调用Map的接口set、clear、delete 更新Map的值，且更新的值被持久化存储。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-persiststorage#持久化map类型变量">持久化Map类型变量</a>。</li>      <li>API version 12及以上支持Set类型，可以观察到Set整体的赋值，同时可通过调用Set的接口add、clear、delete 更新Set的值，且更新的值被持久化存储。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-persiststorage#持久化set类型变量">持久化Set类型变量</a>。</li>      <li>API version 12及以上支持Date类型，可以观察到Date整体的赋值，同时可通过调用Date的接口setFullYear、setMonth、setDate、setHours、setMinutes、setSeconds、setMilliseconds、setTime、setUTCFullYear、setUTCMonth、setUTCDate、setUTCHours、setUTCMinutes、setUTCSeconds、setUTCMilliseconds 更新Date的属性，且更新的值被持久化存储。详见<a href="/consumer/cn/doc/harmonyos-guides/arkts-persiststorage#持久化date类型变量">持久化Date类型变量</a>。</li>      <li>API version 12及以上支持undefined 和 null。</li>      <li>API version 12及以上<a href="/consumer/cn/doc/harmonyos-guides/arkts-persiststorage#持久化联合类型变量">支持联合类型</a>。</li>     </ul>     <p>PersistentStorage不允许的类型和值有：</p>     <ul>      <li>嵌套对象（对象数组，对象的属性是对象等）。因为目前框架无法检测AppStorage中嵌套对象（包括数组）值的变化，所以无法写回到PersistentStorage中。</li>     </ul>     <p>持久化数据是一个相对缓慢的操作，应用程序应避免以下情况：</p>     <ul>      <li>       <p>持久化大型数据集。</p></li>      <li>       <p>持久化经常变化的变量。</p></li>     </ul>     <p>PersistentStorage的持久化变量最好是小于2kb的数据，不要大量的数据持久化，因为PersistentStorage写入磁盘是在UI线程同步执行的，大量数据本地读写会影响UI渲染性能。如果开发者需要存储大量的数据，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore" target="_blank">数据库api</a>。</p>     <p>PersistentStorage和UI实例相关联，持久化操作需要在UI实例初始化成功后（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-windowstage#loadcontent9" target="_blank">loadContent</a>传入的回调被调用时）才可以被调用，早于该时机调用会导致持久化失败。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">47</span>);</li><li>  });</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="从appstorage中访问persistentstorage初始化的属性" class="firsth2">从AppStorage中访问PersistentStorage初始化的属性<i class="anchor-icon anchor-icon-link" anchorid="从appstorage中访问persistentstorage初始化的属性" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>初始化PersistentStorage：</p>       <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">47</span>);</li></ol></pre></div></div></li>      <li>       <p>在AppStorage获取对应属性：</p>       <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'aProp'</span>); <span class="hljs-comment">// returns 47</span></li></ol></pre></div></div>       <p>或在组件内部定义：</p>       <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'aProp'</span>) <span class="hljs-attr">aProp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">48</span>;</li></ol></pre></div></div></li>     </ol>     <p>完整代码如下：</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">47</span>);</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'aProp'</span>) <span class="hljs-attr">aProp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">48</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        <span class="hljs-comment">// 应用退出时会保存当前结果。重新启动后，会显示上一次的保存结果</span></li><li>        <span class="hljs-comment">// 未修改时默认值为47</span></li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.aProp}</span>`</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">aProp</span> += <span class="hljs-number">1</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <ul>      <li>       <p>新应用安装后首次启动运行：</p>       <ol>        <li>调用persistProp初始化PersistentStorage，首先查询在PersistentStorage本地文件中是否存在“aProp”，查询结果为不存在，因为应用是第一次安装。</li>        <li>接着查询属性“aProp”在AppStorage中是否存在，依旧不存在。</li>        <li>在AppStorage中创建名为“aProp”的number类型属性，属性初始值是定义的默认值47。</li>        <li>PersistentStorage将属性“aProp”和值47写入磁盘，AppStorage中“aProp”对应的值和其后续的更改将被持久化。</li>        <li>在Index组件中创建状态变量@StorageLink('aProp') aProp，和AppStorage中“aProp”双向绑定，在创建的过程中会在AppStorage中查找，成功找到“aProp”，所以使用其在AppStorage找到的值47。</li>       </ol>       <p><strong>图1</strong> PersistProp初始化流程</p></li>     </ul>     <p></p>     <p><span><img originheight="807" originwidth="1558" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114959.22699033482240618625954345450516:50001231000000:2800:187A12E359C6679F9A60873557696352BACBF7B3AC48E21B330D95E0117AFB7B.png" width="920" height="476.5340179717587"></span></p>     <ul>      <li>       <p>触发点击事件后：</p>       <ol>        <li>状态变量@StorageLink('aProp') aProp改变，触发Text组件重新刷新。</li>        <li>@StorageLink装饰的变量是和AppStorage中建立双向同步的，所以@StorageLink('aProp') aProp的变化会被同步回AppStorage中。</li>        <li>AppStorage中“aProp”属性的改变会同步到所有绑定该“aProp”的单向或者双向变量，在本示例中没有其他的绑定“aProp”的变量。</li>        <li>因为“aProp”对应的属性已经被持久化，所以在AppStorage中“aProp”的改变会触发PersistentStorage，将新的改变写入本地磁盘。</li>       </ol></li>      <li>       <p>后续启动应用：</p>       <ol>        <li>执行PersistentStorage.persistProp('aProp', 47)，首先在PersistentStorage本地文件查询“aProp”属性，成功查询到。</li>        <li>将在PersistentStorage查询到的值写入AppStorage中。</li>        <li>在Index组件里，@StorageLink绑定的“aProp”为PersistentStorage写入AppStorage中的值，即为上一次退出应用存入的值。</li>       </ol></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="在persistentstorage之前访问appstorage中的属性">在PersistentStorage之前访问AppStorage中的属性<i class="anchor-icon anchor-icon-link" anchorid="在persistentstorage之前访问appstorage中的属性" tips="复制节点链接"></i></h3>          <p>该示例为反例。在调用PersistentStorage.persistProp或者persistProps之前使用接口访问AppStorage中的属性是错误的，因为这样的调用顺序会丢失上一次应用程序运行中的属性值：</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> aProp = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">47</span>);</li><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">48</span>);</li></ol></pre></div></div>     <p>应用在非首次运行时，先执行AppStorage.setOrCreate('aProp', 47)：属性“aProp”在AppStorage中创建，其类型为number，其值设置为指定的默认值47。“aProp”是持久化的属性，所以会被写回PersistentStorage磁盘中，PersistentStorage存储的上次退出应用的值被覆盖。</p>     <p>PersistentStorage.persistProp('aProp', 48)：在PersistentStorage中查找到“aProp”，值为刚刚使用AppStorage接口写入的47。</p>    </div>    <div class="tiledSection">     <h3 id="在persistentstorage之后访问appstorage中的属性">在PersistentStorage之后访问AppStorage中的属性<i class="anchor-icon anchor-icon-link" anchorid="在persistentstorage之后访问appstorage中的属性" tips="复制节点链接"></i></h3>          <p>开发者可以先判断是否需要覆盖上一次保存在PersistentStorage中的值，如果需要覆盖，再调用AppStorage的接口进行修改，如果不需要覆盖，则不调用AppStorage的接口。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'aProp'</span>, <span class="hljs-number">48</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'aProp'</span>) &gt; <span class="hljs-number">50</span>) {</li><li>    <span class="hljs-comment">// 如果PersistentStorage存储的值超过50，设置为47</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'aProp'</span>,<span class="hljs-number">47</span>);</li><li>}</li></ol></pre></div></div>     <p>示例代码在读取PersistentStorage存储的数据后，判断“aProp”的值是否大于50，如果大于50，则使用AppStorage的接口将其设置为47。</p>    </div>    <div class="tiledSection">     <h3 id="持久化联合类型变量">持久化联合类型变量<i class="anchor-icon anchor-icon-link" anchorid="持久化联合类型变量" tips="复制节点链接"></i></h3>          <p>PersistentStorage支持联合类型和undefined和null，在下面的示例中，使用persistProp方法初始化“P”为undefined。通过@StorageLink('P')绑定变量p，类型为number | undefined | null，点击Button改变P的值，视图会随之刷新。且P的值被持久化存储。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'P'</span>, <span class="hljs-literal">undefined</span>);</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">TestCase6</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'P'</span>) <span class="hljs-attr">p</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> + <span class="hljs-string">''</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'changeToNumber'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = <span class="hljs-number">10</span>;</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'changeTo undefined'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = <span class="hljs-literal">undefined</span>;</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'changeTo null'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">p</span> = <span class="hljs-literal">null</span>;</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="持久化date类型变量">持久化Date类型变量<i class="anchor-icon anchor-icon-link" anchorid="持久化date类型变量" tips="复制节点链接"></i></h3>          <p>在下面的示例中，@StorageLink装饰的persistedDate类型为Date，点击Button改变persistedDate的值，视图会随之刷新。且persistedDate的值被持久化存储。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'persistedDate'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PersistedDate</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'persistedDate'</span>) <span class="hljs-attr">persistedDate</span>: <span class="hljs-title class_">Date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();</li><li>
</li><li>  <span class="hljs-title function_">updateDate</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedDate</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">List</span>() {</li><li>      <span class="hljs-title class_">ListItem</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Date is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.persistedDate.toString()}</span>`</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Date year is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.persistedDate.getFullYear()}</span>`</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Date hours is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.persistedDate.getHours()}</span>`</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Date minutes is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.persistedDate.getMinutes()}</span>`</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Date time is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.persistedDate.toLocaleTimeString()}</span>`</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>
</li><li>          <span class="hljs-title class_">Button</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Update Date'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>          })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateDate</span>();</li><li>          })</li><li>
</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="持久化map类型变量">持久化Map类型变量<i class="anchor-icon anchor-icon-link" anchorid="持久化map类型变量" tips="复制节点链接"></i></h3>          <p>在下面的示例中，@StorageLink装饰的persistedMapString类型为Map&lt;number, string&gt;，点击Button改变persistedMapString的值，视图会随之刷新。且persistedMapString的值被持久化存储。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'persistedMapString'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt;([]));</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PersistedMap</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'persistedMapString'</span>) <span class="hljs-attr">persistedMapString</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt;([]);</li><li>
</li><li>  <span class="hljs-title function_">persistMapString</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedMapString</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt;([[<span class="hljs-number">3</span>, <span class="hljs-string">'one'</span>], [<span class="hljs-number">6</span>, <span class="hljs-string">'two'</span>], [<span class="hljs-number">9</span>, <span class="hljs-string">'three'</span>]]);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">List</span>() {</li><li>      <span class="hljs-title class_">ListItem</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Map String is `</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedMapString</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>]</span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">0</span>]}</span> <span class="hljs-subst">${item[<span class="hljs-number">1</span>]}</span>`</span>)</li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Button</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Persist Map String'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>          })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">persistMapString</span>();</li><li>          })</li><li>
</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="持久化set类型变量">持久化Set类型变量<i class="anchor-icon anchor-icon-link" anchorid="持久化set类型变量" tips="复制节点链接"></i></h3>          <p>在下面的示例中，@StorageLink装饰的persistedSet类型为Set&lt;number&gt;，点击Button改变persistedSet的值，视图会随之刷新。且persistedSet的值被持久化存储。</p>     <div _ngcontent-emf-c106="" class="highlight-div"><div _ngcontent-emf-c106="" class="highlight-div-header"><div _ngcontent-emf-c106="" class="highlight-div-header-left"><div _ngcontent-emf-c106="" class="handle-button expand-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emf-c106="" class="highlight-div-header-right"><div _ngcontent-emf-c106="" class="handle-button ai-button"></div><div _ngcontent-emf-c106="" class="handle-button line-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emf-c106="" class="handle-button theme-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emf-c106="" class="handle-button copy-button"><div _ngcontent-emf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PersistentStorage</span>.<span class="hljs-title function_">persistProp</span>(<span class="hljs-string">'persistedSet'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt;([]));</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PersistedSet</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'persistedSet'</span>) <span class="hljs-attr">persistedSet</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt;([]);</li><li>
</li><li>  <span class="hljs-title function_">persistSet</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedSet</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">number</span>&gt;([<span class="hljs-number">33</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>]);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">clearSet</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedSet</span>.<span class="hljs-title function_">clear</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">List</span>() {</li><li>      <span class="hljs-title class_">ListItem</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Persisted Set is `</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">persistedSet</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-function">(<span class="hljs-params">item: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>]</span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item[<span class="hljs-number">1</span>]}</span>`</span>)</li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Button</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Persist Set'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>          })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">persistSet</span>();</li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Button</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Persist Clear'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>          })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearSet</span>();</li><li>          })</li><li>
</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>