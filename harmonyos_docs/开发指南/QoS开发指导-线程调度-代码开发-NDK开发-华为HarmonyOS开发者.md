<h1 _ngcontent-hoe-c119="" class="doc-title ng-star-inserted" title="QoS 开发指导"> QoS 开发指导 </h1>

<div _ngcontent-hoe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>自多道程序及多任务操作系统问世以来，CPU、内存等有限的系统资源成为系统中所有任务的竞争对象。合理安排各个任务对系统的响应速度以及资源消耗都有非常重大的意义。相比操作系统，开发者更加清楚应用中各个任务的重要程度；根据重要程度对应用的任务进行分类，能帮助系统更好地进行任务的调度。通过本指导，开发者可以了解在HarmonyOS系统中，如何利用QoS特性及相关的接口调节任务在系统中的运行时间分配。</p> <p>本文用于指导开发者基于QoS特性实现应用任务优先调度属性自定义。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="qos" class="firsth2">QoS<i class="anchor-icon anchor-icon-link" anchorid="qos" tips="复制节点链接"></i></h3><p>QoS(quality-of-service)，即服务质量，在HarmonyOS中QoS特性主要指任务的优先调度属性。开发者可以利用QoS对要执行的工作进行分类，以指示其与用户交互的关联程度；系统则可以根据任务设置的QoS安排各任务的运行时间和运行次序。例如，当系统中有多个任务需要同时执行时，一些与用户交互关联程度不高的后台下载任务可以推迟到更晚的时间执行，且每次执行时分配更少的时间；而用户感知明显的动效绘制等任务则需要立即执行，并分配更多的执行时间。</p> </div>  <div class="tiledSection"><h3 id="qos等级定义">QoS等级定义<i class="anchor-icon anchor-icon-link" anchorid="qos等级定义" tips="复制节点链接"></i></h3><p>目前，HarmonyOS系统一共划分了如下6个QoS等级，从上到下与用户交互的关联程度依次递增，适用于多种不同的应用场景及负载特征情况。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.1" valign="top" width="33.33333333333333%">QoS等级</th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.2" valign="top" width="33.33333333333333%">使用场景</th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.3" valign="top" width="33.33333333333333%">负载特征</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_BACKGROUND</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">后台且用户不可见任务，例如数据同步、备份。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务完成需要几分钟甚至几小时。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_UTILITY</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">不需要立即看到响应效果的任务，例如下载或导入数据。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务完成需要几秒到几分钟。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_DEFAULT</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">默认。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务完成需要几秒钟。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_USER_INITIATED</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">用户触发并且可见进展的任务，例如打开文档。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务在几秒钟之内完成。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_DEADLINE_REQUEST</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">越快越好的关键任务，如页面加载。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务几乎是瞬间完成的。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">QOS_USER_INTERACTIVE</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">用户交互任务（UI线程、刷新界面、动效）。</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">任务是即时的。</td> </tr>  </tbody></table></div> </div> <p>QoS等级定义为枚举类型QoS_Level，如上表所示；枚举值定义如下。</p> </div>  <div class="tiledSection"><h3 id="qos_level声明">QoS_Level声明<i class="anchor-icon anchor-icon-link" anchorid="qos_level声明" tips="复制节点链接"></i></h3><div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">QoS_Level</span> {</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 适用于数据同步等用户不可见的后台任务。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_BACKGROUND,</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 适用于下载等不需要立即看到响应效果的任务。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_UTILITY,</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 默认的QoS等级。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_DEFAULT,</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 适用于打开文档等用户触发并且可以看到进展的任务。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_USER_INITIATED,</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 适用于页面加载等越快越好的任务。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_DEADLINE_REQUEST,</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * 适用于动效绘制等用户交互任务。</span></li><li><span class="hljs-comment">     */</span></li><li>    QOS_USER_INTERACTIVE,</li><li>} QoS_Level;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="功能效果">功能效果<i class="anchor-icon anchor-icon-link" anchorid="功能效果" tips="复制节点链接"></i></h2><p>QoS等级更高的任务相对等级更低的可能被分配更多的CPU时间。</p> <p>下面将展示合理使用QoS对程序执行的优化效果。</p> </div>  <div class="tiledSection"><h3 id="qos对线程执行的优化" class="firsth2">QoS对线程执行的优化<i class="anchor-icon anchor-icon-link" anchorid="qos对线程执行的优化" tips="复制节点链接"></i></h3><p><strong>优化前</strong></p> <p><span><img originheight="307" originwidth="1329" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114336.23698963215000625748426298095332:50001231000000:2800:2CD42BA0E219AB6A433AB1B609B799A9F0965BBFF06FD94F23E9A5DC9981C370.png" width="920" height="212.5206922498119"></span></p> <p>线程1和线程2是某程序的两个关键线程，线程1在运行时会触发新任务线程2，等线程2执行完后会唤醒线程1继续执行。在未标记这两个线程的QoS等级之前，其优先执行顺序低于线程3和线程4；此时线程1和线程2的执行效果如上图所示：</p> <ol><li><p>线程1等待被线程2唤醒，而线程2优先级低，长时间被抢占，导致线程1长时间睡眠；</p>  </li><li><p>线程1优先级低，它被唤醒后等待运行时间长；</p>  </li><li><p>线程1优先级低，运行过程中长时间被其它线程抢占。</p>  </li></ol> <p><strong>优化后</strong></p> <p><span><img originheight="511" originwidth="1304" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114336.74629380641775811884842962666789:50001231000000:2800:7C909A05EA6288C988ACA5FC73083E4A8D2FE2B3B142806C7921DAF3B0525BFB.png" width="920" height="360.52147239263803"></span></p> <p>合理标记线程1和线程2的QoS等级后，两个线程的执行优化效果如上图所示：</p> <ol><li><p>线程2运行时间占比提高，线程1等待时间减少；</p>  </li><li><p>线程1被线程2唤醒后，等待的时间减少；</p>  </li><li><p>线程1运行实际占比提高，被抢占比例减少。</p>  </li></ol> </div>  <div class="tiledSection"><h3 id="qos对rn框架的优化">QoS对RN框架的优化<i class="anchor-icon anchor-icon-link" anchorid="qos对rn框架的优化" tips="复制节点链接"></i></h3><p>在RN框架中合理标记关键线程的QoS等级后，如下表所示，开源benchmark测试的性能提升了约13%。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.3.1.4.1.1" valign="top" width="33.33333333333333%">验证场景</th> <th align="left" class="cellrowborder" id="mcps1.3.8.3.1.4.1.2" valign="top" width="33.33333333333333%">验证环境</th> <th align="left" class="cellrowborder" id="mcps1.3.8.3.1.4.1.3" valign="top" width="33.33333333333333%">总渲染时间</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>benchmark</p> <p>1500view</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%">无QoS优化</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">270.8 ms</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>benchmark</p> <p>1500view</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%">使用QoS优化</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">236.6 ms</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.1.5.1.1" valign="top" width="25%">接口名</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.5.1.2" valign="top" width="25%">描述</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.5.1.3" valign="top" width="25%">参数</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.5.1.4" valign="top" width="25%">返回值</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%">OH_QoS_SetThreadQoS(QoS_Level level)</td> <td class="cellrowborder" valign="top" width="25%">设置当前任务的QoS等级。</td> <td class="cellrowborder" valign="top" width="25%">QoS_Level level</td> <td class="cellrowborder" valign="top" width="25%">0或-1</td> </tr> <tr><td class="cellrowborder" valign="top" width="25%">OH_QoS_ResetThreadQoS()</td> <td class="cellrowborder" valign="top" width="25%">取消当前任务设置的QoS等级。</td> <td class="cellrowborder" valign="top" width="25%">无</td> <td class="cellrowborder" valign="top" width="25%">0或-1</td> </tr> <tr><td class="cellrowborder" valign="top" width="25%">OH_QoS_GetThreadQoS(QoS_Level *level)</td> <td class="cellrowborder" valign="top" width="25%">获取当前任务的QoS等级。</td> <td class="cellrowborder" valign="top" width="25%">QoS_Level *level</td> <td class="cellrowborder" valign="top" width="25%">0或-1</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="使用限制" class="firsth2">使用限制<i class="anchor-icon anchor-icon-link" anchorid="使用限制" tips="复制节点链接"></i></h3><ul><li>QoS接口只能设置本任务的QoS等级。</li></ul> </div>  <div class="tiledSection"><h2 id="函数介绍">函数介绍<i class="anchor-icon anchor-icon-link" anchorid="函数介绍" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="oh_qos_setthreadqos" class="firsth2">OH_QoS_SetThreadQoS<i class="anchor-icon anchor-icon-link" anchorid="oh_qos_setthreadqos" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">OH_QoS_SetThreadQoS</span><span class="hljs-params">(QoS_Level level)</span></span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <p>QoS_Level level</p> <ul><li>该参数用于描述要为任务设置的QoS等级。</li></ul> <p><strong>返回值</strong></p> <ul><li>若成功则返回0，失败则返回-1。</li></ul> <p><strong>描述</strong></p> <p>为某个任务设置指定的QoS等级。设置当前任务的QoS等级。开发者可以根据当前任务的重要程度，为其标记不同等级的QoS，从而获得不同的调度供给。参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-thread-priority-setting" target="_blank">QoS实践指导</a>。</p> <p><strong>样例</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"qos/qos.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 设置当前任务的QoS等级为QOS_USER_INITIATED</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_QoS_SetThreadQoS</span>(QoS_Level::QOS_USER_INITIATED);</li><li>    </li><li>    <span class="hljs-keyword">if</span> (!ret) { <span class="hljs-comment">// ret等于0说明设置成功</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"set QoS Success."</span>);</li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// ret不等于0说明设置失败</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"set QoS failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_qos_resetthreadqos">OH_QoS_ResetThreadQoS<i class="anchor-icon anchor-icon-link" anchorid="oh_qos_resetthreadqos" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">OH_QoS_ResetThreadQoS</span>()</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>无。</li></ul> <p><strong>返回值</strong></p> <ul><li>若成功则返回0，失败则返回-1。</li></ul> <p><strong>描述</strong></p> <p>取消某个任务设置的QoS等级。取消当前任务的QoS等级。参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-thread-priority-setting" target="_blank">QoS实践指导</a>。</p> <p><strong>样例</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"qos/qos.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 重置当前任务的QoS等级</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_QoS_ResetThreadQoS</span>();</li><li>    </li><li>    <span class="hljs-keyword">if</span> (!ret) { <span class="hljs-comment">// ret等于0说明重置成功</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"reset QoS Success."</span>);</li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// ret不等于0说明重置失败</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"reset QoS failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_qos_getthreadqos">OH_QoS_GetThreadQoS<i class="anchor-icon anchor-icon-link" anchorid="oh_qos_getthreadqos" tips="复制节点链接"></i></h3><p><strong>声明</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">OH_QoS_GetThreadQoS</span><span class="hljs-params">(QoS_Level *level)</span></span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <p>QoS_Level *level</p> <ul><li>该参数用于存储任务已经设置的QoS等级。</li></ul> <p><strong>返回值</strong></p> <ul><li>若成功则返回0，失败则返回-1。</li></ul> <p><strong>描述</strong></p> <p>获取某个任务之前最近一次设置的QoS等级；如果之前未设置任何QoS等级，则返回-1。查看当前任务的QoS等级。参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-thread-priority-setting" target="_blank">QoS实践指导</a>。</p> <p><strong>样例</strong></p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"qos/qos.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取当前任务的QoS等级</span></li><li>    QoS_Level level = QoS_Level::QOS_DEFAULT;</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_QoS_GetThreadQoS</span>(&amp;level);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!ret) { <span class="hljs-comment">// ret等于0说明获取成功</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"get QoS level %d Success."</span>, level);</li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// ret不等于0说明获取失败</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"get QoS level failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p>以下步骤描述了如何使用QoS特性提供的Native API接口，调整或查询任务的QoS等级。</p> </div>  <div class="tiledSection"><h3 id="section1-添加动态链接库" class="firsth2">1. 添加动态链接库<i class="anchor-icon anchor-icon-link" anchorid="section1-添加动态链接库" tips="复制节点链接"></i></h3><p>QoS特性的使用依赖相关的动态链接库：<strong>libqos.so</strong>；需要在目标应用或程序的编译环境中添加。</p> <p><strong>示例</strong></p> <p>使用DevEco Studio创建的模板NDK工程，会默认生成CMakeLists.txt脚本，在其中添加QoS相关动态链接库示例如下：</p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li>cmake_minimum_required(VERSION 3.4.1)</li><li>project(qos)</li><li>
</li><li>set(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>include_directories(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li>add_library(entry SHARED hello.cpp)</li><li>
</li><li># 直接引用libqos.so原因：位于已在链接寻址路径的NDK中，无需额外声明</li><li>target_link_libraries(entry PUBLIC libqos.so)</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="section2-引用头文件">2. 引用头文件<i class="anchor-icon anchor-icon-link" anchorid="section2-引用头文件" tips="复制节点链接"></i></h3><p>在使用QoS特性的源代码中需要引用相关的头文件。</p> <div _ngcontent-hoe-c106="" class="highlight-div"><div _ngcontent-hoe-c106="" class="highlight-div-header"><div _ngcontent-hoe-c106="" class="highlight-div-header-left"><div _ngcontent-hoe-c106="" class="handle-button expand-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hoe-c106="" class="highlight-div-header-right"><div _ngcontent-hoe-c106="" class="handle-button ai-button"></div><div _ngcontent-hoe-c106="" class="handle-button line-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hoe-c106="" class="handle-button theme-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hoe-c106="" class="handle-button copy-button"><div _ngcontent-hoe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hoe-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"qos/qos.h"</span></span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="section3-调用qos接口">3. 调用QoS接口<i class="anchor-icon anchor-icon-link" anchorid="section3-调用qos接口" tips="复制节点链接"></i></h3><p>开发者根据自身需求调用相应的QoS接口调整任务的QoS等级，或者查询任务的QoS等级。</p> </div> </div> <div></div></div>