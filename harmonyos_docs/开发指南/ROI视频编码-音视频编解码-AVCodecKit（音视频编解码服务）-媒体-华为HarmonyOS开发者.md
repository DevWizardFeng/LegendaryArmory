<h1 _ngcontent-xem-c119="" class="doc-title ng-star-inserted" title="ROI视频编码"> ROI视频编码 </h1>

<div _ngcontent-xem-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="基础概念">基础概念<i class="anchor-icon anchor-icon-link" anchorid="基础概念" tips="复制节点链接"></i></h2>          <p>ROI视频编码是在现有的硬件编码基础上开放的高级能力，允许开发者自主指定ROI区域，并通过调整ROI区域码率分配优化编码效果。</p>     <ul>      <li>ROI区域：ROI（Region of Interest）一般是指视频中引人注目的区域，比如直播中的人脸区域等。</li>      <li>ROI编码：允许对画面中的ROI区域分配更高的码率，同时适当降低背景等非ROI区域码率，从而在有限带宽条件下提升整体视觉体验。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="适用场景">适用场景<i class="anchor-icon anchor-icon-link" anchorid="适用场景" tips="复制节点链接"></i></h2>          <p>具备明显ROI区域的视频编码场景，例如：</p>     <ul>      <li><strong>直播场景</strong>：人脸或商品一般是受关注的重点区域，通过ROI编码能够有效提升该区域的主观清晰度。</li>      <li><strong>监控场景</strong>：车牌或人脸一般是受关注的重点区域，通过ROI编码能够保留更清晰的有效信息。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="约束和限制">约束和限制<i class="anchor-icon anchor-icon-link" anchorid="约束和限制" tips="复制节点链接"></i></h2>          <ul>      <li><strong>支持的平台</strong>：Kirin9000及以后。</li>      <li><strong>支持的系统</strong>：HarmonyOS6.0及以后。</li>      <li><strong>支持的编码器</strong>：H264 8bit硬件编码、H265 8bit硬件编码、H265 10bit硬件编码。</li>      <li><strong>支持的码控模式</strong>：VBR、CBR、SQR。</li>      <li><strong>支持的编码模式</strong>：Surface模式、Buffer模式。</li>      <li>同一帧最多支持配置6个ROI区域，并且总ROI面积不能超过图片面积的1/5。</li>      <li>本模块仅提供底层ROI编码能力，不包括ROI区域检测功能。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口介绍">接口介绍<i class="anchor-icon anchor-icon-link" anchorid="接口介绍" tips="复制节点链接"></i></h2>          <p>ROI编码接口支持开发者通过字符串形式下发配置参数，参数需满足"Top1,Left1-Bottom1,Right1=Offset1;Top2,Left2-Bottom2,Right2=Offset2;"的格式。</p>     <ul>      <li>Top、Left、Bottom、Right分别指定对应ROI区域上、左、下、右边界。</li>      <li>Offset指定deltaQp并且"=Offset"可以省略，省略时使用默认参数（deltaQp=-3）。</li>      <li>多个ROI参数之间通过";"连接，所有参数均为整数。</li>      <li>使用前请确保传入参数有效，并尽量避免多个ROI区域之间产生交叠。</li>     </ul>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.1" valign="top" width="33.33333333333333%">配置参数</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.2" valign="top" width="33.33333333333333%">语义</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.3" valign="top" width="33.33333333333333%">格式</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ROI参数</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">String</td>        </tr>             </tbody></table></div>     </div>     <p><strong>注意</strong></p>     <ol>      <li>为了便于使用，ROI参数支持随帧下发并实时生效，开发者无需进行能力查询或配置全局开关。</li>      <li>如果底层硬编不支持ROI编码能力，编码器会忽略ROI参数，进行普通编码。</li>      <li>deltaQp有效范围[-51，51]，编码器会在块级QP的基础上叠加deltaQp，然后Clip到[minQp，maxQp]范围内得到最终QP。</li>      <li>不通过OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS下发参数时，该帧会复用历史ROI信息进行编码。</li>      <li>通过OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS传入空字符串，可以主动关闭ROI编码并清空历史ROI信息，进行普通编码。</li>      <li>通过OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS传入的字符串无法解析出任何有效ROI信息时，ROI编码不生效并清空历史ROI信息，转为普通编码。</li>      <li>如果设置的ROI总面积超过1/5图片大小，ROI编码不生效并清空历史ROI信息，转为普通编码。</li>      <li>如果输入的有效ROI参数超过6个，超过的ROI参数将被忽略。</li>      <li>如果多个ROI区域产生交叠，仅第一个ROI参数会在交叠区域生效。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>基础编码功能请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>开发指南，下面仅针对ROI编码做具体说明。</p>    </div>    <div class="tiledSection">     <h3 id="surface模式" class="firsth2">Surface模式<i class="anchor-icon anchor-icon-link" anchorid="surface模式" tips="复制节点链接"></i></h3>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_registerparametercallback" target="_blank">OH_VideoEncoder_RegisterParameterCallback()</a>接口注册随帧通路回调。</p>     <div _ngcontent-xem-c106="" class="highlight-div"><div _ngcontent-xem-c106="" class="highlight-div-header"><div _ngcontent-xem-c106="" class="highlight-div-header-left"><div _ngcontent-xem-c106="" class="handle-button expand-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xem-c106="" class="highlight-div-header-right"><div _ngcontent-xem-c106="" class="handle-button ai-button"></div><div _ngcontent-xem-c106="" class="handle-button line-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xem-c106="" class="handle-button theme-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xem-c106="" class="handle-button copy-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xem-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 编码输入参数回调OH_VideoEncoder_OnNeedInputParameter实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputParameter</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVFormat *parameter, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">    * 配置两个ROI区域，并指定对应的deltaQp。</span></li><li><span class="hljs-comment">    * ROI1左上角坐标(0, 0)，右下角坐标(64, 128)，调节QP-4。</span></li><li><span class="hljs-comment">    * ROI2左上角坐标(200, 100)，右下角坐标(400, 300)，调节QP+3。</span></li><li><span class="hljs-comment">    **/</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *roiInfo = <span class="hljs-string">"0,0-128,64=-4;100,200-300,400=3"</span>;</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(parameter, OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS, roiInfo);</li><li>    <span class="hljs-built_in">OH_VideoEncoder_PushInputParameter</span>(codec, index);</li><li>}</li><li><span class="hljs-comment">// 2. 注册随帧参数回调。</span></li><li>OH_VideoEncoder_OnNeedInputParameter inParaCb = OnNeedInputParameter;</li><li><span class="hljs-built_in">OH_VideoEncoder_RegisterParameterCallback</span>(videoEnc, inParaCb, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// nullptr：用户特定数据userData为空。</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="buffer模式">Buffer模式<i class="anchor-icon anchor-icon-link" anchorid="buffer模式" tips="复制节点链接"></i></h3>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_setparameter" target="_blank">OH_AVBuffer_SetParameter()</a>接口配置随帧参数。</p>     <div _ngcontent-xem-c106="" class="highlight-div"><div _ngcontent-xem-c106="" class="highlight-div-header"><div _ngcontent-xem-c106="" class="highlight-div-header-left"><div _ngcontent-xem-c106="" class="handle-button expand-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xem-c106="" class="highlight-div-header-right"><div _ngcontent-xem-c106="" class="handle-button ai-button"></div><div _ngcontent-xem-c106="" class="handle-button line-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xem-c106="" class="handle-button theme-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xem-c106="" class="handle-button copy-button"><div _ngcontent-xem-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xem-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">    * 配置两个ROI区域，并指定对应的deltaQp。</span></li><li><span class="hljs-comment">    * ROI1左上角坐标(0, 0)，右下角坐标(64, 128)，调节QP-4。</span></li><li><span class="hljs-comment">    * ROI2左上角坐标(200, 100)，右下角坐标(400, 300)，调节QP+3。</span></li><li><span class="hljs-comment">    **/</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *roiInfo = <span class="hljs-string">"0,0-128,64=-4;100,200-300,400=3"</span>;</li><li>    OH_AVFormat *parameter = <span class="hljs-built_in">OH_AVBuffer_GetParameter</span>(buffer);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(parameter, OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS, roiInfo);</li><li>    <span class="hljs-built_in">OH_AVBuffer_SetParameter</span>(buffer, parameter);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(parameter);</li><li>
</li><li>    inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>