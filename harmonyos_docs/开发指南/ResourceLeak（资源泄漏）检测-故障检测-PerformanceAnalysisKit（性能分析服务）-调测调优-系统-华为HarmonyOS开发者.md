<h1 _ngcontent-qnj-c119="" class="doc-title ng-star-inserted" title="Resource Leak（资源泄漏）检测"> Resource Leak（资源泄漏）检测 </h1>

<div _ngcontent-qnj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section2536135813467">简介<i class="anchor-icon anchor-icon-link" anchorid="section2536135813467" tips="复制节点链接"></i></h2><p>资源泄漏是指句柄、线程或内存等资源，在应用运行过程中没有被正确释放，导致资源被长期占用且无法被其他应用使用，如果某一类资源耗尽，系统可能出现卡死或重启等异常情况。为了应对资源泄漏问题，系统会提供资源泄漏检测、判决、维测日志抓取、日志上报的能力，为开发者提供详细的维测日志以辅助故障定位。本文将主要介绍<a href="/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section19499182961220">资源泄漏检测能力</a>以及<a href="/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section166893320117">资源泄漏日志的规格</a>。</p> </div> <div class="tiledSection"><h2 id="section245764412575">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section245764412575" tips="复制节点链接"></i></h2><p>资源泄漏主要分为三类：内存泄漏、句柄泄漏和线程泄漏。对于每种泄漏，系统会通过周期采样的方式对进程的资源使用情况进行检测，如果资源使用超过阈值，会抓取对应维测并上报泄漏事件。开发者可以通过Hiappevent资源泄漏事件进行订阅，订阅方法详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events" target="_blank">资源泄漏事件</a>。</p> </div> <div class="tiledSection"><h2 id="section19499182961220">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section19499182961220" tips="复制节点链接"></i></h2><p>资源泄漏具体检测方式如下：</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" colspan="2" id="mcps1.3.4.1.4.1.1" valign="top"><p>泄漏类型</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.1.4.1.2" valign="top"><p>检测机制</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" colspan="2" valign="top"><p>句柄泄漏（FD_LEAK）</p> </td> <td class="cellrowborder" valign="top"><p>每隔60s遍历一次进程，获取进程fd句柄总数，超过<strong>阈值（5000个）</strong>时抓取详细句柄信息，同步上报泄漏。</p> </td> </tr> <tr><td align="center" class="cellrowborder" colspan="2" valign="top"><p>线程泄漏（THREAD_LEAK）</p> </td> <td class="cellrowborder" valign="top"><p>每隔60s遍历一次进程，获取进程的总线程数，超过<strong>阈值（700个）</strong>时抓取详细线程名信息，同步上报泄漏。</p> </td> </tr> <tr><td align="center" class="cellrowborder" rowspan="3" valign="top" width="19.351935193519353%"><p>内存泄漏（MEMORY_LEAK）</p> </td> <td align="center" class="cellrowborder" valign="top" width="25.83258325832583%"><p>JS泄漏（JS_LEAK）</p> </td> <td class="cellrowborder" valign="top" width="54.81548154815482%"><p>虚拟机内部进行插桩，当<strong>堆内存的使用率超过85%</strong>或者<strong>触发OOM时</strong>会抓取heapdump，同步上报该故障。</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>native内存泄漏（PSS_MEMORY）</p> </td> <td class="cellrowborder" valign="top"><p>以应用进程平均动态峰值内存作为基线，以200s作为基准，当<strong>动态内存峰值超过基线值2倍时，判定泄漏，同时触发管控。</strong></p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>ashmem/ion/gpu等内存泄漏（KERNEL_MEMORY）</p> </td> <td class="cellrowborder" valign="top"><p>基于ashmem/ion/gpu的基线值，超过基线值时会判定泄漏，同步抓取维测信息。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1. 表格中所述阈值/基线均为系统默认，如果生态在开发过程中需要自行设定基线，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hidebug#hidebugsetappresourcelimit12" target="_blank">hidebug.setAppResourceLimit接口</a>进行设置，该接口建议在开发阶段调用，不要在正式发布阶段使用。</p> <p>2. 虚拟机内存使用率计算公式 = heapUsed / totalHeap</p> <p>heapUsed：当前虚拟机使用的堆大小，单位：KB。可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hidebug#hidebuggetappvmmemoryinfo12" target="_blank">hidebug.getAppVMMemoryInfo()</a>接口获取。</p> <p>totalHeap：当前虚拟机的堆总大小，单位：KB。可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hidebug#hidebuggetappvmmemoryinfo12" target="_blank">hidebug.getAppVMMemoryInfo()</a>接口获取。</p> <p>3. 当应用上报JS_ERROR/CPP_CRASH故障，Error message包含“OutOfMemory”时，可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-leak-way#section728319329442" target="_blank">内存泄漏分析方法</a>辅助定位。</p> </div></div></div> <div class="tiledSection"><h2 id="section122741534102211">约束和限制<i class="anchor-icon anchor-icon-link" anchorid="section122741534102211" tips="复制节点链接"></i></h2><p>1. 句柄泄漏调用栈、native内存泄漏调用栈、js泄漏内存快照等维测因为开销较大，所以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#nolog版本" target="_blank">nolog版本</a>默认不开启；</p> <p>2. 如果开发者希望获取到nolog版本的js泄漏内存快照，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events-arkts" target="_blank">资源泄漏事件订阅（ArkTS）</a>增加对nolog版本js内存快照的订阅。</p> </div> <div class="tiledSection"><h2 id="section166893320117">日志获取<i class="anchor-icon anchor-icon-link" anchorid="section166893320117" tips="复制节点链接"></i></h2></div> <p>资源泄漏日志由LeakDetector模块进行管理，可通过以下方式获取：</p> <ul><li>方式一：通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/exploratory-testing" target="_blank">DevEco Testing进行探索测试</a>并获取日志。<p>DevEco Testing工具会收集设备/data/log/reliability/resource_leak/路径下的资源泄漏故障日志，根据进程名、故障和时间分类显示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" colspan="2" id="mcps1.3.9.1.3.1.4.1.1" valign="top"><p>泄漏类型</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.9.1.3.1.4.1.2" valign="top"><p>日志文件名称</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" colspan="2" valign="top"><p>句柄泄漏（FD_LEAK）</p> </td> <td class="cellrowborder" valign="top"><p>[pid]_fd_leak.txt</p> </td> </tr> <tr><td align="center" class="cellrowborder" colspan="2" valign="top"><p>线程泄漏（THREAD_LEAK）</p> </td> <td class="cellrowborder" valign="top"><p>[pid]_thread_leak.txt</p> </td> </tr> <tr><td align="center" class="cellrowborder" rowspan="3" valign="top" width="19.36193619361936%"><p>内存泄漏（MEMORY_LEAK）</p> </td> <td align="center" class="cellrowborder" valign="top" width="26.56265626562656%"><p>js泄漏（JS_LEAK）</p> </td> <td class="cellrowborder" valign="top" width="54.07540754075407%"><p>memleak-js-[process_name]-[pid]-[tid]-[timestamp].rawheap</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>native内存泄漏（PSS_MEMORY）</p> </td> <td class="cellrowborder" valign="top"><p>memleak-native-[process_name]-[pid]-sample.txt</p> <p>memleak-native-[process_name]-[pid]-smaps.txt</p> <p>memleak-native-[process_name]-[pid]-[timestamp].txt</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>ashmem/ion/gpu等内存泄漏（KERNEL_MEMORY）</p> </td> <td class="cellrowborder" valign="top"><p>memleak-kernel-[module]-0-sample.txt</p> <p>memleak-kernel-[module]-0-[timestamp].txt</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>1. native内存泄漏的调用栈（memleak-native-[process_name]-[pid]-[timestamp].txt）无法直接在DevEco Studio打开，需要修改后缀名为.nas，然后使用DevEco Studio-Profiler-打开并分析，详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations-memory" target="_blank">内存分析及优化</a>。</p> <p>2. js泄漏的维测日志 memleak-js-[process_name]-[pid]-[tid]-[timestamp].rawheap 为二进制内存快照文件，需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/rawheap-translator" target="_blank">translator工具</a>转换为.heapsnapshot文件，通过DevEco Studio或浏览器打开展示，详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-snapshot-basic-operations#section6760173514388" target="_blank">Snapshot离线导入</a>。</p> </div></div></div> </li><li>方式二：通过DevEco Studio主动采集日志。<p>DevEco Studio的profiler模块提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations-memory" target="_blank"><strong>Allocation</strong></a>（获取native调用栈profiler）和 <strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-arkts-memory-leak-analysis" target="_blank">Snapshot</a></strong>（获取JS层heapdump）两种采集方式：</p> <p><span><img originheight="297" originwidth="1210" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115053.00314052890750056522067571660624:50001231000000:2800:9832A894A36FF5D4EDF7E8648A44EE71B3EB82E40FA9D77B85928C2D42F5663A.png" width="920" height="225.8181818181818"></span></p> </li></ul> <ul><li>方式三：通过HiAppEvent接口订阅。<p>HiAppEvent对外提供故障订阅接口，可以订阅各类故障打点，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-intro" target="_blank">HiAppEvent介绍</a>，其中资源泄漏的订阅方式详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events" target="_blank">资源泄漏事件介绍</a>。资源泄漏故障日志存于/data/storage/el2/log/resourcelimit/路径，日志名统一为RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log，可根据日志内容区分文件类型。</p> <p></p> </li></ul> <div class="tiledSection"><h2 id="section1120134982114">句柄泄漏日志规格<i class="anchor-icon anchor-icon-link" anchorid="section1120134982114" tips="复制节点链接"></i></h2></div> <p>故障日志文件名：[pid]_fd_leak.txt（<strong>方式一</strong>）或RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log（<strong>方式三</strong>）。</p> <div class="tiledSection"><h3 id="section133751185258" class="firsth2">日志头部信息<i class="anchor-icon anchor-icon-link" anchorid="section133751185258" tips="复制节点链接"></i></h3></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.14.1.3.1.1" valign="top" width="36.38%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.14.1.3.1.2" valign="top" width="63.62%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="36.38%"><p>time</p> </td> <td class="cellrowborder" valign="top" width="63.62%"><p>故障发生时间。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.38%"><p>pid</p> </td> <td class="cellrowborder" valign="top" width="63.62%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.38%"><p>process</p> </td> <td class="cellrowborder" valign="top" width="63.62%"><p>应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.38%"><p>leaked fd nums</p> </td> <td class="cellrowborder" valign="top" width="63.62%"><p>判定泄漏时获取的句柄数量（快照）。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>time: 2024/06/27 11:55:28</li><li>pid: 1380</li><li>process: process1</li><li>leaked fd nums: 5111</li></ol></pre></div></div> <div class="tiledSection"><h3 id="section66481329112519">句柄类型详细信息<i class="anchor-icon anchor-icon-link" anchorid="section66481329112519" tips="复制节点链接"></i></h3></div> <ul><li><strong>Leaked fd Top 10：</strong>按照句柄名聚类，获取泄漏句柄中最多的类型。第一列为泄漏数量，第二列为泄漏类型，如下即ashmem类型的句柄存在1337个。<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>FdCount    FileDescriptor</li><li>*****************************</li><li>Leaked fd Top 10:</li><li>4796    ashmem</li><li>259    socket</li><li>119    dmabuf</li><li>48    eventfd</li><li>42    sync_file</li><li>17    eventpoll</li><li>3    /sys/kernel/debug/tracing/trace_marker</li><li>3    /dev/null</li><li>2    /dev/hvgr0</li></ol></pre></div></div> </li><li><strong>Dir Type Top 10：</strong>针对文件句柄类型，会单独根据文件路径聚类。如下，根据“<strong>Leaked fd Top 10</strong>”无法看出具体泄漏的类型，但是通过“<strong>Dir Type Top 10</strong>”能确定是“/data/storage/el2/database/rdb”路径下的文件句柄泄漏，且能大概感知是db泄漏。<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Dir Type Top 10:</li><li>6175 /data/storage/el2/database/rdb</li><li>5    /dev/urandom</li><li>3    /sys/kernel/debug/tracing/trace_marker</li><li>3    /dev/null</li><li>1    anon_inode:[signalfd]</li><li>1    /dev/binder</li><li>1    /proc/</li><li>1    /system/app/PhoneClone/PhoneClone.hap</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>若top句柄为unknown，说明维测没有权限获取泄漏进程的句柄。</p> </div></div></div> </li></ul> <div class="tiledSection"><h3 id="section328913422256">特殊类型句柄维测信息<i class="anchor-icon anchor-icon-link" anchorid="section328913422256" tips="复制节点链接"></i></h3></div> <p>如果<strong>Leaked fd Top 10</strong>的TOP句柄信息属于ashmem/socket/pipe/sync_file/dmabuf这五类特殊类型，且该类型的句柄个数超过1000个，日志中会增加整机详细的维测信息，具体如下：</p> <ul><li><strong>ashmem类型句柄</strong><p>ashmem（共享内存），当TOP 1的句柄类型为ashmem时，抓取整机ashmem内存的详细信息如下。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.1.3.1.3.1.1" valign="top" width="36.25%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.1.3.1.3.1.2" valign="top" width="63.74999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="36.25%"><p>Process_name</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>持有该ashmem内存块的应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.25%"><p>Process_ID</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.25%"><p>Fd</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>该进程持有的句柄。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.25%"><p>Applicant_Pid</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>申请该ashmem内存块的进程pid，可根据此字段识别该内存块的申请来源。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.25%"><p>Ashmem_name</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>共享内存的名字，开发者可通过提供的API进行设置，用来判断存储的资源类型，指向不同的领域。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="36.25%"><p>Size</p> </td> <td class="cellrowborder" valign="top" width="63.74999999999999%"><p>单个ashmem块的大小，单位：B。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>开发者可通过提供的API接口设置ashmem内存：</p> <p><span style="color: rgb(0,38,84);">JS层API：</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#setmemorynamesync13" target="_blank">setMemoryNameSync</a></p> <p>NATIVE层API：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_setmemoryname" target="_blank">OH_PixelmapNative_SetMemoryName</a></p> </div></div></div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>*****************************</li><li>LOGGER_MEMCHECK_ASHMEM_INFO</li><li>Process ashmem detail info:</li><li>---------------------------------------------------------------------------------</li><li>Process_name Process_ID Fd Cnode_idx Applicant_Pid Ashmem_name Size</li><li>process1 781 18 328233 781 dev/ashmem/PolicyVolumeMap 384</li><li>...........</li><li>...........</li></ol></pre></div></div> </li><li><strong>socket类型句柄</strong><p>socket（网络通信），当TOP 1的句柄类型为socket时，抓取整机socket内存的详细信息如下。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.2.3.1.3.1.1" valign="top" width="38.04%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.2.3.1.3.1.2" valign="top" width="61.96%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="38.04%"><p>ProcessName</p> </td> <td class="cellrowborder" valign="top" width="61.96%"><p>持有该socket内存块的应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.04%"><p>ProcessID</p> </td> <td class="cellrowborder" valign="top" width="61.96%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.04%"><p>Fd</p> </td> <td class="cellrowborder" valign="top" width="61.96%"><p>该进程持有的句柄。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.04%"><p>inode</p> </td> <td class="cellrowborder" valign="top" width="61.96%"><p>文件系统对象信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.04%"><p>PeerTid</p> </td> <td class="cellrowborder" valign="top" width="61.96%"><p>对端tid（对于有连接的socket为对应值，无连接为0）。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Process socket info:</li><li>----------------------------------------------------</li><li>ProcessName ProcessID Fd inode PeerTid</li><li>process1   6874   3   0    0</li><li>........</li><li>.........</li></ol></pre></div></div> </li><li><strong>pipe类型句柄</strong><p>pipe（进程间通信），当TOP 1的句柄类型为pipe时，以fd维度抓取整机pipe内存的详细信息如下。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.3.3.1.3.1.1" valign="top" width="37.65%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.3.3.1.3.1.2" valign="top" width="62.35000000000001%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="37.65%"><p>ProcessName</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>持有该pipe内存块的应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>ProcessID</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>Fd</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>该进程持有的句柄。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>PipeName</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>管道名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>inode</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>文件系统对象信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>MaxUsage</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>最大使用量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>NumAccounted</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>累计大小量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.65%"><p>RingSize</p> </td> <td class="cellrowborder" valign="top" width="62.35000000000001%"><p>RingBuf大小，单位：KB。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Process pipe info:</li><li>------------------------------------</li><li>ProcessName ProcessID Fd PipeName inode MaxUsage NumAccounted RingSize</li><li>process1 629 7 / 11 16 16 16</li><li>process1 629 8 / 11 16 16 16</li><li>........</li></ol></pre></div></div> <p></p> </li><li><strong>sync_file类型句柄</strong><div class="p">sync_file（显存），当TOP 1的句柄类型为sync_file时，以fd维度抓取整机sync_file的详细信息如下。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.4.2.1.1.3.1.1" valign="top" width="38.1%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.4.2.1.1.3.1.2" valign="top" width="61.9%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="38.1%"><p>ProcessName</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>持有该sync_file内存块的应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>ProcessID</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>Fd</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>该进程持有的句柄。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>FenceName</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>sync_file名字。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>inode</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>文件系统对象信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>FenceNum</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>fence个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>TimelineName</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>fence的Timeline名字。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>DriverName</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>驱动名字。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>Status</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>fence的状态。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="38.1%"><p>Timestamp</p> </td> <td class="cellrowborder" valign="top" width="61.9%"><p>fence的时间戳。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Process fence info:</li><li>----------------------------------------------------</li><li>ProcessName ProcessID Fd FenceName inode FenceNum TimelineName DriverName Status Timestamp</li><li>process1 1309 25 NULL 4186 1 0:online_composer_gfx_primary ukmd_release_fence_2941430 1 91607485502500</li><li>process1 1309 26 NULL 4186 1 0:online_composer_gfx_primary ukmd_release_fence_2941430 1 91607485502500</li><li>........</li></ol></pre></div></div> </div> </li><li><strong>dmabuf类型句柄</strong><div class="p">dmabuf（也称ion内存），当TOP 1的句柄类型为dmabuf时，以fd维度抓取了整机dmabuf的详细信息如下<strong>。</strong> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.5.2.2.1.3.1.1" valign="top" width="37.84%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.5.2.2.1.3.1.2" valign="top" width="62.160000000000004%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="37.84%"><p>Process name</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>持有该ion内存块的应用进程包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>Process ID</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>发生故障进程的pid，可以用于在流水日志中搜索相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>Fd</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>该进程持有的句柄。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>size</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>buffer内存大小，单位：B。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>magic</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>buffer唯一标识（<strong>magic相同表示指向同一块buffer）</strong>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>buf-&gt;pid</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>申请者的pid。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="37.84%"><p>buf-&gt;task_comm</p> </td> <td class="cellrowborder" valign="top" width="62.160000000000004%"><p>申请buffer的进程名。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Process dma_heap info:</li><li>----------------------------------------------------</li><li>    Process name       Process ID               fd             size            magic         buf-&gt;pid   buf-&gt;task_comm</li><li>    process1              971               23          3145728               36              971       process2</li><li>    process1              971               24          1048576               38              971       process2</li><li>   ........</li></ol></pre></div></div> </div> </li></ul> <div class="tiledSection"><h3 id="section81104992718">句柄栈信息<i class="anchor-icon anchor-icon-link" anchorid="section81104992718" tips="复制节点链接"></i></h3><p>当判定句柄泄漏后，会hook该进程的pipe/open等系统调用10分钟，抓取调用栈，并基于相同调用栈聚类。如下每一行都是一个调用栈，调用顺序为从右到左，其中num后面的数字表示调用栈总个数，bt后面为具体调用栈。具体栈信息可通过<a href="https://llvm.org/docs/CommandGuide/llvm-symbolizer.html" target="_blank">addr2line</a>解析到对应的函数。</p> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>*****************************</li><li>LOGGER_MEMCHECK_FD_STACK_INFO</li><li>pid: 12326</li><li>get stack time: 2024/06/17 19:16:48</li><li>==============================FdTrack Stack==============================</li><li>Generated by HiviewDFX @OpenHarmony</li><li>==============================Sorted by num==============================</li><li>num 8272 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib/ld-musl-aarch64.so.1+0x148940] [/system/lib64/platformsdk/libuv.so+0x1ab30] [/system/lib64/platformsdk/libuv.so+0x1cbd0] [/system/lib64/module/file/libfs.z.so+0x17109c] [/system/lib64/module/file/libfs.z.so+0x170af4] [/system/lib64/module/file/libfs.z.so+0x1701c8] [/system/lib64/platformsdk/libace_napi.z.so+0x34828] </li><li>num 3968 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib64/platformsdk/libipc_core.z.so+0x4ac64] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x532d4] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x4f8fc] [/system/lib64/platformsdk/libipc_core.z.so+0x38420] [/system/lib64/platformsdk/libipc_core.z.so+0x4e99c] [/system/lib64/platformsdk/libipc_core.z.so+0x4eb34] [/system/lib64/platformsdk/libipc_core.z.so+0x4edc8] </li><li>num 3968 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib64/platformsdk/libipc_core.z.so+0x4ac64] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x532b0] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x4f8fc] [/system/lib64/platformsdk/libipc_core.z.so+0x38420] [/system/lib64/platformsdk/libipc_core.z.so+0x4e99c] [/system/lib64/platformsdk/libipc_core.z.so+0x4eb34] [/system/lib64/platformsdk/libipc_core.z.so+0x4edc8] </li></ol></pre></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>1. 这里统计的是10分钟内全量申请句柄的调用栈，并没有将已经close的去掉。</p> <p>2. 栈信息只有在log版本直接存在；nolog版本若未开“开发者模式”，则不抓取栈信息，如果发现不存在栈信息，需要在“开发者选项”中打开“系统资源泄漏日志”，并重启设备，来使能资源泄漏的抓栈功能。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section203047817288">线程泄漏日志规格<i class="anchor-icon anchor-icon-link" anchorid="section203047817288" tips="复制节点链接"></i></h2></div> <p>故障日志文件名：[pid]_thread_leak.txt（<strong>方式一</strong>）或RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log（<strong>方式三</strong>）。</p> <div class="tiledSection"><h3 id="section2818620102817" class="firsth2">日志头部信息<i class="anchor-icon anchor-icon-link" anchorid="section2818620102817" tips="复制节点链接"></i></h3></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.25.1.3.1.1" valign="top" width="41.57%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.25.1.3.1.2" valign="top" width="58.43000000000001%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="41.57%"><p>time</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>检测到线程泄漏的时间。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.57%"><p>pid</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>发生故障进程的pid，用于在流水日志中查询相关进程信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.57%"><p>vss</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>单个进程全部可访问的地址空间，其大小可能包括还尚未在内存中驻留的部分，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.57%"><p>rss</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>单个进程实际占用的内存大小，包括该进程所使用共享库全部内存大小，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.57%"><p>process</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>发生故障的应用包名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.57%"><p>summary</p> </td> <td class="cellrowborder" valign="top" width="58.43000000000001%"><p>判定泄漏时进程线程总数。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>time: 2024/06/27 03:45:19</li><li>pid: 41897</li><li>vss: 12783644</li><li>rss: 2229352</li><li>process: process1</li><li>summary: 879</li></ol></pre></div></div> <div class="tiledSection"><h3 id="section388422762812">线程类泄漏详细信息<i class="anchor-icon anchor-icon-link" anchorid="section388422762812" tips="复制节点链接"></i></h3></div> <ul><li><strong>Top 10 Thread Name：</strong>按照线程名聚类，获取泄漏最多的线程，第一列为泄漏数量，第二列为线程名称（若创建线程时未指定线程名，则表现为线程名和进程名相同）。<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Top 10 Thread Name:</li><li>913    process1</li><li>3    gpu-work-client</li><li>2    OS_Actor_402</li><li>1    IPC_11_13795</li><li>1    IPC_12_13796</li><li>1    IPC_13_13797</li></ol></pre></div></div> </li></ul> <ul><li><strong>线程启动信息</strong>：可根据线程启动时间推测。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.29.1.2.1.3.1.1" valign="top" width="41.32%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.29.1.2.1.3.1.2" valign="top" width="58.68%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="41.32%"><p>tid</p> </td> <td class="cellrowborder" valign="top" width="58.68%"><p>检测到泄漏时未释放线程的线程号</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.32%"><p>thread_name</p> </td> <td class="cellrowborder" valign="top" width="58.68%"><p>未释放的线程名</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.32%"><p>start_time(jiffies)</p> </td> <td class="cellrowborder" valign="top" width="58.68%"><p>线程创建时间</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>======================================================</li><li>tid    thread_name    start_time(jiffies)</li><li>221    process1    4688297</li><li>240    IPC_3_4318    3081382</li><li>...</li><li>...</li></ol></pre></div></div> </li></ul> <ul><li><strong>线程快照</strong>：抓取判定泄漏时线程的调用栈，可由此看下线程做的任务，推测线程未退出的原因（如：__pthread_cond_timedwait表示线程正在等待唤醒）。<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>======================================================</li><li>Result: 0 ( no error )</li><li>Timestamp:2024-06-27 03:45:20.000</li><li>Pid:41897</li><li>Uid:1013</li><li>Process name:process1</li><li>Tid:1527, Name:xxx</li><li>#00 pc 00000000001b6464 /system/lib/ld-musl-aarch64.so.1(__timedwait_cp+192)(98dc7600a0fc62125e291b93ca336154)</li><li>#01 pc 00000000001b8468 /system/lib/ld-musl-aarch64.so.1(__pthread_cond_timedwait+188)(98dc7600a0fc62125e291b93ca336154)</li><li>#02 pc 00000000000c108c /system/lib64/libc++.so(std::__h::condition_variable::wait(std::__h::unique_lock&lt;std::__h::mutex&gt;&amp;)+20)(9cbc937082b3d7412696099dd58f4f78242f9512)</li><li>#03 pc 000000000024654c /system/lib64/platformsdk/xxx.so(mindspore::Worker::WaitUntilActive()+204)(534ce78b66262dc14658c35fa018662f)</li><li>#04 pc 000000000023da14 /system/lib64/platformsdk/xxx.so(mindspore::ActorWorker::RunWithSpin()+256)(534ce78b66262dc14658c35fa018662f)</li><li>#05 pc 000000000023edb0 /system/lib64/platformsdk/xxx.so(void* std::__h::__thread_proxy[abi:v15004]&lt;std::__h::tuple&lt;std::__h::unique_ptr&lt;std::__h::__thread_struct, std::__h::default_delete&lt;std::__h::__thread_struct&gt;&gt;, void (mindspore::ActorWorker::*)(), mindspore::ActorWorker*&gt;&gt;(void*)+60)(534ce78b66262dc14658c35fa018662f)</li><li>#06 pc 00000000001baac0 /system/lib/ld-musl-aarch64.so.1(start+236)(98dc7600a0fc62125e291b93ca336154)</li><li>........</li></ol></pre></div></div> </li></ul> <div class="tiledSection"><h2 id="section1827795252818">JS内存泄漏日志规格<i class="anchor-icon anchor-icon-link" anchorid="section1827795252818" tips="复制节点链接"></i></h2></div> <p><strong>故障日志文件名：</strong>memleak-js-[process_name]-[pid]-[tid]-[timestamp].rawheap（<strong>方式一</strong>）或RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log（<strong>方式三</strong>）。</p> <ul><li>该文件记录了对象堆内存的详细信息。</li><li>日志文件需要将后缀名修改为.rawheap文件，再通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/rawheap-translator" target="_blank">translator工具</a>转换为.heapsnapshot文件，通过DevEco Studio或浏览器打开展示，详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-snapshot-basic-operations#section6760173514388" target="_blank">Snapshot离线导入</a>。</li><li>API14后，开发者可以将日志文件后缀名修改为.rawheap后，将其导入DevEco Studio并展示，详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-snapshot-basic-operations#section6760173514388" target="_blank">Raw Heap离线导入</a>。</li></ul> <div class="tiledSection"><h2 id="section8486193719219">native内存泄漏日志规格<i class="anchor-icon anchor-icon-link" anchorid="section8486193719219" tips="复制节点链接"></i></h2><p><strong>故障日志文件名：</strong>泄漏日志获取中方式一和方式三文件名不同，方式三为RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log，根据内容区分，方式一如下所示：</p> </div> <div class="tiledSection"><h3 id="section63726521239" class="firsth2">内存采样<i class="anchor-icon anchor-icon-link" anchorid="section63726521239" tips="复制节点链接"></i></h3></div> <div class="p">日志文件：memleak-native-[process_name]-[pid]-sample.txt，里面展示了进程号，进程名，基线值，内存采样的情况，可以直观的观察到内存的变化情况。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.36.1.1.3.1.1" valign="top" width="41.48%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.36.1.1.3.1.2" valign="top" width="58.52%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="41.48%"><p>SoftThreshold</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>系统设定的该进程基线（也可由应用自身通过setAppResourceLimit接口设置），应用内存连续五次超过进程基线即上报内存泄漏事件，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>HardThreshold</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>系统设定的进程硬门限，应用内存连续两次超过硬门限即上报内存泄漏事件，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>PSS</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>按比例计算的驻留内存大小，共享库的内存按进程数均摊（<strong>带*的时间精准计算一次进程的PSS使用</strong><strong>量</strong>），单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>Offset</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>将共享库内存均摊后的偏差：RSS + Offset = PSS<strong>（用于矫正后续不带*号的PSS</strong><strong>估算值）</strong>，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>RSS</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程实际驻留在物理内存中的内存总量（包含共享库占用的全部内存），单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>SwapPSS</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程实际交换出去（即写入swap空间）的内存总量，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>TotalPSS</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程PSS使用量的总和，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>AvcMem</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程通过Avcodec_service创建编解码实例创建的内存，由Avcodec_service上报给hiview进行统计，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>MediaMem</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程通过Media_service接口创建的内存，由Media_service上报给hiview进行统计，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>GPU</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程使用GPU内存，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>ION</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程使用ION内存，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>TotalMem</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程使用的TotalPSS+ION+GPU+AvcMem+MediaMem内存的总和，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>Level</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>当前进程的泄漏等级简写。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>RunningTime</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>进程当前生命周期，单位：s。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="41.48%"><p>Realtime</p> </td> <td class="cellrowborder" valign="top" width="58.52%"><p>当前采样的真实时间。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>/*************************************************************</li><li>/*                  ***** READ ME *****                      *</li><li>/*************************************************************</li><li>/*                 RSS: Resident Set Size                    *</li><li>/*                 PSS: Proportional Set Size                *</li><li>/*                 RSS + Offset = PSS                        *</li><li>/*                 TotalPSS = PSS + SwapPSS                  *</li><li>/*   TotalMem = TotalPSS + Av_Mem + Media_Mem + ION + GPU    *</li><li>/*                 ***** Two Modes *****                     *</li><li>/*      Estimate Mode: RSS &amp; SwapPSS is real                 *</li><li>/*      Real Mode(Realtime with *): everything is real       *</li><li>/*      Media_rss:apply mem through media_service            *</li><li>/*      Avc_rss:apply mem through avcodec_service            *</li><li>/*    ~ means negligible memory(safe to ignore in analysis)  *</li><li>/*************************************************************</li><li>/*                   ***** Attention *****                   *</li><li>/*    Formulas about TotalMem and sub-items may change,      *</li><li>/*    please reference current annotation formula            *</li><li>/*************************************************************</li><li>
</li><li>pid:    XXXX</li><li>processName:    XXXXXX</li><li>SoftThreshold:    3500(KB)</li><li>HardThreshold:    1024000(KB)</li><li>
</li><li>Index   RSS(KB)     Offset(KB)  PSS(KB)     SwapPSS(KB)     TotalPSS(KB)     MediaMem(KB)   AvcMem(KB)    GPU(KB)       ION(KB)       TotalMem(KB)     Level   RunningTime(s)     Realtime</li><li>1       14668       0           14668       5500            20168            ~              ~             ~             ~             20168            W       112             2025/04/23 12:28:02</li><li>2       12732       0           12732       5476            18208            ~              ~             ~             ~             18208            W       352             2025/04/23 12:32:01</li><li>3       13560       0           13560       5456            19016            ~              ~             ~             ~             19016            W       592             2025/04/23 12:36:02</li><li>4       13576       0           13576       5440            19016            ~              ~             ~             ~             19016            W       832             2025/04/23 12:40:02</li><li>5       13576       0           13576       5440            19016            ~              ~             ~             ~             19016            W       1072            2025/04/23 12:44:02</li><li>6       13584       -8320       5264        5440            10704            ~              ~             ~             ~             10704            W       1072            *2025/04/23 12:44:02</li><li>7       12984       -8320       4664        5084            9748             ~              ~             ~             ~             9748             W       1312            2025/04/23 12:48:02</li><li>
</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section1233615310263">内存维测<i class="anchor-icon anchor-icon-link" anchorid="section1233615310263" tips="复制节点链接"></i></h3></div> <div class="p">日志文件：memleak-native-[process_name]-[pid]-smaps.txt <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.38.1.1.3.1.1" valign="top" width="46.23%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.38.1.1.3.1.2" valign="top" width="53.769999999999996%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="46.23%"><p>RealPssMemory</p> </td> <td class="cellrowborder" valign="top" width="53.769999999999996%"><p>记录了realtime时刻采集的PSS值，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="46.23%"><p>LOGGER_MEMCHECK_MEMINFO</p> </td> <td class="cellrowborder" valign="top" width="53.769999999999996%"><p>下方记录了整机meminfo内存信息，如MemTotal、MemFree等。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="46.23%"><p>LOGGER_MEMCHECK_SMAPS_INFO</p> </td> <td class="cellrowborder" valign="top" width="53.769999999999996%"><p>下方记录了该进程的smaps汇总信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="46.23%"><p>LOGGER_MEMCHECK_SAMPLE_NMD_INFO</p> </td> <td class="cellrowborder" valign="top" width="53.769999999999996%"><p>下方记录了该进程的两次jemalloc的申请情况（两次记录间隔5min），系统会根据两次NMD信息抓取内存栈。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="46.23%"><p>LOGGER_MEMCHECK_DETIAL_INFO</p> </td> <td class="cellrowborder" valign="top" width="53.769999999999996%"><p>下方记录了该进程的jemalloc快照详细信息。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Generated by HiviewDFX @OpenHarmony</li><li>LOGGER_MEMCHECK_GERNAL_INFO</li><li>    pidNumber: 2017</li><li>    processName: process1</li><li>    PidStartTime: 1602</li><li>    RealPssMemory: 83505</li><li>
</li><li>*****************************</li><li>LOGGER_MEMCHECK_MEMINFO</li><li>MemTotal:                             11332540 kB</li><li>MemFree:                               1686056 kB</li><li>......</li><li>
</li><li>LOGGER_MEMCHECK_SMAPS_INFO</li><li>-------------------------------[memory]-------------------------------</li><li>                                    Shared      Shared      Private     Private                                                     </li><li>Size        Rss         Pss         Clean       Dirty       Clean       Dirty       Swap        SwapPss     Counts                        Name</li><li>2048        0           0           0           0           0           0           0           0           1                             /dev/__parameters__/param_sec_dac         </li><li>.......</li><li>
</li><li>LOGGER_MEMCHECK_SAMPLE_NMD_INFO</li><li>
</li><li>            size       allocated         nmalloc         ndalloc</li><li>
</li><li>               8           17384          511848          509675</li><li>              16          129376          338438          330352</li><li>              32         1138816         1026155          990567</li><li>              48         3161808         1322095         1256224</li><li>              64         1869376          908151          878942</li><li>......</li><li>
</li><li>************ endl ************</li><li>
</li><li>LOGGER_MEMCHECK_SAMPLE_NMD_INFO</li><li>
</li><li>            size       allocated         nmalloc         ndalloc</li><li>
</li><li>               8           17384          511848          509675</li><li>              16          129376          338438          330352</li><li>              32         1138816         1026155          990567</li><li>              48         3161808         1322095         1256224</li><li>              64         1869376          908151          878942</li><li>......</li><li>
</li><li>************ endl ************</li><li>
</li><li>*****************************</li><li>LOGGER_MEMCHECK_PROC_INFO</li><li>ASHMEM_PROCESS_INFO</li><li>---------------------------------------------------------------------------------</li><li>---------------------------------------------------------------------------------</li><li>Process_name    Process_ID    Fd    Cnode_idx    Applicant_Pid    Ashmem_name    Virtual_size    Physical_size    magic</li><li>XXXXX           816             22      328234  816     dev/ashmem/PolicyVolumeMap      541             4096            7</li><li>************ endl ************</li><li>
</li><li>******************************</li><li>LOGGER_MEMCHECK_DETIAL_INFO</li><li>allocated         nmalloc   (#/sec)         ndalloc   (#/sec)       nrequests   (#/sec)           nfill   (#/sec)          nflush   (#/sec)</li><li>small:                      183785560        12591759       619        10371251       510         1289491        63         1313204        64          956094        47</li><li>large:                       31059968            3359         0            2946         0            3359         0            3359         0               0         0</li><li>total:                      214845528        12595118       619        10374197       510         1292850        63         1316563        64          956094        47</li><li>
</li><li>......</li><li>
</li><li>bins:           size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests   (#/sec)  nshards      curregs     curslabs  nonfull_slabs regs pgs   util       nfills (#/sec)     nflushes (#/sec)       nslabs     nreslabs (#/sec)      n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds</li><li>8   0       198920       163820       8       138955       6       119703         5        1        24865           56             19  512   1  0.867         6526       0         4008       0           96        26995       1           10990       0               0       0               0       0            1226       0               0         0               0           0</li><li>16   1      1802688      1143707      56      1031039      50       221165        10        1       112668          563            309  256   1  0.781       105471       5        82548       4         1942        80503       3          191126       9               0       0              14       0            4316       0               0         0               0           0</li><li>32   2      9954560      1867465      91      1556385      76       267993        13        1       311080         2614            503  128   1  0.929       177825       8       136745       6         7713       176923       8          325128      15               2       0              52       0            8139       0               0         0               0           1</li><li>48   3     35382816      3763756     185      3026614     148       300952        14        1       737142         2953            220  256   3  0.975       371881      18       283650      13        12022        60637       2          667997      32               2       0              17       0            2725       0               0         0               0           1</li><li>......</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>“LOGGER_MEMCHECK_SAMPLE_NMD_INFO”与“LOGGER_MEMCHECK_DETIAL_INFO”均为进程jemalloc快照，区别在于：</p> <p>1. LOGGER_MEMCHECK_SAMPLE_NMD_INFO：单次维测连续采样2次，间隔为5分钟，内容包含size、allocated、nmalloc、ndalloc等四列内存申请相关信息；</p> <p>2. LOGGER_MEMCHECK_DETIAL_INFO：单次维测仅采样1次，内容包含进程jemalloc的完整信息。</p> </div></div></div> <div class="tiledSection"><h3 id="section116134616266">内存栈<i class="anchor-icon anchor-icon-link" anchorid="section116134616266" tips="复制节点链接"></i></h3></div> <div class="p"><strong>栈信息日志文件：</strong>memleak-native-[process_name]-[pid]-[timestamp].txt<ul><li>检测到泄漏后抓取<strong>15min内的进程内存trace</strong>，可将日志如下图通过Open File加载到DevEco Studio进行解析。<p><span><img originheight="214" originwidth="321" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115053.88433556691940054905506024082386:50001231000000:2800:42291763EDEB01B868AF0042F4BFC4A11FBD7D5FE1E152E6C5722447F45861EE.png" width="321" height="214"></span></p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>系统自动抓的调用栈（memleak-native-[process_name]-[pid]-[timestamp].txt）<strong>无法直接在DevEco Studio打开，需要修改后缀名为.nas</strong>。</p> </div></div></div> </li><li><strong>All Heap：</strong>选择后展示抓取15分钟内的内存情况，记录了hook malloc等系统调用的堆栈。Native日志是以so+偏移的形式展示调用栈（每一行表示一次内存分配行为调用栈），需要结合符号表进一步分析。<p>点击Call Trees可以查看抓取进程的调用栈，筛选“Created &amp; Existing”，根据没有释放的内存占比排序，展开可查看详细进程调用信息，优先排查内存占用较高的堆栈。</p> <p><span><img height="443.07208743169394" originheight="786" originwidth="1632" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115053.34915577435163255117414812700629:50001231000000:2800:BDC3209C6E084663D2883EA2F4BD608BC4144256297638E12A4B793A529B8F06.png" title="点击放大" width="920"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1. 部分栈单看Existing可能感觉泄漏不大或者和检测到的内存峰值相差很多，但是栈里只是抓取的是15分钟内的堆栈信息和内存申请，很多进程泄漏是以几十甚至几百小时为单位的，长时间的泄漏达到上报时的泄漏大小。</p> </div></div></div> </li><li><strong>All Anonymous VM：</strong>选择后记录了当前hook mmap系统调用的堆栈信息。<p>同样选择“Created &amp; Existing”，表示在hook抓取内存申请未释放的。长度越长代表在剩余内存中占用越多，优先排查。</p> <p><span><img height="644.6207452165155" originheight="831" originwidth="1186" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115053.21511086651627631241235389230514:50001231000000:2800:6576CE180AE33870423DEC21967D1238313A8118C18C45045C3CB09EE5188D78.png" title="点击放大" width="920"></span></p> <p></p> </li></ul> </div> <div class="tiledSection"><h2 id="section20381028112710">ashmem/ion/gpu/gpu_rs内存泄漏日志规格<i class="anchor-icon anchor-icon-link" anchorid="section20381028112710" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section4579165218275" class="firsth2">内存采样<i class="anchor-icon anchor-icon-link" anchorid="section4579165218275" tips="复制节点链接"></i></h3></div> <ul><li>日志文件：memleak-kernel-[module]-0-sample.txt（<strong>方式一</strong>）或 RESOURCE_OVERLIMIT_[TIMESTAMP]_[PID].log（<strong>方式三</strong>）。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.44.1.3.1.3.1.1" valign="top" width="50%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.44.1.3.1.3.1.2" valign="top" width="50%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>memoryName</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>内核内存类型，如果发现进程存在泄漏（超过系统设定基线），会显示为该泄漏进程的进程名；如果memoryName打印类型为：ashmem/gpu/ion，则说明无进程泄漏。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>softThreshold</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>系统设定的软门限（超过8个采样周期，即30+分钟超过软门限后判定泄漏），单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>hardThreshold</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>系统设定的硬门限（单次超过硬门限后判定泄漏），单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>topMemory</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>检测到的内核内存峰值，单位：KB。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>LOGGER_MEMCHECK_MEMINFO</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>整机内存信息概览。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>LOGGER_MEMCHECK_PROC_INFO</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>ashmem/ion/gpu对应泄漏内存节点信息打印（泄漏类型不同，落盘内容不同）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>LOGGER_PROCESS_DMABUF_INFO</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>ion内存泄漏时获取的特殊节点内容，包含更多的内存块使用信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>LOGGER_MEMCHECK_RENDER_SERVICE_MEM</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>Render_service进程的内存使用情况。</p> </td> </tr>  </tbody></table></div> </div> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>memoryName:gpu</li><li>softThreshold:2300(MB)</li><li>hardThreshold:3450(MB)</li><li>topMemory:4876824(KB)</li><li>time(s) kernelMemory(KB)realtime</li><li>247681  4876824         2024/06/24 08:27:52</li></ol></pre></div></div> </li></ul> <div class="tiledSection"><h3 id="section1338422814285">内存维测<i class="anchor-icon anchor-icon-link" anchorid="section1338422814285" tips="复制节点链接"></i></h3></div> <p>日志文件：memleak-kernel-[module]-0-[timestamp].txt<strong>（方式一）</strong></p> <p>检测到ashmem/gpu/ion内存泄漏时，会抓取整机ashmem/gpu/ion内存信息，ashmem/ion与句柄泄漏ashmem/dmabuf日志规格相同，参考ashmem/dmabuf类型句柄。</p> <p>日志抬头：</p> <div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>Generated by HiviewDFX @OpenHarmony</li><li>LOGGER_MEMCHECK_GERNAL_INFO</li><li>memoryName:ion</li><li>softThreshold:2800(MB)</li><li>hardThreshold:4200(MB)</li><li>appHardThreshold:4096(MB)</li><li>topMemory:0(KB)</li><li>
</li><li>*****************************</li><li>LOGGER_MEMCHECK_MEMINFO</li><li>MemTotal:       11738500 kB</li><li>MemFree:          116204 kB</li><li>MemAvailable:      95232 kB</li><li>Buffers:               0 kB</li></ol></pre></div></div> <p>日志文件内“LOGGER_MEMCHECK_PROC_INFO”会根据内存泄漏类型不同，落盘对应的内存信息，具体如下：</p> <ul><li>ashmem内存泄漏：<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>LOGGER_MEMCHECK_PROC_INFO</li><li>realtime:       2025/05/30 19:52:42</li><li>Process ashmem overview info:</li><li>---------------------------------------------------------------------------------</li><li>Process_name Virtual_size Physical_size</li><li>Total ashmem  of [XXXXXX] virtual size is  541, physical size is 4096</li><li>Total ashmem  of [XXXXXX] virtual size is  299008, physical size is 299008</li><li>Total ashmem  of [XXXXXX] virtual size is  37574896, physical size is 37470208</li><li>......</li><li>Process ashmem detail info:</li><li>---------------------------------------------------------------------------------</li><li>Process_name    Process_ID      Fd      Cnode_idx       Applicant_Pid   Ashmem_name     Virtual_size    Physical_size   magic</li><li>XXXXX    816     22      328234  816     dev/ashmem/PolicyVolumeMap      541     4096    7</li><li>......</li><li>---------------------------------------------------------------------------------</li><li>*****************************</li><li>LOGGER_MEMCHECK_RENDER_SERVICE_MEM</li><li>get info realtime:      2025/05/30 19:52:42</li><li>
</li><li>-------------------------------[ability]-------------------------------</li><li>
</li><li>----------------------------------RenderService----------------------------------</li><li>......</li></ol></pre></div></div> </li><li>ion内存泄漏：<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>*****************************</li><li>LOGGER_MEMCHECK_PROC_INFO</li><li>MM_DMABUF_INFO</li><li>realtime:    2025/07/26 14:19:58</li><li>Process    pid    fd    size_bytes    ino    exp_pid    exp_task_comm    buf_name    exp_name    buf_type    </li><li>process1        1563    71    13926400    25690    11187    allocator_host    11563    mm_heap_helpers    xcomponent    </li><li>process1        1563    75    1024000000    21095    11187    allocator_host    11563    mm_heap_helpers    NULL    </li><li>process1        1563    77    1024000000    11557    11187    allocator_host    11563    mm_heap_helpers    NULL    </li><li>process1        1563    79    1024000000    26747    11187    allocator_host    11563    mm_heap_helpers    NULL    </li><li>************ endl ************</li><li>
</li><li>*****************************</li><li>LOGGER_MEMCHECK_RENDER_SERVICE_MEM </li><li>get info realtime:      2025/05/30 21:17:39</li><li>
</li><li>-------------------------------[ability]-------------------------------</li><li>
</li><li>
</li><li>----------------------------------RenderService----------------------------------</li><li>......</li></ol></pre></div></div> </li><li>gpu/gpu_rs内存泄漏：<div _ngcontent-qnj-c106="" class="highlight-div"><div _ngcontent-qnj-c106="" class="highlight-div-header"><div _ngcontent-qnj-c106="" class="highlight-div-header-left"><div _ngcontent-qnj-c106="" class="handle-button expand-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qnj-c106="" class="highlight-div-header-right"><div _ngcontent-qnj-c106="" class="handle-button ai-button"></div><div _ngcontent-qnj-c106="" class="handle-button line-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qnj-c106="" class="handle-button theme-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qnj-c106="" class="handle-button copy-button"><div _ngcontent-qnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qnj-c106="" class="highlight-scroll-div"><pre class="Plaintext prettyprint linenums hljs language-Plaintext" hw-language="Plaintext" data-highlighted="yes"><ol class="linenums"><li>LOGGER_MEMCHECK_PROC_INFO</li><li>GPU_PROCESS_INFO</li><li>render_service</li><li>ctx_1       1689       1455 used summary:3362426880 grow:0 driver:10432512 kmd:3260416 jit:131072</li><li>process1</li><li>Channel: xx default device (Total memory: 730594)</li><li>  1:                    2 / 2</li><li>  6:                    4 / 160</li><li>  7:                    6 / 384</li><li>  8:                  163 / 20928</li><li>  9:                 1573 / 604160</li><li> 10:                   48 / 24576</li><li> 11:                    2 / 2048</li><li> 13:                    2 / 12800</li><li> 15:                    4 / 65536</li><li>......</li><li>
</li><li>*****************************</li><li>LOGGER_MEMCHECK_RENDER_SERVICE_MEM</li><li>get info realtime:      2025/05/30 21:16:01</li><li>
</li><li>-------------------------------[ability]-------------------------------</li><li>
</li><li>
</li><li>----------------------------------RenderService----------------------------------</li></ol></pre></div></div> </li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1. gpu_rs内存泄漏与gpu泄漏的区别在于：gpu是应用自渲染发生的泄漏，gpu_rs是通过进程render_service进行统一渲染发生的泄漏。</p> <p>2. 在资源泄漏资料中，ion、dmaheap、dmabuf 可理解为同一种内存类型，不作强区分。</p> <p>3. 当前日志规格不代表维测的最终形态，后续会根据版本问题以及用户原声增加维测信息，变更形式包括但不限于行、列、段落等。</p> </div></div></div> </div> <div></div></div>