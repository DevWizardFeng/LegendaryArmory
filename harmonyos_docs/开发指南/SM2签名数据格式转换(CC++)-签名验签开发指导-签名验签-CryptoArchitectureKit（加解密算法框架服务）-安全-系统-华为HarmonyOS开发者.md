<h1 _ngcontent-uva-c119="" class="doc-title ng-star-inserted" title="SM2签名数据格式转换 (C/C++)"> SM2签名数据格式转换 (C/C++) </h1>

<div _ngcontent-uva-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当前支持DER格式与r、s格式互转的能力。</p>    <p>开发者可指定SM2密文的参数，将其转换成DER格式密文。反之，也可以从DER格式密文中提取出SM2的具体密文参数。</p>    <p><strong>指定密文参数，转换为DER格式</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_create" target="_blank">OH_CryptoEccSignatureSpec_Create</a>，创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-cryptosignatureapi-oh-cryptoeccsignaturespec" target="_blank">OH_CryptoEccSignatureSpec</a>对象，用于设置SM2密文参数。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_setrands" target="_blank">OH_CryptoEccSignatureSpec_SetRAndS</a>，将R、S设置到OH_CryptoEccSignatureSpec对象中。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_encode" target="_blank">OH_CryptoEccSignatureSpec_Encode</a>得到转换后的DER格式的密文。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_destroy" target="_blank">OH_CryptoEccSignatureSpec_Destroy</a>释放对象。</p></li>    </ol>    <div _ngcontent-uva-c106="" class="highlight-div"><div _ngcontent-uva-c106="" class="highlight-div-header"><div _ngcontent-uva-c106="" class="highlight-div-header-left"><div _ngcontent-uva-c106="" class="handle-button expand-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uva-c106="" class="highlight-div-header-right"><div _ngcontent-uva-c106="" class="handle-button ai-button"></div><div _ngcontent-uva-c106="" class="handle-button line-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uva-c106="" class="handle-button theme-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uva-c106="" class="handle-button copy-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uva-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_common.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_asym_key.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_signature.h"</span></span></li><li>
</li><li><span class="hljs-keyword">static</span> OH_Crypto_ErrCode doTestSm2DataChange()</li><li>{</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> g_rCoordinate[] = {</li><li>        <span class="hljs-number">107</span>, <span class="hljs-number">93</span>,  <span class="hljs-number">198</span>, <span class="hljs-number">247</span>, <span class="hljs-number">119</span>, <span class="hljs-number">18</span>,  <span class="hljs-number">40</span>,  <span class="hljs-number">110</span>, <span class="hljs-number">90</span>,  <span class="hljs-number">156</span>, <span class="hljs-number">193</span>,</li><li>        <span class="hljs-number">158</span>, <span class="hljs-number">205</span>, <span class="hljs-number">113</span>, <span class="hljs-number">170</span>, <span class="hljs-number">128</span>, <span class="hljs-number">146</span>, <span class="hljs-number">109</span>, <span class="hljs-number">75</span>,  <span class="hljs-number">17</span>,  <span class="hljs-number">181</span>, <span class="hljs-number">109</span>,</li><li>        <span class="hljs-number">110</span>, <span class="hljs-number">91</span>,  <span class="hljs-number">149</span>, <span class="hljs-number">5</span>,   <span class="hljs-number">110</span>, <span class="hljs-number">233</span>, <span class="hljs-number">209</span>, <span class="hljs-number">78</span>,  <span class="hljs-number">229</span>, <span class="hljs-number">96</span>};</li><li>
</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> g_sCoordinate[] = {</li><li>        <span class="hljs-number">45</span>,  <span class="hljs-number">153</span>, <span class="hljs-number">88</span>,  <span class="hljs-number">82</span>,  <span class="hljs-number">104</span>, <span class="hljs-number">221</span>, <span class="hljs-number">226</span>, <span class="hljs-number">43</span>,  <span class="hljs-number">174</span>, <span class="hljs-number">21</span>,  <span class="hljs-number">122</span>,</li><li>        <span class="hljs-number">248</span>, <span class="hljs-number">5</span>,   <span class="hljs-number">232</span>, <span class="hljs-number">105</span>, <span class="hljs-number">41</span>,  <span class="hljs-number">92</span>,  <span class="hljs-number">95</span>,  <span class="hljs-number">102</span>, <span class="hljs-number">224</span>, <span class="hljs-number">216</span>, <span class="hljs-number">149</span>,</li><li>        <span class="hljs-number">85</span>,  <span class="hljs-number">236</span>, <span class="hljs-number">110</span>, <span class="hljs-number">6</span>,   <span class="hljs-number">64</span>,  <span class="hljs-number">188</span>, <span class="hljs-number">149</span>, <span class="hljs-number">70</span>,  <span class="hljs-number">70</span>,  <span class="hljs-number">183</span>};</li><li>
</li><li>    <span class="hljs-comment">// 由R和S生成DER格式的签名数据。</span></li><li>    OH_CryptoEccSignatureSpec *spec = <span class="hljs-literal">NULL</span>;</li><li>    Crypto_DataBlob r = {<span class="hljs-number">0</span>};</li><li>    Crypto_DataBlob s = {<span class="hljs-number">0</span>};</li><li>    r.data = g_rCoordinate;</li><li>    r.len = <span class="hljs-keyword">sizeof</span>(g_rCoordinate);</li><li>    s.data = g_sCoordinate;</li><li>    s.len = <span class="hljs-keyword">sizeof</span>(g_sCoordinate);</li><li>    OH_Crypto_ErrCode ret = OH_CryptoEccSignatureSpec_Create(<span class="hljs-literal">NULL</span>, &amp;spec);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        OH_CryptoEccSignatureSpec_Destroy(spec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = OH_CryptoEccSignatureSpec_SetRAndS(spec, &amp;r, &amp;s);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        OH_CryptoEccSignatureSpec_Destroy(spec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    Crypto_DataBlob sig = {<span class="hljs-number">0</span>};</li><li>    ret = OH_CryptoEccSignatureSpec_Encode(spec, &amp;sig);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        OH_CryptoEccSignatureSpec_Destroy(spec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    OH_Crypto_FreeDataBlob(&amp;sig);</li><li>    OH_CryptoEccSignatureSpec_Destroy(spec);</li><li>    spec = <span class="hljs-literal">NULL</span>;</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>
</li><li>}</li></ol></pre></div></div>    <p><strong>指定DER格式，转换为r、s格式</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_create" target="_blank">OH_CryptoEccSignatureSpec_Create</a>传入签名数据，创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-cryptosignatureapi-oh-cryptoeccsignaturespec" target="_blank">OH_CryptoEccSignatureSpec</a>对象，用于获取转换后的数据。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_getrands" target="_blank">OH_CryptoEccSignatureSpec_GetRAndS</a>拿到转换后的数据r、s。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-signature-h#oh_cryptoeccsignaturespec_destroy" target="_blank">OH_CryptoEccSignatureSpec_Destroy</a>释放内存。</p></li>    </ol>    <div _ngcontent-uva-c106="" class="highlight-div"><div _ngcontent-uva-c106="" class="highlight-div-header"><div _ngcontent-uva-c106="" class="highlight-div-header-left"><div _ngcontent-uva-c106="" class="handle-button expand-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uva-c106="" class="highlight-div-header-right"><div _ngcontent-uva-c106="" class="handle-button ai-button"></div><div _ngcontent-uva-c106="" class="handle-button line-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uva-c106="" class="handle-button theme-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uva-c106="" class="handle-button copy-button"><div _ngcontent-uva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uva-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_common.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_asym_key.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_signature.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doSm2GetRS</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">uint8_t</span> signText[] = {</li><li>        <span class="hljs-number">0x30</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xab</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0xe2</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x5b</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0x9a</span>, <span class="hljs-number">0xbd</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xa6</span>,</li><li>        <span class="hljs-number">0x81</span>, <span class="hljs-number">0xd6</span>, <span class="hljs-number">0xb1</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0xd2</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xa8</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xe0</span>, <span class="hljs-number">0x1d</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x74</span>,</li><li>        <span class="hljs-number">0xa0</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x94</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xc3</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0xa6</span>,</li><li>        <span class="hljs-number">0x5e</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-number">0x3d</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x1c</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0xca</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0xcd</span>,</li><li>        <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xc5</span>,</li><li>    };</li><li>    Crypto_DataBlob signBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(signText),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(signText)};</li><li>
</li><li>    OH_CryptoEccSignatureSpec *eccSignSpec = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoEccSignatureSpec_Create</span>(&amp;signBlob, &amp;eccSignSpec);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    Crypto_DataBlob r = {.data = <span class="hljs-literal">nullptr</span>, .len = <span class="hljs-number">0</span>};</li><li>    Crypto_DataBlob s = {.data = <span class="hljs-literal">nullptr</span>, .len = <span class="hljs-number">0</span>};</li><li>    ret = <span class="hljs-built_in">OH_CryptoEccSignatureSpec_GetRAndS</span>(eccSignSpec, &amp;r, &amp;s);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoEccSignatureSpec_Destroy</span>(eccSignSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;r);</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;s);</li><li>    <span class="hljs-built_in">OH_CryptoEccSignatureSpec_Destroy</span>(eccSignSpec);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>   </div>   <div></div></div>