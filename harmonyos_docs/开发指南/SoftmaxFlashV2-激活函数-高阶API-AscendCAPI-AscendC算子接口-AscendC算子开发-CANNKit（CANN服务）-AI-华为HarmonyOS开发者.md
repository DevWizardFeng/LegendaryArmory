<h1 _ngcontent-uxy-c119="" class="doc-title ng-star-inserted" title="SoftmaxFlashV2"> SoftmaxFlashV2 </h1>

<div _ngcontent-uxy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section194135143713">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section194135143713" tips="复制节点链接"></i></h2><p>将输入tensor[m<sub>0</sub>, m<sub>1</sub>, ...m<sub>t</sub>, n]（t大于等于0）的非尾轴长度相乘的结果看作m，则输入tensor的shape看作[m, n]。对输入tensor[m,n]按行做如下计算，不同的update值对应不同的计算公式，其中x、inmax和insum为输入，M、S、E均为输出。</p> </div> <ul><li>update为false：<p><span><img originheight="136" originwidth="335" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114310.91920298896391141516872029876936:50001231000000:2800:B6629C1C3D3649874C95CFFBE81D7ADD70BBFC1A5D76B9D25E4B9386939DE1FB.png" width="335" height="136"></span></p> </li><li>update为true：<p><span><img originheight="177" originwidth="335" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114310.91823633672894683171263824485246:50001231000000:2800:60EE484B19634A3AAE5C8045DD40E10379AF1FE97B1AAD9C27EF0CCB60B4EC8D.png" width="335" height="177"></span></p> </li></ul> <p>当输入shape为ND格式时，内部的reduce过程按last轴进行。当输入shape为NZ格式时，内部的reduce过程按照last轴和first轴进行</p> <div class="tiledSection"><h2 id="section0163113613382">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section0163113613382" tips="复制节点链接"></i></h2><p>计算过程根据isUpdate是否使能分为两个分支处理，均在Vector上进行。</p> </div> <ul><li>当isUpdate为false时，分为如下几步：<ol><li>reducemax步骤：对输入x的每一行数据求最大值得到[m, 1]，计算结果会保存到一个临时空间temp中。</li><li>broadcast步骤：对temp中的数据[m, 1]做一个按datablock为单位的填充，比如float类型下，把[m, 1]扩展成[m, 8]，同时输出max。</li><li>sub步骤：对输入x的所有数据按行减去max。</li><li>exp步骤：对sub之后的所有数据求exp，并且输出y。</li><li>reducesum步骤：对exp结果的每一行数据求和得到[m, 1]，计算结果会保存到临时空间temp中。</li><li>broadcast步骤：对temp[m, 1]做一个按datablock为单位的填充，比如float类型下，把[m, 1]扩展成[m, 8]，同时输出sum。</li></ol> </li></ul> <ul><li>当isUpdate为true时，分为如下几步：<ol><li>reducemax步骤：对输入x的每一行数据求最大值得到[m, 1]，计算结果会保存到一个临时空间temp中。</li><li>broadcast步骤：对temp中的数据[m, 1]做一个按datablock为单位的填充，比如float类型下，把[m, 1]扩展成[m, 8]，保存为max。</li><li>max步骤：对输入inmax和上一步计算的max做max操作，得到新的max并输出。</li><li>sub步骤：将输入inmax和新的max相减，然后做exp，计算得到expmax并输出。</li><li>sub步骤：将输入x和新的max按行相减。</li><li>exp步骤：对sub之后的所有数据求exp，并且输出y。</li><li>reducesum步骤：对exp结果的每一行数据求和得到[m, 1]，计算结果会保存到临时空间temp中。</li><li>broadcast步骤：对temp数据[m, 1]做一个按datablock为单位的填充，比如float类型下，把[m, 1]扩展成[m, 8]，保存到sum中。</li><li>mul步骤：将输入insum和expmax结果相乘。</li><li>add步骤：将相乘结果和sum相加，保存到sum并输出。</li></ol> </li></ul> <div class="tiledSection"><h2 id="section562413129409">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section562413129409" tips="复制节点链接"></i></h2><div class="p">高阶API接口<div _ngcontent-uxy-c106="" class="highlight-div"><div _ngcontent-uxy-c106="" class="highlight-div-header"><div _ngcontent-uxy-c106="" class="highlight-div-header-left"><div _ngcontent-uxy-c106="" class="handle-button expand-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uxy-c106="" class="highlight-div-header-right"><div _ngcontent-uxy-c106="" class="handle-button ai-button"></div><div _ngcontent-uxy-c106="" class="handle-button line-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uxy-c106="" class="handle-button theme-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uxy-c106="" class="handle-button copy-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uxy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-type">bool</span> isUpdate = <span class="hljs-literal">false</span>, <span class="hljs-type">bool</span> isReuseSource = <span class="hljs-literal">false</span>, <span class="hljs-type">bool</span> isBasicBlock = <span class="hljs-literal">false</span>, <span class="hljs-type">bool</span> isDataFormatNZ = <span class="hljs-literal">false</span>, <span class="hljs-type">const</span> SoftmaxConfig&amp; config = SOFTMAX_DEFAULT_CFG&gt; __aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-built_in">SoftmaxFlashV2</span>(<span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; dstTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; expSumTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; maxTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; srcTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; expMaxTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; inExpSumTensor, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; inMaxTensor, <span class="hljs-type">const</span> SoftMaxTiling&amp; tiling, <span class="hljs-type">const</span> SoftMaxShapeInfo&amp; softmaxShapeInfo = {})</li></ol></pre></div></div> </div> <div class="p">tiling获取接口<div _ngcontent-uxy-c106="" class="highlight-div"><div _ngcontent-uxy-c106="" class="highlight-div-header"><div _ngcontent-uxy-c106="" class="highlight-div-header-left"><div _ngcontent-uxy-c106="" class="handle-button expand-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uxy-c106="" class="highlight-div-header-right"><div _ngcontent-uxy-c106="" class="handle-button ai-button"></div><div _ngcontent-uxy-c106="" class="handle-button line-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uxy-c106="" class="handle-button theme-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uxy-c106="" class="handle-button copy-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uxy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-keyword">constexpr</span> SoftMaxTiling <span class="hljs-title">SoftMaxFlashV2TilingFunc</span><span class="hljs-params">(<span class="hljs-type">const</span> SoftMaxShapeInfo&amp; shapeInfo, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> dataTypeSize1, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> dataTypeSize2, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> localWorkSpaceSize, <span class="hljs-type">const</span> <span class="hljs-type">bool</span> isUpdate = <span class="hljs-literal">false</span>, <span class="hljs-type">const</span> <span class="hljs-type">bool</span> isBasicBlock = <span class="hljs-literal">false</span>, <span class="hljs-type">const</span> <span class="hljs-type">bool</span> isDataFormatNZ = <span class="hljs-literal">false</span>, <span class="hljs-type">const</span> <span class="hljs-type">bool</span> isFlashOutputBrc = <span class="hljs-literal">false</span>)</span></span></li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h2 id="section12101153519402">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section12101153519402" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>模板参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.2.2.3.1.1" valign="top" width="19.189999999999998%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.2.2.3.1.2" valign="top" width="80.81%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p>T</p> </td> <td class="cellrowborder" valign="top" width="80.81%"><p><span style="color: rgb(73,73,73);">操作数的数据类型。</span><span style="color: rgb(73,73,73);">支持的数据类型为：half、float。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p>isUpdate</p> </td> <td class="cellrowborder" valign="top" width="80.81%"><p><span style="color: rgb(73,73,73);">是否使能</span><span style="color: rgb(73,73,73);">update</span><span style="color: rgb(73,73,73);">部分中的计算。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p>isReuseSource</p> </td> <td class="cellrowborder" valign="top" width="80.81%"><p><span style="color: rgb(73,73,73);">预留参数，暂未启用，为后续的功能扩展做保留，必须使用默认值，默认值为false。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p><span style="color: rgb(73,73,73);">isBasicBlock</span></p> </td> <td class="cellrowborder" valign="top" width="80.81%"><p><span style="color: rgb(73,73,73);">该参数为预留参数，只支持</span><span style="color: rgb(73,73,73);">false</span><span style="color: rgb(73,73,73);">。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p><span style="color: rgb(73,73,73);">isDataFormatNZ</span></p> </td> <td class="cellrowborder" valign="top" width="80.81%"><p><span style="color: rgb(73,73,73);">数据格式支持</span><span style="color: rgb(73,73,73);">ND</span><span style="color: rgb(73,73,73);">和</span><span style="color: rgb(73,73,73);">NZ</span><span style="color: rgb(73,73,73);">，默认取值为</span><span style="color: rgb(73,73,73);">false</span><span style="color: rgb(73,73,73);">，为</span><span style="color: rgb(73,73,73);">ND</span><span style="color: rgb(73,73,73);">格式。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.189999999999998%"><p><span style="color: rgb(73,73,73);">config</span></p> </td> <td class="cellrowborder" valign="top" width="80.81%"><div _ngcontent-uxy-c106="" class="highlight-div"><div _ngcontent-uxy-c106="" class="highlight-div-header"><div _ngcontent-uxy-c106="" class="highlight-div-header-left"><div _ngcontent-uxy-c106="" class="handle-button expand-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uxy-c106="" class="highlight-div-header-right"><div _ngcontent-uxy-c106="" class="handle-button ai-button"></div><div _ngcontent-uxy-c106="" class="handle-button line-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uxy-c106="" class="handle-button theme-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uxy-c106="" class="handle-button copy-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uxy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SoftmaxConfig</span>{</li><li>    <span class="hljs-comment">// 是否需要检查shape和tiling的一致性；若不一致，API内会根据shape重新计算所需tiling。默认取值true：API内部会检查一致性</span></li><li>    <span class="hljs-type">bool</span> isCheckTiling = <span class="hljs-literal">true</span>; </li><li>};</li></ol></pre></div></div> </td> </tr>  </tbody></table></div> </div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>高阶API接口参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.4.1.1" valign="top" width="16.16%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.4.1.2" valign="top" width="11.110000000000001%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.4.1.3" valign="top" width="72.72999999999999%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">dstTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p><span style="color: rgb(73,73,73);">目的操作数。</span></p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p><span style="color: rgb(73,73,73);">dstTensor</span><span style="color: rgb(73,73,73);">的</span><span style="color: rgb(73,73,73);">shape</span><span style="color: rgb(73,73,73);">和源操作数</span><span style="color: rgb(73,73,73);">srcTensor</span><span style="color: rgb(73,73,73);">一致。</span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">expSumTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>用于保存softmax计算过程中reducesum的结果。</p> <p>expSumTensor的last轴长度固定为32Byte，即一个datablock长度。该datablock中的所有数据为同一个值，比如half数据类型下，该datablock中的16个数均为相同的reducesum的值。</p> <p>非last轴的长度与dstTensor保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">maxTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>用于保存softmax计算过程中reducemax的结果。</p> <p>maxTensor的last轴长度固定为32Byte，即一个datablock长度。该datablock中的所有数据为同一个值。比如half数据类型下，该datablock中的16个数均为相同的reducemax的值。</p> <p>非last轴的长度与dstTensor保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">srcTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>last轴长度需要32Byte对齐。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">expMaxTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>expMaxTensor的last轴长度固定为32Byte，即一个datablock长度。该datablock中的所有数据为同一个值，比如half数据类型下，该datablock中的16个数均为相同的值。</p> <p>非last轴的长度需要与dstTensor保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">inExpSumTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>softmax计算所需要的sum值。</p> <p>inExpSumTensor的last轴长度固定为32Byte，即一个datablock长度。该datablock中的所有数据为同一个值，比如half数据类型下，该datablock中的16个数均为相同的值。</p> <p>非last轴的长度需要与dstTensor保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p><span style="color: rgb(73,73,73);">inMaxTensor</span></p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，</p> <p>支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>softmax计算所需要的max值。</p> <p>除模板参数config配置为非拓展模式（SoftmaxMode::SOFTMAX_OUTPUT_WITHOUT_BRC）的场景外，inMaxTensor的last轴长度固定为32Byte，即一个datablock长度。该datablock中的所有数据为同一个值，比如half数据类型下，该datablock里的16个数均为相同的值。</p> <p>非last轴的长度需要与dstTensor保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>tiling</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>softmaxflashv2接口计算所需tiling信息。通过SoftMaxFlashV2TilingFunc获取。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>softmaxShapeInfo</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>srcTensor的shape信息。SoftMaxShapeInfo类型，具体定义如下：</p> <div _ngcontent-uxy-c106="" class="highlight-div"><div _ngcontent-uxy-c106="" class="highlight-div-header"><div _ngcontent-uxy-c106="" class="highlight-div-header-left"><div _ngcontent-uxy-c106="" class="handle-button expand-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uxy-c106="" class="highlight-div-header-right"><div _ngcontent-uxy-c106="" class="handle-button ai-button"></div><div _ngcontent-uxy-c106="" class="handle-button line-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uxy-c106="" class="handle-button theme-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uxy-c106="" class="handle-button copy-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uxy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SoftMaxShapeInfo</span> {</li><li>    <span class="hljs-type">uint32_t</span> srcM; <span class="hljs-comment">// 非尾轴长度的乘积</span></li><li>    <span class="hljs-type">uint32_t</span> srcK; <span class="hljs-comment">// 尾轴长度，必须32Byte对齐</span></li><li>    <span class="hljs-type">uint32_t</span> oriSrcM; <span class="hljs-comment">// 原始非尾轴长度的乘积</span></li><li>    <span class="hljs-type">uint32_t</span> oriSrcK; <span class="hljs-comment">// 原始尾轴长度</span></li><li>};</li></ol></pre></div></div> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>SoftMaxFlashV2TilingFunc接口参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.2.4.1.1" valign="top" width="16.16%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.1.2" valign="top" width="11.110000000000001%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.1.3" valign="top" width="72.72999999999999%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.16%"><p>srcShape</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>输入srcTensor的shape信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>localWorkSpaceSize</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>剩余的可供SoftmaxFlashV2接口计算的空间大小。目前不需要。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>dataTypeSize1</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>计算的源数据的数据类型，比如half=2。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>dataTypeSize2</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>参与计算的maxTensor和sumTensor的数据类型，比如half=2。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>isUpdate</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>是否使能刷新功能，和kernel侧SoftmaxFlashV2接口一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>isBasicBlock</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>是否要使能基本块计算。只支持false。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>isFlashOutputBrc</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>是否使能输出shape的非拓展模式。建议设置为false或使用默认值</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>softmaxFlashTiling</p> </td> <td class="cellrowborder" valign="top" width="11.110000000000001%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>输出SoftmaxFlashV2接口所需的tiling信息。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section1595153911439">返回值<i class="anchor-icon anchor-icon-link" anchorid="section1595153911439" tips="复制节点链接"></i></h2><p>无</p> </div> <div class="tiledSection"><h2 id="section18815135534313">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section18815135534313" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> </div> <p>KirinX90系列处理器</p> <div class="tiledSection"><h2 id="section1892013449">约束说明<i class="anchor-icon anchor-icon-link" anchorid="section1892013449" tips="复制节点链接"></i></h2><ul><li>srcTensor和dstTensor的Tensor的空间可以复用，maxTensor和inMaxTensor的空间可以复用，expSumTensor和inExpSumTensor的空间可以复用。</li><li>除模板参数config配置为非拓展模式（SoftmaxMode::SOFTMAX_OUTPUT_WITHOUT_BRC）的场景外，expSumTensor、maxTensor、expMaxTensor、inExpSumTensor、inMaxTensor的Tensor空间，last轴长度必须固定32Byte。</li></ul> <ul><li>操作数地址偏移对齐要求请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-general-constraints">通用约束</a>。</li><li>输入输出操作数参与计算的数据长度要求32B对齐。</li></ul> </div> <div class="tiledSection"><h2 id="section1443104994416">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section1443104994416" tips="复制节点链接"></i></h2><div _ngcontent-uxy-c106="" class="highlight-div"><div _ngcontent-uxy-c106="" class="highlight-div-header"><div _ngcontent-uxy-c106="" class="highlight-div-header-left"><div _ngcontent-uxy-c106="" class="handle-button expand-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uxy-c106="" class="highlight-div-header-right"><div _ngcontent-uxy-c106="" class="handle-button ai-button"></div><div _ngcontent-uxy-c106="" class="handle-button line-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uxy-c106="" class="handle-button theme-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uxy-c106="" class="handle-button copy-button"><div _ngcontent-uxy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uxy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 其它处理省略</span></li><li><span class=""><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span></span></span><span class="hljs-function"></span></li><li><span class="hljs-function"></span>{</li><li>    AscendC::LocalTensor&lt;half&gt; xLocal = queueX.<span class="hljs-built_in">DeQue</span>&lt;half&gt;();</li><li>    AscendC::SoftMaxShapeInfo srcShape = { M_VALUE, K_VALUE, M_VALUE, K_VALUE };</li><li>    AscendC::<span class="hljs-built_in">SoftmaxFlashV2</span>&lt;half, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>&gt;(xLocal, sumLocal, maxLocal, xLocal, expmaxLocal, sumLocal,</li><li>        maxLocal, softmaxTiling, srcShape);</li><li>    AscendC::<span class="hljs-built_in">DataCopy</span>(zGm[<span class="hljs-number">0</span>], xLocal, xLength);</li><li>    queueX.<span class="hljs-built_in">FreeTensor</span>(xLocal);</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>