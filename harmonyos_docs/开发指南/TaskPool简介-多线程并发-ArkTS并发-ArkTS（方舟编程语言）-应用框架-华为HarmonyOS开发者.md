<h1 _ngcontent-plk-c119="" class="doc-title ng-star-inserted" title="TaskPool简介"> TaskPool简介 </h1>

<div _ngcontent-plk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>TaskPool为应用程序提供多线程环境，降低资源消耗并提高系统性能。无需管理线程生命周期。具体接口信息及使用方法，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>。</p>    <div class="tiledSection">     <h2 id="taskpool运作机制">TaskPool运作机制<i class="anchor-icon anchor-icon-link" anchorid="taskpool运作机制" tips="复制节点链接"></i></h2>          <p>TaskPool运作机制示意图</p>     <p><span><img originheight="535" originwidth="800" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114805.41472588781923136053240959912304:50001231000000:2800:61E24397BB502C20B4AC1240040366D1DAFF609FB552CAEEA99CA257F8133CD3.png" width="800" height="535"></span></p>     <p>TaskPool支持在宿主线程提交任务到任务队列，系统选择合适的工作线程执行任务，并将结果返回给宿主线程。接口易用，支持任务执行、取消和指定优先级。通过系统统一线程管理，结合动态调度和负载均衡算法，可以节约系统资源。系统默认启动一个任务工作线程，任务多时会自动扩容。工作线程数量上限由设备的物理核数决定，内部管理具体数量，确保调度和执行效率最优。长时间无任务分发时会缩容，减少工作线程数量。具体扩缩容机制请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction#taskpool扩缩容机制">TaskPool扩缩容机制</a>。</p>    </div>    <div class="tiledSection">     <h2 id="taskpool注意事项">TaskPool注意事项<i class="anchor-icon anchor-icon-link" anchorid="taskpool注意事项" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>实现任务的函数需要使用<a href="/consumer/cn/doc/harmonyos-guides/taskpool-introduction#concurrent装饰器">@Concurrent装饰器</a>标注，且仅支持在.ets文件中使用。</p></li>      <li>       <p>从API version 11开始，跨并发实例传递带方法的实例对象时，该类必须使用装饰器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable装饰器">@Sendable装饰器</a>标注，且仅支持在.ets文件中使用。</p></li>      <li>       <p>任务函数（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#longtask12" target="_blank">LongTask</a>除外）在TaskPool工作线程中的执行时长不能超过3分钟。否则，任务将被强制终止。需要注意的是，这里的3分钟限制仅统计TaskPool线程的​​同步运行时长​​，不包含异步操作（如Promise或async/await）的等待时长。例如，数据库的插入、删除、更新等操作，如果是异步操作，仅计入CPU实际处理时长（如SQL解析），网络传输或磁盘I/O等待时长不计入；如果是同步操作，整个操作时长（含I/O阻塞时间）均计入限制。开发者可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#task" target="_blank">Task</a>的属性ioDuration、cpuDuration获取执行当前任务的异步IO耗时和CPU耗时。</p></li>      <li>       <p>实现任务的函数入参需满足序列化支持的类型。详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/serializable-overview">线程间通信对象概述</a>。目前不支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State装饰器</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop装饰器</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link装饰器</a>等装饰器修饰的复杂类型。</p></li>      <li>       <p>ArrayBuffer参数在TaskPool中默认转移，需要设置转移列表的话可通过接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#settransferlist10" target="_blank">setTransferList()</a>设置。如果需要多次调用使用ArrayBuffer作为参数的task，则需要通过接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#setclonelist11" target="_blank">setCloneList()</a>把ArrayBuffer在线程中的传输行为改成拷贝传递，避免对原有对象产生影响。</p></li>     </ul>     <p>除上述注意事项外，使用TaskPool时还需注意<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multi-thread-concurrency-overview#并发注意事项">并发注意事项</a>。</p>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">printArrayBuffer</span>(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">return</span> buffer;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testArrayBuffer</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-keyword">const</span> group = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">TaskGroup</span>();</li><li>  <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(printArrayBuffer, buffer);</li><li>  group.<span class="hljs-title function_">addTask</span>(task);</li><li>  task.<span class="hljs-title function_">setCloneList</span>([buffer]);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {</li><li>    taskpool.<span class="hljs-title function_">execute</span>(group).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'execute group success'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`execute group error: <span class="hljs-subst">${e.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <ul>      <li>       <p>由于不同线程中上下文对象不同，TaskPool工作线程只能使用线程安全的模块。例如，不能使用UI相关的非线程安全模块。TaskPool/Worker等工作线程不支持使用操作UI的模块、线程不安全的模块以及其他只支持在主线程中使用的模块。不支持UI模块是因为目前工作线程不支持操作UI，不支持线程不安全的模块是因为多线程使用该模块可能会导致多线程问题，只支持在主线程中使用的模块明确在文档中说明的有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-applicationcontext" target="_blank">ApplicationContext</a>等。线程安全的模块是指多线程同时使用该模块也不会引入多线程问题，如TaskPool/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">Worker</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hilog">hilog</a>等。</p></li>      <li>       <p>序列化传输的数据量限制为16MB。</p></li>      <li>       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#priority" target="_blank">Priority</a>的IDLE优先级是用来标记需要在后台运行的耗时任务（例如数据同步、备份），它的优先级别是最低的。这种优先级的任务只在所有线程都空闲时触发执行，并且同一时间只会有一个IDLE优先级的任务执行。</p></li>      <li>       <p>Promise不支持跨线程传递。TaskPool返回pending或rejected状态的Promise时会失败，返回fulfilled状态的Promise时TaskPool会解析返回的结果，如果结果可以跨线程传递，则返回成功。</p></li>      <li>       <p>不支持在TaskPool工作线程中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage">AppStorage</a>。</p></li>      <li>       <p>TaskPool支持在宿主线程封装任务并提交给任务队列，理论上支持的任务数量没有上限。然而，任务的执行效率受限于任务的优先级和系统资源。当工作线程达到最大数量时，任务的执行效率可能会下降。</p></li>      <li>       <p>TaskPool不支持指定任务所运行的线程，任务会被分配到空闲的线程中执行。如果需要指定任务所运行的线程，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">Worker</a>。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="concurrent装饰器">@Concurrent装饰器<i class="anchor-icon anchor-icon-link" anchorid="concurrent装饰器" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>时，执行的并发函数必须用该装饰器修饰，否则无法通过校验。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 9开始，支持使用@Concurrent装饰器声明并校验并发函数。</p>      </div></div></div>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.3.1.1" valign="top" width="50%">@Concurrent并发装饰器</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">装饰器参数</td>         <td class="cellrowborder" valign="top" width="50%">无。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">使用场景</td>         <td class="cellrowborder" valign="top" width="50%">仅支持在Stage模型的工程中使用。仅支持在.ets文件中使用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">装饰的函数类型</td>         <td class="cellrowborder" valign="top" width="50%">允许标注为async函数或普通函数。禁止标注为generator、箭头函数、类方法。不支持类成员函数或者匿名函数。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">装饰的函数内的变量类型</td>         <td class="cellrowborder" valign="top" width="50%">允许使用局部变量、入参和通过import引入的变量，禁止使用闭包变量。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">装饰的函数内的返回值类型</td>         <td class="cellrowborder" valign="top" width="50%">支持的类型请查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/serializable-overview">线程间通信对象概述</a>。</td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>由于@Concurrent标记的函数不能访问闭包，因此函数内部不能调用当前文件的其他函数，例如：</p>       <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"></span>) {</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title function_">bar</span>(); <span class="hljs-comment">// 违反闭包原则，报错</span></li><li>}</li></ol></pre></div></div>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="装饰器使用示例">装饰器使用示例<i class="anchor-icon anchor-icon-link" anchorid="装饰器使用示例" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="并发函数一般使用" class="firsth2">并发函数一般使用<i class="anchor-icon anchor-icon-link" anchorid="并发函数一般使用" tips="复制节点链接"></i></h3>          <p>并发函数为一个计算两数之和的普通函数，taskpool执行该函数并返回结果。</p>     <p>示例：</p>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">num1: <span class="hljs-built_in">number</span>, num2: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">return</span> num1 + num2;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentFunc</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(add, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`taskpool res is: <span class="hljs-subst">${<span class="hljs-keyword">await</span> taskpool.execute(task)}</span>`</span>); <span class="hljs-comment">// 输出结果：taskpool res is: 3</span></li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`taskpool execute error is: <span class="hljs-subst">${e}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">concurrentFunc</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="并发函数返回promise">并发函数返回Promise<i class="anchor-icon anchor-icon-link" anchorid="并发函数返回promise" tips="复制节点链接"></i></h3>          <p>在并发函数中返回Promise时需特别注意。如示例所示，testPromise和testPromise1等函数需处理Promise并返回结果。</p>     <p>示例：</p>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise</span>(<span class="hljs-params">args1: <span class="hljs-built_in">number</span>, args2: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">resolve</span>(args1 + args2);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise1</span>(<span class="hljs-params">args1: <span class="hljs-built_in">number</span>, args2: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">resolve</span>(args1 + args2);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise2</span>(<span class="hljs-params">args1: <span class="hljs-built_in">number</span>, args2: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">resolve</span>(args1 + args2);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise3</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise4</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromise5</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Promise setTimeout after resolve'</span>);</li><li>    }, <span class="hljs-number">1000</span>)</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testConcurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task1</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task2</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise1, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task3</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise2, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task4</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise3);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task5</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise4);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task6</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromise5);</li><li>
</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task1).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task1 res is: <span class="hljs-subst">${d}</span>`</span>); <span class="hljs-comment">// 输出结果：task1 res is: 3</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task1 catch e: <span class="hljs-subst">${e}</span>`</span>);</li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task2).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task2 res is: <span class="hljs-subst">${d}</span>`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task2 catch e: <span class="hljs-subst">${e}</span>`</span>); <span class="hljs-comment">// 输出结果：task2 catch e: Error: Can't return Promise in pending state</span></li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task3).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task3 res is: <span class="hljs-subst">${d}</span>`</span>); <span class="hljs-comment">// 输出结果：task3 res is: 3</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task3 catch e: <span class="hljs-subst">${e}</span>`</span>);</li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task4).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task4 res is: <span class="hljs-subst">${d}</span>`</span>); <span class="hljs-comment">// 输出结果：task4 res is: 1</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task4 catch e: <span class="hljs-subst">${e}</span>`</span>);</li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task5).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task5 res is: <span class="hljs-subst">${d}</span>`</span>); <span class="hljs-comment">// 输出结果：task5 res is: 1</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task5 catch e: <span class="hljs-subst">${e}</span>`</span>);</li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task6).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task6 res is: <span class="hljs-subst">${d}</span>`</span>); <span class="hljs-comment">// 输出结果：task6 res is: Promise setTimeout after resolve</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task6 catch e: <span class="hljs-subst">${e}</span>`</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">testConcurrentFunc</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="并发函数中使用自定义类或函数">并发函数中使用自定义类或函数<i class="anchor-icon anchor-icon-link" anchorid="并发函数中使用自定义类或函数" tips="复制节点链接"></i></h3>          <p>在并发函数中使用自定义类或函数时，需将其定义在单独的文件中，否则可能被视为闭包。如下示例所示。</p>     <p>示例：</p>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { testAdd, <span class="hljs-title class_">MyTestA</span>, <span class="hljs-title class_">MyTestB</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Test'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">arg: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">return</span> ++arg;</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestA</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>
</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'ClassA'</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestB</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-attr">nameStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'ClassB'</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">TestFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// case1：在并发函数中直接调用同文件内定义的类或函数</span></li><li>
</li><li>  <span class="hljs-comment">// 直接调用同文件定义的函数add()，add飘红报错：Only imported variables and local variables can be used in @Concurrent decorated functions. &lt;ArkTSCheck&gt;</span></li><li>  <span class="hljs-comment">// add(1);</span></li><li>  <span class="hljs-comment">// 直接使用同文件定义的TestA构造，TestA飘红报错：Only imported variables and local variables can be used in @Concurrent decorated functions. &lt;ArkTSCheck&gt;</span></li><li>  <span class="hljs-comment">// const a = new TestA('aaa');</span></li><li>  <span class="hljs-comment">// 直接访问同文件定义的TestB的成员nameStr，TestB飘红报错：Only imported variables and local variables can be used in @Concurrent decorated functions. &lt;ArkTSCheck&gt;</span></li><li>  <span class="hljs-comment">// console.info(`TestB name is: ${TestB.nameStr}`);</span></li><li>
</li><li>  <span class="hljs-comment">// case2：在并发函数中调用定义在Test.ets文件并导入当前文件的类或函数</span></li><li>
</li><li>  <span class="hljs-comment">// 输出结果：res1 is: 2</span></li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`res1 is: <span class="hljs-subst">${testAdd(<span class="hljs-number">1</span>)}</span>`</span>);</li><li>  <span class="hljs-keyword">const</span> tmpStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTestA</span>(<span class="hljs-string">'TEST A'</span>);</li><li>  <span class="hljs-comment">// 输出结果：res2 is: TEST A</span></li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`res2 is: <span class="hljs-subst">${tmpStr.name}</span>`</span>);</li><li>  <span class="hljs-comment">// 输出结果：res3 is: MyTestB</span></li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`res3 is: <span class="hljs-subst">${MyTestB.nameStr}</span>`</span>);</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(<span class="hljs-title class_">TestFunc</span>);</li><li>          taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'taskpool: execute task success!'</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`taskpool: execute: Code: <span class="hljs-subst">${e.code}</span>, message: <span class="hljs-subst">${e.message}</span>`</span>);</li><li>          })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Test.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testAdd</span>(<span class="hljs-params">arg: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">return</span> ++arg;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTestA</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'MyTestA'</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTestB</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-attr">nameStr</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">'MyTestB'</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="并发异步函数中使用promise">并发异步函数中使用Promise<i class="anchor-icon anchor-icon-link" anchorid="并发异步函数中使用promise" tips="复制节点链接"></i></h3>          <p>在并发异步函数中使用Promise时，建议搭配await使用，这样TaskPool可以捕获Promise中的异常。推荐使用示例如下。</p>     <p>示例：</p>     <div _ngcontent-plk-c106="" class="highlight-div"><div _ngcontent-plk-c106="" class="highlight-div-header"><div _ngcontent-plk-c106="" class="highlight-div-header-left"><div _ngcontent-plk-c106="" class="handle-button expand-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-plk-c106="" class="highlight-div-header-right"><div _ngcontent-plk-c106="" class="handle-button ai-button"></div><div _ngcontent-plk-c106="" class="handle-button line-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-plk-c106="" class="handle-button theme-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-plk-c106="" class="handle-button copy-button"><div _ngcontent-plk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-plk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromiseError</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);</li><li>  }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'testPromise error'</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromiseError1</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">'testPromiseError1 error msg'</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testPromiseError2</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">'testPromiseError2 error msg'</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testConcurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task1</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromiseError);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task2</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromiseError1);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">task3</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(testPromiseError2);</li><li>
</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task1).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task1 res is: <span class="hljs-subst">${d}</span>`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task1 catch e: <span class="hljs-subst">${e}</span>`</span>); <span class="hljs-comment">// task1 catch e: Error: testPromise error</span></li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task2).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task2 res is: <span class="hljs-subst">${d}</span>`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task2 catch e: <span class="hljs-subst">${e}</span>`</span>); <span class="hljs-comment">// task2 catch e: testPromiseError1 error msg</span></li><li>  })</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task3).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`task3 res is: <span class="hljs-subst">${d}</span>`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`task3 catch e: <span class="hljs-subst">${e}</span>`</span>); <span class="hljs-comment">// task3 catch e: testPromiseError2 error msg</span></li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">testConcurrentFunc</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="taskpool扩缩容机制">TaskPool扩缩容机制<i class="anchor-icon anchor-icon-link" anchorid="taskpool扩缩容机制" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="扩容机制" class="firsth2">扩容机制<i class="anchor-icon anchor-icon-link" anchorid="扩容机制" tips="复制节点链接"></i></h3>          <p>一般情况下，向任务队列提交任务时会触发扩容检测。扩容检测首先判断当前空闲工作线程数是否大于任务数。如果大于，说明线程池中有空闲工作线程，无需扩容。否则，通过负载计算确定所需工作线程数并创建。</p>    </div>    <div class="tiledSection">     <h3 id="缩容机制">缩容机制<i class="anchor-icon anchor-icon-link" anchorid="缩容机制" tips="复制节点链接"></i></h3>          <p>扩容后，TaskPool创建多个工作线程，但当任务数减少后，这些线程就会处于空闲状态，造成资源浪费，因此，TaskPool提供了缩容机制。TaskPool使用定时器，每30秒检测一次当前负载，并尝试释放空闲的工作线程。释放的线程需满足以下条件：</p>     <ul>      <li>       <p>该线程空闲时长达到30s。</p></li>      <li>       <p>该线程上未执行长时任务（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#longtask12" target="_blank">LongTask</a>）。</p></li>      <li>       <p>该线程上没有业务申请且未释放的句柄，例如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-timer" target="_blank">Timer(定时器)</a>。</p></li>      <li>       <p>该线程处于非调试调优阶段。</p></li>      <li>       <p>该线程中不存在已创建未销毁的子Worker。</p></li>     </ul>    </div>   </div>   <div></div></div>