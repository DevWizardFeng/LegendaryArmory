<h1 _ngcontent-mlh-c119="" class="doc-title ng-star-inserted" title="TilingData结构定义"> TilingData结构定义 </h1>

<div _ngcontent-mlh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section75563mcpsimp">函数功能<i class="anchor-icon anchor-icon-link" anchorid="section75563mcpsimp" tips="复制节点链接"></i></h2><p>定义一个TilingData的类，添加所需的成员变量（TilingData字段），用于保存所需TilingData参数。完成该TilingData类的定义后，该类通过继承TilingDef类（用来存放、处理开发者自定义Tiling结构体成员变量的基类）提供以下接口：</p> <ul><li>set_+<em>field_name</em>接口：用于设置TilingData类的字段值，<em>field_name</em>为定义TilingData类时添加的字段名。</li><li>SaveToBuffer接口：完成TilingData的序列化和保存。</li><li>GetDataSize接口：获取TilingData的长度。</li></ul> </div> <div class="tiledSection"><h2 id="section75574mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section75574mcpsimp" tips="复制节点链接"></i></h2><ul><li>定义一个TilingData类<div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(class_name)</li></ol></pre></div></div> </li><li>添加通用数据类型的TilingData字段<div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(data_type, field_name)</li></ol></pre></div></div> </li><li>添加数组类型的TilingData字段，数组的元素数据类型为通用数据类型<div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(arr_type, arr_size, field_name)</li></ol></pre></div></div> </li><li>添加结构体类型的TilingData字段<div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(struct_type, field_name)</li></ol></pre></div></div> </li><li>定义结束<div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>END_TILING_DATA_DEF</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section75592mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section75592mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>BEGIN_TILING_DATA_DEF参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.2" valign="top" width="15.15%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.3" valign="top" width="67.67999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>class_name</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>开发者定义tiling结构体名，与c++变量命名要求一致。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>TILING_DATA_FIELD_DEF参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.2" valign="top" width="15.15%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.3" valign="top" width="67.67999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>data_type</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>字段的数据类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>field_name</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>字段名，与c++变量命名要求一致。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>TILING_DATA_FIELD_DEF_ARR参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.4.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.4.2.4.1.2" valign="top" width="15.15%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.4.2.4.1.3" valign="top" width="67.67999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>arr_type</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>数组元素数据类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>arr_size</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>数组元素个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>field_name</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>字段名，与c++变量命名要求一致。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表4 </b>TILING_DATA_FIELD_DEF_STRUCT参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.5.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.5.2.4.1.2" valign="top" width="15.15%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.5.2.4.1.3" valign="top" width="67.67999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>struct_type</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>结构体类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>field_name</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>字段名，与c++变量命名要求一致。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section75714mcpsimp">约束说明<i class="anchor-icon anchor-icon-link" anchorid="section75714mcpsimp" tips="复制节点链接"></i></h2><ul><li>使用SaveToBuffer接口时必须在set_+<em>field_name</em>接口后调用。</li><li>使用时需要包含头文件register/tilingdata_base.h。</li><li>TILING_DATA_FIELD_DEF和TILING_DATA_FIELD_DEF_ARR中定义的变量，仅支持int8_t, uint8_t, int16_t, uint16_t, int32_t, uint32_t, int64_t, uint64_t, float数据类型。</li><li>TILING_DATA_FIELD_DEF_STRUCT中struct_type仅支持用BEGIN_TILING_DATA_DEF等定义的tiling结构体，不支持直接使用c++语法定义的结构体类型。</li><li>开发者在host侧设置参数值和使用tiling数据需要使用set_xxx和get_xxx接口（xxx请替换为字段名），具体使用方法见调用示例。</li><li>tiling数据成员需要满足字节对齐要求，即：当前数据成员dataVar位于结构体的偏移offset满足， offset % sizeof(dataVar) == 0。</li><li>tiling结构体是全局属性，需注意应通过结构体名作为全局唯一标记，不同算子若注册同名不同结构tiling结构体则会发生未定义行为。</li></ul> </div> <div class="tiledSection"><h2 id="section75723mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section75723mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-mlh-c106="" class="highlight-div"><div _ngcontent-mlh-c106="" class="highlight-div-header"><div _ngcontent-mlh-c106="" class="highlight-div-header-left"><div _ngcontent-mlh-c106="" class="handle-button expand-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlh-c106="" class="highlight-div-header-right"><div _ngcontent-mlh-c106="" class="handle-button ai-button"></div><div _ngcontent-mlh-c106="" class="handle-button line-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlh-c106="" class="handle-button theme-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlh-c106="" class="handle-button copy-button"><div _ngcontent-mlh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span> </span></li><li> </li><li><span class="hljs-comment">// 定义tilingdata类 </span></li><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(Matmul) </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint16_t</span>, mmVar); </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(<span class="hljs-type">uint16_t</span>, <span class="hljs-number">3</span>, mmArr); </li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-comment">// 注册中间结构体，第一个参数固定为struct_name#Op，第二个参数即struct_name, 如struct_name为Matmul，第一参数为MatmulOp，第二个参数为Matmul </span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MatmulOp, Matmul)      <span class="hljs-comment">// 注册中间结构体 </span></li><li> </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(AddCustomTilingData)        <span class="hljs-comment">// 注册一个tiling类，以tiling的名字作为入参 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, blkDim);        <span class="hljs-comment">// 添加tiling变量类型字段，参与计算核数 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, totalSize);     <span class="hljs-comment">// 添加tiling变量类型字段，总计算数据量 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, splitTile);     <span class="hljs-comment">// 添加tiling变量类型字段，每个core处理的数据分块计算 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(<span class="hljs-type">uint16_t</span>, <span class="hljs-number">3</span>, arrSample);    <span class="hljs-comment">// 添加tiling数组类型字段 </span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_STRUCT</span>(Matmul, mm);             <span class="hljs-comment">// 添加tiling结构体类型字段 </span></li><li>END_TILING_DATA_DEF;                                    <span class="hljs-comment">// 定义结束 </span></li><li><span class="hljs-comment">// 注册算子tilingdata类到对应的AddCustom算子 </span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(AddCustom, AddCustomTilingData)  </li><li>} </li><li> </li><li><span class="hljs-comment">// host侧设置参数值和使用tiling参数 </span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">TilingAddInit</span><span class="hljs-params">(AddCustomTilingData *tiling, <span class="hljs-type">uint32_t</span> blockDim)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>  <span class="hljs-comment">// 设置参数值 </span></li><li>  tiling-&gt;<span class="hljs-built_in">set_blkDim</span>(blockDim);                  <span class="hljs-comment">// 置值通用数据类型变量blockDim </span></li><li>  <span class="hljs-type">uint16_t</span> arr[] = {<span class="hljs-number">10</span>,<span class="hljs-number">2</span>,<span class="hljs-number">8</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,}; </li><li>  tiling-&gt;<span class="hljs-built_in">set_arrSample</span>(arr);                    <span class="hljs-comment">// 置值通用数据类型数组变量arrSample，仅会复制arr数据的前三个数据，与TILING_DATA_FIELD_DEF_ARR中arr_size一致 </span></li><li>  tiling-&gt;mm.<span class="hljs-built_in">set_mmVar</span>(<span class="hljs-number">1</span>);                       <span class="hljs-comment">// 置值嵌套结构体通用数据类型变量mmVar </span></li><li>  tiling-&gt;mm.<span class="hljs-built_in">set_mmArr</span>(arr);                     <span class="hljs-comment">// 置值嵌套结构体通用数据类型数组mmArr </span></li><li>   </li><li>  <span class="hljs-comment">// 使用参数值 </span></li><li>  <span class="hljs-type">uint32_t</span> useBlockDim = tiling-&gt;<span class="hljs-built_in">get_blkDim</span>();    <span class="hljs-comment">// 获取通用数据类型变量blockDim </span></li><li>  <span class="hljs-type">uint32_t</span>* arrPoint = tiling-&gt;<span class="hljs-built_in">get_arrSample</span>();   <span class="hljs-comment">// 获取通用数据类型数组变量arrSample </span></li><li>  useBlockDim = tiling-&gt;mm.<span class="hljs-built_in">get_mmVar</span>();           <span class="hljs-comment">// 获取嵌套结构体通用数据类型变量mmVar </span></li><li>  arrPoint = tiling-&gt;mm.<span class="hljs-built_in">get_mmArr</span>();              <span class="hljs-comment">// 获取嵌套结构体通用数据类型数组mmArr </span></li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>