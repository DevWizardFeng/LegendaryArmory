<h1 _ngcontent-yvg-c119="" class="doc-title ng-star-inserted" title="TilingData结构注册"> TilingData结构注册 </h1>

<div _ngcontent-yvg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section75727mcpsimp">函数功能<i class="anchor-icon anchor-icon-link" anchorid="section75727mcpsimp" tips="复制节点链接"></i></h2><p>注册定义的TilingData结构体并和自定义算子绑定。具体使用说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tilingdata-structure-registration#section75775mcpsimp">调用示例</a>。</p> </div> <div class="tiledSection"><h2 id="section75731mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section75731mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-yvg-c106="" class="highlight-div"><div _ngcontent-yvg-c106="" class="highlight-div-header"><div _ngcontent-yvg-c106="" class="highlight-div-header-left"><div _ngcontent-yvg-c106="" class="handle-button expand-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yvg-c106="" class="highlight-div-header-right"><div _ngcontent-yvg-c106="" class="handle-button ai-button"></div><div _ngcontent-yvg-c106="" class="handle-button line-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yvg-c106="" class="handle-button theme-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yvg-c106="" class="handle-button copy-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yvg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(op_type, class_name)</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> REGISTER_TILING_DATA_CLASS(op_type, class_name) </span></li><li>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">op_type</span>##class_name##Helper { </li><li>  <span class="hljs-keyword">public</span>: </li><li>    op_type##class_name##<span class="hljs-built_in">Helper</span>() { </li><li>      CTilingDataClassFactory::<span class="hljs-built_in">RegisterTilingData</span>(#op_type, op_type##class_name##Helper::CreateTilingDataInstance); </li><li>    } </li><li>    <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;TilingDef&gt; <span class="hljs-title">CreateTilingDataInstance</span><span class="hljs-params">()</span> </span>{ </li><li>      <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;class_name&gt;(); </li><li>    } </li><li>  }; </li><li>  op_type##class_name##Helper g_tilingdata_##op_type##class_name#<span class="hljs-meta">#helper;</span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section75736mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section75736mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.1" valign="top" width="17.169999999999998%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.2" valign="top" width="15.15%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.3" valign="top" width="67.67999999999999%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>op_type</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>注册的算子名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.169999999999998%"><p>class_name</p> </td> <td class="cellrowborder" valign="top" width="15.15%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="67.67999999999999%"><p>tiling结构体名，与c++变量命名要求一致。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section75767mcpsimp">约束说明<i class="anchor-icon anchor-icon-link" anchorid="section75767mcpsimp" tips="复制节点链接"></i></h2><ul><li>使用时需要包含头文件register/tilingdata_base.h。</li><li>中间结构体和定制tilingkey结构体需注意op_type命名规则，具体见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tilingdata-structure-registration#section75775mcpsimp">调用示例</a>。</li><li>算子定制tilingkey结构体需保证必须注册op_type默认结构体。</li><li>tiling结构体是全局属性，需注意应通过结构体名作为全局唯一标记，不同算子若注册同名不同结构tiling结构体则会发生未定义行为。</li></ul> </div> <div class="tiledSection"><h2 id="section75775mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section75775mcpsimp" tips="复制节点链接"></i></h2><ul><li>注册算子Tiling结构体<div _ngcontent-yvg-c106="" class="highlight-div"><div _ngcontent-yvg-c106="" class="highlight-div-header"><div _ngcontent-yvg-c106="" class="highlight-div-header-left"><div _ngcontent-yvg-c106="" class="handle-button expand-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yvg-c106="" class="highlight-div-header-right"><div _ngcontent-yvg-c106="" class="handle-button ai-button"></div><div _ngcontent-yvg-c106="" class="handle-button line-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yvg-c106="" class="handle-button theme-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yvg-c106="" class="handle-button copy-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yvg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 定义tilingdata类</span></li><li><span class="hljs-keyword">namespace</span> optiling {</li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(AddCustomTilingData)    <span class="hljs-comment">// 注册一个tiling的类，以tiling的名字作为入参</span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, blkDim);    <span class="hljs-comment">// 添加tiling字段，参与计算核数</span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, totalSize); <span class="hljs-comment">// 添加tiling字段，总计算数据量-输入shape大小</span></li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, splitTile); <span class="hljs-comment">// 添加tiling字段，每个core处理的数据分块计算</span></li><li>END_TILING_DATA_DEF;                          <span class="hljs-comment">// 定义结束</span></li><li><span class="hljs-comment">// 注册算子tilingdata类到对应的AddCustom算子</span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(AddCustom, AddCustomTilingData) </li><li>}</li></ol></pre></div></div> </li><li>注册中间结构体。当开发者有结构体嵌套场景时，嵌套的结构体称为中间结构体。因为一个算子名只能注册一个Tiling结构体，为使得框架能够检测中间结构体信息，需要构造"虚拟算子名"（结构体名+Op）并通过REGISTER_TILING_DATA_CLASS接口注册中间结构体，注册方式如下。<div _ngcontent-yvg-c106="" class="highlight-div"><div _ngcontent-yvg-c106="" class="highlight-div-header"><div _ngcontent-yvg-c106="" class="highlight-div-header-left"><div _ngcontent-yvg-c106="" class="handle-button expand-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yvg-c106="" class="highlight-div-header-right"><div _ngcontent-yvg-c106="" class="handle-button ai-button"></div><div _ngcontent-yvg-c106="" class="handle-button line-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yvg-c106="" class="handle-button theme-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yvg-c106="" class="handle-button copy-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yvg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(Matmul)</li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint16_t</span>, mmVar);</li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(<span class="hljs-type">uint16_t</span>, <span class="hljs-number">3</span>, mmArr);</li><li>END_TILING_DATA_DEF;</li><li><span class="hljs-comment">// 注册中间结构体，第一个参数固定为struct_name#Op，第二个参数即struct_name, 如struct_name为Matmul，第一参数为MatmulOp，第二个参数为Matmul</span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(MatmulOp, Matmul)      <span class="hljs-comment">// 注册中间结构体</span></li></ol></pre></div></div> </li><li>定制tiling_key注册不同Tiling结构体<div _ngcontent-yvg-c106="" class="highlight-div"><div _ngcontent-yvg-c106="" class="highlight-div-header"><div _ngcontent-yvg-c106="" class="highlight-div-header-left"><div _ngcontent-yvg-c106="" class="handle-button expand-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yvg-c106="" class="highlight-div-header-right"><div _ngcontent-yvg-c106="" class="handle-button ai-button"></div><div _ngcontent-yvg-c106="" class="handle-button line-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yvg-c106="" class="handle-button theme-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yvg-c106="" class="handle-button copy-button"><div _ngcontent-yvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yvg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*REGISTER_TILING_DATA_CLASS中第一个参数为${op_type} + ‘_’ + tiling_key。若tiling_key未注册匹配的tiling结构体，则会使用默认的结构体。如下面两种方式，tiling_key不指定或者非1情况，tiling结构体为AddStruct；tiling_key等于1的时候，tiling结构体为AddStructSample1*/</span></li><li>
</li><li><span class="hljs-comment">// 以op_type为Add为例，默认tiling结构体注册如下</span></li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(AddStruct)   </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint16_t</span>, mmVar);   </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(<span class="hljs-type">uint16_t</span>, <span class="hljs-number">3</span>, mmArr); </li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(Add, AddStruct) </li><li>
</li><li><span class="hljs-comment">// TilingKey等于1时注册结构体如下</span></li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(AddStructSample1) </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint16_t</span>, mmVar);   </li><li>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF_ARR</span>(<span class="hljs-type">uint16_t</span>, <span class="hljs-number">3</span>, mmArr); </li><li>END_TILING_DATA_DEF; </li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(Add_1, AddStructSample1) </li></ol></pre></div></div> </li></ul> </div> </div> <div></div></div>