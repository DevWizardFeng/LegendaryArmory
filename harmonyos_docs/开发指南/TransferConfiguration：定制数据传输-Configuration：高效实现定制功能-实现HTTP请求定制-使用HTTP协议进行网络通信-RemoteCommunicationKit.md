<h1 _ngcontent-gut-c119="" class="doc-title ng-star-inserted" title="TransferConfiguration：定制数据传输"> TransferConfiguration：定制数据传输 </h1>

<div _ngcontent-gut-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1521171451910">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1521171451910" tips="复制节点链接"></i></h2><p>在远场通信框架中，开发者们利用 TransferConfiguration，可以对 HTTP请求期间的数据传输行为进行精细化管理和定制化调整。TransferConfiguration提供了自动重定向策略、超时时间设定等关键功能的配置选项。通过理解和灵活运用这些属性，开发者可以根据项目需求，实现数据传输策略的个性化定制，从而获得更高效、更可靠的数据传输体验。</p> </div> <div class="tiledSection"><h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2><p>定制数据传输能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p> </div> <div class="tiledSection"><h2 id="section737143881912">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section737143881912" tips="复制节点链接"></i></h2><p>下面会介绍超时重试场景下TransferConfiguration如何去使用。</p> </div> <div class="tiledSection"><h3 id="section8215124510231" class="firsth2">超时重试<i class="anchor-icon anchor-icon-link" anchorid="section8215124510231" tips="复制节点链接"></i></h3><ol><li><span>导入需要的模块。</span><p></p><div _ngcontent-gut-c106="" class="highlight-div"><div _ngcontent-gut-c106="" class="highlight-div-header"><div _ngcontent-gut-c106="" class="highlight-div-header-left"><div _ngcontent-gut-c106="" class="handle-button expand-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gut-c106="" class="highlight-div-header-right"><div _ngcontent-gut-c106="" class="handle-button ai-button"></div><div _ngcontent-gut-c106="" class="handle-button line-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gut-c106="" class="handle-button theme-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gut-c106="" class="handle-button copy-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gut-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>定义会话配置，创建会话，以及定义日志函数。</span><p></p><div _ngcontent-gut-c106="" class="highlight-div"><div _ngcontent-gut-c106="" class="highlight-div-header"><div _ngcontent-gut-c106="" class="highlight-div-header-left"><div _ngcontent-gut-c106="" class="handle-button expand-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gut-c106="" class="highlight-div-header-right"><div _ngcontent-gut-c106="" class="handle-button ai-button"></div><div _ngcontent-gut-c106="" class="handle-button line-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gut-c106="" class="handle-button theme-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gut-c106="" class="handle-button copy-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gut-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义日志函数</span></li><li><span class="hljs-keyword">const</span> logI = <span class="hljs-variable language_">console</span>.<span class="hljs-property">info</span></li><li><span class="hljs-keyword">const</span> logE = <span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span></li><li>
</li><li><span class="hljs-comment">// 定义会话配置</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">sessionConfig</span>: rcp.<span class="hljs-property">SessionConfiguration</span> = {</li><li>  <span class="hljs-attr">requestConfiguration</span>: {</li><li>    <span class="hljs-attr">transfer</span>: {</li><li>      <span class="hljs-attr">timeout</span>: {</li><li>        <span class="hljs-attr">connectMs</span>: <span class="hljs-number">3000</span>,</li><li>        <span class="hljs-attr">transferMs</span>: <span class="hljs-number">6000</span></li><li>      }</li><li>    }</li><li>  }</li><li>};</li><li>
</li><li><span class="hljs-comment">// 创建会话</span></li><li><span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>(sessionConfig);</li></ol></pre></div></div> <p></p></li><li><span>定义异步函数，利用递归实现重试，如果请求失败，会在指定的重试次数内进行重试，在最后一次重试时，会等待3秒后再发送请求（根据实际情况进行调整）。</span><p></p><div _ngcontent-gut-c106="" class="highlight-div"><div _ngcontent-gut-c106="" class="highlight-div-header"><div _ngcontent-gut-c106="" class="highlight-div-header-left"><div _ngcontent-gut-c106="" class="handle-button expand-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gut-c106="" class="highlight-div-header-right"><div _ngcontent-gut-c106="" class="handle-button ai-button"></div><div _ngcontent-gut-c106="" class="handle-button line-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gut-c106="" class="handle-button theme-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gut-c106="" class="handle-button copy-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gut-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">retryRequest</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, retryCount: <span class="hljs-built_in">number</span>, attempt: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;rcp.<span class="hljs-property">Response</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 在最后一次重试时，等待一段时间后再发送请求</span></li><li>    <span class="hljs-keyword">const</span> delay = attempt === retryCount - <span class="hljs-number">1</span> ? <span class="hljs-number">3000</span> : <span class="hljs-number">0</span>; <span class="hljs-comment">// 如果是最后一次重试，延迟3秒，否则不延迟</span></li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      session.<span class="hljs-title function_">get</span>(url)</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (response.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) { </li><li>            <span class="hljs-title function_">logI</span>(<span class="hljs-string">`Request successful on attempt <span class="hljs-subst">${attempt}</span>.`</span>); <span class="hljs-comment">// 记录请求成功信息</span></li><li>            <span class="hljs-title function_">resolve</span>(response); <span class="hljs-comment">// 请求成功，Promise resolve</span></li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title function_">logE</span>(<span class="hljs-string">`Request failed on attempt <span class="hljs-subst">${attempt}</span>, statusCode: <span class="hljs-subst">${response.statusCode}</span>`</span>); <span class="hljs-comment">// 记录请求失败信息</span></li><li>            <span class="hljs-keyword">if</span> (attempt &lt; retryCount) { <span class="hljs-comment">// 如果还未达到重试次数</span></li><li>              <span class="hljs-title function_">retryRequest</span>(url, retryCount, attempt + <span class="hljs-number">1</span>); <span class="hljs-comment">// 进行下一次重试</span></li><li>            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 如果已经达到重试次数</span></li><li>              <span class="hljs-title function_">logE</span>(<span class="hljs-string">`All retries failed.`</span>); <span class="hljs-comment">// 记录所有重试失败信息</span></li><li>              <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'All retries failed'</span>)); <span class="hljs-comment">// 所有重试失败，Promise reject</span></li><li>            }</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> { <span class="hljs-comment">// 请求的catch块，处理请求过程中抛出的错误</span></li><li>          <span class="hljs-title function_">logE</span>(<span class="hljs-string">`Request error on attempt <span class="hljs-subst">${attempt}</span>, error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>); <span class="hljs-comment">// 记录请求错误信息</span></li><li>          <span class="hljs-keyword">if</span> (attempt &lt; retryCount) { <span class="hljs-comment">// 如果还未达到重试次数</span></li><li>            <span class="hljs-title function_">retryRequest</span>(url, retryCount, attempt + <span class="hljs-number">1</span>); <span class="hljs-comment">// 进行下一次重试</span></li><li>          } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 如果已经达到重试次数</span></li><li>            <span class="hljs-title function_">logE</span>(<span class="hljs-string">`All retries failed.`</span>); <span class="hljs-comment">// 记录所有重试失败信息</span></li><li>            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'All retries failed'</span>)); <span class="hljs-comment">// 所有重试失败，Promise reject</span></li><li>          }</li><li>        });</li><li>    }, delay); <span class="hljs-comment">// 延迟指定时间后再发送请求</span></li><li>  });</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用retryRequest方法，实现网络请求的重试逻辑。</span><p></p><div _ngcontent-gut-c106="" class="highlight-div"><div _ngcontent-gut-c106="" class="highlight-div-header"><div _ngcontent-gut-c106="" class="highlight-div-header-left"><div _ngcontent-gut-c106="" class="handle-button expand-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gut-c106="" class="highlight-div-header-right"><div _ngcontent-gut-c106="" class="handle-button ai-button"></div><div _ngcontent-gut-c106="" class="handle-button line-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gut-c106="" class="handle-button theme-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gut-c106="" class="handle-button copy-button"><div _ngcontent-gut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gut-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义URL</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">URL</span> = <span class="hljs-string">'https://www.example.com'</span></li><li>
</li><li><span class="hljs-comment">// 定义重试次数，值为3</span></li><li><span class="hljs-keyword">const</span> retryCount = <span class="hljs-number">3</span></li><li><span class="hljs-comment">// 定义当前尝试次数，初始值为1</span></li><li><span class="hljs-keyword">const</span> attempt = <span class="hljs-number">1</span></li><li>
</li><li><span class="hljs-comment">// 调用retryRequest函数进行网络请求，参数为URL、重试次数和当前尝试次数,将返回的结果存储在response变量中</span></li><li><span class="hljs-keyword">const</span> response = <span class="hljs-title function_">retryRequest</span>(<span class="hljs-variable constant_">URL</span>, retryCount, attempt);</li><li><span class="hljs-comment">// 使用then方法处理response的成功返回情况</span></li><li>response.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 如果返回的状态码不是200，表示请求未成功</span></li><li>  <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">statusCode</span> != <span class="hljs-number">200</span>) {</li><li>    <span class="hljs-comment">// 打印日志，表示超时重试失败</span></li><li>    <span class="hljs-title function_">logI</span>(<span class="hljs-string">`Timeout retry failed`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 打印日志，如果返回的状态码是200，表示请求成功</span></li><li>  <span class="hljs-title function_">logI</span>(<span class="hljs-string">`Timeout retry succeeded, print result: <span class="hljs-subst">${res}</span>`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 打印日志，表示响应出错，并打印错误信息</span></li><li>  <span class="hljs-title function_">logE</span>(<span class="hljs-string">`Response error, the error message is: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>})</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>