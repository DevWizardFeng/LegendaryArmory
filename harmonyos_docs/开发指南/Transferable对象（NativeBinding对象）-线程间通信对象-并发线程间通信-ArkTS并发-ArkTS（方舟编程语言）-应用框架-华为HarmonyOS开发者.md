<h1 _ngcontent-vqs-c119="" class="doc-title ng-star-inserted" title="Transferable对象（NativeBinding对象）"> Transferable对象（NativeBinding对象） </h1>

<div _ngcontent-vqs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Transferable对象，也称为NativeBinding对象，是指绑定C++对象的JS对象，其主要功能由C++提供，JS对象壳则分配在虚拟机的本地堆（LocalHeap）中。跨线程传输时复用同一个C++对象，相比JS对象的拷贝模式，传输效率更高。因此，可共享或转移的NativeBinding对象被称为Transferable对象。开发者可以自定义Transferable对象，详细示例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-coerce-to-native-binding-object">自定义Native Transferable对象的多线程操作场景</a>。</p>    <div class="tiledSection">     <h2 id="共享模式">共享模式<i class="anchor-icon anchor-icon-link" anchorid="共享模式" tips="复制节点链接"></i></h2>          <p>如果C++实现能够确保线程安全性，则NativeBinding对象的C++部分支持跨线程共享。NativeBinding对象跨线程传输后，只需重新创建JS壳即可桥接到同一个C++对象上，实现C++对象的共享。通信过程如下图所示：</p>     <p><span><img originheight="763" originwidth="1199" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114937.04378026502117613528761194762404:50001231000000:2800:7AA91DA1B27A856807EE50C93DFBDB29DE52A9A15BDBE848D354E5742539B20A.png" width="920" height="585.4545454545455"></span></p>     <p>常见的共享模式NativeBinding对象包括：应用上下文（ApplicationContext）、窗口上下文（WindowContext）、组件上下文（AbilityContext或ComponentContext）等Context类型对象。这些上下文对象封装了应用程序组件的上下文信息，提供了访问系统服务和资源的能力，使得应用程序组件可以与系统进行交互。获取Context信息的方法可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage">获取上下文信息</a>。</p>     <p>示例可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/batch-database-operations-guide#使用taskpool进行频繁数据库操作">使用TaskPool进行频繁数据库操作</a>。</p>    </div>    <div class="tiledSection">     <h2 id="转移模式">转移模式<i class="anchor-icon anchor-icon-link" anchorid="转移模式" tips="复制节点链接"></i></h2>          <p>如果C++实现包含数据且无法保证线程安全性，则NativeBinding对象的C++部分需要采用转移方式传输。NativeBinding对象跨线程传输后，重新创建JS壳可桥接到C++对象上，但需移除原JS壳与C++对象的绑定关系。通信过程如下图所示：</p>     <p><span><img originheight="818" originwidth="1199" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114937.28339240757515161275495112348089:50001231000000:2800:73C283F4756654222819F70E859929E7E9A669FD8339374C0E1B092A1E2543E7.png" width="920" height="627.6563803169308"></span></p>     <p>常见的转移模式NativeBinding对象包括<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#imagecreatepixelmap8" target="_blank">PixelMap对象</a>，它可以读取或写入图像数据，获取图像信息，常用于显示图片。</p>     <p>这里提供了一个跨线程传递PixelMap对象的示例。首先从rawfile文件夹中获取图片资源，然后在子线程中创建PixelMap对象并传递给主线程，具体实现如下：</p>     <div _ngcontent-vqs-c106="" class="highlight-div"><div _ngcontent-vqs-c106="" class="highlight-div-header"><div _ngcontent-vqs-c106="" class="highlight-div-header-left"><div _ngcontent-vqs-c106="" class="handle-button expand-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqs-c106="" class="highlight-div-header-right"><div _ngcontent-vqs-c106="" class="handle-button ai-button"></div><div _ngcontent-vqs-c106="" class="handle-button line-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqs-c106="" class="handle-button theme-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqs-c106="" class="handle-button copy-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { loadPixelMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'./PixelMapTest'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">pixelMap</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">loadImageFromThread</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> context : <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>    <span class="hljs-keyword">const</span> resourceMgr = context.<span class="hljs-property">resourceManager</span>;</li><li>    <span class="hljs-comment">// 此处‘startIcon.png’为media下复制到rawfile文件夹中，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>    resourceMgr.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'startIcon.png'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">rawFileDescriptor</span> =&gt;</span> {</li><li>      taskpool.<span class="hljs-title function_">execute</span>(loadPixelMap, rawFileDescriptor).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">pixelMap</span> =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (pixelMap) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = pixelMap <span class="hljs-keyword">as</span> <span class="hljs-title class_">PixelMap</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in creating pixelMap.'</span>);</li><li>          <span class="hljs-comment">// 主线程释放pixelMap。由于子线程返回pixelMap时已调用setTransferDetached，所以此处能够立即释放pixelMap。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>.<span class="hljs-title function_">release</span>();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to create pixelMap.'</span>);</li><li>        }</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'taskpool execute loadPixelMap failed. Code: '</span> + e.<span class="hljs-property">code</span> + <span class="hljs-string">', message: '</span> + e.<span class="hljs-property">message</span>);</li><li>      });</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImageFromThread</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-vqs-c106="" class="highlight-div"><div _ngcontent-vqs-c106="" class="highlight-div-header"><div _ngcontent-vqs-c106="" class="highlight-div-header-left"><div _ngcontent-vqs-c106="" class="handle-button expand-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqs-c106="" class="highlight-div-header-right"><div _ngcontent-vqs-c106="" class="handle-button ai-button"></div><div _ngcontent-vqs-c106="" class="handle-button line-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqs-c106="" class="handle-button theme-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqs-c106="" class="handle-button copy-button"><div _ngcontent-vqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PixelMapTest.ets</span></li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPixelMap</span>(<span class="hljs-params">rawFileDescriptor: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PixelMap</span>&gt; {</li><li>  <span class="hljs-comment">// 创建imageSource。</span></li><li>  <span class="hljs-keyword">const</span> imageSource = image.<span class="hljs-title function_">createImageSource</span>(rawFileDescriptor);</li><li>  <span class="hljs-comment">// 创建pixelMap。</span></li><li>  <span class="hljs-keyword">const</span> pixelMap = imageSource.<span class="hljs-title function_">createPixelMapSync</span>();</li><li>  <span class="hljs-comment">// 释放imageSource。</span></li><li>  imageSource.<span class="hljs-title function_">release</span>();</li><li>  <span class="hljs-comment">// 使pixelMap在跨线程传输完成后，断开原线程的引用。</span></li><li>  pixelMap.<span class="hljs-title function_">setTransferDetached</span>(<span class="hljs-literal">true</span>);</li><li>  <span class="hljs-comment">// 返回pixelMap给主线程。</span></li><li>  <span class="hljs-keyword">return</span> pixelMap;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>