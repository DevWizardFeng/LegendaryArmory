<h1 _ngcontent-lrr-c119="" class="doc-title ng-star-inserted" title="Transpose"> Transpose </h1>

<div _ngcontent-lrr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section128417364277">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section128417364277" tips="复制节点链接"></i></h2><ul><li>可实现16*16的二维矩阵数据块的转置。</li><li>可实现[N, C, H, W]与[N, H, W, C]互相转换。</li></ul> </div> <div class="tiledSection"><h2 id="section48533692711">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section48533692711" tips="复制节点链接"></i></h2><ul><li>普通转置，支持16*16的二维矩阵数据块进行转置<div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Transpose</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; dstLocal, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; srcLocal)</span></span></li></ol></pre></div></div> </li><li>增强转置，支持16*16的二维矩阵数据块转置，支持[N, C, H, W]与[N, H, W, C]互相转换<div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Transpose</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T&gt; &amp;dstLocal, <span class="hljs-type">const</span> LocalTensor&lt;T&gt; &amp;srcLocal, <span class="hljs-type">const</span> LocalTensor&lt;<span class="hljs-type">uint8_t</span>&gt; &amp;sharedTmpBuffer, <span class="hljs-type">const</span> TransposeParamsExt &amp;transposeParams)</span></span></li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section208773692710">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section208773692710" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>模板参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.3.1.1" valign="top" width="27.87%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.3.1.2" valign="top" width="72.13000000000001%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="27.87%"><p>T</p> </td> <td class="cellrowborder" valign="top" width="72.13000000000001%"><p>操作数的数据类型。</p> <p><strong>普通转置接口:</strong></p> <p>Kirin9020系列处理器，支持的数据类型为：half/int16/uint16</p> <p>KirinX90系列处理器，支持的数据类型为：half/int16/uint16</p> <p><strong>增强转置接口:</strong></p> <p>参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-transpose#zh-cn_topic_0000002141076013_table5148113610277">表4</a>。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>接口参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.1" valign="top" width="14.29%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.2" valign="top" width="8.16%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.4.1.3" valign="top" width="77.55%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="14.29%"><p>dstLocal</p> </td> <td class="cellrowborder" valign="top" width="8.16%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="77.55%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.29%"><p>srcLocal</p> </td> <td class="cellrowborder" valign="top" width="8.16%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="77.55%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> <p>数据类型需要与dstLocal保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.29%"><p>sharedTmpBuffer</p> </td> <td class="cellrowborder" valign="top" width="8.16%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="77.55%"><p>共享的临时Buffer Tensor，sharedTmpBuffer的大小参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-transpose#zh-cn_topic_0000002141076013_table8152536182716">表5</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.29%"><p>transposeParams</p> </td> <td class="cellrowborder" valign="top" width="8.16%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="77.55%"><p>控制Transpose的数据结构。结构体内包含：输入的shape信息和transposeType参数。该数据结构的定义请参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-transpose#zh-cn_topic_0000002141076013_table214114361277">表3</a>。</p> <div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">VtransposeParams</span> { </li><li>     <span class="hljs-type">uint16_t</span> nSize; </li><li>     <span class="hljs-type">uint16_t</span> cSize; </li><li>     <span class="hljs-type">uint16_t</span> hSize; </li><li>     <span class="hljs-type">uint16_t</span> wSize; </li><li>     TransposeType transposeType; </li><li> };</li></ol></pre></div></div> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table id="zh-cn_topic_0000002141076013_table214114361277" class="layoutFixed idpTab"><caption><b>表3 </b>VtransposeParams结构体内参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.4.2.3.1.1" valign="top" width="12.120000000000001%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.4.2.3.1.2" valign="top" width="87.88%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>nSize</p> </td> <td class="cellrowborder" valign="top" width="87.88%"><p>n轴长度，取值范围：m∈[0, 65535]。默认值为0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>cSize</p> </td> <td class="cellrowborder" valign="top" width="87.88%"><p>c轴长度，取值范围：m∈[0, 65535]。默认值为0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>hSize</p> </td> <td class="cellrowborder" valign="top" width="87.88%"><p>h轴长度，取值范围：m∈[0, 65535]。默认值为0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>wSize</p> </td> <td class="cellrowborder" valign="top" width="87.88%"><p>w轴长度，取值范围：m∈[0, 65535]。默认值为0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.120000000000001%"><p>transposeType</p> </td> <td class="cellrowborder" valign="top" width="87.88%"><p>数据排布及reshape的类型，类型为TransposeType枚举类。</p> <div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">TransposeType</span> : <span class="hljs-type">uint8_t</span> { </li><li>     TRANSPOSE_TYPE_NONE,           <span class="hljs-comment">// default value </span></li><li>     TRANSPOSE_NZ2ND_0213,          <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_NZ2NZ_0213,          <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_NZ2NZ_012_WITH_N,    <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_NZ2ND_012_WITH_N,    <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_NZ2ND_012_WITHOUT_N, <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_NZ2NZ_012_WITHOUT_N, <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_ND2ND_ONLY,          <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_ND_UB_GM,            <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_GRAD_ND_UB_GM,       <span class="hljs-comment">// 当前不支持 </span></li><li>     TRANSPOSE_ND2ND_B16,           <span class="hljs-comment">// [16,16]二维矩阵转置 </span></li><li>     TRANSPOSE_NCHW2NHWC,           <span class="hljs-comment">// [N,C,H,W]-&gt;[N,H,W,C]， </span></li><li>     TRANSPOSE_NHWC2NCHW            <span class="hljs-comment">// [N,H,W,C]-&gt;[N,C,H,W] </span></li><li> };</li></ol></pre></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>当transposeType为TRANSPOSE_ND2ND_B16时，hSize和wSize必须传入16，nSize和cSize传入无效。</p> </div></div></div> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table id="zh-cn_topic_0000002141076013_table5148113610277" class="layoutFixed idpTab"><caption><b>表4 </b>增强转置接口支持的数据类型</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.5.2.3.1.1" valign="top" width="21.21%"><p>transposeType</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.5.2.3.1.2" valign="top" width="78.79%"><p>支持的数据类型</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_ND2ND_B16</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果要实现int16_t/half类型，shape为[16, 16]二维矩阵的转置，可使用普通转置接口。</p> </div></div></div> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_NCHW2NHWC</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_NHWC2NCHW</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table id="zh-cn_topic_0000002141076013_table8152536182716" class="layoutFixed idpTab"><caption><b>表5 </b>增强转置接口sharedTmpBuffer所需的大小</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.6.2.3.1.1" valign="top" width="21.21%"><p>transposeType</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.6.2.3.1.2" valign="top" width="78.79%"><p>支持的数据类型</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_ND2ND_B16</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_NCHW2NHWC</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.21%"><p>TRANSPOSE_NHWC2NCHW</p> </td> <td class="cellrowborder" valign="top" width="78.79%"><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section2012643611271">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section2012643611271" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> <div class="tiledSection"><h2 id="section0126123672714">注意事项<i class="anchor-icon anchor-icon-link" anchorid="section0126123672714" tips="复制节点链接"></i></h2><ul><li>操作数地址偏移对齐要求请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-general-constraints">通用约束</a>。</li><li>该指令不可迭代（即不能通过repeatTimes重复）。</li><li>[N, C, H, W]与[N, H, W, C]互相转换，H * W需要32B对齐。</li><li>普通转置接口支持srcLocal和dstLocal复用。</li><li>增强转置接口，transposeType为TRANSPOSE_ND2ND_B16时支持srcLocal和dstLocal复用，transposeType为TRANSPOSE_NCHW2NHWC、TRANSPOSE_NHWC2NCHW时不支持srcLocal和dstLocal复用。</li></ul> </div> <div class="tiledSection"><h2 id="section171281936112712">返回值<i class="anchor-icon anchor-icon-link" anchorid="section171281936112712" tips="复制节点链接"></i></h2><p>无</p> </div> <div class="tiledSection"><h2 id="section912883613273">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section912883613273" tips="复制节点链接"></i></h2><ul><li>普通接口调用示例，该示例对[16, 16]的half类型矩阵进行转置。<div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li>  </li><li> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelTranspose</span> { </li><li> <span class="hljs-keyword">public</span>: </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelTranspose</span><span class="hljs-params">()</span> </span>{} </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* src, __gm__ <span class="hljs-type">uint8_t</span>* dstGm)</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         srcGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)src); </li><li>         dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)dstGm); </li><li>  </li><li>         pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueSrc, <span class="hljs-number">1</span>, srcDataSize * <span class="hljs-built_in">sizeof</span>(half)); </li><li>         pipe.<span class="hljs-built_in">InitBuffer</span>(outQueueDst, <span class="hljs-number">1</span>, dstDataSize * <span class="hljs-built_in">sizeof</span>(half)); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         <span class="hljs-built_in">CopyIn</span>(); </li><li>         <span class="hljs-built_in">Compute</span>(); </li><li>         <span class="hljs-built_in">CopyOut</span>(); </li><li>     } </li><li> <span class="hljs-keyword">private</span>: </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;half&gt; srcLocal = inQueueSrc.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>         AscendC::<span class="hljs-built_in">DataCopy</span>(srcLocal, srcGlobal, srcDataSize); </li><li>         inQueueSrc.<span class="hljs-built_in">EnQue</span>(srcLocal); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;half&gt; srcLocal = inQueueSrc.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>         AscendC::LocalTensor&lt;half&gt; dstLocal = outQueueDst.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>  </li><li>         AscendC::<span class="hljs-built_in">Transpose</span>&lt;half&gt;(dstLocal, srcLocal); </li><li>  </li><li>         outQueueDst.<span class="hljs-built_in">EnQue</span>&lt;half&gt;(dstLocal); </li><li>         inQueueSrc.<span class="hljs-built_in">FreeTensor</span>(srcLocal); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;half&gt; dstLocal = outQueueDst.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>         AscendC::<span class="hljs-built_in">DataCopy</span>(dstGlobal, dstLocal, dstDataSize); </li><li>         outQueueDst.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>     } </li><li> <span class="hljs-keyword">private</span>: </li><li>     AscendC::TPipe pipe; </li><li>     AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; inQueueSrc; </li><li>     AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; outQueueDst; </li><li>  </li><li>     AscendC::GlobalTensor&lt;half&gt; srcGlobal, dstGlobal; </li><li>     <span class="hljs-type">int</span> srcDataSize = <span class="hljs-number">256</span>; </li><li>     <span class="hljs-type">int</span> dstDataSize = <span class="hljs-number">256</span>; </li><li> }; </li><li>  </li><li> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">transpose_kernel</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* src, __gm__ <span class="hljs-type">uint8_t</span>* dstGm)</span> </span></li><li><span class="hljs-function"> </span>{ </li><li>     KernelTranspose op; </li><li>     op.<span class="hljs-built_in">Init</span>(src, dstGm); </li><li>     op.<span class="hljs-built_in">Process</span>(); </li><li> }</li><li>输入数据(src_gm): </li><li> [[  <span class="hljs-number">0.</span>   <span class="hljs-number">1.</span>   <span class="hljs-number">2.</span>   <span class="hljs-number">3.</span>   <span class="hljs-number">4.</span>   <span class="hljs-number">5.</span>   <span class="hljs-number">6.</span>   <span class="hljs-number">7.</span>   <span class="hljs-number">8.</span>   <span class="hljs-number">9.</span>  <span class="hljs-number">10.</span>  <span class="hljs-number">11.</span>  <span class="hljs-number">12.</span>  <span class="hljs-number">13.</span> </li><li>    <span class="hljs-number">14.</span>  <span class="hljs-number">15.</span>] </li><li>  [ <span class="hljs-number">16.</span>  <span class="hljs-number">17.</span>  <span class="hljs-number">18.</span>  <span class="hljs-number">19.</span>  <span class="hljs-number">20.</span>  <span class="hljs-number">21.</span>  <span class="hljs-number">22.</span>  <span class="hljs-number">23.</span>  <span class="hljs-number">24.</span>  <span class="hljs-number">25.</span>  <span class="hljs-number">26.</span>  <span class="hljs-number">27.</span>  <span class="hljs-number">28.</span>  <span class="hljs-number">29.</span> </li><li>    <span class="hljs-number">30.</span>  <span class="hljs-number">31.</span>] </li><li>  [ <span class="hljs-number">32.</span>  <span class="hljs-number">33.</span>  <span class="hljs-number">34.</span>  <span class="hljs-number">35.</span>  <span class="hljs-number">36.</span>  <span class="hljs-number">37.</span>  <span class="hljs-number">38.</span>  <span class="hljs-number">39.</span>  <span class="hljs-number">40.</span>  <span class="hljs-number">41.</span>  <span class="hljs-number">42.</span>  <span class="hljs-number">43.</span>  <span class="hljs-number">44.</span>  <span class="hljs-number">45.</span> </li><li>    <span class="hljs-number">46.</span>  <span class="hljs-number">47.</span>] </li><li>  [ <span class="hljs-number">48.</span>  <span class="hljs-number">49.</span>  <span class="hljs-number">50.</span>  <span class="hljs-number">51.</span>  <span class="hljs-number">52.</span>  <span class="hljs-number">53.</span>  <span class="hljs-number">54.</span>  <span class="hljs-number">55.</span>  <span class="hljs-number">56.</span>  <span class="hljs-number">57.</span>  <span class="hljs-number">58.</span>  <span class="hljs-number">59.</span>  <span class="hljs-number">60.</span>  <span class="hljs-number">61.</span> </li><li>    <span class="hljs-number">62.</span>  <span class="hljs-number">63.</span>] </li><li>  [ <span class="hljs-number">64.</span>  <span class="hljs-number">65.</span>  <span class="hljs-number">66.</span>  <span class="hljs-number">67.</span>  <span class="hljs-number">68.</span>  <span class="hljs-number">69.</span>  <span class="hljs-number">70.</span>  <span class="hljs-number">71.</span>  <span class="hljs-number">72.</span>  <span class="hljs-number">73.</span>  <span class="hljs-number">74.</span>  <span class="hljs-number">75.</span>  <span class="hljs-number">76.</span>  <span class="hljs-number">77.</span> </li><li>    <span class="hljs-number">78.</span>  <span class="hljs-number">79.</span>] </li><li>  [ <span class="hljs-number">80.</span>  <span class="hljs-number">81.</span>  <span class="hljs-number">82.</span>  <span class="hljs-number">83.</span>  <span class="hljs-number">84.</span>  <span class="hljs-number">85.</span>  <span class="hljs-number">86.</span>  <span class="hljs-number">87.</span>  <span class="hljs-number">88.</span>  <span class="hljs-number">89.</span>  <span class="hljs-number">90.</span>  <span class="hljs-number">91.</span>  <span class="hljs-number">92.</span>  <span class="hljs-number">93.</span> </li><li>    <span class="hljs-number">94.</span>  <span class="hljs-number">95.</span>] </li><li>  [ <span class="hljs-number">96.</span>  <span class="hljs-number">97.</span>  <span class="hljs-number">98.</span>  <span class="hljs-number">99.</span> <span class="hljs-number">100.</span> <span class="hljs-number">101.</span> <span class="hljs-number">102.</span> <span class="hljs-number">103.</span> <span class="hljs-number">104.</span> <span class="hljs-number">105.</span> <span class="hljs-number">106.</span> <span class="hljs-number">107.</span> <span class="hljs-number">108.</span> <span class="hljs-number">109.</span> </li><li>   <span class="hljs-number">110.</span> <span class="hljs-number">111.</span>] </li><li>  [<span class="hljs-number">112.</span> <span class="hljs-number">113.</span> <span class="hljs-number">114.</span> <span class="hljs-number">115.</span> <span class="hljs-number">116.</span> <span class="hljs-number">117.</span> <span class="hljs-number">118.</span> <span class="hljs-number">119.</span> <span class="hljs-number">120.</span> <span class="hljs-number">121.</span> <span class="hljs-number">122.</span> <span class="hljs-number">123.</span> <span class="hljs-number">124.</span> <span class="hljs-number">125.</span> </li><li>   <span class="hljs-number">126.</span> <span class="hljs-number">127.</span>] </li><li>  [<span class="hljs-number">128.</span> <span class="hljs-number">129.</span> <span class="hljs-number">130.</span> <span class="hljs-number">131.</span> <span class="hljs-number">132.</span> <span class="hljs-number">133.</span> <span class="hljs-number">134.</span> <span class="hljs-number">135.</span> <span class="hljs-number">136.</span> <span class="hljs-number">137.</span> <span class="hljs-number">138.</span> <span class="hljs-number">139.</span> <span class="hljs-number">140.</span> <span class="hljs-number">141.</span> </li><li>   <span class="hljs-number">142.</span> <span class="hljs-number">143.</span>] </li><li>  [<span class="hljs-number">144.</span> <span class="hljs-number">145.</span> <span class="hljs-number">146.</span> <span class="hljs-number">147.</span> <span class="hljs-number">148.</span> <span class="hljs-number">149.</span> <span class="hljs-number">150.</span> <span class="hljs-number">151.</span> <span class="hljs-number">152.</span> <span class="hljs-number">153.</span> <span class="hljs-number">154.</span> <span class="hljs-number">155.</span> <span class="hljs-number">156.</span> <span class="hljs-number">157.</span> </li><li>   <span class="hljs-number">158.</span> <span class="hljs-number">159.</span>] </li><li>  [<span class="hljs-number">160.</span> <span class="hljs-number">161.</span> <span class="hljs-number">162.</span> <span class="hljs-number">163.</span> <span class="hljs-number">164.</span> <span class="hljs-number">165.</span> <span class="hljs-number">166.</span> <span class="hljs-number">167.</span> <span class="hljs-number">168.</span> <span class="hljs-number">169.</span> <span class="hljs-number">170.</span> <span class="hljs-number">171.</span> <span class="hljs-number">172.</span> <span class="hljs-number">173.</span> </li><li>   <span class="hljs-number">174.</span> <span class="hljs-number">175.</span>] </li><li>  [<span class="hljs-number">176.</span> <span class="hljs-number">177.</span> <span class="hljs-number">178.</span> <span class="hljs-number">179.</span> <span class="hljs-number">180.</span> <span class="hljs-number">181.</span> <span class="hljs-number">182.</span> <span class="hljs-number">183.</span> <span class="hljs-number">184.</span> <span class="hljs-number">185.</span> <span class="hljs-number">186.</span> <span class="hljs-number">187.</span> <span class="hljs-number">188.</span> <span class="hljs-number">189.</span> </li><li>   <span class="hljs-number">190.</span> <span class="hljs-number">191.</span>] </li><li>  [<span class="hljs-number">192.</span> <span class="hljs-number">193.</span> <span class="hljs-number">194.</span> <span class="hljs-number">195.</span> <span class="hljs-number">196.</span> <span class="hljs-number">197.</span> <span class="hljs-number">198.</span> <span class="hljs-number">199.</span> <span class="hljs-number">200.</span> <span class="hljs-number">201.</span> <span class="hljs-number">202.</span> <span class="hljs-number">203.</span> <span class="hljs-number">204.</span> <span class="hljs-number">205.</span> </li><li>   <span class="hljs-number">206.</span> <span class="hljs-number">207.</span>] </li><li>  [<span class="hljs-number">208.</span> <span class="hljs-number">209.</span> <span class="hljs-number">210.</span> <span class="hljs-number">211.</span> <span class="hljs-number">212.</span> <span class="hljs-number">213.</span> <span class="hljs-number">214.</span> <span class="hljs-number">215.</span> <span class="hljs-number">216.</span> <span class="hljs-number">217.</span> <span class="hljs-number">218.</span> <span class="hljs-number">219.</span> <span class="hljs-number">220.</span> <span class="hljs-number">221.</span> </li><li>   <span class="hljs-number">222.</span> <span class="hljs-number">223.</span>] </li><li>  [<span class="hljs-number">224.</span> <span class="hljs-number">225.</span> <span class="hljs-number">226.</span> <span class="hljs-number">227.</span> <span class="hljs-number">228.</span> <span class="hljs-number">229.</span> <span class="hljs-number">230.</span> <span class="hljs-number">231.</span> <span class="hljs-number">232.</span> <span class="hljs-number">233.</span> <span class="hljs-number">234.</span> <span class="hljs-number">235.</span> <span class="hljs-number">236.</span> <span class="hljs-number">237.</span> </li><li>   <span class="hljs-number">238.</span> <span class="hljs-number">239.</span>] </li><li>  [<span class="hljs-number">240.</span> <span class="hljs-number">241.</span> <span class="hljs-number">242.</span> <span class="hljs-number">243.</span> <span class="hljs-number">244.</span> <span class="hljs-number">245.</span> <span class="hljs-number">246.</span> <span class="hljs-number">247.</span> <span class="hljs-number">248.</span> <span class="hljs-number">249.</span> <span class="hljs-number">250.</span> <span class="hljs-number">251.</span> <span class="hljs-number">252.</span> <span class="hljs-number">253.</span> </li><li>   <span class="hljs-number">254.</span> <span class="hljs-number">255.</span>]] </li><li>  </li><li>输出数据(dst_gm): </li><li> [[  <span class="hljs-number">0.</span>  <span class="hljs-number">16.</span>  <span class="hljs-number">32.</span>  <span class="hljs-number">48.</span>  <span class="hljs-number">64.</span>  <span class="hljs-number">80.</span>  <span class="hljs-number">96.</span> <span class="hljs-number">112.</span> <span class="hljs-number">128.</span> <span class="hljs-number">144.</span> <span class="hljs-number">160.</span> <span class="hljs-number">176.</span> <span class="hljs-number">192.</span> <span class="hljs-number">208.</span> </li><li>   <span class="hljs-number">224.</span> <span class="hljs-number">240.</span>] </li><li>  [  <span class="hljs-number">1.</span>  <span class="hljs-number">17.</span>  <span class="hljs-number">33.</span>  <span class="hljs-number">49.</span>  <span class="hljs-number">65.</span>  <span class="hljs-number">81.</span>  <span class="hljs-number">97.</span> <span class="hljs-number">113.</span> <span class="hljs-number">129.</span> <span class="hljs-number">145.</span> <span class="hljs-number">161.</span> <span class="hljs-number">177.</span> <span class="hljs-number">193.</span> <span class="hljs-number">209.</span> </li><li>   <span class="hljs-number">225.</span> <span class="hljs-number">241.</span>] </li><li>  [  <span class="hljs-number">2.</span>  <span class="hljs-number">18.</span>  <span class="hljs-number">34.</span>  <span class="hljs-number">50.</span>  <span class="hljs-number">66.</span>  <span class="hljs-number">82.</span>  <span class="hljs-number">98.</span> <span class="hljs-number">114.</span> <span class="hljs-number">130.</span> <span class="hljs-number">146.</span> <span class="hljs-number">162.</span> <span class="hljs-number">178.</span> <span class="hljs-number">194.</span> <span class="hljs-number">210.</span> </li><li>   <span class="hljs-number">226.</span> <span class="hljs-number">242.</span>] </li><li>  [  <span class="hljs-number">3.</span>  <span class="hljs-number">19.</span>  <span class="hljs-number">35.</span>  <span class="hljs-number">51.</span>  <span class="hljs-number">67.</span>  <span class="hljs-number">83.</span>  <span class="hljs-number">99.</span> <span class="hljs-number">115.</span> <span class="hljs-number">131.</span> <span class="hljs-number">147.</span> <span class="hljs-number">163.</span> <span class="hljs-number">179.</span> <span class="hljs-number">195.</span> <span class="hljs-number">211.</span> </li><li>   <span class="hljs-number">227.</span> <span class="hljs-number">243.</span>] </li><li>  [  <span class="hljs-number">4.</span>  <span class="hljs-number">20.</span>  <span class="hljs-number">36.</span>  <span class="hljs-number">52.</span>  <span class="hljs-number">68.</span>  <span class="hljs-number">84.</span> <span class="hljs-number">100.</span> <span class="hljs-number">116.</span> <span class="hljs-number">132.</span> <span class="hljs-number">148.</span> <span class="hljs-number">164.</span> <span class="hljs-number">180.</span> <span class="hljs-number">196.</span> <span class="hljs-number">212.</span> </li><li>   <span class="hljs-number">228.</span> <span class="hljs-number">244.</span>] </li><li>  [  <span class="hljs-number">5.</span>  <span class="hljs-number">21.</span>  <span class="hljs-number">37.</span>  <span class="hljs-number">53.</span>  <span class="hljs-number">69.</span>  <span class="hljs-number">85.</span> <span class="hljs-number">101.</span> <span class="hljs-number">117.</span> <span class="hljs-number">133.</span> <span class="hljs-number">149.</span> <span class="hljs-number">165.</span> <span class="hljs-number">181.</span> <span class="hljs-number">197.</span> <span class="hljs-number">213.</span> </li><li>   <span class="hljs-number">229.</span> <span class="hljs-number">245.</span>] </li><li>  [  <span class="hljs-number">6.</span>  <span class="hljs-number">22.</span>  <span class="hljs-number">38.</span>  <span class="hljs-number">54.</span>  <span class="hljs-number">70.</span>  <span class="hljs-number">86.</span> <span class="hljs-number">102.</span> <span class="hljs-number">118.</span> <span class="hljs-number">134.</span> <span class="hljs-number">150.</span> <span class="hljs-number">166.</span> <span class="hljs-number">182.</span> <span class="hljs-number">198.</span> <span class="hljs-number">214.</span> </li><li>   <span class="hljs-number">230.</span> <span class="hljs-number">246.</span>] </li><li>  [  <span class="hljs-number">7.</span>  <span class="hljs-number">23.</span>  <span class="hljs-number">39.</span>  <span class="hljs-number">55.</span>  <span class="hljs-number">71.</span>  <span class="hljs-number">87.</span> <span class="hljs-number">103.</span> <span class="hljs-number">119.</span> <span class="hljs-number">135.</span> <span class="hljs-number">151.</span> <span class="hljs-number">167.</span> <span class="hljs-number">183.</span> <span class="hljs-number">199.</span> <span class="hljs-number">215.</span> </li><li>   <span class="hljs-number">231.</span> <span class="hljs-number">247.</span>] </li><li>  [  <span class="hljs-number">8.</span>  <span class="hljs-number">24.</span>  <span class="hljs-number">40.</span>  <span class="hljs-number">56.</span>  <span class="hljs-number">72.</span>  <span class="hljs-number">88.</span> <span class="hljs-number">104.</span> <span class="hljs-number">120.</span> <span class="hljs-number">136.</span> <span class="hljs-number">152.</span> <span class="hljs-number">168.</span> <span class="hljs-number">184.</span> <span class="hljs-number">200.</span> <span class="hljs-number">216.</span> </li><li>   <span class="hljs-number">232.</span> <span class="hljs-number">248.</span>] </li><li>  [  <span class="hljs-number">9.</span>  <span class="hljs-number">25.</span>  <span class="hljs-number">41.</span>  <span class="hljs-number">57.</span>  <span class="hljs-number">73.</span>  <span class="hljs-number">89.</span> <span class="hljs-number">105.</span> <span class="hljs-number">121.</span> <span class="hljs-number">137.</span> <span class="hljs-number">153.</span> <span class="hljs-number">169.</span> <span class="hljs-number">185.</span> <span class="hljs-number">201.</span> <span class="hljs-number">217.</span> </li><li>   <span class="hljs-number">233.</span> <span class="hljs-number">249.</span>] </li><li>  [ <span class="hljs-number">10.</span>  <span class="hljs-number">26.</span>  <span class="hljs-number">42.</span>  <span class="hljs-number">58.</span>  <span class="hljs-number">74.</span>  <span class="hljs-number">90.</span> <span class="hljs-number">106.</span> <span class="hljs-number">122.</span> <span class="hljs-number">138.</span> <span class="hljs-number">154.</span> <span class="hljs-number">170.</span> <span class="hljs-number">186.</span> <span class="hljs-number">202.</span> <span class="hljs-number">218.</span> </li><li>   <span class="hljs-number">234.</span> <span class="hljs-number">250.</span>] </li><li>  [ <span class="hljs-number">11.</span>  <span class="hljs-number">27.</span>  <span class="hljs-number">43.</span>  <span class="hljs-number">59.</span>  <span class="hljs-number">75.</span>  <span class="hljs-number">91.</span> <span class="hljs-number">107.</span> <span class="hljs-number">123.</span> <span class="hljs-number">139.</span> <span class="hljs-number">155.</span> <span class="hljs-number">171.</span> <span class="hljs-number">187.</span> <span class="hljs-number">203.</span> <span class="hljs-number">219.</span> </li><li>   <span class="hljs-number">235.</span> <span class="hljs-number">251.</span>] </li><li>  [ <span class="hljs-number">12.</span>  <span class="hljs-number">28.</span>  <span class="hljs-number">44.</span>  <span class="hljs-number">60.</span>  <span class="hljs-number">76.</span>  <span class="hljs-number">92.</span> <span class="hljs-number">108.</span> <span class="hljs-number">124.</span> <span class="hljs-number">140.</span> <span class="hljs-number">156.</span> <span class="hljs-number">172.</span> <span class="hljs-number">188.</span> <span class="hljs-number">204.</span> <span class="hljs-number">220.</span> </li><li>   <span class="hljs-number">236.</span> <span class="hljs-number">252.</span>] </li><li>  [ <span class="hljs-number">13.</span>  <span class="hljs-number">29.</span>  <span class="hljs-number">45.</span>  <span class="hljs-number">61.</span>  <span class="hljs-number">77.</span>  <span class="hljs-number">93.</span> <span class="hljs-number">109.</span> <span class="hljs-number">125.</span> <span class="hljs-number">141.</span> <span class="hljs-number">157.</span> <span class="hljs-number">173.</span> <span class="hljs-number">189.</span> <span class="hljs-number">205.</span> <span class="hljs-number">221.</span> </li><li>   <span class="hljs-number">237.</span> <span class="hljs-number">253.</span>] </li><li>  [ <span class="hljs-number">14.</span>  <span class="hljs-number">30.</span>  <span class="hljs-number">46.</span>  <span class="hljs-number">62.</span>  <span class="hljs-number">78.</span>  <span class="hljs-number">94.</span> <span class="hljs-number">110.</span> <span class="hljs-number">126.</span> <span class="hljs-number">142.</span> <span class="hljs-number">158.</span> <span class="hljs-number">174.</span> <span class="hljs-number">190.</span> <span class="hljs-number">206.</span> <span class="hljs-number">222.</span> </li><li>   <span class="hljs-number">238.</span> <span class="hljs-number">254.</span>] </li><li>  [ <span class="hljs-number">15.</span>  <span class="hljs-number">31.</span>  <span class="hljs-number">47.</span>  <span class="hljs-number">63.</span>  <span class="hljs-number">79.</span>  <span class="hljs-number">95.</span> <span class="hljs-number">111.</span> <span class="hljs-number">127.</span> <span class="hljs-number">143.</span> <span class="hljs-number">159.</span> <span class="hljs-number">175.</span> <span class="hljs-number">191.</span> <span class="hljs-number">207.</span> <span class="hljs-number">223.</span> </li><li>   <span class="hljs-number">239.</span> <span class="hljs-number">255.</span>]]</li></ol></pre></div></div> </li><li>增强接口调用示例，完成half类型的[N, C, H, W]-&gt;[N, H, W, C]转置。<div _ngcontent-lrr-c106="" class="highlight-div"><div _ngcontent-lrr-c106="" class="highlight-div-header"><div _ngcontent-lrr-c106="" class="highlight-div-header-left"><div _ngcontent-lrr-c106="" class="handle-button expand-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrr-c106="" class="highlight-div-header-right"><div _ngcontent-lrr-c106="" class="handle-button ai-button"></div><div _ngcontent-lrr-c106="" class="handle-button line-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrr-c106="" class="handle-button theme-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrr-c106="" class="handle-button copy-button"><div _ngcontent-lrr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrr-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li>  </li><li> <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Kernel4dTrans</span> { </li><li> <span class="hljs-keyword">public</span>: </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">Kernel4dTrans</span><span class="hljs-params">()</span> </span>{} </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span> *srcGm, __gm__ <span class="hljs-type">uint8_t</span> *dstGm)</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         inputSize = N * C * H * W; </li><li>         tmpBufferSize = (C + <span class="hljs-number">2</span>) * <span class="hljs-number">16</span> * <span class="hljs-number">16</span>; </li><li>         srcGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ T *)srcGm); </li><li>         dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ T *)dstGm); </li><li>         pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueSrcVecIn, <span class="hljs-number">1</span>, inputSize*<span class="hljs-built_in">sizeof</span>(T)); </li><li>         pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueSrcVecOut, <span class="hljs-number">1</span>, inputSize*<span class="hljs-built_in">sizeof</span>(T)); </li><li>         pipe.<span class="hljs-built_in">InitBuffer</span>(tmpQueue, <span class="hljs-number">1</span>, tmpBufferSize * <span class="hljs-built_in">sizeof</span>(T)); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         <span class="hljs-built_in">CopyIn</span>(); </li><li>         <span class="hljs-built_in">Compute</span>(); </li><li>         <span class="hljs-built_in">CopyOut</span>(); </li><li>     } </li><li> <span class="hljs-keyword">private</span>: </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;T&gt; srcLocal = inQueueSrcVecIn.<span class="hljs-built_in">AllocTensor</span>&lt;T&gt;(); </li><li>         AscendC::<span class="hljs-built_in">DataCopy</span>(srcLocal, srcGlobal, inputSize); </li><li>         inQueueSrcVecIn.<span class="hljs-built_in">EnQue</span>(srcLocal); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;T&gt; srcLocal = inQueueSrcVecIn.<span class="hljs-built_in">DeQue</span>&lt;T&gt;(); </li><li>         AscendC::LocalTensor&lt;T&gt; dstLocal = inQueueSrcVecOut.<span class="hljs-built_in">AllocTensor</span>&lt;T&gt;(); </li><li>         AscendC::LocalTensor&lt;<span class="hljs-type">uint8_t</span>&gt; stackBuffer = tmpQueue.<span class="hljs-built_in">AllocTensor</span>&lt;<span class="hljs-type">uint8_t</span>&gt;(); </li><li>  </li><li>         AscendC::TransposeParamsExt transposeParams; </li><li>         transposeParams.nSize = N; </li><li>         transposeParams.cSize = C; </li><li>         transposeParams.hSize = H; </li><li>         transposeParams.wSize = W; </li><li>         transposeParams.transposeType = transposetype; </li><li>         AscendC::<span class="hljs-built_in">Transpose</span>(dstLocal, srcLocal, stackBuffer, transposeParams); </li><li>         inQueueSrcVecOut.<span class="hljs-built_in">EnQue</span>&lt;T&gt;(dstLocal); </li><li>         inQueueSrcVecIn.<span class="hljs-built_in">FreeTensor</span>(srcLocal); </li><li>         tmpQueue.<span class="hljs-built_in">FreeTensor</span>(stackBuffer); </li><li>     } </li><li>     <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">     </span>{ </li><li>         AscendC::LocalTensor&lt;T&gt; dstLocal = inQueueSrcVecOut.<span class="hljs-built_in">DeQue</span>&lt;T&gt;(); </li><li>         AscendC::<span class="hljs-built_in">DataCopy</span>(dstGlobal, dstLocal, inputSize); </li><li>         inQueueSrcVecOut.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>     } </li><li> <span class="hljs-keyword">private</span>: </li><li>     AscendC::TPipe pipe; </li><li>     AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; inQueueSrcVecIn; </li><li>     AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; inQueueSrcVecOut; </li><li>     AscendC::TQue&lt;AscendC::QuePosition::VECCALC, <span class="hljs-number">1</span>&gt; tmpQueue; </li><li>  </li><li>     AscendC::GlobalTensor&lt;T&gt; srcGlobal; </li><li>     AscendC::GlobalTensor&lt;T&gt; dstGlobal; </li><li>     <span class="hljs-type">uint32_t</span> N = <span class="hljs-number">3</span>; </li><li>     <span class="hljs-type">uint32_t</span> C = <span class="hljs-number">3</span>; </li><li>     <span class="hljs-type">uint32_t</span> H = <span class="hljs-number">2</span>; </li><li>     <span class="hljs-type">uint32_t</span> W = <span class="hljs-number">8</span>; </li><li>     <span class="hljs-type">uint32_t</span> inputSize, tmpBufferSize; </li><li>     AscendC::TransposeType transposetype = AscendC::TransposeType::TRANSPOSE_NCHW2NHWC; </li><li> }; </li><li>  </li><li> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">transpose_kernel</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* srcGm, __gm__ <span class="hljs-type">uint8_t</span>* dstGm)</span> </span></li><li><span class="hljs-function"> </span>{ </li><li>     Kernel4dTrans&lt;half&gt;op; </li><li>     op.<span class="hljs-built_in">Init</span>(srcGm, dstGm); </li><li>     op.<span class="hljs-built_in">Process</span>(); </li><li> }</li></ol></pre></div></div> </li></ul> </div> </div> <div></div></div>