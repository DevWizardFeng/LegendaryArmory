<h1 _ngcontent-clv-c119="" class="doc-title ng-star-inserted" title="UIAbility与UIAbility连接开发指南"> UIAbility与UIAbility连接开发指南 </h1>

<div _ngcontent-clv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>自API version 18起，系统新增支持应用跨设备协同连接与通信能力（含数据传输）。该特性通过分布式组件管理框架实现多端应用协作（即多个终端设备上的应用协同完成同一业务场景），成为分布式能力体系的核心功能之一。典型应用场景如智能手表端的拍照控制应用，可远程调用手机端相机功能并实现跨设备的实时双向数据交互。</p>    </div>    <div class="tiledSection">     <h3 id="能力范围" class="firsth2">能力范围<i class="anchor-icon anchor-icon-link" anchorid="能力范围" tips="复制节点链接"></i></h3>          <ul>      <li>跨设备拉起应用：支持在分布式组网环境下拉起关联应用，实现多端业务协同（需应用适配开发）</li>      <li>跨设备数据交互：实现跨设备数据传输，跨设备数据交互能力随不同应用类型存在差异。具体为系统应用可传输文本、字节流、图片及传输流，三方应用仅支持文本信息。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h3>          <p>在进行应用跨设备连接管理开发前，开发者应了解以下基本概念：</p>     <ul>      <li>       <p><strong>DMS</strong></p>       <p>DMS（Distributedsched Management Service）是分布式组件管理框架，提供分布式组件的管理能力。</p></li>      <li>       <p><strong>UIAbility</strong></p>       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-overview" target="_blank">UIAbility</a>描述应用程序的界面交互能力，负责管理应用界面的生命周期、用户交互以及界面渲染等任务。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h3>          <p>应用跨设备连接管理依托分布式组件管理框架，在分布式组件管理框架上进行了JS对象型的封装，能通过分布式组件管理框架服务建立协同关系并进行应用间的连接，数据的交互能力由系统支持。</p>     <p><strong>图1</strong> 应用跨设备连接运行机制</p>     <p><span><img originheight="822" originwidth="1298" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115031.74457167608091261466987044176010:50001231000000:2800:4C04230C1B7CDE00C87BE70C7E8AB30D90BF5F1A0FAE4E2E9C1209A19B12E88F.png" width="920" height="582.6194144838213"></span></p>    </div>    <div class="tiledSection">     <h3 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>仅限于API version 18及以上版本设备，设备间需要登录相同的华为账号。</p></li>      <li>       <p>不同设备间只有相同bundleName的UIAbility应用才能进行协同。</p></li>      <li>       <p>业务协同完毕后需及时结束协同状态。为了系统的安全和资源合理利用考虑，未申请长时任务的应用，在锁屏或退至后台5秒以上，会被结束掉协同生命周期。</p></li>      <li>       <p>分布式组件管理框架在协同过程中不会对传输内容进行审查。涉及隐私敏感数据时，建议业务通过弹框提醒等方式提醒用户。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境要求" class="firsth2">环境要求<i class="anchor-icon anchor-icon-link" anchorid="环境要求" tips="复制节点链接"></i></h3>          <p>可登录华为账号的设备A和设备B，设备间需要组网成功（设备组网通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/devicemanager-guidelines" target="_blank">Device Manager</a>的接口实现）。</p>    </div>    <div class="tiledSection">     <h3 id="搭建环境">搭建环境<i class="anchor-icon anchor-icon-link" anchorid="搭建环境" tips="复制节点链接"></i></h3>          <ol>      <li>在PC上安装<a href="https://developer.huawei.com/consumer/cn/download/deveco-studio" target="_blank">DevEco Studio</a>，要求版本在4.1及以上。</li>      <li>将public-SDK更新到API 18或以上。</li>      <li>用USB线缆将两台调试设备（设备A和设备B）连接到PC。</li>      <li>打开设备A和设备B的蓝牙，互相识别，实现组网。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="检验环境是否搭建成功">检验环境是否搭建成功<i class="anchor-icon anchor-icon-link" anchorid="检验环境是否搭建成功" tips="复制节点链接"></i></h3>          <p>PC上执行shell命令：</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>hdc shell</li><li>hidumper -s 4700 -a "buscenter -l remote_device_info"</li></ol></pre></div></div>     <p>组网成功时可显示组网设备数量的信息，如“remote device num = 1”。</p>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>应用跨设备连接管理可以通过分布式组件管理框架，拉起对端设备并发送消息。具体案例提供如下。</p>    </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <p>应用跨设备连接管理接口如下表所示。具体API说明详见API参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-distributed-abilityconnectionmanager" target="_blank">abilityConnectionManager</a>。</p>     <p><strong>表1</strong> abilityConnectionManager接口功能介绍</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">createAbilityConnectionSession(serviceName: string, context: Context, peerInfo: PeerInfo, connectOptions: ConnectOptions): number;</td>         <td class="cellrowborder" valign="top" width="50%">创建应用间的会话。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">destroyAbilityConnectionSession(sessionId: number): void;</td>         <td class="cellrowborder" valign="top" width="50%">销毁应用间的会话。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">connect(sessionId: number): Promise&lt;ConnectResult&gt;;</td>         <td class="cellrowborder" valign="top" width="50%">source侧进行ability的连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">acceptConnect(sessionId: number, token: string): Promise&lt;void&gt;;</td>         <td class="cellrowborder" valign="top" width="50%">sink侧进行ability的连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">disconnect(sessionId: number): void;</td>         <td class="cellrowborder" valign="top" width="50%">断开ability的连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'connect' | 'disconnect' | 'receiveMessage' | 'receiveData', sessionId: number, callback: Callback&lt;EventCallbackInfo&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">监听事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">off(type: 'connect' | 'disconnect' | 'receiveMessage' | 'receiveData', sessionId: number, callback?: Callback&lt;EventCallbackInfo&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">取消事件的监听。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">sendMessage(sessionId: number, msg: string): Promise&lt;void&gt;;</td>         <td class="cellrowborder" valign="top" width="50%">发送文本信息。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>通过应用跨设备管理模块，设备A拉起并连接设备B上的应用。连接成功后，设备A和设备B通过on接口注册相应事件的回调监听。设备A或设备B通过sendMessage接口发送消息。对端通过监听到的回调信息进行后续协同业务。</p>     <p><strong>导入AbilityConnectionManager模块文件</strong></p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityConnectionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li></ol></pre></div></div>     <p><strong>发现设备</strong></p>     <p>设备A上的应用，需要发现并选择设备B的netWorkId来作为协同接口的入参。可调用分布式设备管理模块接口，进行对端设备的发现和选择，详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/devicemanager-guidelines">分布式设备管理模块</a>进行开发。</p>     <p><strong>应用间创建会话并进行连接</strong></p>     <p>设备A和设备B在创建会话和连接时要执行的操作不同，接下来的开发步骤中，以设备A作为连接发起方，设备B作为连接接收端。</p>     <p><strong>1.设备A</strong></p>     <p>应用主动调用createAbilityConnectionSession()接口创建会话，获得sessionId。之后调用connect()方法启动ability会话连接（此时设备B上应用会被拉起）。</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityConnectionManager, distributedDeviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dmClass</span>: distributedDeviceManager.<span class="hljs-property">DeviceManager</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">initDmClass</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    dmClass = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.example.remotephotodemo'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'createDeviceManager err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 获取设备B的设备ID</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getRemoteDeviceId</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-title function_">initDmClass</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dmClass === <span class="hljs-string">'object'</span> &amp;&amp; dmClass !== <span class="hljs-literal">null</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getRemoteDeviceId begin'</span>);</li><li>    <span class="hljs-keyword">let</span> list = dmClass.<span class="hljs-title function_">getAvailableDeviceListSync</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (list) === <span class="hljs-string">'undefined'</span> || <span class="hljs-keyword">typeof</span> (list.<span class="hljs-property">length</span>) === <span class="hljs-string">'undefined'</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getRemoteDeviceId err: list is null'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (list.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getRemoteDeviceId err: list is empty'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> list[<span class="hljs-number">0</span>].<span class="hljs-property">networkId</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getRemoteDeviceId err: dmClass is null'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'sessionId'</span>) <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// 定义设备B的协同信息</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">peerInfo</span>: abilityConnectionManager.<span class="hljs-property">PeerInfo</span> = {</li><li>  <span class="hljs-attr">deviceId</span>: <span class="hljs-title function_">getRemoteDeviceId</span>()!,</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.remotephotodemo'</span>,</li><li>  <span class="hljs-attr">moduleName</span>: <span class="hljs-string">'entry'</span>,</li><li>  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'EntryAbility'</span>,</li><li>  <span class="hljs-attr">serviceName</span>: <span class="hljs-string">'collabTest'</span></li><li>};</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">myRecord</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {</li><li>  <span class="hljs-string">"newKey1"</span>: <span class="hljs-string">"value1"</span>,</li><li>};</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {</li><li>  <span class="hljs-string">'ohos.collabrate.key.start.option'</span>: <span class="hljs-string">'ohos.collabrate.value.foreground'</span>,</li><li>};</li><li><span class="hljs-comment">// 定义连接选项</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">connectOptions</span>: abilityConnectionManager.<span class="hljs-property">ConnectOptions</span> = {</li><li>  <span class="hljs-attr">needSendData</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">startOptions</span>: abilityConnectionManager.<span class="hljs-property">StartOptionParams</span>.<span class="hljs-property">START_IN_FOREGROUND</span>,</li><li>  <span class="hljs-attr">parameters</span>: myRecord</li><li>};</li><li><span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>();</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = abilityConnectionManager.<span class="hljs-title function_">createAbilityConnectionSession</span>(<span class="hljs-string">"collabTest"</span>, context, peerInfo, connectOptions);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'createSession sessionId is'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>);</li><li>
</li><li>  abilityConnectionManager.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ConnectResult</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">ConnectResult</span>.<span class="hljs-property">isConnected</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'connect failed'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"connect failed"</span>);</li><li>  })</li><li>
</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, error);</li><li>}</li></ol></pre></div></div>     <p><strong>2.设备B</strong></p>     <p>设备A的应用调用connect()后，设备B的应用会通过协同的方式被拉起，拉起时会触发协同生命周期函数onCollaborate()，可在该接口中配置createAbilityConnectionSession()接口以及acceptConnect()接口的调用。</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityConnectionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onCollaborate</span>(<span class="hljs-attr">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">CollaborateResult</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'on collaborate'</span>);</li><li>    <span class="hljs-keyword">let</span> param = wantParam[<span class="hljs-string">"ohos.extra.param.key.supportCollaborateIndex"</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onCollab</span>(param);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onCollab</span>(<span class="hljs-params">collabParam: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>    <span class="hljs-keyword">const</span> sessionId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSessionFromWant</span>(collabParam);</li><li>    <span class="hljs-keyword">if</span> (sessionId == -<span class="hljs-number">1</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Invalid session ID.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> collabToken = collabParam[<span class="hljs-string">"ohos.dms.collabToken"</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>    abilityConnectionManager.<span class="hljs-title function_">acceptConnect</span>(sessionId, collabToken).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'acceptConnect success'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"failed"</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">createSessionFromWant</span>(<span class="hljs-attr">collabParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> sessionId = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">const</span> peerInfo = collabParam[<span class="hljs-string">"PeerInfo"</span>] <span class="hljs-keyword">as</span> abilityConnectionManager.<span class="hljs-property">PeerInfo</span>;</li><li>    <span class="hljs-keyword">if</span> (peerInfo == <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span> sessionId;</li><li>    }</li><li> </li><li>    <span class="hljs-keyword">const</span> options = collabParam[<span class="hljs-string">"ConnectOption"</span>] <span class="hljs-keyword">as</span> abilityConnectionManager.<span class="hljs-property">ConnectOptions</span>;</li><li>    options.<span class="hljs-property">needSendData</span> = <span class="hljs-literal">true</span>;</li><li>    options.<span class="hljs-property">needSendStream</span> = <span class="hljs-literal">true</span>;</li><li>    options.<span class="hljs-property">needReceiveStream</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      sessionId = abilityConnectionManager.<span class="hljs-title function_">createAbilityConnectionSession</span>(<span class="hljs-string">"collabTest"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, peerInfo, options);</li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'sessionId'</span>, sessionId);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'createSession sessionId is'</span> + sessionId);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, error);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> sessionId;</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>注册事件监听</strong></p>     <p>在应用创建会话成功并获得sessionId后，开发者可调用on()方法进行对应事件的监听，通过触发回调函数的方式通知监听者，以便执行对应业务。</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { abilityConnectionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li>  <span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"connect"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,<span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'session connect, sessionId is'</span>, callbackInfo.<span class="hljs-property">sessionId</span>);</li><li>  });</li><li>  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"disconnect"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,<span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'session disconnect, sessionId is'</span>, callbackInfo.<span class="hljs-property">sessionId</span>);</li><li>  });</li><li>  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"receiveMessage"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,<span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'session receiveMessage, sessionId is'</span>, callbackInfo.<span class="hljs-property">sessionId</span>);</li><li>  });</li></ol></pre></div></div>     <p><strong>发送消息</strong></p>     <p>应用连接成功后，开发者可在设备A或者设备B上调用sendMessage()方法给对端应用发送文本信息。</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityConnectionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>abilityConnectionManager.<span class="hljs-title function_">sendMessage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>, <span class="hljs-string">"message send success"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"sendMessage success"</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"connect failed"</span>);</li><li>})</li></ol></pre></div></div>     <p><strong>结束协同</strong></p>     <p>业务协同完毕后需及时结束协同状态。若是后续短期内还有协同需要，可调用disconnect()方法断开应用间的连接，保留sessionId，以便下次继续使用该sessionId进行连接。若是短期无需使用协同业务，可直接调用destroyAbilityConnectionSession()接口销毁会话，此时会自动断开连接。</p>     <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityConnectionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'disconnectRemoteAbility begin'</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> == -<span class="hljs-number">1</span>) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Invalid session ID.'</span>);</li><li><span class="hljs-keyword">return</span>;</li><li>}</li><li>abilityConnectionManager.<span class="hljs-title function_">disconnect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>);</li><li>
</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'destroyAbilityConnectionSession called'</span>);</li><li>abilityConnectionManager.<span class="hljs-title function_">destroyAbilityConnectionSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h3>          <p>应用侧开发完成后，可在设备A和设备B上安装应用，测试步骤如下：</p>     <ol>      <li>点击设备A应用的“连接”按钮，此时设备B上的应用被拉起。</li>      <li>点击设备A应用的“sendMessage”按钮，此时设备B上的应用会触发on()方法的回调，接收该字符串。</li>      <li>点击设备A或设备B应用的“disconnect”按钮，此时双端会断开连接，触发connect()接口的回调，将断连信息上报给双端应用。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="设备a应用无法拉起设备b应用" class="firsth2">设备A应用无法拉起设备B应用<i class="anchor-icon anchor-icon-link" anchorid="设备a应用无法拉起设备b应用" tips="复制节点链接"></i></h3>          <p><strong>可能原因</strong></p>     <ul>      <li>       <p>【原因1】：设备间没有相互组网，导致设备A发起连接时，createAbilityConnectionSession()接口中的peerInfo.deviceId属性未设置正确。</p></li>      <li>       <p>【原因2】：有多台设备相互组网，设备A发起连接时，createAbilityConnectionSession()接口中的peerInfo.deviceId属性设置为其他设备的deviceId，未正确指定到B设备上。</p></li>     </ul>     <p><strong>解决措施</strong></p>     <ul>      <li>       <p>针对原因1，设备A和设备B开启USB调试功能，用USB线连接设备和PC。执行shell命令：</p>       <div _ngcontent-clv-c106="" class="highlight-div"><div _ngcontent-clv-c106="" class="highlight-div-header"><div _ngcontent-clv-c106="" class="highlight-div-header-left"><div _ngcontent-clv-c106="" class="handle-button expand-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-clv-c106="" class="highlight-div-header-right"><div _ngcontent-clv-c106="" class="handle-button ai-button"></div><div _ngcontent-clv-c106="" class="handle-button line-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-clv-c106="" class="handle-button theme-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-clv-c106="" class="handle-button copy-button"><div _ngcontent-clv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-clv-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>hdc shell</li><li>hidumper -s 4700 -a "buscenter -l remote_device_info"</li></ol></pre></div></div>       <p>回显信息为“remote device num = 0”即为组网失败，请确保登录同一华为账号并使用蓝牙连接。组网成功时可显示组网设备数量的信息，如“remote device num = 1”。</p></li>      <li>       <p>针对原因2，查询并选择指定设备时，添加设备选择列表，确保指定到期望的设备。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="应用锁屏或者退后台一段时间后正在执行的协同业务被断开">应用锁屏或者退后台一段时间后，正在执行的协同业务被断开<i class="anchor-icon anchor-icon-link" anchorid="应用锁屏或者退后台一段时间后正在执行的协同业务被断开" tips="复制节点链接"></i></h3>          <p><strong>可能原因</strong></p>     <p>应用在协同过程中，DMS会对应用的生命周期进行监听。发生锁屏、退后台操作持续五秒后，未申请长时任务的应用会被结束协同状态。</p>     <p><strong>解决措施</strong></p>     <p>应用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task">申请长时任务</a>，消除此限制。</p>    </div>   </div>   <div></div></div>