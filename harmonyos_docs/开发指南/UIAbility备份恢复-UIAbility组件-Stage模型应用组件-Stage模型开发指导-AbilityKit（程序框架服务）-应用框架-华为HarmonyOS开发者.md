<h1 _ngcontent-bnn-c119="" class="doc-title ng-star-inserted" title="UIAbility备份恢复"> UIAbility备份恢复 </h1>

<div _ngcontent-bnn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>当应用后台运行时，可能由于系统资源管控等原因导致应用关闭、进程退出，应用直接退出可能会导致用户数据丢失。如果应用在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext" target="_blank">UIAbilityContext</a>中启用了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>备份恢复功能，并对临时数据进行保存，则可以在应用退出后的下一次启动时恢复先前的状态和数据（包括应用的页面栈以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onsavestate" target="_blank">onSaveState</a>接口中保存的数据），从而保证用户体验的连贯性。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>应用正常关闭时，不会触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>备份流程。应用正常启动（例如通过startAbility接口启动或点击图标启动）时，不触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>恢复流程。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="运行机制">运行机制<i class="anchor-icon anchor-icon-link" anchorid="运行机制" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>数据备份：在应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onbackground" target="_blank">onBackground</a>生命周期后，系统自动调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onsavestate" target="_blank">onSaveState</a>进行备份。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>数据恢复：恢复的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">Want</a>数据可以在应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#oncreate" target="_blank">onCreate</a>生命周期中获取，页面栈数据在应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onwindowstagecreate" target="_blank">onWindowStageCreate</a>生命周期中恢复。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>备份恢复支持多实例，备份数据保存7天，以文件的形式存储在应用的沙箱路径中。</p></li>      <li>       <p>备份数据存储在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want#want" target="_blank">Want</a>中的parameter字段中，由于序列化大小限制，支持的最大数据量为200KB。</p></li>      <li>       <p>重启设备不支持还原备份。</p></li>      <li>       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiextensionability" target="_blank">UIExtensionAbility</a>不支持备份恢复。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>备份恢复接口由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext" target="_blank">UIAbilityContext</a>模块提供，开发者可以通过在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>中通过this.context直接调用，详见<a href="/consumer/cn/doc/harmonyos-guides/ability-recover-guideline#开发步骤">开发步骤</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">setRestoreEnabled(enabled: boolean): void</td>         <td class="cellrowborder" valign="top" width="50%">设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>是否启用备份恢复。</td>        </tr>             </tbody></table></div>     </div>     <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#setrestoreenabled14" target="_blank">setRestoreEnabled</a>接口需要在应用初始化阶段调用（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onforeground" target="_blank">onForeground</a>前），比如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#oncreate" target="_blank">onCreate</a>调用。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>开发者需要在应用模块初始化时启用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>的备份恢复功能。</p>     <div _ngcontent-bnn-c106="" class="highlight-div"><div _ngcontent-bnn-c106="" class="highlight-div-header"><div _ngcontent-bnn-c106="" class="highlight-div-header-left"><div _ngcontent-bnn-c106="" class="handle-button expand-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnn-c106="" class="highlight-div-header-right"><div _ngcontent-bnn-c106="" class="handle-button ai-button"></div><div _ngcontent-bnn-c106="" class="handle-button line-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnn-c106="" class="handle-button theme-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnn-c106="" class="handle-button copy-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Demo] EntryAbility onCreate'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setRestoreEnabled</span>(<span class="hljs-literal">true</span>);</li><li>    }</li><li>}</li></ol></pre></div></div>     <p>开发者主动保存数据，在UIAbility启动时恢复。</p>     <div _ngcontent-bnn-c106="" class="highlight-div"><div _ngcontent-bnn-c106="" class="highlight-div-header"><div _ngcontent-bnn-c106="" class="highlight-div-header-left"><div _ngcontent-bnn-c106="" class="handle-button expand-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnn-c106="" class="highlight-div-header-right"><div _ngcontent-bnn-c106="" class="handle-button ai-button"></div><div _ngcontent-bnn-c106="" class="handle-button line-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnn-c106="" class="handle-button theme-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnn-c106="" class="handle-button copy-button"><div _ngcontent-bnn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Demo] EntryAbility onCreate'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setRestoreEnabled</span>(<span class="hljs-literal">true</span>);</li><li>        <span class="hljs-keyword">if</span> (want &amp;&amp; want.<span class="hljs-property">parameters</span>) {</li><li>          <span class="hljs-keyword">let</span> recoveryMyData = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'myData'</span>];</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onSaveState</span>(<span class="hljs-params">state:AbilityConstant.StateType, wantParams: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>        <span class="hljs-comment">// 保存应用数据。</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Demo] EntryAbility onSaveState'</span>);</li><li>        wantParams[<span class="hljs-string">'myData'</span>] = <span class="hljs-string">'my1234567'</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnSaveResult</span>.<span class="hljs-property">ALL_AGREE</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>