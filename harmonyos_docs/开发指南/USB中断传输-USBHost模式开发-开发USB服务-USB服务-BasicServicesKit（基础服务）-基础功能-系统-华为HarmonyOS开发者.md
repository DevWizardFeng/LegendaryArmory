<h1 _ngcontent-dkh-c119="" class="doc-title ng-star-inserted" title="USB中断传输"> USB中断传输 </h1>

<div _ngcontent-dkh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>中断传输主要用于主机（Host）接收设备（Device）发送的数据包。设备的端点模式决定了接口支持中断读或中断写，这种传输方式适用于少量的、分散的、不可预测的数据类型的传输，鼠标、键盘和操纵杆等设备均属于这种类型，且此类设备的端点一般只支持中断读操作。</p>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境要求" class="firsth2">环境要求<i class="anchor-icon anchor-icon-link" anchorid="环境要求" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>开发工具及配置：</p>       <p>DevEco Studio作为驱动开发工具，是进行驱动开发必备条件之一，开发者可以使用该工具进行开发、调试、打包等操作。请<a href="https://developer.huawei.com/consumer/cn/download/" target="_blank">下载安装</a>该工具，并参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-tools-overview" target="_blank">DevEco Studio使用指南</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-create-new-project" target="_blank">创建工程及运行</a>进行基本的操作验证，保证DevEco Studio可正常运行。</p></li>      <li>       <p>SDK版本配置：</p>       <p>扩展外设管理提供的ArkTs接口，所需SDK版本为API16及以上才可使用。</p></li>      <li>       <p>HDC配置：</p>       <p>HDC（HarmonyOS Device Connector）是为开发人员提供的用于调试的命令行工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互，详细参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdc" target="_blank">HDC配置</a>。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="搭建环境">搭建环境<i class="anchor-icon anchor-icon-link" anchorid="搭建环境" tips="复制节点链接"></i></h3>          <ul>      <li>在PC上安装<a href="https://developer.huawei.com/consumer/cn/download/deveco-studio" target="_blank">DevEco Studio</a>，要求版本在4.1及以上。</li>      <li>将public-SDK更新到API 16或以上。</li>      <li>PC安装HDC工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互。</li>      <li>用USB线缆将搭载HarmonyOS的设备连接到PC。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">usbSubmitTransfer(transfer: UsbDataTransferParams): void</td>         <td class="cellrowborder" valign="top" width="50%">异步传输接口（支持实时、批量、中断传输）。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">usbCancelTransfer(transfer: UsbDataTransferParams): void</td>         <td class="cellrowborder" valign="top" width="50%">取消已提交的异步传输。</td>        </tr>             </tbody></table></div>     </div>     <p>更多关于设备管理和传输模式的详细接口介绍，请查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager" target="_blank">API参考文档</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>主机（Host）连接设备（Device），通过usbSubmitTransfer接口进行数据传输。以下步骤描述了如何使用中断传输方式来传输数据：</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>以下示例代码只是使用中断传输方式来传输数据的必要流程，需要放入具体的方法中执行。在实际调用时，设备开发者需要遵循设备相关协议进行调用，确保数据的正确传输和设备的兼容性。</p>      </div></div></div>     <ol>      <li>       <p>导入模块。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入usbManager模块。</span></li><li><span class="hljs-keyword">import</span> { usbManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取设备列表。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取连接主设备的USB设备列表</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbDevices</span>: <span class="hljs-title class_">Array</span>&lt;usbManager.<span class="hljs-property">USBDevice</span>&gt; = usbManager.<span class="hljs-title function_">getDevices</span>();</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`usbDevices: <span class="hljs-subst">${usbDevices}</span>`</span>);</li><li><span class="hljs-keyword">if</span>(usbDevices.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'usbDevices is empty'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取设备操作权限。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处对列表中的第一台USB设备判断是否拥有访问权限</span></li><li><span class="hljs-comment">// 函数名仅作为示例，实际需要与业务结合命名</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transferDefault</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">usbDevice</span>: usbManager.<span class="hljs-property">USBDevice</span> = usbDevices[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-keyword">if</span>(!usbManager.<span class="hljs-title function_">hasRight</span>(usbDevice.<span class="hljs-property">name</span>)) {</li><li>      <span class="hljs-keyword">await</span> usbManager.<span class="hljs-title function_">requestRight</span>(usbDevice.<span class="hljs-property">name</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span>(!result) {</li><li>          <span class="hljs-comment">// 没有访问设备的权限且用户不授权则退出</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'The user does not have permission to perform this operation'</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>      });</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取通过中断传输读取数据的端点。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">devicePipe</span>: usbManager.<span class="hljs-property">USBDevicePipe</span> = usbManager.<span class="hljs-title function_">connectDevice</span>(usbDevice);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbConfigs</span>: usbManager.<span class="hljs-property">USBConfiguration</span>[] = usbDevice.<span class="hljs-property">configs</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbInterfaces</span>: usbManager.<span class="hljs-property">USBInterface</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbInterface</span>: usbManager.<span class="hljs-property">USBInterface</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbEndpoints</span>: usbManager.<span class="hljs-property">USBEndpoint</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usbEndpoint</span>: usbManager.<span class="hljs-property">USBEndpoint</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; usbConfigs.<span class="hljs-property">length</span>; i++) {</li><li>  usbInterfaces = usbConfigs[i].<span class="hljs-property">interfaces</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; usbInterfaces.<span class="hljs-property">length</span>; j++) {</li><li>    usbEndpoints = usbInterfaces[j].<span class="hljs-property">endpoints</span>;</li><li>    usbEndpoint = usbEndpoints.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> value.<span class="hljs-property">direction</span> === <span class="hljs-number">128</span> &amp;&amp; value.<span class="hljs-property">type</span> === usbManager.<span class="hljs-property">UsbEndpointTransferType</span>.<span class="hljs-property">TRANSFER_TYPE_INTERRUPT</span>;</li><li>    })</li><li>    <span class="hljs-keyword">if</span> (usbEndpoint !== <span class="hljs-literal">undefined</span>) {</li><li>      usbInterface = usbInterfaces[j];</li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>  }</li><li>}</li><li><span class="hljs-keyword">if</span> (usbEndpoint === <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`get usbEndpoint error`</span>)</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>连接设备，注册通信接口。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册通信接口，注册成功返回0，注册失败返回其他错误码。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">claimInterfaceResult</span>: <span class="hljs-built_in">number</span> = usbManager.<span class="hljs-title function_">claimInterface</span>(devicePipe, usbInterface, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (claimInterfaceResult !== <span class="hljs-number">0</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`claimInterface error = <span class="hljs-subst">${claimInterfaceResult}</span>`</span>)</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>传输数据。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 通信接口注册成功，传输数据</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">transferParams</span>: usbManager.<span class="hljs-property">UsbDataTransferParams</span> = {</li><li>    <span class="hljs-attr">devPipe</span>: devicePipe,</li><li>    <span class="hljs-attr">flags</span>: usbManager.<span class="hljs-property">UsbTransferFlags</span>.<span class="hljs-property">USB_TRANSFER_SHORT_NOT_OK</span>,</li><li>    <span class="hljs-attr">endpoint</span>: usbEndpoint.<span class="hljs-property">address</span>,</li><li>    <span class="hljs-attr">type</span>: usbManager.<span class="hljs-property">UsbEndpointTransferType</span>.<span class="hljs-property">TRANSFER_TYPE_INTERRUPT</span>,</li><li>    <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,</li><li>    <span class="hljs-attr">length</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> {},</li><li>    <span class="hljs-attr">userData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">10</span>),</li><li>    <span class="hljs-attr">buffer</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">10</span>),</li><li>    <span class="hljs-attr">isoPacketCount</span>: <span class="hljs-number">2</span>,</li><li>  };</li><li>
</li><li>  transferParams.<span class="hljs-property">callback</span> = <span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span>, callBackData: usbManager.SubmitTransferCallback</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`callBackData = <span class="hljs-subst">${callBackData}</span>`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`transfer success，result = <span class="hljs-subst">${transferParams.buffer}</span>`</span>);</li><li>  }</li><li>  usbManager.<span class="hljs-title function_">usbSubmitTransfer</span>(transferParams);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'USB transfer request submitted.'</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`USB transfer failed: <span class="hljs-subst">${error}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>取消传输，释放接口，关闭设备消息控制通道。</p>       <div _ngcontent-dkh-c106="" class="highlight-div"><div _ngcontent-dkh-c106="" class="highlight-div-header"><div _ngcontent-dkh-c106="" class="highlight-div-header-left"><div _ngcontent-dkh-c106="" class="handle-button expand-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dkh-c106="" class="highlight-div-header-right"><div _ngcontent-dkh-c106="" class="handle-button ai-button"></div><div _ngcontent-dkh-c106="" class="handle-button line-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dkh-c106="" class="handle-button theme-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dkh-c106="" class="handle-button copy-button"><div _ngcontent-dkh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dkh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>usbManager.<span class="hljs-title function_">usbCancelTransfer</span>(transferParams);</li><li>usbManager.<span class="hljs-title function_">releaseInterface</span>(devicePipe, usbInterface);</li><li>usbManager.<span class="hljs-title function_">closePipe</span>(devicePipe);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h3>          <ol>      <li>主机端通过USB接口连接支持中断传输的终端设备（鼠标、键盘等）。</li>      <li>执行上述代码。</li>      <li>log中搜索关键字transfer success，表示中断传输接口调用成功。</li>     </ol>    </div>   </div>   <div></div></div>