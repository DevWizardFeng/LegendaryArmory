<h1 _ngcontent-qid-c119="" class="doc-title ng-star-inserted" title="USB批量传输"> USB批量传输 </h1>

<div _ngcontent-qid-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>批量传输主要应用在传输和接收大量数据同时又没有带宽和间隔时间要求的情况下，例如传输文件、图像等场景，打印机和扫描仪等设备属于这种类型的设备。</p>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境要求" class="firsth2">环境要求<i class="anchor-icon anchor-icon-link" anchorid="环境要求" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>开发工具及配置：</p>       <p>DevEco Studio作为驱动开发工具，是进行驱动开发必备条件之一，开发者可以使用该工具进行开发、调试、打包等操作。请<a href="https://developer.huawei.com/consumer/cn/download/" target="_blank">下载安装</a>该工具，并参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-tools-overview" target="_blank">DevEco Studio使用指南</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-create-new-project" target="_blank">创建工程及运行</a>进行基本的操作验证，保证DevEco Studio可正常运行。</p></li>      <li>       <p>SDK版本配置：</p>       <p>扩展外设管理提供的ArkTs接口，所需SDK版本为API16及以上才可使用。</p></li>      <li>       <p>HDC配置：</p>       <p>HDC（HarmonyOS Device Connector）是为开发人员提供的用于调试的命令行工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互，详细参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdc" target="_blank">HDC配置</a>。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="搭建环境">搭建环境<i class="anchor-icon anchor-icon-link" anchorid="搭建环境" tips="复制节点链接"></i></h3>          <ul>      <li>在PC上安装<a href="https://developer.huawei.com/consumer/cn/download/deveco-studio" target="_blank">DevEco Studio</a>，要求版本在4.1及以上。</li>      <li>将public-SDK更新到API 16或以上。</li>      <li>PC安装HDC工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互。</li>      <li>用USB线缆将搭载HarmonyOS的设备连接到PC。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">bulkTransfer(pipe: USBDevicePipe, endpoint: USBEndpoint, buffer: Uint8Array, timeout ?: number): Promise&lt;number&gt;</td>         <td class="cellrowborder" valign="top" width="50%">批量传输。</td>        </tr>             </tbody></table></div>     </div>     <p>更多关于设备管理和传输模式的详细接口介绍，请查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager" target="_blank">API参考文档</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>主机（Host）连接设备（Device），通过bulkTransfer接口进行数据传输。以下步骤描述了如何使用批量传输方式来传输数据：</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>以下示例代码只是使用批量传输方式来传输数据的必要流程，需要放入具体的方法中执行。在实际调用时，设备开发者需要遵循设备相关协议进行调用，确保数据的正确传输和设备的兼容性。</p>      </div></div></div>     <ol>      <li>       <p>导入模块。</p>       <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入usbManager模块。</span></li><li><span class="hljs-keyword">import</span> { usbManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取设备列表。</p></li>     </ol>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>批量传输只能在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager#usbendpointtransfertype18" target="_blank">传输类型</a>为2的端点上进行，若不匹配会返回IO错误。</p>      </div></div></div>     <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取设备列表。</span></li><li><span class="hljs-keyword">let</span> deviceList : <span class="hljs-title class_">Array</span>&lt;usbManager.<span class="hljs-property">USBDevice</span>&gt; = usbManager.<span class="hljs-title function_">getDevices</span>();</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`deviceList: <span class="hljs-subst">${deviceList}</span>`</span>);</li><li><span class="hljs-keyword">if</span>(deviceList.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'deviceList is empty'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">deviceList结构示例</span></li><li><span class="hljs-comment">[</span></li><li><span class="hljs-comment">  {</span></li><li><span class="hljs-comment">    name: "1-1",</span></li><li><span class="hljs-comment">    serial: "",</span></li><li><span class="hljs-comment">    manufacturerName: "",</span></li><li><span class="hljs-comment">    productName: "",</span></li><li><span class="hljs-comment">    version: "",</span></li><li><span class="hljs-comment">    vendorId: 7531,</span></li><li><span class="hljs-comment">    productId: 2,</span></li><li><span class="hljs-comment">    clazz: 9,</span></li><li><span class="hljs-comment">    subClass: 0,</span></li><li><span class="hljs-comment">    protocol: 1,</span></li><li><span class="hljs-comment">    devAddress: 1,</span></li><li><span class="hljs-comment">    busNum: 1,</span></li><li><span class="hljs-comment">    configs: [</span></li><li><span class="hljs-comment">      {</span></li><li><span class="hljs-comment">        id: 1,</span></li><li><span class="hljs-comment">        attributes: 224,</span></li><li><span class="hljs-comment">        isRemoteWakeup: true,</span></li><li><span class="hljs-comment">        isSelfPowered: true,</span></li><li><span class="hljs-comment">        maxPower: 0,</span></li><li><span class="hljs-comment">        name: "1-1",</span></li><li><span class="hljs-comment">        interfaces: [</span></li><li><span class="hljs-comment">          {</span></li><li><span class="hljs-comment">            id: 0,</span></li><li><span class="hljs-comment">            protocol: 0,</span></li><li><span class="hljs-comment">            clazz: 9,</span></li><li><span class="hljs-comment">            subClass: 0,</span></li><li><span class="hljs-comment">            alternateSetting: 0,</span></li><li><span class="hljs-comment">            name: "1-1",</span></li><li><span class="hljs-comment">            endpoints: [</span></li><li><span class="hljs-comment">              {</span></li><li><span class="hljs-comment">                address: 129,</span></li><li><span class="hljs-comment">                attributes: 3,</span></li><li><span class="hljs-comment">                interval: 12,</span></li><li><span class="hljs-comment">                maxPacketSize: 4,</span></li><li><span class="hljs-comment">                direction: 128,</span></li><li><span class="hljs-comment">                number: 1,</span></li><li><span class="hljs-comment">                type: 2, // 决定传输类型。</span></li><li><span class="hljs-comment">                interfaceId: 0,</span></li><li><span class="hljs-comment">              }</span></li><li><span class="hljs-comment">            ]</span></li><li><span class="hljs-comment">          }</span></li><li><span class="hljs-comment">        ]</span></li><li><span class="hljs-comment">      }</span></li><li><span class="hljs-comment">    ]</span></li><li><span class="hljs-comment">  }</span></li><li><span class="hljs-comment">]</span></li><li><span class="hljs-comment">*/</span></li></ol></pre></div></div>     <ol>      <li>       <p>获取设备操作权限。</p>       <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> deviceName : <span class="hljs-built_in">string</span> = deviceList[<span class="hljs-number">0</span>].<span class="hljs-property">name</span>;</li><li><span class="hljs-comment">// 申请操作指定的device的操作权限。</span></li><li>usbManager.<span class="hljs-title function_">requestRight</span>(deviceName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">hasRight : <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`usb device request right result: <span class="hljs-subst">${hasRight}</span>`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>)=&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`usb device request right failed : <span class="hljs-subst">${error}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>打开设备。</p>       <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 打开设备，获取数据传输通道。</span></li><li><span class="hljs-keyword">let</span> pipe : usbManager.<span class="hljs-property">USBDevicePipe</span> = usbManager.<span class="hljs-title function_">connectDevice</span>(deviceList[<span class="hljs-number">0</span>]);</li><li><span class="hljs-keyword">let</span> interface1 : usbManager.<span class="hljs-property">USBInterface</span> = deviceList[<span class="hljs-number">0</span>].<span class="hljs-property">configs</span>[<span class="hljs-number">0</span>].<span class="hljs-property">interfaces</span>[<span class="hljs-number">0</span>];</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> 打开对应接口，在设备信息（deviceList）中选取对应的interface。</span></li><li><span class="hljs-comment">interface1为设备配置中的一个接口。</span></li><li><span class="hljs-comment">*/</span></li><li>usbManager.<span class="hljs-title function_">claimInterface</span>(pipe, interface1, <span class="hljs-literal">true</span>);</li></ol></pre></div></div></li>      <li>       <p>数据传输。</p></li>     </ol>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>在数据传输前建议先获取interface所属endpointer的type，通过type判断interface是否支持所需的传输类型。</p>       <p>若调用传输接口失败，请先确认设备interface是否支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager#usbinterface" target="_blank">模式切换</a>。若alternateSetting支持切换设置，可在传输前调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager#usbmanagersetinterface" target="_blank">usbManager.setInterface</a>重新设置interface，使端点和传输类型匹配，保证端点正常通信。</p>      </div></div></div>     <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  读取数据，在device信息中选取对应数据接收的endpoint来做数据传输</span></li><li><span class="hljs-comment">（endpoint.direction == 0x80）；dataUint8Array是要读取的数据，类型为Uint8Array。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">let</span> inEndpoint : usbManager.<span class="hljs-property">USBEndpoint</span> = interface1.<span class="hljs-property">endpoints</span>[<span class="hljs-number">2</span>];</li><li><span class="hljs-keyword">let</span> outEndpoint : usbManager.<span class="hljs-property">USBEndpoint</span> = interface1.<span class="hljs-property">endpoints</span>[<span class="hljs-number">1</span>];</li><li><span class="hljs-keyword">let</span> dataUint8Array : <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);</li><li>usbManager.<span class="hljs-title function_">bulkTransfer</span>(pipe, inEndpoint, dataUint8Array, <span class="hljs-number">15000</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">dataLength : <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li><span class="hljs-keyword">if</span> (dataLength &gt;= <span class="hljs-number">0</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`usb readData result Length : <span class="hljs-subst">${dataLength}</span>`</span>);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"usb readData failed"</span>);</li><li>}</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`usb readData error : <span class="hljs-subst">${error}</span>`</span>);</li><li>});</li><li><span class="hljs-comment">// 发送数据，在device信息中选取对应数据发送的endpoint来做数据传输。（endpoint.direction == 0）</span></li><li>usbManager.<span class="hljs-title function_">bulkTransfer</span>(pipe, outEndpoint, dataUint8Array, <span class="hljs-number">15000</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">dataLength : <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (dataLength &gt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`usb writeData result write length : <span class="hljs-subst">${dataLength}</span>`</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"usb writeData failed"</span>);</li><li>  }</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`usb writeData error : <span class="hljs-subst">${error}</span>`</span>);</li><li>});</li></ol></pre></div></div>     <ol>      <li>       <p>释放接口，关闭设备。</p>       <div _ngcontent-qid-c106="" class="highlight-div"><div _ngcontent-qid-c106="" class="highlight-div-header"><div _ngcontent-qid-c106="" class="highlight-div-header-left"><div _ngcontent-qid-c106="" class="handle-button expand-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qid-c106="" class="highlight-div-header-right"><div _ngcontent-qid-c106="" class="handle-button ai-button"></div><div _ngcontent-qid-c106="" class="handle-button line-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qid-c106="" class="handle-button theme-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qid-c106="" class="handle-button copy-button"><div _ngcontent-qid-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qid-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>usbManager.<span class="hljs-title function_">releaseInterface</span>(pipe, interface1);</li><li>usbManager.<span class="hljs-title function_">closePipe</span>(pipe);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>