<h1 _ngcontent-kuc-c119="" class="doc-title ng-star-inserted" title="USB设备管理"> USB设备管理 </h1>

<div _ngcontent-kuc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>当有USB设备插入时，可以通过usbManager获取一些USB设备的基本信息，如设备类型、支持的功能等。 Host侧主要通过封装的pipe来完成和USB设备的通信。在HarmonyOS系统中，USB管理服务是核心组件，负责管理与USB设备的连接和通信。通过USB管理服务，应用程序可以检测USB设备的连接与断开，管理USB设备的权限请求和设备配置，以及进行数据传输和设备控制。</p>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境要求" class="firsth2">环境要求<i class="anchor-icon anchor-icon-link" anchorid="环境要求" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>开发工具及配置：</p>       <p>DevEco Studio作为驱动开发工具，是进行驱动开发必备条件之一，开发者可以使用该工具进行开发、调试、打包等操作。请<a href="https://developer.huawei.com/consumer/cn/download/" target="_blank">下载安装</a>该工具，并参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-tools-overview" target="_blank">DevEco Studio使用指南</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-create-new-project" target="_blank">创建工程及运行</a>进行基本的操作验证，保证DevEco Studio可正常运行。</p></li>      <li>       <p>SDK版本配置：</p>       <p>扩展外设管理提供的ArkTs接口，所需SDK版本为API16及以上才可使用。</p></li>      <li>       <p>HDC配置：</p>       <p>HDC（HarmonyOS Device Connector）是为开发人员提供的用于调试的命令行工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互，详细参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdc" target="_blank">HDC配置</a>。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="搭建环境">搭建环境<i class="anchor-icon anchor-icon-link" anchorid="搭建环境" tips="复制节点链接"></i></h3>          <ul>      <li>在PC上安装<a href="https://developer.huawei.com/consumer/cn/download/deveco-studio" target="_blank">DevEco Studio</a>，要求版本在4.1及以上。</li>      <li>将public-SDK更新到API 16或以上。</li>      <li>PC安装HDC工具，通过该工具可以在Windows/Linux/Mac系统上与真实设备或者模拟器进行交互。</li>      <li>用USB线缆将搭载HarmonyOS的设备连接到PC。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <p>USB设备管理主要提供的功能有：查询USB设备列表、USB设备权限控制、设置USB设备配置等。</p>     <p>USB类开放能力如下，具体请查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-usbmanager" target="_blank">API参考文档</a>。</p>     <p><strong>表1</strong> USB类的开放能力接口</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">hasRight(deviceName: string): boolean</td>         <td class="cellrowborder" valign="top" width="50%">判断是否有权访问该设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">requestRight(deviceName: string): Promise&lt;boolean&gt;</td>         <td class="cellrowborder" valign="top" width="50%">请求软件包的临时权限以访问设备。使用Promise异步回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">removeRight(deviceName: string): boolean</td>         <td class="cellrowborder" valign="top" width="50%">移除软件包对设备的访问权限。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">connectDevice(device: USBDevice): Readonly&lt;USBDevicePipe&gt;</td>         <td class="cellrowborder" valign="top" width="50%">根据getDevices()返回的设备信息打开USB设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getDevices(): Array&lt;Readonly&lt;USBDevice&gt;&gt;</td>         <td class="cellrowborder" valign="top" width="50%">获取接入主设备的USB设备列表。如果没有设备接入，那么将会返回一个空的列表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setConfiguration(pipe: USBDevicePipe, config: USBConfiguration): number</td>         <td class="cellrowborder" valign="top" width="50%">设置设备的配置。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setInterface(pipe: USBDevicePipe, iface: USBInterface): number</td>         <td class="cellrowborder" valign="top" width="50%">设置设备的接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">claimInterface(pipe: USBDevicePipe, iface: USBInterface, force ?: boolean): number</td>         <td class="cellrowborder" valign="top" width="50%">注册通信接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">closePipe(pipe: USBDevicePipe): number</td>         <td class="cellrowborder" valign="top" width="50%">关闭设备消息控制通道。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">releaseInterface(pipe: USBDevicePipe, iface: USBInterface): number</td>         <td class="cellrowborder" valign="top" width="50%">释放注册过的通信接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getFileDescriptor(pipe: USBDevicePipe): number</td>         <td class="cellrowborder" valign="top" width="50%">获取文件描述符。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getRawDescriptor(pipe: USBDevicePipe): Uint8Array</td>         <td class="cellrowborder" valign="top" width="50%">获取原始的USB描述符。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>USB设备可作为Host连接Device进行设备管理，开发示例如下：</p>     <ol>      <li>       <p>导入模块。</p>       <div _ngcontent-kuc-c106="" class="highlight-div"><div _ngcontent-kuc-c106="" class="highlight-div-header"><div _ngcontent-kuc-c106="" class="highlight-div-header-left"><div _ngcontent-kuc-c106="" class="handle-button expand-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kuc-c106="" class="highlight-div-header-right"><div _ngcontent-kuc-c106="" class="handle-button ai-button"></div><div _ngcontent-kuc-c106="" class="handle-button line-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kuc-c106="" class="handle-button theme-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kuc-c106="" class="handle-button copy-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kuc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入usbManager模块。</span></li><li><span class="hljs-keyword">import</span> { usbManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取设备列表。</p>       <div _ngcontent-kuc-c106="" class="highlight-div"><div _ngcontent-kuc-c106="" class="highlight-div-header"><div _ngcontent-kuc-c106="" class="highlight-div-header-left"><div _ngcontent-kuc-c106="" class="handle-button expand-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kuc-c106="" class="highlight-div-header-right"><div _ngcontent-kuc-c106="" class="handle-button ai-button"></div><div _ngcontent-kuc-c106="" class="handle-button line-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kuc-c106="" class="handle-button theme-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kuc-c106="" class="handle-button copy-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kuc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取设备列表。</span></li><li><span class="hljs-keyword">let</span> deviceList : <span class="hljs-title class_">Array</span>&lt;usbManager.<span class="hljs-property">USBDevice</span>&gt; = usbManager.<span class="hljs-title function_">getDevices</span>();</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`deviceList: <span class="hljs-subst">${deviceList}</span>`</span>);</li><li><span class="hljs-keyword">if</span>(deviceList.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'deviceList is empty'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">deviceList结构示例</span></li><li><span class="hljs-comment">[</span></li><li><span class="hljs-comment">  {</span></li><li><span class="hljs-comment">    name: "1-1",</span></li><li><span class="hljs-comment">    serial: "",</span></li><li><span class="hljs-comment">    manufacturerName: "",</span></li><li><span class="hljs-comment">    productName: "",</span></li><li><span class="hljs-comment">    version: "",</span></li><li><span class="hljs-comment">    vendorId: 7531,</span></li><li><span class="hljs-comment">    productId: 2,</span></li><li><span class="hljs-comment">    clazz: 9,</span></li><li><span class="hljs-comment">    subClass: 0,</span></li><li><span class="hljs-comment">    protocol: 1,</span></li><li><span class="hljs-comment">    devAddress: 1,</span></li><li><span class="hljs-comment">    busNum: 1,</span></li><li><span class="hljs-comment">    configs: [</span></li><li><span class="hljs-comment">      {</span></li><li><span class="hljs-comment">        id: 1,</span></li><li><span class="hljs-comment">        attributes: 224,</span></li><li><span class="hljs-comment">        isRemoteWakeup: true,</span></li><li><span class="hljs-comment">        isSelfPowered: true,</span></li><li><span class="hljs-comment">        maxPower: 0,</span></li><li><span class="hljs-comment">        name: "1-1",</span></li><li><span class="hljs-comment">        interfaces: [</span></li><li><span class="hljs-comment">          {</span></li><li><span class="hljs-comment">            id: 0,</span></li><li><span class="hljs-comment">            protocol: 0,</span></li><li><span class="hljs-comment">            clazz: 9,</span></li><li><span class="hljs-comment">            subClass: 0,</span></li><li><span class="hljs-comment">            alternateSetting: 0,</span></li><li><span class="hljs-comment">            name: "1-1",</span></li><li><span class="hljs-comment">            endpoints: [</span></li><li><span class="hljs-comment">              {</span></li><li><span class="hljs-comment">                address: 129,</span></li><li><span class="hljs-comment">                attributes: 3,</span></li><li><span class="hljs-comment">                interval: 12,</span></li><li><span class="hljs-comment">                maxPacketSize: 4,</span></li><li><span class="hljs-comment">                direction: 128,</span></li><li><span class="hljs-comment">                number: 1,</span></li><li><span class="hljs-comment">                type: 3,</span></li><li><span class="hljs-comment">                interfaceId: 0,</span></li><li><span class="hljs-comment">              }</span></li><li><span class="hljs-comment">            ]</span></li><li><span class="hljs-comment">          }</span></li><li><span class="hljs-comment">        ]</span></li><li><span class="hljs-comment">      }</span></li><li><span class="hljs-comment">    ]</span></li><li><span class="hljs-comment">  }</span></li><li><span class="hljs-comment">]</span></li><li><span class="hljs-comment">*/</span></li></ol></pre></div></div></li>      <li>       <p>获取设备操作权限。</p>       <div _ngcontent-kuc-c106="" class="highlight-div"><div _ngcontent-kuc-c106="" class="highlight-div-header"><div _ngcontent-kuc-c106="" class="highlight-div-header-left"><div _ngcontent-kuc-c106="" class="handle-button expand-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kuc-c106="" class="highlight-div-header-right"><div _ngcontent-kuc-c106="" class="handle-button ai-button"></div><div _ngcontent-kuc-c106="" class="handle-button line-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kuc-c106="" class="handle-button theme-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kuc-c106="" class="handle-button copy-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kuc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> deviceName : <span class="hljs-built_in">string</span> = deviceList[<span class="hljs-number">0</span>].<span class="hljs-property">name</span>;</li><li><span class="hljs-comment">// 申请操作指定的device的操作权限。</span></li><li>usbManager.<span class="hljs-title function_">requestRight</span>(deviceName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">hasRight : <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"usb device request right result: "</span> + hasRight);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>)=&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`usb device request right failed : <span class="hljs-subst">${error}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>打开Device设备。</p>       <div _ngcontent-kuc-c106="" class="highlight-div"><div _ngcontent-kuc-c106="" class="highlight-div-header"><div _ngcontent-kuc-c106="" class="highlight-div-header-left"><div _ngcontent-kuc-c106="" class="handle-button expand-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kuc-c106="" class="highlight-div-header-right"><div _ngcontent-kuc-c106="" class="handle-button ai-button"></div><div _ngcontent-kuc-c106="" class="handle-button line-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kuc-c106="" class="handle-button theme-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kuc-c106="" class="handle-button copy-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kuc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 打开设备，获取数据传输通道。</span></li><li><span class="hljs-keyword">let</span> pipe : usbManager.<span class="hljs-property">USBDevicePipe</span> = usbManager.<span class="hljs-title function_">connectDevice</span>(deviceList[<span class="hljs-number">0</span>]);</li><li><span class="hljs-keyword">let</span> interface1 : usbManager.<span class="hljs-property">USBInterface</span> = deviceList[<span class="hljs-number">0</span>].<span class="hljs-property">configs</span>[<span class="hljs-number">0</span>].<span class="hljs-property">interfaces</span>[<span class="hljs-number">0</span>];</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> 打开对应接口，在设备信息（deviceList）中选取对应的interface。</span></li><li><span class="hljs-comment">interface1为设备配置中的一个接口。</span></li><li><span class="hljs-comment">*/</span></li><li>usbManager.<span class="hljs-title function_">claimInterface</span>(pipe, interface1, <span class="hljs-literal">true</span>);</li></ol></pre></div></div></li>      <li>       <p>释放接口，关闭设备。</p>       <div _ngcontent-kuc-c106="" class="highlight-div"><div _ngcontent-kuc-c106="" class="highlight-div-header"><div _ngcontent-kuc-c106="" class="highlight-div-header-left"><div _ngcontent-kuc-c106="" class="handle-button expand-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kuc-c106="" class="highlight-div-header-right"><div _ngcontent-kuc-c106="" class="handle-button ai-button"></div><div _ngcontent-kuc-c106="" class="handle-button line-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kuc-c106="" class="handle-button theme-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kuc-c106="" class="handle-button copy-button"><div _ngcontent-kuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kuc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>usbManager.<span class="hljs-title function_">releaseInterface</span>(pipe, interface1);</li><li>usbManager.<span class="hljs-title function_">closePipe</span>(pipe);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>