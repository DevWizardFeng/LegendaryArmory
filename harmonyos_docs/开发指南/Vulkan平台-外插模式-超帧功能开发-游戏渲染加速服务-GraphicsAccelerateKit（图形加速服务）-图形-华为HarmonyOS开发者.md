<h1 _ngcontent-ipv-c119="" class="doc-title ng-star-inserted" title="Vulkan平台"> Vulkan平台 </h1>

<div _ngcontent-ipv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1247120472212">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section1247120472212" tips="复制节点链接"></i></h2>          <p>基于Vulkan图形API平台，超帧外插模式的主要业务流程如下：</p>     <p><span><img originheight="893" originwidth="965" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114415.61512547225752458772659521650787:50001231000000:2800:F8474D9E11524C330ADC4E888B88BB359E14BFE274177D9E7FA261AEF119C5FA.png" width="920" height="851.3575129533679"></span></p>     <ol>      <li>用户进入超帧适用的游戏场景。</li>      <li>游戏应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#gac39606d03c25d898c656ab6973bb54f3" target="_blank">HMS_FG_CreateContext_VK</a>接口创建超帧上下文实例。如超帧上下文实例创建失败，则无需进入步骤6到步骤9的真实帧、预测帧交替渲染送显的循环流程，只需逐帧对场景进行渲染送显即可。</li>      <li>游戏应用调用接口配置超帧实例属性。包括调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga9262d0cde377603a6ccc1239095be917" target="_blank">HMS_FG_SetAlgorithmMode_VK</a>（必选）设置超帧算法模式并选择外插模式；调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga2295f5bde5b0186e0f89f7d49e3338bf" target="_blank">HMS_FG_SetResolution_VK</a>（必选）设置超帧输入输出图像分辨率；调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga7a71df6640e6e95d5d6f67b2e24448fd" target="_blank">HMS_FG_SetCvvZSemantic_VK</a>（可选）设置齐次裁剪空间Z/W范围及深度测试函数；调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#gabcb428cb2187ce986cf8ac0f1c76a3ca" target="_blank">HMS_FG_SetImageFormat_VK</a>（可选）设置超帧输入输出图像格式；如果颜色缓冲区相对深度模板缓冲区基于y轴翻转180度，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga5148977465964658f817de45e28ab80a" target="_blank">HMS_FG_SetDepthStencilYDirectionInverted_VK</a>（可选）设置翻转状态。</li>      <li>游戏应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga6871faa08ebf19d380301cf400c086a8" target="_blank">HMS_FG_Activate_VK</a>接口激活超帧上下文实例。</li>      <li>游戏应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga7733f097ea5f4ae4d2aa53d11d7e60ff" target="_blank">HMS_FG_CreateImage_VK</a>接口创建真实渲染帧颜色缓冲区图像实例、深度模板缓冲区图像实例、预测帧缓冲区图像实例。该接口将游戏应用中的VkImage、VkImageView图像资源和超帧算法实现之间建立关联。</li>      <li>渲染游戏场景绘制真实渲染帧，缓存真实帧颜色信息、深度信息和相机矩阵等信息，用于后续超帧预测。</li>      <li>真实渲染帧绘制UI并送显。</li>      <li>游戏应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga21f86a194e72e99dd54fd39080385a37" target="_blank">HMS_FG_Dispatch_VK</a>接口并传入历史真实渲染帧颜色信息、深度信息、相机矩阵等信息，生成预测帧，并更新预测帧缓冲区。</li>      <li>预测帧绘制UI并送显，跳转至步骤5继续执行，直到退出游戏场景。</li>      <li>用户退出超帧适用的游戏场景。</li>      <li>游戏应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga6be707669124e0bb6e5d61c2e24043be" target="_blank">HMS_FG_DestroyContext_VK</a>接口销毁超帧上下文实例并释放内存资源。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section831014124119">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section831014124119" tips="复制节点链接"></i></h2>          <p>本节阐述基于Vulkan图形API平台的超帧调用示例。详细代码请参考<a href="https://gitcode.com/harmonyos_samples/frame-generation-vulkan-samplecode-clientdemo-cpp" target="_blank">图形开发Sample（超帧Vulkan）</a>。</p>    </div>    <ol>     <li>引用Graphics Accelerate Kit超帧头文件：frame_generation_vk.h。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 引用超帧frame_generation_vk.h头文件</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;graphics_game_sdk/frame_generation_vk.h&gt;</span></span></li></ol></pre></div></div></li>     <li>编写CMakeLists.txt。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    framegeneration-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    libframegeneration.so</li><li>)</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    vulkan-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    vulkan</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC</li><li>    ${framegeneration-lib} ${vulkan-lib}</li><li>)</li></ol></pre></div></div></li>     <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#gac39606d03c25d898c656ab6973bb54f3" target="_blank">HMS_FG_CreateContext_VK</a>接口创建超帧上下文实例。如果返回nullptr，则说明超帧上下文实例创建失败，或当前硬件设备不支持开启超帧。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 变量声明</span></li><li>VkInstance vkInstance = VK_NULL_HANDLE;</li><li>VkPhysicalDevice vkPhysicalDevice = VK_NULL_HANDLE;</li><li>VkDevice vkDevice = VK_NULL_HANDLE;</li><li>
</li><li><span class="hljs-comment">// 创建超帧上下文实例</span></li><li>FG_ContextDescription_VK contextDescription{};</li><li>contextDescription.vkInstance = vkInstance;</li><li>contextDescription.vkPhysicalDevice = vkPhysicalDevice;</li><li>contextDescription.vkDevice = vkDevice;</li><li>contextDescription.framesInFlight = <span class="hljs-number">1</span>;</li><li>contextDescription.fnVulkanLoaderFunction = vkGetInstanceProcAddr;</li><li>FG_Context_VK* m_context = <span class="hljs-built_in">HMS_FG_CreateContext_VK</span>(&amp;contextDescription);</li><li><span class="hljs-keyword">if</span> (m_context == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div></li>     <li>调用超帧实例属性配置接口，超帧算法模式选择外插模式。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化超帧接口调用错误码</span></li><li>FG_ErrorCode errorCode = FG_SUCCESS;</li><li>
</li><li><span class="hljs-comment">// 超帧算法模式</span></li><li>FG_AlgorithmModeInfo aInfo{};</li><li>aInfo.predictionMode = FG_PREDICTION_MODE_EXTRAPOLATION;                  <span class="hljs-comment">// 外插模式</span></li><li>aInfo.meMode = FG_ME_MODE_BASIC;                                          <span class="hljs-comment">// 运动估计基础模式</span></li><li>errorCode = <span class="hljs-built_in">HMS_FG_SetAlgorithmMode_VK</span>(m_context, &amp;aInfo);                <span class="hljs-comment">// [必选] 设置超帧算法模式</span></li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 真实帧颜色缓冲区分辨率</span></li><li>FG_Dimension2D inputColorResolution{};                                    </li><li>inputColorResolution.width = <span class="hljs-number">1280</span>;                                        <span class="hljs-comment">// 真实帧颜色缓冲区图像宽度</span></li><li>inputColorResolution.height = <span class="hljs-number">720</span>;                                        <span class="hljs-comment">// 真实帧颜色缓冲区图像高度</span></li><li><span class="hljs-comment">// 真实帧深度模板缓冲区分辨率</span></li><li>FG_Dimension2D inputDepthStencilResolution{};                             </li><li>inputDepthStencilResolution.width = <span class="hljs-number">1280</span>;                                 <span class="hljs-comment">// 真实帧深度模板缓冲区图像宽度</span></li><li>inputDepthStencilResolution.height = <span class="hljs-number">720</span>;                                 <span class="hljs-comment">// 真实帧深度模板缓冲区图像高度</span></li><li><span class="hljs-comment">// 预测帧分辨率</span></li><li>FG_Dimension2D outputColorResolution{};                                    </li><li>outputColorResolution.width = <span class="hljs-number">1280</span>;                                       <span class="hljs-comment">// 预测帧图像宽度</span></li><li>outputColorResolution.height = <span class="hljs-number">720</span>;                                       <span class="hljs-comment">// 预测帧图像高度</span></li><li><span class="hljs-comment">// 超帧输入输出图像分辨率</span></li><li>FG_ResolutionInfo rInfo{};</li><li>rInfo.inputColorResolution = inputColorResolution;</li><li>rInfo.inputDepthStencilResolution = inputDepthStencilResolution;</li><li>rInfo.outputColorResolution = outputColorResolution;</li><li>errorCode = <span class="hljs-built_in">HMS_FG_SetResolution_VK</span>(m_context, &amp;rInfo);                    <span class="hljs-comment">// [必选] 设置超帧输入输出图像分辨率</span></li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// [可选] 设置齐次裁剪空间Z/W范围及深度测试模式，接口不调用时默认为FG_CVV_Z_SEMANTIC_ZERO_TO_ONE_FORWARD_Z</span></li><li>errorCode = <span class="hljs-built_in">HMS_FG_SetCvvZSemantic_VK</span>(m_context, FG_CVV_Z_SEMANTIC_ZERO_TO_ONE_FORWARD_Z);</li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// [可选] 设置超帧输入输出图像格式</span></li><li>FG_ImageFormat_VK imageFormat{};</li><li>imageFormat.inputColorFormat = VK_FORMAT_R8G8B8A8_UNORM;</li><li>imageFormat.inputDepthStencilFormat = VK_FORMAT_D24_UNORM_S8_UINT;</li><li>imageFormat.outputColorFormat = VK_FORMAT_R8G8B8A8_UNORM;</li><li>errorCode = <span class="hljs-built_in">HMS_FG_SetImageFormat_VK</span>(m_context, &amp;imageFormat);</li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// [可选] 当颜色缓冲区相对深度模板缓冲区基于y轴翻转180度时，设置第二个参数为true，接口不调用时默认为false</span></li><li>errorCode = <span class="hljs-built_in">HMS_FG_SetDepthStencilYDirectionInverted_VK</span>(m_context, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div></li>     <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga6871faa08ebf19d380301cf400c086a8" target="_blank">HMS_FG_Activate_VK</a>接口激活超帧上下文实例。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 激活超帧上下文实例</span></li><li>errorCode = <span class="hljs-built_in">HMS_FG_Activate_VK</span>(m_context);</li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div></li>     <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga7733f097ea5f4ae4d2aa53d11d7e60ff" target="_blank">HMS_FG_CreateImage_VK</a>接口创建真实渲染帧颜色缓冲区图像实例、深度模板缓冲区图像实例、预测帧缓冲区图像实例。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 变量声明</span></li><li>VkImage inputColorImage = VK_NULL_HANDLE;</li><li>VkImageView inputColorImageView = VK_NULL_HANDLE;</li><li>VkImage inputDepthStencilImage = VK_NULL_HANDLE;</li><li>VkImageView inputDepthStencilImageView = VK_NULL_HANDLE;</li><li>VkImage outputColorImage = VK_NULL_HANDLE;</li><li>VkImageView outputColorImageView = VK_NULL_HANDLE;</li><li>
</li><li><span class="hljs-comment">// 创建真实帧颜色缓冲区图像实例</span></li><li>FG_Image_VK* inputColor = <span class="hljs-built_in">HMS_FG_CreateImage_VK</span>(m_context, inputColorImage, inputColorImageView);</li><li><span class="hljs-keyword">if</span> (!inputColor) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li><span class="hljs-comment">// 创建真实帧深度模板缓冲区图像实例</span></li><li>FG_Image_VK* inputDepthStencil = <span class="hljs-built_in">HMS_FG_CreateImage_VK</span>(m_context, inputDepthStencilImage, inputDepthStencilImageView);</li><li><span class="hljs-keyword">if</span> (!inputDepthStencil) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li><span class="hljs-comment">// 创建预测帧缓冲区图像实例</span></li><li>FG_Image_VK* outputColor = <span class="hljs-built_in">HMS_FG_CreateImage_VK</span>(m_context, outputColorImage, outputColorImageView);</li><li><span class="hljs-keyword">if</span> (!outputColor) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div></li>     <li>游戏运行中，真实帧和预测帧交替渲染并送显。渲染真实帧时，缓存颜色信息、深度信息和相机矩阵等属性信息。渲染预测帧时，需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga21f86a194e72e99dd54fd39080385a37" target="_blank">HMS_FG_Dispatch_VK</a>接口并传入上一帧真实帧属性信息，指定预测帧缓冲区索引，生成预测帧，最终更新预测帧缓冲区内存。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 帧计数</span></li><li><span class="hljs-type">uint32_t</span> frameNum = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// 帧循环</span></li><li><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</li><li>    frameNum += <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> ((frameNum &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span>) { <span class="hljs-comment">// 真实帧渲染阶段</span></li><li>        <span class="hljs-comment">// 渲染当前帧渲染画面，缓存颜色、深度、相机矩阵等信息，用于下一帧预测帧生成</span></li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 绘制真实帧</span></li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 绘制UI</span></li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 送显真实帧</span></li><li>        <span class="hljs-comment">// ...    </span></li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 预测帧渲染阶段           </span></li><li>        <span class="hljs-comment">// 设置预测帧生成前真实帧颜色缓冲区同步状态</span></li><li>        FG_ImageSync_VK inputColorInitImageSync{};</li><li>        inputColorInitImageSync.stages = VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT;</li><li>        inputColorInitImageSync.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;</li><li>        inputColorInitImageSync.accessMask = VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 设置预测帧生成后真实帧颜色缓冲区同步状态</span></li><li>        FG_ImageSync_VK inputColorFinalImageSync{};</li><li>        inputColorFinalImageSync.stages = VK_PIPELINE_STAGE_TRANSFER_BIT;</li><li>        inputColorFinalImageSync.layout = VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL;</li><li>        inputColorFinalImageSync.accessMask = VK_ACCESS_TRANSFER_READ_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 创建真实帧颜色缓冲区图像属性实例</span></li><li>        FG_ImageInfo_VK inputColorImageInfo{};</li><li>        inputColorImageInfo.image = inputColor;</li><li>        inputColorImageInfo.initialSync = inputColorInitImageSync;</li><li>        inputColorImageInfo.finalSync = inputColorFinalImageSync;</li><li>
</li><li>        <span class="hljs-comment">// 设置预测帧生成前深度模板缓冲区同步状态</span></li><li>        FG_ImageSync_VK depthInitImageSync{};</li><li>        depthInitImageSync.stages = VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT;</li><li>        depthInitImageSync.layout = VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL;</li><li>        depthInitImageSync.accessMask = VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 设置预测帧生成后深度模板缓冲区同步状态</span></li><li>        FG_ImageSync_VK depthFinalImageSync{};</li><li>        depthFinalImageSync.stages = VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT;</li><li>        depthFinalImageSync.layout = VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL;</li><li>        depthFinalImageSync.accessMask = VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 创建真实帧深度模板缓冲区图像属性实例</span></li><li>        FG_ImageInfo_VK depthImageInfo{};</li><li>        depthImageInfo.image = inputDepthStencil;</li><li>        depthImageInfo.initialSync = depthInitImageSync;</li><li>        depthImageInfo.finalSync = depthFinalImageSync;</li><li>
</li><li>        <span class="hljs-comment">// 设置预测帧生成前预测帧缓冲区同步状态</span></li><li>        FG_ImageSync_VK outputColorInitImageSync{};</li><li>        outputColorInitImageSync.stages = VK_PIPELINE_STAGE_ALL_GRAPHICS_BIT;</li><li>        outputColorInitImageSync.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;</li><li>        outputColorInitImageSync.accessMask = VK_ACCESS_SHADER_WRITE_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 设置预测帧生成后预测帧缓冲区同步状态</span></li><li>        FG_ImageSync_VK outputColorFinalImageSync{};</li><li>        outputColorFinalImageSync.stages = VK_PIPELINE_STAGE_TRANSFER_BIT;</li><li>        outputColorFinalImageSync.layout = VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL;</li><li>        outputColorFinalImageSync.accessMask = VK_ACCESS_TRANSFER_READ_BIT;</li><li>
</li><li>        <span class="hljs-comment">// 创建预测帧缓冲区图像属性实例</span></li><li>        FG_ImageInfo_VK outputColorImageInfo{};</li><li>        outputColorImageInfo.image = outputColor;</li><li>        outputColorImageInfo.initialSync = outputColorInitImageSync;</li><li>        outputColorImageInfo.finalSync = outputColorFinalImageSync;</li><li>
</li><li>        <span class="hljs-comment">// 帧生成属性配置结构体</span></li><li>        FG_DispatchDescription_VK dispatchDescription{};</li><li>        <span class="hljs-comment">// 传入真实渲染帧颜色缓冲区属性信息</span></li><li>        dispatchDescription.inputColorInfo = inputColorImageInfo;</li><li>        <span class="hljs-comment">// 传入真实渲染帧深度模板缓冲区属性信息</span></li><li>        dispatchDescription.inputDepthStencilInfo = depthImageInfo;</li><li>        <span class="hljs-comment">// 传入预测帧缓冲区属性信息</span></li><li>        dispatchDescription.outputColorInfo = outputColorImageInfo;</li><li>
</li><li>        <span class="hljs-comment">// 变量声明</span></li><li>        FG_Mat4x4 preViewProj;</li><li>        FG_Mat4x4 preInvViewProj;</li><li>        VkCommandBuffer vkCommandBuffer = VK_NULL_HANDLE;</li><li>
</li><li>        <span class="hljs-comment">// 传入上一帧真实渲染帧视图投影矩阵</span></li><li>        dispatchDescription.viewProj = preViewProj;</li><li>        <span class="hljs-comment">// 传入上一帧真实渲染帧视图投影逆矩阵</span></li><li>        dispatchDescription.invViewProj = preInvViewProj;</li><li>        <span class="hljs-comment">// 传入用于录入超帧绘制指令的命令缓冲区句柄</span></li><li>        dispatchDescription.vkCommandBuffer = vkCommandBuffer;</li><li>        <span class="hljs-comment">// 传入当前帧序号</span></li><li>        dispatchDescription.frameIdx = <span class="hljs-number">0</span>;</li><li>
</li><li>        <span class="hljs-comment">// 生成预测帧，更新预测帧缓冲区的内存</span></li><li>        errorCode = <span class="hljs-built_in">HMS_FG_Dispatch_VK</span>(m_context, &amp;dispatchDescription);</li><li>        <span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">switch</span> (errorCode) {</li><li>            <span class="hljs-keyword">case</span> FG_SUCCESS: {</li><li>                <span class="hljs-comment">// 绘制预测帧</span></li><li>                <span class="hljs-comment">// ...</span></li><li>
</li><li>                <span class="hljs-comment">// 绘制UI</span></li><li>                <span class="hljs-comment">// ...</span></li><li>
</li><li>                <span class="hljs-comment">// 送显预测帧</span></li><li>                <span class="hljs-comment">// ...</span></li><li>                <span class="hljs-keyword">break</span>;</li><li>            }</li><li>            <span class="hljs-keyword">case</span> FG_COLLECTING_PREVIOUS_FRAMES:</li><li>                <span class="hljs-comment">// 传入真实帧数量未达到固定阈值，无预测帧生成，外插模式传入真实帧数量&lt;3时返回该状态码，此时不要将预测帧送显</span></li><li>                <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">default</span>:</li><li>                <span class="hljs-comment">// 预测帧生成失败</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div></li>     <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/_graphics_accelerate#ga6be707669124e0bb6e5d61c2e24043be" target="_blank">HMS_FG_DestroyContext_VK</a>接口销毁超帧实例，释放内存资源。      <div _ngcontent-ipv-c106="" class="highlight-div"><div _ngcontent-ipv-c106="" class="highlight-div-header"><div _ngcontent-ipv-c106="" class="highlight-div-header-left"><div _ngcontent-ipv-c106="" class="handle-button expand-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ipv-c106="" class="highlight-div-header-right"><div _ngcontent-ipv-c106="" class="handle-button ai-button"></div><div _ngcontent-ipv-c106="" class="handle-button line-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ipv-c106="" class="handle-button theme-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ipv-c106="" class="handle-button copy-button"><div _ngcontent-ipv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ipv-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁超帧上下文实例并释放内存资源</span></li><li>errorCode = <span class="hljs-built_in">HMS_FG_DestroyContext_VK</span>(&amp;m_context);</li><li><span class="hljs-keyword">if</span> (errorCode != FG_SUCCESS) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>