<h1 _ngcontent-idd-c119="" class="doc-title ng-star-inserted" title="Web组件在不同的窗口间迁移"> Web组件在不同的窗口间迁移 </h1>

<div _ngcontent-idd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Web组件能够实现在不同窗口的组件树上进行挂载或移除操作，这一能力使得开发者可以将同一个Web组件在不同窗口间迁移。例如，将浏览器的Tab页拖出成独立窗口，或拖入浏览器的另一个窗口。</p> <p>Web组件在不同窗口间迁移，是基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-node">自定义节点</a>能力实现的。实现的基本原理是：通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode">BuilderNode</a>，开发者可创建Web组件的离线节点，并结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-place-holder">自定义占位节点</a>控制Web节点的挂载与移除。当从一个窗口上移除Web节点，并挂载到另一个窗口中，即完成Web组件在窗口间的迁移。</p> <p>在以下示例中，主窗Ability启动时，通过命令式的方式创建了一个Web组件。开发者可以利用common.ets中提供的方法和类，实现Web组件的挂载和移除。Index.ets则提供了一种挂载和移除Web组件的实现方法。通过这种方式，开发者能够实现Web组件在不同窗口中页面的挂载与移除，即实现了Web组件在不同窗口间的迁移。下图是展示了这一迁移过程的示意图。</p> <p><span><img originheight="408" originwidth="714" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114745.39523077736973875458218680734361:50001231000000:2800:14CB6E8765BC30AA4B8E84280944D0BF4B37B3A92B974FC09AA13167BC25F568.png" width="714" height="408"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>不要将一个Web组件同时挂载在两个父节点下，这会导致非预期行为。</p>  </div></div></div> <div _ngcontent-idd-c106="" class="highlight-div"><div _ngcontent-idd-c106="" class="highlight-div-header"><div _ngcontent-idd-c106="" class="highlight-div-header-left"><div _ngcontent-idd-c106="" class="handle-button expand-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-idd-c106="" class="highlight-div-header-right"><div _ngcontent-idd-c106="" class="handle-button ai-button"></div><div _ngcontent-idd-c106="" class="handle-button line-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-idd-c106="" class="handle-button theme-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-idd-c106="" class="handle-button copy-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-idd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 主窗Ability</span></li><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { createNWeb, defaultUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/common'</span></li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 创建Web动态组件（需传入UIContext），loadContent之后的任意时机均可创建，应用仅创建一个Web组件</span></li><li>      <span class="hljs-title function_">createNWeb</span>(defaultUrl, windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">getUIContext</span>());</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div> <div _ngcontent-idd-c106="" class="highlight-div"><div _ngcontent-idd-c106="" class="highlight-div-header"><div _ngcontent-idd-c106="" class="highlight-div-header-left"><div _ngcontent-idd-c106="" class="handle-button expand-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-idd-c106="" class="highlight-div-header-right"><div _ngcontent-idd-c106="" class="handle-button ai-button"></div><div _ngcontent-idd-c106="" class="handle-button line-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-idd-c106="" class="handle-button theme-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-idd-c106="" class="handle-button copy-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-idd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 提供动态挂载Web组件能力</span></li><li><span class="hljs-comment">// pages/common.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> defaultUrl : <span class="hljs-built_in">string</span> = <span class="hljs-string">'https://www.example.com'</span>;</li><li>
</li><li><span class="hljs-comment">// Data为入参封装类</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>{</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">webController</span>: webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, webController: webview.WebviewController</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span> = url;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webController</span> = webController;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// @Builder中为动态组件的具体组件内容</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">webController</span> })</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>    .<span class="hljs-title function_">borderStyle</span>(<span class="hljs-title class_">BorderStyle</span>.<span class="hljs-property">Dashed</span>)</li><li>    .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">2</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> wrap = wrapBuilder&lt;[<span class="hljs-title class_">Data</span>]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li>
</li><li><span class="hljs-comment">// 用于控制和反馈对应的NodeContainer上的节点的行为，需要与NodeContainer一起使用</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Data</span>]&gt; | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> webController : webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> rootNode : <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">builderNode : BuilderNode&lt;[Data]&gt; | <span class="hljs-literal">undefined</span>, webController : webview.WebviewController | <span class="hljs-literal">undefined</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> = builderNode;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webController</span> = webController;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 必须要重写的方法，用于构建节点数、返回节点挂载在对应NodeContainer中</span></li><li>  <span class="hljs-comment">// 在对应NodeContainer创建的时候调用或者通过rebuild方法调用刷新</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-comment">// 该节点会被挂载在NodeContainer的父节点下</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 挂载Webview</span></li><li>  <span class="hljs-title function_">attachWeb</span>() : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>) {</li><li>      <span class="hljs-keyword">let</span> frameNode : <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>      <span class="hljs-keyword">if</span> (frameNode?.<span class="hljs-title function_">getParent</span>() != <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-comment">// 挂载自定义节点前判断该节点是否已经被挂载</span></li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'The frameNode is already attached'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 卸载Webview</span></li><li>  <span class="hljs-title function_">detachWeb</span>() : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getWebController</span>() : webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">webController</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建Map保存所需要的BuilderNode</span></li><li><span class="hljs-keyword">let</span> builderNodeMap : <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Data</span>]&gt; | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 创建Map保存所需要的webview.WebviewController</span></li><li><span class="hljs-keyword">let</span> webControllerMap : <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li><span class="hljs-comment">// 初始化需要UIContext对象，UIContext对象可通过窗口或自定义组件的getUIContext方法获取</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNWeb</span> = (<span class="hljs-params">url: <span class="hljs-built_in">string</span>, uiContext: UIContext</span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建WebviewController</span></li><li>  <span class="hljs-keyword">let</span> webController = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>() ;</li><li>  <span class="hljs-comment">// 创建BuilderNode</span></li><li>  <span class="hljs-keyword">let</span> builderNode : <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Data</span>]&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>  <span class="hljs-comment">// 创建动态Web组件</span></li><li>  builderNode.<span class="hljs-title function_">build</span>(wrap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(url, webController));</li><li>
</li><li>  <span class="hljs-comment">// 保存BuilderNode</span></li><li>  builderNodeMap.<span class="hljs-title function_">set</span>(url, builderNode);</li><li>  <span class="hljs-comment">// 保存WebviewController</span></li><li>  webControllerMap.<span class="hljs-title function_">set</span>(url, webController);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义获取BuilderNode的接口</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getBuilderNode = (url : <span class="hljs-built_in">string</span>) : <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Data</span>]&gt; | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> builderNodeMap.<span class="hljs-title function_">get</span>(url);</li><li>}</li><li><span class="hljs-comment">// 自定义获取WebviewController的接口</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getWebviewController = (url : <span class="hljs-built_in">string</span>) : webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> webControllerMap.<span class="hljs-title function_">get</span>(url);</li><li>}</li></ol></pre></div></div> <div _ngcontent-idd-c106="" class="highlight-div"><div _ngcontent-idd-c106="" class="highlight-div-header"><div _ngcontent-idd-c106="" class="highlight-div-header-left"><div _ngcontent-idd-c106="" class="handle-button expand-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-idd-c106="" class="highlight-div-header-right"><div _ngcontent-idd-c106="" class="handle-button ai-button"></div><div _ngcontent-idd-c106="" class="handle-button line-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-idd-c106="" class="handle-button theme-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-idd-c106="" class="handle-button copy-button"><div _ngcontent-idd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-idd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用NodeController的Page页</span></li><li><span class="hljs-comment">// pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { getBuilderNode, <span class="hljs-title class_">MyNodeController</span>, defaultUrl, getWebviewController } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common"</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> nodeController : <span class="hljs-title class_">MyNodeController</span> =</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-title function_">getBuilderNode</span>(defaultUrl), <span class="hljs-title function_">getWebviewController</span>(defaultUrl));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Attach Webview"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 注意不要将同一个节点同时挂载在不同的页面上！</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">attachWeb</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">rebuild</span>();</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Detach Webview"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">detachWeb</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">rebuild</span>();</li><li>          })</li><li>        <span class="hljs-comment">// NodeContainer用于与NodeController节点绑定，rebuild会触发makeNode</span></li><li>        <span class="hljs-comment">// Page页通过NodeContainer接口绑定NodeController，实现动态组件页面显示</span></li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div></div></div>