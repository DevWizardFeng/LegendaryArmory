<h1 _ngcontent-eob-c119="" class="doc-title ng-star-inserted" title="Worker常驻线程通过TaskPool进行多任务并发处理"> Worker常驻线程通过TaskPool进行多任务并发处理 </h1>

<div _ngcontent-eob-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ArkTS应用开发过程中，可以选择TaskPool或Worker线程进行多任务并发处理，也可以两种并发能力都选择。</p> <p>本示例将说明在Worker线程中通过TaskPool执行并发任务。</p> <ol><li><p>在主线程中创建Worker线程并发送消息。</p>  <div _ngcontent-eob-c106="" class="highlight-div"><div _ngcontent-eob-c106="" class="highlight-div-header"><div _ngcontent-eob-c106="" class="highlight-div-header-left"><div _ngcontent-eob-c106="" class="handle-button expand-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eob-c106="" class="highlight-div-header-right"><div _ngcontent-eob-c106="" class="handle-button ai-button"></div><div _ngcontent-eob-c106="" class="handle-button line-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eob-c106="" class="handle-button theme-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eob-c106="" class="handle-button copy-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eob-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessageEvents</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 1. 创建Worker实例</span></li><li>          <span class="hljs-keyword">const</span> myWorker = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/Worker.ets'</span>);</li><li>
</li><li>          <span class="hljs-comment">// 2. 接收Worker返回的结果</span></li><li>          myWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'主线程收到最终结果:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">result</span>);</li><li>            myWorker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 选择合适的时机销毁Worker</span></li><li>          };</li><li>
</li><li>          <span class="hljs-comment">// 3. 向Worker发送启动指令</span></li><li>          myWorker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">data</span>: <span class="hljs-number">10</span> });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li><li><p>在Worker线程中调用TaskPool执行并发任务。</p>  <div _ngcontent-eob-c106="" class="highlight-div"><div _ngcontent-eob-c106="" class="highlight-div-header"><div _ngcontent-eob-c106="" class="highlight-div-header-left"><div _ngcontent-eob-c106="" class="handle-button expand-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eob-c106="" class="highlight-div-header-right"><div _ngcontent-eob-c106="" class="handle-button ai-button"></div><div _ngcontent-eob-c106="" class="handle-button line-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eob-c106="" class="handle-button theme-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eob-c106="" class="handle-button copy-button"><div _ngcontent-eob-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eob-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Worker.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessageEvents</span>, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvents</span>) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'start'</span>) {</li><li>    <span class="hljs-comment">// 模拟Worker数据处理</span></li><li>    <span class="hljs-keyword">const</span> processedData = <span class="hljs-title function_">heavyComputation</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);</li><li>
</li><li>    <span class="hljs-comment">// 调用TaskPool执行并发任务</span></li><li>    <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(parallelTask, processedData);</li><li>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Worker线程返回结果: '</span>, result);</li><li>
</li><li>    <span class="hljs-comment">// 将最终结果返回主线程</span></li><li>    workerPort.<span class="hljs-title function_">postMessage</span>({</li><li>      <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>,</li><li>      <span class="hljs-attr">result</span>: result</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">heavyComputation</span>(<span class="hljs-params">base: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; base * <span class="hljs-number">10</span>; i++) {</li><li>    sum += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelTask</span>(<span class="hljs-params">base: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; base; i++) {</li><li>    total += i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? i : -i;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'TaskPool线程计算结果: '</span>, total);</li><li>  <span class="hljs-keyword">return</span> total;</li><li>}</li></ol></pre></div></div>  </li></ol> </div> <div></div></div>