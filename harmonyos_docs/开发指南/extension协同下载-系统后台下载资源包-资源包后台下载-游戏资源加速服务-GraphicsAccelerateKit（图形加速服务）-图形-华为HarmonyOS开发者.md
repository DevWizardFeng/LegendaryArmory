<h1 _ngcontent-vkr-c119="" class="doc-title ng-star-inserted" title="extension协同下载"> extension协同下载 </h1>

<div _ngcontent-vkr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从5.1.1(19)版本开始，新增extension协同下载。</p>    <p>用户在应用市场安装游戏后、或更新游戏后、设备满足闲时条件时，在游戏未启动状态下，若检测到该游戏有资源包需要更新，可使用<strong>应用自身下载器</strong>自动下载资源包。</p>    <div class="tiledSection">     <h2 id="section142791396388">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section142791396388" tips="复制节点链接"></i></h2>          <p><span><img originheight="732" originwidth="1266" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114414.08182120165133333439789709938272:50001231000000:2800:67B7BE52E453C9E65EF05999E5795B5BB8627086DB8BE897AECD6425438F0B29.png" width="920" height="531.9431279620853"></span></p>     <ol>      <li>用户在应用市场安装游戏后、用户在应用市场更新游戏后、系统检测到用户设备符合闲时条件时，游戏资源加速服务开启资源包后台下载。</li>      <li>游戏资源加速服务从<span style="color: rgb(29,29,26);">AppGallery Connect</span>获取相关资源下载配置信息，例如下载类型、CDN类型、 manifestUrl、域名白名单等。具体资源下载配置信息请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/graphics-accelerate-assetdownload-release">发布资源包下载任务</a>。</li>      <li>游戏资源加速服务唤醒ExtensionAbility进程，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1441671271116" target="_blank">onDownloadWithAppControl</a>方法传入manifestUrl资源清单等信息。</li>      <li>游戏实现资源加速ExtensionAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1441671271116" target="_blank">onDownloadWithAppControl</a>方法，调用应用自身下载器下载游戏资源包。若manifestUrl不为空，下载manifestUrl，生成托管在华为CDN的资源下载任务列表；若manifestUrl为空，生成托管在三方CDN的资源下载任务列表。</li>      <li>应用自身下载器查询是否有下载任务，若有下载任务，则异步下载资源并返回结果true给游戏资源加速服务。若没有下载任务，则返回结果false给游戏资源加速服务，游戏资源加速服务将关闭资源包后台下载。</li>      <li>若有下载任务，应用自身下载器下载资源包，并同步下载进度信息给游戏资源加速ExtensionAbility。</li>      <li>在资源加速ExtensionAbility中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section1492357144916" target="_blank">reportDownloadProgress</a>方法，向游戏资源加速服务上报下载进度信息。</li>      <li>应用自身下载器完成下载后，并同步下载完成信息给资源加速ExtensionAbility。</li>      <li>在资源加速ExtensionAbility中调用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section1492357144916" target="_blank">reportDownloadProgress</a>方法，向游戏资源加速服务上报下载完成信息。</li>      <li>游戏资源加速服务接收到下载完成信息后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>方法通知资源加速ExtensionAbility将关闭进程。</li>      <li>游戏资源加速服务关闭资源包后台下载。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1212682065918">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1212682065918" tips="复制节点链接"></i></h2>          <p>具体API说明请详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="53.769999999999996%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="46.23%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1441671271116" target="_blank">onDownloadWithAppControl</a>(requestType: ContentRequestType, manifestUrl: string, assetAccelerationExtensionInfo: AssetAccelerationExtensionInfo): Promise&lt;boolean&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>安装应用、更新应用、设备闲时，执行该方法，触发extension协同下载，如果有资源包下载任务则返回true，否则返回false。使用Promise异步回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section1492357144916" target="_blank">reportDownloadProgress</a>(progressInfo: AppDownloadProgress): void</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>上报应用自身下载器中的下载进度信息。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>(error?: BusinessError&lt;void&gt;): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>在资源加速ExtensionAbility生命周期即将结束时、调度异常退出后，执行该方法，通知关闭资源包后台下载。建议在该方法中执行资源清理等操作。请避免耗时操作。使用Promise异步回调。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section2336527123810">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2336527123810" tips="复制节点链接"></i></h2>          <ol>      <li>在“src/main/module.json5”的extensionAbilities层级中添加资源加速ExtensionAbility信息。       <div _ngcontent-vkr-c106="" class="highlight-div"><div _ngcontent-vkr-c106="" class="highlight-div-header"><div _ngcontent-vkr-c106="" class="highlight-div-header-left"><div _ngcontent-vkr-c106="" class="handle-button expand-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkr-c106="" class="highlight-div-header-right"><div _ngcontent-vkr-c106="" class="handle-button ai-button"></div><div _ngcontent-vkr-c106="" class="handle-button line-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkr-c106="" class="handle-button theme-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkr-c106="" class="handle-button copy-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkr-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"extensionAbilities"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"AssetAccelExtAbility"</span>, <span class="hljs-comment">// 游戏资源加速ExtensionAbility组件的名称。</span></li><li>    <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/extensionability/AssetAccelExtAbility.ets"</span>, <span class="hljs-comment">// 游戏资源加速ExtensionAbility组件所对应的代码路径。</span></li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"assetAcceleration"</span></li><li>  }</li><li>]</li></ol></pre></div></div></li>      <li>在ets目录下新建extensionability文件夹及AssetAccelExtAbility.ets文件，导入assetDownloadManager模块、AssetAccelerationExtensionAbility模块及相关模块，同时新增AssetAccelExtAbility类继承AssetAccelerationExtensionAbility。       <div _ngcontent-vkr-c106="" class="highlight-div"><div _ngcontent-vkr-c106="" class="highlight-div-header"><div _ngcontent-vkr-c106="" class="highlight-div-header-left"><div _ngcontent-vkr-c106="" class="handle-button expand-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkr-c106="" class="highlight-div-header-right"><div _ngcontent-vkr-c106="" class="handle-button ai-button"></div><div _ngcontent-vkr-c106="" class="handle-button line-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkr-c106="" class="handle-button theme-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkr-c106="" class="handle-button copy-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkr-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { assetDownloadManager, <span class="hljs-title class_">AssetAccelerationExtensionAbility</span>, <span class="hljs-title class_">AssetAccelerationExtensionInfo</span>, <span class="hljs-title class_">ContentRequestType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.GraphicsAccelerateKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssetAccelExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AssetAccelerationExtensionAbility</span> {</li><li>};</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1441671271116" target="_blank">onDownloadWithAppControl</a>方法，调用应用自身下载器下载资源包。       <div _ngcontent-vkr-c106="" class="highlight-div"><div _ngcontent-vkr-c106="" class="highlight-div-header"><div _ngcontent-vkr-c106="" class="highlight-div-header-left"><div _ngcontent-vkr-c106="" class="handle-button expand-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkr-c106="" class="highlight-div-header-right"><div _ngcontent-vkr-c106="" class="handle-button ai-button"></div><div _ngcontent-vkr-c106="" class="handle-button line-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkr-c106="" class="handle-button theme-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkr-c106="" class="handle-button copy-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkr-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onDownloadWithAppControl</span>(<span class="hljs-attr">requestType</span>: <span class="hljs-title class_">ContentRequestType</span>, <span class="hljs-attr">manifestUrl</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">assetAccelerationExtensionInfo</span>: <span class="hljs-title class_">AssetAccelerationExtensionInfo</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onDownloadWithAppControl enter, requestType: <span class="hljs-subst">${requestType}</span>, manifestUrl: <span class="hljs-subst">${manifestUrl}</span>.`</span>);</li><li>  <span class="hljs-comment">// 如果有下载任务，则调用应用自身下载器进行资源下载，并返回true，否则返回false。</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">let</span> hasDownloadTask = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">return</span> hasDownloadTask;</li><li>}</li></ol></pre></div></div></li>      <li>应用自身下载器下载过程中和下载完成后，会同步下载信息给资源加速ExtensionAbility。在资源加速ExtensionAbility中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section1492357144916" target="_blank">reportDownloadProgress</a>方法，向游戏资源加速服务上报下载进度信息和下载完成信息。       <div _ngcontent-vkr-c106="" class="highlight-div"><div _ngcontent-vkr-c106="" class="highlight-div-header"><div _ngcontent-vkr-c106="" class="highlight-div-header-left"><div _ngcontent-vkr-c106="" class="handle-button expand-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkr-c106="" class="highlight-div-header-right"><div _ngcontent-vkr-c106="" class="handle-button ai-button"></div><div _ngcontent-vkr-c106="" class="handle-button line-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkr-c106="" class="handle-button theme-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkr-c106="" class="handle-button copy-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkr-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">progressInfo</span>: assetDownloadManager.<span class="hljs-property">AppDownloadProgress</span> = {</li><li>    <span class="hljs-attr">totalBytesWritten</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">totalExpectedBytes</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">totalFiles</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">successCount</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">failureCount</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">status</span>:assetDownloadManager.<span class="hljs-property">AppDownloadStatus</span>.<span class="hljs-property">IN_PROGRESS</span></li><li>  }</li><li>  assetDownloadManager.<span class="hljs-title function_">reportDownloadProgress</span>(progressInfo);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`Succeeded in reporting downloadProgress`</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`Failed to report downloadProgress, errCode:<span class="hljs-subst">${error.code}</span>, errMessage:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>方法，接收游戏资源加速服务关闭资源包后台下载功能的通知。       <div _ngcontent-vkr-c106="" class="highlight-div"><div _ngcontent-vkr-c106="" class="highlight-div-header"><div _ngcontent-vkr-c106="" class="highlight-div-header-left"><div _ngcontent-vkr-c106="" class="handle-button expand-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkr-c106="" class="highlight-div-header-right"><div _ngcontent-vkr-c106="" class="handle-button ai-button"></div><div _ngcontent-vkr-c106="" class="handle-button line-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkr-c106="" class="handle-button theme-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkr-c106="" class="handle-button copy-button"><div _ngcontent-vkr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkr-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onExtensionWillTerminate</span>(error?: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 避免进行耗时处理。</span></li><li>  <span class="hljs-keyword">if</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onExtensionWillTerminate enter, TerminateReason：<span class="hljs-subst">${error?.code}</span>, msg: <span class="hljs-subst">${error?.message}</span>.`</span>);</li><li>    <span class="hljs-comment">// 添加异常终止处理逻辑。</span></li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 添加资源清理等处理逻辑。</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>