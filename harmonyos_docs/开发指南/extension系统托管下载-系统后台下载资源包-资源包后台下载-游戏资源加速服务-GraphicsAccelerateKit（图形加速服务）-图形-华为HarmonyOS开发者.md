<h1 _ngcontent-fuc-c119="" class="doc-title ng-star-inserted" title="extension系统托管下载"> extension系统托管下载 </h1>

<div _ngcontent-fuc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>用户在应用市场安装游戏后、或更新游戏后、设备满足闲时条件时，在游戏未启动状态下，若检测到该游戏有资源包需要更新，将使用<strong>系统下载器</strong>（游戏资源加速服务）自动下载资源包。</p>    <div class="tiledSection">     <h2 id="section142791396388">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section142791396388" tips="复制节点链接"></i></h2>          <p><span><img originheight="654" originwidth="1160" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114414.89392159563597962989349575462649:50001231000000:2800:B40FF6B6C8AA6559EFB2DDAF78BFE123BE7AAD67C3827D55CD3F90C15CEEC292.png" width="920" height="518.6896551724138"></span></p>     <ol>      <li>用户在应用市场安装游戏后、用户在应用市场更新游戏后、系统检测到用户设备符合闲时条件时，游戏资源加速服务开启资源包后台下载。</li>      <li>游戏资源加速服务从<span style="color: rgb(29,29,26);">AppGallery Connect</span>获取相关资源下载配置信息，例如下载类型、CDN类型、 manifestUrl、域名白名单等。具体资源下载配置信息请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/graphics-accelerate-assetdownload-release">发布资源包下载任务</a>。</li>      <li>游戏资源加速服务唤醒ExtensionAbility进程，并通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1643305731014" target="_blank">onDownloadContentRequest</a>方法传入manifestUrl资源清单等信息，以获取下载任务的配置信息列表。</li>      <li>游戏实现资源加速ExtensionAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1643305731014" target="_blank">onDownloadContentRequest</a>方法，生成资源包下载任务列表。若manifestUrl不为空，下载manifestUrl，生成托管在华为CDN的资源下载任务列表；若manifestUrl为空，生成托管在三方CDN的资源下载任务列表。</li>      <li>资源加速ExtensionAbility向游戏资源加速服务返回不超过200条下载任务的配置信息列表<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section14401125712" target="_blank">AssetDownloadConfig</a>。</li>      <li>游戏资源加速服务根据配置信息列表逐一从华为CDN或三方CDN下载资源包。</li>      <li>游戏资源加速服务每完成一个下载任务，均会向资源加速ExtensionAbility通知当前任务的下载状态。</li>      <li>游戏实现资源加速ExtensionAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section7400025191119" target="_blank">onBackgroundDownloadSucceeded</a>方法，接收“成功”状态的下载任务信息，并前往下载路径操作（例如转移、解压）资源文件。游戏实现资源加速ExtensionAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1348813731114" target="_blank">onBackgroundDownloadFailed</a>方法，接收“失败”状态的下载任务信息，并根据失败原因<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section82071855806" target="_blank">DownloadFault</a>自行实现处理逻辑。</li>      <li>游戏资源加速服务完成所有下载任务后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>方法通知资源加速ExtensionAbility。</li>      <li>游戏资源加速服务关闭资源包后台下载功能。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1212682065918">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1212682065918" tips="复制节点链接"></i></h2>          <p>具体API说明请详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="53.769999999999996%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="46.23%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1643305731014" target="_blank">onDownloadContentRequest</a>(requestType: ContentRequestType, manifestUrl: string, assetAccelerationExtensionInfo: AssetAccelerationExtensionInfo): Promise&lt;assetDownloadManager.AssetDownloadConfig[]&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>安装应用、更新应用、设备闲时，执行该方法，获取资源包下载任务列表。返回任务量不超过200条。使用Promise异步回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section7400025191119" target="_blank">onBackgroundDownloadSucceeded</a>(downloadTask: assetDownloadManager.AssetDownloadTask, filePath: string): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>在系统后台下载任务成功时，执行该方法，通知资源加速ExtensionAbility下载成功。使用Promise异步回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1348813731114" target="_blank">onBackgroundDownloadFailed</a>(downloadTask: assetDownloadManager.AssetDownloadTask, fault: assetDownloadManager.DownloadFault): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>在系统后台下载任务失败时，执行该方法，通知资源加速ExtensionAbility下载失败。使用Promise异步回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="53.769999999999996%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>(error?: BusinessError&lt;void&gt;): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="46.23%">          <p>在资源加速ExtensionAbility生命周期即将结束时、调度异常退出后，执行该方法，通知关闭资源包后台下载功能。建议在该方法中执行资源清理等操作。请避免耗时操作。使用Promise异步回调。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section2336527123810">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2336527123810" tips="复制节点链接"></i></h2>          <ol>      <li>在“src/main/module.json5”的extensionAbilities层级中添加资源加速ExtensionAbility信息。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"extensionAbilities"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"AssetAccelExtAbility"</span>, <span class="hljs-comment">// 游戏资源加速ExtensionAbility组件的名称。</span></li><li>    <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/extensionability/AssetAccelExtAbility.ets"</span>, <span class="hljs-comment">// 游戏资源加速ExtensionAbility组件所对应的代码路径。</span></li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"assetAcceleration"</span></li><li>  }</li><li>]</li></ol></pre></div></div></li>      <li>新建extensionability文件夹及AssetAccelExtAbility.ets文件，导入assetDownloadManager模块、AssetAccelerationExtensionAbility模块及相关模块，同时新增AssetAccelExtAbility类继承AssetAccelerationExtensionAbility。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { assetDownloadManager, <span class="hljs-title class_">AssetAccelerationExtensionAbility</span>, <span class="hljs-title class_">AssetAccelerationExtensionInfo</span>, <span class="hljs-title class_">ContentRequestType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.GraphicsAccelerateKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssetAccelExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AssetAccelerationExtensionAbility</span> {</li><li>};</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1643305731014" target="_blank">onDownloadContentRequest</a>方法，收集资源包下载任务列表。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onDownloadContentRequest</span>(<span class="hljs-attr">requestType</span>: <span class="hljs-title class_">ContentRequestType</span>, <span class="hljs-attr">manifestUrl</span>: <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">assetAccelerationExtensionInfo</span>: <span class="hljs-title class_">AssetAccelerationExtensionInfo</span>): <span class="hljs-title class_">Promise</span>&lt;assetDownloadManager.<span class="hljs-property">AssetDownloadConfig</span>[]&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onDownloadContentRequest enter, requestType: <span class="hljs-subst">${requestType}</span>, manifestUrl: <span class="hljs-subst">${manifestUrl}</span>.`</span>);</li><li>  <span class="hljs-comment">// 1.根据manifestUrl获取下载资源包。2.manifestUrl不为空，获取华为CDN侧资源，为空则获取三方CDN侧资源。3.返回资源包下载任务列表。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">downloadConfigArr</span>: <span class="hljs-title class_">Array</span>&lt;assetDownloadManager.<span class="hljs-property">AssetDownloadConfig</span>&gt; = [];</li><li>  <span class="hljs-keyword">return</span> downloadConfigArr;</li><li>}</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section7400025191119" target="_blank">onBackgroundDownloadSucceeded</a>方法，接收“成功”状态的下载任务，并前往下载路径操作（例如转移、解压）资源文件。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onBackgroundDownloadSucceeded</span>(<span class="hljs-attr">downloadTask</span>: assetDownloadManager.<span class="hljs-property">AssetDownloadTask</span>,</li><li>  <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onBackgroundDownloadSucceeded enter, taskId is <span class="hljs-subst">${downloadTask.taskId}</span>, filePath = <span class="hljs-subst">${filePath}</span>`</span>);</li><li>  <span class="hljs-comment">// 添加已下载资源包转移等处理逻辑。</span></li><li>}</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section1348813731114" target="_blank">onBackgroundDownloadFailed</a>方法，接收“失败”状态的下载任务，并根据失败原因<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-assetdownloadmanager#section82071855806" target="_blank">DownloadFault</a>自行实现处理逻辑。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onBackgroundDownloadFailed</span>(<span class="hljs-attr">downloadTask</span>: assetDownloadManager.<span class="hljs-property">AssetDownloadTask</span>,</li><li>  <span class="hljs-attr">fault</span>: assetDownloadManager.<span class="hljs-property">DownloadFault</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onBackgroundDownloadFailed enter, download url: <span class="hljs-subst">${downloadTask.config.url}</span>, err: <span class="hljs-subst">${fault}</span>`</span>);</li><li>  <span class="hljs-comment">// 添加资源包下载失败处理逻辑。</span></li><li>}</li></ol></pre></div></div></li>      <li>游戏实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/graphics-accelerate-extensionability#section144241488119" target="_blank">onExtensionWillTerminate</a>方法，接收游戏资源加速服务关闭资源包后台下载功能的通知。       <div _ngcontent-fuc-c106="" class="highlight-div"><div _ngcontent-fuc-c106="" class="highlight-div-header"><div _ngcontent-fuc-c106="" class="highlight-div-header-left"><div _ngcontent-fuc-c106="" class="handle-button expand-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuc-c106="" class="highlight-div-header-right"><div _ngcontent-fuc-c106="" class="handle-button ai-button"></div><div _ngcontent-fuc-c106="" class="handle-button line-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuc-c106="" class="handle-button theme-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuc-c106="" class="handle-button copy-button"><div _ngcontent-fuc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">onExtensionWillTerminate</span>(error?: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 避免进行耗时处理。</span></li><li>  <span class="hljs-keyword">if</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'AssetAccelDemo'</span>, <span class="hljs-string">`onExtensionWillTerminate enter, TerminateReason：<span class="hljs-subst">${error?.code}</span>, msg: <span class="hljs-subst">${error?.message}</span>.`</span>);</li><li>    <span class="hljs-comment">// 添加异常终止处理逻辑。</span></li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 添加资源清理等处理逻辑。</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>