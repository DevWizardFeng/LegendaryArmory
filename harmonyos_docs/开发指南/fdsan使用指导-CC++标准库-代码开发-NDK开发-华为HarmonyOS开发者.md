<h1 _ngcontent-nmd-c119="" class="doc-title ng-star-inserted" title="fdsan使用指导"> fdsan使用指导 </h1>

<div _ngcontent-nmd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="section1-功能介绍">1. 功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section1-功能介绍" tips="复制节点链接"></i></h2><p>fdsan主要用于检测不同使用者对相同文件描述符的错误操作，如多次关闭（double-close）和关闭后使用（use-after-close）。这些文件描述符可以是操作系统中的文件、目录、网络套接字或其他I/O设备等。在程序中，打开文件或套接字会生成一个文件描述符。如果此文件描述符在使用后出现反复关闭或关闭后使用等情形，会导致内存泄露或文件句柄泄露等安全隐患。这类问题非常隐蔽，难以排查。为此，引入了fdsan这种检测工具。</p> </div>  <div class="tiledSection"><h2 id="section2-实现原理">2. 实现原理<i class="anchor-icon anchor-icon-link" anchorid="section2-实现原理" tips="复制节点链接"></i></h2><p>设计思路：当打开已有文件或创建一个新文件的时候，在得到返回fd后，设置一个关联的tag，来标记fd的属主信息；关闭文件前，检测fd关联的tag，判断是否符合预期(属主信息一致)，符合就继续走正常文件关闭流程；如果不符合就是检测到异常，根据设置，调用对应的异常处理。</p> <p>tag由两部分组成，最高位的8-bit构成type，后面的56-bit构成value。</p> <p>type标识fd通过何种封装形式进行管理，例如FDSAN_OWNER_TYPE_FILE表示fd通过普通文件进行管理。类型在fdsan_owner_type中定义。</p> <p>value用于标识实际的owner tag。</p> <p> tag构成图示</p> <p><span><img originheight="262" originwidth="988" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114336.90162540568672635068224208585489:50001231000000:2800:CB3FAAB27B2EA6B669042E1D2ABD41D0F381E949B0627F2B0319FB8E85DEF5C7.png" width="920" height="243.9676113360324"></span></p> </div>  <div class="tiledSection"><h2 id="section3-接口说明">3. 接口说明<i class="anchor-icon anchor-icon-link" anchorid="section3-接口说明" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="fdsan_set_error_level" class="firsth2">fdsan_set_error_level<i class="anchor-icon anchor-icon-link" anchorid="fdsan_set_error_level" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">enum</span> fdsan_error_level <span class="hljs-title function_">fdsan_set_error_level</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> fdsan_error_level new_level)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 可以通过fdsan_set_error_level设定error_level，error_level用于控制检测到异常后的处理行为。默认error_level为FDSAN_ERROR_LEVEL_WARN_ALWAYS。</p> <p><strong>参数：</strong> fdsan_error_level</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.5.1.3.1.1" valign="top" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.4.5.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">FDSAN_ERROR_LEVEL_DISABLED</td> <td class="cellrowborder" valign="top" width="50%">disabled，此level代表什么都不处理。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_ERROR_LEVEL_WARN_ONCE</td> <td class="cellrowborder" valign="top" width="50%">warn-once，第一次出现错误时在hilog中发出警告，然后将级别降低为disabled(FDSAN_ERROR_LEVEL_DISABLED)。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_ERROR_LEVEL_WARN_ALWAYS</td> <td class="cellrowborder" valign="top" width="50%">warn-always，每次出现错误时都在hilog中发出警告。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_ERROR_LEVEL_FATAL</td> <td class="cellrowborder" valign="top" width="50%">fatal，出现错误时调用abort异常退出。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 返回旧的error_level。</p> </div>  <div class="tiledSection"><h3 id="fdsan_get_error_level">fdsan_get_error_level<i class="anchor-icon anchor-icon-link" anchorid="fdsan_get_error_level" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">enum</span> fdsan_error_level <span class="hljs-title function_">fdsan_get_error_level</span><span class="hljs-params">()</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 可以通过fdsan_get_error_level获取error level。</p> <p><strong>返回值：</strong> 当前的error_level。</p> </div>  <div class="tiledSection"><h3 id="fdsan_create_owner_tag">fdsan_create_owner_tag<i class="anchor-icon anchor-icon-link" anchorid="fdsan_create_owner_tag" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">fdsan_create_owner_tag</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> fdsan_owner_type type, <span class="hljs-type">uint64_t</span> tag)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 通过传入的type和tag字段，拼接成一个有效的文件描述符的关闭tag。</p> <p><strong>参数：</strong> fdsan_owner_type</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.1" valign="top" width="50%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_GENERIC_00</td> <td class="cellrowborder" valign="top" width="50%">默认未使用fd对应的type值。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_GENERIC_FF</td> <td class="cellrowborder" valign="top" width="50%">默认非法fd对应的type值。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_FILE</td> <td class="cellrowborder" valign="top" width="50%">默认普通文件对应的type值，使用fopen或fdopen打开的文件具有该类型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_DIRECTORY</td> <td class="cellrowborder" valign="top" width="50%">默认文件夹对应的type值，使用opendir或fdopendir打开的文件具有该类型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_UNIQUE_FD</td> <td class="cellrowborder" valign="top" width="50%">默认unique_fd对应的type值，保留暂未使用。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">FDSAN_OWNER_TYPE_ZIPARCHIVE</td> <td class="cellrowborder" valign="top" width="50%">默认zip压缩文件对应的type值，保留暂未使用。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 返回创建的tag，可以用于fdsan_exchange_owner_tag函数的输入。</p> </div>  <div class="tiledSection"><h3 id="fdsan_exchange_owner_tag">fdsan_exchange_owner_tag<i class="anchor-icon anchor-icon-link" anchorid="fdsan_exchange_owner_tag" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">fdsan_exchange_owner_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint64_t</span> expected_tag, <span class="hljs-type">uint64_t</span> new_tag)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 修改文件描述符的关闭tag。</p> <p>通过fd找到对应的FdEntry，判断close_tag值与expected_tag是否一致。如果一致，说明符合预期，可以使用new_tag值重新设定对应的FdEntry。</p> <p>如果不符合，说明检测到异常，后续进行对应的异常处理。</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.7.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.7.7.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.7.7.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">fd</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">int</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">fd句柄，作为FdEntry的索引。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">expected_tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">期望的ownership tag值。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">new_tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">设置新的ownership tag值。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="fdsan_close_with_tag">fdsan_close_with_tag<i class="anchor-icon anchor-icon-link" anchorid="fdsan_close_with_tag" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> <span class="hljs-title function_">fdsan_close_with_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint64_t</span> tag)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 根据tag描述符关闭文件描述符。</p> <p>通过fd找到匹配的FdEntry。如果close_tag与tag相同，则符合预期，可以继续执行文件描述符关闭流程；否则，表示检测到异常。</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.6.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">fd</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">int</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">待关闭的fd句柄。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">期望的ownership tag。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 0或者-1，0表示close成功，-1表示close失败。</p> </div>  <div class="tiledSection"><h3 id="fdsan_get_owner_tag">fdsan_get_owner_tag<i class="anchor-icon anchor-icon-link" anchorid="fdsan_get_owner_tag" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">fdsan_get_owner_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 根据文件描述符获取tag信息。</p> <p>通过fd找到匹配的FdEntry，并获取其close_tag。</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.6.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.9.6.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.9.6.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">ownership tag。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 返回对应fd的tag。</p> </div>  <div class="tiledSection"><h3 id="fdsan_get_tag_type">fdsan_get_tag_type<i class="anchor-icon anchor-icon-link" anchorid="fdsan_get_tag_type" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title function_">fdsan_get_tag_type</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> tag)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 根据tag计算出对应的type类型。</p> <p>获取tag信息后，计算并获取对应tag的type信息。</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.6.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.10.6.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.10.6.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">ownership tag。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 返回对应tag的type。</p> </div>  <div class="tiledSection"><h3 id="fdsan_get_tag_value">fdsan_get_tag_value<i class="anchor-icon anchor-icon-link" anchorid="fdsan_get_tag_value" tips="复制节点链接"></i></h3><div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">fdsan_get_tag_value</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> tag)</span>;</li></ol></pre></div></div> <p><strong>描述：</strong> 根据tag计算出对应的owner value。</p> <p>通过获取到的tag信息，通过偏移计算获取对应tag中的value信息。</p> <p><strong>参数：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.11.6.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.11.6.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.11.6.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">tag</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">uint64_t</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">ownership tag。</td> </tr>  </tbody></table></div> </div> <p><strong>返回值：</strong> 返回对应tag的value。</p> </div>  <div class="tiledSection"><h2 id="section4-使用示例">4. 使用示例<i class="anchor-icon anchor-icon-link" anchorid="section4-使用示例" tips="复制节点链接"></i></h2><p>如何使用fdsan？这是一个简单的double-close问题：</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">good_write</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);</li><li>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">"log"</span>, O_WRONLY | O_APPEND);</li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">3</span>);</li><li>    <span class="hljs-type">ssize_t</span> ret = <span class="hljs-built_in">write</span>(fd, <span class="hljs-string">"fdsan test"</span>, <span class="hljs-number">11</span>);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"good write but failed?!"</span>);</li><li>    }</li><li>    <span class="hljs-built_in">close</span>(fd);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">bad_close</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">"/dev/null"</span>, O_RDONLY);</li><li>    <span class="hljs-built_in">close</span>(fd);</li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-comment">// This close expected to be detect by fdsan</span></li><li>    <span class="hljs-built_in">close</span>(fd);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">functional_test</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::vector&lt;std::thread&gt; threads;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> function : { good_write, bad_close }) {</li><li>        threads.<span class="hljs-built_in">emplace_back</span>(function);</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; thread : threads) {</li><li>        thread.<span class="hljs-built_in">join</span>();</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">functional_test</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>上述代码中的good_write函数会打开一个文件并写入一些字符串，而bad_close函数中也会打开一个文件同时包含double-close问题，这两个线程同时运行执行情况如下图。</p> <p><span><img originheight="412" originwidth="748" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114336.52660674453068497331765667893759:50001231000000:2800:9888729D58AFF54852AFADF40FD785FDE5BA5FC21EC4BFBCD958E703D19EEE29.png" width="748" height="412"></span></p> <p>由于每次open返回的文件描述符（fd）是顺序分配的，进入主函数后第一个可用的fd是43。在bad_close 函数中，第一次open返回的fd也是43。关闭之后，43变成可用的fd。在good_write函数中，open返回了第一个可用的fd，即43。然而，由于bad_close函数中存在重复关闭问题，错误地关闭了另一个线程中打开的文件，导致写入失败。</p> <p>引入fdsan后，有两种检测方法：使用标准库接口或实现带有fdsan的函数接口。</p> </div>  <div class="tiledSection"><h3 id="使用标准库接口" class="firsth2">使用标准库接口<i class="anchor-icon anchor-icon-link" anchorid="使用标准库接口" tips="复制节点链接"></i></h3><p>标准库接口中，fopen、fdopen、opendir、fdopendir已集成fdsan。使用这些接口而非直接使用open有助于检测问题。例如，可以使用fopen替代open。</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEMP_FILE <span class="hljs-string">"/data/local/tmp/test.txt"</span></span></li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">good_write</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-comment">// fopen is protected by fdsan, replace open with fopen</span></li><li>    <span class="hljs-comment">// int fd = open(TEMP_FILE, O_RDWR);</span></li><li>    FILE *f = fopen(TEMP_FILE, <span class="hljs-string">"w+"</span>);</li><li>    <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fopen failed errno=%d\n"</span>, errno);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// ssize_t ret = write(fd, "fdsan test\n", 11);</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">fprintf</span>(f, <span class="hljs-string">"fdsan test %d\n"</span>, <span class="hljs-number">11</span>);</li><li>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fprintf failed errno=%d\n"</span>, errno);</li><li>    }</li><li>    <span class="hljs-comment">// close(fd);</span></li><li>    fclose(f);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="日志信息">日志信息<i class="anchor-icon anchor-icon-link" anchorid="日志信息" tips="复制节点链接"></i></h3><p>使用fopen打开的每个文件描述符都需要有一个与之对应的 tag 。fdsan 在 close 时会检查关闭的 fd 是否与 tag 匹配，不匹配就会默认提示相关日志信息。下面是上述代码的日志信息：</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li># hilog | grep MUSL-FDSAN</li><li>04-30 15:03:41.760 10933  1624 E C03f00/MUSL-FDSAN: attempted to close file descriptor 43,                             expected to be unowned, actually owned by FILE* 0x00000000f7b90aa2</li></ol></pre></div></div> <p>从这里的错误信息中可以看出，FILE接口的文件被其他人错误地关闭了。FILE接口的地址可以协助进一步定位。</p> <p>此外，可以在代码中使用fdsan_set_error_level设置错误等级error_level。设置为Fatal之后，如果fdsan检测到错误，会提示日志信息并crash生成堆栈信息，用于定位。下面是 error_level 设置为Fatal之后生成的crash堆栈信息：</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>Reason:Signal:SIGABRT(SI_TKILL)@0x0000076e from:1902:20010043</li><li>Fault thread info:</li><li>Tid:15312, Name:e.myapplication</li><li>#00 pc 000e65bc /system/lib/ld-musl-arm.so.1(raise+176)(3de40c79448a2bbced06997e583ef614)</li><li>#01 pc 0009c3bc /system/lib/ld-musl-arm.so.1(abort+16)(3de40c79448a2bbced06997e583ef614)</li><li>#02 pc 0009de4c /system/lib/ld-musl-arm.so.1(fdsan_error+116)(3de40c79448a2bbced06997e583ef614)</li><li>#03 pc 0009e2e8 /system/lib/ld-musl-arm.so.1(fdsan_close_with_tag+836)(3de40c79448a2bbced06997e583ef614)</li><li>#04 pc 0009e56c /system/lib/ld-musl-arm.so.1(close+20)(3de40c79448a2bbced06997e583ef614)</li><li>#05 pc 000055d8 /data/storage/el1/bundle/libs/arm/libentry.so(bad_close()+96)(f3339aac824c099f449153e92718e1b56f80b2ba)</li><li>#06 pc 00006cf4 /data/storage/el1/bundle/libs/arm/libentry.so(decltype(std::declval&lt;void (*)()&gt;()()) std::__n1::__invoke[abi:v15004]&lt;void (*)()&gt;(void (*&amp;&amp;)())+24)(f3339aac824c099f449153e92718e1b56f80b2ba)</li><li>#07 pc 00006c94 /data/storage/el1/bundle/libs/arm/libentry.so(f3339aac824c099f449153e92718e1b56f80b2ba)</li><li>#08 pc 000067b8 /data/storage/el1/bundle/libs/arm/libentry.so(void* std::__n1::__thread_proxy[abi:v15004]&lt;std::__n1::tuple&lt;std::__n1::unique_ptr&lt;std::__n1::__thread_struct, std::__n1::default_delete&lt;std::__n1::__thread_struct&gt;&gt;, void (*)()&gt;&gt;(void*)+100)(f3339aac824c099f449153e92718e1b56f80b2ba)</li><li>#09 pc 00105a6c /system/lib/ld-musl-arm.so.1(start+248)(3de40c79448a2bbced06997e583ef614)</li><li>#10 pc 000700b0 /system/lib/ld-musl-arm.so.1(3de40c79448a2bbced06997e583ef614)</li></ol></pre></div></div> <p>此时，从crash信息中可以看到bad_close存在问题，同时crash中包含所有打开的文件，协助定位问题，提升效率。</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>OpenFiles:</li><li>0-&gt;/dev/null native object of unknown type 0</li><li>1-&gt;/dev/null native object of unknown type 0</li><li>2-&gt;/dev/null native object of unknown type 0</li><li>3-&gt;socket:[28102] native object of unknown type 0</li><li>4-&gt;socket:[28103] native object of unknown type 0</li><li>5-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>6-&gt;/sys/kernel/debug/tracing/trace_marker native object of unknown type 0</li><li>7-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>8-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>9-&gt;/dev/console native object of unknown type 0</li><li>10-&gt;pipe:[95598] native object of unknown type 0</li><li>11-&gt;pipe:[95598] native object of unknown type 0</li><li>12-&gt;socket:[18542] native object of unknown type 0</li><li>13-&gt;pipe:[96594] native object of unknown type 0</li><li>14-&gt;socket:[18545] native object of unknown type 0</li><li>15-&gt;pipe:[96594] native object of unknown type 0</li><li>16-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>17-&gt;/dev/binder native object of unknown type 0</li><li>18-&gt;/data/storage/el1/bundle/entry.hap native object of unknown type 0</li><li>19-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>20-&gt;anon_inode:[signalfd] native object of unknown type 0</li><li>21-&gt;socket:[29603] native object of unknown type 0</li><li>22-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>23-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>24-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>25-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>26-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>27-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>28-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>29-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>30-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>31-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>32-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>33-&gt;anon_inode:[eventpoll] native object of unknown type 0</li><li>34-&gt;anon_inode:[eventfd] native object of unknown type 0</li><li>35-&gt;socket:[97409] native object of unknown type 0</li><li>36-&gt;socket:[94716] native object of unknown type 0</li><li>38-&gt;socket:[94720] native object of unknown type 0</li><li>40-&gt;/data/storage/el1/bundle/entry_test.hap native object of unknown type 0</li><li>41-&gt;socket:[95617] native object of unknown type 0</li><li>42-&gt;/sys/kernel/debug/tracing/trace_marker native object of unknown type 0</li><li>43-&gt;/dev/null FILE* 4155724704</li><li>44-&gt;socket:[94737] native object of unknown type 0</li><li>45-&gt;pipe:[95634] native object of unknown type 0</li><li>46-&gt;pipe:[95634] native object of unknown type 0</li><li>47-&gt;pipe:[95635] native object of unknown type 0</li><li>49-&gt;pipe:[95636] native object of unknown type 0</li><li>50-&gt;pipe:[95636] native object of unknown type 0</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="实现具有fdsan的函数接口">实现具有fdsan的函数接口<i class="anchor-icon anchor-icon-link" anchorid="实现具有fdsan的函数接口" tips="复制节点链接"></i></h3><p>除了使用标准库函数，还可以实现具有fdsan的函数接口。fdsan机制通过fdsan_exchange_owner_tag和fdsan_close_with_tag实现。fdsan_exchange_owner_tag设置fd的tag，fdsan_close_with_tag检查关闭文件时的tag。</p> <p>下面是一个实现具有fdsan功能的函数接口的示例：</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fdsan_fd</span> {</li><li>    <span class="hljs-built_in">fdsan_fd</span>() = <span class="hljs-keyword">default</span>;</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">fdsan_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-built_in">reset</span>(fd);</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">fdsan_fd</span>(<span class="hljs-type">const</span> fdsan_fd&amp; copy) = <span class="hljs-keyword">delete</span>;</li><li>    <span class="hljs-built_in">fdsan_fd</span>(fdsan_fd&amp;&amp; move)</li><li>    {</li><li>        *<span class="hljs-keyword">this</span> = std::<span class="hljs-built_in">move</span>(move);</li><li>    }</li><li>
</li><li>    ~<span class="hljs-built_in">fdsan_fd</span>()</li><li>    {</li><li>        <span class="hljs-built_in">reset</span>();</li><li>    }</li><li>
</li><li>    fdsan_fd&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> fdsan_fd&amp; copy) = <span class="hljs-keyword">delete</span>;</li><li>    fdsan_fd&amp; <span class="hljs-keyword">operator</span>=(fdsan_fd&amp;&amp; move)</li><li>    {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == &amp;move) {</li><li>            <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;</li><li>        }</li><li>        <span class="hljs-built_in">reset</span>();</li><li>        <span class="hljs-keyword">if</span> (move.fd_ != <span class="hljs-number">-1</span>) {</li><li>            fd_ = move.fd_;</li><li>            move.fd_ = <span class="hljs-number">-1</span>;</li><li>            <span class="hljs-comment">// Acquire ownership from the moved-from object.</span></li><li>            <span class="hljs-built_in">exchange_tag</span>(fd_, move.<span class="hljs-built_in">tag</span>(), <span class="hljs-built_in">tag</span>());</li><li>        }</li><li>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> fd_;</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reset</span><span class="hljs-params">(<span class="hljs-type">int</span> new_fd = <span class="hljs-number">-1</span>)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">if</span> (fd_ != <span class="hljs-number">-1</span>) {</li><li>            <span class="hljs-built_in">close</span>(fd_, <span class="hljs-built_in">tag</span>());</li><li>            fd_ = <span class="hljs-number">-1</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (new_fd != <span class="hljs-number">-1</span>) {</li><li>            fd_ = new_fd;</li><li>            <span class="hljs-comment">// Acquire ownership of the presumably unowned fd.</span></li><li>            <span class="hljs-built_in">exchange_tag</span>(fd_, <span class="hljs-number">0</span>, <span class="hljs-built_in">tag</span>());</li><li>        }</li><li>    }</li><li>
</li><li>  <span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-type">int</span> fd_ = <span class="hljs-number">-1</span>;</li><li>
</li><li>    <span class="hljs-comment">// Use the address of object as the file tag</span></li><li>    <span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">tag</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(<span class="hljs-keyword">this</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">exchange_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint64_t</span> old_tag, <span class="hljs-type">uint64_t</span> new_tag)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">if</span> (&amp;fdsan_exchange_owner_tag) {</li><li>            <span class="hljs-built_in">fdsan_exchange_owner_tag</span>(fd, old_tag, new_tag);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint64_t</span> tag)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">if</span> (&amp;fdsan_close_with_tag) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">fdsan_close_with_tag</span>(fd, tag);</li><li>        }</li><li>    }</li><li>};</li></ol></pre></div></div> <p>这里的实现中使用fdsan_exchange_owner_tag在开始时将fd与结构体对象地址绑定，然后在关闭文件时使用fdsan_close_with_tag进行检测，预期tag是结构体对象地址。</p> <p>在实现具有fdsan的函数接口后，可以使用该接口包装fd。</p> <div _ngcontent-nmd-c106="" class="highlight-div"><div _ngcontent-nmd-c106="" class="highlight-div-header"><div _ngcontent-nmd-c106="" class="highlight-div-header-left"><div _ngcontent-nmd-c106="" class="handle-button expand-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmd-c106="" class="highlight-div-header-right"><div _ngcontent-nmd-c106="" class="handle-button ai-button"></div><div _ngcontent-nmd-c106="" class="handle-button line-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmd-c106="" class="handle-button theme-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmd-c106="" class="handle-button copy-button"><div _ngcontent-nmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEMP_FILE <span class="hljs-string">"/data/local/tmp/test.txt"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">good_write</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// int fd = open(DEV_NULL_FILE, O_RDWR);</span></li><li>    <span class="hljs-function">fdsan_fd <span class="hljs-title">fd</span><span class="hljs-params">(open(TEMP_FILE, O_CREAT | O_RDWR))</span></span>;</li><li>    <span class="hljs-keyword">if</span> (fd.<span class="hljs-built_in">get</span>() == <span class="hljs-number">-1</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fopen failed errno=%d\n"</span>, errno);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">ssize_t</span> ret = <span class="hljs-built_in">write</span>(fd.<span class="hljs-built_in">get</span>(), <span class="hljs-string">"fdsan test\n"</span>, <span class="hljs-number">11</span>);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"write failed errno=%d\n"</span>, errno);</li><li>    }</li><li>    fd.<span class="hljs-built_in">reset</span>();</li><li>}</li></ol></pre></div></div> <p>此时运行该程序可以检测到另一个线程的double-close问题，详细信息可以<a href="/consumer/cn/doc/harmonyos-guides/fdsan#日志信息">参考日志</a>。同样也可以设置error_level为fatal，这样可以使fdsan在检测到crash之后主动crash以获取更多信息。</p> </div>  <div class="tiledSection"><h2 id="section5-close函数信号安全性说明">5. close函数信号安全性说明<i class="anchor-icon anchor-icon-link" anchorid="section5-close函数信号安全性说明" tips="复制节点链接"></i></h2><p>在POSIX标准中，close函数原本被定义为信号安全函数（async-signal-safe），这意味着它可以安全地在信号处理函数（signal handler）中调用。然而，在集成了fdsan（File Descriptor Sanitizer）机制的系统实现中，这一性质发生了变化。</p> <p>由于fdsan的实现依赖于mmap系统调用，而mmap本身不是信号安全函数，这会导致close函数也不再是信号安全的。因此，在信号处理函数中避免使用 close，可以通过其他系统调用来实现相同功能。</p> </div> </div> <div></div></div>