<h1 _ngcontent-twx-c119="" class="doc-title ng-star-inserted" title="gdb调试"> gdb调试 </h1>

<div _ngcontent-twx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section3145mcpsimp">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section3145mcpsimp" tips="复制节点链接"></i></h2><p>可使用gdb单步调试算子计算精度。由于cpu调测已转为多进程调试，每个核都会拉起独立的子进程，故gdb需要转换成子进程调试的方式。</p> </div> <div class="tiledSection"><h2 id="section3148mcpsimp">使用方法（命令行）<i class="anchor-icon anchor-icon-link" anchorid="section3148mcpsimp" tips="复制节点链接"></i></h2><ul><li>调试单独一个子进程<div class="p">在gdb启动后，首先设置跟踪子进程，之后再打断点，就会停留在子进程中，设置的命令为：<div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>set follow-fork-mode child</li></ol></pre></div></div> </div> <p>但是这种方式只会停留在遇到断点的第一个子进程中，其余子进程和主进程会继续执行直到退出。涉及到核间同步的算子无法使用这种方法进行调试。</p> </li></ul> <ul><li>调试多个子进程<p>如果涉及到核间同步，那么需要能同时调试多个子进程。</p> <p>在gdb启动后，首先设置调试模式为只调试一个进程，挂起其他进程。设置的命令如下。</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) set detach-on-fork off</li></ol></pre></div></div> <p>查看当前调试模式的命令为：</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) show detach-on-fork</li></ol></pre></div></div> <p>中断gdb程序的方式要使用捕捉事件的方式，即gdb程序监控fork这一事件并中断。这样在每一次起子进程时就可以中断gdb程序。设置的命令为：</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) catch fork</li></ol></pre></div></div> <p>当执行r后，可以查看当前的进程信息：</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) info inferiors</li><li>Num Description</li><li>* 1 process 19613</li></ol></pre></div></div> <p>可以看到，当第一次执行fork的时候，程序断在了主进程fork的位置，子进程还未生成。 执行c后，再次查看info inferiors，可以看到此时第一个子进程已经启动。</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) info inferiors</li><li>Num Description</li><li>* 1 process 19613</li><li>2 process 19626</li></ol></pre></div></div> <p>这个时候可以使用切换到第二个进程，也就是第一个子进程，再打上断点进行调试，此时主进程是暂停状态：</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) inferior 2</li><li>[Switching to inferior 2 [process 19626] ($HOME/demo)]</li><li>(gdb) info inferiors</li><li>Num Description</li><li>1 process 19613</li><li>* 2 process 19626</li></ol></pre></div></div> <p>请注意，inferior后跟的数字是进程的序号，而不是进程号。 如果遇到同步阻塞，可以切换回主进程继续生成子进程，然后再切换到新的子进程进行调试，等到同步条件完成后，再切回第一个子进程继续执行。</p> <p>如下是调试一个单独子进程的调试命令样例：</p> <p>add_custom_cpu获取方法见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cpu-twin-debugging">CPU孪生调试功能</a>，位于调试工作路径debug_workspace下的AddCustom/cpu/build/add_custom_cpu。</p> <div _ngcontent-twx-c106="" class="highlight-div"><div _ngcontent-twx-c106="" class="highlight-div-header"><div _ngcontent-twx-c106="" class="highlight-div-header-left"><div _ngcontent-twx-c106="" class="handle-button expand-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-twx-c106="" class="highlight-div-header-right"><div _ngcontent-twx-c106="" class="handle-button ai-button"></div><div _ngcontent-twx-c106="" class="handle-button line-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-twx-c106="" class="handle-button theme-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-twx-c106="" class="handle-button copy-button"><div _ngcontent-twx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-twx-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>gdb --args add_custom_cpu</li><li>set follow-fork-mode child</li><li>break add_custom.cpp:45</li><li>run</li><li>list</li><li>backtrace</li><li>print i</li><li>break add_custom.cpp:56</li><li>continue</li><li>display xLocal</li><li>quit</li></ol></pre></div></div> </li></ul> </div> </div> <div></div></div>