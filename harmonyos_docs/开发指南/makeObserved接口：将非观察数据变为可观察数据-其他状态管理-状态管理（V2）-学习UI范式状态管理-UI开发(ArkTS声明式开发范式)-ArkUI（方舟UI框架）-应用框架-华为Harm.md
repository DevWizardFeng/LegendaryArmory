<h1 _ngcontent-qpn-c119="" class="doc-title ng-star-inserted" title="makeObserved接口：将非观察数据变为可观察数据"> makeObserved接口：将非观察数据变为可观察数据 </h1>

<div _ngcontent-qpn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>为了将普通不可观察数据变为可观察数据，开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-statemanagement#makeobserved" target="_blank">makeObserved接口</a>。</p>    <p>makeObserved可以在@Trace无法标记的情况下使用。在阅读本文档前，建议提前阅读：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@Trace</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>从API version 12开始，开发者可以使用UIUtils中的makeObserved接口将普通不可观察数据变为可观察数据。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>状态管理框架已提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2/@Trace</a>用于观察类属性变化，makeObserved接口提供主要应用于@ObservedV2/@Trace无法涵盖的场景：</p>       <ul>        <li>         <p>class的定义在三方包中：开发者无法手动对class中需要观察的属性加上@Trace标签，可以使用makeObserved使得当前对象可以被观察。</p></li>        <li>         <p>当前类的成员属性不能被修改：因为@Trace观察类属性会动态修改类的属性，这个行为在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable装饰器">@Sendable</a>装饰的class中是不被允许的，此时可以使用makeObserved。</p></li>        <li>         <p>interface或者JSON.parse返回的匿名对象：这类场景往往没有明确的class声明，开发者无法使用@Trace标记当前属性可以被观察，此时可以使用makeObserved。</p></li>       </ul></li>      <li>       <p>使用makeObserved接口需要导入UIUtils。</p>       <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="限制条件">限制条件<i class="anchor-icon anchor-icon-link" anchorid="限制条件" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>makeObserved仅支持非空的对象类型传参。</p>       <ul>        <li>不支持undefined和null：返回自身，不做任何处理。</li>        <li>非Object类型：编译拦截报错。</li>       </ul>       <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">let</span> res1 = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 非法类型入参，错误用法，编译报错</span></li><li><span class="hljs-keyword">let</span> res2 = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-literal">undefined</span>); <span class="hljs-comment">// 非法类型入参，错误用法，返回自身，res2 === undefined</span></li><li><span class="hljs-keyword">let</span> res3 = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 非法类型入参，错误用法，返回自身，res3 === null</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">rawInfo</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>()); <span class="hljs-comment">// 正确用法</span></li></ol></pre></div></div></li>      <li>       <p>makeObserved不支持传入被<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed</a>装饰的类的实例和被makeObserved封装过的代理数据。为了防止数据被双重代理，makeObserved发现入参为上述情况时则直接返回，不做处理。</p>       <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 错误用法：makeObserved发现传入的实例是@ObservedV2装饰的类的实例，则返回传入对象自身</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">observedInfo</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>());</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info2</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 正确用法：传入对象既不是@ObservedV2/@Observed装饰的类的实例，也不是makeObserved封装过的代理数据</span></li><li><span class="hljs-comment">// 返回可观察数据</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">observedInfo1</span>: <span class="hljs-title class_">Info2</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info2</span>());</li><li><span class="hljs-comment">// 错误用法：传入对象为makeObserved封装过的代理数据，此次makeObserved不做处理</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">observedInfo2</span>: <span class="hljs-title class_">Info2</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(observedInfo1);</li></ol></pre></div></div></li>      <li>       <p>makeObserved可以用在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-create-custom-components#component">@Component</a>装饰的自定义组件中，但不能和状态管理V1的状态变量装饰器配合使用，如果一起使用，则会抛出运行时异常。</p>       <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 错误写法，运行时异常</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>));</li></ol></pre></div></div>       <p>注意：下面message2的写法不会抛异常。原因是：</p>       <ul>        <li>this.message是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a>装饰的，其实现等同于@Observed。</li>        <li>UIUtils.makeObserved的入参如果是@Observed装饰的class的实例，会直接返回自身。</li>       </ul>       <p>因此message2的初始值不是makeObserved返回的代理对象，而是@State装饰的this.message。</p>       <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>}</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">person</span>: <span class="hljs-title class_">Person</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message2</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>); <span class="hljs-comment">// 不会抛异常</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message2.person.age}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// UI不会刷新，因为State只能观察到第一层的变化</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message2</span>.<span class="hljs-property">person</span>.<span class="hljs-property">age</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="makeobserved仅对入参对象进行深度观察" class="firsth2">makeObserved仅对入参对象进行深度观察<i class="anchor-icon anchor-icon-link" anchorid="makeobserved仅对入参对象进行深度观察" tips="复制节点链接"></i></h3>          <ul>      <li>message被<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-local">@Local</a>装饰，本身具有观察自身赋值的能力。其初始值为makeObserved的返回值，具有深度观察能力。需要注意，makeObserved仅对message进行深度观察，而message自身赋值的变化，则是由@Local观察的。</li>      <li>点击change id可以触发UI刷新。</li>      <li>点击change Info，将this.message重新赋值为不可观察数据后，再次点击change id，无法触发UI刷新。</li>      <li>再次点击change Info1，将this.message重新赋值为可观察数据，再次点击change id，可以触发UI刷新。</li>     </ul>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>));</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`change id`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">id</span>++;</li><li>      })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`change Info <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.id}</span>`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">30</span>);</li><li>      })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`change Info1 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.id}</span>`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">30</span>));</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="支持类型和观察变化">支持类型和观察变化<i class="anchor-icon anchor-icon-link" anchorid="支持类型和观察变化" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="支持类型" class="firsth2">支持类型<i class="anchor-icon anchor-icon-link" anchorid="支持类型" tips="复制节点链接"></i></h3>          <ul>      <li>支持未被<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2</a>装饰的类。</li>      <li>支持Array、Map、Set和Date。</li>      <li>支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-collections-array" target="_blank">collections.Array</a>, <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-collections-set" target="_blank">collections.Set</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-collections-map" target="_blank">collections.Map</a>。</li>      <li>JSON.parse返回的Object。</li>      <li>@Sendable装饰的类。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="观察变化">观察变化<i class="anchor-icon anchor-icon-link" anchorid="观察变化" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>makeObserved传入内置类型或collections类型的实例时，可以观测其API带来的变化：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.2.1.3.1.1" valign="top" width="50%">类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.2.1.3.1.2" valign="top" width="50%">可观测变化的API</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">Array</td>           <td class="cellrowborder" valign="top" width="50%">push、pop、shift、unshift、splice、copyWithin、fill、reverse、sort</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">collections.Array</td>           <td class="cellrowborder" valign="top" width="50%">push、pop、shift、unshift、splice、fill、reverse、sort、shrinkTo、extendTo</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">Map/collections.Map</td>           <td class="cellrowborder" valign="top" width="50%">set、clear、delete</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">Set/collections.Set</td>           <td class="cellrowborder" valign="top" width="50%">add、clear、delete</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">Date</td>           <td class="cellrowborder" valign="top" width="50%">setFullYear、setMonth、setDate、setHours、setMinutes、setSeconds、setMilliseconds、setTime、setUTCFullYear、setUTCMonth、setUTCDate、setUTCHours、setUTCMinutes、setUTCSeconds、setUTCMilliseconds</td>          </tr>                 </tbody></table></div>       </div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="makeobserved和sendable装饰的class配合使用" class="firsth2">makeObserved和@Sendable装饰的class配合使用<i class="anchor-icon anchor-icon-link" anchorid="makeobserved和sendable装饰的class配合使用" tips="复制节点链接"></i></h3>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable">@Sendable</a>主要是为了处理应用场景中的并发任务。将makeObserved和@Sendable配合使用，可以满足一般应用开发中，在子线程做大数据处理，在UI线程做ViewModel的显示和观察数据的需求。@Sendable具体内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multi-thread-concurrency-overview">并发任务文档</a>。</p>     <p>本章节将说明下面的场景：</p>     <ul>      <li>makeObserved在传入@Sendable类型的数据后有观察能力，且其变化可以触发UI刷新。</li>      <li>从子线程中获取一个整体数据，然后对UI线程的可观察数据做整体替换。</li>      <li>从子线程获取的数据重新执行makeObserved，将数据变为可观察数据。</li>      <li>将数据从主线程传递回子线程时，仅传递不可观察的数据。makeObserved的返回值不可直接传给子线程。</li>     </ul>     <p>例子如下：</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SendableData.ets</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableData</span>  {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Tom'</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>  <span class="hljs-attr">gender</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-comment">// ....更多其他属性</span></li><li>  <span class="hljs-attr">likes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-attr">follow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SendableData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">threadGetData</span>(<span class="hljs-params">param: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">SendableData</span> {</li><li>  <span class="hljs-comment">// 在子线程处理数据</span></li><li>  <span class="hljs-keyword">let</span> ret = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableData</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Concurrent threadGetData, param <span class="hljs-subst">${param}</span>`</span>);</li><li>  ret.<span class="hljs-property">name</span> = param + <span class="hljs-string">'-o'</span>;</li><li>  ret.<span class="hljs-property">age</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">40</span>);</li><li>  ret.<span class="hljs-property">likes</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>);</li><li>  <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">ObservedSendableTest</span> {</li><li>  <span class="hljs-comment">// 通过makeObserved给普通对象或是Sendable对象添加可观察能力</span></li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">send</span>: <span class="hljs-title class_">SendableData</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableData</span>());</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">send</span>.<span class="hljs-property">name</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change name'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// ok 可以观察到属性的改变</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">send</span>.<span class="hljs-property">name</span> += <span class="hljs-string">'0'</span>;</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'task'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 将待执行的函数放入taskpool内部任务队列等待，等待分发到工作线程执行。</span></li><li>        taskpool.<span class="hljs-title function_">execute</span>(threadGetData, <span class="hljs-variable language_">this</span>.<span class="hljs-property">send</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> {</li><li>          <span class="hljs-comment">// 和@Local一起使用，可以观察this.send的变化</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">send</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(val <span class="hljs-keyword">as</span> <span class="hljs-title class_">SendableData</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>需要注意：数据的构建和处理可以在子线程中完成，但有观察能力的数据不能传给子线程，只有在主线程里才可以操作可观察的数据。所以上述例子中只是将this.send的属性name传给子线程操作。</p>    </div>    <div class="tiledSection">     <h3 id="makeobserved和collectionsarraysetmap配合使用">makeObserved和collections.Array/Set/Map配合使用<i class="anchor-icon anchor-icon-link" anchorid="makeobserved和collectionsarraysetmap配合使用" tips="复制节点链接"></i></h3>          <p>collections提供ArkTS容器集，可用于并发场景下的高性能数据传递。详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-collections" target="_blank">@arkts.collections文档</a>。</p>     <p>makeObserved可以在ArkUI中导入可观察的collections容器，但makeObserved不能和状态管理V1的状态变量装饰器如@State和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>等配合使用，否则会抛出运行时异常。</p>     <p><strong>collections.Array</strong></p>     <p>collections.Array可以触发UI刷新的API有：</p>     <ul>      <li>改变数组长度：push、pop、shift、unshift、splice、shrinkTo、extendTo</li>      <li>改变数组项本身：sort、fill</li>     </ul>     <p>其他API不会改变原始数组，所以不会触发UI刷新。</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'cc'</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>();</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">arrCollect</span>: collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">Info</span>&gt; =</li><li>    <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">Info</span>&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">2</span>)));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// ForEach接口仅支持Array&lt;any&gt;，不支持collections.Array&lt;any&gt;。</span></li><li>      <span class="hljs-comment">// 但ForEach的实现用到的Array的API，collections.Array都有提供。所以可以使用as类型断言Array。</span></li><li>      <span class="hljs-comment">// 需要注意断言并不会改变原本的数据类型。</span></li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Info</span>&gt;, <span class="hljs-function">(<span class="hljs-params">item: Info</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item.id}</span>`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          item.<span class="hljs-property">id</span>++;</li><li>        })</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: Info, index</span>) =&gt;</span> item.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>() + index.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Divider</span>()</li><li>        .<span class="hljs-title function_">color</span>(<span class="hljs-string">'blue'</span>)</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`the first one <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.arrCollect[<span class="hljs-number">0</span>].id}</span>`</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`the last one <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.arrCollect[<span class="hljs-variable language_">this</span>.arrCollect.length - <span class="hljs-number">1</span>].id}</span>`</span>)</li><li>      }</li><li>      <span class="hljs-title class_">Divider</span>()</li><li>        .<span class="hljs-title function_">color</span>(<span class="hljs-string">'blue'</span>)</li><li>
</li><li>      <span class="hljs-comment">/****************************改变数据长度的api**************************/</span></li><li>      <span class="hljs-title class_">Scroll</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>) {</li><li>        <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">10</span>}) {</li><li>          <span class="hljs-comment">// push: 新增新元素</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'push'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">30</span>));</li><li>          })</li><li>          <span class="hljs-comment">// pop: 删除最后一个</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'pop'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">pop</span>();</li><li>          })</li><li>          <span class="hljs-comment">// shift: 删除第一个</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'shift'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">shift</span>();</li><li>          })</li><li>          <span class="hljs-comment">// unshift: 在数组的开头插入新项</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'unshift'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">unshift</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">50</span>));</li><li>          })</li><li>          <span class="hljs-comment">// splice: 从数组的指定位置删除元素</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'splice'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>);</li><li>          })</li><li>
</li><li>          <span class="hljs-comment">// shrinkTo: 将数组长度缩小到给定的长度</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'shrinkTo'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">shrinkTo</span>(<span class="hljs-number">1</span>);</li><li>          })</li><li>          <span class="hljs-comment">// extendTo: 将数组长度扩展到给定的长度</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'extendTo'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">extendTo</span>(<span class="hljs-number">6</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>));</li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Divider</span>()</li><li>            .<span class="hljs-title function_">color</span>(<span class="hljs-string">'blue'</span>)</li><li>
</li><li>          <span class="hljs-comment">/****************************************改变数组item本身*****************/</span></li><li>          <span class="hljs-comment">// sort：从大到小排序</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'sort'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a: Info, b: Info</span>) =&gt;</span> b.<span class="hljs-property">id</span> - a.<span class="hljs-property">id</span>);</li><li>          })</li><li>          <span class="hljs-comment">// fill: 用值填充指定部分</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'fill'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">fill</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">5</span>), <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);</li><li>          })</li><li>
</li><li>          <span class="hljs-comment">/*****************************不会改变数组本身API***************************/</span></li><li>          <span class="hljs-comment">// slice：返回新的数组，根据start end对原数组的拷贝，不会改变原数组，所以直接调用slice不会触发UI刷新</span></li><li>          <span class="hljs-comment">// 可以构建用例为返回的浅拷贝的数据赋值给this.arrCollect,需要注意这里依然要调用makeObserved，否则this.arr被普通变量赋值后，会丧失观察能力</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'slice'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>));</li><li>          })</li><li>          <span class="hljs-comment">// map：原理同上</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'map'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {</li><li>              value.<span class="hljs-property">id</span> += <span class="hljs-number">10</span>;</li><li>              <span class="hljs-keyword">return</span> value;</li><li>            }))</li><li>          })</li><li>          <span class="hljs-comment">// filter：原理同上</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'filter'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">value: Info</span>) =&gt;</span> value.<span class="hljs-property">id</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>));</li><li>          })</li><li>
</li><li>          <span class="hljs-comment">// concat：原理同上</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'concat'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> array1 = <span class="hljs-keyword">new</span> collections.<span class="hljs-title class_">Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">100</span>))</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arrCollect</span>.<span class="hljs-title function_">concat</span>(array1));</li><li>          })</li><li>        }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'200%'</span>)</li><li>      }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'60%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>collections.Map</strong></p>     <p>collections.Map可以触发UI刷新的API有：set、clear、delete。</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">CollectionMap</span> {</li><li>  <span class="hljs-attr">mapCollect</span>: collections.<span class="hljs-property">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt; = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> collections.<span class="hljs-property">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt;([[<span class="hljs-string">'a'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">10</span>)], [<span class="hljs-string">'b'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>)]]));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// this.mapCollect.keys()返回迭代器。Foreach不支持迭代器，所以要Array.from浅拷贝生成数据。</span></li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">keys</span>()), <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.mapCollect.get(item)?.id}</span>`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">Info</span>|<span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">get</span>(item);</li><li>          <span class="hljs-keyword">if</span> (value) {</li><li>            value.<span class="hljs-property">id</span>++;</li><li>          }</li><li>        })</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index</span>) =&gt;</span> item + index.<span class="hljs-title function_">toString</span>())</li><li>
</li><li>      <span class="hljs-comment">// set c</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'set c'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'c'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">30</span>));</li><li>      })</li><li>      <span class="hljs-comment">// delete c</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete c'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">has</span>(<span class="hljs-string">'c'</span>)) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'c'</span>);</li><li>        }</li><li>      })</li><li>      <span class="hljs-comment">// clear</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">mapCollect</span>.<span class="hljs-title function_">clear</span>();</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>collections.Set</strong></p>     <p>collections.Set可以触发UI刷新的API有：add、clear、delete。</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">set</span>: collections.<span class="hljs-property">Set</span>&lt;<span class="hljs-title class_">Info</span>&gt; = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> collections.<span class="hljs-property">Set</span>&lt;<span class="hljs-title class_">Info</span>&gt;([<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">10</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>)]));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 因为ForEach不支持迭代器，所以需要使用Array.from浅拷贝生成数组。</span></li><li>      <span class="hljs-comment">// 但是浅拷贝生成的新的数组没有观察能力，为了ForEach组件在访问item的时候是可观察的数据，所以需要重新调用makeObserved。</span></li><li>      <span class="hljs-title class_">ForEach</span>((<span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-title function_">values</span>()))), <span class="hljs-function">(<span class="hljs-params">item: Info</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item.id}</span>`</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          item.<span class="hljs-property">id</span>++;</li><li>        })</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: Info, index</span>) =&gt;</span> item.<span class="hljs-property">id</span> + index.<span class="hljs-title function_">toString</span>())</li><li>
</li><li>      <span class="hljs-comment">// add</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">30</span>));</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'size:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-property">size</span>);</li><li>      })</li><li>      <span class="hljs-comment">// delete</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> iterator = <span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-title function_">keys</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-title function_">delete</span>(iterator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>);</li><li>      })</li><li>      <span class="hljs-comment">// clear</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'clear'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">set</span>.<span class="hljs-title function_">clear</span>();</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="makeobserved的入参为jsonparse的返回值">makeObserved的入参为JSON.parse的返回值<i class="anchor-icon anchor-icon-link" anchorid="makeobserved的入参为jsonparse的返回值" tips="复制节点链接"></i></h3>          <p>JSON.parse返回Object，无法使用@Trace装饰其属性，可以使用makeObserved使其变为可观察数据。</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">test</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = { <span class="hljs-string">'a'</span>: <span class="hljs-number">123</span> };</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">testJsonStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(test);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">test2</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt; = { <span class="hljs-string">'a'</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>) };</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">test2JsonStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(test2);</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-property">makeObserved</span>&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;&gt;(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(testJsonStr) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;);</li><li>  <span class="hljs-attr">message2</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt; = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-property">makeObserved</span>&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt;&gt;(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(test2JsonStr) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Info</span>&gt;);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.a}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">a</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message2.a.id}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message2</span>.<span class="hljs-property">a</span>.<span class="hljs-property">id</span>++;</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="makeobserved和v2装饰器配合使用">makeObserved和V2装饰器配合使用<i class="anchor-icon anchor-icon-link" anchorid="makeobserved和v2装饰器配合使用" tips="复制节点链接"></i></h3>          <p>makeObserved可以和V2的装饰器一起使用。对于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-monitor">@Monitor</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-computed">@Computed</a>，因为makeObserved传入@Observed或ObservedV2装饰的类实例会返回其自身，所以@Monitor或者@Computed不能定义在class中，只能定义在自定义组件里。</p>     <p>例子如下：</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>));</li><li>
</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'message.id'</span>)</li><li>  <span class="hljs-title function_">onStrChange</span>(<span class="hljs-params">monitor: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`name change from <span class="hljs-subst">${monitor.value()?.before}</span> to <span class="hljs-subst">${monitor.value()?.now}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">ageId</span>() {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'---------Computed----------'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">id</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">age</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`id: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.id}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">id</span>++;</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`age: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.age}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">age</span>++;</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Computed age+id: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.ageId}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change Info'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">200</span>));</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Child</span>({<span class="hljs-attr">message</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>})</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Require</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Child id: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.id}</span>`</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="makeobserved在component内使用">makeObserved在@Component内使用<i class="anchor-icon anchor-icon-link" anchorid="makeobserved在component内使用" tips="复制节点链接"></i></h3>          <p>makeObserved不能和V1的状态变量装饰器一起使用，但可以在@Component装饰的自定义组件里使用。</p>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// 如果和@State一起使用会抛出运行时异常</span></li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>(<span class="hljs-number">20</span>));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message.id}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-property">id</span>++;</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="gettarget后的数据可以正常赋值但是无法触发ui刷新" class="firsth2">getTarget后的数据可以正常赋值，但是无法触发UI刷新<i class="anchor-icon anchor-icon-link" anchorid="gettarget后的数据可以正常赋值但是无法触发ui刷新" tips="复制节点链接"></i></h3>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-gettarget">getTarget</a>可以获取状态管理框架代理前的原始对象。</p>     <p>makeObserved封装的观察对象，可以通过getTarget获取到其原始对象，对原始对象的赋值不会触发UI刷新。</p>     <p>如下面例子：</p>     <ol>      <li>先点击第一个Text组件，通过getTarget获取其原始对象，此时修改原始对象的属性不会触发UI刷新，但数据会正常赋值。</li>      <li>再点击第二个Text组件，此时修改this.observedObj的属性会触发UI刷新，Text显示21。</li>     </ol>     <div _ngcontent-qpn-c106="" class="highlight-div"><div _ngcontent-qpn-c106="" class="highlight-div-header"><div _ngcontent-qpn-c106="" class="highlight-div-header-left"><div _ngcontent-qpn-c106="" class="handle-button expand-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qpn-c106="" class="highlight-div-header-right"><div _ngcontent-qpn-c106="" class="handle-button ai-button"></div><div _ngcontent-qpn-c106="" class="handle-button line-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qpn-c106="" class="handle-button theme-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qpn-c106="" class="handle-button copy-button"><div _ngcontent-qpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qpn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">observedObj</span>: <span class="hljs-title class_">Info</span> = <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">makeObserved</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Info</span>());</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.observedObj.id}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 通过getTarget获取其原始对象，将this.observedObj赋值为不可观察的数据</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">rawObj</span>: <span class="hljs-title class_">Info</span>= <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">getTarget</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">observedObj</span>);</li><li>          <span class="hljs-comment">// 不会触发UI刷新，但数据会正常赋值</span></li><li>          rawObj.<span class="hljs-property">id</span> = <span class="hljs-number">20</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.observedObj.id}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 触发UI刷新，Text显示21</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">observedObj</span>.<span class="hljs-property">id</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>