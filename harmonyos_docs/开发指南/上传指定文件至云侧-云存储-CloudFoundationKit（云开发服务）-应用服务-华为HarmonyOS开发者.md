<h1 _ngcontent-ysf-c119="" class="doc-title ng-star-inserted" title="上传指定文件至云侧"> 上传指定文件至云侧 </h1>

<div _ngcontent-ysf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以快速将本地设备上的文件上传至云侧，上传完后，可以前往AppGallery Connect的“云存储”页面，查看上传的文档内容。</p>    <div class="tiledSection">     <h2 id="section1337743192918">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section1337743192918" tips="复制节点链接"></i></h2>          <p id="ZH-CN_TOPIC_0000002474214245__zh-cn_topic_0000002440774444_p176909276175">支持Phone、Tablet设备。并且从5.1.0(18)版本开始，新增支持Wearable设备；从5.1.1(19)版本开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section1049017100361">前提条件<i class="anchor-icon anchor-icon-link" anchorid="section1049017100361" tips="复制节点链接"></i></h2>          <p>已<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cloudfoundation-storage-initialize-bucket">初始化存储实例</a>。</p>    </div>    <div class="tiledSection">     <h2 id="section10146755375">操作步骤<i class="anchor-icon anchor-icon-link" anchorid="section10146755375" tips="复制节点链接"></i></h2>          <ol>      <li>选择待上传的文件，下方示例代码中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoviewpicker" target="_blank">photoAccessHelper.PhotoViewPicker</a>指定需要上传的文件。</li>      <li>将待上传的文件复制到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-context#属性" target="_blank">context.cacheDir</a>目录下。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>由于StorageBucket.uploadFile接口传入参数localPath只能设置为context.cacheDir目录下的文件路径，所以上传前需要先将文件复制到context.cacheDir目录下。</p>        </div></div></div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/cloudfoundation-cloudstorage#section2105131521913" target="_blank">StorageBucket.uploadFile</a>接口创建上传任务，监听上传任务的progress、completed、failed等事件。</li>      <li>启动上传任务。</li>     </ol>     <p>完整的示例代码如下：</p>     <div _ngcontent-ysf-c106="" class="highlight-div"><div _ngcontent-ysf-c106="" class="highlight-div-header"><div _ngcontent-ysf-c106="" class="highlight-div-header-left"><div _ngcontent-ysf-c106="" class="handle-button expand-button"><div _ngcontent-ysf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ysf-c106="" class="highlight-div-header-right"><div _ngcontent-ysf-c106="" class="handle-button ai-button"></div><div _ngcontent-ysf-c106="" class="handle-button line-button"><div _ngcontent-ysf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ysf-c106="" class="handle-button theme-button"><div _ngcontent-ysf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ysf-c106="" class="handle-button copy-button"><div _ngcontent-ysf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ysf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cloudStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CloudFoundationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">GlobalContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/GlobalContext'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">storageBucket</span>: cloudStorage.<span class="hljs-property">StorageBucket</span> = cloudStorage.<span class="hljs-title function_">bucket</span>();</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct testPage {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 上传指定文件至云侧</span></li><li>  <span class="hljs-title function_">upload</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectPhoto</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> fileUri = photoSelectResult.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>];</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`pick file <span class="hljs-subst">${fileUri}</span>`</span>);</li><li>      <span class="hljs-keyword">let</span> fileName = fileUri.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`file name <span class="hljs-subst">${fileName}</span>`</span>);</li><li>      <span class="hljs-keyword">let</span> cacheFile = <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>().<span class="hljs-property">cacheDir</span> + <span class="hljs-string">'/'</span> + fileName;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`cacheFile <span class="hljs-subst">${cacheFile}</span>`</span>);</li><li>      <span class="hljs-comment">// 将选中文件copy至cache目录下</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">copyFile</span>(fileUri, cacheFile);</li><li>      <span class="hljs-comment">// 上传至云存储默认实例</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uploadFile</span>(cacheFile, <span class="hljs-string">`screenshot/<span class="hljs-subst">${fileName}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to upload file, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> photoViewPicker select throws</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">selectPhoto</span>(): <span class="hljs-title class_">Promise</span>&lt;photoAccessHelper.<span class="hljs-property">PhotoSelectResult</span>&gt; {</li><li>    <span class="hljs-comment">// 使用photoAccessHelper选择指定的文件</span></li><li>    <span class="hljs-keyword">let</span> photoSelectOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>    photoSelectOptions.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>; <span class="hljs-comment">// 过滤选择媒体文件类型为IMAGE</span></li><li>    photoSelectOptions.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 选择媒体文件的最大数目</span></li><li>    <span class="hljs-keyword">let</span> photoViewPicker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>    <span class="hljs-keyword">return</span> photoViewPicker.<span class="hljs-title function_">select</span>(photoSelectOptions);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">copyFile</span>(<span class="hljs-params">srcPath: <span class="hljs-built_in">string</span>, dstPath: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> srcFile = fs.<span class="hljs-title function_">openSync</span>(srcPath);</li><li>      <span class="hljs-keyword">let</span> dstFile = fs.<span class="hljs-title function_">openSync</span>(dstPath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>      fs.<span class="hljs-title function_">copyFileSync</span>(srcFile.<span class="hljs-property">fd</span>, dstFile.<span class="hljs-property">fd</span>);</li><li>      fs.<span class="hljs-title function_">closeSync</span>(srcFile);</li><li>      fs.<span class="hljs-title function_">closeSync</span>(dstFile);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`copy file failed <span class="hljs-subst">${e.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">uploadFile</span>(<span class="hljs-params">localPath: <span class="hljs-built_in">string</span>, cloudPath: <span class="hljs-built_in">string</span></span>) {</li><li>    storageBucket.<span class="hljs-title function_">uploadFile</span>(<span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>(), {</li><li>      <span class="hljs-attr">localPath</span>: localPath, <span class="hljs-comment">// 本地文件路径（context.cacheDir目录下的文件路径）</span></li><li>      <span class="hljs-attr">cloudPath</span>: cloudPath   <span class="hljs-comment">// 云侧路径，支持传入“文件目录/文件名”（如“screenshot/demo.jpg”），或仅传入文件名。</span></li><li>    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>      task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`on progress <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(progress)}</span>`</span>);</li><li>      });</li><li>      task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`on completed <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(progress)}</span>`</span>);</li><li>        <span class="hljs-comment">// 删除cache目录临时文件</span></li><li>        fs.<span class="hljs-title function_">unlink</span>(localPath).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to unlink, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>        });</li><li>      });</li><li>      task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'failed'</span>, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`on failed <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(progress)}</span>`</span>);</li><li>        <span class="hljs-comment">// 删除cache目录临时文件</span></li><li>        fs.<span class="hljs-title function_">unlink</span>(localPath).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to unlink, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>        });</li><li>      });</li><li>      task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'response'</span>, <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`on response <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(response)}</span>`</span>);</li><li>      });</li><li>
</li><li>      <span class="hljs-comment">// start task</span></li><li>      task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>            <span class="hljs-string">`Failed to start a file upload task, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Succeeded in starting a file upload task.`</span>);</li><li>        }</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to upload file, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上传完成，可以登录<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>，选择项目，进入“云存储”界面查看文件列表。</p>      </div></div></div>    </div>   </div>   <div></div></div>