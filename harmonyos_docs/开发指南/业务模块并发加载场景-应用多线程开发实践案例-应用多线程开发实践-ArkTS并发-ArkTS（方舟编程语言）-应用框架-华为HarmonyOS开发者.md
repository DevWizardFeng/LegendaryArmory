<h1 _ngcontent-war-c119="" class="doc-title ng-star-inserted" title="业务模块并发加载场景"> 业务模块并发加载场景 </h1>

<div _ngcontent-war-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在应用启动时，多个业务模块需要加载，例如地图应用中的定位、打车、导航等模块。如果全部在UI主线程初始化，会严重影响应用冷启动时间。此时，应在不同子线程中并行加载这些模块，以降低启动耗时。</p> <p>通过使用ArkTS提供的TaskPool能力，可以将不同的业务初始化任务移到子线程中。业务模块可通过下沉C++实现为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/transferabled-object">NativeBinding对象</a>或在ArkTS层定义为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable">Sendable对象</a>，从而将初始化的模块返回给UI主线程调用，实现如下。</p> <ol><li><p>各业务功能（SDK）模块定义（这里以使用Sendable对象为例）。</p> <p>计算器业务模块定义如下：</p>  <div _ngcontent-war-c106="" class="highlight-div"><div _ngcontent-war-c106="" class="highlight-div-header"><div _ngcontent-war-c106="" class="highlight-div-header-left"><div _ngcontent-war-c106="" class="handle-button expand-button"><div _ngcontent-war-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-war-c106="" class="highlight-div-header-right"><div _ngcontent-war-c106="" class="handle-button ai-button"></div><div _ngcontent-war-c106="" class="handle-button line-button"><div _ngcontent-war-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-war-c106="" class="handle-button theme-button"><div _ngcontent-war-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-war-c106="" class="handle-button copy-button"><div _ngcontent-war-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-war-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sdk/Calculator.ets</span></li><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {</li><li>  history?: collections.<span class="hljs-property">Array</span>&lt;collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;;</li><li>  <span class="hljs-attr">totalCount</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">init</span>(): <span class="hljs-title class_">Calculator</span> {</li><li>    <span class="hljs-keyword">let</span> calc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();</li><li>    calc.<span class="hljs-property">totalCount</span> = <span class="hljs-number">0</span>;</li><li>    calc.<span class="hljs-property">history</span> = collections.<span class="hljs-property">Array</span>.<span class="hljs-title function_">create</span>(calc.<span class="hljs-property">totalCount</span>, collections.<span class="hljs-property">Array</span>.<span class="hljs-title function_">create</span>(<span class="hljs-number">2</span>, <span class="hljs-string">""</span>));</li><li>    <span class="hljs-keyword">return</span> calc;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> result = a + b;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCalc</span>(<span class="hljs-string">`<span class="hljs-subst">${a}</span> + <span class="hljs-subst">${b}</span>`</span>, <span class="hljs-string">`<span class="hljs-subst">${result}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">sub</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> result = a - b;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCalc</span>(<span class="hljs-string">`<span class="hljs-subst">${a}</span> - <span class="hljs-subst">${b}</span>`</span>, <span class="hljs-string">`<span class="hljs-subst">${result}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">mul</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> result = a * b;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCalc</span>(<span class="hljs-string">`<span class="hljs-subst">${a}</span> * <span class="hljs-subst">${b}</span>`</span>, <span class="hljs-string">`<span class="hljs-subst">${result}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">div</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> result = a / b;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCalc</span>(<span class="hljs-string">`<span class="hljs-subst">${a}</span> / <span class="hljs-subst">${b}</span>`</span>, <span class="hljs-string">`<span class="hljs-subst">${result}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getHistory</span>(): collections.<span class="hljs-property">Array</span>&lt;collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>!;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">showHistory</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalCount</span>; i++) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.history![i][<span class="hljs-number">0</span>]}</span> = <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.history![i][<span class="hljs-number">1</span>]}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">newCalc</span>(<span class="hljs-params">opt: <span class="hljs-built_in">string</span>, ret: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> newRecord = <span class="hljs-keyword">new</span> collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;(opt, ret);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalCount</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>!.<span class="hljs-title function_">unshift</span>(newRecord);</li><li>  }</li><li>}</li></ol></pre></div></div>    <p>定时器业务模块的定义如下：</p>  <div _ngcontent-war-c106="" class="highlight-div"><div _ngcontent-war-c106="" class="highlight-div-header"><div _ngcontent-war-c106="" class="highlight-div-header-left"><div _ngcontent-war-c106="" class="handle-button expand-button"><div _ngcontent-war-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-war-c106="" class="highlight-div-header-right"><div _ngcontent-war-c106="" class="handle-button ai-button"></div><div _ngcontent-war-c106="" class="handle-button line-button"><div _ngcontent-war-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-war-c106="" class="handle-button theme-button"><div _ngcontent-war-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-war-c106="" class="handle-button copy-button"><div _ngcontent-war-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-war-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sdk/TimerSdk.ets</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerSdk</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">init</span>(): <span class="hljs-title class_">TimerSdk</span> {</li><li>    <span class="hljs-keyword">let</span> timer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerSdk</span>();</li><li>    <span class="hljs-keyword">return</span> timer;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">countDown</span>(<span class="hljs-params">time: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: (value: <span class="hljs-built_in">boolean</span>) =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);</li><li>      }, time);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>   </li><li><p>在UI主线程触发各业务模块分发到子线程，加载完成后在UI主线程使用，示例如下：</p>  <div _ngcontent-war-c106="" class="highlight-div"><div _ngcontent-war-c106="" class="highlight-div-header"><div _ngcontent-war-c106="" class="highlight-div-header-left"><div _ngcontent-war-c106="" class="handle-button expand-button"><div _ngcontent-war-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-war-c106="" class="highlight-div-header-right"><div _ngcontent-war-c106="" class="handle-button ai-button"></div><div _ngcontent-war-c106="" class="handle-button line-button"><div _ngcontent-war-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-war-c106="" class="handle-button theme-button"><div _ngcontent-war-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-war-c106="" class="handle-button copy-button"><div _ngcontent-war-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-war-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Calculator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../sdk/Calculator'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">TimerSdk</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../sdk/TimerSdk'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">initCalculator</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Calculator</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Calculator</span>.<span class="hljs-title function_">init</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">initTimerSdk</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">TimerSdk</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">TimerSdk</span>.<span class="hljs-title function_">init</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  calc?: <span class="hljs-title class_">Calculator</span></li><li>  timer?: <span class="hljs-title class_">TimerSdk</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    taskpool.<span class="hljs-title function_">execute</span>(initCalculator).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">calc</span> = ret <span class="hljs-keyword">as</span> <span class="hljs-title class_">Calculator</span>;</li><li>    })</li><li>    taskpool.<span class="hljs-title function_">execute</span>(initTimerSdk).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = ret <span class="hljs-keyword">as</span> <span class="hljs-title class_">TimerSdk</span>;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"calculate add"</span>)</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'add'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">alignRules</span>({</li><li>            <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>            <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>          })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-property">calc</span>?.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Result is <span class="hljs-subst">${result}</span>`</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"show history"</span>)</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'show'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">alignRules</span>({</li><li>            <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>            <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>          })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">calc</span>?.<span class="hljs-title function_">showHistory</span>();</li><li>          })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"countdown"</span>)</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'get'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">alignRules</span>({</li><li>            <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>            <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>          })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Timer start`</span>);</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>?.<span class="hljs-title function_">countDown</span>(<span class="hljs-number">1000</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Timer end`</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> <div></div></div>