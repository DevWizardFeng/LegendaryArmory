<h1 _ngcontent-jbc-c119="" class="doc-title ng-star-inserted" title="主体分割"> 主体分割 </h1>

<div _ngcontent-jbc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1384112112520">适用场景<i class="anchor-icon anchor-icon-link" anchorid="section1384112112520" tips="复制节点链接"></i></h2>          <p>主体分割，可以检测出图片中区别于背景的前景物体或区域（即“显著主体”），并将其从背景中分离出来，适用于需要识别和提取图像主要信息的场景，广泛使用于前景目标检测和前景主体分离的场景。例如：</p>     <ul>      <li>主体贴纸，从图片中提取显著性的主体，去掉背景。</li>      <li>背景替换，替换并提取出主体对象的背景。</li>      <li>显著性检测，快速定位图片中显著性区域。</li>      <li>辅助图片编辑，例如单独对主体进行美化处理。</li>     </ul>     <p>效果如下图所示：</p>     <p><span><img originheight="661" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114226.59023934055958358819404570891146:50001231000000:2800:D40031E4AEBA698BF1BD9CDCAEB01858AD48A88C3497A1E5707250A1A2493759.png" width="320" height="661"></span></p>    </div>    <div class="tiledSection">     <h2 id="section2020122517405">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2020122517405" tips="复制节点链接"></i></h2>          <p>该能力当前不支持模拟器。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="38.96%">          <p>AI能力</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="61.040000000000006%">          <p>约束</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="38.96%">          <p>主体分割</p></td>         <td class="cellrowborder" valign="top" width="61.040000000000006%">          <ul>           <li>某个物体占比不小于原图大小的千分之五才会被认定为“主体”，才会支持分割。</li>           <li>不建议用于处理包含较多文字内容的图片分析场景。</li>           <li>输入图像具有合适成像的质量（建议720p以上），<span style="color: rgb(55,65,81);">20px</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">高度</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">9000px，20px</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">宽度</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">9000px</span>，高宽比例建议3:1以下（高度小于宽度的3倍），接近手机屏幕高宽比例为宜。</li>          </ul></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section15741222179">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section15741222179" tips="复制节点链接"></i></h2>          <ol>      <li><span>引用相关类添加至工程。</span>       <p></p>       <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { subjectSegmentation } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreVisionKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>准备预处理的图片资源，将图片转换为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>，并添加初始化和释放方法。</span>       <p></p>       <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> initResult = <span class="hljs-keyword">await</span> subjectSegmentation.<span class="hljs-title function_">init</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'subjectSegmentationSample'</span>, <span class="hljs-string">`Subject segmentation initialization result:<span class="hljs-subst">${initResult}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">await</span> subjectSegmentation.<span class="hljs-title function_">release</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'subjectSegmentationSample'</span>, <span class="hljs-string">'Subject segmentation released successfully'</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectImage</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openPhoto</span>()</li><li>  <span class="hljs-keyword">if</span> (uri === <span class="hljs-literal">undefined</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"uri is undefined"</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(uri);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">openPhoto</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-title class_">PhotoSelectOptions</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>    <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;</li><li>    <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">photoPicker</span>: photoAccessHelper.<span class="hljs-property">PhotoViewPicker</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'PhotoViewPicker.select successfully, PhotoSelectResult uri: '</span>);</li><li>    photoPicker.<span class="hljs-title function_">select</span>(<span class="hljs-title class_">PhotoSelectOptions</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">PhotoSelectResult</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`PhotoViewPicker.select successfully, PhotoSelectResult uri: <span class="hljs-subst">${PhotoSelectResult.photoUris}</span>`</span>);</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">PhotoSelectResult</span>.<span class="hljs-property">photoUris</span>)</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`PhotoViewPicker.select failed with errCode: <span class="hljs-subst">${err.code}</span>, errMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-title function_">reject</span>();</li><li>    });</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">names: <span class="hljs-built_in">string</span>[]</span>) {</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>    <span class="hljs-keyword">let</span> fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>)</li><li>    imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>()</li><li>  }, <span class="hljs-number">100</span></li><li>  )</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>实例化待分割的入参项<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-subjectsegmentation-api#section674171818172" target="_blank">VisionInfo</a>，并传入待检测图片的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>。</span>       <p></p>       <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo</span>: subjectSegmentation.<span class="hljs-property">VisionInfo</span> = {</li><li>  <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>,</li><li>};</li></ol></pre></div></div>       <p></p></li>      <li><span>配置通用文本识别的配置项<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-subjectsegmentation-api#section1268211401742" target="_blank">SegmentationConfig</a>，包括最大分割主体个数、是否输出每个主体的分割信息，以及是否输出分割后的前景图。</span>       <p></p>       <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: subjectSegmentation.<span class="hljs-property">SegmentationConfig</span> = {</li><li>  <span class="hljs-attr">maxCount</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxNum</span>),</li><li>  <span class="hljs-attr">enableSubjectDetails</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">enableSubjectForegroundImage</span>: <span class="hljs-literal">true</span>,</li><li>};</li></ol></pre></div></div>       <p></p></li>      <li><span>调用subjectSegmentation的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-subjectsegmentation-api#section3410243584" target="_blank">subjectSegmentation.doSegmentation</a>接口，实现主体分割。</span>       <p></p>       <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: subjectSegmentation.<span class="hljs-property">SegmentationResult</span> = <span class="hljs-keyword">await</span> subjectSegmentation.<span class="hljs-title function_">doSegmentation</span>(visionInfo, config);</li><li><span class="hljs-keyword">let</span> outputString = <span class="hljs-string">`Subject count: <span class="hljs-subst">${data.subjectCount}</span>\n`</span>;</li><li>outputString += <span class="hljs-string">`Max subject count: <span class="hljs-subst">${config.maxCount}</span>\n`</span>;</li><li>outputString += <span class="hljs-string">`Enable subject details: <span class="hljs-subst">${config.enableSubjectDetails ? <span class="hljs-string">'Yes'</span> : <span class="hljs-string">'No'</span>}</span>\n\n`</span>;</li><li><span class="hljs-keyword">let</span> segBox : subjectSegmentation.<span class="hljs-property">Rectangle</span> = data.<span class="hljs-property">fullSubject</span>.<span class="hljs-property">subjectRectangle</span>;</li><li><span class="hljs-keyword">let</span> segBoxString = <span class="hljs-string">`Full subject box:\nLeft: <span class="hljs-subst">${segBox.left}</span>, Top: <span class="hljs-subst">${segBox.top}</span>, Width: <span class="hljs-subst">${segBox.width}</span>, Height: <span class="hljs-subst">${segBox.height}</span>\n\n`</span>;</li><li>outputString += segBoxString;</li><li>
</li><li><span class="hljs-keyword">if</span> (config.<span class="hljs-property">enableSubjectDetails</span>) {</li><li>  outputString += <span class="hljs-string">'Individual subject boxes:\n'</span>;</li><li>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">subjectDetails</span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">subjectDetails</span>.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">detailSegBox</span>: subjectSegmentation.<span class="hljs-property">Rectangle</span> = data.<span class="hljs-property">subjectDetails</span>[i].<span class="hljs-property">subjectRectangle</span>;</li><li>      outputString += <span class="hljs-string">`Subject <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>:\nLeft: <span class="hljs-subst">${detailSegBox.left}</span>, Top: <span class="hljs-subst">${detailSegBox.top}</span>, Width: <span class="hljs-subst">${detailSegBox.width}</span>, Height: <span class="hljs-subst">${detailSegBox.height}</span>\n\n`</span>;</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section158910013336">开发实例<i class="anchor-icon anchor-icon-link" anchorid="section158910013336" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1971123317102" class="firsth2">Index.ets<i class="anchor-icon anchor-icon-link" anchorid="section1971123317102" tips="复制节点链接"></i></h3>          <div _ngcontent-jbc-c106="" class="highlight-div"><div _ngcontent-jbc-c106="" class="highlight-div-header"><div _ngcontent-jbc-c106="" class="highlight-div-header-left"><div _ngcontent-jbc-c106="" class="handle-button expand-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jbc-c106="" class="highlight-div-header-right"><div _ngcontent-jbc-c106="" class="handle-button ai-button"></div><div _ngcontent-jbc-c106="" class="handle-button line-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jbc-c106="" class="handle-button theme-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jbc-c106="" class="handle-button copy-button"><div _ngcontent-jbc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jbc-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { subjectSegmentation } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreVisionKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"ImageSegmentationSample"</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">chooseImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataValues</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">segmentedImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">maxNum</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'20'</span></li><li>
</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">accessibilityDescription</span>(<span class="hljs-string">"Image to be segmented"</span>)</li><li>
</li><li>      <span class="hljs-title class_">Scroll</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span>)</li><li>          .<span class="hljs-title function_">copyOption</span>(<span class="hljs-title class_">CopyOptions</span>.<span class="hljs-property">LocalDevice</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'20%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">segmentedImage</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">accessibilityDescription</span>(<span class="hljs-string">"Segmented subject image"</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Max subject count:'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>        <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Enter max subject count'</span>, <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxNum</span> })</li><li>          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">InputType</span>.<span class="hljs-property">Number</span>)</li><li>          .<span class="hljs-title function_">placeholderColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxNum</span> = value</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Select Image'</span>)</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectImage</span>()</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Image Segmentation'</span>)</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"imageSegmentation not have chooseImage"</span>);</li><li>            <span class="hljs-keyword">return</span></li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo</span>: subjectSegmentation.<span class="hljs-property">VisionInfo</span> = {</li><li>            <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>,</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: subjectSegmentation.<span class="hljs-property">SegmentationConfig</span> = {</li><li>            <span class="hljs-attr">maxCount</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxNum</span>),</li><li>            <span class="hljs-attr">enableSubjectDetails</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-attr">enableSubjectForegroundImage</span>: <span class="hljs-literal">true</span>,</li><li>          };</li><li>          subjectSegmentation.<span class="hljs-title function_">doSegmentation</span>(visionInfo, config)</li><li>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: subjectSegmentation.SegmentationResult</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> outputString = <span class="hljs-string">`Subject count: <span class="hljs-subst">${data.subjectCount}</span>\n`</span>;</li><li>              outputString += <span class="hljs-string">`Max subject count: <span class="hljs-subst">${config.maxCount}</span>\n`</span>;</li><li>              outputString += <span class="hljs-string">`Enable subject details: <span class="hljs-subst">${config.enableSubjectDetails ? <span class="hljs-string">'Yes'</span> : <span class="hljs-string">'No'</span>}</span>\n\n`</span>;</li><li>              <span class="hljs-keyword">let</span> segBox : subjectSegmentation.<span class="hljs-property">Rectangle</span> = data.<span class="hljs-property">fullSubject</span>.<span class="hljs-property">subjectRectangle</span>;</li><li>              <span class="hljs-keyword">let</span> segBoxString = <span class="hljs-string">`Full subject box:\nLeft: <span class="hljs-subst">${segBox.left}</span>, Top: <span class="hljs-subst">${segBox.top}</span>, Width: <span class="hljs-subst">${segBox.width}</span>, Height: <span class="hljs-subst">${segBox.height}</span>\n\n`</span>;</li><li>              outputString += segBoxString;</li><li>
</li><li>              <span class="hljs-keyword">if</span> (config.<span class="hljs-property">enableSubjectDetails</span>) {</li><li>                outputString += <span class="hljs-string">'Individual subject boxes:\n'</span>;</li><li>                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">subjectDetails</span>) {</li><li>                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">subjectDetails</span>.<span class="hljs-property">length</span>; i++) {</li><li>                    <span class="hljs-keyword">let</span> <span class="hljs-attr">detailSegBox</span>: subjectSegmentation.<span class="hljs-property">Rectangle</span> = data.<span class="hljs-property">subjectDetails</span>[i].<span class="hljs-property">subjectRectangle</span>;</li><li>                    outputString += <span class="hljs-string">`Subject <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>:\nLeft: <span class="hljs-subst">${detailSegBox.left}</span>, Top: <span class="hljs-subst">${detailSegBox.top}</span>, Width: <span class="hljs-subst">${detailSegBox.width}</span>, Height: <span class="hljs-subst">${detailSegBox.height}</span>\n\n`</span>;</li><li>                  }</li><li>                }</li><li>              }</li><li>
</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"Segmentation result: "</span> + outputString);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span> = outputString;</li><li>
</li><li>              <span class="hljs-keyword">if</span> (data.<span class="hljs-property">fullSubject</span> &amp;&amp; data.<span class="hljs-property">fullSubject</span>.<span class="hljs-property">foregroundImage</span>) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">segmentedImage</span> = data.<span class="hljs-property">fullSubject</span>.<span class="hljs-property">foregroundImage</span>;</li><li>              } <span class="hljs-keyword">else</span> {</li><li>                hilog.<span class="hljs-title function_">warn</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"No foreground image in segmentation result"</span>);</li><li>              }</li><li>            })</li><li>            .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Image segmentation failed errCode: <span class="hljs-subst">${error.code}</span>, errMessage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span> = <span class="hljs-string">`Error: <span class="hljs-subst">${error.message}</span>`</span>;</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">segmentedImage</span> = <span class="hljs-literal">undefined</span>;</li><li>            });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'80%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectImage</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openPhoto</span>()</li><li>    <span class="hljs-keyword">if</span> (uri === <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"uri is undefined"</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(uri);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">openPhoto</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-title class_">PhotoSelectOptions</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>      <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;</li><li>      <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">photoPicker</span>: photoAccessHelper.<span class="hljs-property">PhotoViewPicker</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>      photoPicker.<span class="hljs-title function_">select</span>(<span class="hljs-title class_">PhotoSelectOptions</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">PhotoSelectResult</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`PhotoViewPicker.select successfully, PhotoSelectResult uri: <span class="hljs-subst">${PhotoSelectResult.photoUris}</span>`</span>);</li><li>        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">PhotoSelectResult</span>.<span class="hljs-property">photoUris</span>)</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`PhotoViewPicker.select failed with errCode: <span class="hljs-subst">${err.code}</span>, errMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-title function_">reject</span>();</li><li>      });</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">names: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>)</li><li>        imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>)</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>()</li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">close</span>(fileSource);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to open file. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>      }</li><li>    }, <span class="hljs-number">100</span></li><li>    )</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>