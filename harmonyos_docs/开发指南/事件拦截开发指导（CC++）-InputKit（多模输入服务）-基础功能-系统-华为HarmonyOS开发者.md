<h1 _ngcontent-ame-c119="" class="doc-title ng-star-inserted" title="事件拦截开发指导（C/C++）"> 事件拦截开发指导（C/C++） </h1>

<div _ngcontent-ame-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="功能介绍">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="功能介绍" tips="复制节点链接"></i></h2>          <p>从API version 12开始，多模为应用提供了创建和删除按键、输入事件（鼠标、触摸和轴事件）拦截的能力。使用场景例如：云桌面应用需要拦截按键、鼠标、触摸和轴事件。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>创建和删除事件拦截相关接口如下表所示，接口详细介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-input" target="_blank">Input文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">Input_Result OH_Input_AddKeyEventInterceptor(Input_KeyEventCallback callback, Input_InterceptorOptions *option)</td>         <td class="cellrowborder" valign="top" width="50%">创建按键事件拦截。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">Input_Result OH_Input_AddInputEventInterceptor(Input_InterceptorEventCallback *callback, Input_InterceptorOptions *option)</td>         <td class="cellrowborder" valign="top" width="50%">创建输入事件拦截，包含鼠标、触摸和轴事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">Input_Result OH_Input_RemoveKeyEventInterceptor()</td>         <td class="cellrowborder" valign="top" width="50%">删除按键事件拦截。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">Input_Result OH_Input_RemoveInputEventInterceptor()</td>         <td class="cellrowborder" valign="top" width="50%">删除输入事件拦截，包含鼠标、触摸和轴事件。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="链接动态库" class="firsth2">链接动态库<i class="anchor-icon anchor-icon-link" anchorid="链接动态库" tips="复制节点链接"></i></h3>          <p>调用创建和删除事件拦截前，需链接相关动态库。链接动态库的方法是，在CMakeList.txt文件中做下面例子所示的配置：</p>     <div _ngcontent-ame-c106="" class="highlight-div"><div _ngcontent-ame-c106="" class="highlight-div-header"><div _ngcontent-ame-c106="" class="highlight-div-header-left"><div _ngcontent-ame-c106="" class="handle-button expand-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ame-c106="" class="highlight-div-header-right"><div _ngcontent-ame-c106="" class="handle-button ai-button"></div><div _ngcontent-ame-c106="" class="handle-button line-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ame-c106="" class="handle-button theme-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ame-c106="" class="handle-button copy-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ame-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libohinput.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="申请所需权限">申请所需权限<i class="anchor-icon anchor-icon-link" anchorid="申请所需权限" tips="复制节点链接"></i></h3>          <p>应用需要在module.json5中添加下面权限的配置，详细的配置方法参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限文档</a>。</p>     <div _ngcontent-ame-c106="" class="highlight-div"><div _ngcontent-ame-c106="" class="highlight-div-header"><div _ngcontent-ame-c106="" class="highlight-div-header-left"><div _ngcontent-ame-c106="" class="handle-button expand-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ame-c106="" class="highlight-div-header-right"><div _ngcontent-ame-c106="" class="handle-button ai-button"></div><div _ngcontent-ame-c106="" class="handle-button line-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ame-c106="" class="handle-button theme-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ame-c106="" class="handle-button copy-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ame-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERCEPT_INPUT_EVENT"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="创建事件拦截">创建事件拦截<i class="anchor-icon anchor-icon-link" anchorid="创建事件拦截" tips="复制节点链接"></i></h3>          <ul>      <li><strong>按键事件</strong></li>     </ul>     <div _ngcontent-ame-c106="" class="highlight-div"><div _ngcontent-ame-c106="" class="highlight-div-header"><div _ngcontent-ame-c106="" class="highlight-div-header-left"><div _ngcontent-ame-c106="" class="handle-button expand-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ame-c106="" class="highlight-div-header-right"><div _ngcontent-ame-c106="" class="handle-button ai-button"></div><div _ngcontent-ame-c106="" class="handle-button line-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ame-c106="" class="handle-button theme-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ame-c106="" class="handle-button copy-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ame-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimodalinput/oh_input_manager.h"</span></span></li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KeyEvent</span> {</li><li>    <span class="hljs-type">int32_t</span> action;</li><li>    <span class="hljs-type">int32_t</span> keyCode;</li><li>    <span class="hljs-type">int64_t</span> actionTime { <span class="hljs-number">-1</span> };</li><li>};</li><li>
</li><li><span class="hljs-comment">//定义按键事件回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnKeyEventCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> Input_KeyEvent* keyEvent)</span></span></li><li><span class="hljs-function"></span>{</li><li>    KeyEvent event;</li><li>    <span class="hljs-comment">//Input_KeyEvent的生命周期仅在回调函数内，出了回调函数会被销毁</span></li><li>    event.action = <span class="hljs-built_in">OH_Input_GetKeyEventAction</span>(keyEvent);</li><li>    event.keyCode = <span class="hljs-built_in">OH_Input_GetKeyEventKeyCode</span>(keyEvent);</li><li>    event.actionTime = <span class="hljs-built_in">OH_Input_GetKeyEventActionTime</span>(keyEvent);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestKeyEventInterceptor</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">//添加按键事件拦截</span></li><li>    Input_Result ret = <span class="hljs-built_in">OH_Input_AddKeyEventInterceptor</span>(OnKeyEventCallback, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">//移除按键事件监听</span></li><li>    ret = <span class="hljs-built_in">OH_Input_RemoveKeyEventInterceptor</span>();</li><li>}</li></ol></pre></div></div>     <ul>      <li><strong>输入拦截（鼠标、触摸和轴事件）</strong></li>     </ul>     <div _ngcontent-ame-c106="" class="highlight-div"><div _ngcontent-ame-c106="" class="highlight-div-header"><div _ngcontent-ame-c106="" class="highlight-div-header-left"><div _ngcontent-ame-c106="" class="handle-button expand-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ame-c106="" class="highlight-div-header-right"><div _ngcontent-ame-c106="" class="handle-button ai-button"></div><div _ngcontent-ame-c106="" class="handle-button line-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ame-c106="" class="handle-button theme-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ame-c106="" class="handle-button copy-button"><div _ngcontent-ame-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ame-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimodalinput/oh_input_manager.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;map&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MouseEvent</span> {</li><li>    <span class="hljs-type">int32_t</span> action;</li><li>    <span class="hljs-type">int32_t</span> displayX;</li><li>    <span class="hljs-type">int32_t</span> displayY;</li><li>    <span class="hljs-type">int32_t</span> button { <span class="hljs-number">-1</span> };</li><li>    <span class="hljs-type">int32_t</span> axisType { <span class="hljs-number">-1</span> };</li><li>    <span class="hljs-type">float</span> axisValue { <span class="hljs-number">0.0f</span> };</li><li>    <span class="hljs-type">int64_t</span> actionTime { <span class="hljs-number">-1</span> };</li><li>};</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">TouchEvent</span> {</li><li>    <span class="hljs-type">int32_t</span> action;</li><li>    <span class="hljs-type">int32_t</span> id;</li><li>    <span class="hljs-type">int32_t</span> displayX;</li><li>    <span class="hljs-type">int32_t</span> displayY;</li><li>    <span class="hljs-type">int64_t</span> actionTime { <span class="hljs-number">-1</span> };</li><li>};</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AxisEvent</span> {</li><li>    <span class="hljs-type">int32_t</span> axisAction;</li><li>    <span class="hljs-type">float</span> displayX;</li><li>    <span class="hljs-type">float</span> displayY;</li><li>    std::map&lt;<span class="hljs-type">int32_t</span>, <span class="hljs-type">double</span>&gt; axisValues;</li><li>    <span class="hljs-type">int64_t</span> actionTime { <span class="hljs-number">-1</span> };</li><li>    <span class="hljs-type">int32_t</span> sourceType;</li><li>    <span class="hljs-type">int32_t</span> axisEventType { <span class="hljs-number">-1</span> };</li><li>};</li><li>
</li><li><span class="hljs-comment">//定义鼠标事件回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnMouseEventCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> Input_MouseEvent* mouseEvent)</span></span></li><li><span class="hljs-function"></span>{</li><li>    MouseEvent event;</li><li>    <span class="hljs-comment">//Input_MouseEvent的生命周期仅在回调函数内，出了回调函数会被销毁</span></li><li>    event.action = <span class="hljs-built_in">OH_Input_GetMouseEventAction</span>(mouseEvent);</li><li>    event.displayX = <span class="hljs-built_in">OH_Input_GetMouseEventDisplayX</span>(mouseEvent);</li><li>    event.displayY = <span class="hljs-built_in">OH_Input_GetMouseEventDisplayY</span>(mouseEvent);</li><li>    event.button = <span class="hljs-built_in">OH_Input_GetMouseEventButton</span>(mouseEvent);</li><li>    event.axisType = <span class="hljs-built_in">OH_Input_GetMouseEventAxisType</span>(mouseEvent);</li><li>    event.axisValue = <span class="hljs-built_in">OH_Input_GetMouseEventAxisValue</span>(mouseEvent);</li><li>    event.actionTime = <span class="hljs-built_in">OH_Input_GetMouseEventActionTime</span>(mouseEvent);</li><li>}</li><li>
</li><li><span class="hljs-comment">//定义触摸事件回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnTouchEventCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> Input_TouchEvent* touchEvent)</span></span></li><li><span class="hljs-function"></span>{</li><li>    TouchEvent event;</li><li>    <span class="hljs-comment">//Input_TouchEvent的生命周期仅在回调函数内，出了回调函数会被销毁</span></li><li>    event.action = <span class="hljs-built_in">OH_Input_GetTouchEventAction</span>(touchEvent);</li><li>    event.id = <span class="hljs-built_in">OH_Input_GetTouchEventFingerId</span>(touchEvent);</li><li>    event.displayX = <span class="hljs-built_in">OH_Input_GetTouchEventDisplayX</span>(touchEvent);</li><li>    event.displayY = <span class="hljs-built_in">OH_Input_GetTouchEventDisplayY</span>(touchEvent);</li><li>    event.actionTime = <span class="hljs-built_in">OH_Input_GetTouchEventActionTime</span>(touchEvent);</li><li>}</li><li>
</li><li><span class="hljs-comment">//定义轴事件回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnAxisEventCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> Input_AxisEvent* axisEvent)</span></span></li><li><span class="hljs-function"></span>{</li><li>    AxisEvent event;</li><li>    </li><li>    <span class="hljs-comment">//Input_AxisEvent的生命周期仅在回调函数内，出了回调函数会被销毁</span></li><li>    InputEvent_AxisAction action;</li><li>    Input_Result ret = <span class="hljs-built_in">OH_Input_GetAxisEventAction</span>(axisEvent, &amp;action);</li><li>    event.axisAction = action;</li><li>    ret = <span class="hljs-built_in">OH_Input_GetAxisEventDisplayX</span>(axisEvent, &amp;event.displayX);</li><li>    ret = <span class="hljs-built_in">OH_Input_GetAxisEventDisplayY</span>(axisEvent, &amp;event.displayY);</li><li>    ret = <span class="hljs-built_in">OH_Input_GetAxisEventActionTime</span>(axisEvent, &amp;event.actionTime);</li><li>    InputEvent_SourceType sourceType;</li><li>    ret = <span class="hljs-built_in">OH_Input_GetAxisEventSourceType</span>(axisEvent, &amp;sourceType);</li><li>    event.sourceType = sourceType;</li><li>    InputEvent_AxisEventType axisEventType;</li><li>    ret = <span class="hljs-built_in">OH_Input_GetAxisEventType</span>(axisEvent, &amp;axisEventType);</li><li>    event.axisEventType = axisEventType;</li><li>    <span class="hljs-keyword">if</span> (event.axisEventType == AXIS_EVENT_TYPE_PINCH) {</li><li>        <span class="hljs-type">double</span> value = <span class="hljs-number">0</span>;</li><li>        ret = <span class="hljs-built_in">OH_Input_GetAxisEventAxisValue</span>(axisEvent, AXIS_TYPE_PINCH, &amp;value);</li><li>        event.axisValues.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">make_pair</span>(AXIS_TYPE_PINCH, value));</li><li>        ret = <span class="hljs-built_in">OH_Input_GetAxisEventAxisValue</span>(axisEvent, AXIS_TYPE_ROTATE, &amp;value);</li><li>        event.axisValues.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">make_pair</span>(AXIS_TYPE_ROTATE, value));</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.axisEventType == AXIS_EVENT_TYPE_SCROLL) {</li><li>        <span class="hljs-type">double</span> value = <span class="hljs-number">0</span>;</li><li>        ret = <span class="hljs-built_in">OH_Input_GetAxisEventAxisValue</span>(axisEvent, AXIS_TYPE_SCROLL_VERTICAL, &amp;value);</li><li>        event.axisValues.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">make_pair</span>(AXIS_TYPE_SCROLL_VERTICAL, value));</li><li>        ret = <span class="hljs-built_in">OH_Input_GetAxisEventAxisValue</span>(axisEvent, AXIS_TYPE_SCROLL_HORIZONTAL, &amp;value);</li><li>        event.axisValues.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">make_pair</span>(AXIS_TYPE_SCROLL_HORIZONTAL, value));</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">//输入事件回调函数结构体</span></li><li>Input_InterceptorEventCallback g_eventCallback;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestInputEventInterceptor</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">//设置鼠标事件回调函数</span></li><li>    g_eventCallback.mouseCallback = OnMouseEventCallback;</li><li>    <span class="hljs-comment">//设置触摸事件回调函数</span></li><li>    g_eventCallback.touchCallback = OnTouchEventCallback;</li><li>    <span class="hljs-comment">//设置轴事件回调函数</span></li><li>    g_eventCallback.axisCallback = OnAxisEventCallback;</li><li>
</li><li>    <span class="hljs-comment">//添加输入事件拦截</span></li><li>    Input_Result ret = <span class="hljs-built_in">OH_Input_AddInputEventInterceptor</span>(&amp;g_eventCallback, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">//移除输入事件监听</span></li><li>    ret = <span class="hljs-built_in">OH_Input_RemoveInputEventInterceptor</span>();</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/input/NDKInputEventInterceptor" target="_blank">输入事件拦截（C/C++）</a></li>     </ul>    </div>   </div>   <div></div></div>