<h1 _ngcontent-dtt-c119="" class="doc-title ng-star-inserted" title="事件订阅（C/C++）"> 事件订阅（C/C++） </h1>

<div _ngcontent-dtt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>HiAppEvent提供了事件订阅接口，用于获取应用的事件。</p>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>API接口的使用说明，包括参数使用限制和取值范围，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hiappevent-h" target="_blank">HiAppEvent C API文档</a>。</p>     <p><strong>订阅接口功能介绍</strong>：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiAppEvent_AddWatcher(HiAppEvent_Watcher* watcher)</td>         <td class="cellrowborder" valign="top" width="50%">添加应用的事件观察者。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiAppEvent_RemoveWatcher(HiAppEvent_Watcher* watcher)</td>         <td class="cellrowborder" valign="top" width="50%">移除应用的事件观察者。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>打点接口功能介绍</strong>：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.6.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.6.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiAppEvent_Write(const char* domain, const char* name, enum EventType type, const ParamList list)</td>         <td class="cellrowborder" valign="top" width="50%">实现对参数为列表类型的应用事件打点。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="事件订阅开发指导">事件订阅开发指导<i class="anchor-icon anchor-icon-link" anchorid="事件订阅开发指导" tips="复制节点链接"></i></h2>          <p>以订阅崩溃事件（系统事件）和按钮点击事件（应用事件）为例，说明开发步骤。</p>    </div>    <div class="tiledSection">     <h3 id="步骤一新建工程及编译配置" class="firsth2">步骤一：新建工程及编译配置<i class="anchor-icon anchor-icon-link" anchorid="步骤一新建工程及编译配置" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>获取该示例工程依赖的jsoncpp文件，</p>       <p>从<a href="https://github.com/open-source-parsers/jsoncpp" target="_blank">三方开源库jsoncpp代码仓</a>下载源码的压缩包，并按照README的<strong>Amalgamated source</strong>中介绍的操作步骤得到jsoncpp.cpp、json.h和json-forwards.h三个文件。</p>       <p>新建Native C++工程，并将jsoncpp导入工程，目录结构如下：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>entry</li><li>└── src</li><li>    └── main</li><li>        ├── cpp</li><li>        │   ├── CMakeLists.txt</li><li>        │   ├── json</li><li>        │   │   ├── json-forwards.h</li><li>        │   │   └── json.h</li><li>        │   ├── jsoncpp.cpp</li><li>        │   ├── napi_init.cpp</li><li>        │   └── types</li><li>        │       └── libentry</li><li>        │           ├── Index.d.ts</li><li>        │           └── oh-package.json5</li><li>        └── ets</li><li>            ├── entryability</li><li>            │   └── EntryAbility.ets</li><li>            └── pages</li><li>                └── Index.ets</li></ol></pre></div></div></li>      <li>       <p>编辑“CMakeLists.txt”文件，添加源文件和动态库。</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 新增jsoncpp<span class="hljs-selector-class">.cpp</span>(解析订阅事件中的json字符串)源文件</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp jsoncpp.cpp)</li><li># 新增动态库依赖libhiappevent_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>和libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(日志输出)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libhiappevent_ndk.z.so)</li></ol></pre></div></div></li>      <li>       <p>编辑“napi_init.cpp”文件，导入依赖的文件并定义LOG_TAG：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"json/json.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hiappevent/hiappevent.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"testTag"</span></span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="步骤二订阅事件">步骤二：订阅事件<i class="anchor-icon anchor-icon-link" anchorid="步骤二订阅事件" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>订阅事件。分别使用OnReceive类型观察者、OnTrigger类型观察者的订阅方式。</p>       <ul>        <li>         <p>订阅崩溃事件（系统事件），采用OnReceive类型观察者的订阅方式，观察者接收到事件后会立即触发OnReceive()回调。编辑“napi_init.cpp”文件，定义OnReceive类型观察者相关方法：</p>         <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义变量，用来缓存创建的观察者的指针。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">HiAppEvent_Watcher</span> *<span class="hljs-variable">onReceiverWatcher</span>;</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnReceive</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">domain</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HiAppEvent_AppEventGroup</span> *<span class="hljs-variable">appEventGroups</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">groupLen</span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">groupLen</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">appEventGroups</span>[<span class="hljs-title class_">i</span>].<span class="hljs-title class_">infoLen</span>; ++<span class="hljs-title class_">j</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">domain</span>);</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">name</span>);</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-keyword">type</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">strcmp</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">domain</span>, <span class="hljs-variable">DOMAIN_OS</span>) == <span class="hljs-number">0</span> &amp;&amp;</li><li>                <span class="hljs-title function_">strcmp</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">name</span>, <span class="hljs-variable">EVENT_APP_CRASH</span>) == <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Value</span> <span class="hljs-title class_">params</span>;</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Reader</span> <span class="hljs-title class_">reader</span>(<span class="hljs-variable">Json</span>::<span class="hljs-variable">Features</span>::<span class="hljs-title class_">strictMode</span>());</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">FastWriter</span> <span class="hljs-title class_">writer</span>;</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">reader</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">params</span>, <span class="hljs-variable">params</span>)) {</li><li>                    <span class="hljs-comment">// 开发者可以获取到崩溃事件发生的时间戳</span></li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.time=%{public}lld"</span>, <span class="hljs-variable">params</span>[<span class="hljs-string">"time"</span>].<span class="hljs-title function_">asInt64</span>());</li><li>                    <span class="hljs-comment">// 开发者可以获取到崩溃应用的包名</span></li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.bundle_name=%{public}s"</span>, <span class="hljs-variable">params</span>[<span class="hljs-string">"bundle_name"</span>].<span class="hljs-title function_">asString</span>().<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">external_log</span> = <span class="hljs-variable">writer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">params</span>[<span class="hljs-string">"external_log"</span>]);</li><li>                    <span class="hljs-comment">// 开发者可以获取到崩溃事件发生时的故障日志文件</span></li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.external_log=%{public}s"</span>, <span class="hljs-variable">external_log</span>.<span class="hljs-title function_">c_str</span>());</li><li>                }</li><li>            }</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">RegisterWatcherCrash</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-comment">// 开发者自定义观察者名称，系统根据不同的名称来识别不同的观察者。</span></li><li>    <span class="hljs-variable">onReceiverWatcher</span> = <span class="hljs-title function_">OH_HiAppEvent_CreateWatcher</span>(<span class="hljs-string">"AppCrashWatcher"</span>);</li><li>    <span class="hljs-comment">// 设置订阅的事件名称为EVENT_APP_CRASH，即崩溃事件。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">names</span>[] = {<span class="hljs-variable">EVENT_APP_CRASH</span>};</li><li>    <span class="hljs-comment">// 开发者订阅感兴趣的事件，此处订阅了系统事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetAppEventFilter</span>(<span class="hljs-variable">onReceiverWatcher</span>, <span class="hljs-variable">DOMAIN_OS</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">names</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 开发者设置已实现的回调函数，观察者接收到事件后回立即触发OnReceive回调。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetWatcherOnReceive</span>(<span class="hljs-variable">onReceiverWatcher</span>, <span class="hljs-variable">OnReceive</span>);</li><li>    <span class="hljs-comment">// 使观察者开始监听订阅的事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_AddWatcher</span>(<span class="hljs-variable">onReceiverWatcher</span>);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>        <li>         <p>订阅按钮点击事件（应用事件），采用OnTrigger类型观察者的订阅方式。需满足OH_HiAppEvent_SetTriggerCondition()设置的条件，才能触发OnTrigger()回调。编辑 “napi_init.cpp”文件，定义OnTrigger类型观察者相关方法：</p>         <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义变量，用来缓存创建的观察者的指针。</span></li><li><span class="hljs-type">static</span> HiAppEvent_Watcher *onTriggerWatcher;</li><li><span class="hljs-comment">// 开发者可以自行实现获取已监听到事件的回调函数，其中events指针指向内容仅在该函数内有效。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnTake</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-type">const</span> *events, <span class="hljs-type">uint32_t</span> eventLen)</span> </span>{</li><li>    <span class="hljs-function">Json::Reader <span class="hljs-title">reader</span><span class="hljs-params">(Json::Features::strictMode())</span></span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; eventLen; ++i) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiAppEvent eventInfo=%{public}s"</span>, events[i]);</li><li>        Json::Value eventInfo;</li><li>        <span class="hljs-keyword">if</span> (reader.<span class="hljs-built_in">parse</span>(events[i], eventInfo)) {</li><li>            <span class="hljs-keyword">auto</span> domain = eventInfo[<span class="hljs-string">"domain_"</span>].<span class="hljs-built_in">asString</span>();</li><li>            <span class="hljs-keyword">auto</span> name = eventInfo[<span class="hljs-string">"name_"</span>].<span class="hljs-built_in">asString</span>();</li><li>            <span class="hljs-keyword">auto</span> type = eventInfo[<span class="hljs-string">"type_"</span>].<span class="hljs-built_in">asInt</span>();</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span>, domain.<span class="hljs-built_in">c_str</span>());</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span>, name.<span class="hljs-built_in">c_str</span>());</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span>, type);</li><li>            <span class="hljs-keyword">if</span> (domain == <span class="hljs-string">"button"</span> &amp;&amp; name == <span class="hljs-string">"click"</span>) {</li><li>                <span class="hljs-keyword">auto</span> clickTime = eventInfo[<span class="hljs-string">"click_time"</span>].<span class="hljs-built_in">asInt64</span>();</li><li>                <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiAppEvent eventInfo.params.click_time=%{public}lld"</span>, clickTime);</li><li>            }</li><li>        }</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者可以自行实现订阅回调函数，以便对获取到的事件打点数据进行自定义处理。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnTrigger</span><span class="hljs-params">(<span class="hljs-type">int</span> row, <span class="hljs-type">int</span> size)</span> </span>{</li><li>    <span class="hljs-comment">// 接收回调后，获取指定数量的已接收事件。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_TakeWatcherData</span>(onTriggerWatcher, row, OnTake);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RegisterWatcherClick</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// 开发者自定义观察者名称，系统根据不同的名称来识别不同的观察者。</span></li><li>    onTriggerWatcher = <span class="hljs-built_in">OH_HiAppEvent_CreateWatcher</span>(<span class="hljs-string">"ButtonClickWatcher"</span>);</li><li>    <span class="hljs-comment">// 设置订阅的事件名称为click。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *names[] = {<span class="hljs-string">"click"</span>};</li><li>    <span class="hljs-comment">// 开发者订阅感兴趣的应用事件，此处订阅了button相关事件。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_SetAppEventFilter</span>(onTriggerWatcher, <span class="hljs-string">"button"</span>, <span class="hljs-number">0</span>, names, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 开发者设置已实现的回调函数，需OH_HiAppEvent_SetTriggerCondition设置的条件满足方可触发。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_SetWatcherOnTrigger</span>(onTriggerWatcher, OnTrigger);</li><li>    <span class="hljs-comment">// 开发者可以设置订阅触发回调的条件，此处是设置新增事件打点数量为1个时，触发onTrigger回调。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_SetTriggerCondition</span>(onTriggerWatcher, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// 使观察者开始监听订阅的事件。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_AddWatcher</span>(onTriggerWatcher);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>编辑“napi_init.cpp”文件，添加按钮点击事件的打点接口：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">WriteAppEvent</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> params = <span class="hljs-built_in">OH_HiAppEvent_CreateParamList</span>();</li><li>    <span class="hljs-built_in">OH_HiAppEvent_AddInt64Param</span>(params, <span class="hljs-string">"click_time"</span>, <span class="hljs-built_in">time</span>(<span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-built_in">OH_HiAppEvent_Write</span>(<span class="hljs-string">"button"</span>, <span class="hljs-string">"click"</span>, EventType::BEHAVIOR, params);</li><li>    <span class="hljs-built_in">OH_HiAppEvent_DestroyParamList</span>(params);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编辑“napi_init.cpp”文件，注册RegisterWatcherCrash()(订阅崩溃事件)、RegisterWatcherClick()（订阅按钮点击事件）、WriteAppEvent()(按钮点击事件打点接口)为ArkTS接口：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"registerWatcherCrash"</span>, <span class="hljs-literal">nullptr</span>, RegisterWatcherCrash, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"registerWatcherClick"</span>, <span class="hljs-literal">nullptr</span>, RegisterWatcherClick, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"writeAppEvent"</span>, <span class="hljs-literal">nullptr</span>, WriteAppEvent, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编辑“index.d.ts”文件，定义ArkTS接口：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerWatcherCrash</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerWatcherClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">writeAppEvent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑“EntryAbility.ets”文件，在onCreate()函数中添加接口调用：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入依赖模块</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-comment">// 在onCreate()函数中添加接口调用</span></li><li><span class="hljs-comment">// 启动时，注册崩溃事件观察者</span></li><li>testNapi.<span class="hljs-title function_">registerWatcherCrash</span>();</li><li><span class="hljs-comment">// 启动时，注册按钮点击事件观察者</span></li><li>testNapi.<span class="hljs-title function_">registerWatcherClick</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="步骤三触发事件">步骤三：触发事件<i class="anchor-icon anchor-icon-link" anchorid="步骤三触发事件" tips="复制节点链接"></i></h3>          <p>编辑“Index.ets”文件，新增“appCrash”按钮以触发崩溃事件；新增“buttonClick”按钮，在按钮点击函数中进行事件打点。示例代码如下：</p>     <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入依赖模块</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"appCrash"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 在按钮点击函数中构造一个crash场景，触发应用崩溃事件</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">object</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">""</span>);</li><li>          })</li><li>          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> }) <span class="hljs-comment">// 设置按钮位置</span></li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"buttonClick"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 在按钮点击函数中进行事件打点，以记录按钮点击事件</span></li><li>            testNapi.<span class="hljs-title function_">writeAppEvent</span>();</li><li>          })</li><li>          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">200</span> }) <span class="hljs-comment">// 设置按钮位置</span></li><li>        }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。在应用界面中点击“appCrash”按钮，触发崩溃事件。应用退出后重新打开应用。</p></li>      <li>       <p>搜索关键字“HiAppEvent”，在HiLog窗口查看应用处理崩溃事件数据的日志：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent eventInfo.domain=OS</li><li>HiAppEvent eventInfo.name=APP_CRASH</li><li>HiAppEvent eventInfo.eventType=1</li><li>HiAppEvent eventInfo.params.time=1750946685473</li><li>HiAppEvent eventInfo.params.bundle_name=com.example.cxxxx</li><li>HiAppEvent eventInfo.params.external_log=["/data/storage/el2/log/hiappevent/APP_CRASH_1750946685805_64003.log"]</li></ol></pre></div></div></li>      <li>       <p>点击buttonClick按钮，触发按钮点击事件。搜索关键字“HiAppEvent”，在HiLog窗口查看应用处理按钮点击事件数据的日志：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent eventInfo={"domain_":"button","name_":"click","type_":4,"time_":1750947007108,"tz_":"","pid_":64750,"tid_":64750,"click_time":1750947007}</li><li>HiAppEvent eventInfo.domain=button</li><li>HiAppEvent eventInfo.name=click</li><li>HiAppEvent eventInfo.eventType=4</li><li>HiAppEvent eventInfo.params.click_time=1750947007</li></ol></pre></div></div></li>      <li>       <p>移除应用的事件观察者：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>static napi_value <span class="hljs-built_in">RemoveWatcher</span>(napi_env env, napi_callback_info info) {</li><li>    <span class="hljs-comment">// 使观察者停止监听事件</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_RemoveWatcher</span>(appEventWatcher);</li><li>    return {};</li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁应用的事件观察者：</p>       <div _ngcontent-dtt-c106="" class="highlight-div"><div _ngcontent-dtt-c106="" class="highlight-div-header"><div _ngcontent-dtt-c106="" class="highlight-div-header-left"><div _ngcontent-dtt-c106="" class="handle-button expand-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dtt-c106="" class="highlight-div-header-right"><div _ngcontent-dtt-c106="" class="handle-button ai-button"></div><div _ngcontent-dtt-c106="" class="handle-button line-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dtt-c106="" class="handle-button theme-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dtt-c106="" class="handle-button copy-button"><div _ngcontent-dtt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dtt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DestroyWatcher</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// 销毁创建的观察者，并置appEventWatcher为nullptr</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_DestroyWatcher</span>(appEventWatcher);</li><li>    appEventWatcher = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>