<h1 _ngcontent-woe-c119="" class="doc-title ng-star-inserted" title="云侧围栏开发指导"> 云侧围栏开发指导 </h1>

<div _ngcontent-woe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1275182892617">概述<i class="anchor-icon anchor-icon-link" anchorid="section1275182892617" tips="复制节点链接"></i></h2><p>云侧围栏是指开发者直接使用云侧公共围栏，当用户进入这个区域，在移动设备上进行有针对性的提醒。</p> </div> <div class="tiledSection"><h2 id="section111272414114">开通云侧围栏服务<i class="anchor-icon anchor-icon-link" anchorid="section111272414114" tips="复制节点链接"></i></h2><p>在开通定位服务前，请先参考“<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-dev-overview" target="_blank">应用开发准备</a>”创建项目和应用工程。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>从HarmonyOS NEXT Developer Beta2起，开发者无需配置公钥指纹和Client ID。</p> </div></div></div> <p><strong>操作步骤</strong></p> <ol><li>登录<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>网站，选择“开发与服务”。<p><span><img height="157.45138500000002" originheight="419" originwidth="1882" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.25787242713062994984215497095611:50001231000000:2800:F00CAEC36F7538286A0653EE108A4D5EB710C166433663F5590FB4D28DB7D0BA.png" title="点击放大" width="707.2275000000001"></span></p> </li><li>在项目列表中找到您的项目，在项目下的应用列表中选择需要配置定位服务参数的应用。</li></ol> <p><span><img height="165.933061" originheight="284" originwidth="1248" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.74713852791007840000861816446729:50001231000000:2800:C9F97A31CD9CFA5CDE628ABC05B7A69B0FE669E3031A40A554BDDBD519D97DB0.png" title="点击放大" width="729.1725"></span></p> <ol start="3"><li>在左侧导航栏选择“定位服务”，并点击收藏。</li></ol> <p><span><img height="425.527515" originheight="1152" originwidth="1980" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.16984119620102871751236539127349:50001231000000:2800:4C757E31B60984E665847E35B6E908E9A6D996CAEFD2E3E4ACA882F15F7F40EA.png" title="点击放大" width="731.3749799999999"></span></p> <ol start="4"><li>在左侧导航栏选择“构建 &gt; 定位服务”。</li></ol> <p><span><img height="419.99937" originheight="1223" originwidth="2140" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.86988633695338730503005136165196:50001231000000:2800:8389B1D72E0212FC208334AF561542E20A76FBA99DE9FBD7E42D60699EADD418.png" title="点击放大" width="734.9520150000001"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果需要使用地理围栏，请确保已联系华为地图定位运营团队（locationkit@huawei.com）开通服务。</p> </div></div></div> <p></p> </div> <div class="tiledSection"><h2 id="section1111963512262">使用场景<i class="anchor-icon anchor-icon-link" anchorid="section1111963512262" tips="复制节点链接"></i></h2><p>1.开发者可以通过该围栏扩展能力来使用云侧公共围栏；</p> <p>2.开发者首先需要在AGC（AppGallery Connect）平台定位服务选择右侧“添加围栏组触发”开始创建地理围栏。</p> <p><span><img height="417.547515" originheight="1221" originwidth="2137" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.27494595356352362242557378604963:50001231000000:2800:27DE8CDEA05F4381AB273DEF9D84FF3F4F7C49720155652D97D22A5AFEAAD315.png" title="点击放大" width="730.805474"></span></p> <p>3.可以根据商圈、景点等类别，配置围栏组下发围栏策略；</p> <p><span><img height="375.984616" originheight="1098" originwidth="2137" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114557.49658274810428429866948939193915:50001231000000:2800:845358E183F7B3A4C0135C7E24C1F9C66D720451419F4754C4D0FE68732FC76C.png" title="点击放大" width="731.796989"></span></p> <p>4. 定位服务在满足围栏触发条件后，通过FenceExtensionAbility把围栏事件通知给APP，APP接收到围栏事件后完成相关的业务处理。</p> </div> <div class="tiledSection"><h2 id="section312012252619">接口介绍<i class="anchor-icon anchor-icon-link" anchorid="section312012252619" tips="复制节点链接"></i></h2><p>接口详情参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-fenceextensionability" target="_blank">FenceExtensionAbility</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="50%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>onFenceStatusChange(transition: geoLocationManager.GeofenceTransition, additions: Record&lt;string, string&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>接收系统通知的地理围栏事件，根据围栏事件类型和数据进行相应处理。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>onDestroy(): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>接收FenceExtensionAbility的销毁事件并处理，会在FenceExtensionAbility销毁前回调。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section994912610261">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section994912610261" tips="复制节点链接"></i></h2><p>要实现一个地理围栏扩展服务，开发者需要实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-fenceextensionability" target="_blank">FenceExtensionAbility</a>的能力，具体步骤如下：</p> <ol><li>在工程Module对应的ets目录下，右键选择“New &gt; Directory”，新建一个目录并命名为fenceextensionability;</li><li>在fenceextensionability目录，右键选择“New &gt; File”，新建一个.ets文件并命名为MyFenceExtensionAbility.ets;</li><li>打开MyFenceExtensionAbility.ets，导入FenceExtensionAbility的依赖包，自定义类继承FenceExtensionAbility并实现onFenceStatusChange和onDestroy接口;<p>示例代码如下：</p> <div _ngcontent-woe-c106="" class="highlight-div"><div _ngcontent-woe-c106="" class="highlight-div-header"><div _ngcontent-woe-c106="" class="highlight-div-header-left"><div _ngcontent-woe-c106="" class="handle-button expand-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-woe-c106="" class="highlight-div-header-right"><div _ngcontent-woe-c106="" class="handle-button ai-button"></div><div _ngcontent-woe-c106="" class="handle-button line-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-woe-c106="" class="handle-button theme-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-woe-c106="" class="handle-button copy-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-woe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">FenceExtensionAbility</span>, <span class="hljs-variable">geoLocationManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">wantAgent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">notificationManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NotificationKit'</span>;</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyFenceExtensionAbility</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">FenceExtensionAbility</span> {</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">onFenceStatusChange</span>(<span class="hljs-variable">transition</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">GeofenceTransition</span>, <span class="hljs-variable">additions</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>    <span class="hljs-keyword">super</span>.<span class="hljs-title function_">onFenceStatusChange</span>(<span class="hljs-variable">transition</span>, <span class="hljs-variable">additions</span>);</li><li>
</li><li>    <span class="hljs-comment">// 接收围栏触发信息</span></li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'MyFenceExtensionAbility onFenceStatusChange'</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">poiId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">additions</span>[<span class="hljs-string">'poiId'</span>];<span class="hljs-comment">// 围栏id，唯一标识，示例：'999287512272780934'</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">policyType</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">additions</span>[<span class="hljs-string">'policyType'</span>];<span class="hljs-comment">// 策略类型：'0'-普通策略;'1'-标签策略</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">policyResult</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">additions</span>[<span class="hljs-string">'policyResult'</span>];<span class="hljs-comment">// 策略结果：标签等策略的额外信息</span></li><li>
</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">poiId</span>:${<span class="hljs-variable">poiId</span>},<span class="hljs-variable">policyType</span>:${<span class="hljs-variable">policyType</span>},<span class="hljs-variable">policyResult</span>:${<span class="hljs-variable">policyResult</span>}`);</li><li>
</li><li>    <span class="hljs-comment">// 可以发送围栏业务通知</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>      <span class="hljs-variable">wants</span>: [</li><li>        {</li><li>          <span class="hljs-variable">bundleName</span>: <span class="hljs-string">'com.huawei.hmos.locationtest.smartfence'</span>,</li><li>          <span class="hljs-variable">abilityName</span>: <span class="hljs-string">'EntryAbility'</span></li><li>        } <span class="hljs-keyword">as</span> <span class="hljs-variable">Want</span></li><li>      ],</li><li>      <span class="hljs-variable">actionType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITY</span>,</li><li>      <span class="hljs-variable">requestCode</span>: <span class="hljs-number">100</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentMy</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">notificationRequest</span>: <span class="hljs-title class_">notificationManager</span>.<span class="hljs-title class_">NotificationRequest</span> = {</li><li>      <span class="hljs-variable">id</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-variable">content</span>: {</li><li>        <span class="hljs-variable">notificationContentType</span>: <span class="hljs-title class_">notificationManager</span>.<span class="hljs-title class_">ContentType</span>.<span class="hljs-title class_">NOTIFICATION_CONTENT_BASIC_TEXT</span>,</li><li>        <span class="hljs-variable">normal</span>: {</li><li>          <span class="hljs-variable">title</span>: <span class="hljs-title class_">`围栏通知`</span>,</li><li>          <span class="hljs-variable">text</span>: `<span class="hljs-title class_">poiId</span>:${<span class="hljs-variable">poiId</span>},<span class="hljs-variable">policyType</span>:${<span class="hljs-variable">policyType</span>},<span class="hljs-variable">policyResult</span>:${<span class="hljs-variable">policyResult</span>}`,</li><li>        }</li><li>      },</li><li>      <span class="hljs-variable">notificationSlotType</span>: <span class="hljs-title class_">notificationManager</span>.<span class="hljs-title class_">SlotType</span>.<span class="hljs-title class_">SOCIAL_COMMUNICATION</span>,</li><li>      <span class="hljs-variable">wantAgent</span>: <span class="hljs-title class_">wantAgentMy</span></li><li>    };</li><li>    <span class="hljs-variable">notificationManager</span>.<span class="hljs-title function_">publish</span>(<span class="hljs-variable">notificationRequest</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">super</span>.<span class="hljs-title function_">onDestroy</span>();</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'MyFenceExtensionAbility onDestroy'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li>在工程Module对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file" target="_blank">module.json5配置文件</a>中注册FenceExtensionAbility，type标签需要设置为fence，srcEntry标签表示当前FenceExtensionAbility组件所对应的代码路径。<div _ngcontent-woe-c106="" class="highlight-div"><div _ngcontent-woe-c106="" class="highlight-div-header"><div _ngcontent-woe-c106="" class="highlight-div-header-left"><div _ngcontent-woe-c106="" class="handle-button expand-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-woe-c106="" class="highlight-div-header-right"><div _ngcontent-woe-c106="" class="handle-button ai-button"></div><div _ngcontent-woe-c106="" class="handle-button line-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-woe-c106="" class="handle-button theme-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-woe-c106="" class="handle-button copy-button"><div _ngcontent-woe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-woe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-string">"extensionAbilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"MyFenceExtensionAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/fenceextensionability/MyFenceExtensionAbility.ets"</span>,</li><li>        <span class="hljs-string">"description"</span>: <span class="hljs-string">"MyFenceExtensionAbility"</span>,</li><li>        <span class="hljs-string">"type"</span>: <span class="hljs-string">"fence"</span>,</li><li>        <span class="hljs-string">"exported"</span>: <span class="hljs-keyword">false</span></li><li>      },</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>