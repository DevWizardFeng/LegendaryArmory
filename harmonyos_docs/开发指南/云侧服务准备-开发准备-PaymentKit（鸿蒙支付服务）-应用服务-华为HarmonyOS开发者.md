<h1 _ngcontent-msp-c119="" class="doc-title ng-star-inserted" title="云侧服务准备"> 云侧服务准备 </h1>

<div _ngcontent-msp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Payment Kit服务提供了支付系统相关的一系列API接口。为减小API接口的接入工作量，提供了相应java版本的Maven依赖用于云侧服务对接。</p>    <p>开发者可通过Maven集成来完成服务器开发环境的构建，以此来快速使用华为支付提供的API接口。</p>    <p>可下载<a href="https://gitcode.com/HarmonyOS_Samples/paymentkit-sample-code-serverdemo-java" target="_blank">示例代码-服务端</a>用以快速完成商户服务器接入。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p style="color: rgb(255,0,0);">因业务发展需要，API接口响应、通知回调请求字段可能会发生变动，如开发者自行实现验签逻辑，一定要使用原始的字符串转为Map对象进行验签处理后再转换成自定义的业务对象去使用，以确保验签正常通过。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="section835417111237">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section835417111237" tips="复制节点链接"></i></h2>          <p>商户使用提供的示例代码接入华为支付前请确保网络已正常连接，可以从华为支付仓库地址正常拉取Maven依赖。</p>     <p>开发环境：<a href="https://www.oracle.com/java/technologies/javase-downloads.html" target="_blank">JDK</a> 1.8及以上。</p>    </div>    <div class="tiledSection">     <h2 id="section379431652315">集成Maven依赖<i class="anchor-icon anchor-icon-link" anchorid="section379431652315" tips="复制节点链接"></i></h2>          <p>在示例代码pom.xml文件中已配置仓库地址，如无法正常拉取依赖，可在Maven配置文件“settings.xml”中添加华为支付的Maven仓库地址。</p>     <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="xml prettyprint linenums hljs language-xml" hw-language="xml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-tag">&lt;</span><span class=""><span class="hljs-tag"><span class="hljs-name">mirror</span></span></span><span class="hljs-tag">&gt;</span></li><li>  <span class="hljs-tag">&lt;</span><span class=""><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span>central<span class="hljs-tag">&lt;/</span><span class=""><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></li><li>  <span class="hljs-tag">&lt;</span><span class=""><span class="hljs-tag"><span class="hljs-name">mirrorOf</span></span></span><span class="hljs-tag">&gt;</span>central<span class="hljs-tag">&lt;/</span><span class=""><span class="hljs-tag"><span class="hljs-name">mirrorOf</span></span></span><span class="hljs-tag">&gt;</span></li><li>  <span class="hljs-tag">&lt;</span><span class=""><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span>https://developer.huawei.com/repo/<span class="hljs-tag">&lt;/</span><span class=""><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></li><li><span class="hljs-tag">&lt;/</span><span class=""><span class="hljs-tag"><span class="hljs-name">mirror</span></span></span><span class="hljs-tag">&gt;</span></li></ol></pre></div></div>     <p>在示例代码pom.xml文件中已引入jar包的Maven坐标。如商户自己构建工程则需在pom.xml文件中引入如下坐标：</p>     <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span></li><li><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.huawei.petalpay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span></li><li><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pay-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span></li><li><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0.331<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="section16454184842320">配置初始化<i class="anchor-icon anchor-icon-link" anchorid="section16454184842320" tips="复制节点链接"></i></h2>          <p>将以下商户相关配置添加到示例代码配置文件src/main/resources/petalpayconfig.properties。</p>     <ol>      <li>商户号，获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/pay-docs/hwzf-shanghuhao-0000001725982508" target="_blank">查询商户号信息</a>。</li>      <li>商户私钥，获取途径请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/payment-certificates-config">准备证书</a>。</li>      <li>商户私钥签名类型，RSA或SM2。</li>      <li>商户证书ID，获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/payment-certificates-config#section325481952016">上传商户证书</a>。</li>      <li>鸿蒙支付服务验签公钥，获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/payment-certificates-config#section377312802116">下载华为支付证书</a>。</li>      <li>鸿蒙支付服务加密公钥（非必选），涉及接口入参敏感字段（接口会做标注）加密时需配置，参见<a href="/consumer/cn/doc/harmonyos-guides/payment-server-connect#section1416282832417">敏感信息处理</a>。</li>      <li>商户号关联的APPID，获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/pay-docs/hwzf-appidguanli-0000001757041165" target="_blank">AppID管理及关联</a>。</li>     </ol>     <p>配置内容示例如下：</p>     <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_"># </span><span class="language-bash">商户号</span></li><li>PETALPAY.MERC_NO=121540000***</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">商户私钥</span></li><li>PETALPAY.MERC_PRIVATE_KEY=MIIJQwIBADAN=9w0BAQEFAASCCS0wg******************************CldcDlDCSsdfDceCSDr+RyvJdfcXssdEA=</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">商户证书ID</span></li><li>PETALPAY.MERC_AUTH_ID=101540200089***</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">商户私钥签名类型</span></li><li>PETALPAY.SIGN_TYPE=RSA</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">鸿蒙支付服务域名</span></li><li>PETALPAY.SERVER_HOST=https://petalpay-developer.cloud.huawei.com.cn</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">鸿蒙支付服务验签公钥</span></li><li>PETALPAY.HW_PAY_PUBLIC_KEY_FOR_CALLBACK=6D015316F09CB747E4467******************************DB46DA4BD0960ADD500D84912</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">鸿蒙支付服务加密公钥（非必选）</span></li><li>PETALPAY.HW_PUBLIC_KEY_FOR_SESSIONKEY=042A7D32FA19C29D3E722D6C4ACAC0B******************************E5A5B1C8120DAC9882E4B093B9CE7A38296F87F41747D319A</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">商户号关联的APPID</span></li><li>PETALPAY.APPID=111831***</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="section5626882242">业务接口请求<i class="anchor-icon anchor-icon-link" anchorid="section5626882242" tips="复制节点链接"></i></h2>          <ol>      <li>获取发起请求客户端对象       <div class="p">        可通过工具类MercConfigUtil提供的方法getMercConfig快速获取PetalPayConfig对象来构建请求客户端，对应配置项获取及配置参见<a href="/consumer/cn/doc/harmonyos-guides/payment-server-connect#section16454184842320">配置初始化</a>。        <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 商户配置</span></li><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span>PetalPayConfig <span class=""><span class="hljs-title function_">getMercConfig</span></span><span class="hljs-params">()</span> {</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>PetalPayConfig.builder().callerId(<span class="">MERC_NO</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">必填</span></span><span class=""><span class="hljs-comment">)</span></span><span class=""><span class="hljs-comment">商户号</span></span></li><li>        .appId(<span class="">APP_ID</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">必填</span></span><span class=""><span class="hljs-comment">) </span></span><span class=""><span class="hljs-comment">商户号关联的APPID</span></span></li><li>        .privateKey(<span class="">MERC_PRIVATE_KEY</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">必填</span></span><span class=""><span class="hljs-comment">) </span></span><span class=""><span class="hljs-comment">商户私钥</span></span></li><li>        .authId(<span class="">MERC_AUTH_ID</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">必填</span></span><span class=""><span class="hljs-comment">) </span></span><span class=""><span class="hljs-comment">商户证书</span></span><span class=""><span class="hljs-comment">ID</span></span></li><li>        .signType(<span class="">SIGN_TYPE</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">选填</span></span><span class=""><span class="hljs-comment">) </span></span><span class=""><span class="hljs-comment">商户公私钥类型，默认</span></span><span class=""><span class="hljs-comment">RSA</span></span><span class=""><span class="hljs-comment">加密</span></span></li><li>        .petalpayPublicKey(<span class="">HW_PAY_PUBLIC_KEY_FOR_CALLBACK</span>) <span class=""><span class="hljs-comment">// (</span></span><span class=""><span class="hljs-comment">非必填</span></span><span class=""><span class="hljs-comment">) </span></span><span class=""><span class="hljs-comment">验签公钥</span></span><span class=""><span class="hljs-comment">(</span></span><span class=""><span class="hljs-comment">和接口级配置</span></span><span class=""><span class="hljs-comment">needVerifyRsp</span></span><span class=""><span class="hljs-comment">对应，公钥和商户通知回调验签公钥同一个</span></span><span class=""><span class="hljs-comment">)</span></span></li><li>        .domainHost(<span class="">SERVER_HOST</span>).build();</li><li>}</li></ol></pre></div></div>       </div>       <div class="p">        <strong>方式一</strong>：使用默认实现的请求客户端工具类。通过PetalPayConfig构建请求客户端对象示例如下：        <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">PetalPayClient</span> <span class="hljs-variable">payClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPetalPayClient</span>(MercConfigUtil.getMercConfig());</li></ol></pre></div></div>       </div>       <p><strong>方式二</strong>：自定义实现请求客户端工具类。开发者如果需要自定义接口请求的client，用于处理请求中的日志打印等操作，可以通过继承PetalPayClient 来实现。示例如下：</p>       <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">public</span></span> <span class=""><span class="hljs-keyword">class</span></span> <span class="hljs-title class_">MercPetalPayClient</span> <span class=""><span class="hljs-keyword">extends</span></span> <span class="hljs-title class_">PetalPayClient</span> {</li><li>    <span class=""><span class="hljs-keyword">public</span></span> <span class="hljs-title function_">MercPetalPayClient</span><span class="hljs-params">(PetalPayConfig petalPayConfig)</span> {</li><li>        <span class=""><span class="hljs-built_in">super</span></span>(petalPayConfig);</li><li>    }</li><li>    <span class=""><span class="hljs-meta">@Override</span></span></li><li>    <span class=""><span class="hljs-keyword">public</span></span> String <span class="hljs-title function_">doPost</span><span class="hljs-params">(String url, Map&lt;String, String&gt; headers, String requestBody)</span> <span class=""><span class="hljs-keyword">throws</span></span> Exception {</li><li>        <span class=""><span class="hljs-comment">// todo</span></span></li><li>    }</li><li>    <span class=""><span class="hljs-meta">@Override</span></span></li><li>    <span class=""><span class="hljs-keyword">public</span></span> String <span class="hljs-title function_">doGet</span><span class="hljs-params">(String url, Map&lt;String, String&gt; headers, String requestBody)</span> <span class=""><span class="hljs-keyword">throws</span></span> Exception {</li><li>        <span class=""><span class="hljs-comment">// todo</span></span></li><li>    }</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>需要使用最新开放的API接口，如示例代码未及时更新，未找到默认提供用于接口请求的对象信息，可直接调用PetalPayClient的execute方法构建接口请求。</li>          <li>由于PetalPayClient.execute()方法及DefaultPetalPayClient实现涉及通过SecureRandom.getInstanceStrong()获取安全随机数，如果服务器熵值不足，可能会导致请求阻塞，以下处理方式可供参考：           <div class="p">            方式一：通过三方服务补充服务器熵值。以下为通过haveged服务补充熵值参考。            <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># 查看熵值 </span></li><li><span class="hljs-built_in">cat</span> /proc/sys/kernel/random/entropy_avail</li><li><span class="hljs-comment"># 安装haveged </span></li><li>yum install haveged </li><li><span class="hljs-comment"># 启动haveged</span></li><li>systemctl start haveged.service </li><li><span class="hljs-comment"># 开启haveged服务开机自启动</span></li><li>systemctl <span class="hljs-built_in">enable</span> haveged.service</li></ol></pre></div></div>           </div>           <div class="p">            方式二：开发者参照DefaultPetalPayClient自定义实现请求客户端工具类并通过RequestConfig对象tranceId字段（建议每次请求都更新该字段）来主动传递tranceId，避免自动通过SecureRandom.getInstanceStrong()生成安全随机数导致请求阻塞。            <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-vbnet" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">public</span> </span>&lt;<span class="">T</span>&gt; <span class="">T </span><span class="">execute</span>(<span class="hljs-type">String</span> httpMethod, <span class="hljs-type">String</span> apiUrl, <span class="hljs-keyword">Class</span>&lt;<span class="">T</span>&gt; rspType, RequestConfig requestConfig, <span class="hljs-type">Object</span> requestObj) <span class="">throws </span>Exception;</li></ol></pre></div></div>           </div></li>         </ul>        </div></div></div></li>      <li>组装请求参数       <div class="p">        预下单请求参数组装示例如下：        <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span>PreOrderCreateRequestV2 <span class=""><span class="hljs-title function_">getPreOrderCreateRequestV2</span></span><span class="hljs-params">()</span> {</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>PreOrderCreateRequestV2.builder()</li><li>        .mercOrderNo(<span class=""><span class="hljs-string">"pay-example-"</span> </span>+ System.currentTimeMillis()) <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">每次订单号都要变，请将</span></span><span class=""><span class="hljs-comment">pay-example-</span></span><span class=""><span class="hljs-comment">修改为商户自己的订单前缀</span></span></li><li>        .appId(MercConfigUtil.<span class="">APP_ID</span>)  <span class=""><span class="hljs-comment">// appId</span></span><span class=""><span class="hljs-comment">，需要配置为与商户绑定的正确的</span></span><span class=""><span class="hljs-comment">appId</span></span></li><li>        .mercNo(MercConfigUtil.<span class="">MERC_NO</span>) <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">商户的商户号</span></span></li><li>        .tradeSummary(<span class=""><span class="hljs-string">"</span></span><span class=""><span class="hljs-string">请修改为对应的商品简称</span></span><span class=""><span class="hljs-string">"</span></span>) <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">请修改为商品简称</span></span></li><li>        .totalAmount(<span class=""><span class="hljs-number">2L</span></span>)</li><li>        .callbackUrl(<span class=""><span class="hljs-string">"https://www.xxxxxx.com/hw/pay/callback"</span></span>) <span class=""><span class="hljs-comment">//</span></span><span class=""><span class="hljs-comment">回调通知地址，通知</span></span><span class=""><span class="hljs-comment">URL</span></span><span class=""><span class="hljs-comment">必须为直接可访问的</span></span><span class=""><span class="hljs-comment">URL</span></span><span class=""><span class="hljs-comment">，要求为</span></span><span class=""><span class="hljs-comment">https</span></span><span class=""><span class="hljs-comment">地址。最大长度为</span></span><span class=""><span class="hljs-comment">512</span></span><span class=""><span class="hljs-comment">。请替换为格式正确的结果通知回调地址。</span></span></li><li>        .build();</li><li>}</li></ol></pre></div></div>       </div></li>      <li>请求业务接口       <p>不同API接口调用URI不一样，详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/payment-prepay" target="_blank">API参考</a>文档。</p>       <div class="p">        APP预下单请求示例如下：        <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">public</span> </span>CommonResponse <span class=""><span class="hljs-title function_">aggrPreOrderForAppV2</span></span><span class="hljs-params">()</span> {</li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">组装对象</span></span></li><li>    <span class="hljs-type">PreOrderCreateRequestV2</span> <span class="hljs-variable">preOrderReq</span> <span class="hljs-operator">=</span> getPreOrderCreateRequestV2();</li><li>    <span class="hljs-type">PreOrderCreateResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class=""><span class="hljs-literal">null</span></span>;</li><li>    <span class=""><span class="hljs-keyword">try</span> </span>{</li><li>        response = <span class="">payClient</span>.execute(<span class=""><span class="hljs-string">"POST"</span></span>, <span class=""><span class="hljs-string">"/api/v2/aggr/preorder/create/app"</span></span>, PreOrderCreateResponse.<span class="">class</span>,</li><li>            preOrderReq);</li><li>    } <span class=""><span class="hljs-keyword">catch</span> </span>(Exception e) {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">todo </span></span><span class=""><span class="hljs-comment">异常处理</span></span></li><li>        <span class="">log</span>.error(<span class=""><span class="hljs-string">"request error "</span></span>, e);</li><li>        <span class=""><span class="hljs-keyword">return</span> </span>CommonResponse.buildErrorRsp(e.getMessage());</li><li>    }</li><li>    <span class=""><span class="hljs-keyword">if</span> </span>(!validResponse(response)) {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">todo </span></span><span class=""><span class="hljs-comment">异常处理</span></span></li><li>        <span class="">log</span>.error(<span class=""><span class="hljs-string">"response is invalid "</span></span>, response);</li><li>        <span class=""><span class="hljs-keyword">return</span> </span>CommonResponse.buildFailRsp(response);</li><li>    }</li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取prepayId构建orderStr返回</span></span></li><li>    <span class=""><span class="hljs-keyword">return</span> </span>CommonResponse.buildSuccessRsp(<span class="">payClient</span>.buildOrderStr(response.getPrepayId()));</li><li>}</li><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> </span><span class=""><span class="hljs-title function_">validResponse</span></span><span class="hljs-params">(BaseGwRspWithSign rsp)</span> {</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>rsp != <span class=""><span class="hljs-literal">null</span> </span>&amp;&amp; <span class=""><span class="hljs-string">"000000"</span></span>.equals(rsp.getResultCode());</li><li>}</li></ol></pre></div></div>       </div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section18412658142616">通知回调处理<i class="anchor-icon anchor-icon-link" anchorid="section18412658142616" tips="复制节点链接"></i></h2>          <p>可使用VerifyTools.getCallbackResult方法自动处理回调结果验签并返回响应给华为支付服务器以及实现CallBackHandleInterface接口来处理回调结果。</p>     <p>通知回调处理示例如下：</p>     <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">public</span> </span>CallBackBaseResponse <span class=""><span class="hljs-title function_">transactionResultNotify</span></span><span class="hljs-params">(</span><span class=""><span class="hljs-params"><span class="hljs-meta">@RequestBody</span> </span></span><span class="hljs-params">Object callbackRequest)</span> {</li><li>    <span class="hljs-type">String</span> <span class="hljs-variable">callbackStr</span> <span class="hljs-operator">=</span> JSONObject.toJSONString(callbackRequest);</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>VerifyTools.getCallbackResult(callbackStr, MercConfigUtil.<span class="">HW_PAY_PUBLIC_KEY_FOR_CALLBACK</span>, <span class=""><span class="hljs-keyword">new</span></span> <span class="hljs-title class_">CallBackHandleInterface</span>() {</li><li>       <span class=""> <span class="hljs-meta">@Override</span></span></li><li>        <span class=""> <span class="hljs-keyword">public</span></span> <span class=""><span class="hljs-keyword">void</span></span> <span class="hljs-title function_">fail</span><span class="hljs-params">(CallBackBaseResponse response, String reqString)</span> {</li><li>          <span class="">    <span class="hljs-comment">// 未获取到字节流或者验签失败</span></span></li><li>          <span class="">    <span class="hljs-comment">// 商户自己业务处理</span></span></li><li>              log.error(<span class=""><span class="hljs-string">"CallBack failed: "</span></span>, response != <span class="hljs-literal">null</span> ? response.getResultCode() : <span class="hljs-literal">null</span>);</li><li>         }</li><li>      <span class="">   <span class="hljs-meta">@Override</span></span></li><li>        <span class=""> <span class="hljs-keyword">public</span></span> <span class=""><span class="hljs-keyword">void</span></span> <span class="hljs-title function_">success</span><span class="hljs-params">(String reqString)</span> {</li><li>              <span class="hljs-type">NotifyPaymentReq</span> <span class="hljs-variable">callbackReq</span> <span class="hljs-operator">=</span> JSONObject.parseObject(reqString, NotifyPaymentReq.<span class="">class</span>);</li><li>            <span class="">  <span class="hljs-comment">// 验签成功，商户自己业务处理</span></span></li><li>         }</li><li>    });</li><li>}</li></ol></pre></div></div>    </div>    <p>关于通知回调更多具体要求可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/payment-rest-overview#section2091445712409" target="_blank">通知回调接口说明</a>。</p>    <div class="tiledSection">     <h2 id="section1416282832417">敏感信息处理<i class="anchor-icon anchor-icon-link" anchorid="section1416282832417" tips="复制节点链接"></i></h2>          <p>为了保证API接口请求通信过程中敏感信息字段（如用户的住址、银行卡号、手机号码等，涉及加密字段会在具体API接口中标注）的机密性，鸿蒙支付服务要求加密上送。 如开发者使用对应业务接口涉及字段加密，请联系华为侧工程师获取对应的SM2加密公钥（合作咨询可<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/payment-service-support">点击此处</a>）。</p>     <p><strong>涉及密钥</strong>：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.4.1.1" valign="top" width="17.28172817281728%">          <p>密钥类型</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.4.1.2" valign="top" width="35.13351335133513%">          <p>来源</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.4.1.3" valign="top" width="47.584758475847586%">          <p>作用</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="17.28172817281728%">          <p>SM2</p></td>         <td class="cellrowborder" valign="top" width="35.13351335133513%">          <p>华为支付提供。</p></td>         <td class="cellrowborder" valign="top" width="47.584758475847586%">          <p>加密开发者生成的SM4密钥。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="17.28172817281728%">          <p>SM4</p></td>         <td class="cellrowborder" valign="top" width="35.13351335133513%">          <p>开发者生成。</p></td>         <td class="cellrowborder" valign="top" width="47.584758475847586%">          <p>加密敏感信息字段。</p></td>        </tr>             </tbody></table></div>     </div>     <p><strong>处理逻辑：</strong></p>     <p>1、开发者生成SM4对称密钥，用于加密敏感数据内容并作为入参传递给华为支付。</p>     <p>2、开发者使用华为支付提供的SM2密钥加密生成的SM4对称密钥并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/payment-model#section11744172016145" target="_blank">PayMercAuth</a>.sessionKey字段传递给华为支付用于解密敏感信息。</p>     <p>本质为SM4对称密钥加密，示例代码如下：</p>     <div _ngcontent-msp-c106="" class="highlight-div"><div _ngcontent-msp-c106="" class="highlight-div-header"><div _ngcontent-msp-c106="" class="highlight-div-header-left"><div _ngcontent-msp-c106="" class="handle-button expand-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msp-c106="" class="highlight-div-header-right"><div _ngcontent-msp-c106="" class="handle-button ai-button"></div><div _ngcontent-msp-c106="" class="handle-button line-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msp-c106="" class="handle-button theme-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msp-c106="" class="handle-button copy-button"><div _ngcontent-msp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msp-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.apiservice.client.model.MgmtSubmercRsp;</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.core.client.DefaultPetalPayClient;</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.core.client.PetalPayClient;</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.core.config.RequestConfig;</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.core.tools.SM4Util;</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.huawei.petalpay.paymentservice.example.common.MercConfigUtil;</li><li>
</li><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> </span><span class="hljs-title class_">SignRegister</span> {</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> </span><span class=""><span class="hljs-title function_">main</span></span><span class="hljs-params">(String[] args)</span> {</li><li>        <span class="hljs-type">PetalPayClient</span> <span class="hljs-variable">payClient</span> <span class="hljs-operator">=</span> <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">DefaultPetalPayClient</span>(MercConfigUtil.getMercConfig());</li><li>        <span class="hljs-type">String</span> <span class="hljs-variable">sessionKey</span> <span class="hljs-operator">=</span> SM4Util.getSM4GCMSessionKey();</li><li>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class=""><span class="hljs-string">"xxxxxx"</span></span>;</li><li>        <span class="hljs-type">RegisterSubmercReq</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">RegisterSubmercReq</span>(SM4Util.getSM4GCMContent(sessionKey, message));</li><li>        <span class="hljs-type">RequestConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RequestConfig.builder()</li><li>            .publicKeyForSessionKey(MercConfigUtil.<span class="">HW_PUBLIC_KEY_FOR_SESSIONKEY</span>)</li><li>            .sessionKey(sessionKey)</li><li>            .build();</li><li>        <span class=""><span class="hljs-keyword">try</span> </span>{</li><li>            <span class="hljs-type">MgmtSubmercRsp</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> payClient.execute(<span class=""><span class="hljs-string">"POST"</span></span>, <span class=""><span class="hljs-string">"/api/v1/partner/mgmt/submerc/register"</span></span>, </li><li>                MgmtSubmercRsp.<span class="">class</span>, config, req);</li><li>        } <span class=""><span class="hljs-keyword">catch</span> </span>(Exception e) {</li><li>            <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">todo </span></span><span class=""><span class="hljs-comment">异常处理</span></span></li><li>        }</li><li>    }</li><li>    <span class=""><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> </span><span class="hljs-title class_">RegisterSubmercReq</span> {</li><li>        <span class=""><span class="hljs-keyword">private</span> </span>String <span class="">message</span>;</li><li>        <span class=""><span class="hljs-keyword">public</span> </span><span class=""><span class="hljs-title function_">RegisterSubmercReq</span></span><span class="hljs-params">(String message)</span> {</li><li>            <span class=""><span class="hljs-built_in">this</span></span>.<span class="">message </span>= message;</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>