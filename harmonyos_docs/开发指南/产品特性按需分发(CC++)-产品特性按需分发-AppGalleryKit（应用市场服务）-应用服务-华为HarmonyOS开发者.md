<h1 _ngcontent-iao-c119="" class="doc-title ng-star-inserted" title="产品特性按需分发(C/C++)"> 产品特性按需分发(C/C++) </h1>

<div _ngcontent-iao-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section15372484511">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section15372484511" tips="复制节点链接"></i></h2>          <p>随着HarmonyOS应用的持续发展，应用的功能将越来越丰富，实际上80%的用户使用时长都会集中在20%的特性上，其余的功能可能也仅仅是面向部分用户。为了避免用户首次下载应用耗时过长，及过多占用用户空间，应用市场服务提供按需分发的能力，支持用户按需动态下载自己所需的增强特性。</p>    </div>    <div class="tiledSection">     <h2 id="section12051840143913">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section12051840143913" tips="复制节点链接"></i></h2>          <p>按需分发：一个应用程序被打包成多个安装包，安装包包含了所有的应用程序代码和静态资源。用户从应用市场下载的应用只包含基本功能的安装包，当用户需要使用增强功能时，相应安装包将会从服务器下载到设备上。</p>    </div>    <div class="tiledSection">     <h2 id="section2933193284216">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2933193284216" tips="复制节点链接"></i></h2>          <ul>      <li>应用需要上架应用市场。</li>      <li>产品特性按需分发功能支持Phone、Tablet、PC/2in1设备。并且从5.1.1(19)版本开始，新增支持TV设备。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section3584151102912">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section3584151102912" tips="复制节点链接"></i></h2>          <p>产品特性按需分发场景提供以下C接口，具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#函数" target="_blank">接口说明</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="49.95%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="50.05%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#oh_osaccount_getname" target="_blank">HMS_ModuleInstall_GetInstalledModule</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>查询模块是否安装。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section19475184213526" target="_blank">HMS_ModuleInstall_GetInstalledModuleName</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块名。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section39341746155513" target="_blank">HMS_ModuleInstall_GetInstalledModuleType</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块类型。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section84699521566" target="_blank">HMS_ModuleInstall_GetModuleInstallStatus</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块安装状态。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1533121613581" target="_blank">HMS_ModuleInstall_FetchModules</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>请求下载模块。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section191414113614" target="_blank">HMS_ModuleInstall_GetFetchModulesRequestCode</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载请求码。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section142448141910" target="_blank">HMS_ModuleInstall_GetFetchModulesTaskStatus</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载任务状态。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section979412409101" target="_blank">HMS_ModuleInstall_GetFetchModulesTaskId</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载任务id。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section762681812121" target="_blank">HMS_ModuleInstall_GetFetchModulesDesc</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载描述。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section55521545111313" target="_blank">HMS_ModuleInstall_GetFetchModules</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载模块名。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1071043411515" target="_blank">HMS_ModuleInstall_GetFetchModulesTotalSize</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载总大小。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section04641118168" target="_blank">HMS_ModuleInstall_GetFetchModulesDownloadedSize</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取模块下载已下载大小。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1177619221712" target="_blank">HMS_ModuleInstall_CancelTask</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>取消下载任务。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1897653081720" target="_blank">HMS_ModuleInstall_ShowCellularDataConfirmation</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>展示流量弹窗。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1710031151816" target="_blank">HMS_ModuleInstall_CreateStatusCallback</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>创建下载进度监听回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section18492123951816" target="_blank">HMS_ModuleInstall_On</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>下载进度监听。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1541418516194" target="_blank">HMS_ModuleInstall_ReleaseStatusCallback</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>释放下载进度监听回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1260162551917" target="_blank">HMS_ModuleInstall_Off</a></p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>取消下载进度监听。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="使用入门">使用指导<i class="anchor-icon anchor-icon-link" anchorid="使用入门" tips="复制节点链接"></i></h2>          <p>应用要使用ModuleInstall提供的按需分发能力，需要添加对应的头文件。</p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在CMake脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libhmsmoduleinstall.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="添加头文件">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="添加头文件" tips="复制节点链接"></i></h3>          <p>需要开发者引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-module_install" target="_blank">module_install.h</a>头文件后，才可以使用按需分发相关API。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AppGalleryKit/module_install.h"</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="获取音频会话管理器">获取模块安装信息<i class="anchor-icon anchor-icon-link" anchorid="获取音频会话管理器" tips="复制节点链接"></i></h2>          <p>在使用按需分发能力之前，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#oh_osaccount_getname" target="_blank">HMS_ModuleInstall_GetInstalledModule</a>接口查询按需分发的模块是否安装，接口调用成功后，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section19475184213526" target="_blank">HMS_ModuleInstall_GetInstalledModuleName</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section39341746155513" target="_blank">HMS_ModuleInstall_GetInstalledModuleType</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section84699521566" target="_blank">HMS_ModuleInstall_GetModuleInstallStatus</a>接口分别获取模块名称、模块类型、模块安装状态信息。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *moduleName;</li><li>ModuleInstall_InstalledModule *installedModule;</li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModule</span>(moduleName, <span class="hljs-built_in">strlen</span>(moduleName), &amp;installedModule);</li><li><span class="hljs-keyword">if</span> (ret == E_NO_ERROR) {</li><li>    <span class="hljs-type">char</span> *installedModuleName = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModuleName</span>(installedModule);</li><li>    <span class="hljs-type">int</span> moduleType = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModuleType</span>(installedModule);</li><li>    <span class="hljs-type">int</span> installStatus = <span class="hljs-built_in">HMS_ModuleInstall_GetModuleInstallStatus</span>(installedModule);</li><li>}</li><li><span class="hljs-keyword">if</span> (installedModule != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">delete</span> installedModule;</li><li>    installedModule = <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="激活音频会话">按需加载模块<i class="anchor-icon anchor-icon-link" anchorid="激活音频会话" tips="复制节点链接"></i></h2>          <p>应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1533121613581" target="_blank">HMS_ModuleInstall_FetchModules</a>按需加载模块，接口调用成功之后可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section191414113614" target="_blank">HMS_ModuleInstall_GetFetchModulesRequestCode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section142448141910" target="_blank">HMS_ModuleInstall_GetFetchModulesTaskStatus</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section979412409101" target="_blank">HMS_ModuleInstall_GetFetchModulesTaskId</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section762681812121" target="_blank">HMS_ModuleInstall_GetFetchModulesDesc</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section55521545111313" target="_blank">HMS_ModuleInstall_GetFetchModules</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1071043411515" target="_blank">HMS_ModuleInstall_GetFetchModulesTotalSize</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section04641118168" target="_blank">HMS_ModuleInstall_GetFetchModulesDownloadedSize</a>接口获取模块下载相关信息。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *bundleName;</li><li><span class="hljs-type">int</span> arraySize = <span class="hljs-number">1</span>;</li><li><span class="hljs-type">char</span>** moduleNames = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>*[arraySize];</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>     moduleNames[i] = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">256</span>];</li><li>}</li><li>ModuleInstall_FetchModulesResult *fetchModulesResult;</li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_FetchModules</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), moduleNames, arraySize, &amp;fetchModulesResult);</li><li><span class="hljs-keyword">if</span> (ret == E_NO_ERROR) {</li><li>    ModuleInstall_RequestCode code = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesRequestCode</span>(fetchModulesResult);</li><li>    ModuleInstall_TaskStatus taskStatus = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTaskStatus</span>(fetchModulesResult);</li><li>    <span class="hljs-type">char</span> *taskId = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTaskId</span>(fetchModulesResult);</li><li>    <span class="hljs-type">char</span> *desc = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesDesc</span>(fetchModulesResult);</li><li>    <span class="hljs-type">char</span> *modules = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModules</span>(fetchModulesResult);</li><li>    <span class="hljs-type">int</span> totalSize = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTotalSize</span>(fetchModulesResult);</li><li>    <span class="hljs-type">int</span> downloadedSize = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesDownloadedSize</span>(fetchModulesResult);</li><li>}</li><li><span class="hljs-keyword">if</span> (moduleNames != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">delete</span>[] moduleNames;</li><li>    moduleNames = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (fetchModulesResult != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">delete</span> fetchModulesResult;</li><li>    fetchModulesResult = <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="停用音频会话">取消下载任务<i class="anchor-icon anchor-icon-link" anchorid="停用音频会话" tips="复制节点链接"></i></h2>          <p>如果需要取消下载，应用可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1177619221712" target="_blank">HMS_ModuleInstall_CancelTask</a>接口取消下载任务，其中taskId是调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section979412409101" target="_blank">HMS_ModuleInstall_GetFetchModulesTaskId</a>接口返回的taskId。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *taskId; <span class="hljs-comment">// 下载任务id</span></li><li><span class="hljs-type">int</span> cancelResult; <span class="hljs-comment">// 取消下载结果</span></li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_CancelTask</span>(taskId, <span class="hljs-built_in">strlen</span>(taskId), cancelResult);</li><li><span class="hljs-keyword">if</span> (ret == E_NO_ERROR &amp;&amp; cancelResult == <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 取消下载成功</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="查询音频会话是否已激活">展示流量弹窗<i class="anchor-icon anchor-icon-link" anchorid="查询音频会话是否已激活" tips="复制节点链接"></i></h2>          <p>如果调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section191414113614" target="_blank">HMS_ModuleInstall_GetFetchModulesRequestCode</a>接口返回DOWNLOAD_WAIT_WIFI时，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1897653081720" target="_blank">HMS_ModuleInstall_ShowCellularDataConfirmation</a>接口展示流量弹窗。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *taskId; <span class="hljs-comment">// 下载任务id</span></li><li><span class="hljs-type">int</span> showResult; <span class="hljs-comment">// 展示流量弹窗结果</span></li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_ShowCellularDataConfirmation</span>(taskId, <span class="hljs-built_in">strlen</span>(taskId), showResult);</li><li><span class="hljs-keyword">if</span> (ret == E_NO_ERROR &amp;&amp; showResult == <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 展示流量弹窗成功</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="注册音频会话停用事件回调取消注册音频会话停用事件回调">监听下载任务<i class="anchor-icon anchor-icon-link" anchorid="注册音频会话停用事件回调取消注册音频会话停用事件回调" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="定义回调函数" class="firsth2">定义监听下载回调函数<i class="anchor-icon anchor-icon-link" anchorid="定义回调函数" tips="复制节点链接"></i></h3>          <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onEvent</span><span class="hljs-params">(<span class="hljs-type">char</span> *bundleName, <span class="hljs-type">char</span> *eventInfo)</span> </span>{</li><li>    <span class="hljs-comment">// 回调处理</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="注册音频会话停用事件回调">初始化下载进度回调<i class="anchor-icon anchor-icon-link" anchorid="注册音频会话停用事件回调" tips="复制节点链接"></i></h3>          <p>应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1710031151816" target="_blank">HMS_ModuleInstall_CreateStatusCallback</a>初始化下载进度回调。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>ModuleInstall_StatusCallback *statusCallback;</li><li>ModuleInstall_OnStatusCallback onStatusCallback = onEvent;</li><li>statusCallback = <span class="hljs-built_in">HMS_ModuleInstall_CreateStatusCallback</span>(&amp;onStatusCallback);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="取消注册音频会话停用事件回调">监听下载进度<i class="anchor-icon anchor-icon-link" anchorid="取消注册音频会话停用事件回调" tips="复制节点链接"></i></h3>          <p>应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section18492123951816" target="_blank">HMS_ModuleInstall_On</a>接口监听下载进度。</p>     <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *bundleName; <span class="hljs-comment">// 应用包名</span></li><li><span class="hljs-type">int</span> appIndex; <span class="hljs-comment">// 应用分身索引</span></li><li><span class="hljs-type">int</span> period; <span class="hljs-comment">// 监听周期</span></li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_On</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), appIndex, period, &amp;statusCallback);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="section178501241103116">取消监听下载任务<i class="anchor-icon anchor-icon-link" anchorid="section178501241103116" tips="复制节点链接"></i></h2>         </div>    <p>应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/store-c-moduleinstall#section1260162551917" target="_blank">HMS_ModuleInstall_Off</a>接口取消下载进度监听。</p>    <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> *bundleName; <span class="hljs-comment">// 应用包名</span></li><li><span class="hljs-type">int</span> appIndex; <span class="hljs-comment">// 应用分身索引</span></li><li>ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_Off</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), appIndex);</li><li><span class="hljs-keyword">if</span> (ret == E_NO_ERROR) {</li><li>    <span class="hljs-comment">//取消监听成功</span></li><li>}</li></ol></pre></div></div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div class="p">      参考以下示例，完成应用按需分发过程。      <div _ngcontent-iao-c106="" class="highlight-div"><div _ngcontent-iao-c106="" class="highlight-div-header"><div _ngcontent-iao-c106="" class="highlight-div-header-left"><div _ngcontent-iao-c106="" class="handle-button expand-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iao-c106="" class="highlight-div-header-right"><div _ngcontent-iao-c106="" class="handle-button ai-button"></div><div _ngcontent-iao-c106="" class="handle-button line-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iao-c106="" class="handle-button theme-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iao-c106="" class="handle-button copy-button"><div _ngcontent-iao-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iao-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AppGalleryKit/module_install.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetInstalledModule</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">char</span> *moduleName;</li><li>    ModuleInstall_InstalledModule *installedModule;</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModule</span>(moduleName, <span class="hljs-built_in">strlen</span>(moduleName), &amp;installedModule);</li><li>    <span class="hljs-keyword">if</span> (ret == E_NO_ERROR) {</li><li>        <span class="hljs-type">char</span> *installedModuleName = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModuleName</span>(installedModule);</li><li>        <span class="hljs-type">int</span> moduleType = <span class="hljs-built_in">HMS_ModuleInstall_GetInstalledModuleType</span>(installedModule);</li><li>        <span class="hljs-type">int</span> installStatus = <span class="hljs-built_in">HMS_ModuleInstall_GetModuleInstallStatus</span>(installedModule);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (installedModule != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">delete</span> installedModule;</li><li>        installedModule = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowCellularDataConfirmation</span><span class="hljs-params">(<span class="hljs-type">char</span> *taskId)</span> </span>{</li><li>    <span class="hljs-type">int</span> showResult;</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_ShowCellularDataConfirmation</span>(taskId, <span class="hljs-built_in">strlen</span>(taskId), showResult);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FetchModules</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">char</span> *bundleName;</li><li>    <span class="hljs-type">int</span> arraySize = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">char</span> **moduleNames = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span> *[arraySize];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>        moduleNames[i] = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">256</span>];</li><li>    }</li><li>    ModuleInstall_FetchModulesResult *fetchModulesResult;</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_FetchModules</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), moduleNames, arraySize, &amp;fetchModulesResult);</li><li>    <span class="hljs-keyword">if</span> (ret == E_NO_ERROR) {</li><li>        ModuleInstall_TaskStatus taskStatus = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTaskStatus</span>(fetchModulesResult);</li><li>        <span class="hljs-type">char</span> *taskId = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTaskId</span>(fetchModulesResult);</li><li>        ModuleInstall_RequestCode code = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesRequestCode</span>(fetchModulesResult);</li><li>        <span class="hljs-keyword">if</span> (code == DOWNLOAD_WAIT_WIFI) {</li><li>            <span class="hljs-built_in">ShowCellularDataConfirmation</span>(taskId);</li><li>        }</li><li>        <span class="hljs-type">char</span> *desc = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesDesc</span>(fetchModulesResult);</li><li>        <span class="hljs-type">char</span> *modules = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModules</span>(fetchModulesResult);</li><li>        <span class="hljs-type">int</span> totalSize = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesTotalSize</span>(fetchModulesResult);</li><li>        <span class="hljs-type">int</span> downloadedSize = <span class="hljs-built_in">HMS_ModuleInstall_GetFetchModulesDownloadedSize</span>(fetchModulesResult);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (moduleNames != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">delete</span>[] moduleNames;</li><li>        moduleNames = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (fetchModulesResult != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">delete</span> fetchModulesResult;</li><li>        fetchModulesResult = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CancelTask</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">char</span> *taskId;</li><li>    <span class="hljs-type">int</span> cancelResult;</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_CancelTask</span>(taskId, <span class="hljs-built_in">strlen</span>(taskId), cancelResult);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onEvent</span><span class="hljs-params">(<span class="hljs-type">char</span> *bundleName, <span class="hljs-type">char</span> *eventInfo)</span> </span>{}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">On</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">char</span> *bundleName;</li><li>    <span class="hljs-type">int</span> appIndex;</li><li>    <span class="hljs-type">int</span> period;</li><li>    ModuleInstall_StatusCallback *statusCallback;</li><li>    ModuleInstall_OnStatusCallback onStatusCallback = onEvent;</li><li>    statusCallback = <span class="hljs-built_in">HMS_ModuleInstall_CreateStatusCallback</span>(&amp;onStatusCallback);</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_On</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), appIndex, period, &amp;statusCallback);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Off</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">char</span> *bundleName;</li><li>    <span class="hljs-type">int</span> appIndex;</li><li>    ModuleInstall_ErrCode ret = <span class="hljs-built_in">HMS_ModuleInstall_Off</span>(bundleName, <span class="hljs-built_in">strlen</span>(bundleName), appIndex);</li><li>}</li></ol></pre></div></div>     </div>    </div>   </div>   <div></div></div>