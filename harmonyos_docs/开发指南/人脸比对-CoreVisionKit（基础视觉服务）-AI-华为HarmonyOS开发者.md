<h1 _ngcontent-ktq-c119="" class="doc-title ng-star-inserted" title="人脸比对"> 人脸比对 </h1>

<div _ngcontent-ktq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section470850154811">适用场景<i class="anchor-icon anchor-icon-link" anchorid="section470850154811" tips="复制节点链接"></i></h2>          <p>输入的两张比对图片是同一个人的照片时，系统返回的比对结果为"同一个人"，置信分数比较高；当两张比对图片不是同一个人的照片时，系统返回的比对结果为"非同一个人"，置信分数很低。可以用于APP中需要用到人脸比对功能的场景，比如娱乐类APP中比较两个人的相似度、与明星的相似度等。</p>     <p>效果如下图所示：</p>     <p><span><img originheight="661" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114226.26227522337012463121427049902222:50001231000000:2800:BFDF7A7E3AB3DD88F33039DA33578C6D86C9D031CEC58954F44E6D21CBB8B7E6.png" width="320" height="661"></span></p>    </div>    <div class="tiledSection">     <h2 id="section2020122517405">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2020122517405" tips="复制节点链接"></i></h2>          <p>该能力当前不支持模拟器。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="38.96%">          <p>AI能力</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="61.040000000000006%">          <p>约束</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="38.96%">          <p>人脸比对</p></td>         <td class="cellrowborder" valign="top" width="61.040000000000006%">          <ul>           <li>当前功能只支持1v1人脸比对。</li>           <li>输入的两张图像都需要合适的成像质量（建议720p以上），<span style="color: rgb(55,65,81);">224px</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">高度</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">15210px，100px</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">宽度</span><span style="color: rgb(55,65,81);">&lt;</span><span style="color: rgb(55,65,81);">10000px</span>，高宽比例建议10:1以下（高度小于宽度的10倍），接近手机屏幕高宽比例为宜。</li>          </ul></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section33671724817">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section33671724817" tips="复制节点链接"></i></h2>          <ol>      <li><span>在使用人脸比对时，将实现人脸比对相关的类添加至工程。</span>       <p></p>       <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { faceComparator } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreVisionKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>简单配置页面的布局，并在Button组件添加点击事件，拉起图库，选择图片。</span>       <p></p>       <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">'选择图片'</span>)</li><li>  .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>  .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>  .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>  .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 拉起图库，获取图片资源</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectImage</span>();</li><li>  })</li></ol></pre></div></div>       <p></p></li>      <li><span>通过图库获取图片资源，将图片转换为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>，并添加初始化和释放方法。</span>       <p></p>       <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> initResult = <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">init</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Face comparator initialization result:<span class="hljs-subst">${initResult}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">release</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Face comparator released successfully'</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectImage</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openPhoto</span>()</li><li>  <span class="hljs-keyword">if</span> (uri === <span class="hljs-literal">undefined</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'faceCompare'</span>, <span class="hljs-string">"Failed to get two image uris."</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(uri);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">openPhoto</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">photoPicker</span>: photoAccessHelper.<span class="hljs-property">PhotoViewPicker</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>    photoPicker.<span class="hljs-title function_">select</span>({</li><li>      <span class="hljs-title class_">MIMEType</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>,</li><li>      <span class="hljs-attr">maxSelectNumber</span>: <span class="hljs-number">2</span></li><li>    }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">photoUris</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get photo image uris. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-title function_">reject</span>();</li><li>    });</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">names: <span class="hljs-built_in">string</span>[]</span>) {</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>();</li><li>    fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">1</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>();</li><li>  }, <span class="hljs-number">100</span></li><li>  )</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>实现人脸比对功能。<span style="color: rgb(55,65,81);">实例化</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-facecomparator-api#section674171818172" target="_blank">VisionInfo</a><span style="color: rgb(55,65,81);">对象，</span><span style="color: rgb(55,65,81);">传入两张图片的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a><span style="color: rgb(55,65,81);">，调用</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-facecomparator-api#section16178105410532" target="_blank">faceComparator.compareFaces</a><span style="color: rgb(55,65,81);">方法进行人脸比对。</span></span>       <p></p>       <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用人脸比对接口</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo</span>: faceComparator.<span class="hljs-property">VisionInfo</span> = {</li><li>  <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>,</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo1</span>: faceComparator.<span class="hljs-property">VisionInfo</span> = {</li><li>  <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span>,</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>:faceComparator.<span class="hljs-property">FaceCompareResult</span> = <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">compareFaces</span>(visionInfo, visionInfo1);</li></ol></pre></div></div>       <p></p></li>      <li><span><span style="color: rgb(55,65,81);">（可选）如果需要将结果展示在界面上，可以用下列代码。</span></span>       <p></p>       <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>:faceComparator.<span class="hljs-property">FaceCompareResult</span> = <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">compareFaces</span>(visionInfo, visionInfo1);</li><li><span class="hljs-keyword">let</span> faceString = <span class="hljs-string">"degree of similarity: "</span>+ <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toPercentage</span>(data.<span class="hljs-property">similarity</span>)+((data.<span class="hljs-property">isSamePerson</span>)?<span class="hljs-string">". is"</span>:<span class="hljs-string">". no"</span>)+ <span class="hljs-string">" same person"</span>;</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"faceString data is "</span> + faceString);</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span> = faceString;</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1564831315485">开发实例<i class="anchor-icon anchor-icon-link" anchorid="section1564831315485" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section44291859797" class="firsth2">Index.ets<i class="anchor-icon anchor-icon-link" anchorid="section44291859797" tips="复制节点链接"></i></h3>          <div _ngcontent-ktq-c106="" class="highlight-div"><div _ngcontent-ktq-c106="" class="highlight-div-header"><div _ngcontent-ktq-c106="" class="highlight-div-header-left"><div _ngcontent-ktq-c106="" class="handle-button expand-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ktq-c106="" class="highlight-div-header-right"><div _ngcontent-ktq-c106="" class="handle-button ai-button"></div><div _ngcontent-ktq-c106="" class="handle-button line-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ktq-c106="" class="handle-button theme-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ktq-c106="" class="handle-button copy-button"><div _ngcontent-ktq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ktq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { faceComparator } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreVisionKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"FaceCompareSample"</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">chooseImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">chooseImage1</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataValues</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">const</span> initResult = <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">init</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Face comparator initialization result:<span class="hljs-subst">${initResult}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">await</span> faceComparator.<span class="hljs-title function_">release</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Face comparator released successfully'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">accessibilityDescription</span>(<span class="hljs-string">"默认图片1"</span>)</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">accessibilityDescription</span>(<span class="hljs-string">"默认图片2"</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span>)</li><li>        .<span class="hljs-title function_">copyOption</span>(<span class="hljs-title class_">CopyOptions</span>.<span class="hljs-property">LocalDevice</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'15%'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'60%'</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'选择图片'</span>)</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 拉起图库</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectImage</span>()</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'人脸比对'</span>)</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span>) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"Failed to choose image"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-comment">// 调用人脸比对接口</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo</span>: faceComparator.<span class="hljs-property">VisionInfo</span> = {</li><li>            <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span>,</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo1</span>: faceComparator.<span class="hljs-property">VisionInfo</span> = {</li><li>            <span class="hljs-attr">pixelMap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span>,</li><li>          };</li><li>          faceComparator.<span class="hljs-title function_">compareFaces</span>(visionInfo, visionInfo1)</li><li>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: faceComparator.FaceCompareResult</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> faceString = <span class="hljs-string">"degree of similarity: "</span>+ <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toPercentage</span>(data.<span class="hljs-property">similarity</span>)+((data.<span class="hljs-property">isSamePerson</span>)?<span class="hljs-string">". is"</span>:<span class="hljs-string">". no"</span>)+ <span class="hljs-string">" same person"</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"faceString data is "</span> + faceString);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span> = faceString;</li><li>            })</li><li>            .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Face comparison failed. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataValues</span> = <span class="hljs-string">`Error: <span class="hljs-subst">${error.message}</span>`</span>;</li><li>            });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toPercentage</span>(<span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(num * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)}</span>%`</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectImage</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openPhoto</span>()</li><li>    <span class="hljs-keyword">if</span> (uri === <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"Failed to get two image uris."</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadImage</span>(uri);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">openPhoto</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">photoPicker</span>: photoAccessHelper.<span class="hljs-property">PhotoViewPicker</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>      photoPicker.<span class="hljs-title function_">select</span>({</li><li>        <span class="hljs-title class_">MIMEType</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>,</li><li>        <span class="hljs-attr">maxSelectNumber</span>: <span class="hljs-number">2</span></li><li>      }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {</li><li>        <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">photoUris</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get photo image uris. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-title function_">reject</span>();</li><li>      });</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">loadImage</span>(<span class="hljs-params">names: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">fileSource</span>: fileIo.<span class="hljs-property">File</span></li><li>      <span class="hljs-keyword">try</span> {</li><li>        fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>        imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>();</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to open file. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        fileSource = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(names[<span class="hljs-number">1</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>        imageSource = image.<span class="hljs-title function_">createImageSource</span>(fileSource.<span class="hljs-property">fd</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">chooseImage1</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>();</li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">close</span>(fileSource);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to open the second file. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>      }</li><li>    }, <span class="hljs-number">100</span></li><li>    )</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>