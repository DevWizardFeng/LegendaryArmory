<h1 _ngcontent-bhb-c119="" class="doc-title ng-star-inserted" title="从OpenSL ES切换到OHAudio(C/C++)"> 从OpenSL ES切换到OHAudio(C/C++) </h1>

<div _ngcontent-bhb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>由于OpenSL ES无法满足音频系统的能力拓展，建议开发者使用OHAudio替代OpenSL ES开发音频业务。本文将介绍如何从使用OpenSL ES接口开发音频业务，切换为使用OHAudio接口。</p>  <div class="tiledSection"><h2 id="支持的功能差异">支持的功能差异<i class="anchor-icon anchor-icon-link" anchorid="支持的功能差异" tips="复制节点链接"></i></h2><p>两者支持的功能范围略有差异，OHAudio增加支持低时延播放/录制、监听业务变化等功能。</p> <p>具体差异如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.1" valign="top" width="33.33333333333333%">功能</th> <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.2" valign="top" width="33.33333333333333%">OpenSL ES</th> <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.3" valign="top" width="33.33333333333333%">OHAudio</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">音频流式播放</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">音频流式录制</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">音频低时延播放</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">音频低时延录制</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">播放对象状态切换</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">录制对象状态切换</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">获取音频流对象状态</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">清理播放缓存</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">监听音频打断事件</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">监听音频流事件</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">监听流异常事件</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">监听播放设备变化事件</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">×</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">√</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="开发模式差异">开发模式差异<i class="anchor-icon anchor-icon-link" anchorid="开发模式差异" tips="复制节点链接"></i></h2><p>此小节将结合开发步骤，对比介绍OHAudio和OpenSL ES在开发模式上的差异。</p> <p>音频播放和录制的实现类似，此处以音频播放为例说明。</p> </div>  <div class="tiledSection"><h3 id="构造实例" class="firsth2">构造实例<i class="anchor-icon anchor-icon-link" anchorid="构造实例" tips="复制节点链接"></i></h3><p>OpenSL ES:</p> <p>通过全局接口获取到Engine对象，基于Engine结合不同输入输出配置参数，构造出不同音频播放对象。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 生成Engine Inteface对象。</span></li><li>SLEngineItf engine;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 按需配置音频输入slSource。</span></li><li>SLDataSource slSource;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 按需配置音频输出slSink。</span></li><li>SLDataSink slSink;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 生成音频播放对象。</span></li><li>SLObjectItf playerObject;</li><li>(*engine)-&gt;<span class="hljs-built_in">CreateAudioPlayer</span>(engine,</li><li>                             &amp;playerObject,</li><li>                             &amp;slSource,</li><li>                             &amp;slSink,</li><li>                             <span class="hljs-number">0</span>,</li><li>                             <span class="hljs-literal">nullptr</span>,</li><li>                             <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>(*playerObject)-&gt;<span class="hljs-built_in">Realize</span>(playerObject,</li><li>                         SL_BOOLEAN_FALSE);</li></ol></pre></div></div> <p>OHAudio:</p> <p>采用建造器模式，通过建造器，配合自定义参数设置，生成音频播放对象。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建建造器。</span></li><li>OH_AudioStreamBuilder *builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, AUDIOSTREAM_TYPE_RENDERER);</li><li>
</li><li><span class="hljs-comment">// 设置自定义参数，否则会使用默认参数。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSamplingRate</span>(builder, <span class="hljs-number">48000</span>);</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelCount</span>(builder, <span class="hljs-number">2</span>);</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSampleFormat</span>(builder, AUDIOSTREAM_SAMPLE_S16LE);</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetEncodingType</span>(builder, AUDIOSTREAM_ENCODING_TYPE_RAW);</li><li><span class="hljs-comment">// 关键参数，仅OHAudio支持，根据音频用途设置，系统会根据此参数实现音频策略自适应。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererInfo</span>(builder, AUDIOSTREAM_USAGE_MUSIC);</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 生成音频播放对象。</span></li><li>OH_AudioRenderer *audioRenderer;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_GenerateRenderer</span>(builder, &amp;audioRenderer);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="状态切换">状态切换<i class="anchor-icon anchor-icon-link" anchorid="状态切换" tips="复制节点链接"></i></h3><p>OpenSL ES:</p> <p>基于Object获取状态切换Interface，使用Interface接口切换状态，只有SL_PLAYSTATE_STOPPED、SL_PLAYSTATE_PAUSED、SL_PLAYSTATE_PLAYING三种状态。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 基于播放对象，获取播放操作Interface。</span></li><li>SLPlayItf playItf = <span class="hljs-literal">nullptr</span>;</li><li>(*playerObject)-&gt;<span class="hljs-built_in">GetInterface</span>(playerObject, SL_IID_PLAY, &amp;playItf);</li><li><span class="hljs-comment">// 状态切换。</span></li><li>(*playItf)-&gt;<span class="hljs-built_in">SetPlayState</span>(playItf, SL_PLAYSTATE_PLAYING);</li><li>(*playItf)-&gt;<span class="hljs-built_in">SetPlayState</span>(playItf, SL_PLAYSTATE_PAUSED);</li><li>(*playItf)-&gt;<span class="hljs-built_in">SetPlayState</span>(playItf, SL_PLAYSTATE_STOPPED);</li></ol></pre></div></div> <p>OHAudio:</p> <p>有独立的状态切换接口，基于状态机进行状态切换，共6个OH_AudioStream_State状态，主要在AUDIOSTREAM_STATE_PREPARED、AUDIOSTREAM_STATE_RUNNING、AUDIOSTREAM_STATE_STOPPED、AUDIOSTREAM_STATE_PAUSED、AUDIOSTREAM_STATE_RELEASED状态间切换。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 状态切换。</span></li><li><span class="hljs-built_in">OH_AudioRenderer_Start</span>(audioRenderer);</li><li><span class="hljs-built_in">OH_AudioRenderer_Pause</span>(audioRenderer);</li><li><span class="hljs-built_in">OH_AudioRenderer_Stop</span>(audioRenderer);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="数据处理">数据处理<i class="anchor-icon anchor-icon-link" anchorid="数据处理" tips="复制节点链接"></i></h3><p>OpenSL ES:</p> <p>基于扩展的OHBufferQueue接口，通过注册自定义的Callback函数，根据数据请求时机，将待播放数据填入系统内提供的缓冲区中。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">MyBufferQueueCallback</span><span class="hljs-params">(SLOHBufferQueueItf bufferQueueItf, <span class="hljs-type">void</span> *pContext, SLuint32 size)</span></span></li><li><span class="hljs-function"></span>{</li><li>    SLuint8 *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    SLuint32 bufferSize;</li><li>    <span class="hljs-comment">// 获取系统内提供的buffer。</span></li><li>    (*bufferQueueItf)-&gt;<span class="hljs-built_in">GetBuffer</span>(bufferQueueItf, &amp;buffer, &amp;bufferSize);</li><li>    <span class="hljs-comment">// 将待播放音频数据写入buffer。</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 将buffer输入系统。</span></li><li>    (*bufferQueueItf)-&gt;<span class="hljs-built_in">Enqueue</span>(bufferQueueItf, buffer, bufferSize);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取OHBufferQueue接口。</span></li><li>SLOHBufferQueueItf bufferQueueItf;</li><li>(*playerObject)-&gt;<span class="hljs-built_in">GetInterface</span>(playerObject, SL_IID_OH_BUFFERQUEUE, &amp;bufferQueueItf);</li><li><span class="hljs-comment">// 可传入自定义的上下文信息，会在Callback内收到。</span></li><li><span class="hljs-type">void</span> *pContext;</li><li>(*bufferQueueItf)-&gt;<span class="hljs-built_in">RegisterCallback</span>(bufferQueueItf, MyBufferQueueCallback, pContext);</li></ol></pre></div></div> <p>OHAudio:</p> <p>统一使用回调模式，在构造时注册数据输入回调，实现自定义的数据填充函数，在播放过程中会跟随系统调度和时延配置情况，自动在合适时机触发数据请求回调。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnWriteData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer *renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span> *userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span> *buffer,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> bufferLen)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放数据按照请求的bufferLen长度，填入buffer。</span></li><li>    <span class="hljs-comment">// 函数返回后，系统会自动从buffer取出数据输出。</span></li><li>}</li><li>
</li><li>OH_AudioRenderer_Callbacks callbacks;</li><li>callbacks.OH_AudioRenderer_OnWriteData = MyOnWriteData;</li><li>
</li><li><span class="hljs-comment">// 设置输出音频流的回调，在生成音频播放对象时自动注册。</span></li><li><span class="hljs-type">void</span> *userData = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererCallback</span>(builder, callbacks, userData);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="资源释放">资源释放<i class="anchor-icon anchor-icon-link" anchorid="资源释放" tips="复制节点链接"></i></h3><p>OpenSL ES:</p> <p>使用SLObjectItf接口实现对象资源释放。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放播放对象资源。</span></li><li>(*playerObject)-&gt;<span class="hljs-built_in">Destroy</span>(playerObject);</li></ol></pre></div></div> <p>OHAudio:</p> <p>使用对应模块的释放接口实现对象资源释放。</p> <div _ngcontent-bhb-c106="" class="highlight-div"><div _ngcontent-bhb-c106="" class="highlight-div-header"><div _ngcontent-bhb-c106="" class="highlight-div-header-left"><div _ngcontent-bhb-c106="" class="handle-button expand-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bhb-c106="" class="highlight-div-header-right"><div _ngcontent-bhb-c106="" class="handle-button ai-button"></div><div _ngcontent-bhb-c106="" class="handle-button line-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bhb-c106="" class="handle-button theme-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bhb-c106="" class="handle-button copy-button"><div _ngcontent-bhb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bhb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放建造器资源。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li><li>
</li><li><span class="hljs-comment">// 释放播放对象资源。</span></li><li><span class="hljs-built_in">OH_AudioRenderer_Release</span>(audioRenderer);</li></ol></pre></div></div> </div> </div> <div></div></div>