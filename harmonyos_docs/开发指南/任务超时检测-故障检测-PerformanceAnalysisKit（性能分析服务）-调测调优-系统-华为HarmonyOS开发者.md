<h1 _ngcontent-pjb-c119="" class="doc-title ng-star-inserted" title="任务超时检测"> 任务超时检测 </h1>

<div _ngcontent-pjb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>开发者在开发应用时，某一段业务逻辑期望执行一定时间，如果该业务逻辑执行时长超过预期时间，即为任务超时。</p> <p>任务超时检测主要包括主线程超时检测和任务执行超时检测，二者均可使用HiCollie实现自定义时长来对开发者选择的业务逻辑进行主动检测，主线程超时也可采用默认时长进行检测。详见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hicollie-guidelines-ndk">HiCollie使用指导</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines">AppFreeze（应用冻屏）检测</a>相比任务超时检测，主要是由系统侧提供检测周期性检测逻辑，无需开发者感知和适配。</p>  </div></div></div> </div>  <div class="tiledSection"><h2 id="主线程超时检测">主线程超时检测<i class="anchor-icon anchor-icon-link" anchorid="主线程超时检测" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="检测原理" class="firsth2">检测原理<i class="anchor-icon anchor-icon-link" anchorid="检测原理" tips="复制节点链接"></i></h3><ol><li><p>触发流程</p>  <p>主线程超时150ms~450ms，触发采样调用栈流程，生成以txt结尾的堆栈文件；主线程超时450ms，触发采集trace流程，生成以trace结尾的堆栈文件。采集堆栈和采集trace互斥，二者只能触发其中一个。</p>  <p>150ms &lt; 主线程处理时长 &lt; 450ms：仅触发主线程超时采样栈。<strong>同一个应用的PID一个生命周期仅会触发一次主线程超时事件采样栈。开发者选项打开，一小时一次。应用启动10s内不进行检测。</strong></p>  <p>主线程处理时长 &gt; 450ms：仅触发主线程超时采样Trace。<strong>同一个应用的UID一天仅会触发一次主线程超时事件采样trace。</strong></p>  <p>主线程处理时长 = 450ms：当前边界值不触发任何采样。</p>  <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>启动主线程超时检测抓取trace的功能的前提：<strong>开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#nolog版本">nolog</a>版本，并且关闭<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-developer-mode#section530763213432" target="_blank">开发者模式</a></strong>；</p>  <p>log和nolog版本：在手机中，点击设置——搜索关键字“关于本机”——软件版本进行查看。log版本会以log结尾；</p>  <p>关闭开发者模式后，可能无法使用DevEco Studio。因此，可以提前安装应用，再关闭开发者模式。</p>  </div></div></div>  </li><li><p>抓栈时机</p> <p>主线程处理事件超时后，开始执行周期性任务检测，每隔150ms检测主线程是否再次发生超时事件（1 &lt;= 检测次数 &lt;= 2），共三种情况：</p>  <p>（1）第一次检测发现超时事件，开始执行堆栈采样，每隔150ms采样一次，共采样10次堆栈，第11次收集堆栈并上报事件，结束检测。</p>  <p><span><img originheight="388" originwidth="1289" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115054.40605901650932217489425679908943:50001231000000:2800:81A2A6560F852BFE4398262CC8C354417B024C85E3D84C6C55B0B2A177E22D19.png" width="920" height="276.92785104732354"></span></p>  <p>（2）第一轮检测未发生超时事件，第二轮检测发现超时事件，开始执行堆栈采样，每隔150ms采样一轮，共采样10次堆栈，第11轮收集堆栈并上报事件，结束检测。</p>  <p><span><img originheight="429" originwidth="1515" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115054.15444296855575944527650327134561:50001231000000:2800:4F29826662479BB55DF2BAD3155DC4B38E15DEC090C1E386C83494CC16922C5C.png" width="920" height="260.51485148514854"></span></p>  <p>（3）两轮检测均未发现超时事件，结束检测。</p>  <p><span><img originheight="425" originwidth="1054" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115054.16949742377087969476400625819397:50001231000000:2800:C8B174582484F650F16F03C7F718E5C6C16EB39F310875AD5D342731CBB8E45D.png" width="920" height="370.9677419354839"></span></p>  </li><li><p>trace采集时机</p>  <p>主线程超时抓Trace调用录制函数后，每隔150ms检测主线程是否再次发生超时事件（检测次数 = 20），其中，只要在20个间隔检测时，有一次主线程事件超时150ms，3s检测结束后落盘trace。</p>  <p>（1）20次检测均未发生主线程超时150ms事件，无trace文件生成。</p>  <p><span><img originheight="395" originwidth="1124" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115054.32040390802466575096077111531059:50001231000000:2800:E0A116E6E064EC5228053A9DE7293C8C0422970998CA5E3681F5F1876432BB54.png" width="920" height="323.3096085409253"></span></p>  <p>（2）20次检测至少有一次发生主线程超时150ms事件，生成trace文件。</p>  </li></ol> </div>  <div class="tiledSection"><h3 id="日志获取">日志获取<i class="anchor-icon anchor-icon-link" anchorid="日志获取" tips="复制节点链接"></i></h3><p>主线程超时日志保存在应用沙箱目录下，可通过以下方式获取</p> <p><strong>通过HiAppEvent接口订阅</strong></p> <p>HiAppEvent给开发者提供了故障订阅接口，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-intro">HiAppEvent介绍</a>。参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events-arkts">订阅主线程超时事件（ArkTS）</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events-ndk">订阅主线程超时事件（C/C++）</a>完成主线程超时事件订阅，并通过事件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events#事件字段说明">external_log</a>字段读取故障日志文件名。</p> </div>  <div class="tiledSection"><h3 id="日志规格">日志规格<i class="anchor-icon anchor-icon-link" anchorid="日志规格" tips="复制节点链接"></i></h3><ol><li><p>日志老化规格</p> <p>一般情况，栈文件的大小为7-10KB，trace大小为1-5MB。应用沙箱内的watchdog目录最大保存10M内容，超出后，会自动触发此目录老化机制，按照文件名顺序最多删除100文件。目录地址：/data/storage/el2/log/watchdog/。</p>  </li><li><p>采样栈规格</p> <p>抓栈功能目前只支持ARM64架构，抓栈结果为解析后的混合栈信息，包含native帧和JS帧。</p>  <p>抓栈结果部分示例如下：</p>  <div _ngcontent-pjb-c106="" class="highlight-div"><div _ngcontent-pjb-c106="" class="highlight-div-header"><div _ngcontent-pjb-c106="" class="highlight-div-header-left"><div _ngcontent-pjb-c106="" class="handle-button expand-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjb-c106="" class="highlight-div-header-right"><div _ngcontent-pjb-c106="" class="handle-button ai-button"></div><div _ngcontent-pjb-c106="" class="handle-button line-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjb-c106="" class="handle-button theme-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjb-c106="" class="handle-button copy-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjb-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>9 #00 pc 0000757c /system/bin/appspawn(55679d09bcdea35bb1e0d4e1d9a3e58f)</li><li>    9 #01 pc 000731c0 /system/lib/ld-musl-aarch64.so.1(add9e521e4eaf5cb009d4260f3b69ccd)</li><li>        9 #02 pc 000090a9 /system/bin/appspawn(main+396)(55679d09bcdea35bb1e0d4e1d9a3e58f)</li><li>            9 #03 pc 0000ab5d /system/bin/appspawn(AppSpawnRun+100)(55679d09bcdea35bb1e0d4e1d9a3e58f)</li><li>                9 #04 pc 0000e7f1 /system/lib/chipset-pub-sdk/libbegetutil.z.so(RunLoop_+200)(52ace27d827ad482439bf32cc75bb17b)</li><li>                ......</li><li>                                        9 #21 pc 00107aec /system/lib/ld-musl-aarch64.so.1(__pthread_cond_timedwait+628)(add9e521e4eaf5cb009d4260f3b69ccd)</li><li>1 #00 pc 00032e67 /system/lib/platformsdk/libmmi-util.z.so(OHOS::MMI::UDSSocket::OnReadPackets(OHOS::MMI::CircleStreamBuffer&amp;, std::__h::function&lt;void (OHOS::MMI::NetPacket&amp;)&gt;)+158)(99e56bc765f9208f7b7ba8b268886a59)</li><li>    1 #01 pc 0000312e5 /system/lib/platformsdk/libmmi-client.z.so(OHOS::MMI::ClientMsgHandler::OnMsgHandler(OHOS::MMI::UDSClient const&amp;, OHOS::MMI::NetPacket&amp;)+340)(66ac85e964777ae89f0c26c339093cd1)</li><li>        1 #02 pc 0003016b /system/lib/platformsdk/libmmi-client.z.so(OHOS::MMI::ClientMsgHandler::OnPointerEvent(OHOS::MMI::UDSClient const&amp;, OHOS::MMI::NetPacket&amp;)+1222)(66ac85e964777ae89f0c26c339093cd1)</li><li>            1 #03 pc 0003b96b /system/lib/platformsdk/libmmi-client.z.so(OHOS::MMI::InputManagerImpl::OnPointerEvent(std::__h::shared_ptr&lt;OHOS::MMI::PointerEvent&gt;)+1370)(66ac85e964777ae89f0c26c339093cd1)</li><li>                1 #04 pc 00095903 /system/lib/platformsdk/libwm.z.so(OHOS::Rosen::InputEventListener::OnInputEvent(std::__h::shared_ptr&lt;OHOS::MMI::PointerEvent&gt;) const+478)(9c40c5f416d6f830435126998fbcad42)</li><li>                ......</li><li>                                        1 #21 pc 003f5c55 /system/lib/platformsdk/libark_jsruntime.so(4e6a2651ec80a7f639233f414d6486fe)</li><li>                                            1 #22 at anonymous (/entry/build/default/cache/default/default@CompileArkTS/esmodule/debug/entry/src/main/ets/pages/Index.js:67:17)</li><li>                                                1 #23 at wait2 (/entry/build/default/cache/default/default@CompileArkTS/esmodule/debug/entry/src/main/ets/pages/Index.js:16:12)</li><li>                                                ......</li></ol></pre></div></div>  <p>每次抓栈拷贝16KB主线程调用栈信息进行回栈解析，所以每一次抓栈结果最多可以展示进程16KB调用信息，共进行10次，重复栈帧会聚合在一起，不同调用层次通过行缩进进行区分，最终以树型方式进行展示。当抓栈失败（如主线程阻塞在内核或信号被屏蔽等情况）时，将会输出“/proc/self/wchan”文件内容。</p>  <p>展示结果中每一行表示一个栈信息，每一行栈帧信息所表示的意义可以按如下方式解读：</p>  <p>native帧格式如下：</p>  <div _ngcontent-pjb-c106="" class="highlight-div"><div _ngcontent-pjb-c106="" class="highlight-div-header"><div _ngcontent-pjb-c106="" class="highlight-div-header-left"><div _ngcontent-pjb-c106="" class="handle-button expand-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjb-c106="" class="highlight-div-header-right"><div _ngcontent-pjb-c106="" class="handle-button ai-button"></div><div _ngcontent-pjb-c106="" class="handle-button line-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjb-c106="" class="handle-button theme-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjb-c106="" class="handle-button copy-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjb-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>9 #02 pc 000090a9 /system/bin/appspawn(main+396)(55679d09bcdea35bb1e0d4e1d9a3e58f)</li><li>^  ^       ^               ^              ^                   ^</li><li>1  2       3               4              5                   6</li><li>
</li><li>1 表示采样到此帧的次数。</li><li>2 表示帧的调用层级，行缩进大小与该层级对应，所有同一层级帧采样到的次数和不大于10次，#00采样次数和为10（设置采样的次数）。</li><li>3 为native帧PC值。</li><li>4 表示调用的文件路径。</li><li>5 调用的函数名及代码行偏移。</li><li>6 so文件md5值。</li></ol></pre></div></div>  <p>JS帧格式如下：</p>  <div _ngcontent-pjb-c106="" class="highlight-div"><div _ngcontent-pjb-c106="" class="highlight-div-header"><div _ngcontent-pjb-c106="" class="highlight-div-header-left"><div _ngcontent-pjb-c106="" class="handle-button expand-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pjb-c106="" class="highlight-div-header-right"><div _ngcontent-pjb-c106="" class="handle-button ai-button"></div><div _ngcontent-pjb-c106="" class="handle-button line-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pjb-c106="" class="handle-button theme-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pjb-c106="" class="handle-button copy-button"><div _ngcontent-pjb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pjb-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>1 #23 at wait2 (/entry/build/default/cache/default/XXX/entry/src/main/ets/pages/Index.js:16:12)</li><li>^  ^    ^               ^</li><li>1  2    3               4</li><li>
</li><li>1 表示采样到此帧的次数，同样最大为采样次数。</li><li>2 表示帧的调用层级，与native帧意义相同。</li><li>3 表示调用函数名wait2。</li><li>4 表示调用函数所在的路径，文件及行列号。</li></ol></pre></div></div>  </li><li><p>采样trace规格</p> <p>trace文件大小约为1-5M左右。trace文件可以通过<a href="https://gitcode.com/openharmony/developtools_smartperf_host" target="_blank">HiSmartPerf</a>工具进行可视化分析。工具下载链接：<a href="https://gitcode.com/openharmony/developtools_smartperf_host/releases" target="_blank">developtools_smartperf_host官方发行版</a>。</p>  <p>trace文件说明参考：<a href="https://gitcode.com/openharmony/developtools_smartperf_host/blob/master/smartperf_host/ide/src/doc/md/quickstart_systemtrace.md" target="_blank">web端加载trace说明</a>。</p>  </li></ol> </div>  <div class="tiledSection"><h2 id="任务执行超时检测">任务执行超时检测<i class="anchor-icon anchor-icon-link" anchorid="任务执行超时检测" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="检测原理-1" class="firsth2">检测原理<i class="anchor-icon anchor-icon-link" anchorid="检测原理-1" tips="复制节点链接"></i></h3><p><strong>概述</strong>：业务逻辑超出预期时间即为任务超时。</p> <p><strong>检测原理</strong>：开发者自定义超时时间，随后在执行业务逻辑时，如果业务逻辑超出预期时间即为任务执行超时。</p> <p>检测原理如下图：</p> <p><span><img originheight="523" originwidth="698" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115055.48133898396952955483082410494635:50001231000000:2800:110A5D1DF0A8DB9B412F3365452CB7AA28A92E65EDCA2504C1EF0A0A0AF0DF06.png" width="698" height="523"></span></p> </div>  <div class="tiledSection"><h3 id="日志获取-1">日志获取<i class="anchor-icon anchor-icon-link" anchorid="日志获取-1" tips="复制节点链接"></i></h3><p>任务执行超时日志可通过以下方式获取：</p> <p><strong>通过HiAppEvent接口订阅</strong></p> <p>HiAppEvent给开发者提供了故障订阅接口，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-intro">HiAppEvent介绍</a>。参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-apphicollie-events-arkts">订阅任务执行超时事件（ArkTS）</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-apphicollie-events-ndk">订阅任务执行超时事件（C/C++）</a>完成任务执行超时事件订阅，并通过事件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-apphicollie-events#事件字段说明">external_log</a>字段读取故障日志文件名。</p> </div>  <div class="tiledSection"><h3 id="日志规格-1">日志规格<i class="anchor-icon anchor-icon-link" anchorid="日志规格-1" tips="复制节点链接"></i></h3><p>任务执行超时事件日志规格与应用冻屏日志相同，可详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines#日志规格">应用冻屏日志规格</a>。</p> </div> </div> <div></div></div>