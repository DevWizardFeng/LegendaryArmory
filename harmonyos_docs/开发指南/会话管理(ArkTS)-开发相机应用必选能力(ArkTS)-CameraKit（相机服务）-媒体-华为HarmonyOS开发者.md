<h1 _ngcontent-yud-c119="" class="doc-title ng-star-inserted" title="会话管理(ArkTS)"> 会话管理(ArkTS) </h1>

<div _ngcontent-yud-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>相机使用预览、拍照、录像、元数据功能前，均需要创建相机会话。</p>    <p>在会话中，可以完成以下功能：</p>    <ul>     <li>      <p>配置相机的输入流和输出流。相机在拍摄前，必须完成输入输出流的配置。</p>      <p>配置输入流即添加设备输入，对用户而言，相当于选择设备的某一相机拍摄；配置输出流，即选择数据将以什么形式输出。当应用需要实现拍照时，输出流应配置为预览流和拍照流，预览流的数据将显示在XComponent组件上，拍照流的数据将通过ImageReceiver接口的能力保存到相册中。</p></li>     <li>      <p>添加闪光灯、调整焦距等配置。具体支持的配置及接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera" target="_blank">Camera API参考</a>。</p></li>     <li>      <p>会话切换控制。应用可以通过移除和添加输出流的方式，切换相机模式。如当前会话的输出流为拍照流，应用可以将拍照流移除，然后添加视频流作为输出流，即完成了拍照到录像的切换。</p></li>    </ul>    <p>完成会话配置后，应用提交和开启会话，可以开始调用相机相关功能。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入相关接口，导入方法如下。</p>       <div _ngcontent-yud-c106="" class="highlight-div"><div _ngcontent-yud-c106="" class="highlight-div-header"><div _ngcontent-yud-c106="" class="highlight-div-header-left"><div _ngcontent-yud-c106="" class="handle-button expand-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yud-c106="" class="highlight-div-header-right"><div _ngcontent-yud-c106="" class="handle-button ai-button"></div><div _ngcontent-yud-c106="" class="handle-button line-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yud-c106="" class="handle-button theme-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yud-c106="" class="handle-button copy-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yud-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>调用cameraManager中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createsession11" target="_blank">createSession</a>方法创建一个会话。</p>       <div _ngcontent-yud-c106="" class="highlight-div"><div _ngcontent-yud-c106="" class="highlight-div-header"><div _ngcontent-yud-c106="" class="highlight-div-header-left"><div _ngcontent-yud-c106="" class="handle-button expand-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yud-c106="" class="highlight-div-header-right"><div _ngcontent-yud-c106="" class="handle-button ai-button"></div><div _ngcontent-yud-c106="" class="handle-button line-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yud-c106="" class="handle-button theme-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yud-c106="" class="handle-button copy-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yud-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处以videoSession为例。</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSession</span>(<span class="hljs-params">cameraManager: camera.CameraManager</span>): camera.<span class="hljs-property">VideoSession</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoSession</span>: camera.<span class="hljs-property">VideoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> videoSession;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用VideoSession中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#beginconfig11" target="_blank">beginConfig</a>方法配置会话。</p>       <div _ngcontent-yud-c106="" class="highlight-div"><div _ngcontent-yud-c106="" class="highlight-div-header"><div _ngcontent-yud-c106="" class="highlight-div-header-left"><div _ngcontent-yud-c106="" class="handle-button expand-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yud-c106="" class="highlight-div-header-right"><div _ngcontent-yud-c106="" class="handle-button ai-button"></div><div _ngcontent-yud-c106="" class="handle-button line-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yud-c106="" class="handle-button theme-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yud-c106="" class="handle-button copy-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yud-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">beginConfig</span>(<span class="hljs-params">videoSession: camera.VideoSession</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to beginConfig. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使能。向会话中添加相机的输入流和输出流，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addinput11" target="_blank">addInput</a>添加相机的输入流；调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addoutput11" target="_blank">addOutput</a>添加相机的输出流。以下示例代码以添加预览流previewOutput和拍照流photoOutput为例，即当前模式支持拍照和预览。</p>       <p>调用VideoSession中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">commitConfig</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#start11" target="_blank">start</a>方法提交相关配置，并启动会话。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>在调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addoutput11" target="_blank">addOutput</a>添加相机的输出流前，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#canaddoutput11" target="_blank">canAddOutput</a>判断当前相机输出流是否可以添加到session中。</p>         <p>相机输入流cameraInput创建流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-input">设备输入</a>，相机预览输出流previewOutput和拍照输出流photoOutput创建流程请分别参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preview">预览</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-shooting">拍照</a>。</p>        </div></div></div>       <div _ngcontent-yud-c106="" class="highlight-div"><div _ngcontent-yud-c106="" class="highlight-div-header"><div _ngcontent-yud-c106="" class="highlight-div-header-left"><div _ngcontent-yud-c106="" class="handle-button expand-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yud-c106="" class="highlight-div-header-right"><div _ngcontent-yud-c106="" class="handle-button ai-button"></div><div _ngcontent-yud-c106="" class="handle-button line-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yud-c106="" class="handle-button theme-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yud-c106="" class="handle-button copy-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yud-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startSession</span>(<span class="hljs-params">videoSession: camera.VideoSession, cameraInput: camera.CameraInput, previewOutput: camera.PreviewOutput, photoOutput: camera.PhotoOutput</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addInput</span>(cameraInput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to addInput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> canAddPreviewOutput : <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    canAddPreviewOutput = videoSession.<span class="hljs-title function_">canAddOutput</span>(previewOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add previewOutput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!canAddPreviewOutput) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add preview output.`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addOutput</span>(previewOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add previewOutput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> canAddPhotoOutput : <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    canAddPhotoOutput = videoSession.<span class="hljs-title function_">canAddOutput</span>(photoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add photoOutput error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!canAddPhotoOutput) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add photo output.`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addOutput</span>(photoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add photoOutput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to commitConfig. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>   <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>会话控制。调用VideoSession中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#stop11" target="_blank">stop</a>方法可以停止当前会话。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#removeoutput11" target="_blank">removeOutput</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addoutput11" target="_blank">addOutput</a>方法可以完成会话切换控制。以下示例代码以移除拍照流photoOutput，添加视频流videoOutput为例，完成了拍照到录像的切换。</p>       <div _ngcontent-yud-c106="" class="highlight-div"><div _ngcontent-yud-c106="" class="highlight-div-header"><div _ngcontent-yud-c106="" class="highlight-div-header-left"><div _ngcontent-yud-c106="" class="handle-button expand-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yud-c106="" class="highlight-div-header-right"><div _ngcontent-yud-c106="" class="handle-button ai-button"></div><div _ngcontent-yud-c106="" class="handle-button line-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yud-c106="" class="handle-button theme-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yud-c106="" class="handle-button copy-button"><div _ngcontent-yud-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yud-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">switchOutput</span>(<span class="hljs-params">videoSession: camera.VideoSession, videoOutput: camera.VideoOutput, photoOutput: camera.PhotoOutput</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">stop</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to beginConfig. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 从会话中移除拍照输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">removeOutput</span>(photoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to remove photoOutput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">canAddOutput</span>(videoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add videoOutput error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 向会话中添加视频输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSession.<span class="hljs-title function_">addOutput</span>(videoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add videoOutput. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to commitConfig. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start. error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>