<h1 _ngcontent-qsk-c119="" class="doc-title ng-star-inserted" title="会话管理(C/C++)"> 会话管理(C/C++) </h1>

<div _ngcontent-qsk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>相机使用预览、拍照、录像、元数据功能前，均需要创建相机会话。</p>    <p>在会话中，可以完成以下功能：</p>    <ul>     <li>      <p>配置相机的输入流和输出流。相机在拍摄前，必须完成输入输出流的配置。</p>      <p>配置输入流即添加设备输入，对用户而言，相当于选择设备的某一相机拍摄；配置输出流，即选择数据将以什么形式输出。当应用需要实现拍照时，输出流应配置为预览流和拍照流，预览流的数据将显示在XComponent组件上，拍照流的数据将通过ImageReceiver接口的能力保存到相册中。</p></li>     <li>      <p>添加闪光灯、调整焦距等配置。具体支持的配置及接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p></li>     <li>      <p>会话切换控制。应用可以通过移除和添加输出流的方式，切换相机模式。如当前会话的输出流为拍照流，应用可以将拍照流移除，然后添加视频流作为输出流，即完成了拍照到录像的切换。</p></li>    </ul>    <p>完成会话配置后，应用提交和开启会话，可以开始调用相机相关功能。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入NDK相关接口，导入方法如下。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libohcamera.so</li><li>    libhilog_ndk.z.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_createcapturesession" target="_blank">OH_CameraManager_CreateCaptureSession()</a>方法创建一个会话。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_CaptureSession* <span class="hljs-title">CreateCaptureSession</span><span class="hljs-params">(Camera_Manager* cameraManager)</span></span></li><li><span class="hljs-function"></span>{</li><li>    Camera_CaptureSession* captureSession = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (cameraManager == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"cameraManager is nullptr."</span>);</li><li>        <span class="hljs-keyword">return</span> captureSession;</li><li>    }</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_CameraManager_CreateCaptureSession</span>(cameraManager, &amp;captureSession);</li><li>    <span class="hljs-keyword">if</span> (captureSession == <span class="hljs-literal">nullptr</span> || ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateCaptureSession failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> captureSession;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setsessionmode" target="_blank">OH_CaptureSession_SetSessionMode()</a>方法配置会话模式。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">SetSessionMode</span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_SetSessionMode(captureSession, NORMAL_VIDEO);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetSessionMode failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_beginconfig" target="_blank">OH_CaptureSession_BeginConfig()</a>方法配置会话。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">BeginConfig</span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_BeginConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_BeginConfig failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使能。向会话中添加相机的输入流和输出流，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_addinput" target="_blank">OH_CaptureSession_AddInput()</a>添加相机的输入流；调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_addpreviewoutput" target="_blank">OH_CaptureSession_AddPreviewOutput()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_addphotooutput" target="_blank">OH_CaptureSession_AddPhotoOutput()</a>添加相机的输出流。以下示例代码以添加预览流previewOutput和拍照流photoOutput为例，即当前模式支持拍照和预览。</p>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_commitconfig" target="_blank">OH_CaptureSession_CommitConfig()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_start" target="_blank">OH_CaptureSession_Start()</a>方法提交相关配置，并启动会话。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode StartSession(Camera_CaptureSession* captureSession, Camera_Input* cameraInput,</li><li>    Camera_PreviewOutput* previewOutput, Camera_PhotoOutput* photoOutput)</li><li>{</li><li>    <span class="hljs-comment">// 向会话中添加相机输入流。</span></li><li>    Camera_ErrorCode ret = OH_CaptureSession_AddInput(captureSession, cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddInput failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加预览输出流。</span></li><li>    ret = OH_CaptureSession_AddPreviewOutput(captureSession, previewOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddPreviewOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加拍照输出流。</span></li><li>    ret = OH_CaptureSession_AddPhotoOutput(captureSession, photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddPhotoOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 提交会话配置。</span></li><li>    ret = OH_CaptureSession_CommitConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_CommitConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动会话。</span></li><li>    ret = OH_CaptureSession_Start(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Start failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>会话控制。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_stop" target="_blank">OH_CaptureSession_Stop()</a>方法可以停止当前会话。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_removephotooutput" target="_blank">OH_CaptureSession_RemovePhotoOutput()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_addvideooutput" target="_blank">OH_CaptureSession_AddVideoOutput()</a>方法可以完成会话切换控制。以下示例代码以移除拍照流photoOutput，添加视频流videoOutput为例，完成了拍照到录像的切换。</p>       <div _ngcontent-qsk-c106="" class="highlight-div"><div _ngcontent-qsk-c106="" class="highlight-div-header"><div _ngcontent-qsk-c106="" class="highlight-div-header-left"><div _ngcontent-qsk-c106="" class="handle-button expand-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsk-c106="" class="highlight-div-header-right"><div _ngcontent-qsk-c106="" class="handle-button ai-button"></div><div _ngcontent-qsk-c106="" class="handle-button line-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsk-c106="" class="handle-button theme-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsk-c106="" class="handle-button copy-button"><div _ngcontent-qsk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode ReloadSession(Camera_CaptureSession* captureSession, Camera_PhotoOutput* photoOutput,</li><li>    Camera_VideoOutput* videoOutput)</li><li>{</li><li>    Camera_ErrorCode ret = OH_CaptureSession_Stop(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop failed. %d "</span>, ret);</li><li>    }</li><li>    ret = OH_CaptureSession_BeginConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_BeginConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-comment">// 从会话中移除拍照输出流。</span></li><li>    ret = OH_CaptureSession_RemovePhotoOutput(captureSession, photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_RemovePhotoOutput success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_RemovePhotoOutput failed. %d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-comment">// 释放photoOutput。</span></li><li>    ret = OH_PhotoOutput_Release(photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Release failed. %d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-comment">// 向会话中添加视频输出流。</span></li><li>    ret = OH_CaptureSession_AddVideoOutput(captureSession, videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddVideoOutput success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddVideoOutput failed. %d "</span>, ret);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-comment">// 提交会话配置。</span></li><li>    ret = OH_CaptureSession_CommitConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_CommitConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动会话。</span></li><li>    ret = OH_CaptureSession_Start(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Start failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>