<h1 _ngcontent-ggl-c119="" class="doc-title ng-star-inserted" title="传感器开发指导(C/C++)"> 传感器开发指导(C/C++) </h1>

<div _ngcontent-ggl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>当设备需要获取传感器数据时，可以使用sensor模块，例如：通过订阅方向传感器数据感知用户设备当前的朝向，通过订阅计步传感器数据统计用户的步数等。</p>     <p>详细的接口介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-sensor" target="_blank">Sensor接口</a>。</p>    </div>    <div class="tiledSection">     <h2 id="函数说明">函数说明<i class="anchor-icon anchor-icon-link" anchorid="函数说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_GetInfos(Sensor_Info **infos, uint32_t *count)</td>         <td class="cellrowborder" valign="top" width="50%">获取设备上所有传感器的信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_Subscribe(const Sensor_SubscriptionId *id, const Sensor_SubscriptionAttribute *attribute, const Sensor_Subscriber *subscriber)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>订阅传感器数据。系统将以指定的频率向用户上报传感器数据。</p>          <p>订阅加速度传感器，需要申请ohos.permission.ACCELEROMETER权限；</p>          <p>订阅陀螺仪传感器，需要申请ohos.permission.GYROSCOPE权限；</p>          <p>订阅计步器相关传感器时，需要申请ohos.permission.ACTIVITY_MOTION权限；</p>          <p>订阅与健康相关的传感器时，比如心率传感器需要申请ohos.permission.READ_HEALTH_DATA权限，否则订阅失败;</p>          <p>订阅其余传感器不需要申请权限。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_Unsubscribe(const Sensor_SubscriptionId *id, const Sensor_Subscriber *subscriber)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>取消订阅传感器数据。</p>          <p>取消订阅加速度计传感器，需要申请ohos.permission.ACCELEROMETER权限；</p>          <p>取消订阅陀螺仪传感器，需要申请ohos.permission.GYROSCOPE权限；</p>          <p>取消订阅计步器相关传感器时，需要申请ohos.permission.ACTIVITY_MOTION权限；</p>          <p>取消订阅与健康相关的传感器时，需要申请ohos.permission.READ_HEALTH_DATA权限，否则取消订阅失败。</p>          <p>取消订阅其余传感器不需要申请权限。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_CreateInfos(uint32_t count)</td>         <td class="cellrowborder" valign="top" width="50%">用给定的数字创建一个实例数组，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-sensor-sensor-info" target="_blank">Sensor_Info</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_DestroyInfos(Sensor_Info **sensors, uint32_t count)</td>         <td class="cellrowborder" valign="top" width="50%">销毁实例数组并回收内存，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-sensor-sensor-info" target="_blank">Sensor_Info</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetName(Sensor_Info *sensor, char *sensorName, uint32_t *length)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器名称。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetVendorName(Sensor_Info* sensor, char *vendorName, uint32_t *length)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器的厂商名称。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetType(Sensor_Info* sensor, Sensor_Type *sensorType)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetResolution(Sensor_Info* sensor, float *resolution)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器分辨率。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetMinSamplingInterval(Sensor_Info* sensor, int64_t *minSamplingInterval)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器的最小数据上报间隔。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorInfo_GetMaxSamplingInterval(Sensor_Info* sensor, int64_t *maxSamplingInterval)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器的最大数据上报间隔时间。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorEvent_GetType(Sensor_Event* sensorEvent, Sensor_Type *sensorType)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorEvent_GetTimestamp(Sensor_Event* sensorEvent, int64_t *timestamp)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器数据的时间戳。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorEvent_GetAccuracy(Sensor_Event* sensorEvent, Sensor_Accuracy *accuracy)</td>         <td class="cellrowborder" valign="top" width="50%">获取传感器数据的精度。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorEvent_GetData(Sensor_Event* sensorEvent, float **data, uint32_t *length)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>获取传感器数据。</p>          <p>数据的长度和内容依赖于监听的传感器类型，传感器上报的数据格式如下：</p>          <p>1.SENSOR_TYPE_ACCELEROMETER:data[0]、data[1]、data[2]分别表示设备x、y、z轴的加速度分量，单位m/s²；</p>          <p>2.SENSOR_TYPE_GYROSCOPE:data[0]、data[1]、data[2]分别表示设备x、y、z轴的旋转角速度，单位弧度/s；</p>          <p>3.SENSOR_TYPE_AMBIENT_LIGHT:data[0]表示环境光强度，单位lux；从API Version 12开始，将返回两个额外的数据，其中data[1]表示色温，单位kelvin；data[2]表示红外亮度，单位cd/m²；</p>          <p>4.SENSOR_TYPE_MAGNETIC_FIELD:data[0]、data[1]、data[2]分别表示设备x、y、z轴的地磁分量，单位微特斯拉；</p>          <p>5.SENSOR_TYPE_BAROMETER:data[0]表示气压值，单位hPa；</p>          <p>6.SENSOR_TYPE_HALL:data[0]表示皮套吸合状态，0表示打开，大于0表示吸附；</p>          <p>7.SENSOR_TYPE_PROXIMITY:data[0]表示接近状态，0表示接近，大于0表示远离；</p>          <p>8.SENSOR_TYPE_ORIENTATION:data[0]、data[1]、data[2]分别表示设备绕z、x、y轴的角度，单位度；</p>          <p>9.SENSOR_TYPE_GRAVITY:data[0]、data[1]、data[2]分别表示设备x、y、z轴的重力加速度分量，单位m/s²；</p>          <p>10.SENSOR_TYPE_ROTATION_VECTOR:data[0]、data[1]、data[2]分别表示设备x、y、z轴的旋转角度，单位度，data[3]表示旋转向量元素；</p>          <p>11.SENSOR_TYPE_PEDOMETER_DETECTION:data[0]表示计步检测状态，1表示检测到了步数变化；</p>          <p>12.SENSOR_TYPE_PEDOMETER:data[0]表示步数；</p>          <p>13.SENSOR_TYPE_HEART_RATE:data[0]表示心率数值。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_CreateSubscriptionId(void)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个Sensor_SubscriptionId 实例。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_DestroySubscriptionId(Sensor_SubscriptionId *id)</td>         <td class="cellrowborder" valign="top" width="50%">销毁Sensor_SubscriptionId 实例并回收内存。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorSubscriptionId_SetType(Sensor_SubscriptionId* id, const Sensor_Type sensorType)</td>         <td class="cellrowborder" valign="top" width="50%">设置传感器类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_CreateSubscriptionAttribute(void)</td>         <td class="cellrowborder" valign="top" width="50%">创建Sensor_SubscriptionAttribute实例。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_DestroySubscriptionAttribute(Sensor_SubscriptionAttribute *attribute)</td>         <td class="cellrowborder" valign="top" width="50%">销毁Sensor_SubscriptionAttribute实例并回收内存。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorSubscriptionAttribute_SetSamplingInterval(Sensor_SubscriptionAttribute* attribute, const int64_t samplingInterval)</td>         <td class="cellrowborder" valign="top" width="50%">设置传感器数据上报间隔。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_CreateSubscriber(void)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个Sensor_Subscriber实例。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Sensor_DestroySubscriber(Sensor_Subscriber *subscriber)</td>         <td class="cellrowborder" valign="top" width="50%">销毁Sensor_Subscriber实例并回收内存。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_SensorSubscriber_SetCallback(Sensor_Subscriber* subscriber, const Sensor_EventCallback callback)</td>         <td class="cellrowborder" valign="top" width="50%">设置一个回调函数来上报传感器数据。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>开发步骤以加速度传感器为例。</p>     <ol>      <li>       <p>新建一个Native C++工程。</p>       <p><span><img originheight="1015" originwidth="1633" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115048.65336184703717104608394618393325:50001231000000:2800:7250A66607A2570AFEFD5B7DE2D12FE4662969A7393EF5A035CD5E60EFFAF59C.png" width="920" height="571.830985915493"></span></p></li>      <li>       <p>配置加速度传感器权限，具体配置方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.ACCELEROMETER"</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">]</span></li></ol></pre></div></div></li>      <li>       <p>CMakeLists.txt文件中引入动态依赖库。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libace_napi.z.so)</li><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so)</li><li>target_link_libraries(entry PUBLIC libohsensor.so)</li></ol></pre></div></div></li>      <li>       <p>在napi_init.cpp文件中编码，首先导入模块。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sensors/oh_sensor.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>定义常量。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> GLOBAL_RESMGR = <span class="hljs-number">0xFF00</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">"[Sensor]"</span>;</li><li>constexpr Sensor_Type SENSOR_ID { SENSOR_TYPE_ACCELEROMETER };</li><li>constexpr <span class="hljs-type">uint32_t</span> SENSOR_NAME_LENGTH_MAX = <span class="hljs-number">64</span>;</li><li>constexpr <span class="hljs-type">int64_t</span> SENSOR_SAMPLE_PERIOD = <span class="hljs-number">200000000</span>;</li><li>constexpr <span class="hljs-type">int32_t</span> SLEEP_TIME_MS = <span class="hljs-number">1000</span>;</li><li>constexpr <span class="hljs-type">int64_t</span> INVALID_VALUE = <span class="hljs-number">-1</span>;</li><li>constexpr <span class="hljs-type">float</span> INVALID_RESOLUTION = <span class="hljs-number">-1.0F</span>;</li><li>Sensor_Subscriber *g_user = nullptr;</li></ol></pre></div></div></li>      <li>       <p>定义一个回调函数用来接收传感器数据。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">SensorDataCallbackImpl</span><span class="hljs-params">(Sensor_Event *event)</span> {</li><li>    <span class="hljs-keyword">if</span> (event == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, GLOBAL_RESMGR, TAG, <span class="hljs-string">"event is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> timestamp = INVALID_VALUE;</li><li>    <span class="hljs-type">int32_t</span> ret = OH_SensorEvent_GetTimestamp(event, &amp;timestamp); <span class="hljs-comment">// 获取传感器数据的时间戳。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    Sensor_Type sensorType;</li><li>    ret = OH_SensorEvent_GetType(event, &amp;sensorType); <span class="hljs-comment">// 获取传感器类型。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    Sensor_Accuracy accuracy = SENSOR_ACCURACY_UNRELIABLE;</li><li>    ret = OH_SensorEvent_GetAccuracy(event, &amp;accuracy); <span class="hljs-comment">// 获取传感器数据的精度。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">float</span> *data = nullptr;</li><li>    <span class="hljs-type">uint32_t</span> length = <span class="hljs-number">0</span>;</li><li>    ret = OH_SensorEvent_GetData(event, &amp;data, &amp;length); <span class="hljs-comment">// 获取传感器数据。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (data == nullptr) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, GLOBAL_RESMGR, TAG, <span class="hljs-string">"sensorType:%{public}d, dataLen:%{public}d, accuracy:%{public}d"</span>, sensorType, length, accuracy);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; length; ++i) {</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, GLOBAL_RESMGR, TAG, <span class="hljs-string">"data[%{public}d]:%{public}f"</span>, i, data[i]);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取设备上所有传感器的信息。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">GetSensorInfos</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    <span class="hljs-type">uint32_t</span> count = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> ret = OH_Sensor_GetInfos(nullptr, &amp;count); <span class="hljs-comment">// 获取设备上所有传感器的个数。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    Sensor_Info **sensors = OH_Sensor_CreateInfos(count); <span class="hljs-comment">// 用给定的数字创建一个实例数组。</span></li><li>    <span class="hljs-keyword">if</span> (sensors == nullptr) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    ret = OH_Sensor_GetInfos(sensors, &amp;count); <span class="hljs-comment">// 获取设备上所有传感器的信息。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {</li><li>        <span class="hljs-type">char</span> sensorName[SENSOR_NAME_LENGTH_MAX] = {};</li><li>        <span class="hljs-type">uint32_t</span> length = SENSOR_NAME_LENGTH_MAX;</li><li>        ret = OH_SensorInfo_GetName(sensors[i], sensorName, &amp;length); <span class="hljs-comment">// 获取传感器名称。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>        <span class="hljs-type">char</span> vendorName[SENSOR_NAME_LENGTH_MAX] = {};</li><li>        length = SENSOR_NAME_LENGTH_MAX;</li><li>        ret = OH_SensorInfo_GetVendorName(sensors[i], vendorName, &amp;length); <span class="hljs-comment">// 获取传感器的厂商名称。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>        Sensor_Type sensorType;</li><li>        ret = OH_SensorInfo_GetType(sensors[i], &amp;sensorType); <span class="hljs-comment">// 获取传感器类型。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>        <span class="hljs-type">float</span> resolution = INVALID_RESOLUTION;</li><li>        ret = OH_SensorInfo_GetResolution(sensors[i], &amp;resolution); <span class="hljs-comment">// 获取传感器分辨率。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>        <span class="hljs-type">int64_t</span> minSamplePeriod = INVALID_VALUE;</li><li>        ret = OH_SensorInfo_GetMinSamplingInterval(sensors[i], &amp;minSamplePeriod); <span class="hljs-comment">// 获取传感器的最小数据上报间隔。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>        <span class="hljs-type">int64_t</span> maxSamplePeriod = INVALID_VALUE;</li><li>        ret = OH_SensorInfo_GetMaxSamplingInterval(sensors[i], &amp;maxSamplePeriod); <span class="hljs-comment">// 获取传感器的最大数据上报间隔时间。</span></li><li>        <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        }</li><li>    }</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, GLOBAL_RESMGR, TAG, <span class="hljs-string">"GetSensorInfos successful"</span>);</li><li>    ret = OH_Sensor_DestroyInfos(sensors, count); <span class="hljs-comment">// 销毁实例数组并回收内存。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value result = nullptr;</li><li>    napi_create_int32(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>订阅和取消订阅传感器数据。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">Subscriber</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    g_user = OH_Sensor_CreateSubscriber();                                         <span class="hljs-comment">// 创建一个Sensor_Subscriber实例。</span></li><li>    <span class="hljs-type">int32_t</span> ret = OH_SensorSubscriber_SetCallback(g_user, SensorDataCallbackImpl); <span class="hljs-comment">// 设置一个回调函数来报告传感器数据。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    Sensor_SubscriptionId *id = OH_Sensor_CreateSubscriptionId(); <span class="hljs-comment">// 创建一个Sensor_SubscriptionId实例。</span></li><li>    ret = OH_SensorSubscriptionId_SetType(id, SENSOR_ID);         <span class="hljs-comment">// 设置传感器类型。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    Sensor_SubscriptionAttribute *attr = OH_Sensor_CreateSubscriptionAttribute();     <span class="hljs-comment">// 创建Sensor_SubscriptionAttribute实例。</span></li><li>    ret = OH_SensorSubscriptionAttribute_SetSamplingInterval(attr, SENSOR_SAMPLE_PERIOD); <span class="hljs-comment">// 设置传感器数据报告间隔。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    ret = OH_Sensor_Subscribe(id, attr, g_user); <span class="hljs-comment">// 订阅传感器数据。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, GLOBAL_RESMGR, TAG, <span class="hljs-string">"Subscriber successful"</span>);</li><li>    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(SLEEP_TIME_MS));</li><li>    ret = OH_Sensor_Unsubscribe(id, g_user); <span class="hljs-comment">// 取消订阅传感器数据。</span></li><li>    <span class="hljs-keyword">if</span> (ret != SENSOR_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (id != nullptr) {</li><li>        OH_Sensor_DestroySubscriptionId(id); <span class="hljs-comment">// 销毁Sensor_SubscriptionId实例并回收内存。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attr != nullptr) {</li><li>        OH_Sensor_DestroySubscriptionAttribute(attr); <span class="hljs-comment">// 销毁Sensor_SubscriptionAttribute实例并回收内存。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (g_user != nullptr) {</li><li>        OH_Sensor_DestroySubscriber(g_user); <span class="hljs-comment">// 销毁Sensor_Subscriber实例并回收内存。</span></li><li>        g_user = nullptr;</li><li>    }</li><li>    napi_value result = nullptr;</li><li>    napi_create_int32(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在Init函数中补充接口。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>EXTERN_C_START</li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></li><li>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"getSensorInfos"</span>, nullptr, GetSensorInfos, nullptr, nullptr, nullptr, napi_default, nullptr },</li><li>        { <span class="hljs-string">"subscriber"</span>, nullptr, Subscriber, nullptr, nullptr, nullptr, napi_default, nullptr }</li><li>    };</li><li>    napi_define_properties(env, exports, <span class="hljs-keyword">sizeof</span>(desc) / <span class="hljs-keyword">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre></div></div></li>      <li>       <p>在types/libentry路径下index.d.ts文件中引入Napi接口。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li> export <span class="hljs-type">const</span> getSensorInfos: () =&gt; number;</li><li> export <span class="hljs-type">const</span> subscriber: () =&gt; number;</li></ol></pre></div></div></li>      <li>       <p>删除Index.ets中的已废弃函数。</p>       <div _ngcontent-ggl-c106="" class="highlight-div"><div _ngcontent-ggl-c106="" class="highlight-div-header"><div _ngcontent-ggl-c106="" class="highlight-div-header-left"><div _ngcontent-ggl-c106="" class="handle-button expand-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ggl-c106="" class="highlight-div-header-right"><div _ngcontent-ggl-c106="" class="handle-button ai-button"></div><div _ngcontent-ggl-c106="" class="handle-button line-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ggl-c106="" class="handle-button theme-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ggl-c106="" class="handle-button copy-button"><div _ngcontent-ggl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ggl-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li>.<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));</li><li>})</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>