<h1 _ngcontent-qmd-c119="" class="doc-title ng-star-inserted" title="低时延音频播放(C/C++)"> 低时延音频播放(C/C++) </h1>

<div _ngcontent-qmd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 10开始支持低时延音频播放。</p>    <p>低时延音频播放是一种通过软硬芯协同设计实现的音频渲染方案。其核心机制是通过减少buffer大小、优化读写数据架构，使该模式下音频播放具有更低的时延。</p>    <div class="tiledSection">     <h2 id="zh-cn_topic_0000002480648590_使用前提">使用前提<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_使用前提" tips="复制节点链接"></i></h2>          <ul>      <li>支持低时延模式的音频输出设备。</li>      <li>可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_getfaststatus" target="_blank">OH_AudioRenderer_GetFastStatus()</a>验证当前设备是否支持低时延模式。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="zh-cn_topic_0000002480648590_开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_简介" class="firsth2">简介<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_简介" tips="复制节点链接"></i></h3>          <p>为使用低时延模式，开发者需要参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback">使用OHAudio开发音频播放功能(C/C++)</a>进行音频开发。</p>     <p>当前OHAudio支持两种模式：普通模式（AUDIOSTREAM_LATENCY_MODE_NORMAL）和低时延模式（AUDIOSTREAM_LATENCY_MODE_FAST）。</p>    </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_设置低时延模式">设置低时延模式<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_设置低时延模式" tips="复制节点链接"></i></h3>          <p>开发者通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setlatencymode" target="_blank">OH_AudioStreamBuilder_SetLatencyMode()</a>，设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_latencymode" target="_blank">OH_AudioStream_LatencyMode()</a>来决定音频流使用的模式。</p>     <p>设置低时延模式开发示例：</p>     <div _ngcontent-qmd-c106="" class="highlight-div"><div _ngcontent-qmd-c106="" class="highlight-div-header"><div _ngcontent-qmd-c106="" class="highlight-div-header-left"><div _ngcontent-qmd-c106="" class="handle-button expand-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qmd-c106="" class="highlight-div-header-right"><div _ngcontent-qmd-c106="" class="handle-button ai-button"></div><div _ngcontent-qmd-c106="" class="handle-button line-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qmd-c106="" class="handle-button theme-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qmd-c106="" class="handle-button copy-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qmd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStream_LatencyMode latencyMode = AUDIOSTREAM_LATENCY_MODE_FAST;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetLatencyMode</span>(builder, latencyMode);</li></ol></pre></div></div>     <p>针对OHAudio开发音频播放，有以下相关实例可供参考：</p>     <ul>      <li><a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/Audio/OHAudio" target="_blank">OHAudio录制和播放</a>。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="zh-cn_topic_0000002480648590_注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_注意事项" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_低时延模式限制" class="firsth2">低时延模式限制<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_低时延模式限制" tips="复制节点链接"></i></h3>          <p>在以下场景中，即使设置了低时延模式，系统仍会使用普通模式。</p>     <ul>      <li>当前设备不支持低时延模式。</li>      <li>当前流格式不支持低时延模式。</li>      <li>系统低时延资源已被全部占用。</li>      <li>当前系统中存在更高优先级流（如：蜂窝通话）。</li>     </ul>     <p>从API version 20开始，支持低时延相关查询接口。</p>     <ul>      <li>开发者通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_getfaststatus" target="_blank">OH_AudioRenderer_GetFastStatus()</a>来获取音频播放流是否正在低时延状态下工作。</li>      <li>在部分特殊场景（如：存在更高优先级流、当前连接设备不支持等）下，开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_onfaststatuschange" target="_blank">OH_AudioRenderer_OnFastStatusChange()</a>来获取低时延状态改变事件。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_使用低时延流的场景">使用低时延流的场景<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_使用低时延流的场景" tips="复制节点链接"></i></h3>          <ul>      <li>游戏、k歌、直播等对时延要求较高的场景，建议使用低时延模式。</li>      <li>视频播放、音乐播放等没有实时要求的场景，不建议使用低时延模式。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_确保数据及时提供">确保数据及时提供<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_确保数据及时提供" tips="复制节点链接"></i></h3>          <p>低时延模式下，应用提供数据的频次比普通播放模式高，如果传送数据不及时可能导致杂音等问题。开发者应避免在数据回调线程中做耗时操作，确保数据回调线程可以及时返回。</p>    </div>    <div class="tiledSection">     <h3 id="zh-cn_topic_0000002480648590_数据回调线程">数据回调线程<i class="anchor-icon anchor-icon-link" anchorid="zh-cn_topic_0000002480648590_数据回调线程" tips="复制节点链接"></i></h3>          <p>播放的音频数据需要通过回调接口写入。开发者要实现回调接口，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setrendererwritedatacallback" target="_blank">OH_AudioStreamBuilder_SetRendererWriteDataCallback</a>设置写入音频数据的回调函数，在设置音频回调函数时，回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiorenderer_onwritedatacallback" target="_blank">OH_AudioRenderer_OnWriteDataCallback</a>（从API version 12开始支持）用于写入音频数据。</p>     <p>开发音频播放功能的示例代码请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback">使用OHAudio开发音频播放功能(C/C++)</a>。</p>     <p>设置数据回调函数示例：</p>     <div _ngcontent-qmd-c106="" class="highlight-div"><div _ngcontent-qmd-c106="" class="highlight-div-header"><div _ngcontent-qmd-c106="" class="highlight-div-header-left"><div _ngcontent-qmd-c106="" class="handle-button expand-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qmd-c106="" class="highlight-div-header-right"><div _ngcontent-qmd-c106="" class="handle-button ai-button"></div><div _ngcontent-qmd-c106="" class="handle-button line-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qmd-c106="" class="handle-button theme-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qmd-c106="" class="handle-button copy-button"><div _ngcontent-qmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qmd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义写入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_AudioData_Callback_Result <span class="hljs-title">MyOnWriteData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* audioData,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> audioDataSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的数据，按audioDataSize长度写入audioData。</span></li><li>    <span class="hljs-comment">// 如果开发者不希望播放某段audioData，返回AUDIO_DATA_CALLBACK_RESULT_INVALID即可。</span></li><li>    <span class="hljs-keyword">return</span> AUDIO_DATA_CALLBACK_RESULT_VALID;</li><li>}</li><li><span class="hljs-comment">// 配置写入音频数据回调函数。</span></li><li>OH_AudioRenderer_OnWriteDataCallback writeDataCb = MyOnWriteData;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererWriteDataCallback</span>(builder, writeDataCb, <span class="hljs-literal">nullptr</span>);</li></ol></pre></div></div>     <ul>      <li>       <p>为避免音频卡顿，禁止在回调方法OH_AudioRenderer_OnWriteData中执行耗时操作。</p></li>      <li>       <p>为保证OH_AudioRenderer_OnWriteData与流状态控制逻辑独立正常运行，禁止在OH_AudioRenderer_OnWriteData回调方法中调用音频流控制接口。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.11.6.2.2.1.3.1.1" valign="top" width="50%">            <p>音频流控制接口</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.11.6.2.2.1.3.1.2" valign="top" width="50%">            <p>说明</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">            <p>OH_AudioStream_Result OH_AudioRenderer_Start(OH_AudioRenderer* renderer)</p></td>           <td class="cellrowborder" valign="top" width="50%">            <p>开始播放。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">            <p>OH_AudioStream_Result OH_AudioRenderer_Pause(OH_AudioRenderer* renderer)</p></td>           <td class="cellrowborder" valign="top" width="50%">            <p>暂停播放。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">            <p>OH_AudioStream_Result OH_AudioRenderer_Stop(OH_AudioRenderer* renderer)</p></td>           <td class="cellrowborder" valign="top" width="50%">            <p>停止播放。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">            <p>OH_AudioStream_Result OH_AudioRenderer_Flush(OH_AudioRenderer* renderer)</p></td>           <td class="cellrowborder" valign="top" width="50%">            <p>释放缓存数据。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">            <p>OH_AudioStream_Result OH_AudioRenderer_Release(OH_AudioRenderer* renderer)</p></td>           <td class="cellrowborder" valign="top" width="50%">            <p>释放播放实例。</p></td>          </tr>                 </tbody></table></div>       </div></li>     </ul>    </div>   </div>   <div></div></div>