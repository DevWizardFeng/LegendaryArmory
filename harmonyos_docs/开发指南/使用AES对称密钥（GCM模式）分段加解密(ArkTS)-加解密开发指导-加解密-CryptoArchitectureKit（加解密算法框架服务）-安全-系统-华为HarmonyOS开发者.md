<h1 _ngcontent-xhj-c119="" class="doc-title ng-star-inserted" title="使用AES对称密钥（GCM模式）分段加解密(ArkTS)"> 使用AES对称密钥（GCM模式）分段加解密(ArkTS) </h1>

<div _ngcontent-xhj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对应的算法规格请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-encrypt-decrypt-spec#aes">对称密钥加解密算法规格：AES</a>。</p>    <p><strong>加密</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatesymkeygenerator" target="_blank">cryptoFramework.createSymKeyGenerator</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#generatesymkey-1" target="_blank">SymKeyGenerator.generateSymKey</a>，生成密钥算法为AES、密钥长度为128位的对称密钥（SymKey）。</p>      <p>如何生成AES对称密钥，开发者可参考下文示例，并结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-key-generation-conversion-spec#aes">对称密钥生成和转换规格：AES</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-generate-sym-key-randomly">随机生成对称密钥</a>理解，参考文档与当前示例可能存在入参差异，请在阅读时注意区分。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatecipher" target="_blank">cryptoFramework.createCipher</a>，指定字符串参数'AES128|GCM|PKCS7'，创建对称密钥类型为AES128、分组模式为GCM、填充模式为PKCS7的Cipher实例，用于完成加密操作。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#init-1" target="_blank">Cipher.init</a>，设置模式为加密（CryptoMode.ENCRYPT_MODE），指定加密密钥（SymKey）和GCM模式对应的加密参数（GcmParamsSpec），初始化加密Cipher实例。</p></li>     <li>      <p>将一次传入数据量设置为20字节，多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#update-1" target="_blank">Cipher.update</a>，更新数据（明文）。</p>      <ul>       <li>        <p>当前单次update长度没有限制，开发者可以根据数据量判断如何调用update。</p></li>       <li>        <p>建议开发者对每次update的结果都判断是否为null，并在结果不为null时取出其中的数据进行拼接，形成完整的密文。因为在不同的规格下，update的结果可能会受到不同影响。</p>        <p>1）例如ECB和CBC模式，始终以分组作为基本单位进行加密，并输出本次更新产生的加密分组结果。即当本次更新操作凑满一个分组时就输出密文，未凑满则本次更新输出null，将未加密的数据与下次输入的数据拼接后再凑分组输出。最后在doFinal时，将未加密的数据根据指定的填充模式进行填充，再输出剩余的加密结果。解密过程中的update操作同理。</p>        <p>2）对于流加密模式，如CTR和OFB模式，密文长度等于明文长度。</p></li>      </ul></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#dofinal-1" target="_blank">Cipher.doFinal</a>，获取加密后的数据。</p>      <ul>       <li>由于已通过update传入数据，此处传入null。</li>       <li>在访问doFinal输出结果前，需先判断结果是否为null，避免产生异常。</li>      </ul></li>     <li>      <p>读取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#gcmparamsspec" target="_blank">GcmParamsSpec</a>.authTag作为解密认证信息。</p>      <p>在GCM模式下，算法库支持16字节的authTag，用于解密时的认证初始化。示例中的authTag为16字节。</p></li>    </ol>    <p><strong>解密</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatecipher" target="_blank">cryptoFramework.createCipher</a>，指定字符串参数'AES128|GCM|PKCS7'，创建对称密钥类型为AES128、分组模式为GCM、填充模式为PKCS7的Cipher实例，用于完成解密操作。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#init-1" target="_blank">Cipher.init</a>，设置模式为解密（CryptoMode.DECRYPT_MODE），指定解密密钥（SymKey）和GCM模式对应的解密参数（GcmParamsSpec），初始化解密Cipher实例。</p></li>     <li>      <p>将一次传入数据量设置为20字节，多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#update-1" target="_blank">Cipher.update</a>，更新数据（密文）。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#dofinal-1" target="_blank">Cipher.doFinal</a>，获取解密后的数据。</p></li>    </ol>    <ul>     <li>      <p>异步方法示例：</p>      <div _ngcontent-xhj-c106="" class="highlight-div"><div _ngcontent-xhj-c106="" class="highlight-div-header"><div _ngcontent-xhj-c106="" class="highlight-div-header-left"><div _ngcontent-xhj-c106="" class="handle-button expand-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhj-c106="" class="highlight-div-header-right"><div _ngcontent-xhj-c106="" class="handle-button ai-button"></div><div _ngcontent-xhj-c106="" class="handle-button line-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhj-c106="" class="handle-button theme-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhj-c106="" class="handle-button copy-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateRandom</span>(<span class="hljs-params">len: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> rand = cryptoFramework.<span class="hljs-title function_">createRandom</span>();</li><li>  <span class="hljs-keyword">let</span> generateRandSync = rand.<span class="hljs-title function_">generateRandomSync</span>(len);</li><li>  <span class="hljs-keyword">return</span> generateRandSync;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">genGcmParamsSpec</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> ivBlob = <span class="hljs-title function_">generateRandom</span>(<span class="hljs-number">12</span>);</li><li>  <span class="hljs-keyword">let</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]; <span class="hljs-comment">// 8 bytes</span></li><li>  <span class="hljs-keyword">let</span> dataAad = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aadBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: dataAad };</li><li>  arr = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]; <span class="hljs-comment">// 16 bytes</span></li><li>  <span class="hljs-keyword">let</span> dataTag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">tagBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = {</li><li>    <span class="hljs-attr">data</span>: dataTag</li><li>  }; <span class="hljs-comment">// The GCM authTag is obtained by doFinal() in encryption and passed in params of init() in decryption.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gcmParamsSpec</span>: cryptoFramework.<span class="hljs-property">GcmParamsSpec</span> = {</li><li>    <span class="hljs-attr">iv</span>: ivBlob,</li><li>    <span class="hljs-attr">aad</span>: aadBlob,</li><li>    <span class="hljs-attr">authTag</span>: tagBlob,</li><li>    <span class="hljs-attr">algName</span>: <span class="hljs-string">"GcmParamsSpec"</span></li><li>  };</li><li>  <span class="hljs-keyword">return</span> gcmParamsSpec;</li><li>}</li><li><span class="hljs-keyword">let</span> gcmParams = <span class="hljs-title function_">genGcmParamsSpec</span>();</li><li><span class="hljs-comment">// 分段加密消息。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">encryptMessageUpdateBySegment</span>(<span class="hljs-params">symKey: cryptoFramework.SymKey, plainText: cryptoFramework.DataBlob</span>) {</li><li>  <span class="hljs-keyword">let</span> cipher = cryptoFramework.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">'AES128|GCM|PKCS7'</span>);</li><li>  <span class="hljs-keyword">await</span> cipher.<span class="hljs-title function_">init</span>(cryptoFramework.<span class="hljs-property">CryptoMode</span>.<span class="hljs-property">ENCRYPT_MODE</span>, symKey, gcmParams);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设以20字节为单位进行分段update，实际并无要求。</span></li><li>  <span class="hljs-keyword">let</span> cipherText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; plainText.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = plainText.<span class="hljs-property">data</span>.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    <span class="hljs-comment">// 分段update。</span></li><li>    <span class="hljs-keyword">let</span> updateOutput = <span class="hljs-keyword">await</span> cipher.<span class="hljs-title function_">update</span>(updateMessageBlob);</li><li>    <span class="hljs-comment">// 把update的结果拼接起来，以获得密文。在某些情况下，还需要拼接doFinal的结果，这取决于分组模式。</span></li><li>    <span class="hljs-comment">// 和填充模式，本例中GCM模式的doFinal结果只包含authTag而不含密文，所以不需要拼接）。</span></li><li>    <span class="hljs-keyword">let</span> mergeText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(cipherText.<span class="hljs-property">length</span> + updateOutput.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>);</li><li>    mergeText.<span class="hljs-title function_">set</span>(cipherText);</li><li>    mergeText.<span class="hljs-title function_">set</span>(updateOutput.<span class="hljs-property">data</span>, cipherText.<span class="hljs-property">length</span>);</li><li>    cipherText = mergeText;</li><li>  }</li><li>  gcmParams.<span class="hljs-property">authTag</span> = <span class="hljs-keyword">await</span> cipher.<span class="hljs-title function_">doFinal</span>(<span class="hljs-literal">null</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cipherBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: cipherText };</li><li>  <span class="hljs-keyword">return</span> cipherBlob;</li><li>}</li><li><span class="hljs-comment">// 分段解密消息。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">decryptMessagePromise</span>(<span class="hljs-params">symKey: cryptoFramework.SymKey, cipherText: cryptoFramework.DataBlob</span>) {</li><li>  <span class="hljs-keyword">let</span> decoder = cryptoFramework.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">'AES128|GCM|PKCS7'</span>);</li><li>  <span class="hljs-keyword">await</span> decoder.<span class="hljs-title function_">init</span>(cryptoFramework.<span class="hljs-property">CryptoMode</span>.<span class="hljs-property">DECRYPT_MODE</span>, symKey, gcmParams);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设以20字节为单位进行分段update，实际并无要求。</span></li><li>  <span class="hljs-keyword">let</span> decryptText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cipherText.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = cipherText.<span class="hljs-property">data</span>.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    <span class="hljs-comment">// 分段update。</span></li><li>    <span class="hljs-keyword">let</span> updateOutput = <span class="hljs-keyword">await</span> decoder.<span class="hljs-title function_">update</span>(updateMessageBlob);</li><li>    <span class="hljs-comment">// 把update的结果拼接起来，得到明文。</span></li><li>    <span class="hljs-keyword">let</span> mergeText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(decryptText.<span class="hljs-property">length</span> + updateOutput.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>);</li><li>    mergeText.<span class="hljs-title function_">set</span>(decryptText);</li><li>    mergeText.<span class="hljs-title function_">set</span>(updateOutput.<span class="hljs-property">data</span>, decryptText.<span class="hljs-property">length</span>);</li><li>    decryptText = mergeText;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> decryptData = <span class="hljs-keyword">await</span> decoder.<span class="hljs-title function_">doFinal</span>(<span class="hljs-literal">null</span>);</li><li>  <span class="hljs-keyword">if</span> (decryptData === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'GCM decrypt success, decryptData is null'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">decryptBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: decryptText };</li><li>  <span class="hljs-keyword">return</span> decryptBlob;</li><li>}</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'AES128'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-keyword">await</span> aesGenerator.<span class="hljs-title function_">convertKey</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">aes</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">83</span>, <span class="hljs-number">217</span>, <span class="hljs-number">231</span>, <span class="hljs-number">76</span>, <span class="hljs-number">28</span>, <span class="hljs-number">113</span>, <span class="hljs-number">23</span>, <span class="hljs-number">219</span>, <span class="hljs-number">250</span>, <span class="hljs-number">71</span>, <span class="hljs-number">209</span>, <span class="hljs-number">210</span>, <span class="hljs-number">205</span>, <span class="hljs-number">97</span>, <span class="hljs-number">32</span>, <span class="hljs-number">159</span>]);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-keyword">await</span> <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"aaaaa.....bbbbb.....ccccc.....ddddd.....eee"</span>; <span class="hljs-comment">// 消息总共43字节，根据utf-8解码后，也是43字节。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">plainText</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(message, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>) };</li><li>  <span class="hljs-keyword">let</span> encryptText = <span class="hljs-keyword">await</span> <span class="hljs-title function_">encryptMessageUpdateBySegment</span>(symKey, plainText);</li><li>  <span class="hljs-keyword">let</span> decryptText = <span class="hljs-keyword">await</span> <span class="hljs-title function_">decryptMessagePromise</span>(symKey, encryptText);</li><li>  <span class="hljs-keyword">if</span> (plainText.<span class="hljs-property">data</span>.<span class="hljs-title function_">toString</span>() === decryptText.<span class="hljs-property">data</span>.<span class="hljs-title function_">toString</span>()) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'decrypt ok'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'decrypt plainText: '</span> + buffer.<span class="hljs-title function_">from</span>(decryptText.<span class="hljs-property">data</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'utf-8'</span>));</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'decrypt failed'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     <li>      <p>同步方法示例：</p>      <div _ngcontent-xhj-c106="" class="highlight-div"><div _ngcontent-xhj-c106="" class="highlight-div-header"><div _ngcontent-xhj-c106="" class="highlight-div-header-left"><div _ngcontent-xhj-c106="" class="handle-button expand-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhj-c106="" class="highlight-div-header-right"><div _ngcontent-xhj-c106="" class="handle-button ai-button"></div><div _ngcontent-xhj-c106="" class="handle-button line-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhj-c106="" class="handle-button theme-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhj-c106="" class="handle-button copy-button"><div _ngcontent-xhj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateRandom</span>(<span class="hljs-params">len: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> rand = cryptoFramework.<span class="hljs-title function_">createRandom</span>();</li><li>  <span class="hljs-keyword">let</span> generateRandSync = rand.<span class="hljs-title function_">generateRandomSync</span>(len);</li><li>  <span class="hljs-keyword">return</span> generateRandSync;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">genGcmParamsSpec</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> ivBlob = <span class="hljs-title function_">generateRandom</span>(<span class="hljs-number">12</span>);</li><li>  <span class="hljs-keyword">let</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]; <span class="hljs-comment">// 8 bytes</span></li><li>  <span class="hljs-keyword">let</span> dataAad = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aadBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: dataAad };</li><li>  arr = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]; <span class="hljs-comment">// 16 bytes</span></li><li>  <span class="hljs-keyword">let</span> dataTag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">tagBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = {</li><li>    <span class="hljs-attr">data</span>: dataTag</li><li>  }; <span class="hljs-comment">// The GCM authTag is obtained by doFinal() in encryption and passed in params of init() in decryption.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gcmParamsSpec</span>: cryptoFramework.<span class="hljs-property">GcmParamsSpec</span> = {</li><li>    <span class="hljs-attr">iv</span>: ivBlob,</li><li>    <span class="hljs-attr">aad</span>: aadBlob,</li><li>    <span class="hljs-attr">authTag</span>: tagBlob,</li><li>    <span class="hljs-attr">algName</span>: <span class="hljs-string">"GcmParamsSpec"</span></li><li>  };</li><li>  <span class="hljs-keyword">return</span> gcmParamsSpec;</li><li>}</li><li><span class="hljs-keyword">let</span> gcmParams = <span class="hljs-title function_">genGcmParamsSpec</span>();</li><li><span class="hljs-comment">// 分段加密消息。</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">encryptMessageUpdateBySegment</span>(<span class="hljs-params">symKey: cryptoFramework.SymKey, plainText: cryptoFramework.DataBlob</span>) {</li><li>  <span class="hljs-keyword">let</span> cipher = cryptoFramework.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">'AES128|GCM|PKCS7'</span>);</li><li>  cipher.<span class="hljs-title function_">initSync</span>(cryptoFramework.<span class="hljs-property">CryptoMode</span>.<span class="hljs-property">ENCRYPT_MODE</span>, symKey, gcmParams);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设以20字节为单位进行分段update，实际并无要求。</span></li><li>  <span class="hljs-keyword">let</span> cipherText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; plainText.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = plainText.<span class="hljs-property">data</span>.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    <span class="hljs-comment">// 分段update。</span></li><li>    <span class="hljs-keyword">let</span> updateOutput = cipher.<span class="hljs-title function_">updateSync</span>(updateMessageBlob);</li><li>    <span class="hljs-comment">// 把update的结果拼接起来，得到密文（有些情况下还需拼接doFinal的结果，这取决于分组模式。</span></li><li>    <span class="hljs-comment">// 和填充模式，本例中GCM模式的doFinal结果只包含authTag而不含密文，所以不需要拼接）。</span></li><li>    <span class="hljs-keyword">let</span> mergeText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(cipherText.<span class="hljs-property">length</span> + updateOutput.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>);</li><li>    mergeText.<span class="hljs-title function_">set</span>(cipherText);</li><li>    mergeText.<span class="hljs-title function_">set</span>(updateOutput.<span class="hljs-property">data</span>, cipherText.<span class="hljs-property">length</span>);</li><li>    cipherText = mergeText;</li><li>  }</li><li>  gcmParams.<span class="hljs-property">authTag</span> = cipher.<span class="hljs-title function_">doFinalSync</span>(<span class="hljs-literal">null</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cipherBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: cipherText };</li><li>  <span class="hljs-keyword">return</span> cipherBlob;</li><li>}</li><li><span class="hljs-comment">// 分段解密消息。</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">decryptMessage</span>(<span class="hljs-params">symKey: cryptoFramework.SymKey, cipherText: cryptoFramework.DataBlob</span>) {</li><li>  <span class="hljs-keyword">let</span> decoder = cryptoFramework.<span class="hljs-title function_">createCipher</span>(<span class="hljs-string">'AES128|GCM|PKCS7'</span>);</li><li>  decoder.<span class="hljs-title function_">initSync</span>(cryptoFramework.<span class="hljs-property">CryptoMode</span>.<span class="hljs-property">DECRYPT_MODE</span>, symKey, gcmParams);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设以20字节为单位进行分段update，实际并无要求。</span></li><li>  <span class="hljs-keyword">let</span> decryptText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cipherText.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = cipherText.<span class="hljs-property">data</span>.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    <span class="hljs-comment">// 分段update。</span></li><li>    <span class="hljs-keyword">let</span> updateOutput = decoder.<span class="hljs-title function_">updateSync</span>(updateMessageBlob);</li><li>    <span class="hljs-comment">// 把update的结果拼接起来，得到明文。</span></li><li>    <span class="hljs-keyword">let</span> mergeText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(decryptText.<span class="hljs-property">length</span> + updateOutput.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>);</li><li>    mergeText.<span class="hljs-title function_">set</span>(decryptText);</li><li>    mergeText.<span class="hljs-title function_">set</span>(updateOutput.<span class="hljs-property">data</span>, decryptText.<span class="hljs-property">length</span>);</li><li>    decryptText = mergeText;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> decryptData = decoder.<span class="hljs-title function_">doFinalSync</span>(<span class="hljs-literal">null</span>);</li><li>  <span class="hljs-keyword">if</span> (decryptData === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'GCM decrypt success, decryptData is null'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">decryptBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: decryptText };</li><li>  <span class="hljs-keyword">return</span> decryptBlob;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'AES128'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = aesGenerator.<span class="hljs-title function_">convertKeySync</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'convertKeySync success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">83</span>, <span class="hljs-number">217</span>, <span class="hljs-number">231</span>, <span class="hljs-number">76</span>, <span class="hljs-number">28</span>, <span class="hljs-number">113</span>, <span class="hljs-number">23</span>, <span class="hljs-number">219</span>, <span class="hljs-number">250</span>, <span class="hljs-number">71</span>, <span class="hljs-number">209</span>, <span class="hljs-number">210</span>, <span class="hljs-number">205</span>, <span class="hljs-number">97</span>, <span class="hljs-number">32</span>, <span class="hljs-number">159</span>]);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"aaaaa.....bbbbb.....ccccc.....ddddd.....eee"</span>; <span class="hljs-comment">// 消息总共43字节，根据utf-8解码后，也是43字节。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">plainText</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(message, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>) };</li><li>  <span class="hljs-keyword">let</span> encryptText = <span class="hljs-title function_">encryptMessageUpdateBySegment</span>(symKey, plainText);</li><li>  <span class="hljs-keyword">let</span> decryptText = <span class="hljs-title function_">decryptMessage</span>(symKey, encryptText);</li><li>  <span class="hljs-keyword">if</span> (plainText.<span class="hljs-property">data</span>.<span class="hljs-title function_">toString</span>() === decryptText.<span class="hljs-property">data</span>.<span class="hljs-title function_">toString</span>()) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'decrypt ok'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'decrypt plainText: '</span> + buffer.<span class="hljs-title function_">from</span>(decryptText.<span class="hljs-property">data</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'utf-8'</span>));</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'decrypt failed'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ul>   </div>   <div></div></div>