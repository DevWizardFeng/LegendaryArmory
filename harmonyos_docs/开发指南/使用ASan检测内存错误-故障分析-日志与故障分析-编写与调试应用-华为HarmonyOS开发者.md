<h1 _ngcontent-gex-c119="" class="doc-title ng-star-inserted" title="使用ASan检测内存错误"> 使用ASan检测内存错误 </h1>

<div _ngcontent-gex-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001545528013"><p id="ZH-CN_TOPIC_0000002478174480__zh-cn_topic_0000001536844965_p74454338919">为追求C/C++的极致性能，编译器和OS(Windows/Linux/Mac)运行框架不会对内存操作进行安全检测。针对该场景，DevEco Studio集成ASan（Address-Sanitizer）为开发者提供面向C/C++的地址越界检测能力，并通过FaultLog展示错误的堆栈详情及导致错误的代码行。关于ASan的检测原理请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-sanitizer-principle#section159561141247" target="_blank">ASan检测原理</a>。</p> <div class="tiledSection"><h2 id="section1665820539148">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section1665820539148" tips="复制节点链接"></i></h2><ul id="ZH-CN_TOPIC_0000002478174480__ul313617554108"><li id="li181361355191018">如果应用内的任一模块使能ASan，那么entry模块需同时使能ASan。如果entry模块未使能ASan，该应用在启动时将闪退，出现CPP Crash报错。</li><li id="li2065910471997">ASan、TSan、UBSan、HWASan不能同时开启，四个只能开启其中一个。</li></ul> </div> <div class="tiledSection"><h2 id="section111599216114">使能ASan<i class="anchor-icon anchor-icon-link" anchorid="section111599216114" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002478174480__p9236353113">可通过以下两种方式使能ASan。</p> </div> <div class="tiledSection"><h3 id="section1289183162016" class="firsth2">方式一<i class="anchor-icon anchor-icon-link" anchorid="section1289183162016" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002478174480__ol5749164611135"><li id="li16816161918189"><span>点击<strong>Run &gt; Edit Configurations &gt; </strong><strong>Diagnostics</strong>，勾选<strong>Address Sanitizer</strong>。</span><p></p><p id="ZH-CN_TOPIC_0000002478174480__p845898172411"></p> <p id="ZH-CN_TOPIC_0000002478174480__p1717503551817"><span><img originheight="230" originwidth="699" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104838.65147121616183841188740793264130:50001231000000:2800:8C990A80BF44A0E7DE804349405C9D7BCCDF243300A6BFB75440DB75D5DDFD0F.png" width="699" height="230"></span></p> <p></p></li><li id="li17749104615131"><span>如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_ASAN=ON”，表示以ASan模式编译so文件。</span><p></p><p id="ZH-CN_TOPIC_0000002478174480__p175054505139"><span><img originheight="553" originwidth="774" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104838.78908616935800318280233773800334:50001231000000:2800:DD9D46DE50085CC80140419930A2A941B62250572619197FCE1B7F229C28316A.png" width="774" height="553"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section8891931102015">方式二<i class="anchor-icon anchor-icon-link" anchorid="section8891931102015" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002478174480__ol8177953121311"><li id="li1217715391315"><span>修改工程目录下AppScope/app.json5，添加ASan配置开关。</span><p></p><div _ngcontent-gex-c106="" class="highlight-div"><div _ngcontent-gex-c106="" class="highlight-div-header"><div _ngcontent-gex-c106="" class="highlight-div-header-left"><div _ngcontent-gex-c106="" class="handle-button expand-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gex-c106="" class="highlight-div-header-right"><div _ngcontent-gex-c106="" class="handle-button ai-button"></div><div _ngcontent-gex-c106="" class="handle-button line-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gex-c106="" class="handle-button theme-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gex-c106="" class="handle-button copy-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gex-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478174480__screen141151345256" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-attr">"asanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478174480__p177410483720"><span><img originheight="467" originwidth="1160" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104838.75994581546311659178083233767995:50001231000000:2800:E192529F96B05430EB4C57642467327F292CBDEBB502E294F517B87E2CEF31FD.png" width="920" height="370.3793103448276"></span></p> <p></p></li><li id="li19177185316137"><span>设置模块级构建ASan插桩。</span><p></p><p id="ZH-CN_TOPIC_0000002478174480__p128781759275">在需要使能ASan的模块中，通过添加构建参数开启ASan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数：</p> <div _ngcontent-gex-c106="" class="highlight-div"><div _ngcontent-gex-c106="" class="highlight-div-header"><div _ngcontent-gex-c106="" class="highlight-div-header-left"><div _ngcontent-gex-c106="" class="handle-button expand-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gex-c106="" class="highlight-div-header-right"><div _ngcontent-gex-c106="" class="handle-button ai-button"></div><div _ngcontent-gex-c106="" class="handle-button line-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gex-c106="" class="handle-button theme-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gex-c106="" class="handle-button copy-button"><div _ngcontent-gex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gex-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478174480__screen28785598710" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_ASAN=ON"</span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478174480__p198782591071"><span><img originheight="553" originwidth="774" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104839.35403680910404641869218319684451:50001231000000:2800:76F1E07A0A2B48A6EA999ABA6E9D916334F244F853D05D0EC75CC66C15A31A74.png" width="774" height="553"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002478174480__p71238163493">该参数未配置不会报错，但是除包含malloc和free函数等少数内存错误外，出现其他需要插桩检测的内存错误时，ASan无法检测到错误。</p> </div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section746592362512">（可选）配置参数<i class="anchor-icon anchor-icon-link" anchorid="section746592362512" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002478174480__p1646518230252">ASAN_OPTIONS用于在运行时配置ASan的行为，包括设置检测级别、输出格式、内存错误报告的详细程度等。ASAN_OPTIONS支持在app.json5中配置，也支持在Run/Debug Configurations中配置。app.json5的优先级更高，即两种方式都配置后，以app.json5中的配置为准。关于ASAN_OPTIONS的配置方式和常用参数请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-asan-detection#section1496994494018" target="_blank">配置参数</a>。</p> </div> <div class="tiledSection"><h2 id="section989133116209">启用ASan<i class="anchor-icon anchor-icon-link" anchorid="section989133116209" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478174480__ol1327243717121"><li id="zh-cn_topic_0000001536844965_li493493716719"><span>运行或调试当前应用。</span></li><li id="li824420817265"><span>当程序出现内存错误时，弹出ASan log信息，点击信息中的链接即可跳转至引起内存错误的代码处。日志中各字段的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/address-sanitizer-guidelines#asan日志规格" target="_blank">ASan日志规格</a>，异常检测类型请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-asan-detection#section12508111110451" target="_blank">ASan异常检测类型</a>。</span><p></p><p id="ZH-CN_TOPIC_0000002478174480__p11206151114261"><span><img height="462.9177142857143" originheight="863" originwidth="1728" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104839.56478561577522342431953239113814:50001231000000:2800:72E163936CE545F2460A22D50DC14C98FA0EA2FB5EE1216AC0E2B2AEECDF9783.png" title="点击放大" width="920"></span></p> <p></p></li></ol> </div> </div> <div></div></div>