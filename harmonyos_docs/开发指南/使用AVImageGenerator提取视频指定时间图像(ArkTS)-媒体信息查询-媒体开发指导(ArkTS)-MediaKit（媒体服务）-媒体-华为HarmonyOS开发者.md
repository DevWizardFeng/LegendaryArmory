<h1 _ngcontent-ngk-c119="" class="doc-title ng-star-inserted" title="使用AVImageGenerator提取视频指定时间图像(ArkTS)"> 使用AVImageGenerator提取视频指定时间图像(ArkTS) </h1>

<div _ngcontent-ngk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avimagegenerator">AVImageGenerator</a>可以实现从原始媒体资源中获取视频指定时间的缩略图，本开发指导将以获取一个视频资源的缩略图作为示例，向开发者讲解AVImageGenerator相关功能。</p>    <p>获取视频资源的缩略图的全流程包含：创建AVImageGenerator对象，设置资源，获取缩略图，销毁资源。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avimagegenerator" target="_blank">AVImageGenerator API参考</a>。</p>     <ol>      <li>       <p>使用createAVImageGenerator()创建实例。</p>       <div _ngcontent-ngk-c106="" class="highlight-div"><div _ngcontent-ngk-c106="" class="highlight-div-header"><div _ngcontent-ngk-c106="" class="highlight-div-header-left"><div _ngcontent-ngk-c106="" class="handle-button expand-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngk-c106="" class="highlight-div-header-right"><div _ngcontent-ngk-c106="" class="handle-button ai-button"></div><div _ngcontent-ngk-c106="" class="handle-button line-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngk-c106="" class="handle-button theme-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngk-c106="" class="handle-button copy-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avImageGenerator</span>: media.<span class="hljs-property">AVImageGenerator</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVImageGenerator</span>();</li></ol></pre></div></div></li>      <li>       <p>设置资源：需要设置属性fdSrc（表示文件描述符）。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>开发者需根据实际情况，确认资源有效性并设置fdSrc：</p>         <ul>          <li>           <p>可以使用ResourceManager.getRawFd打开HAP资源文件描述符，使用方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfd9" target="_blank">ResourceManager API参考</a>。</p></li>          <li>           <p>也可以使用应用沙箱路径访问对应资源（必须确认资源文件可用），参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径">获取应用文件路径</a>。应用沙箱的介绍及如何向应用沙箱推送文件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory">文件管理</a>。</p></li>          <li>           <p>不同AVImageGenerator或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avmetadataextractor" target="_blank">AVMetadataExtractor</a>，如果需要操作同一资源，需要多次打开文件描述符，不要共用同一文件描述符。</p></li>         </ul>        </div></div></div>       <div _ngcontent-ngk-c106="" class="highlight-div"><div _ngcontent-ngk-c106="" class="highlight-div-header"><div _ngcontent-ngk-c106="" class="highlight-div-header-left"><div _ngcontent-ngk-c106="" class="handle-button expand-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngk-c106="" class="highlight-div-header-right"><div _ngcontent-ngk-c106="" class="handle-button ai-button"></div><div _ngcontent-ngk-c106="" class="handle-button line-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngk-c106="" class="handle-button theme-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngk-c106="" class="handle-button copy-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// 获取当前组件所在Ability的Context，并通过Context获取应用文件路径。</span></li><li><span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li><span class="hljs-comment">// 设置fdSrc，H264_AAC.mp4为rawfile目录下的预置资源，需要开发者根据实际情况进行替换。</span></li><li>avImageGenerator.<span class="hljs-property">fdSrc</span> = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'H264_AAC.mp4'</span>);</li></ol></pre></div></div></li>      <li>       <p>获取指定时间图像：调用fetchFrameByTime()，可以获取到一个PixelMap对象，该对象可用于图片显示。</p>       <div _ngcontent-ngk-c106="" class="highlight-div"><div _ngcontent-ngk-c106="" class="highlight-div-header"><div _ngcontent-ngk-c106="" class="highlight-div-header-left"><div _ngcontent-ngk-c106="" class="handle-button expand-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngk-c106="" class="highlight-div-header-right"><div _ngcontent-ngk-c106="" class="handle-button ai-button"></div><div _ngcontent-ngk-c106="" class="handle-button line-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngk-c106="" class="handle-button theme-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngk-c106="" class="handle-button copy-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-comment">// pixelMap对象声明，用于图片显示。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-comment">// 初始化入参。</span></li><li><span class="hljs-keyword">let</span> timeUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 需要获取的缩略图在视频中的时间点。</span></li><li><span class="hljs-keyword">let</span> queryOption = media.<span class="hljs-property">AVImageQueryOptions</span>.<span class="hljs-property">AV_IMAGE_QUERY_NEXT_SYNC</span>; <span class="hljs-comment">// AV_IMAGE_QUERY_NEXT_SYNC表示选取传入时间点或之后的关键帧。</span></li><li><span class="hljs-comment">// 输出缩略图的格式参数。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">param</span>: media.<span class="hljs-property">PixelMapParams</span> = {</li><li>  width : <span class="hljs-number">300</span>, <span class="hljs-comment">// 输出的缩略图宽度。</span></li><li>  height : <span class="hljs-number">300</span> <span class="hljs-comment">// 输出的缩略图高度。</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 获取缩略图（promise模式）。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = <span class="hljs-keyword">await</span> avImageGenerator.<span class="hljs-title function_">fetchFrameByTime</span>(timeUs, queryOption, param);</li></ol></pre></div></div></li>      <li>       <p>释放资源：调用release()销毁实例，释放资源。</p>       <div _ngcontent-ngk-c106="" class="highlight-div"><div _ngcontent-ngk-c106="" class="highlight-div-header"><div _ngcontent-ngk-c106="" class="highlight-div-header-left"><div _ngcontent-ngk-c106="" class="handle-button expand-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngk-c106="" class="highlight-div-header-right"><div _ngcontent-ngk-c106="" class="handle-button ai-button"></div><div _ngcontent-ngk-c106="" class="handle-button line-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngk-c106="" class="handle-button theme-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngk-c106="" class="handle-button copy-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放资源（promise模式）。</span></li><li>avImageGenerator.<span class="hljs-title function_">release</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="运行示例工程">运行示例工程<i class="anchor-icon anchor-icon-link" anchorid="运行示例工程" tips="复制节点链接"></i></h2>          <p>参考以下示例，获取一个视频指定时间的缩略图。</p>     <ol>      <li>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVImageGenerator/AVImageGeneratorArkTS" target="_blank">完整示例工程</a>，并将示例工程的资源复制到对应目录。       <div _ngcontent-ngk-c106="" class="highlight-div"><div _ngcontent-ngk-c106="" class="highlight-div-header"><div _ngcontent-ngk-c106="" class="highlight-div-header-left"><div _ngcontent-ngk-c106="" class="handle-button expand-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngk-c106="" class="highlight-div-header-right"><div _ngcontent-ngk-c106="" class="handle-button ai-button"></div><div _ngcontent-ngk-c106="" class="handle-button line-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngk-c106="" class="handle-button theme-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngk-c106="" class="handle-button copy-button"><div _ngcontent-ngk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVImageGeneratorArkTS</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (获取缩略图界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│</li><li>└── rawfile</li><li>    └── H264_AAC<span class="hljs-selector-class">.mp4</span> (视频资源)</li></ol></pre></div></div></li>      <li>编译新建工程并运行。</li>     </ol>    </div>   </div>   <div></div></div>