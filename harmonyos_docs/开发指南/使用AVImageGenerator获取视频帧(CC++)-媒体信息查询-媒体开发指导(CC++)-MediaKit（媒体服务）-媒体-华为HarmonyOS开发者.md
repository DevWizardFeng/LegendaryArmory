<h1 _ngcontent-hvc-c119="" class="doc-title ng-star-inserted" title="使用AVImageGenerator获取视频帧(C/C++)"> 使用AVImageGenerator获取视频帧(C/C++) </h1>

<div _ngcontent-hvc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用AVImageGenerator可以实现从原始媒体资源中获取指定时间的视频帧，本开发指导将以获取视频帧作为示例，向开发者讲解AVImageGenerator相关功能。</p>    <p>获取视频帧的全流程包含：创建AVImageGenerator对象、设置资源、获取视频帧、销毁资源。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>在 CMake 脚本中链接动态库。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libavimage_generator.so libace_napi.z.so)</li></ol></pre></div></div>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_convertpixelmapnativetonapi" target="_blank">OH_PixelmapNative_ConvertPixelmapNativeToNapi()</a>接口将nativePixelMap对象转换为PixelMapnapi对象、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_release" target="_blank">OH_PixelmapNative_Release()</a>接口释放OH_PixelmapNative对象资源，需引入如下头文件。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li></ol></pre></div></div>     <p>并在 CMake 脚本中链接如下动态库。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libpixelmap.so libpixelmap_ndk.z.so)</li></ol></pre></div></div>     <p>开发者使用系统日志能力时，需引入如下头文件。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li></ol></pre></div></div>     <p>并需要在 CMake 脚本中链接如下动态库。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libhilog_ndk.z.so)</li></ol></pre></div></div>     <p>（可选）开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avmetadata-extractor-h#oh_avmetadataextractor_fetchmetadata" target="_blank">OH_AVMetadataExtractor_FetchMetadata()</a>获取媒体资源时长信息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avmetadata-extractor-base-h#变量" target="_blank">OH_AVMETADATA_EXTRACTOR_DURATION</a>，进而选择获取视频帧的时间。使用需引入如下头文件。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/avmetadata_extractor.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/avmetadata_extractor_base.h"</span></span></li></ol></pre></div></div>     <p>并需要在 CMake 脚本中链接如下动态库。</p>     <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libavmetadata_extractor.so libnative_media_core.so)</li></ol></pre></div></div>     <p>开发者通过引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-h" target="_blank">avimage_generator.h</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-base-h" target="_blank">avimage_generator_base.h</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-averrors-h" target="_blank">native_averrors.h</a>头文件，使用获取视频帧相关API。</p>     <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimagegenerator" target="_blank">AVImageGenerator API参考</a>。</p>     <ol>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-h#oh_avimagegenerator_create" target="_blank">OH_AVImageGenerator_Create()</a>创建实例。</p>       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avimage_generator.h&gt;</span></span></li><li><span class="hljs-comment">// 创建OH_AVImageGenerator实例。</span></li><li>OH_AVImageGenerator* generator = OH_AVImageGenerator_Create();</li></ol></pre></div></div></li>      <li>       <p>设置视频资源的文件描述符：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-h#oh_avimagegenerator_setfdsource" target="_blank">OH_AVImageGenerator_SetFDSource()</a>。</p>       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avimage_generator.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_averrors.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">int64_t</span> offset = <span class="hljs-number">0</span>; <span class="hljs-comment">// 媒体源在文件描述符中的偏移量。</span></li><li><span class="hljs-type">int32_t</span> fileDescribe = <span class="hljs-number">-1</span>; <span class="hljs-comment">// 媒体文件描述符。</span></li><li><span class="hljs-type">int32_t</span> fileSize = <span class="hljs-number">0</span>; <span class="hljs-comment">// 媒体文件大小。</span></li><li>    </li><li><span class="hljs-comment">// 设置视频资源的文件描述符。</span></li><li>OH_AVErrCode avErrCode = OH_AVImageGenerator_SetFDSource(generator, fileDescribe, offset, fileSize);</li><li><span class="hljs-comment">// 异常处理。</span></li><li><span class="hljs-keyword">if</span> (avErrCode != AV_ERR_OK) {</li><li>    OH_AVImageGenerator_Release(generator);</li><li>    napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"SetFDSource failed"</span>);</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）获取媒体资源时长信息，并指定获取视频帧的时间。</p>       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/avmetadata_extractor.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/player_framework/avmetadata_extractor_base.h"</span></span></li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">OhAVMetadataExtractorGetDuration</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    <span class="hljs-type">int64_t</span> offset = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> fileDescribe = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">int64_t</span> fileSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 通过辅助函数，获取输入参数，实现见完整示例。</span></li><li>    <span class="hljs-keyword">if</span> (!GetGetDurationParams(env, info, offset, fileDescribe, fileSize)) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    OH_AVMetadataExtractor* mainExtractor = OH_AVMetadataExtractor_Create();</li><li>    <span class="hljs-keyword">if</span> (!mainExtractor) {</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"Create metadata extractor failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    OH_AVErrCode avErrCode = OH_AVMetadataExtractor_SetFDSource(mainExtractor, fileDescribe, offset, fileSize);</li><li>    <span class="hljs-keyword">if</span> (avErrCode != AV_ERR_OK) {</li><li>        OH_AVMetadataExtractor_Release(mainExtractor);</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"SetFDSource for metadata extractor failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    OH_AVFormat* avMetadata = OH_AVFormat_Create();</li><li>    <span class="hljs-comment">// 获取资源文件的元数据信息。</span></li><li>    avErrCode = OH_AVMetadataExtractor_FetchMetadata(mainExtractor, avMetadata);</li><li>    <span class="hljs-keyword">if</span> (avErrCode != AV_ERR_OK) {</li><li>        OH_AVFormat_Destroy(avMetadata);</li><li>        OH_AVMetadataExtractor_Release(mainExtractor);</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"Fetch metadata failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> out;</li><li>    <span class="hljs-comment">// 从元数据中获取资源文件的时长。</span></li><li>    <span class="hljs-keyword">if</span> (!OH_AVFormat_GetLongValue(avMetadata, OH_AVMETADATA_EXTRACTOR_DURATION, &amp;out)) {</li><li>        OH_AVFormat_Destroy(avMetadata);</li><li>        OH_AVMetadataExtractor_Release(mainExtractor);</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"Get duration failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value duration;</li><li>    napi_create_int64(env, out, &amp;duration);</li><li>    OH_AVFormat_Destroy(avMetadata);</li><li>    OH_AVMetadataExtractor_Release(mainExtractor);</li><li>    <span class="hljs-keyword">return</span> duration;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取指定时间的视频帧：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-h#oh_avimagegenerator_fetchframebytime" target="_blank">OH_AVImageGenerator_FetchFrameByTime()</a>，可以获取到一个OH_PixelmapNative对象，该对象可用于图片显示。</p>       <ul>        <li>使用完成需要调用OH_PixelmapNative_Release释放OH_PixelmapNative对象资源，详细使用方法请参阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_release" target="_blank">Image_NativeModule</a>。</li>       </ul>       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avimage_generator.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avimage_generator_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_averrors.h&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// FetchFrameByTime的输入参数。</span></li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">FetchFrameParams</span> {</span></li><li>    <span class="hljs-type">int64_t</span> timeUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 指定的时间（单位us）。</span></li><li>    <span class="hljs-type">int64_t</span> offset = <span class="hljs-number">0</span>; <span class="hljs-comment">// 媒体源在文件描述符中的偏移量。</span></li><li>    <span class="hljs-type">int32_t</span> fileDescribe = <span class="hljs-number">-1</span>; <span class="hljs-comment">// 媒体文件描述符。</span></li><li>    <span class="hljs-type">int32_t</span> fileSize = <span class="hljs-number">0</span>; <span class="hljs-comment">// 媒体文件大小。</span></li><li>    <span class="hljs-type">int32_t</span> options = OH_AVIMAGE_GENERATOR_QUERY_CLOSEST; <span class="hljs-comment">// OH_AVIMAGE_GENERATOR_QUERY_CLOSEST表示选取离传入时间点最近的关键帧。</span></li><li>};</li><li>
</li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">OhAvImageGeneratorFetchFrameByTime</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    FetchFrameParams fetchFrameParams;</li><li>    <span class="hljs-comment">// 通过辅助函数，获取输入参数，实现见完整示例。</span></li><li>    <span class="hljs-keyword">if</span> (!GetFetchFrameByTimeParams(env, info, fetchFrameParams)) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> timeUs = fetchFrameParams.timeUs;</li><li>    <span class="hljs-type">int64_t</span> offset = fetchFrameParams.offset;</li><li>    <span class="hljs-type">int32_t</span> fileDescribe = fetchFrameParams.fileDescribe;</li><li>    <span class="hljs-type">int32_t</span> fileSize = fetchFrameParams.fileSize;</li><li>    <span class="hljs-type">int32_t</span> options = fetchFrameParams.options;</li><li>    <span class="hljs-comment">// 创建OH_AVImageGenerator实例。</span></li><li>    OH_AVImageGenerator* generator = OH_AVImageGenerator_Create();</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>    <span class="hljs-keyword">if</span> (!generator) {</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"Create generator failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 设置视频资源的文件描述符。</span></li><li>    OH_AVErrCode avErrCode = OH_AVImageGenerator_SetFDSource(generator, fileDescribe, offset, fileSize);</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>    <span class="hljs-keyword">if</span> (avErrCode != AV_ERR_OK) {</li><li>        OH_AVImageGenerator_Release(generator);</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"SetFDSource failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 取指定时间的视频帧。</span></li><li>    OH_PixelmapNative* pixelMap = nullptr;</li><li>    avErrCode = OH_AVImageGenerator_FetchFrameByTime(generator, timeUs,</li><li>        (OH_AVImageGenerator_QueryOptions)options, &amp;pixelMap);</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>    <span class="hljs-keyword">if</span> (avErrCode != AV_ERR_OK || !pixelMap) {</li><li>        OH_AVImageGenerator_Release(generator);</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"FetchFrameByTime failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 将nativePixelMap对象转换为PixelMapnapi对象。</span></li><li>    napi_value pixelmapNapi = nullptr;</li><li>    Image_ErrorCode errCode = OH_PixelmapNative_ConvertPixelmapNativeToNapi(env, pixelMap, &amp;pixelmapNapi);</li><li>    <span class="hljs-comment">// 释放OH_PixelmapNative资源。</span></li><li>    OH_PixelmapNative_Release(pixelMap);</li><li>    <span class="hljs-comment">// 释放OH_AVImageGenerator资源。</span></li><li>    OH_AVImageGenerator_Release(generator);</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        napi_throw_error(env, <span class="hljs-string">"EFAILED"</span>, <span class="hljs-string">"Convert PixelMap failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> pixelmapNapi;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>释放资源：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avimage-generator-h#oh_avimagegenerator_release" target="_blank">OH_AVImageGenerator_Release()</a>销毁实例，释放资源。</p>       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放OH_AVImageGenerator资源。</span></li><li>OH_AVImageGenerator_Release(generator);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="运行示例工程">运行示例工程<i class="anchor-icon anchor-icon-link" anchorid="运行示例工程" tips="复制节点链接"></i></h2>          <p>参考以下示例，获取一个视频指定时间的视频帧。</p>     <ol>      <li>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVImageGenerator/AVImageGeneratorNDK" target="_blank">完整示例工程</a>，并将示例工程的资源复制到对应目录。       <div _ngcontent-hvc-c106="" class="highlight-div"><div _ngcontent-hvc-c106="" class="highlight-div-header"><div _ngcontent-hvc-c106="" class="highlight-div-header-left"><div _ngcontent-hvc-c106="" class="handle-button expand-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvc-c106="" class="highlight-div-header-right"><div _ngcontent-hvc-c106="" class="handle-button ai-button"></div><div _ngcontent-hvc-c106="" class="handle-button line-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvc-c106="" class="handle-button theme-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvc-c106="" class="handle-button copy-button"><div _ngcontent-hvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVImageGeneratorNDK</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (获取缩略图界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/</li><li>├── cpp</li><li>│   ├── types</li><li>│   │   └── libentry</li><li>│   │       └── Index<span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.ts</span> (NDK函数对应的js映射)</li><li>│   ├── CMakeLists<span class="hljs-selector-class">.txt</span> (CMake脚本)</li><li>│   └── napi_init<span class="hljs-selector-class">.cpp</span> (NDK函数)</li><li>└── resources</li><li>    ├── base</li><li>    │   ├── element</li><li>    │   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>    │   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>    │   │   └── string<span class="hljs-selector-class">.json</span></li><li>    │   └── media</li><li>    │</li><li>    └── rawfile</li><li>        └── H264_AAC<span class="hljs-selector-class">.mp4</span> (视频资源)</li></ol></pre></div></div></li>      <li>编译新建工程并运行。</li>     </ol>    </div>   </div>   <div></div></div>