<h1 _ngcontent-wxd-c119="" class="doc-title ng-star-inserted" title="使用AVPlayer播放流媒体(ArkTS)"> 使用AVPlayer播放流媒体(ArkTS) </h1>

<div _ngcontent-wxd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本开发指导将介绍如何使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avplayer">AVPlayer</a>开发流媒体直播和点播功能。示例展示如何完整播放流媒体视频，实现端到端的流媒体资源播放。</p>    <p>本指导仅介绍流媒体播放功能。本地音视频播放等其他场景，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback">视频播放</a>。</p>    <div class="tiledSection">     <h2 id="流媒体支持的格式">流媒体支持的格式<i class="anchor-icon anchor-icon-link" anchorid="流媒体支持的格式" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.6.1.1" valign="top" width="20%">流媒体协议类型</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.6.1.2" valign="top" width="20%">典型链接</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.6.1.3" valign="top" width="20%">网络点播</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.6.1.4" valign="top" width="20%">网络直播</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.6.1.5" valign="top" width="20%">内容保护</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="20%">HLS</td>         <td class="cellrowborder" valign="top" width="20%">https://xxxx/index.m3u8</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/drm-overview">DRM Kit</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">DASH</td>         <td class="cellrowborder" valign="top" width="20%">https://xxxx.mpd</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">-</td>         <td class="cellrowborder" valign="top" width="20%">支持，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/drm-overview">DRM Kit</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">HTTP/HTTPS</td>         <td class="cellrowborder" valign="top" width="20%">https://xxxx.mp4</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">-</td>         <td class="cellrowborder" valign="top" width="20%">-</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">HTTP-FLV</td>         <td class="cellrowborder" valign="top" width="20%">https://xxxx.flv</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">-</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>创建AVPlayer、设置播放资源和窗口、设置播放参数（音量/倍速/缩放模式）、进行播放控制（播放/暂停/跳转/停止）、重置资源、销毁资源。应用开发时，开发者可通过AVPlayer的state属性主动获取当前状态，或使用on('stateChange')方法监听状态变化。视频播放器处于错误状态时执行操作，可能导致异常或未定义行为。状态详细参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avplayerstate9" target="_blank">AVPlayerState</a>。具体步骤如下：</p>     <ol>      <li>       <p>创建实例createAVPlayer()，初始化AVPlayer为idle状态。</p></li>      <li>       <p>设置业务需要的监听事件，搭配全流程场景使用。支持的监听事件包括：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">stateChange</td>           <td class="cellrowborder" valign="top" width="50%">            <p>必要事件，监听播放器的state属性改变。</p>            <p>需要播放器在idle状态下、未调用设置资源接口前完成设置监听，若在调用设置资源接口后再设置监听，可能导致无法收到资源设置过程中上报的stateChange事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">error</td>           <td class="cellrowborder" valign="top" width="50%">            <p>必要事件，监听播放器的错误信息。</p>            <p>需要播放器在idle状态下、未调用设置资源接口前完成设置监听，若在调用设置资源接口后再设置监听，可能导致无法收到资源设置过程中上报的error事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">durationUpdate</td>           <td class="cellrowborder" valign="top" width="50%">监听进度条长度，刷新资源时长。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">timeUpdate</td>           <td class="cellrowborder" valign="top" width="50%">监听进度条当前位置，刷新当前时间。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">seekDone</td>           <td class="cellrowborder" valign="top" width="50%">            <p>监听seek()请求完成情况。</p>            <p>当使用seek()跳转到指定播放位置后，如果seek操作成功，将上报该事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">speedDone</td>           <td class="cellrowborder" valign="top" width="50%">            <p>监听setSpeed()请求完成情况。</p>            <p>当使用setSpeed()设置播放倍速后，如果setSpeed操作成功，将上报该事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">volumeChange</td>           <td class="cellrowborder" valign="top" width="50%">            <p>监听setVolume()请求完成情况。</p>            <p>当使用setVolume()调节播放音量后，如果setVolume操作成功，将上报该事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">bufferingUpdate</td>           <td class="cellrowborder" valign="top" width="50%">监听网络播放缓冲信息，上报缓冲百分比以及缓存播放进度。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">audioInterrupt</td>           <td class="cellrowborder" valign="top" width="50%">            <p>监听音频焦点切换信息，搭配属性audioInterruptMode使用。</p>            <p>如果当前设备存在多个音频正在播放，音频焦点被切换（即播放其他媒体如通话等）时将上报该事件，应用可以及时处理。</p></td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p>设置资源：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/playback-url-setting-method">使用AVPlayer设置播放URL</a>，使AVPlayer进入initialized状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>下面代码示例中的url仅作示意，开发者需根据实际情况确认资源有效性并设置。</p>         <ul>          <li>           <p>使用网络播放路径，需<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>：ohos.permission.INTERNET。</p></li>          <li>           <p>使用支持的播放格式和协议。</p></li>         </ul>        </div></div></div></li>      <li>       <p>设置窗口：获取并设置SurfaceID属性，用于配置显示画面。</p>       <p>应用从XComponent组件获取surfaceID，获取方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>。</p></li>      <li>       <p>准备播放：调用prepare()，使AVPlayer进入prepared状态，此时可获取duration，设置缩放模式、音量等。</p></li>      <li>       <p>进行视频播控：播放play()，暂停pause()，跳转seek()，停止stop() 等操作。</p></li>      <li>       <p>（可选）更换资源：调用reset()重置资源，使AVPlayer重新进入idle状态，允许更换资源url。</p></li>      <li>       <p>退出播放：调用release()销毁实例，使AVPlayer进入released状态，退出播放。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2>          <p>播放流媒体的标准流程如上述开发步骤所示。不同的流媒体格式在实际开发的过程中存在差异，本节将详细描述这些差异，包括视频起播策略的设置和音视频轨道的切换。</p>    </div>    <div class="tiledSection">     <h3 id="流媒体缓冲状态" class="firsth2">流媒体缓冲状态<i class="anchor-icon anchor-icon-link" anchorid="流媒体缓冲状态" tips="复制节点链接"></i></h3>          <p>当下载速率低于片源的码率时，会出现卡顿。此时，播放器检测到缓冲区数据不足，会先缓冲一些数据再播放，避免连续卡顿。一次卡顿对应的缓冲事件上报过程为：BUFFERING_START-&gt; BUFFERING_PERCENT 0 -&gt; ... -&gt; BUFFERING_PERCENT 100 -&gt; BUFFERING_END。CACHED_DURATION在卡顿过程和播放过程中都会持续上报，直至下载至资源末尾。详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-e#bufferinginfotype8" target="_blank">BufferingInfoType缓冲事件类型枚举</a>。</p>     <p>监听当前bufferingUpdate缓冲状态示例代码：</p>     <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-comment">// 监听当前bufferingUpdate缓冲状态。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bufferingUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">infoType : media.BufferingInfoType, value : <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer bufferingUpdate, infoType is <span class="hljs-subst">${infoType}</span>, value is <span class="hljs-subst">${value}</span>.`</span>);</li><li>})</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="hls切换码率">HLS切换码率<i class="anchor-icon anchor-icon-link" anchorid="hls切换码率" tips="复制节点链接"></i></h3>          <p>当前流媒体HLS协议流支持多码率播放，默认情况下，播放器会根据网络下载速度选择合适的码率。</p>     <ol>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onavailablebitrates9" target="_blank">on('availableBitrates')</a>监听当前HLS协议流可用的码率。如果监听的码率列表长度为0，则不支持设置指定码率。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-comment">// 监听当前HLS协议流可用的码率。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'availableBitrates'</span>, <span class="hljs-function">(<span class="hljs-params">bitrates: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">number</span>&gt;</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'availableBitrates called, and availableBitrates length is: '</span> + bitrates.<span class="hljs-property">length</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setbitrate9" target="_blank">setBitrate</a>接口设置播放码率。若用户设置的码率不在可用码率中，播放器将选择最小且最接近的码率。该接口只能在prepared/playing/paused/completed状态下调用，可通过监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onbitratedone9" target="_blank">bitrateDone</a>事件确认是否生效。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-comment">// 监听码率设置是否生效。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bitrateDone'</span>, <span class="hljs-function">(<span class="hljs-params">bitrate: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bitrateDone called, and bitrate value is: '</span> + bitrate);</li><li>})</li><li><span class="hljs-comment">// 设置播放码率。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">bitrate</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">96000</span>;</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setBitrate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">bitrate</span>);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="dash设置视频起播策略">DASH设置视频起播策略<i class="anchor-icon anchor-icon-link" anchorid="dash设置视频起播策略" tips="复制节点链接"></i></h3>          <p>为了保证在弱网环境下的播放体验，AVPlayer将默认选择最低的视频分辨率开始播放，随后依据网络状况自动调整。开发者可以根据具体需求，自定义DASH视频的起播策略，包括设定视频的宽度、高度以及色彩格式等参数。</p>     <p>下述示例代码描述了设置视频宽度1920px、高度1080px起播。AVPlayer会选择MPD资源中一路分辨率为1920x1080的视频资源进行播放。</p>     <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> mediaSource : media.<span class="hljs-property">MediaSource</span> = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(<span class="hljs-string">"http://test.cn/dash/aaa.mpd"</span>,  {<span class="hljs-string">"User-Agent"</span> : <span class="hljs-string">"User-Agent-Value"</span>});</li><li><span class="hljs-keyword">let</span> playbackStrategy : media.<span class="hljs-property">PlaybackStrategy</span> = {<span class="hljs-attr">preferredWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">preferredHeight</span>: <span class="hljs-number">1080</span>};</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="dash切换音视频轨道">DASH切换音视频轨道<i class="anchor-icon anchor-icon-link" anchorid="dash切换音视频轨道" tips="复制节点链接"></i></h3>          <p>DASH流媒体资源包含多路不同分辨率、码率、采样率、编码格式的音频、视频及字幕资源。默认情况下，AVPlayer会依据网络状况自动切换不同码率的视频轨道。开发者可根据需求选择指定的音视频轨道播放，此时自适应码率切换策略将失效。</p>     <ol>      <li>       <p>设置selectTrack生效的监听事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#ontrackchange12" target="_blank">trackChange</a>。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'trackChange'</span>, <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span>, isSelect: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`trackChange info, index: <span class="hljs-subst">${index}</span>, isSelect: <span class="hljs-subst">${isSelect}</span>`</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#gettrackdescription9" target="_blank">getTrackDescription</a>获取所有音视频轨道列表。开发者可根据实际需求，基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#mediadescription8" target="_blank">MediaDescription</a>各字段信息，确定目标轨道索引。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 以获取1080p视频轨道索引为例。</span></li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">public</span> <span class="hljs-attr">videoTrackIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">getTrackDescription</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError, arrList: <span class="hljs-built_in">Array</span>&lt;media.MediaDescription&gt;</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (arrList != <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arrList.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">propertyIndex</span>: <span class="hljs-title class_">Object</span> = arrList[i][media.<span class="hljs-property">MediaDescriptionKey</span>.<span class="hljs-property">MD_KEY_TRACK_INDEX</span>];</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">propertyType</span>: <span class="hljs-title class_">Object</span> = arrList[i][media.<span class="hljs-property">MediaDescriptionKey</span>.<span class="hljs-property">MD_KEY_TRACK_TYPE</span>];</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">propertyWidth</span>: <span class="hljs-title class_">Object</span> = arrList[i][media.<span class="hljs-property">MediaDescriptionKey</span>.<span class="hljs-property">MD_KEY_WIDTH</span>];</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">propertyHeight</span>: <span class="hljs-title class_">Object</span> = arrList[i][media.<span class="hljs-property">MediaDescriptionKey</span>.<span class="hljs-property">MD_KEY_HEIGHT</span>];</li><li>      <span class="hljs-keyword">if</span> (propertyType == media.<span class="hljs-property">MediaType</span>.<span class="hljs-property">MEDIA_TYPE_VID</span> &amp;&amp; propertyWidth == <span class="hljs-number">1920</span> &amp;&amp; propertyHeight == <span class="hljs-number">1080</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoTrackIndex</span> = <span class="hljs-built_in">parseInt</span>(propertyIndex?.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// 获取1080p视频轨道索引。</span></li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getTrackDescription fail, error:<span class="hljs-subst">${error}</span>`</span>);</li><li>  }</li><li>});</li></ol></pre></div></div></li>      <li>       <p>在音视频播放过程中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#selecttrack12" target="_blank">selectTrack</a>选择对应的音视频轨道，或者调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#deselecttrack12" target="_blank">deselectTrack</a>取消选择的音视频轨道。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">public</span> <span class="hljs-attr">videoTrackIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 类成员定义avPlayer</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li><span class="hljs-comment">// 切换至目标视频轨道。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">selectTrack</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">videoTrackIndex</span>);</li><li><span class="hljs-comment">// 取消选择目标视频轨道。</span></li><li><span class="hljs-comment">// this.avPlayer.deselectTrack(this.videoTrackIndex);</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="异常场景说明">异常场景说明<i class="anchor-icon anchor-icon-link" anchorid="异常场景说明" tips="复制节点链接"></i></h2>          <p>使用avPlayer播放流媒体过程中断网时，流媒体模块会根据返回的错误码、服务器响应时间和请求次数等因素综合处理。若错误码类型属于不进行请求重试的类型，会向应用上报对应的错误码。如果错误码类型需要进行请求重试，会在30s内进行至多10次的请求重试。如果请求重试次数超过10次，或重试总时长超过30秒，会向应用上报对应的错误码。如果请求重试成功，则继续播放。</p>    </div>    <div class="tiledSection">     <h2 id="运行完整示例">运行完整示例<i class="anchor-icon anchor-icon-link" anchorid="运行完整示例" tips="复制节点链接"></i></h2>          <p>参考以下示例，完整地播放一个流媒体视频。</p>     <ol>      <li>       <p>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVPlayer/AVPlayerArkTSStreamingMedia" target="_blank">示例工程</a>，并将示例工程的以下资源复制到对应目录。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVPlayerArkTSAudio</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (播放界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│       ├── ic_video_play<span class="hljs-selector-class">.svg</span>  (播放键图片资源)</li><li>│       └── ic_video_pause<span class="hljs-selector-class">.svg</span> (暂停键图片资源)</li><li>└── rawfile</li><li>    └── test1<span class="hljs-selector-class">.mp4</span> （视频资源）</li></ol></pre></div></div></li>      <li>       <p>在/entry/src/main/module.json5中，申请使用网络的权限（或直接替换为示例工程的module.json5）。</p>       <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.GET_WIFI_INFO"</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div></li>      <li>       <p>通过注释、解注释/entry/src/main/ets/pages/Index.ets中的上文示例的各种情况，编译并运行。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发示例">开发示例<i class="anchor-icon anchor-icon-link" anchorid="开发示例" tips="复制节点链接"></i></h2>          <div _ngcontent-wxd-c106="" class="highlight-div"><div _ngcontent-wxd-c106="" class="highlight-div-header"><div _ngcontent-wxd-c106="" class="highlight-div-header-left"><div _ngcontent-wxd-c106="" class="handle-button expand-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wxd-c106="" class="highlight-div-header-right"><div _ngcontent-wxd-c106="" class="handle-button ai-button"></div><div _ngcontent-wxd-c106="" class="handle-button line-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wxd-c106="" class="handle-button theme-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wxd-c106="" class="handle-button copy-button"><div _ngcontent-wxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { emitter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TIME_ONE</span> = <span class="hljs-number">60000</span>; <span class="hljs-comment">// 1分钟的毫秒数。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TIME_TWO</span> = <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1秒的毫秒数。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SET_INTERVAL</span> = <span class="hljs-number">1000</span>; <span class="hljs-comment">// 每秒更新一次当前播放时间。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SPEED_ZERO</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 对应1.00x。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SPEED_ONE</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 对应1.25x。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SPEED_TWO</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;  <span class="hljs-comment">// 对应1.75x。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SPEED_THREE</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 对应2.00x。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">PROPORTION</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0.99</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">innerEventFalse</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>  <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">HIGH</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">innerEventTrue</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>  <span class="hljs-attr">eventId</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">HIGH</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">innerEventWH</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>  <span class="hljs-attr">eventId</span>: <span class="hljs-number">3</span>,</li><li>  <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">HIGH</span></li><li>};</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">videoTrackIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">bitrate</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">durationTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">percent</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isSwiping</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">tag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'StreamingMedia'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">speedSelect</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">intervalID</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">windowWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">300</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">windowHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">300</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">surfaceW</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">surfaceH</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isPaused</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-title class_">XComponentFlag</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-title function_">getDurationTime</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">durationTime</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getCurrentTime</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">timeConvert</span>(<span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">min</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(time / <span class="hljs-variable constant_">TIME_ONE</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">second</span>: <span class="hljs-built_in">string</span> = ((time % <span class="hljs-variable constant_">TIME_ONE</span>) / <span class="hljs-variable constant_">TIME_TWO</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// return `${min}:${(+second &lt; TIME_THREE ? '0' : '') + second}`;</span></li><li>    second = second.<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${min}</span>:<span class="hljs-subst">${second}</span>`</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">msleepAsync</span>(<span class="hljs-attr">ms</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>)</li><li>      }, ms)</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">avSetupStreamingMediaVideo</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> == <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;</li><li>    <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>
</li><li>    <span class="hljs-comment">// 创建状态机变化回调函数。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-function">(<span class="hljs-params">avPlayer: media.AVPlayer</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span> = avPlayer.<span class="hljs-property">width</span> / avPlayer.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setVideoWH</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">durationTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDurationTime</span>();</li><li>      <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 更新当前时间。</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSwiping</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCurrentTime</span>();</li><li>        }</li><li>      }, <span class="hljs-variable constant_">SET_INTERVAL</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 情况一：HTTP视频播放。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = <span class="hljs-string">"http://media.iyuns.top:1000/http/720p_1m.mp4"</span>;</li><li>
</li><li>    <span class="hljs-comment">// 情况二：HLS视频播放。</span></li><li>    <span class="hljs-comment">// this.avPlayer.url = "http://media.iyuns.top:1000/720-270-480.m3u8";</span></li><li>
</li><li>    <span class="hljs-comment">// 情况三：DASH视频播放。</span></li><li>    <span class="hljs-comment">// this.avPlayer.url = "http://media.iyuns.top:1000/dash/720p/720-1/720-1.mpd";</span></li><li>
</li><li>    <span class="hljs-comment">// 情况四：通过setMediaSource设置自定义头域及播放优选参数实现初始播放参数设置，以流媒体HTTP点播为例。</span></li><li>    <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">    let mediaSource : media.MediaSource = media.createMediaSourceWithUrl("http://media.iyuns.top:1000/http/720p_1m.mp4", {"":""});</span></li><li><span class="hljs-comment">    // 设置播放策略，设置为缓冲区数据为20s。</span></li><li><span class="hljs-comment">    let playbackStrategy : media.PlaybackStrategy = {preferredBufferDuration: 20};</span></li><li><span class="hljs-comment">    // 为avPlayer设置媒体来源和播放策略。</span></li><li><span class="hljs-comment">    this.avPlayer.setMediaSource(mediaSource, playbackStrategy);</span></li><li><span class="hljs-comment">    * */</span></li><li>
</li><li>    <span class="hljs-comment">// 情况五：HLS切码率。</span></li><li>    <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">    this.avPlayer.url = "https://upftimae.dailyworkout.cn/videos/course/c800f81a209b5ee7891f1128ed301db/4/master.m3u8";</span></li><li><span class="hljs-comment">    let bitrate: number = 0;</span></li><li><span class="hljs-comment">    // 监听当前HLS协议流可用的码率。</span></li><li><span class="hljs-comment">    this.avPlayer.on('availableBitrates', (bitrates: Array&lt;number&gt;) =&gt; {</span></li><li><span class="hljs-comment">      console.info('availableBitrates called, and availableBitrates length is: ' + bitrates.length);</span></li><li><span class="hljs-comment">      this.bitrate = bitrates[0]; // 保存需要切换的码率。</span></li><li><span class="hljs-comment">    })</span></li><li><span class="hljs-comment">    // 监听码率设置是否生效。</span></li><li><span class="hljs-comment">    this.avPlayer.on('bitrateDone', (bitrate: number) =&gt; {</span></li><li><span class="hljs-comment">      console.info('bitrateDone called, and bitrate value is: ' + bitrate);</span></li><li><span class="hljs-comment">    })</span></li><li><span class="hljs-comment">    * */</span></li><li>
</li><li>    <span class="hljs-comment">// 情况六：DASH切换音视频轨道。</span></li><li>    <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">    this.avPlayer.url = "http://poster-inland.hwcloudtest.cn/AiMaxEngine/ProductionEnvVideo/DASH_SDR_MultiAudio_MultiSubtitle_yinHeHuWeiDui3/DASH_SDR_MultiAudio_MultiSubtitle_yinHeHuWeiDui3.mpd";</span></li><li><span class="hljs-comment">    //</span></li><li><span class="hljs-comment">    this.avPlayer.getTrackDescription((error: BusinessError, arrList: Array&lt;media.MediaDescription&gt;) =&gt; {</span></li><li><span class="hljs-comment">      if (arrList != null) {</span></li><li><span class="hljs-comment">        for (let i = 0; i &lt; arrList.length; i++) {</span></li><li><span class="hljs-comment">          let propertyIndex: Object = arrList[i][media.MediaDescriptionKey.MD_KEY_TRACK_INDEX];</span></li><li><span class="hljs-comment">          let propertyType: Object = arrList[i][media.MediaDescriptionKey.MD_KEY_TRACK_TYPE];</span></li><li><span class="hljs-comment">          let propertyWidth: Object = arrList[i][media.MediaDescriptionKey.MD_KEY_WIDTH];</span></li><li><span class="hljs-comment">          let propertyHeight: Object = arrList[i][media.MediaDescriptionKey.MD_KEY_HEIGHT];</span></li><li><span class="hljs-comment">          if (propertyType == media.MediaType.MEDIA_TYPE_VID &amp;&amp; propertyWidth == 1920 &amp;&amp; propertyHeight == 1080) {</span></li><li><span class="hljs-comment">            this.videoTrackIndex = parseInt(propertyIndex.toString()); // 获取1080p视频轨道索引。</span></li><li><span class="hljs-comment">          }</span></li><li><span class="hljs-comment">        }</span></li><li><span class="hljs-comment">      } else {</span></li><li><span class="hljs-comment">        console.error(`getTrackDescription fail, error:${error}`);</span></li><li><span class="hljs-comment">      }</span></li><li><span class="hljs-comment">    });</span></li><li><span class="hljs-comment">    * */</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// HLS切换码率。</span></li><li>  <span class="hljs-title function_">changeBitrate</span>(<span class="hljs-params">bitrate: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 设置播放码率。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setBitrate</span>(bitrate);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setBitrate failed, error message is = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error.message)}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// DASH切换音视频轨道。</span></li><li>  <span class="hljs-title function_">changeTrack</span>(<span class="hljs-params">track: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 切换至目标视频轨道。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">selectTrack</span>(track);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: selectTrack failed, error message is = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error.message)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 取消选择目标视频轨道。</span></li><li>    <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">    try {</span></li><li><span class="hljs-comment">      this.avPlayer.deselectTrack(track);</span></li><li><span class="hljs-comment">    } catch (error) {</span></li><li><span class="hljs-comment">      console.error(`${this.tag}: deselectTrack failed, error message is = ${JSON.stringify(error.message)}`);</span></li><li><span class="hljs-comment">    }</span></li><li><span class="hljs-comment">    * */</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">avPlay</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">play</span>();</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPlay = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">avPause</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">pause</span>();</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPause==`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPause== <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">avSeek</span>(<span class="hljs-attr">seekTime</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">mode</span>: <span class="hljs-title class_">SliderChangeMode</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: videoSeek  seekTime== <span class="hljs-subst">${seekTime}</span>`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">seek</span>(seekTime, <span class="hljs-number">2</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = seekTime;</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: videoSeek== <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">avSetSpeed</span>(<span class="hljs-attr">speed</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setSpeed</span>(speed);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avSetSpeed enum <span class="hljs-subst">${speed}</span>`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avSetSpeed == <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注册avplayer回调函数。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">avPlayer: media.AVPlayer</span>) =&gt;</span> <span class="hljs-built_in">void</span>, vType?: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// seek操作结果回调函数。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPlayer has not init!`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seekDone'</span>, <span class="hljs-function">(<span class="hljs-params">seekDoneTime</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer seek succeeded, seek time is <span class="hljs-subst">${seekDoneTime}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'speedDone'</span>, <span class="hljs-function">(<span class="hljs-params">speed</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer speedDone, speed is <span class="hljs-subst">${speed}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// error回调监听函数,当avPlayer在操作过程中出现错误时调用reset接口触发重置流程。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback Invoke avPlayer failed <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPlayer has not init on error`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">reset</span>();</li><li>    });</li><li>    <span class="hljs-comment">// 状态机变化回调函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (state, reason) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPlayer has not init on state change`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">switch</span> (state) {</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'idle'</span>: <span class="hljs-comment">// 成功调用reset接口后触发该状态机上报。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state idle called.`</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// avplayer 设置播放源后触发该状态上报。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state initialized called.`</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>; <span class="hljs-comment">// 设置显示画面，当播放的资源为纯音频时无需设置。</span></li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback this.avPlayer.surfaceId = <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.avPlayer.surfaceId}</span>`</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">prepare</span>();</li><li>          }</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>: <span class="hljs-comment">// prepare调用成功后上报该状态机。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state prepared called.`</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bufferingUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">infoType: media.BufferingInfoType, value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: bufferingUpdate called, infoType value: <span class="hljs-subst">${infoType}</span>, value:<span class="hljs-subst">${value}</span>}`</span>);</li><li>          })</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">durationTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">duration</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">currentTime</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">play</span>(); <span class="hljs-comment">// 调用播放接口开始播放。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>:</span></li><li><span class="hljs-string">            setAVPlayerCallback speedSelect: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.speedSelect}</span>, duration: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.durationTime}</span>`</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">speedSelect</span> != -<span class="hljs-number">1</span>) {</li><li>            <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">speedSelect</span>) {</li><li>              <span class="hljs-keyword">case</span> <span class="hljs-attr">SPEED_ZERO</span>:</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">avSetSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_00_X</span>);</li><li>                <span class="hljs-keyword">break</span>;</li><li>              <span class="hljs-keyword">case</span> <span class="hljs-attr">SPEED_ONE</span>:</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">avSetSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_25_X</span>);</li><li>                <span class="hljs-keyword">break</span>;</li><li>              <span class="hljs-keyword">case</span> <span class="hljs-attr">SPEED_TWO</span>:</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">avSetSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_75_X</span>);</li><li>                <span class="hljs-keyword">break</span>;</li><li>              <span class="hljs-keyword">case</span> <span class="hljs-attr">SPEED_THREE</span>:</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">avSetSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_2_00_X</span>);</li><li>                <span class="hljs-keyword">break</span>;</li><li>            }</li><li>          }</li><li>          <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'playing'</span>: <span class="hljs-comment">// play成功调用后触发该状态机上报。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state playing called.`</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalID</span> != -<span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalID</span>)</li><li>          }</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalID</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 更新当前时间。</span></li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'durationTime'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">durationTime</span>);</li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentTime'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>);</li><li>          }, <span class="hljs-number">100</span>);</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">eventDataTrue</span>: emitter.<span class="hljs-property">EventData</span> = {</li><li>            <span class="hljs-attr">data</span>: {</li><li>              <span class="hljs-string">'flag'</span>: <span class="hljs-literal">true</span></li><li>            }</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">innerEventTrue</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>            <span class="hljs-attr">eventId</span>: <span class="hljs-number">2</span>,</li><li>            <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">HIGH</span></li><li>          };</li><li>          emitter.<span class="hljs-title function_">emit</span>(innerEventTrue, eventDataTrue);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>: <span class="hljs-comment">// 播放结束后触发该状态机上报。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state completed called.`</span>);</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">eventDataFalse</span>: emitter.<span class="hljs-property">EventData</span> = {</li><li>            <span class="hljs-attr">data</span>: {</li><li>              <span class="hljs-string">'flag'</span>: <span class="hljs-literal">false</span></li><li>            }</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">innerEvent</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>            <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span>,</li><li>            <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">HIGH</span></li><li>          };</li><li>          emitter.<span class="hljs-title function_">emit</span>(innerEvent, eventDataFalse);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalID</span> != -<span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">intervalID</span>)</li><li>          }</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'bufferingUpdate'</span>)</li><li>          <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentTime'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">durationTime</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'released'</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback released called.`</span>);</li><li>          <span class="hljs-keyword">break</span></li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'stopped'</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state stopped called.`</span>);</li><li>          <span class="hljs-keyword">break</span></li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'error'</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state error called.`</span>);</li><li>          <span class="hljs-keyword">break</span></li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'paused'</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state paused called.`</span>);</li><li>          <span class="hljs-keyword">break</span></li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: setAVPlayerCallback AVPlayer state unknown called.`</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    });</li><li>    <span class="hljs-comment">// 时间上报监听函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'timeUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">time: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowWidth</span> = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">width</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowHeight</span> = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">height</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span> &gt;= <span class="hljs-number">1</span>) { <span class="hljs-comment">// 横向视频。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">windowWidth</span> * <span class="hljs-variable constant_">PROPORTION</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span>);</li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 纵向视频。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">windowHeight</span> * <span class="hljs-variable constant_">PROPORTION</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPaused</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: avPlayer has not init aboutToDisappear`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">release</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err == <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: videoRelease release success`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: videoRelease release failed, error message is = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err.message)}</span>`</span>);</li><li>      }</li><li>    });</li><li>    emitter.<span class="hljs-title function_">off</span>(innerEventFalse.<span class="hljs-property">eventId</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">avPause</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPaused</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(<span class="hljs-params"></span>) {</li><li>    emitter.<span class="hljs-title function_">on</span>(innerEventTrue, <span class="hljs-function">(<span class="hljs-params">res: emitter.EventData</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPaused</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">flag</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">XComponentFlag</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">flag</span>;</li><li>      }</li><li>    });</li><li>    emitter.<span class="hljs-title function_">on</span>(innerEventFalse, <span class="hljs-function">(<span class="hljs-params">res: emitter.EventData</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPaused</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">flag</span>;</li><li>      }</li><li>    });</li><li>    emitter.<span class="hljs-title function_">on</span>(innerEventWH, <span class="hljs-function">(<span class="hljs-params">res: emitter.EventData</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowWidth</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">width</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowHeight</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">height</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setVideoWH</span>();</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setVideoWH</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span> &gt;= <span class="hljs-number">1</span>) { <span class="hljs-comment">// 横向视频。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">windowWidth</span> * <span class="hljs-variable constant_">PROPORTION</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span>);</li><li>    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 纵向视频。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">windowHeight</span> * <span class="hljs-variable constant_">PROPORTION</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceW</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceH</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">percent</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">CoverXComponent</span>() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>