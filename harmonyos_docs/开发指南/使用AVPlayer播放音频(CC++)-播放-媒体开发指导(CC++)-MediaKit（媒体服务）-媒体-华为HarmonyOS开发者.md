<h1 _ngcontent-jov-c119="" class="doc-title ng-star-inserted" title="使用AVPlayer播放音频(C/C++)"> 使用AVPlayer播放音频(C/C++) </h1>

<div _ngcontent-jov-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avplayer">AVPlayer</a>可以实现端到端播放原始媒体资源，本开发指导将以完整地播放一首音乐作为示例，向开发者讲解AVPlayer音频播放相关功能。</p>    <p>播放的全流程包含：创建AVPlayer，设置回调监听函数，设置播放资源，设置播放参数（音量/倍速/焦点模式），播放控制（播放/暂停/跳转/停止），重置，销毁播放器实例。</p>    <p>在进行应用开发的过程中，开发者可以通过AVPlayer的信息监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeroninfocallback" target="_blank">OH_AVPlayerOnInfoCallback</a>和错误监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeronerrorcallback" target="_blank">OH_AVPlayerOnErrorCallback</a>主动获取播放过程信息。如果应用在音频播放器处于错误状态时执行操作，系统可能会抛出异常或生成其他未定义的行为。</p>    <p><strong>图1</strong> 播放状态变化示意图</p>    <p><span><img originheight="1108" originwidth="1474" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114444.11943484480010175874439320099915:50001231000000:2800:B84DE43799101357BED26F01CC294B6622FECAAF9A3066FEA8CD30A605098233.png" width="920" height="691.560379918589"></span></p>    <p>状态的详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AVPlayerState</a>。当播放处于prepared / playing / paused / completed状态时，播放引擎处于工作状态，这需要占用系统较多的运行内存。当客户端暂时不使用播放器时，调用reset()或release()回收内存资源，做好资源利用。</p>    <div class="tiledSection">     <h2 id="开发建议">开发建议<i class="anchor-icon anchor-icon-link" anchorid="开发建议" tips="复制节点链接"></i></h2>          <p>当前指导仅介绍如何实现媒体资源播放，在应用开发过程中可能会涉及后台播放、播放冲突等情况，请根据实际需要参考以下说明。</p>     <ul>      <li>如果要实现后台播放或熄屏播放，需要接入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-access-scene">AVSession（媒体会话）</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task">申请长时任务</a>，避免播放被系统强制中断。此功能仅提供ArkTS API。</li>      <li>应用在播放过程中，若播放的媒体数据涉及音频，根据系统音频管理策略（参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency">处理音频焦点事件</a>），可能会被其他应用打断，建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>主动监听音频打断事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayeroninfotype" target="_blank">AV_INFO_TYPE_INTERRUPT_EVENT</a>，根据其内容提示，做出相应的处理，避免出现应用状态与预期效果不一致的问题。</li>      <li>面对设备同时连接多个音频输出设备的情况，建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>主动监听音频输出设备改变事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayeroninfotype" target="_blank">AV_INFO_TYPE_AUDIO_OUTPUT_DEVICE_CHANGE</a>，从而做出相应处理。</li>      <li>应用在播放过程中，系统内部可能异常，如网络数据下载失败、媒体服务死亡不可用等，建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setonerrorcallback" target="_blank">OH_AVPlayer_SetOnErrorCallback()</a>接口设置错误监听回调函数，根据不同错误类型，做出相应处理，避免出现播放异常。</li>      <li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setonerrorcallback" target="_blank">OH_AVPlayer_SetOnErrorCallback()</a>接口分别设置信息监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeroninfocallback" target="_blank">OH_AVPlayerOnInfoCallback</a>和错误监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeronerrorcallback" target="_blank">OH_AVPlayerOnErrorCallback</a>。当应用成功设置信息监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeroninfocallback" target="_blank">OH_AVPlayerOnInfoCallback</a>后，不再执行通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setplayercallback" target="_blank">OH_AVPlayer_SetPlayerCallback()</a>设置的信息监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeroninfo" target="_blank">OH_AVPlayerOnInfo</a>；当应用成功设置错误监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeronerrorcallback" target="_blank">OH_AVPlayerOnErrorCallback</a>后，不再执行通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setplayercallback" target="_blank">OH_AVPlayer_SetPlayerCallback()</a>设置的错误监听回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#oh_avplayeronerror" target="_blank">OH_AVPlayerOnError</a>。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>在 CMake 脚本中链接动态库：</p>     <div _ngcontent-jov-c106="" class="highlight-div"><div _ngcontent-jov-c106="" class="highlight-div-header"><div _ngcontent-jov-c106="" class="highlight-div-header-left"><div _ngcontent-jov-c106="" class="handle-button expand-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jov-c106="" class="highlight-div-header-right"><div _ngcontent-jov-c106="" class="handle-button ai-button"></div><div _ngcontent-jov-c106="" class="handle-button line-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jov-c106="" class="handle-button theme-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jov-c106="" class="handle-button copy-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jov-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libavplayer.so)</li></ol></pre></div></div>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setonerrorcallback" target="_blank">OH_AVPlayer_SetOnErrorCallback()</a>接口设置信息监听回调函数和错误监听回调函数，需要在 CMake 脚本中链接如下动态库：</p>     <div _ngcontent-jov-c106="" class="highlight-div"><div _ngcontent-jov-c106="" class="highlight-div-header"><div _ngcontent-jov-c106="" class="highlight-div-header-left"><div _ngcontent-jov-c106="" class="handle-button expand-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jov-c106="" class="highlight-div-header-right"><div _ngcontent-jov-c106="" class="handle-button ai-button"></div><div _ngcontent-jov-c106="" class="handle-button line-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jov-c106="" class="handle-button theme-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jov-c106="" class="handle-button copy-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jov-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div>     <p>开发者使用系统日志能力时，需引入如下头文件：</p>     <div _ngcontent-jov-c106="" class="highlight-div"><div _ngcontent-jov-c106="" class="highlight-div-header"><div _ngcontent-jov-c106="" class="highlight-div-header-left"><div _ngcontent-jov-c106="" class="handle-button expand-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jov-c106="" class="highlight-div-header-right"><div _ngcontent-jov-c106="" class="handle-button ai-button"></div><div _ngcontent-jov-c106="" class="handle-button line-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jov-c106="" class="handle-button theme-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jov-c106="" class="handle-button copy-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jov-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li></ol></pre></div></div>     <p>并需要在 CMake 脚本中链接如下动态库:</p>     <div _ngcontent-jov-c106="" class="highlight-div"><div _ngcontent-jov-c106="" class="highlight-div-header"><div _ngcontent-jov-c106="" class="highlight-div-header-left"><div _ngcontent-jov-c106="" class="handle-button expand-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jov-c106="" class="highlight-div-header-right"><div _ngcontent-jov-c106="" class="handle-button ai-button"></div><div _ngcontent-jov-c106="" class="handle-button line-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jov-c106="" class="handle-button theme-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jov-c106="" class="handle-button copy-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jov-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libhilog_ndk.z.so)</li></ol></pre></div></div>     <p>开发者通过引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h" target="_blank">avplayer.h</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h" target="_blank">avplayer_base.h</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-averrors-h" target="_blank">native_averrors.h</a>头文件，使用音频播放相关API。</p>     <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer" target="_blank">AVPlayer API</a>。</p>     <ol>      <li>       <p>创建AVPlayer实例：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_create" target="_blank">OH_AVPlayer_Create()</a>，AVPlayer初始化为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AV_IDLE</a>状态。</p></li>      <li>       <p>设置回调监听函数：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setonerrorcallback" target="_blank">OH_AVPlayer_SetOnErrorCallback()</a>接口设置信息监听回调函数和错误监听回调函数，搭配全流程场景使用。支持的监听事件包括：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.12.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.12.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVPlayerOnInfoCallback</td>           <td class="cellrowborder" valign="top" width="50%">            <p>必要事件，监听播放器的过程信息。</p>            <p>需要播放器在AV_IDLE状态下、未调用设置资源接口前完成设置监听，若在调用设置资源接口后再设置监听，可能导致无法收到资源设置过程中上报的OH_AVPlayerOnInfoCallback事件。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVPlayerOnErrorCallback</td>           <td class="cellrowborder" valign="top" width="50%">            <p>必要事件，监听播放器的错误信息。</p>            <p>需要播放器在AV_IDLE状态下、未调用设置资源接口前完成设置监听，若在调用设置资源接口后再设置监听，可能导致无法收到资源设置过程中上报的OH_AVPlayerOnErrorCallback事件。</p></td>          </tr>                 </tbody></table></div>       </div>       <p>应用使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setoninfocallback" target="_blank">OH_AVPlayer_SetOnInfoCallback()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setonerrorcallback" target="_blank">OH_AVPlayer_SetOnErrorCallback()</a>接口设置信息监听回调函数和错误监听回调函数，可以获取更多信息，还可以通过设置 userData 区分不同播放实例。</p></li>      <li>       <p>设置资源：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_seturlsource" target="_blank">OH_AVPlayer_SetURLSource()</a>，设置属性url，AVPlayer进入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AV_INITIALIZED</a>状态。</p></li>      <li>       <p>（可选）设置音频流类型：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setaudiorendererinfo" target="_blank">OH_AVPlayer_SetAudioRendererInfo()</a>，设置AVPlayer音频流类型。</p></li>      <li>       <p>（可选）设置音频打断模式：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setaudiointerruptmode" target="_blank">OH_AVPlayer_SetAudioInterruptMode()</a>，设置AVPlayer音频流打断模式。</p></li>      <li>       <p>准备播放：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_prepare" target="_blank">OH_AVPlayer_Prepare()</a>，AVPlayer进入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AV_PREPARED</a>状态，此时可以获取时长，设置音量。</p></li>      <li>       <p>（可选）设置音频音效模式：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_setaudioeffectmode" target="_blank">OH_AVPlayer_SetAudioEffectMode()</a>，设置AVPlayer音频音效模式。</p></li>      <li>       <p>音频播控：播放<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_play" target="_blank">OH_AVPlayer_Play()</a>，暂停<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_pause" target="_blank">OH_AVPlayer_Pause()</a>，跳转<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_seek" target="_blank">OH_AVPlayer_Seek()</a>，停止<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_stop" target="_blank">OH_AVPlayer_Stop()</a>等操作。</p></li>      <li>       <p>（可选）更换资源：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_reset" target="_blank">OH_AVPlayer_Reset()</a>重置资源，AVPlayer重新进入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AV_IDLE</a>状态，允许更换资源url。</p></li>      <li>       <p>退出播放：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-h#oh_avplayer_release" target="_blank">OH_AVPlayer_Release()</a>销毁实例，AVPlayer进入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avplayer-base-h#avplayerstate" target="_blank">AV_RELEASED</a>状态，退出播放。之后再操作AVPlayer实例则行为未知，可能导致应用进程崩溃，应用闪退。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="运行完整示例">运行完整示例<i class="anchor-icon anchor-icon-link" anchorid="运行完整示例" tips="复制节点链接"></i></h2>          <ol>      <li>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVPlayer/AVPlayerNDKAudio" target="_blank">示例工程</a>，并将示例工程的以下资源复制到对应目录。       <div _ngcontent-jov-c106="" class="highlight-div"><div _ngcontent-jov-c106="" class="highlight-div-header"><div _ngcontent-jov-c106="" class="highlight-div-header-left"><div _ngcontent-jov-c106="" class="handle-button expand-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jov-c106="" class="highlight-div-header-right"><div _ngcontent-jov-c106="" class="handle-button ai-button"></div><div _ngcontent-jov-c106="" class="handle-button line-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jov-c106="" class="handle-button theme-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jov-c106="" class="handle-button copy-button"><div _ngcontent-jov-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jov-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVPlayerNDKAudio</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (播放界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/</li><li>├── cpp</li><li>│   ├── types</li><li>│   │   └── libentry</li><li>│   │       └── Index<span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.ts</span> (NDK函数对应的js映射)</li><li>│   ├── CMakeLists<span class="hljs-selector-class">.txt</span> (CMake脚本)</li><li>│   └── napi_init<span class="hljs-selector-class">.cpp</span>  (NDK函数)</li><li>└── resources</li><li>    ├── base</li><li>    │   ├── element</li><li>    │   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>    │   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>    │   │   └── string<span class="hljs-selector-class">.json</span></li><li>    │   └── media</li><li>    │       ├── ic_video_play<span class="hljs-selector-class">.svg</span>  (播放键图片资源)</li><li>    │       └── ic_video_pause<span class="hljs-selector-class">.svg</span> (暂停键图片资源)</li><li>    └── rawfile</li><li>        └── test_01<span class="hljs-selector-class">.mp3</span> （音频资源）</li></ol></pre></div></div></li>      <li>编译新建工程并运行。</li>     </ol>    </div>   </div>   <div></div></div>