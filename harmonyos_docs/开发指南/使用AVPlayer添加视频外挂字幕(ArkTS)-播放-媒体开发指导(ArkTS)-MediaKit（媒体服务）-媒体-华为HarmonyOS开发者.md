<h1 _ngcontent-lcm-c119="" class="doc-title ng-star-inserted" title="使用AVPlayer添加视频外挂字幕(ArkTS)"> 使用AVPlayer添加视频外挂字幕(ArkTS) </h1>

<div _ngcontent-lcm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当前仅支持视频播放前设置外挂字幕。</p>    <p>在进行应用开发的过程中，开发者可以通过AVPlayer的实例注册on('subtitleUpdate')方法监听字幕信息。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a></p>     <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#addsubtitlefromfd12" target="_blank">addSubtitleFromFd</a>，使用视频播放的AVPlayer实例设置外挂字幕资源。</p>       <div _ngcontent-lcm-c106="" class="highlight-div"><div _ngcontent-lcm-c106="" class="highlight-div-header"><div _ngcontent-lcm-c106="" class="highlight-div-header-left"><div _ngcontent-lcm-c106="" class="handle-button expand-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcm-c106="" class="highlight-div-header-right"><div _ngcontent-lcm-c106="" class="handle-button ai-button"></div><div _ngcontent-lcm-c106="" class="handle-button line-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcm-c106="" class="handle-button theme-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcm-c106="" class="handle-button copy-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer和context。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> </li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupVideoAndSubtitle）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-comment">// 设定视频源（此处省略）。</span></li><li>
</li><li> <span class="hljs-comment">// 设定字幕。</span></li><li> <span class="hljs-keyword">let</span> fileDescriptorSub = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'xxx.srt'</span>);</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">addSubtitleFromFd</span>(fileDescriptorSub.<span class="hljs-property">fd</span>, fileDescriptorSub.<span class="hljs-property">offset</span>, fileDescriptorSub.<span class="hljs-property">length</span>);</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onsubtitleupdate12" target="_blank">on('subtitleUpdate')</a>接口，注册字幕回调函数。</p>       <div _ngcontent-lcm-c106="" class="highlight-div"><div _ngcontent-lcm-c106="" class="highlight-div-header"><div _ngcontent-lcm-c106="" class="highlight-div-header-left"><div _ngcontent-lcm-c106="" class="handle-button expand-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcm-c106="" class="highlight-div-header-right"><div _ngcontent-lcm-c106="" class="handle-button ai-button"></div><div _ngcontent-lcm-c106="" class="handle-button line-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcm-c106="" class="handle-button theme-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcm-c106="" class="handle-button copy-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义用来显示的字幕字符串。</span></li><li> <span class="hljs-meta">@State</span> <span class="hljs-attr">subtitle</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'subtitleUpdate info'</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">tag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-comment">// 字幕回调函数。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'subtitleUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">info: media.SubtitleInfo</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (!!info) {</li><li>     <span class="hljs-keyword">let</span> text = (!info.<span class="hljs-property">text</span>) ? <span class="hljs-string">''</span> : info.<span class="hljs-property">text</span>;</li><li>     <span class="hljs-keyword">let</span> startTime = (!info.<span class="hljs-property">startTime</span>) ? <span class="hljs-number">0</span> : info.<span class="hljs-property">startTime</span>;</li><li>     <span class="hljs-keyword">let</span> duration = (!info.<span class="hljs-property">duration</span>) ? <span class="hljs-number">0</span> : info.<span class="hljs-property">duration</span>;</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: text=<span class="hljs-subst">${text}</span> startTime=<span class="hljs-subst">${startTime}</span> duration=<span class="hljs-subst">${duration}</span>`</span>);</li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">subtitle</span> = text;</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tag}</span>: subtitleUpdate info is null`</span>);</li><li>   }</li><li> });</li></ol></pre></div></div></li>      <li>       <p>(可选)当需要不显示字幕的时候，使用视频播放的AVPlayer实例注销字幕回调函数。</p>       <div _ngcontent-lcm-c106="" class="highlight-div"><div _ngcontent-lcm-c106="" class="highlight-div-header"><div _ngcontent-lcm-c106="" class="highlight-div-header-left"><div _ngcontent-lcm-c106="" class="handle-button expand-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcm-c106="" class="highlight-div-header-right"><div _ngcontent-lcm-c106="" class="handle-button ai-button"></div><div _ngcontent-lcm-c106="" class="handle-button line-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcm-c106="" class="handle-button theme-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcm-c106="" class="handle-button copy-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer和context。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'subtitleUpdate'</span>);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="运行完整示例">运行完整示例<i class="anchor-icon anchor-icon-link" anchorid="运行完整示例" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVPlayer/AVPlayerArkTSSubtitle" target="_blank">示例工程</a>，并将示例工程的以下资源复制到对应目录。</p>       <div _ngcontent-lcm-c106="" class="highlight-div"><div _ngcontent-lcm-c106="" class="highlight-div-header"><div _ngcontent-lcm-c106="" class="highlight-div-header-left"><div _ngcontent-lcm-c106="" class="handle-button expand-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcm-c106="" class="highlight-div-header-right"><div _ngcontent-lcm-c106="" class="handle-button ai-button"></div><div _ngcontent-lcm-c106="" class="handle-button line-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcm-c106="" class="handle-button theme-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcm-c106="" class="handle-button copy-button"><div _ngcontent-lcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVPlayerArkTSSubtitle</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (播放界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│       ├── ic_video_play<span class="hljs-selector-class">.svg</span>  (播放键图片资源)</li><li>│       └── ic_video_pause<span class="hljs-selector-class">.svg</span> (暂停键图片资源)</li><li>└── rawfile</li><li>    ├── test1<span class="hljs-selector-class">.mp4</span> （视频资源）</li><li>    └── test1<span class="hljs-selector-class">.srt</span> （字幕资源）</li></ol></pre></div></div></li>      <li>       <p>编译新建工程并运行。</p></li>     </ol>    </div>   </div>   <div></div></div>