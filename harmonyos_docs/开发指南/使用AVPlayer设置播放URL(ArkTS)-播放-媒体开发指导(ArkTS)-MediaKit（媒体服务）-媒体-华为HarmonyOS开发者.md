<h1 _ngcontent-ltq-c119="" class="doc-title ng-star-inserted" title="使用AVPlayer设置播放URL(ArkTS)"> 使用AVPlayer设置播放URL(ArkTS) </h1>

<div _ngcontent-ltq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本开发指导将介绍如何使用AVPlayer开发播放功能，在不同的场景下如何设置URL。</p>    <p>当前指导仅介绍播放URL设置方法，其他场景及完整示例代码，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback">视频播放</a>。</p>    <p>当前开发指导将提供以下设置播放URL的方法：</p>    <ul>     <li><a href="/consumer/cn/doc/harmonyos-guides/playback-url-setting-method#流媒体播放场景下设置url">流媒体播放场景下设置URL</a></li>     <li><a href="/consumer/cn/doc/harmonyos-guides/playback-url-setting-method#本地raw文件播放场景下设置url">本地Raw文件播放场景下设置URL</a></li>    </ul>    <div class="tiledSection">     <h2 id="流媒体播放场景下设置url">流媒体播放场景下设置URL<i class="anchor-icon anchor-icon-link" anchorid="流媒体播放场景下设置url" tips="复制节点链接"></i></h2>          <p><strong>情况一：播放HTTP/HTTPS媒体资源</strong></p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>
</li><li> <span class="hljs-comment">// 设置对应的播放url。</span></li><li> <span class="hljs-keyword">let</span> url = <span class="hljs-string">'https://xxx.xxx.xxx.mp4'</span>;</li><li> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li> }</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = url;</li></ol></pre></div></div>     <p><strong>情况二：HLS媒体资源播放(点播/直播)</strong></p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>
</li><li> <span class="hljs-comment">// 设置对应的播放url。</span></li><li> <span class="hljs-keyword">let</span> url = <span class="hljs-string">'https://xxx.xxx.xxx.xxx:xx/xx/index.m3u8'</span>;</li><li> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> == <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li> }</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = url;</li></ol></pre></div></div>     <p><strong>情况三：设置HTTP请求头信息播放</strong></p>     <p>当服务器需要校验HTTP请求头信息时，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreatemediasourcewithurl12" target="_blank">createMediaSourceWithUrl</a>设置HTTP请求头信息。</p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>
</li><li> <span class="hljs-comment">// 设置对应的播放url。</span></li><li> <span class="hljs-keyword">let</span> url = <span class="hljs-string">'https://xxx.xxx.xxx.xxx:xx/xx/index.m3u8'</span>;</li><li> <span class="hljs-comment">// 创建mediaSource实例对象，设置媒体来源，定制HTTP请求，如需要，可以键值对的形式设置User-Agent、Cookie、Referer等字段。</span></li><li> <span class="hljs-keyword">let</span> mediaSource : media.<span class="hljs-property">MediaSource</span> = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(url,</li><li>   {<span class="hljs-string">"User-Agent"</span> : <span class="hljs-string">"User-Agent-Value"</span>, <span class="hljs-string">"Cookie"</span> : <span class="hljs-string">"Cookie-Value"</span>, <span class="hljs-string">"Referer"</span> : <span class="hljs-string">"Referer-Value"</span>});</li><li> <span class="hljs-comment">// 设置播放策略，设置缓冲区数据量为3s。</span></li><li> <span class="hljs-keyword">let</span> playbackStrategy : media.<span class="hljs-property">PlaybackStrategy</span> =</li><li>   {<span class="hljs-attr">preferredWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">preferredHeight</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">preferredHdr</span>: <span class="hljs-literal">false</span>};</li><li> <span class="hljs-comment">// 为avPlayer设置媒体来源和播放策略。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li></ol></pre></div></div>     <p><strong>情况四：通过本地Raw文件中的m3u8文件播放在线流媒体资源</strong></p>     <p>当应用需要通过解析本地Raw文件中的m3u8文件，播放在线流媒体资源时，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfd9" target="_blank">resourceManager.getRawFd</a>获取文件描述符，将其拼接成fdUrl，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-mediasource#setmimetype12" target="_blank">setMimeType</a>设置MIME类型为APPLICATION_M3U8。</p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer和context。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-comment">// 通过本地m3u8文件名，获取文件描述符。</span></li><li> <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'xxx.m3u8'</span>);</li><li> <span class="hljs-comment">// 用文件描述符构造本地m3u8的URL。</span></li><li> <span class="hljs-keyword">let</span> fdUrl : <span class="hljs-built_in">string</span> = <span class="hljs-string">"fd://"</span> + fileDescriptor.<span class="hljs-property">fd</span> +</li><li>   <span class="hljs-string">"?offset="</span> + fileDescriptor.<span class="hljs-property">offset</span> + <span class="hljs-string">"&amp;size="</span> + fileDescriptor.<span class="hljs-property">length</span>;</li><li> <span class="hljs-comment">// 按需设置HTTP请求头。</span></li><li> <span class="hljs-keyword">let</span> headers : <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">string</span>&gt; = {<span class="hljs-string">"User-Agent"</span> : <span class="hljs-string">"User-Agent-Value"</span>, <span class="hljs-string">"Cookie"</span> : <span class="hljs-string">"Cookie-Value"</span>};</li><li> <span class="hljs-comment">// 通过本地m3u8的URL和HTTP请求头构造mediaSource媒体来源。</span></li><li> <span class="hljs-keyword">let</span> mediaSource : media.<span class="hljs-property">MediaSource</span> = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(fdUrl, headers);</li><li>
</li><li> <span class="hljs-comment">// 设置媒体MIME类型为APPLICATION_M3U8。</span></li><li> <span class="hljs-keyword">let</span> mimeType : media.<span class="hljs-property">AVMimeTypes</span> = media.<span class="hljs-property">AVMimeTypes</span>.<span class="hljs-property">APPLICATION_M3U8</span>;</li><li> mediaSource?.<span class="hljs-title function_">setMimeType</span>(mimeType);</li><li>
</li><li> <span class="hljs-comment">// 设置播放策略，设置缓冲区数据量为20s。</span></li><li> <span class="hljs-keyword">let</span> playbackStrategy : media.<span class="hljs-property">PlaybackStrategy</span> = {<span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">20</span>};</li><li> <span class="hljs-comment">// 为avPlayer设置媒体来源和播放策略。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li></ol></pre></div></div>     <p><strong>情况五：通过应用沙箱中的m3u8文件播放在线流媒体资源</strong></p>     <p>当应用需要通过解析应用沙箱中的m3u8文件，播放在线流媒体资源时，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#fsopensync" target="_blank">fs.openSync</a>获取文件句柄，将其拼接成fdUrl，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-mediasource#setmimetype12" target="_blank">setMimeType</a>设置MIME类型为APPLICATION_M3U8。</p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer和context。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">m3u8FileName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-comment">// 通过UIAbilityContext获取沙箱地址filesDir，以Stage模型为例。</span></li><li> <span class="hljs-keyword">let</span> m3u8FileName = <span class="hljs-string">''</span>;</li><li> <span class="hljs-keyword">let</span> filePath = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.context.filesDir}</span>/<span class="hljs-subst">${m3u8FileName}</span>`</span>;</li><li> <span class="hljs-comment">// 通过fs.openSync获取文件句柄。</span></li><li> <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li> <span class="hljs-keyword">let</span> fd : <span class="hljs-built_in">string</span> = file.<span class="hljs-property">fd</span>.<span class="hljs-title function_">toString</span>();</li><li> <span class="hljs-comment">// 用文件句柄构造本地m3u8的URL。</span></li><li> <span class="hljs-keyword">let</span> fdUrl : <span class="hljs-built_in">string</span> = <span class="hljs-string">"fd://"</span> + fd + <span class="hljs-string">"?offset="</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"&amp;size="</span> + <span class="hljs-string">"0"</span>;</li><li>
</li><li> <span class="hljs-comment">// 按需设置HTTP请求头。</span></li><li> <span class="hljs-keyword">let</span> headers : <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">string</span>&gt; = {<span class="hljs-string">"User-Agent"</span> : <span class="hljs-string">"User-Agent-Value"</span>, <span class="hljs-string">"Cookie"</span> : <span class="hljs-string">"Cookie-Value"</span>};</li><li> <span class="hljs-comment">// 通过本地m3u8的URL和HTTP请求头构造mediaSource媒体来源。</span></li><li> <span class="hljs-keyword">let</span> mediaSource : media.<span class="hljs-property">MediaSource</span> = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(fdUrl, headers);</li><li>
</li><li> <span class="hljs-comment">// 设置媒体MIME类型为APPLICATION_M3U8。</span></li><li> <span class="hljs-keyword">let</span> mimeType : media.<span class="hljs-property">AVMimeTypes</span> = media.<span class="hljs-property">AVMimeTypes</span>.<span class="hljs-property">APPLICATION_M3U8</span>;</li><li> mediaSource?.<span class="hljs-title function_">setMimeType</span>(mimeType);</li><li>
</li><li> <span class="hljs-comment">// 设置播放策略，设置缓冲区数据量为20s。</span></li><li> <span class="hljs-keyword">let</span> playbackStrategy : media.<span class="hljs-property">PlaybackStrategy</span> = {<span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">20</span>};</li><li> <span class="hljs-comment">// 为avPlayer设置媒体来源和播放策略。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="本地raw文件播放场景下设置url">本地raw文件播放场景下设置URL<i class="anchor-icon anchor-icon-link" anchorid="本地raw文件播放场景下设置url" tips="复制节点链接"></i></h2>          <p><strong>情况一：应用沙箱文件播放</strong></p>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer，context和fileName。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-keyword">let</span> fdPath = <span class="hljs-string">'fd://'</span>;</li><li> <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">'test.mp4'</span>; <span class="hljs-comment">// test.mp4为应用文件目录下的预置资源，需要开发者根据实际情况进行替换。</span></li><li> <span class="hljs-comment">// 通过UIAbilityContext获取沙箱地址filesDir，以Stage模型为例。</span></li><li> <span class="hljs-keyword">let</span> path = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.context?.filesDir}</span>/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.fileName}</span>`</span>;</li><li> <span class="hljs-comment">// 打开相应的资源文件地址获取fd，并为url赋值触发initialized状态机上报。</span></li><li> <span class="hljs-keyword">let</span> file = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">open</span>(path);</li><li> fdPath = fdPath + <span class="hljs-string">''</span> + file.<span class="hljs-property">fd</span>;</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = fdPath;</li></ol></pre></div></div>     <p><strong>情况二：本地文件播放</strong></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>当使用AVPlayer播放本地资源时，AVPlayer会独占此fd。</p>      </div></div></div>     <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-comment">// 类成员定义avPlayer，context和fileName。</span></li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-comment">// 在业务函数中（示例工程函数名为avSetupURL）：</span></li><li> <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-comment">// 通过UIAbilityContext的resourceManager成员的getRawFd接口获取媒体资源播放地址。</span></li><li> <span class="hljs-comment">// 返回类型为{fd,offset,length},fd为HAP包fd地址，offset为媒体资源偏移量，length为播放长度。</span></li><li> <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">'test.mp4'</span>; <span class="hljs-comment">// test.mp4为应用文件目录下的预置资源，需要开发者根据实际情况进行替换。</span></li><li> <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span>);</li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">avFileDescriptor</span>: media.<span class="hljs-property">AVFileDescriptor</span> =</li><li>  { <span class="hljs-attr">fd</span>: fileDescriptor.<span class="hljs-property">fd</span>, <span class="hljs-attr">offset</span>: fileDescriptor.<span class="hljs-property">offset</span>, <span class="hljs-attr">length</span>: fileDescriptor.<span class="hljs-property">length</span> };</li><li> <span class="hljs-comment">// 为fdSrc赋值触发initialized状态机上报。</span></li><li> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">fdSrc</span> = avFileDescriptor;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="运行完整示例">运行完整示例<i class="anchor-icon anchor-icon-link" anchorid="运行完整示例" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVPlayer/AVPlayerArkTSURL" target="_blank">示例工程</a>（也可直接运行），并将示例工程的以下资源复制到对应目录。</p>       <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVPlayerArkTSURL</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>    └── Index<span class="hljs-selector-class">.ets</span> (播放界面)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│       ├── ic_video_play<span class="hljs-selector-class">.svg</span>  (播放键图片资源)</li><li>│       └── ic_video_pause<span class="hljs-selector-class">.svg</span> (暂停键图片资源)</li><li>└── rawfile</li><li>    ├── test<span class="hljs-selector-class">.m3u8</span>    (m3u8资源)</li><li>    └── test_01<span class="hljs-selector-class">.mp3</span> （音频资源）</li></ol></pre></div></div></li>      <li>       <p>在/entry/src/main/module.json5中，申请使用网络的权限（或直接替换为示例工程的module.json5）。</p>       <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.GET_WIFI_INFO"</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div></li>      <li>       <p>通过注释、解注释/entry/src/main/ets/pages/Index.ets中的上文示例的各种情况，编译并运行。</p></li>      <li>       <p>在安装应用后，可将示例工程的/entry/src/main/resources/rawfile/test.m3u8通过以下命令加入应用沙箱，从而运行应用沙箱相关示例:（&lt;FILESDIR&gt;为物理路径，以示例工程为例，可通过console.info打印"this.context.filesDir"得到应用沙箱路径，再根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory">应用沙箱指南</a>的应用沙箱路径和真实物理路径的对应关系表找到物理路径）。</p>       <div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>hdc file <span class="hljs-keyword">send</span> <span class="hljs-string">"[目录]\test.m3u8"</span> &lt;FILESDIR&gt;</li><li>hdc file <span class="hljs-keyword">send</span> <span class="hljs-string">"[目录]\test_01.mp3"</span> &lt;FILESDIR&gt;</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>