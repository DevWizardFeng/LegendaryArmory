<h1 _ngcontent-doh-c119="" class="doc-title ng-star-inserted" title="使用AVRecorder录制视频(ArkTS)"> 使用AVRecorder录制视频(ArkTS) </h1>

<div _ngcontent-doh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当前仅支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avrecorder">AVRecorder</a>开发视频录制，集成了音频捕获，音频编码，视频编码，音视频封装功能，适用于实现简单视频录制并直接得到视频本地文件的场景。</p>    <p>本开发指导将以“开始录制-暂停录制-恢复录制-停止录制”的一次流程为示例，向开发者讲解如何使用AVRecorder进行视频录制。</p>    <p>在进行应用开发的过程中，开发者可以通过AVRecorder的state属性主动获取当前状态，或使用on('stateChange')方法监听状态变化。开发过程中应该严格遵循状态机要求，例如只能在started状态下调用pause()接口，只能在paused状态下调用resume()接口。</p>    <p><strong>图1</strong> 录制状态变化示意图</p>    <p><span><img originheight="783" originwidth="1335" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114447.69215214710127522355611385753002:50001231000000:2800:4644FF38D123C08344AA24D9E3F7B034B3D10A1786D7D8BEE870887557B365FF.png" width="920" height="539.5955056179776"></span></p>    <p>状态的详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avrecorderstate9" target="_blank">AVRecorderState</a>。</p>    <div class="tiledSection">     <h2 id="申请权限">申请权限<i class="anchor-icon anchor-icon-link" anchorid="申请权限" tips="复制节点链接"></i></h2>          <p>在开发此功能前，开发者应根据实际需求申请相关权限：</p>     <ul>      <li>当需要使用麦克风时，需要申请<strong>ohos.permission.MICROPHONE</strong>麦克风权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要使用相机拍摄时，需要申请<strong>ohos.permission.CAMERA</strong>相机权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要从图库读取图片或视频文件时，请优先使用媒体库<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-photoviewpicker">Picker选择媒体资源</a>。</li>      <li>当需要保存图片或视频文件至图库时，请优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">安全控件保存媒体资源</a>。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>仅应用需要克隆、备份或同步用户公共目录的图片、视频类文件时，可申请ohos.permission.READ_IMAGEVIDEO、ohos.permission.WRITE_IMAGEVIDEO权限来读写音频文件，申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请受控权限</a>，通过AGC审核后才能使用。为避免应用的上架申请被驳回，开发者应优先使用Picker/控件等替代方案，仅少量符合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_imagevideo">特殊场景</a>的应用被允许申请受限权限。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>AVRecorder只负责视频数据的处理，需要与视频数据采集模块配合才能完成视频录制。视频数据采集模块需要通过Surface将视频数据传递给AVRecorder进行数据处理。当前主流的数据采集模块为相机模块，详细实现请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording">相机-录像</a>。</p>       <p>关于文件的创建与存储操作，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问与管理</a>，默认存储在应用的沙箱路径之下，如需存储至图库，请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">安全控件保存媒体资源</a>对沙箱内文件进行存储。</p>      </div></div></div>     <p>AVRecorder详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder" target="_blank">AVRecorder API参考</a>。</p>     <ol>      <li>       <p>创建AVRecorder实例，实例创建完成进入idle状态。</p>       <div _ngcontent-doh-c106="" class="highlight-div"><div _ngcontent-doh-c106="" class="highlight-div-header"><div _ngcontent-doh-c106="" class="highlight-div-header-left"><div _ngcontent-doh-c106="" class="handle-button expand-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-doh-c106="" class="highlight-div-header-right"><div _ngcontent-doh-c106="" class="handle-button ai-button"></div><div _ngcontent-doh-c106="" class="handle-button line-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-doh-c106="" class="handle-button theme-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-doh-c106="" class="handle-button copy-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-doh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avRecorder</span>: media.<span class="hljs-property">AVRecorder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置业务需要的监听事件，监听状态变化及错误上报。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.4.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.4.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">stateChange</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听播放器的state属性改变。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">error</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听播放器的错误信息。</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-doh-c106="" class="highlight-div"><div _ngcontent-doh-c106="" class="highlight-div-header"><div _ngcontent-doh-c106="" class="highlight-div-header-left"><div _ngcontent-doh-c106="" class="handle-button expand-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-doh-c106="" class="highlight-div-header-right"><div _ngcontent-doh-c106="" class="handle-button ai-button"></div><div _ngcontent-doh-c106="" class="handle-button line-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-doh-c106="" class="handle-button theme-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-doh-c106="" class="handle-button copy-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-doh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 状态上报回调函数。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: media.AVRecorderState, reason: media.StateChangeReason</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVRecorder state is changed to <span class="hljs-subst">${state}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>});</li><li><span class="hljs-comment">// 错误上报回调函数。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error occurred in avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>配置视频录制参数，调用prepare()接口，此时进入prepared状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>配置参数需要注意：</p>         <ul>          <li>           <p>配置参数之前需要确保完成对应权限的申请，请参考<a href="/consumer/cn/doc/harmonyos-guides/video-recording#申请权限">申请权限</a>。</p></li>          <li>           <p>prepare接口的入参avConfig中仅设置视频相关的配置参数，如示例代码所示。</p>           <p>如果添加了音频参数，系统将认为是“音频+视频录制”。</p></li>          <li>           <p>需要使用支持的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#支持的格式">录制规格</a>，视频比特率、分辨率、帧率以实际硬件设备支持的范围为准。</p></li>          <li>           <p>录制输出的url地址（即示例里avConfig中的url），形式为fd://xx (fd number)。需要调用基础文件操作接口（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">Core File Kit的ohos.file.fs</a>）实现应用文件访问能力，获取方式参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问与管理</a>。</p></li>         </ul>        </div></div></div>       <div _ngcontent-doh-c106="" class="highlight-div"><div _ngcontent-doh-c106="" class="highlight-div-header"><div _ngcontent-doh-c106="" class="highlight-div-header-left"><div _ngcontent-doh-c106="" class="handle-button expand-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-doh-c106="" class="highlight-div-header-right"><div _ngcontent-doh-c106="" class="handle-button ai-button"></div><div _ngcontent-doh-c106="" class="handle-button line-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-doh-c106="" class="handle-button theme-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-doh-c106="" class="handle-button copy-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-doh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>  <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 视频文件封装格式，只支持MP4。</span></li><li>  <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">200000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>  <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频文件编码格式，支持avc格式。</span></li><li>  <span class="hljs-attr">videoFrameWidth</span>: <span class="hljs-number">640</span>,  <span class="hljs-comment">// 视频分辨率的宽。</span></li><li>  <span class="hljs-attr">videoFrameHeight</span>: <span class="hljs-number">480</span>, <span class="hljs-comment">// 视频分辨率的高。</span></li><li>  <span class="hljs-attr">videoFrameRate</span>: <span class="hljs-number">30</span> <span class="hljs-comment">// 视频帧率。</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">videoMetaData</span>: media.<span class="hljs-property">AVMetadata</span> = {</li><li>  <span class="hljs-attr">videoOrientation</span>: <span class="hljs-string">'0'</span> <span class="hljs-comment">// 视频旋转角度，默认为0不旋转，支持的值为0、90、180、270。</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!; <span class="hljs-comment">// 参考应用文件访问与管理。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/example.mp4'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">videoFile</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">fileFd</span>: <span class="hljs-built_in">number</span> = videoFile.<span class="hljs-property">fd</span>; <span class="hljs-comment">// 获取文件fd。</span></li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>  <span class="hljs-attr">videoSourceType</span>: media.<span class="hljs-property">VideoSourceType</span>.<span class="hljs-property">VIDEO_SOURCE_TYPE_SURFACE_YUV</span>, <span class="hljs-comment">// 视频源类型，支持YUV和ES两种格式。</span></li><li>  <span class="hljs-attr">profile</span>: avProfile,</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-string">'fd://'</span> + fileFd.<span class="hljs-title function_">toString</span>(), <span class="hljs-comment">// 参考应用文件访问与管理开发示例新建并读写一个视频文件。</span></li><li>  <span class="hljs-attr">metadata</span>: videoMetaData</li><li>};</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">prepare</span>(avConfig);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in preparing avRecorder'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to prepare avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取视频录制需要的SurfaceID。</p>       <p>调用getInputSurface()接口，接口的返回值SurfaceID用于传递给视频数据输入源模块。常用的输入源模块为相机，以下示例代码中，采用相机作为视频输入源为例。</p>       <p>输入源模块通过SurfaceID可以获取到Surface，通过Surface可以将视频数据流传递给AVRecorder，由AVRecorder再进行视频数据的处理。</p>       <div _ngcontent-doh-c106="" class="highlight-div"><div _ngcontent-doh-c106="" class="highlight-div-header"><div _ngcontent-doh-c106="" class="highlight-div-header-left"><div _ngcontent-doh-c106="" class="handle-button expand-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-doh-c106="" class="highlight-div-header-right"><div _ngcontent-doh-c106="" class="handle-button ai-button"></div><div _ngcontent-doh-c106="" class="handle-button line-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-doh-c106="" class="handle-button theme-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-doh-c106="" class="handle-button copy-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-doh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">getInputSurface</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">surfaceId: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting input surface'</span>);</li><li>}, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get input surface, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>初始化视频数据输入源。该步骤需要在输入源模块完成，以相机为例，需要创建录像输出流，包括创建Camera对象、获取相机列表、创建相机输入流等，相机详细步骤请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording">相机-录像方案</a>。</p></li>      <li>       <p>开始录制，启动输入源输入视频数据，例如相机模块调用camera.VideoOutput.start接口启动相机录制。然后调用AVRecorder.start()接口，此时AVRecorder进入started状态。</p></li>      <li>       <p>暂停录制，调用pause()接口，此时AVRecorder进入paused状态，同时暂停输入源输入数据。例如相机模块调用camera.VideoOutput.stop停止相机视频数据输入。</p></li>      <li>       <p>恢复录制，调用resume()接口，此时再次进入started状态。</p></li>      <li>       <p>停止录制，调用stop()接口，此时进入stopped状态，同时停止相机录制。</p></li>      <li>       <p>重置资源，调用reset()重新进入idle状态，允许重新配置录制参数。</p></li>      <li>       <p>销毁实例，调用release()进入released状态，退出录制，释放视频数据输入源相关资源，例如相机资源。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>参考以下示例，完成“开始录制-暂停录制-恢复录制-停止录制”的完整流程。</p>     <div _ngcontent-doh-c106="" class="highlight-div"><div _ngcontent-doh-c106="" class="highlight-div-header"><div _ngcontent-doh-c106="" class="highlight-div-header-left"><div _ngcontent-doh-c106="" class="handle-button expand-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-doh-c106="" class="highlight-div-header-right"><div _ngcontent-doh-c106="" class="handle-button ai-button"></div><div _ngcontent-doh-c106="" class="handle-button line-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-doh-c106="" class="handle-button theme-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-doh-c106="" class="handle-button copy-button"><div _ngcontent-doh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-doh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">videoRecording</span>(<span class="hljs-params">context: common.Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建avRecorder对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avRecorder</span>: media.<span class="hljs-property">AVRecorder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    avRecorder = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 注册avRecorder回调函数。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 状态机变化回调函数。</span></li><li>    avRecorder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: media.AVRecorderState, reason: media.StateChangeReason</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVRecorder state is changed to <span class="hljs-subst">${state}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// 错误上报回调函数。</span></li><li>    avRecorder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error occurred in avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set avRecorder callback, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 配置录制参数完成准备工作。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>    <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 视频文件封装格式，只支持MP4。</span></li><li>    <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">100000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>    <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频文件编码格式，支持avc格式。</span></li><li>    <span class="hljs-attr">videoFrameWidth</span>: <span class="hljs-number">640</span>,  <span class="hljs-comment">// 视频分辨率的宽。</span></li><li>    <span class="hljs-attr">videoFrameHeight</span>: <span class="hljs-number">480</span>, <span class="hljs-comment">// 视频分辨率的高。</span></li><li>    <span class="hljs-attr">videoFrameRate</span>: <span class="hljs-number">30</span> <span class="hljs-comment">// 视频帧率。</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoMetaData</span>: media.<span class="hljs-property">AVMetadata</span> = {</li><li>    <span class="hljs-attr">videoOrientation</span>: <span class="hljs-string">'0'</span> <span class="hljs-comment">// 视频旋转角度，默认为0不旋转，支持的值为0、90、180、270。</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>    <span class="hljs-attr">videoSourceType</span>: media.<span class="hljs-property">VideoSourceType</span>.<span class="hljs-property">VIDEO_SOURCE_TYPE_SURFACE_YUV</span>, <span class="hljs-comment">// 视频源类型，支持YUV和ES两种格式。</span></li><li>    <span class="hljs-attr">profile</span>: avProfile,</li><li>    <span class="hljs-attr">url</span>: <span class="hljs-string">'fd://35'</span>, <span class="hljs-comment">//  参考应用文件访问与管理开发示例新建并读写一个文件。</span></li><li>    <span class="hljs-attr">metadata</span>: videoMetaData</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 创建文件以及设置avConfig.url。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 文件路径。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoFile</span>: fs.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    filePath = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/example.mp4'</span>; <span class="hljs-comment">// 文件沙箱路径，文件后缀名应与封装格式对应。</span></li><li>    videoFile = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>); <span class="hljs-comment">// 打开文件。</span></li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to open file, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (videoFile !== <span class="hljs-literal">undefined</span>) {</li><li>    avConfig.<span class="hljs-property">url</span> = <span class="hljs-string">'fd://'</span> + videoFile.<span class="hljs-property">fd</span>; <span class="hljs-comment">// 更新url。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 配置录制参数完成准备工作。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'idle'</span> || avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'stopped'</span>) { <span class="hljs-comment">// 仅在idle或者stopped状态下调用prepare为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">prepare</span>(avConfig);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to prepare avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 完成相机相关准备工作。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(context);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoOutSurfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">getInputSurface</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">prepareCamera</span>(cameraManager, videoOutSurfaceId);</li><li>
</li><li>  <span class="hljs-comment">// 启动录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'prepared'</span>) { <span class="hljs-comment">// 仅在prepared状态下调用start为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">startCameraOutput</span>(); <span class="hljs-comment">// 启动相机出流。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">start</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 暂停录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'started'</span>) { <span class="hljs-comment">// 仅在started状态下调用pause为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">pause</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">stopCameraOutput</span>(); <span class="hljs-comment">// 停止相机出流。</span></li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to pause avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 恢复录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) { <span class="hljs-comment">// 仅在paused状态下调用resume为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">startCameraOutput</span>(); <span class="hljs-comment">// 启动相机出流。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">resume</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to resume avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'started'</span> || avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) { <span class="hljs-comment">// 仅在started或者paused状态下调用stop为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">stop</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">stopCameraOutput</span>(); <span class="hljs-comment">// 停止相机出流。</span></li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 重置。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">reset</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to reset avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放录制实例。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">release</span>();</li><li>    avRecorder = <span class="hljs-literal">undefined</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to release avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 关闭录制文件fd。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (videoFile !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">close</span>(videoFile.<span class="hljs-property">fd</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to close fd, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放相机相关实例。</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseCamera</span>();</li><li>  </li><li>  <span class="hljs-comment">// 安全控件保存媒体资源至图库。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">phAccessHelper</span>: photoAccessHelper.<span class="hljs-property">PhotoAccessHelper</span> = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>  <span class="hljs-comment">// 需要确保uriPath对应的资源存在。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">uriPath</span>: <span class="hljs-built_in">string</span> = fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath); <span class="hljs-comment">// 获取录制文件的uri，用于安全控件保存至图库。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">assetChangeRequest</span>: photoAccessHelper.<span class="hljs-property">MediaAssetChangeRequest</span> =</li><li>    photoAccessHelper.<span class="hljs-property">MediaAssetChangeRequest</span>.<span class="hljs-title function_">createVideoAssetRequest</span>(context, uriPath);</li><li>  <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">applyChanges</span>(assetChangeRequest);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 相机相关准备工作。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">prepareCamera</span>(<span class="hljs-params">cameraManager: camera.CameraManager, videoOutSurfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// 具体实现查看相机资料。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 启动相机出流。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startCameraOutput</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 调用VideoOutput的start接口开始录像输出。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 停止相机出流。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopCameraOutput</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 调用VideoOutput的stop接口停止录像输出。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 释放相机实例。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">releaseCamera</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 释放相机准备阶段创建出的实例。</span></li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>