<h1 _ngcontent-jjv-c119="" class="doc-title ng-star-inserted" title="使用AVRecorder录制视频(C/C++)"> 使用AVRecorder录制视频(C/C++) </h1>

<div _ngcontent-jjv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>AVRecorder支持开发音视频录制，集成了音频捕获，音频编码，视频编码，音视频封装功能，适用于实现简单视频录制并直接得到本地媒体文件的场景。</p>    <p>本开发指导将以“开始录制-暂停录制-恢复录制-停止录制”的一次流程为示例，向开发者讲解如何使用AVRecorder进行视频录制。</p>    <p>在进行应用开发的过程中，开发者可以通过AVRecorder的state属性主动获取当前状态，或使用OH_AVRecorder_SetStateCallback方法注册回调监听状态变化。开发过程中应严格遵循状态机要求，例如只能在started状态下调用pause()接口，只能在paused状态下调用resume()接口。</p>    <p><strong>图1</strong> 录制状态变化示意图</p>    <p><span><img originheight="471" originwidth="659" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114448.94227438003756643412423870084436:50001231000000:2800:9412CC6D57C9DC64A77366B996F25A68B04604CF281D87A460447C82AC4B750A.png" width="659" height="471"></span></p>    <p>状态的详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avrecorderstate9" target="_blank">AVRecorderState</a>。</p>    <div class="tiledSection">     <h2 id="申请权限">申请权限<i class="anchor-icon anchor-icon-link" anchorid="申请权限" tips="复制节点链接"></i></h2>          <p>在开发此功能前，开发者应根据实际需求申请相关权限：</p>     <ul>      <li>当需要使用麦克风时，需要申请<strong>ohos.permission.MICROPHONE</strong>麦克风权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要使用相机拍摄时，需要申请<strong>ohos.permission.CAMERA</strong>相机权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要从图库读取图片或视频文件时，请优先使用媒体库<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-photoviewpicker">Picker选择媒体资源</a>。</li>      <li>当需要保存图片或视频文件至图库时，请优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">安全控件保存媒体资源</a>。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>仅应用需要克隆、备份或同步用户公共目录的图片、视频类文件时，可申请ohos.permission.READ_IMAGEVIDEO、ohos.permission.WRITE_IMAGEVIDEO权限来读写音视频文件，申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请受控权限</a>，通过AGC审核后才能使用。为避免应用的上架申请被驳回，开发者应优先使用Picker/控件等替代方案，仅少量符合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_imagevideo">特殊场景</a>的应用被允许申请受限权限。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>AVRecorder只负责视频数据的处理，需要与视频数据采集模块配合才能完成视频录制。视频数据采集模块需要通过Surface将视频数据传递给AVRecorder进行数据处理。当前常用的数据采集模块为相机模块，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-recording">相机-录像</a>。</p>       <p>文件的创建与存储，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问与管理</a>，默认存储在应用的沙箱路径之下，如需存储至图库，请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">安全控件保存媒体资源</a>对沙箱内文件进行存储。</p>      </div></div></div>     <p>开发者通过引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avrecorder-h" target="_blank">avrecorder.h</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avrecorder-base-h" target="_blank">avrecorder_base.h</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-averrors-h" target="_blank">native_averrors.h</a>头文件，使用视频录制相关API。</p>     <p>AVRecorder详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avrecorder" target="_blank">AVRecorder API参考</a>。</p>     <p>在 CMake 脚本中链接动态库。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libavrecorder.so)</li></ol></pre></div></div>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avformat-h" target="_blank">OH_AVFormat</a>相关接口时，需引入如下头文件。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li></ol></pre></div></div>     <p>并在 CMake 脚本中链接如下动态库。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libnative_media_core.so)</li></ol></pre></div></div>     <p>开发者使用系统日志能力时，需引入如下头文件。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li></ol></pre></div></div>     <p>并需要在 CMake 脚本中链接如下动态库。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libhilog_ndk.z.so)</li></ol></pre></div></div>     <ol>      <li>       <p>创建AVRecorder实例，实例创建完成进入idle状态。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avrecorder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avrecorder_base.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_AVRecorder</span> *g_avRecorder = <span class="hljs-literal">nullptr</span>;</li><li>g_avRecorder = <span class="hljs-built_in">OH_AVRecorder_Create</span>();</li></ol></pre></div></div></li>      <li>       <p>设置业务需要的监听事件，监听状态变化及错误上报。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.15.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.15.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">OnStateChange</td>           <td class="cellrowborder" valign="top" width="50%">监听AVRecorder的状态改变。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OnError</td>           <td class="cellrowborder" valign="top" width="50%">监听AVRecorder的错误信息。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OnUri</td>           <td class="cellrowborder" valign="top" width="50%">监听AVRecorder生成媒体文件。</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置状态回调。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnStateChange</span><span class="hljs-params">(OH_AVRecorder *recorder, OH_AVRecorder_State state,</span></span></li><li><span class="hljs-function">    OH_AVRecorder_StateChangeReason reason, <span class="hljs-type">void</span> *userData)</span> {</li><li>    (<span class="hljs-type">void</span>)recorder;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>
</li><li>    <span class="hljs-comment">// 将reason转换为字符串表示。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *reasonStr = (reason == OH_AVRecorder_StateChangeReason::AVRECORDER_USER) ? <span class="hljs-string">"USER"</span> :</li><li>                            (reason == OH_AVRecorder_StateChangeReason::AVRECORDER_BACKGROUND) ? <span class="hljs-string">"BACKGROUND"</span> : <span class="hljs-string">"UNKNOWN"</span>;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_IDLE) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange IDLE, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::PREPARED) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange PREPARED, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::STARTED) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange STARTED, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::PAUSED) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange PAUSED, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::STOPPED) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange STOPPED, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::RELEASED) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange RELEASED, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange ERROR, reason: %{public}s"</span>, reasonStr);</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置错误回调。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVRecorder *recorder, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errorMsg, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)recorder;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnError errorCode: %{public}d, error message: %{public}s"</span>,</li><li>        errorCode, errorMsg);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置生成媒体文件回调（fileGenerationMode选择AUTO_CREATE时设置）。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnUri</span><span class="hljs-params">(OH_AVRecorder *recorder, OH_MediaAsset *asset, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)recorder;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    <span class="hljs-keyword">if</span> (asset != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">auto</span> changeRequest = <span class="hljs-built_in">OH_MediaAssetChangeRequest_Create</span>(asset);</li><li>        <span class="hljs-keyword">if</span> (changeRequest == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== changeRequest is null!"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        MediaLibrary_ImageFileType imageFileType = MEDIA_LIBRARY_IMAGE_JPEG; <span class="hljs-comment">// 待媒体库提供可用的VIDEO接口。</span></li><li>        <span class="hljs-type">uint32_t</span> result = <span class="hljs-built_in">OH_MediaAssetChangeRequest_SaveCameraPhoto</span>(changeRequest, imageFileType);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"result of OH_MediaAssetChangeRequest_SaveCameraPhoto: %d"</span>, result);</li><li>
</li><li>        <span class="hljs-type">uint32_t</span> resultChange = <span class="hljs-built_in">OH_MediaAccessHelper_ApplyChanges</span>(changeRequest);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"result of OH_MediaAccessHelper_ApplyChanges: %d"</span>, resultChange);</li><li>
</li><li>        <span class="hljs-built_in">OH_MediaAsset_Release</span>(asset);</li><li>        <span class="hljs-built_in">OH_MediaAssetChangeRequest_Release</span>(changeRequest);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Received null media asset!"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>配置视频录制参数，调用OH_AVRecorder_Prepare()接口，此时进入prepared状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>配置参数需要注意：</p>         <ul>          <li>           <p>配置参数之前需要确保完成对应权限的申请，请参考<a href="/consumer/cn/doc/harmonyos-guides/using-ndk-avrecorder-for-video-recording#申请权限">申请权限</a>。</p></li>          <li>           <p>prepare接口的入参OH_AVRecorder_Config中设置的音视频相关的配置参数，如示例代码所示。</p></li>          <li>           <p>需要使用支持的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#支持的格式">录制规格</a>，视频比特率、分辨率、帧率以实际硬件设备支持的范围为准。</p></li>          <li>           <p>录制输出的url地址（即示例里avConfig中的url），形式为fd://xx (fd number)。需要调用基础文件操作接口实现应用文件访问能力，获取方式参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-fileio-guidelines">应用文件访问与管理</a>。</p></li>         </ul>        </div></div></div>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetConfig</span><span class="hljs-params">(OH_AVRecorder_Config &amp;config)</span></span></li><li><span class="hljs-function"></span>{</li><li>    config.audioSourceType = AVRECORDER_MIC;</li><li>    config.videoSourceType = AVRECORDER_SURFACE_ES;</li><li>
</li><li>    <span class="hljs-comment">// 设置媒体属性。</span></li><li>    config.profile.audioBitrate = <span class="hljs-number">96000</span>;</li><li>    config.profile.audioChannels = <span class="hljs-number">2</span>;</li><li>    config.profile.audioCodec = AVRECORDER_AUDIO_AAC;</li><li>    config.profile.audioSampleRate = <span class="hljs-number">48000</span>;</li><li>
</li><li>    config.profile.videoBitrate = <span class="hljs-number">2000000</span>;</li><li>    config.profile.videoFrameWidth = <span class="hljs-number">1280</span>;</li><li>    config.profile.videoFrameHeight = <span class="hljs-number">720</span>;</li><li>    config.profile.videoFrameRate = <span class="hljs-number">30</span>;</li><li>    config.profile.videoCodec = AVRECORDER_VIDEO_AVC;</li><li>    config.profile.isHdr = <span class="hljs-literal">false</span>;</li><li>    config.profile.enableTemporalScale = <span class="hljs-literal">false</span>;</li><li> </li><li>    config.profile.fileFormat = AVRECORDER_CFT_MPEG_4;</li><li>    config.fileGenerationMode = AVRECORDER_APP_CREATE;</li><li>
</li><li>    config.metadata.videoOrientation = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">2</span>]; <span class="hljs-comment">// 开发者需要自行释放申请的内存。</span></li><li>    <span class="hljs-keyword">if</span> (config.metadata.videoOrientation != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">strcpy</span>(config.metadata.videoOrientation, <span class="hljs-string">"0"</span>); <span class="hljs-comment">// 视频旋转角度，支持0、90、180、270。</span></li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== videoOrientation: %{public}s"</span>, config.metadata.videoOrientation);</li><li>
</li><li>    config.metadata.location.latitude = <span class="hljs-number">27.791863</span>;</li><li>    config.metadata.location.longitude = <span class="hljs-number">64.574687</span>;</li><li> }</li><li>
</li><li> <span class="hljs-comment">// 准备录制。</span></li><li> <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">PrepareAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"> </span>{</li><li>     (<span class="hljs-type">void</span>)info;</li><li>     <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== PrepareAVRecorder in!"</span>);</li><li>     g_avRecorder = <span class="hljs-built_in">OH_AVRecorder_Create</span>();</li><li>     <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Create ok! g_avRecorder: %{public}p"</span>, g_avRecorder);</li><li>     <span class="hljs-keyword">if</span> (g_avRecorder == <span class="hljs-literal">nullptr</span>) {</li><li>         <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Create failed!"</span>);</li><li>     }</li><li>     OH_AVRecorder_Config *config = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OH_AVRecorder_Config</span>(); <span class="hljs-comment">// 开发者需要自行释放申请的内存。</span></li><li>     </li><li>     <span class="hljs-built_in">SetConfig</span>(*config);</li><li> </li><li>     <span class="hljs-comment">// 1.设置URL（fileGenerationMode选择APP_CREATE时设置）。</span></li><li>     <span class="hljs-type">const</span> std::string AVRECORDER_ROOT = <span class="hljs-string">"/data/storage/el2/base/files/"</span>;</li><li>     <span class="hljs-type">int32_t</span> outputFd = <span class="hljs-built_in">open</span>((AVRECORDER_ROOT + <span class="hljs-string">"avrecorder01.mp4"</span>).<span class="hljs-built_in">c_str</span>(), O_RDWR | O_CREAT, <span class="hljs-number">0777</span>); <span class="hljs-comment">// 设置文件名。</span></li><li>     std::string fileUrl = <span class="hljs-string">"fd://"</span> + std::<span class="hljs-built_in">to_string</span>(outputFd);</li><li>     config-&gt;url = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(fileUrl.<span class="hljs-built_in">c_str</span>());</li><li>     <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"config.url is: %s"</span>, <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(fileUrl.<span class="hljs-built_in">c_str</span>()));</li><li> </li><li>     <span class="hljs-comment">// 2.设置回调。</span></li><li>     <span class="hljs-comment">// 状态回调。</span></li><li>     <span class="hljs-built_in">OH_AVRecorder_SetStateCallback</span>(g_avRecorder, OnStateChange, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>     <span class="hljs-comment">// 错误回调。</span></li><li>     <span class="hljs-built_in">OH_AVRecorder_SetErrorCallback</span>(g_avRecorder, OnError, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>     <span class="hljs-comment">// 生成媒体文件回调（fileGenerationMode选择AUTO_CREATE时设置）。</span></li><li>     OH_AVErrCode ret = <span class="hljs-built_in">OH_AVRecorder_SetUriCallback</span>(g_avRecorder, OnUri, <span class="hljs-literal">nullptr</span>);</li><li>     <span class="hljs-keyword">if</span> (ret == AV_ERR_OK) {</li><li>         <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo==  OH_AVRecorder_SetUriCallback succeed!"</span>);</li><li>     } <span class="hljs-keyword">else</span> {</li><li>         <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo==  Failed to set URI callback, error code: %d"</span>, ret);</li><li>     }</li><li>     </li><li>     <span class="hljs-comment">// 3.调用prepare接口。</span></li><li>     <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Prepare</span>(g_avRecorder, config);</li><li>     <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>         <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Prepare failed %{public}d"</span>, result);</li><li>     }</li><li>   </li><li>     <span class="hljs-comment">// 4.释放内存。</span></li><li>     <span class="hljs-keyword">delete</span> config-&gt;metadata.videoOrientation;</li><li>     <span class="hljs-keyword">delete</span> config;</li><li>     config = <span class="hljs-literal">nullptr</span>;</li><li>   </li><li>     napi_value res;</li><li>     <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>     <span class="hljs-keyword">return</span> res;</li><li> }</li></ol></pre></div></div></li>      <li>       <p>获取视频录制需要的SurfaceID，初始化视频数据输入源。该步骤需要在输入源模块完成，以相机为例，需要创建录像输出流，包括创建Camera对象、获取相机列表、创建相机输入流等，相机详细步骤请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-recording">相机-录像方案</a>。</p>       <p>调用getInputSurface()接口，接口的返回值SurfaceID用于传递给视频数据输入源模块。常用的输入源模块为相机，以下示例代码中，仅展示获取SurfaceID的步骤。</p>       <p>输入源模块通过SurfaceID可以获取到Surface，通过Surface可以将视频数据流传递给AVRecorder，由AVRecorder再进行视频数据的处理。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取surfaceID。</span></li><li>OHNativeWindow *window = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int</span> resultCode = <span class="hljs-built_in">OH_AVRecorder_GetInputSurface</span>(g_avRecorder, &amp;window);</li><li><span class="hljs-type">uint64_t</span> surfaceId = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">if</span> (resultCode == AV_ERR_OK &amp;&amp; window != <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-built_in">OH_NativeWindow_GetSurfaceId</span>(window, &amp;surfaceId);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>初始化视频数据输入源。该步骤需要在输入源模块完成，以相机为例，需要创建录像输出流，包括创建Camera对象、获取相机列表、创建相机输入流等，相机详细步骤请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-recording">相机-录像方案</a>。</p></li>      <li>       <p>开始录制，启动输入源输入视频数据，例如相机模块调用OH_VideoOutput_Start()接口启动相机录制。然后调用OH_AVRecorder_Start()接口，此时AVRecorder进入started状态。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Start</span>(g_avRecorder);</li></ol></pre></div></div></li>      <li>       <p>暂停录制，调用OH_AVRecorder_Pause()接口，此时AVRecorder进入paused状态，同时暂停输入源输入数据。例如相机模块调用OH_VideoOutput_Stop()停止相机视频数据输入。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Pause</span>(g_avRecorder);</li></ol></pre></div></div></li>      <li>       <p>恢复录制，调用OH_AVRecorder_Resume()接口，此时再次进入started状态。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Resume</span>(g_avRecorder);</li></ol></pre></div></div></li>      <li>       <p>停止录制，调用OH_AVRecorder_Stop()接口，此时进入stopped状态，同时停止相机录制。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Stop</span>(g_avRecorder);</li></ol></pre></div></div></li>      <li>       <p>重置资源，调用OH_AVRecorder_Reset()重新进入idle状态，允许重新配置录制参数。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Reset</span>(g_avRecorder);</li></ol></pre></div></div></li>      <li>       <p>销毁实例，调用OH_AVRecorder_Release()进入released状态，退出录制，释放视频数据输入源相关资源，例如相机资源。</p>       <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVRecorder_Release</span>(g_avRecorder);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>参考以下示例，包括“创建录制实例-准备录制-开始录制-暂停录制-恢复录制-停止录制-重置录制状态-释放录制资源”的完整流程。</p>     <div _ngcontent-jjv-c106="" class="highlight-div"><div _ngcontent-jjv-c106="" class="highlight-div-header"><div _ngcontent-jjv-c106="" class="highlight-div-header-left"><div _ngcontent-jjv-c106="" class="handle-button expand-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jjv-c106="" class="highlight-div-header-right"><div _ngcontent-jjv-c106="" class="handle-button ai-button"></div><div _ngcontent-jjv-c106="" class="handle-button line-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jjv-c106="" class="handle-button theme-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jjv-c106="" class="handle-button copy-button"><div _ngcontent-jjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jjv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avrecorder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/avrecorder_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_asset_change_request_capi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_access_helper_capi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_asset_capi.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_AVRecorder</span> *g_avRecorder = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> g_outputFd;</li><li>
</li><li><span class="hljs-comment">// 设置状态回调。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnStateChange</span><span class="hljs-params">(OH_AVRecorder *recorder, OH_AVRecorder_State state,</span></span></li><li><span class="hljs-function">                   OH_AVRecorder_StateChangeReason reason, <span class="hljs-type">void</span> *userData)</span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)recorder;</li><li>   (<span class="hljs-type">void</span>)userData;</li><li>
</li><li>   <span class="hljs-comment">// 将reason转换为字符串表示。</span></li><li>   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *reasonStr = (reason == OH_AVRecorder_StateChangeReason::AVRECORDER_USER) ? <span class="hljs-string">"USER"</span> :</li><li>                           (reason == OH_AVRecorder_StateChangeReason::AVRECORDER_BACKGROUND) ? <span class="hljs-string">"BACKGROUND"</span> : <span class="hljs-string">"UNKNOWN"</span>;</li><li>
</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_IDLE) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange IDLE, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_PREPARED) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange PREPARED, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_STARTED) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange STARTED, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_PAUSED) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange PAUSED, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_STOPPED) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange STOPPED, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_RELEASED) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange RELEASED, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>   <span class="hljs-keyword">if</span> (state == OH_AVRecorder_State::AVRECORDER_ERROR) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnStateChange ERROR, reason: %{public}s"</span>, reasonStr);</li><li>      <span class="hljs-comment">// 处理状态变更。</span></li><li>   }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置错误回调。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVRecorder *recorder, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errorMsg, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)recorder;</li><li>   (<span class="hljs-type">void</span>)userData;</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== Recorder OnError errorCode: %{public}d, error message: %{public}s"</span>,</li><li>               errorCode, errorMsg);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置生成媒体文件回调（fileGenerationMode选择AUTO_CREATE时设置）。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnUri</span><span class="hljs-params">(OH_AVRecorder *recorder, OH_MediaAsset *asset, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)recorder;</li><li>   (<span class="hljs-type">void</span>)userData;</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== OnUri in!"</span>);</li><li>   <span class="hljs-keyword">if</span> (asset != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-keyword">auto</span> changeRequest = <span class="hljs-built_in">OH_MediaAssetChangeRequest_Create</span>(asset);</li><li>      <span class="hljs-keyword">if</span> (changeRequest == <span class="hljs-literal">nullptr</span>) {</li><li>         <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== changeRequest is null!"</span>);</li><li>         <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      MediaLibrary_ImageFileType imageFileType = MEDIA_LIBRARY_IMAGE_JPEG; <span class="hljs-comment">// 待媒体库提供可用的VIDEO接口。</span></li><li>      <span class="hljs-type">uint32_t</span> result = <span class="hljs-built_in">OH_MediaAssetChangeRequest_SaveCameraPhoto</span>(changeRequest, imageFileType);</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"result of OH_MediaAssetChangeRequest_SaveCameraPhoto: %d"</span>, result);</li><li>
</li><li>      <span class="hljs-type">uint32_t</span> resultChange = <span class="hljs-built_in">OH_MediaAccessHelper_ApplyChanges</span>(changeRequest);</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"result of OH_MediaAccessHelper_ApplyChanges: %d"</span>, resultChange);</li><li>
</li><li>      <span class="hljs-built_in">OH_MediaAsset_Release</span>(asset);</li><li>      <span class="hljs-built_in">OH_MediaAssetChangeRequest_Release</span>(changeRequest);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Received null media asset!"</span>);</li><li>   }</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== OnUri out!"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetConfig</span><span class="hljs-params">(OH_AVRecorder_Config &amp;config)</span></span></li><li><span class="hljs-function"></span>{</li><li>   config.audioSourceType = AVRECORDER_MIC;</li><li>   config.videoSourceType = AVRECORDER_SURFACE_ES;</li><li>
</li><li>   <span class="hljs-comment">// 设置媒体属性。</span></li><li>   config.profile.audioBitrate = <span class="hljs-number">96000</span>;</li><li>   config.profile.audioChannels = <span class="hljs-number">2</span>;</li><li>   config.profile.audioCodec = AVRECORDER_AUDIO_AAC;</li><li>   config.profile.audioSampleRate = <span class="hljs-number">48000</span>;</li><li>
</li><li>   config.profile.videoBitrate = <span class="hljs-number">2000000</span>;</li><li>   config.profile.videoFrameWidth = <span class="hljs-number">1280</span>;</li><li>   config.profile.videoFrameHeight = <span class="hljs-number">720</span>;</li><li>   config.profile.videoFrameRate = <span class="hljs-number">30</span>;</li><li>   config.profile.videoCodec = AVRECORDER_VIDEO_AVC;</li><li>   config.profile.isHdr = <span class="hljs-literal">false</span>;</li><li>   config.profile.enableTemporalScale = <span class="hljs-literal">false</span>;</li><li>
</li><li>   config.profile.fileFormat = AVRECORDER_CFT_MPEG_4;</li><li>   config.fileGenerationMode = AVRECORDER_APP_CREATE;</li><li>
</li><li>   config.metadata.videoOrientation = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">2</span>]; <span class="hljs-comment">// 开发者需要自行释放申请的内存。</span></li><li>   <span class="hljs-keyword">if</span> (config.metadata.videoOrientation != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">strcpy</span>(config.metadata.videoOrientation, <span class="hljs-string">"0"</span>); <span class="hljs-comment">// 视频旋转角度，支持0、90、180、270。</span></li><li>   }</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== videoOrientation: %{public}s"</span>, config.metadata.videoOrientation);</li><li>
</li><li>   config.metadata.location.latitude = <span class="hljs-number">27.791863</span>;</li><li>   config.metadata.location.longitude = <span class="hljs-number">64.574687</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 1.准备录制。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">PrepareAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== PrepareAVRecorder in!"</span>);</li><li>   g_avRecorder = <span class="hljs-built_in">OH_AVRecorder_Create</span>();</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Create ok! g_avRecorder: %{public}p"</span>, g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (g_avRecorder == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Create failed!"</span>);</li><li>   }</li><li>   OH_AVRecorder_Config *config = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OH_AVRecorder_Config</span>(); <span class="hljs-comment">// 开发者需要自行释放申请的内存。</span></li><li>
</li><li>   <span class="hljs-built_in">SetConfig</span>(*config);</li><li>
</li><li>   <span class="hljs-comment">// 1.1设置URL（fileGenerationMode选择APP_CREATE时设置）。</span></li><li>   <span class="hljs-type">const</span> std::string AVRECORDER_ROOT = <span class="hljs-string">"/data/storage/el2/base/files/"</span>;</li><li>   g_outputFd = <span class="hljs-built_in">open</span>((AVRECORDER_ROOT + <span class="hljs-string">"avrecorder01.mp4"</span>).<span class="hljs-built_in">c_str</span>(), O_RDWR | O_CREAT, <span class="hljs-number">0777</span>); <span class="hljs-comment">// 设置文件名。</span></li><li>   std::string fileUrl = <span class="hljs-string">"fd://"</span> + std::<span class="hljs-built_in">to_string</span>(g_outputFd);</li><li>   config-&gt;url = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(fileUrl.<span class="hljs-built_in">c_str</span>());</li><li>
</li><li>   <span class="hljs-comment">// 1.2设置回调。</span></li><li>   <span class="hljs-comment">// 状态回调。</span></li><li>   <span class="hljs-built_in">OH_AVRecorder_SetStateCallback</span>(g_avRecorder, OnStateChange, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>   <span class="hljs-comment">// 错误回调。</span></li><li>   <span class="hljs-built_in">OH_AVRecorder_SetErrorCallback</span>(g_avRecorder, OnError, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>   <span class="hljs-comment">// 生成媒体文件回调（fileGenerationMode选择AUTO_CREATE时设置）。</span></li><li>   OH_AVErrCode ret = <span class="hljs-built_in">OH_AVRecorder_SetUriCallback</span>(g_avRecorder, OnUri, <span class="hljs-literal">nullptr</span>);</li><li>   <span class="hljs-keyword">if</span> (ret == AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo==  OH_AVRecorder_SetUriCallback succeed!"</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo==  Failed to set URI callback, error code: %d"</span>, ret);</li><li>   }</li><li>
</li><li>   <span class="hljs-comment">// 1.3调用prepare接口。</span></li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Prepare</span>(g_avRecorder, config);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Prepare failed %{public}d"</span>, result);</li><li>   }</li><li>   </li><li>   <span class="hljs-comment">// 1.4释放内存。</span></li><li>   <span class="hljs-keyword">delete</span> config-&gt;metadata.videoOrientation;</li><li>   <span class="hljs-keyword">delete</span> config;</li><li>   config = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 2.启动相机。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">PrepareCamera</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder PrepareCamera"</span>);</li><li>   (<span class="hljs-type">void</span>)info;</li><li>
</li><li>   OHNativeWindow *window = <span class="hljs-literal">nullptr</span>;</li><li>   <span class="hljs-type">int</span> resultCode = <span class="hljs-built_in">OH_AVRecorder_GetInputSurface</span>(g_avRecorder, &amp;window);</li><li>   <span class="hljs-keyword">if</span> (resultCode != AV_ERR_OK || window == <span class="hljs-literal">nullptr</span>) {</li><li>       <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder OH_AVRecorder_GetInputSurface failed!"</span>);</li><li>       napi_value errorResult;</li><li>       <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">-1</span>, &amp;errorResult); <span class="hljs-comment">// -1表示错误</span></li><li>       <span class="hljs-keyword">return</span> errorResult;</li><li>   }</li><li>   <span class="hljs-type">uint64_t</span> surfaceId = <span class="hljs-number">0</span>;</li><li>   <span class="hljs-built_in">OH_NativeWindow_GetSurfaceId</span>(window, &amp;surfaceId);</li><li>
</li><li>   <span class="hljs-comment">// 将surfaceId传入数据采集模块，具体请参考相机模块。</span></li><li>
</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 3.开始录制。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StartAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Start</span>(g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Start failed %{public}d"</span>, result);</li><li>   }</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 4.暂停录制。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">PauseAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Pause</span>(g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Pause failed %{public}d"</span>, result);</li><li>   }</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 5.恢复录制。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ResumeAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Resume</span>(g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Resume failed %{public}d"</span>, result);</li><li>   }</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 6.停止录制。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StopAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Stop</span>(g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Stop failed %{public}d"</span>, result);</li><li>   }</li><li>   <span class="hljs-built_in">close</span>(g_outputFd);</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 7.重置录制状态。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ResetAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-comment">// 检查g_avRecorder是否有效。</span></li><li>   <span class="hljs-keyword">if</span> (g_avRecorder == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== g_avRecorder is nullptr!"</span>);</li><li>      napi_value res;</li><li>      <span class="hljs-built_in">napi_create_int32</span>(env, AV_ERR_INVALID_VAL, &amp;res);</li><li>      <span class="hljs-keyword">return</span> res;</li><li>   }</li><li>
</li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Reset</span>(g_avRecorder);</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Reset failed %{public}d"</span>, result);</li><li>   }</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 8.释放录制资源。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ReleaseAVRecorder</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   (<span class="hljs-type">void</span>)info;</li><li>   <span class="hljs-comment">// 检查g_avRecorder是否有效。</span></li><li>   <span class="hljs-keyword">if</span> (g_avRecorder == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== g_avRecorder is nullptr!"</span>);</li><li>      napi_value res;</li><li>      <span class="hljs-built_in">napi_create_int32</span>(env, AV_ERR_INVALID_VAL, &amp;res);</li><li>      <span class="hljs-keyword">return</span> res;</li><li>   }</li><li>   </li><li>   <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVRecorder_Release</span>(g_avRecorder);</li><li>   g_avRecorder = <span class="hljs-literal">nullptr</span>;   <span class="hljs-comment">// 释放录制资源后，需要显式地将g_avRecorder指针置空。</span></li><li>
</li><li>   <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"==NDKDemo== AVRecorder Release failed %{public}d"</span>, result);</li><li>   }</li><li>   napi_value res;</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;res);</li><li>   <span class="hljs-keyword">return</span> res;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>