<h1 _ngcontent-uqa-c119="" class="doc-title ng-star-inserted" title="使用AVRecorder录制音频(ArkTS)"> 使用AVRecorder录制音频(ArkTS) </h1>

<div _ngcontent-uqa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avrecorder">AVRecorder</a>可以实现音频录制功能，本开发指导将以“开始录制-暂停录制-恢复录制-停止录制”的一次流程为示例，向开发者讲解AVRecorder音频录制相关功能。</p>    <p>在进行应用开发的过程中，开发者可以通过AVRecorder的state属性，主动获取当前状态或使用on('stateChange')方法监听状态变化。开发过程中应该严格遵循状态机要求，例如只能在started状态下调用pause()接口，只能在paused状态下调用resume()接口。</p>    <p><strong>图1</strong> 录制状态变化示意图</p>    <p><span><img originheight="783" originwidth="1335" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114444.85077854154864172143825804469235:50001231000000:2800:A4AA5ABF68D16E600FBF3C997A23BA38E337B5D9D3D139E059DCFA8B284E2508.png" width="920" height="539.5955056179776"></span></p>    <p>状态的详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avrecorderstate9" target="_blank">AVRecorderState</a>。</p>    <div class="tiledSection">     <h2 id="申请权限">申请权限<i class="anchor-icon anchor-icon-link" anchorid="申请权限" tips="复制节点链接"></i></h2>          <p>在开发此功能前，开发者应根据实际需求申请相关权限：</p>     <ul>      <li>当需要使用麦克风时，需要申请<strong>ohos.permission.MICROPHONE</strong>麦克风权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要读取和保存音频文件时，请优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#audioviewpicker" target="_blank">AudioViewPicker音频选择器对象</a>。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>仅应用需要克隆、备份或同步用户公共目录的音频类文件时，可申请ohos.permission.READ_AUDIO、ohos.permission.WRITE_AUDIO权限来读写音频文件，申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请受控权限</a>，通过AGC审核后才能使用。为避免应用的上架申请被驳回，开发者应优先使用Picker/控件等替代方案，仅少量符合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_audio">特殊场景</a>的应用被允许申请受限权限。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发音频录制应用须知">开发音频录制应用须知<i class="anchor-icon anchor-icon-link" anchorid="开发音频录制应用须知" tips="复制节点链接"></i></h2>          <ul>      <li>如果需要持续录制或后台录制，请申请长时任务避免进入挂起（Suspend）状态。具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task">长时任务开发指导</a>。</li>      <li>录制需要在前台启动，启动后可以退后台。在后台启动录制将会失败。</li>      <li>应用录制音频时需要使用合适的录制流类型，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-right-streamusage-and-sourcetype">使用合适的音频流类型</a>。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder" target="_blank">AVRecorder API参考</a>。</p>     <ol>      <li>       <p>创建AVRecorder实例，实例创建完成进入idle状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>需要在avRecorder完成赋值后，再进行剩余操作。</p>        </div></div></div>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avRecorder</span>: media.<span class="hljs-property">AVRecorder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置业务需要的监听事件，监听状态变化及错误上报。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.3.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.3.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">stateChange</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听AVRecorder的state属性改变。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">error</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听AVRecorder的错误信息。</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 状态上报回调函数。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: media.AVRecorderState, reason: media.StateChangeReason</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVRecorder state is changed to <span class="hljs-subst">${state}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>  <span class="hljs-comment">// 用户可以在此补充状态发生切换后想要进行的动作。</span></li><li>});</li><li>
</li><li><span class="hljs-comment">// 错误上报回调函数。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error occurred in avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>配置音频录制参数，调用prepare()接口，此时进入prepared状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>配置参数需要注意：</p>         <ul>          <li>           <p>配置参数之前需要确保完成对应权限的申请，请参考<a href="/consumer/cn/doc/harmonyos-guides/using-avrecorder-for-recording#申请权限">申请权限</a>。</p></li>          <li>           <p>prepare接口的入参avConfig中仅设置音频相关的配置参数，如示例代码所示。</p>           <p>如果只需要录制音频，请不要设置视频相关配置参数；如果需要录制视频，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-recording">视频录制开发指导</a>进行开发。直接设置视频相关参数会导致后续步骤报错。</p></li>          <li>           <p>需要使用支持的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#支持的格式">录制规格</a>，具体录制参数需严格契合既定的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#avrecorderprofile9" target="_blank">录制参数配置</a>。</p></li>          <li>           <p>录制输出的url地址（即示例里avConfig中的url），形式为fd://xx (fd number)。需要基础文件操作接口（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">Core File Kit的ohos.file.fs</a>）实现应用文件访问能力，获取方式参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问与管理</a>。</p></li>         </ul>        </div></div></div>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>  <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">112000</span>, <span class="hljs-comment">// 音频比特率。</span></li><li>  <span class="hljs-attr">audioChannels</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 音频声道数。</span></li><li>  <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>, <span class="hljs-comment">// 音频编码格式，当前支持AAC，MP3，G711MU。</span></li><li>  <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>, <span class="hljs-comment">// 音频采样率。</span></li><li>  <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4A</span>, <span class="hljs-comment">// 封装格式，当前支持MP4，M4A，MP3，WAV，AMR，AAC。</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!; <span class="hljs-comment">// 参考应用文件访问与管理。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/example.mp3'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioFile</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">fileFd</span>: <span class="hljs-built_in">number</span> = audioFile.<span class="hljs-property">fd</span>; <span class="hljs-comment">// 获取文件fd。</span></li><li> </li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>  <span class="hljs-attr">audioSourceType</span>: media.<span class="hljs-property">AudioSourceType</span>.<span class="hljs-property">AUDIO_SOURCE_TYPE_MIC</span>, <span class="hljs-comment">// 音频输入源，这里设置为麦克风。</span></li><li>  <span class="hljs-attr">profile</span>: avProfile,</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-string">'fd://'</span> + fileFd.<span class="hljs-title function_">toString</span>(), <span class="hljs-comment">// 参考应用文件访问与管理中的开发示例获取创建的音频文件fd填入此处。</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">prepare</span>(avConfig);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in preparing avRecorder'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to prepare avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>开始录制，调用start()接口，此时进入started状态。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 开始录制。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">start</span>();</li></ol></pre></div></div></li>      <li>       <p>暂停录制，调用pause()接口，此时进入paused状态。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 暂停录制。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">pause</span>();</li></ol></pre></div></div></li>      <li>       <p>恢复录制，调用resume()接口，此时再次进入started状态。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 恢复录制。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">resume</span>();</li></ol></pre></div></div></li>      <li>       <p>停止录制，调用stop()接口，此时进入stopped状态。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 停止录制。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">stop</span>();</li></ol></pre></div></div></li>      <li>       <p>重置资源，调用reset()重新进入idle状态，允许重新配置录制参数。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 重置资源。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">reset</span>();</li></ol></pre></div></div></li>      <li>       <p>销毁实例，调用release()进入released状态，退出录制。</p>       <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁实例。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">release</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>参考以下示例，完成“开始录制-暂停录制-恢复录制-停止录制”的完整流程。</p>     <p>使用当前示例代码时，需要申请<strong>ohos.permission.MICROPHONE</strong>麦克风权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>     <div _ngcontent-uqa-c106="" class="highlight-div"><div _ngcontent-uqa-c106="" class="highlight-div-header"><div _ngcontent-uqa-c106="" class="highlight-div-header-left"><div _ngcontent-uqa-c106="" class="handle-button expand-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqa-c106="" class="highlight-div-header-right"><div _ngcontent-uqa-c106="" class="handle-button ai-button"></div><div _ngcontent-uqa-c106="" class="handle-button line-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqa-c106="" class="handle-button theme-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqa-c106="" class="handle-button copy-button"><div _ngcontent-uqa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">audioRecording</span>(<span class="hljs-params">context: common.Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建avRecorder对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avRecorder</span>: media.<span class="hljs-property">AVRecorder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    avRecorder = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 注册avRecorder回调函数。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 状态机变化回调函数。</span></li><li>    avRecorder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: media.AVRecorderState, reason: media.StateChangeReason</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVRecorder state is changed to <span class="hljs-subst">${state}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// 错误上报回调函数。</span></li><li>    avRecorder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error occurred in avRecorder, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set avRecorder callback, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>    <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">112000</span>, <span class="hljs-comment">// 音频比特率。</span></li><li>    <span class="hljs-attr">audioChannels</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 音频声道数。</span></li><li>    <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>, <span class="hljs-comment">// 音频编码格式，当前支持AAC，MP3，G711MU。</span></li><li>    <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>, <span class="hljs-comment">// 音频采样率。</span></li><li>    <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4A</span>, <span class="hljs-comment">// 封装格式，当前支持MP4，M4A，MP3，WAV，AMR，AAC。</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>    <span class="hljs-attr">audioSourceType</span>: media.<span class="hljs-property">AudioSourceType</span>.<span class="hljs-property">AUDIO_SOURCE_TYPE_MIC</span>, <span class="hljs-comment">// 音频输入源，这里设置为麦克风。</span></li><li>    <span class="hljs-attr">profile</span>: avProfile,</li><li>    <span class="hljs-attr">url</span>: <span class="hljs-string">'fd://35'</span>, <span class="hljs-comment">// 参考应用文件访问与管理开发示例新建并读写一个文件。</span></li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 创建文件以及设置avConfig.url。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">audioFile</span>: fs.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/example.mp3'</span>; <span class="hljs-comment">// 文件沙箱路径，文件后缀名应与封装格式对应。</span></li><li>    audioFile = fs.<span class="hljs-title function_">openSync</span>(path, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>); <span class="hljs-comment">// 打开文件。</span></li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to open file, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (audioFile !== <span class="hljs-literal">undefined</span>) {</li><li>    avConfig.<span class="hljs-property">url</span> = <span class="hljs-string">'fd://'</span> + audioFile.<span class="hljs-property">fd</span>; <span class="hljs-comment">// 更新url。</span></li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 配置录制参数完成准备工作。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'idle'</span> || avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'stopped'</span>) { <span class="hljs-comment">// 仅在idle或者stopped状态下调用prepare为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">prepare</span>(avConfig);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to prepare avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 开始录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'prepared'</span>) { <span class="hljs-comment">// 仅在prepared状态下调用start为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">start</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 暂停录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'started'</span>) { <span class="hljs-comment">// 仅在started状态下调用pause为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">pause</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to pause avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 恢复录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) { <span class="hljs-comment">// 仅在paused状态下调用resume为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">resume</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to resume avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止录制。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'started'</span> || avRecorder.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) { <span class="hljs-comment">// 仅在started或者paused状态下调用stop为合理状态切换。</span></li><li>      <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">stop</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 重置。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">reset</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to reset avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放录制实例。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> avRecorder.<span class="hljs-title function_">release</span>();</li><li>    avRecorder = <span class="hljs-literal">undefined</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to release avRecorder, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 关闭录制文件fd。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (audioFile !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">close</span>(audioFile.<span class="hljs-property">fd</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to close fd, error code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>