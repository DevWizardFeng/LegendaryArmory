<h1 _ngcontent-xsr-c119="" class="doc-title ng-star-inserted" title="使用AVScreenCaptureRecorder录屏写文件(ArkTS)"> 使用AVScreenCaptureRecorder录屏写文件(ArkTS) </h1>

<div _ngcontent-xsr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>屏幕录制主要为主屏幕录屏功能。</p>    <p>开发者可以调用录屏（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avscreencapture">AVScreenCaptureRecorder</a>）模块的ArkTs接口，完成屏幕录制，采集设备内、麦克风等的音视频源数据。可以调用录屏模块获取音视频文件，然后通过文件的形式流转到其他模块进行播放或处理，达成文件形式分享屏幕内容的场景。</p>    <p>录屏模块和窗口（Window）、图形（Graphic）等模块协同完成整个视频采集的流程。</p>    <p>使用AVScreenCaptureRecorder录制屏幕涉及到AVScreenCaptureRecorder实例的创建、音视频采集参数的配置、采集的开始与停止、资源的释放等。</p>    <p>开始屏幕录制时正在通话中或者屏幕录制过程中来电，录屏将自动停止。因通话中断的录屏会上报SCREENCAPTURE_STATE_STOPPED_BY_CALL状态。</p>    <p>本开发指导将以完成一次屏幕数据录制的过程为例，向开发者讲解如何使用AVScreenCaptureRecorder进行屏幕录制，详细的API声明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avscreencapturerecorder" target="_blank">AVScreenCaptureRecorder API参考</a>。</p>    <p>如果配置了采集麦克风音频数据，需对应配置麦克风权限ohos.permission.MICROPHONE和申请长时任务，配置方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请权限</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task">申请长时任务</a>。</p>    <div class="tiledSection">     <h2 id="申请权限">申请权限<i class="anchor-icon anchor-icon-link" anchorid="申请权限" tips="复制节点链接"></i></h2>          <p>在开发此功能前，开发者应根据实际需求申请相关权限：</p>     <ul>      <li>当需要使用麦克风时，需要申请<strong>ohos.permission.MICROPHONE</strong>麦克风权限。申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>      <li>当需要读取图片或视频文件时，请优先使用媒体库<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-photoviewpicker">Picker选择媒体资源</a>。</li>      <li>当需要保存图片或视频文件时，请优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">安全控件保存媒体资源</a>。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>仅应用需要克隆、备份或同步用户公共目录的图片、视频类文件时，可申请ohos.permission.READ_IMAGEVIDEO、ohos.permission.WRITE_IMAGEVIDEO权限来读写音频文件，申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请受控权限</a>，通过AGC审核后才能使用。为避免应用的上架申请被驳回，开发者应优先使用Picker/控件等替代方案，仅少量符合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_imagevideo">特殊场景</a>的应用被允许申请受限权限。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>使用AVScreenCaptureRecorder时要明确其状态的变化，在创建实例后，调用对应的方法可以进入指定的状态实现对应的行为。在确定的状态下执行不合适的方法会导致AVScreenCaptureRecorder发生错误，开发者需要在调用状态转换的方法前进行状态检查，避免程序运行异常。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建AVScreenCaptureRecorder类型的成员变量screenCapture。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 声明一个AVScreenCaptureRecorder类型的变量。</span></li><li>private screenCapture?: media.<span class="hljs-property">AVScreenCaptureRecorder</span>;</li><li><span class="hljs-comment">// 创建一个AVScreenCaptureRecorder，并赋值给screenCapture成员变量。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVScreenCaptureRecorder</span>();</li></ol></pre></div></div></li>      <li>       <p>对成员变量screenCapture设置监听函数，分别监听不同状态和异常情况。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">infoType</span>: media.<span class="hljs-property">AVScreenCaptureStateCode</span>) =&gt; {</li><li>    <span class="hljs-keyword">switch</span> (infoType) {</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STARTED</span>:</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏成功开始后会收到的回调"</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_CANCELED</span>:</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-literal">undefined</span>;</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"不允许使用录屏功能"</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_USER</span>:</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-literal">undefined</span>;</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"通过录屏胶囊结束录屏，底层录制会停止"</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_INTERRUPTED_BY_OTHER</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏因其他中断而停止，底层录制会停止"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_CALL</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏过程因通话中断，底层录制会停止"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_UNAVAILABLE</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风不可用"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_MUTED_BY_USER</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风被用户静音"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_UNMUTED_BY_USER</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风被用户取消静音"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_ENTER_PRIVATE_SCENE</span>:</li><li>            <span class="hljs-comment">// 目前可以从系统直接注册监听到进入隐私场景。</span></li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏进入隐私场景"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_EXIT_PRIVATE_SCENE</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏退出隐私场景"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_USER_SWITCHES</span>:</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户账号切换，底层录制会停止"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>              <span class="hljs-keyword">break</span>;</li><li>    }</li><li>})</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`处理异常情况, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>配置屏幕录制参数。</p>       <p>​创建AVScreenCaptureRecorder实例screenCapture后，可以设置屏幕录制所需要的参数。</p>       <p>​参数videoBitrate、audioSampleRate、audioChannelCount、audioBitrate、preset、displayId为可选参数，若不设置则可按默认值进行设置，如下示例中提供了可选参数的默认值。麦克风和系统音的音频流共用一套音频参数，分别是音频采样率、音频通道数和音频比特率，对应audioSampleRate、audioChannelCount和audioBitrate参数。</p>       <p>参数fd可以参考应用文件访问与管理的开发实例<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">新建并读写一个文件fd</a>。本示例中提供的getFileFd()仅作为参考。</p>       <p>2in1设备配置displayId为扩展屏Id，可拉起录屏窗口选择界面，用户在界面上选择录屏内容，最终录屏内容以用户在弹窗界面上的选择为准。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">filePath</span>: string = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/screenCapture.mp4'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">captureFile</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li><span class="hljs-keyword">if</span> (!captureFile) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理异常情况"</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-attr">captureConfig</span>: media.<span class="hljs-property">AVScreenCaptureRecordConfig</span> = {</li><li>    <span class="hljs-comment">// 开发者可以根据自身的需要设置宽高。</span></li><li>    <span class="hljs-attr">frameWidth</span>: <span class="hljs-number">768</span>,</li><li>    <span class="hljs-attr">frameHeight</span>: <span class="hljs-number">1280</span>,</li><li>    <span class="hljs-comment">// 参考应用文件访问与管理开发示例新建并读写一个文件fd。</span></li><li>    <span class="hljs-attr">fd</span>: captureFile.<span class="hljs-property">fd</span>,</li><li>    <span class="hljs-comment">// 可选参数及其默认值。</span></li><li>    <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">10000000</span>,</li><li>    <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>,</li><li>    <span class="hljs-attr">audioChannelCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">96000</span>,</li><li>    <span class="hljs-attr">displayId</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">preset</span>: media.<span class="hljs-property">AVScreenCaptureRecordPreset</span>.<span class="hljs-property">SCREEN_RECORD_PRESET_H264_AAC_MP4</span></li><li>};</li></ol></pre></div></div></li>      <li>       <p>基于预先配置的屏幕录制参数，调用init()方法初始化screenCapture。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureConfig</span>);</li></ol></pre></div></div></li>      <li>       <p>创建豁免隐私窗口，这里填写的是子窗口id和主窗口id，具体开发步骤可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-i#windowproperties" target="_blank">窗口API</a>。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> windowIDs = [<span class="hljs-number">57</span>, <span class="hljs-number">86</span>];</li><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">skipPrivacyMode</span>(windowIDs);</li></ol></pre></div></div></li>      <li>       <p>调用startRecording()方法开始进行屏幕录制，并通过监听函数监听状态。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">startRecording</span>();</li></ol></pre></div></div></li>      <li>       <p>停止录屏。</p>       <ul>        <li>         <p>点击录屏胶囊中的结束按钮停止录制：基于回调函数实现，录屏对象实例screenCapture会触发SCREENCAPTURE_STATE_STOPPED_BY_USER的回调，通知应用此次录屏已停止，不需要开发者主动调用stopRecording()方法。</p></li>        <li>         <p>应用主动调用stopRecording()方法，停止录屏。</p>         <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">stopRecording</span>();</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>调用release()方法销毁实例，释放资源。</p>       <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>.<span class="hljs-title function_">release</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>以下是通过AVScreenCaptureRecorder实现录屏存文件的完整代码示例。</p>     <div _ngcontent-xsr-c106="" class="highlight-div"><div _ngcontent-xsr-c106="" class="highlight-div-header"><div _ngcontent-xsr-c106="" class="highlight-div-header-left"><div _ngcontent-xsr-c106="" class="handle-button expand-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xsr-c106="" class="highlight-div-header-right"><div _ngcontent-xsr-c106="" class="handle-button ai-button"></div><div _ngcontent-xsr-c106="" class="handle-button line-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xsr-c106="" class="handle-button theme-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xsr-c106="" class="handle-button copy-button"><div _ngcontent-xsr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xsr-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVScreenCaptureDemo</span> {</li><li>  private screenCapture?: media.<span class="hljs-property">AVScreenCaptureRecorder</span>;</li><li>  private <span class="hljs-attr">captureFile</span>: fs.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  private <span class="hljs-attr">captureConfig</span>: media.<span class="hljs-property">AVScreenCaptureRecordConfig</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  private <span class="hljs-title function_">openFile</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">path</span>: string = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/screenCapture.mp4'</span>; <span class="hljs-comment">// 文件沙箱路径，文件后缀名应与封装格式对应。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span> = fs.<span class="hljs-title function_">openSync</span>(path, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  }</li><li>
</li><li>  private <span class="hljs-title function_">closeFile</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    fs.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span>);</li><li>  }</li><li>
</li><li>  private <span class="hljs-title function_">setConfig</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureConfig</span> = {</li><li>        <span class="hljs-comment">// 开发者可以根据自身的需要设置宽高。</span></li><li>        <span class="hljs-attr">frameWidth</span>: <span class="hljs-number">768</span>,</li><li>        <span class="hljs-attr">frameHeight</span>: <span class="hljs-number">1280</span>,</li><li>        <span class="hljs-comment">// 参考应用文件访问与管理开发示例新建并读写一个文件fd。</span></li><li>        <span class="hljs-attr">fd</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span>.<span class="hljs-property">fd</span>,</li><li>        <span class="hljs-comment">// 可选参数及其默认值。</span></li><li>        <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">10000000</span>,</li><li>        <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>,</li><li>        <span class="hljs-attr">audioChannelCount</span>: <span class="hljs-number">2</span>,</li><li>        <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">96000</span>,</li><li>        <span class="hljs-attr">displayId</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">preset</span>: media.<span class="hljs-property">AVScreenCaptureRecordPreset</span>.<span class="hljs-property">SCREEN_RECORD_PRESET_H264_AAC_MP4</span></li><li>      };</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注册screenCapture回调函数。</span></li><li>  private <span class="hljs-title function_">registerScreenCaptureCallback</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">infoType</span>: media.<span class="hljs-property">AVScreenCaptureStateCode</span>) =&gt; {</li><li>      <span class="hljs-keyword">switch</span> (infoType) {</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STARTED</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏成功开始后会收到的回调"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_CANCELED</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-literal">undefined</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"不允许使用录屏功能"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_USER</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-literal">undefined</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"通过录屏胶囊结束录屏，底层录制会停止"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_INTERRUPTED_BY_OTHER</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏因其他中断而停止，底层录制会停止"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_CALL</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏过程因通话中断，底层录制会停止"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_UNAVAILABLE</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风不可用"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_MUTED_BY_USER</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风被用户静音"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_MIC_UNMUTED_BY_USER</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏麦克风被用户取消静音"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_ENTER_PRIVATE_SCENE</span>:</li><li>          <span class="hljs-comment">// 目前可以从系统直接注册监听到进入隐私场景。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏进入隐私场景"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_EXIT_PRIVATE_SCENE</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"录屏退出隐私场景"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> media.<span class="hljs-property">AVScreenCaptureStateCode</span>.<span class="hljs-property">SCREENCAPTURE_STATE_STOPPED_BY_USER_SWITCHES</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户账号切换，底层录制会停止"</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    })</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`处理异常情况, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 取消注册screenCapture回调函数。</span></li><li>  private <span class="hljs-title function_">unRegisterScreenCaptureCallback</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'error'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 调用startRecording方法可以开始一次录屏存文件的流程，结束录屏可以通过点击录屏胶囊停止按钮进行操作。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">startRecording</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVScreenCaptureRecorder</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>) {</li><li>      <span class="hljs-comment">// failed.</span></li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openFile</span>(context);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureFile</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理异常情况"</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setConfig</span>();</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">captureConfig</span>);</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerScreenCaptureCallback</span>();</li><li>    <span class="hljs-comment">// 豁免隐私窗口。</span></li><li>    <span class="hljs-keyword">let</span> windowIDs = [<span class="hljs-number">57</span>, <span class="hljs-number">86</span>];</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">skipPrivacyMode</span>(windowIDs);</li><li>
</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">startRecording</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 可以主动调用stopRecording方法来停止录屏。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopRecording</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>) {</li><li>      <span class="hljs-comment">// Error.</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closeFile</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">stopRecording</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unRegisterScreenCaptureCallback</span>();</li><li>    <span class="hljs-comment">// 调用release()方法销毁实例，释放资源。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>
</li><li>    <span class="hljs-comment">// 最后需要关闭创建的录屏文件;</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closeFile</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>