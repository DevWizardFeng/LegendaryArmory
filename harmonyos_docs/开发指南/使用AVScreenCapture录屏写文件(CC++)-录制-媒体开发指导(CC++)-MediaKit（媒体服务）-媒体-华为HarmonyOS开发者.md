<h1 _ngcontent-epv-c119="" class="doc-title ng-star-inserted" title="使用AVScreenCapture录屏写文件(C/C++)"> 使用AVScreenCapture录屏写文件(C/C++) </h1>

<div _ngcontent-epv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>屏幕录制主要为主屏幕录屏功能。</p>    <p>开发者可以调用录屏（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avscreencapture">AVScreenCapture</a>）模块的C API接口，完成屏幕录制，采集设备内、麦克风等的音视频源数据。可以调用录屏模块获取音视频文件，然后通过文件的形式流转到其他模块进行播放或处理，达成文件形式分享屏幕内容的场景。</p>    <p>录屏模块和窗口（Window）、图形（Graphic）等模块协同完成整个视频采集的流程。</p>    <p>使用AVScreenCapture录制屏幕涉及到AVScreenCapture实例的创建、音视频采集参数的配置、采集的开始与停止、资源的释放等。</p>    <p>开始屏幕录制时正在通话中或者屏幕录制过程中来电，录屏将自动停止。因通话中断的录屏会上报OH_SCREEN_CAPTURE_STATE_STOPPED_BY_CALL状态。</p>    <p>屏幕录制过程中发生系统用户切换事件时，录屏将自动停止。因系统用户切换中断的录屏会上报OH_SCREEN_CAPTURE_STATE_STOPPED_BY_USER_SWITCHES状态。</p>    <p>本开发指导将以完成一次屏幕数据录制的过程为例，向开发者讲解如何使用AVScreenCapture进行屏幕录制，详细的API声明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture" target="_blank">AVScreenCapture API参考</a>。</p>    <p>如果配置了采集麦克风音频数据，需对应配置麦克风权限ohos.permission.MICROPHONE和申请长时任务，配置方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请权限</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task">申请长时任务</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>使用AVScreenCapture时要明确其状态的变化，在创建实例后，调用对应的方法可以进入指定的状态实现对应的行为。</p>     <p>在确定的状态下执行不合适的方法会导致AVScreenCapture发生错误，开发者需要在调用状态转换的方法前进行状态检查，避免程序运行异常。</p>     <p><strong>在 CMake 脚本中链接动态库</strong></p>     <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libnative_avscreen_capture.so)</li></ol></pre></div></div>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_errors.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建AVScreenCapture实例capture。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>OH_AVScreenCapture* capture = OH_AVScreenCapture_Create();</li></ol></pre></div></div></li>      <li>       <p>配置屏幕录制参数。</p>       <p>创建AVScreenCapture实例capture后，可以设置屏幕录制所需要的参数。</p>       <p>其中，录屏存文件时默认录制内录，麦克风可以动态开关，可以同时内外录制。</p>       <p>同时，录屏存文件需要设置状态回调，感知录制状态。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 录屏时获取麦克风或者内录，内录参数必填，如果都设置了，内录和麦克风的参数设置需要一致。</span></li><li><span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">micCapInfo</span> <span class="hljs-operator">=</span> {</li><li>    .audioSampleRate = <span class="hljs-number">48000</span>,</li><li>    .audioChannels = <span class="hljs-number">2</span>,</li><li>    .audioSource = OH_MIC</li><li>};</li><li>
</li><li><span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">innerCapInfo</span> <span class="hljs-operator">=</span> {</li><li>    .audioSampleRate = <span class="hljs-number">48000</span>,</li><li>    .audioChannels = <span class="hljs-number">2</span>,</li><li>    .audioSource = OH_ALL_PLAYBACK</li><li>};</li><li>
</li><li><span class="hljs-type">OH_AudioEncInfo</span> <span class="hljs-variable">audioEncInfo</span> <span class="hljs-operator">=</span> {</li><li>    .audioBitrate = <span class="hljs-number">48000</span>,</li><li>    .audioCodecformat = OH_AAC_LC</li><li>};</li><li>
</li><li><span class="hljs-type">OH_VideoCaptureInfo</span> <span class="hljs-variable">videoCapInfo</span> <span class="hljs-operator">=</span> {</li><li>    .videoFrameWidth = <span class="hljs-number">768</span>,</li><li>    .videoFrameHeight = <span class="hljs-number">1280</span>,</li><li>    .videoSource = OH_VIDEO_SOURCE_SURFACE_RGBA</li><li>};</li><li>
</li><li><span class="hljs-type">OH_VideoEncInfo</span> <span class="hljs-variable">videoEncInfo</span> <span class="hljs-operator">=</span> {</li><li>    .videoCodec = OH_H264,</li><li>    .videoBitrate = <span class="hljs-number">2000000</span>,</li><li>    .videoFrameRate = <span class="hljs-number">30</span></li><li>};</li><li>
</li><li><span class="hljs-type">OH_AudioInfo</span> <span class="hljs-variable">audioInfo</span> <span class="hljs-operator">=</span> {</li><li>    .innerCapInfo = innerCapInfo,</li><li>    .audioEncInfo = audioEncInfo</li><li>};</li><li>
</li><li><span class="hljs-type">OH_VideoInfo</span> <span class="hljs-variable">videoInfo</span> <span class="hljs-operator">=</span> {</li><li>    .videoCapInfo = videoCapInfo,</li><li>    .videoEncInfo = videoEncInfo</li><li>};</li><li>
</li><li>config = {</li><li>    .captureMode = OH_CAPTURE_HOME_SCREEN,</li><li>    .dataType = OH_CAPTURE_FILE,</li><li>    .audioInfo = audioInfo,</li><li>    .videoInfo = videoInfo,</li><li>};</li><li>
</li><li>OH_AVScreenCapture_Init(capture, config);</li></ol></pre></div></div></li>      <li>       <p>调用StartScreenRecording()方法开始进行屏幕录制。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVScreenCapture_StartScreenRecording</span>(capture);</li></ol></pre></div></div></li>      <li>       <p>调用StopScreenRecording()方法停止录制。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVScreenCapture_StopScreenRecording</span>(capture);</li></ol></pre></div></div></li>      <li>       <p>调用Release()方法销毁实例，释放资源。</p>       <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVScreenCapture_Release</span>(capture);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>下面展示了使用AVScreenCapture屏幕录制存文件的完整示例代码。</p>     <div _ngcontent-epv-c106="" class="highlight-div"><div _ngcontent-epv-c106="" class="highlight-div-header"><div _ngcontent-epv-c106="" class="highlight-div-header-left"><div _ngcontent-epv-c106="" class="handle-button expand-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-epv-c106="" class="highlight-div-header-right"><div _ngcontent-epv-c106="" class="handle-button ai-button"></div><div _ngcontent-epv-c106="" class="handle-button line-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-epv-c106="" class="handle-button theme-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-epv-c106="" class="handle-button copy-button"><div _ngcontent-epv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-epv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_errors.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">int32_t</span> outputFd;</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_AVScreenCapture</span>* capture;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnStateChange</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_AVScreenCapture *capture, OH_AVScreenCaptureStateCode stateCode, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    </li><li>    <span class="hljs-keyword">if</span> (stateCode == OH_SCREEN_CAPTURE_STATE_STARTED) {</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (stateCode == OH_SCREEN_CAPTURE_STATE_STOPPED_BY_CALL ||</li><li>        stateCode == OH_SCREEN_CAPTURE_STATE_STOPPED_BY_USER_SWITCHES) {</li><li>        <span class="hljs-comment">// 录屏中断状态处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (stateCode == OH_SCREEN_CAPTURE_STATE_INTERRUPTED_BY_OTHER) {</li><li>        <span class="hljs-comment">// 处理状态变更。</span></li><li>    }</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取录屏屏幕id的回调函数OnDisplaySelected()。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnDisplaySelected</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_AVScreenCapture *capture, <span class="hljs-type">uint64_t</span> displayId, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    (<span class="hljs-type">void</span>)displayId;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 录屏内容变更回调函数OnCaptureContentChanged()。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnCaptureContentChanged</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_AVScreenCapture *capture, OH_AVScreenCaptureContentChangedEvent event, OH_Rect *area, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    <span class="hljs-keyword">if</span> (event == OH_SCREEN_CAPTURE_CONTENT_HIDE) {</li><li>        <span class="hljs-comment">// 处理录屏内容变为隐藏。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (event == OH_SCREEN_CAPTURE_CONTENT_VISIBLE) {</li><li>        <span class="hljs-comment">// 处理录屏内容变为可见。</span></li><li>        <span class="hljs-comment">// 录屏内容变为可见时，可通过回调回传的area参数，获取窗口的位置信息。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (event == OH_SCREEN_CAPTURE_CONTENT_UNAVAILABLE) {</li><li>        <span class="hljs-comment">// 处理录屏内容变为不可用，如录屏窗口关闭。</span></li><li>    }</li><li>    (<span class="hljs-type">void</span>)area;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 手工确认页面用户选择结果的回调函数OnUserSelected()。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnUserSelected</span><span class="hljs-params">(OH_AVScreenCapture* capture, OH_AVScreenCapture_UserSelectionInfo* selections, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    <span class="hljs-type">int</span>* selectType = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>;</li><li>    <span class="hljs-type">uint64_t</span>* displayId = <span class="hljs-keyword">new</span> <span class="hljs-type">uint64_t</span>;</li><li>
</li><li>    <span class="hljs-comment">// 通过获取接口，拿到对应的选择类型和屏幕Id。OH_AVScreenCapture_UserSelectionInfo* selections仅在OnUserSelected回调中有效。</span></li><li>    OH_AVSCREEN_CAPTURE_ErrCode errorSelectType = <span class="hljs-built_in">OH_AVScreenCapture_GetCaptureTypeSelected</span>(selections, selectType);</li><li>    OH_AVSCREEN_CAPTURE_ErrCode errorDisplayId = <span class="hljs-built_in">OH_AVScreenCapture_GetDisplayIdSelected</span>(selections, displayId);</li><li>
</li><li>    <span class="hljs-comment">// 在使用完成后，对申请的内存进行释放</span></li><li>    <span class="hljs-keyword">delete</span> selectType, displayId;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开始录屏时调用StartScreenCapture。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StartScreenCapture</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    OH_AVScreenCaptureConfig config;</li><li>    OH_AudioCaptureInfo micCapInfo = {</li><li>        .audioSampleRate = <span class="hljs-number">48000</span>,</li><li>        .audioChannels = <span class="hljs-number">2</span>,</li><li>        .audioSource = OH_MIC</li><li>    };</li><li>
</li><li>    OH_AudioCaptureInfo innerCapInfo = {</li><li>        .audioSampleRate = <span class="hljs-number">48000</span>,</li><li>        .audioChannels = <span class="hljs-number">2</span>,</li><li>        .audioSource = OH_ALL_PLAYBACK</li><li>    };</li><li>
</li><li>    OH_AudioEncInfo audioEncInfo = {</li><li>        .audioBitrate = <span class="hljs-number">48000</span>,</li><li>        .audioCodecformat = OH_AudioCodecFormat::OH_AAC_LC</li><li>    };</li><li>
</li><li>    OH_VideoCaptureInfo videoCapInfo = {</li><li>        .videoFrameWidth = <span class="hljs-number">768</span>,</li><li>        .videoFrameHeight = <span class="hljs-number">1280</span>,</li><li>        .videoSource = OH_VIDEO_SOURCE_SURFACE_RGBA</li><li>    };</li><li>
</li><li>    OH_VideoEncInfo videoEncInfo = {</li><li>        .videoCodec = OH_VideoCodecFormat::OH_H264,</li><li>        .videoBitrate = <span class="hljs-number">2000000</span>,</li><li>        .videoFrameRate = <span class="hljs-number">30</span></li><li>    };</li><li>
</li><li>    OH_AudioInfo audioInfo = {</li><li>        .micCapInfo = micCapInfo,</li><li>        .innerCapInfo = innerCapInfo,</li><li>        .audioEncInfo = audioEncInfo</li><li>    };</li><li>
</li><li>    OH_VideoInfo videoInfo = {</li><li>        .videoCapInfo = videoCapInfo,</li><li>        .videoEncInfo = videoEncInfo</li><li>    };</li><li>
</li><li>    config = {</li><li>        .captureMode = OH_CAPTURE_HOME_SCREEN,</li><li>        .dataType = OH_CAPTURE_FILE,</li><li>        .audioInfo = audioInfo,</li><li>        .videoInfo = videoInfo,</li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 实例化ScreenCapture。</span></li><li>    capture = <span class="hljs-built_in">OH_AVScreenCapture_Create</span>();</li><li>
</li><li>    <span class="hljs-comment">// 初始化录屏参数，传入配置信息OH_AVScreenRecorderConfig。</span></li><li>    OH_RecorderInfo recorderInfo;</li><li>    <span class="hljs-type">const</span> std::string SCREEN_CAPTURE_ROOT = <span class="hljs-string">"/data/storage/el2/base/files/"</span>;</li><li>    outputFd = <span class="hljs-built_in">open</span>((SCREEN_CAPTURE_ROOT + <span class="hljs-string">"screen01.mp4"</span>).<span class="hljs-built_in">c_str</span>(), O_RDWR | O_CREAT, <span class="hljs-number">0777</span>);</li><li>
</li><li>    <span class="hljs-comment">// 处理打开失败或创建失败的情况，返回报错结果。</span></li><li>    <span class="hljs-keyword">if</span> (outputFd == <span class="hljs-number">-1</span>) {</li><li>        napi_value errCode;</li><li>        <span class="hljs-built_in">napi_create_double</span>(env, AV_SCREEN_CAPTURE_ERR_IO, &amp;errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    std::string fileUrl = <span class="hljs-string">"fd://"</span> + std::<span class="hljs-built_in">to_string</span>(outputFd);</li><li>    recorderInfo.url = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(fileUrl.<span class="hljs-built_in">c_str</span>());</li><li>    recorderInfo.fileFormat = OH_ContainerFormatType::CFT_MPEG_4;</li><li>    config.recorderInfo = recorderInfo;</li><li>
</li><li>    <span class="hljs-comment">// 设置状态回调。</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetStateCallback</span>(capture, OnStateChange, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 可选，设置录屏内容变化回调。</span></li><li>    OH_Rect* area = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetCaptureContentChangedCallback</span>(capture, OnCaptureContentChanged, area);</li><li>
</li><li>    <span class="hljs-comment">// 可选，设置隐私窗口屏蔽模式。</span></li><li>    <span class="hljs-type">int</span> value = <span class="hljs-number">0</span>;</li><li>    OH_AVScreenCapture_CaptureStrategy* strategy = <span class="hljs-built_in">OH_AVScreenCapture_CreateCaptureStrategy</span>();</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_StrategyForPrivacyMaskMode</span>(strategy, value);</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetCaptureStrategy</span>(capture, strategy);</li><li>
</li><li>    <span class="hljs-comment">// 可选，设置录屏屏幕Id回调，必须在开始录屏前调用。</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetDisplayCallback</span>(capture, OnDisplaySelected, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 可选 设置手工确认页面用户选择结果的回调，必须在开始录屏前调用。</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetSelectionCallback</span>(capture, OnUserSelected, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 可选，设置光标显示开关，开始录屏前后均可调用。</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_ShowCursor</span>(capture, <span class="hljs-literal">false</span>);</li><li>
</li><li>    <span class="hljs-comment">// 进行初始化操作。</span></li><li>    <span class="hljs-type">int32_t</span> retInit = <span class="hljs-built_in">OH_AVScreenCapture_Init</span>(capture, config);</li><li>
</li><li>    <span class="hljs-comment">// 可选（API version 20开始支持）：可以根据需要设置区域坐标和大小，设置想要捕获的区域，如下方创建了一个从（0，0）为起点的长100，宽100的矩形区域。此接口也可以在开始录屏以后设置。</span></li><li>    OH_Rect* region = <span class="hljs-keyword">new</span> OH_Rect;</li><li>    region-&gt;x = <span class="hljs-number">0</span>;</li><li>    region-&gt;y = <span class="hljs-number">0</span>;</li><li>    region-&gt;width = <span class="hljs-number">100</span>;</li><li>    region-&gt;height = <span class="hljs-number">100</span>;</li><li>    <span class="hljs-type">uint64_t</span> regionDisplayId = <span class="hljs-number">0</span>; <span class="hljs-comment">// 传入矩形区域所在的屏幕Id。</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetCaptureArea</span>(capture, regionDisplayId, region);</li><li>    </li><li>    <span class="hljs-comment">// 对申请的内存进行释放。</span></li><li>    <span class="hljs-keyword">delete</span> region;</li><li>
</li><li>    <span class="hljs-comment">// 开始录屏。</span></li><li>    <span class="hljs-type">int32_t</span> retStart = <span class="hljs-built_in">OH_AVScreenCapture_StartScreenRecording</span>(capture);</li><li>
</li><li>    <span class="hljs-comment">// 开始录屏失败的情况处理，返回报错结果。</span></li><li>    <span class="hljs-keyword">if</span> (retStart != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>        napi_value errCode;</li><li>        <span class="hljs-built_in">napi_create_double</span>(env, retStart, &amp;errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 结束录屏见StopScreenCapture。</span></li><li>    </li><li>    <span class="hljs-comment">// 返回调用结果，示例仅返回随意值。</span></li><li>    napi_value code;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, AV_SCREEN_CAPTURE_ERR_OK, &amp;code);</li><li>
</li><li>    <span class="hljs-keyword">return</span> code;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 结束录屏时调用StopScreenCapture。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StopScreenCapture</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (capture != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-comment">// 结束录屏。</span></li><li>        <span class="hljs-type">int32_t</span> retStop = <span class="hljs-built_in">OH_AVScreenCapture_StopScreenRecording</span>(capture);</li><li>
</li><li>        <span class="hljs-comment">// 关闭文件访问</span></li><li>        <span class="hljs-built_in">close</span>(outputFd);</li><li>
</li><li>        <span class="hljs-comment">// 结束录屏失败的情况处理，返回报错结果。</span></li><li>        <span class="hljs-keyword">if</span> (retStop != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>            napi_value errCode;</li><li>            <span class="hljs-built_in">napi_create_double</span>(env, retStop, &amp;errCode);</li><li>            <span class="hljs-keyword">return</span> errCode;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 释放ScreenCapture。</span></li><li>        <span class="hljs-type">int32_t</span> retRelease = <span class="hljs-built_in">OH_AVScreenCapture_Release</span>(capture);</li><li>
</li><li>        <span class="hljs-comment">// 释放ScreenCapture失败情况下处理，返回报错结果。</span></li><li>        <span class="hljs-keyword">if</span> (retRelease != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>            napi_value errCode;</li><li>            <span class="hljs-built_in">napi_create_double</span>(env, retRelease, &amp;errCode);</li><li>            <span class="hljs-keyword">return</span> errCode;</li><li>        }</li><li>
</li><li>        capture = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 返回成功结果。</span></li><li>    napi_value code;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, AV_SCREEN_CAPTURE_ERR_OK, &amp;code);</li><li>
</li><li>    <span class="hljs-keyword">return</span> code;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"startScreenCapture"</span>, <span class="hljs-literal">nullptr</span>, StartScreenCapture, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"stopScreenCapture"</span>, <span class="hljs-literal">nullptr</span>, StopScreenCapture, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule); }</li></ol></pre></div></div>    </div>   </div>   <div></div></div>