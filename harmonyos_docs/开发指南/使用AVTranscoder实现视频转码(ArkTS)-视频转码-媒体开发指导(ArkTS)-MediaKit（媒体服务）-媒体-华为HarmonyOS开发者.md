<h1 _ngcontent-frd-c119="" class="doc-title ng-star-inserted" title="使用AVTranscoder实现视频转码(ArkTS)"> 使用AVTranscoder实现视频转码(ArkTS) </h1>

<div _ngcontent-frd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avtranscoder">AVTranscoder</a>可以实现视频转码功能，从API 20开始支持视频转码的C/C++开发，转码功能可在手机、平板、2in1设备上作为系统提供的基础能力使用。可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-syscap#caniuse" target="_blank">canIUse</a>接口来判断当前设备是否支持AVTranscoder，当canIUse("SystemCapability.Multimedia.Media.AVTranscoder")的返回值为true时，表示可以使用转码能力。</p>    <p>本开发指导将以“开始转码-暂停转码-恢复转码-转码完成”的一次流程为示例，向开发者讲解AVTranscoder视频转码相关功能。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avtranscoder" target="_blank">AVTranscoder API参考</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>如需对转码后的文件进行转发、上传、转存等处理，应用须收到complete事件后调用系统接口await avTranscoder.release()，以保证视频文件完整性。</p>      </div></div></div>     <ol>      <li>       <p>创建AVTranscoder实例。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-comment">// 创建转码实例。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li></ol></pre></div></div></li>      <li>       <p>设置业务需要的监听事件，监听状态变化及错误上报。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.3.4.2.2.1.3.1.1" valign="top" width="50%">事件类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.3.4.2.2.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">complete</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听AVTranscoder的转码完成。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">error</td>           <td class="cellrowborder" valign="top" width="50%">必要事件，监听AVTranscoder的错误信息。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">progressUpdate</td>           <td class="cellrowborder" valign="top" width="50%">监听AVTranscoder的进度。</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">currentProgress</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 创建转码实例。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-comment">// 转码完成回调函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVTranscoder is completed`</span>);</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseTranscoderingProcess</span>();</li><li>    });</li><li>    <span class="hljs-comment">// 错误上报回调函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVTranscoder failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// 进度上报回调函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progressUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">progress: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVTranscoder progressUpdate = <span class="hljs-subst">${progress}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentProgress</span> = progress;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取当前进度。</span></li><li><span class="hljs-title function_">getCurrentProgress</span>(): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`getCurrentProgress = <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentProgress}</span>`</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentProgress</span>;</li><li>}</li><li><span class="hljs-comment">// 释放转码流程。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Multimedia.Media.AVTranscoder'</span>)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 1.释放转码实例。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-literal">undefined</span>;</li><li>      <span class="hljs-comment">// 2.关闭转码目标文件fd。</span></li><li>      fs.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>!.<span class="hljs-property">fdDst</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li></ol></pre></div></div></li>      <li>       <p>设置源视频文件fd：设置属性fdSrc。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>下面代码示例中的fdSrc仅作示意使用，开发者需根据实际情况，确认资源有效性并设置：</p>         <ul>          <li>           <p>如果使用本地资源转码，必须确认资源文件可用，并使用应用沙箱路径访问对应资源，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径">获取应用文件路径</a>。应用沙箱的介绍及如何向应用沙箱推送文件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory">文件管理</a>。</p></li>          <li>           <p>应通过Context属性获取应用文件路径，建议使用getUIContext获取UIContext实例，并使用getHostContext调用绑定实例的getContext，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#gethostcontext12" target="_blank">获取Context</a>。</p></li>          <li>           <p>如果使用ResourceManager.getRawFd()打开HAP资源文件描述符，使用方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfd9" target="_blank">ResourceManager API参考</a>。</p></li>         </ul>        </div></div></div>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入来自于ets/transcoder/AVTranscoderManager.ets文件。</span></li><li><span class="hljs-keyword">import</span> {<span class="hljs-title class_">AVTranscoderDemo</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../transcoder/AVTranscoderManager'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// 获取当前组件所在Ability的Context，以通过Context获取应用文件路径。</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>:<span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>();</li><li>  <span class="hljs-comment">// 获取转码功能管理类。</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">avTranscoder</span>: <span class="hljs-title class_">AVTranscoderDemo</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVTranscoderDemo</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) : <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>($r(<span class="hljs-string">'app.string.StartTranscoder'</span>)) <span class="hljs-comment">// 来自于resources/base/element/string.json文件中的name:StartTranscoder的值。</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Button put`</span>);</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>?.<span class="hljs-title function_">avTranscoderDemo</span>();</li><li>          })</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'AVTranscoderButton'</span>)</li><li>          <span class="hljs-comment">// 获取转码进度。</span></li><li>          <span class="hljs-title class_">Progress</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">total</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ProgressType</span>.<span class="hljs-property">Linear</span> }).<span class="hljs-title function_">value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>?.<span class="hljs-title function_">getCurrentProgress</span>())</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>        <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-title function_">constructor</span>(<span class="hljs-params">context: Context | <span class="hljs-literal">undefined</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = context; <span class="hljs-comment">// this.getUIContext().getHostContext();。</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 创建转码实例。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>  <span class="hljs-comment">// 获取输入文件fd，H264_AAC.mp4为rawfile目录下的预置资源，需要开发者根据实际情况进行替换。</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'H264_AAC.mp4'</span>);</li><li>    <span class="hljs-comment">// 设置转码的源文件属性fdSrc。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-property">fdSrc</span> = fileDescriptor;</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置目标视频文件fd：设置属性fdDst。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>转码输出文件fd（即示例里fdDst），形式为number。需要调用基础文件操作接口（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">Core File Kit的ohos.file.fs</a>）实现应用文件访问能力，获取方式参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问与管理</a>。</p>        </div></div></div>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-title function_">constructor</span>(<span class="hljs-params">context: Context | <span class="hljs-literal">undefined</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = context; <span class="hljs-comment">// this.getUIContext().getHostContext();。</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 创建转码实例。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-comment">// 设置输出目标文件的沙箱路径。</span></li><li>    <span class="hljs-keyword">let</span> outputFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">filesDir</span> + <span class="hljs-string">"/output.mp4"</span>;</li><li>    <span class="hljs-comment">// 文件不存在时创建并打开文件，文件存在时打开文件。</span></li><li>    <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(outputFilePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>    <span class="hljs-comment">// 设置转码的目标文件属性fdDst。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-property">fdDst</span> = file.<span class="hljs-property">fd</span>; <span class="hljs-comment">// 参考应用文件访问与管理中的开发示例获取创建的视频文件fd填入此处。</span></li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>配置视频转码参数，调用prepare()接口。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>写入配置参数时需要注意，prepare()接口的入参avConfig中仅设置转码相关的配置参数。</p>         <p>受限于解析/封装/编解码能力，只能使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avtranscoder">支持的转码格式</a>。</p>        </div></div></div>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVTranscoderConfig</span> = {</li><li>  <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">100000</span>, <span class="hljs-comment">// 音频比特率。</span></li><li>  <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>, <span class="hljs-comment">// 音频编码格式。</span></li><li>  <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 封装格式。</span></li><li>  <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">2000000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>  <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频编码格式。</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 创建转码实例。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>  <span class="hljs-comment">// 配置转码参数完成准备工作。</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">prepare</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avConfig</span>);</li><li>}</li></ol></pre></div></div>       <p>可在avConfig中设置目标视频的分辨率。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVTranscoderConfig</span> = {</li><li>  <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">100000</span>, <span class="hljs-comment">// 音频比特率。</span></li><li>  <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>, <span class="hljs-comment">// 音频编码格式。</span></li><li>  <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 封装格式。</span></li><li>  <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">2000000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>  <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频编码格式。</span></li><li>  <span class="hljs-attr">videoFrameWidth</span>: <span class="hljs-number">640</span>, <span class="hljs-comment">// 目标视频分辨率的宽为640。</span></li><li>  <span class="hljs-attr">videoFrameHeight</span>: <span class="hljs-number">480</span>, <span class="hljs-comment">// 目标视频分辨率的高为480。</span></li><li>};</li></ol></pre></div></div></li>      <li>       <p>开始转码，调用start()接口。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">startTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Multimedia.Media.AVTranscoder'</span>)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>   <span class="hljs-comment">// 开始转码前需要创建转码实例、设置回调、设置fd并完成prepare。</span></li><li>   <span class="hljs-comment">// 具体创建步骤参考开发步骤1-5。</span></li><li>
</li><li>   <span class="hljs-comment">// 开始转码。</span></li><li>   <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">start</span>();</li><li> }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>暂停转码，调用pause()接口。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 暂停转码对应的流程。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">pauseTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Multimedia.Media.AVTranscoder'</span>)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// 仅在调用start返回后调用pause为合理调用。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">pause</span>();</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>恢复转码，调用resume()接口。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 恢复转码。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">resumeTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Multimedia.Media.AVTranscoder'</span>)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// 仅在调用pause返回后调用resume为合理调用。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">resume</span>();</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁实例，调用release()接口，退出转码。</p>       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁实例。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Multimedia.Media.AVTranscoder'</span>)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 1.销毁实例。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-literal">undefined</span>;</li><li>      <span class="hljs-comment">// 2.关闭转码目标文件fd。</span></li><li>      fs.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>!.<span class="hljs-property">fdDst</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>完整的【开始转码-暂停转码-恢复转码-转码完成】流程</p></li>     </ol>     <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">avTranscoderDemo</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startTranscoderingProcess</span>(); <span class="hljs-comment">// 开始转码。</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseTranscoderingProcess</span>(); <span class="hljs-comment">// 暂停转码。</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resumeTranscoderingProcess</span>(); <span class="hljs-comment">// 恢复转码。</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="运行示例工程">运行示例工程<i class="anchor-icon anchor-icon-link" anchorid="运行示例工程" tips="复制节点链接"></i></h2>          <p>参考以下示例，完成“开始转码-暂停转码-恢复转码-转码完成”的完整流程。</p>     <ol>      <li>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVTranscoder/AVTranscoderArkTS" target="_blank">完整示例工程</a>，并将示例工程的资源复制到对应目录。       <div _ngcontent-frd-c106="" class="highlight-div"><div _ngcontent-frd-c106="" class="highlight-div-header"><div _ngcontent-frd-c106="" class="highlight-div-header-left"><div _ngcontent-frd-c106="" class="handle-button expand-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frd-c106="" class="highlight-div-header-right"><div _ngcontent-frd-c106="" class="handle-button ai-button"></div><div _ngcontent-frd-c106="" class="handle-button line-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frd-c106="" class="handle-button theme-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frd-c106="" class="handle-button copy-button"><div _ngcontent-frd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AVTranscoderArkTS</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>└── pages</li><li>│    └── Index<span class="hljs-selector-class">.ets</span> (转码界面)</li><li>│</li><li>└── transcoder</li><li>    └── AVTranscoderManager<span class="hljs-selector-class">.ets</span> (转码功能)</li><li>
</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│</li><li>└── rawfile</li><li>    └── H264_AAC<span class="hljs-selector-class">.mp4</span> (视频资源)</li></ol></pre></div></div></li>      <li>编译新建工程并运行。</li>     </ol>    </div>   </div>   <div></div></div>