<h1 _ngcontent-qjk-c119="" class="doc-title ng-star-inserted" title="使用AppServiceExtensionAbility组件实现后台服务"> 使用AppServiceExtensionAbility组件实现后台服务 </h1>

<div _ngcontent-qjk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>从API version 20开始，支持开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>组件，为应用提供后台服务能力，其他三方应用可通过启动或连接该AppServiceExtensionAbility组件获取相应的服务。</p>     <p>例如，企业部署的数据防泄漏 (DLP) 软件需要能够长期无界面运行，持续监听文件操作、网络流量，并拦截违规行为，可以使用AppServiceExtensionAbility组件来实现其核心的后台监控服务。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>本文将被启动或被连接的AppServiceExtensionAbility组件称为服务端，将启动或连接AppServiceExtensionAbility组件的应用组件（当前仅支持UIAbility）称为客户端。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="设备限制" class="firsth2">设备限制<i class="anchor-icon anchor-icon-link" anchorid="设备限制" tips="复制节点链接"></i></h3>          <p>AppServiceExtensionAbility组件当前仅支持2in1设备。</p>    </div>    <div class="tiledSection">     <h3 id="规格限制">规格限制<i class="anchor-icon anchor-icon-link" anchorid="规格限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>应用集成AppServiceExtensionAbility组件需要申请ACL权限（ohos.permission.SUPPORT_APP_SERVICE_EXTENSION）。该ACL权限当前只对企业普通应用开放申请。</p></li>      <li>       <p>AppServiceExtensionAbility组件内不支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window" target="_blank">window</a>相关API。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>          <p>开发者可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>中以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#startappserviceextensionability20" target="_blank">启动</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#connectappserviceextensionability20" target="_blank">连接</a>的方式来拉起AppServiceExtensionAbility组件。</p>     <ul>      <li><strong>启动：</strong> 客户端必须为AppServiceExtensionAbility所属应用或者在AppServiceExtensionAbility支持的应用清单（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#extensionabilities标签">extensionAbilities标签</a>的appIdentifierAllowList属性）中的应用才能调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#startappserviceextensionability20" target="_blank">startAppServiceExtensionAbility()</a>接口。</li>      <li><strong>连接：</strong> 如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>实例未启动，客户端必须为AppServiceExtensionAbility所属应用或者在AppServiceExtensionAbility支持的应用清单（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#extensionabilities标签">extensionAbilities标签</a>的appIdentifierAllowList属性）中的应用才能调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#connectappserviceextensionability20" target="_blank">connectAppServiceExtensionAbility()</a>接口。如果实例已启动，则没有上述限制。</li>     </ul>     <p>下表展示了拉起和连接的几种场景：</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>“客户端是否可信”为是时，表示客户端属于服务端所属应用或已配置在appIdentifierAllowList中。为否时，表示客户端不属于服务端所属应用且未配置在appIdentifierAllowList中。</p>      </div></div></div>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.6.1.5.1.1" valign="top" width="25%">客户端操作</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.6.1.5.1.2" valign="top" width="25%">服务端状态</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.6.1.5.1.3" valign="top" width="25%">客户端是否可信</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.6.1.5.1.4" valign="top" width="25%">结果说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="25%">startAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">未启动</td>         <td class="cellrowborder" valign="top" width="25%">是</td>         <td class="cellrowborder" valign="top" width="25%">成功，服务端通过start方式启动，服务端状态变为已启动。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">startAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">未启动</td>         <td class="cellrowborder" valign="top" width="25%">否</td>         <td class="cellrowborder" valign="top" width="25%">失败，客户端不在允许列表中，无法调用启动服务。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">startAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">已启动</td>         <td class="cellrowborder" valign="top" width="25%">是</td>         <td class="cellrowborder" valign="top" width="25%">成功，服务端已经启动，start操作直接返回成功。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">startAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">已启动</td>         <td class="cellrowborder" valign="top" width="25%">否</td>         <td class="cellrowborder" valign="top" width="25%">失败，客户端不在允许列表中，无法调用启动服务。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">connectAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">未启动</td>         <td class="cellrowborder" valign="top" width="25%">是</td>         <td class="cellrowborder" valign="top" width="25%">成功，服务端通过connect方式启动，并建立连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">connectAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">未启动</td>         <td class="cellrowborder" valign="top" width="25%">否</td>         <td class="cellrowborder" valign="top" width="25%">失败，客户端不在允许列表中，无法启动服务端。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">connectAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">已启动</td>         <td class="cellrowborder" valign="top" width="25%">是</td>         <td class="cellrowborder" valign="top" width="25%">成功，服务端已启动，直接建立连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="25%">connectAppServiceExtensionAbility</td>         <td class="cellrowborder" valign="top" width="25%">已启动</td>         <td class="cellrowborder" valign="top" width="25%">否</td>         <td class="cellrowborder" valign="top" width="25%">成功，服务端已启动，直接建立连接。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="实现一个后台服务">实现一个后台服务<i class="anchor-icon anchor-icon-link" anchorid="实现一个后台服务" tips="复制节点链接"></i></h2>          <p>在DevEco Studio工程中手动新建一个AppServiceExtensionAbility组件，具体步骤如下：</p>     <ol>      <li>       <p>在工程Module对应的ets目录下，右键选择“New &gt; Directory”，新建一个目录并命名为MyAppServiceExtAbility。</p></li>      <li>       <p>在MyAppServiceExtAbility目录，右键选择“New &gt; ArkTS File”，新建一个文件并命名为MyAppServiceExtAbility.ets。</p>       <p><span><img originheight="586" originwidth="705" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114908.12299245778015987083463774176180:50001231000000:2800:3D51CB1257619936E76C71FEF395E26C8E073CAFCA0FCA75091F9ECDED419FE5.png" width="705" height="586"></span></p>       <p>其目录结构如下所示：</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>├── ets</li><li>│ ├── MyAppServiceExtAbility</li><li>│ │   ├── MyAppServiceExtAbility.ets</li><li>└</li></ol></pre></div></div></li>      <li>       <p>在MyAppServiceExtAbility.ets文件中，增加导入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>的依赖包，自定义类继承AppServiceExtensionAbility组件并实现生命周期回调。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppServiceExtensionAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MyAppServiceExtAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">StubTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">des: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>(des);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRemoteMessageRequest</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>,</li><li>    <span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">reply</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">options</span>: rpc.<span class="hljs-property">MessageOption</span>): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>    <span class="hljs-comment">// 处理客户端发送的消息</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppServiceExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AppServiceExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> appServiceExtensionContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onCreate, want: <span class="hljs-subst">${want.abilityName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRequest</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">startId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onRequest, want: <span class="hljs-subst">${want.abilityName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onConnect</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): rpc.<span class="hljs-property">RemoteObject</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnect, want: <span class="hljs-subst">${want.abilityName}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StubTest</span>(<span class="hljs-string">"test"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDisconnect</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDisconnect, want: <span class="hljs-subst">${want.abilityName}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onDestroy'</span>);</li><li>  }</li><li>};</li></ol></pre></div></div></li>      <li>       <p>在工程Module对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file">module.json5配置文件</a>中注册AppServiceExtensionAbility组件，type标签需要设置为“appService”，srcEntry标签表示当前ExtensionAbility组件所对应的代码路径。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-attr">"extensionAbilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAppServiceExtAbility"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"appService"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"appService"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"exported"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/MyAppServiceExtAbility/MyAppServiceExtAbility.ets"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"appIdentifierAllowList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>          <span class="hljs-comment">// 此处填写允许启动该后台服务的客户端应用的appIdentifier列表</span></li><li>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="启动一个后台服务">启动一个后台服务<i class="anchor-icon anchor-icon-link" anchorid="启动一个后台服务" tips="复制节点链接"></i></h2>          <p>应用通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#startappserviceextensionability20" target="_blank">startAppServiceExtensionAbility()</a>方法启动一个后台服务，服务的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability#onrequest" target="_blank">onRequest()</a>回调就会被调用，并在该回调方法中接收到调用者传递过来的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">Want</a>对象。后台服务启动后，其生命周期独立于客户端，即使客户端已经销毁，该后台服务仍可继续运行。因此，后台服务需要在其工作完成时通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/-apis-inner-application-appserviceextensioncontext" target="_blank">AppServiceExtensionContext</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/-apis-inner-application-appserviceextensioncontext#terminateself" target="_blank">terminateSelf()</a>来自行停止，或者由另一个组件调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#stopappserviceextensionability20" target="_blank">stopAppServiceExtensionAbility()</a>来将其停止。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>AppServiceExtensionAbility组件以start方式启动，并且没有连接的时候，AppServiceExtensionAbility组件进程可能被挂起（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview">Background Tasks Kit简介</a>）。</p>      </div></div></div>     <ul>      <li>       <p>在应用中启动一个新的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>组件。示例中的context的获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Page_AppServiceExtensionAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span>_AppServiceExtensionAbility {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// UIAbilityContext</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>              <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>,</li><li>              <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.stagemodelabilitydevelop'</span>,</li><li>              <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'MyAppServiceExtAbility'</span></li><li>            };</li><li>            context.<span class="hljs-title function_">startAppServiceExtensionAbility</span>(want).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in starting AppServiceExtensionAbility.'</span>);</li><li>              <span class="hljs-comment">// 成功启动后台服务</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-attr">message</span>: <span class="hljs-string">'SuccessfullyStartBackendService'</span></li><li>              });</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                <span class="hljs-string">`Failed to start AppServiceExtensionAbility. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            });</li><li>          })</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">//...</span></li><li>      }</li><li>
</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//...</span></li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在应用中停止一个已启动的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>组件。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Page_AppServiceExtensionAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span>_AppServiceExtensionAbility {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// UIAbilityContext</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>              <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>,</li><li>              <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.stagemodelabilitydevelop'</span>,</li><li>              <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'MyAppServiceExtAbility'</span></li><li>            };</li><li>            context.<span class="hljs-title function_">stopAppServiceExtensionAbility</span>(want).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in stopping AppServiceExtensionAbility.'</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-attr">message</span>: <span class="hljs-string">'SuccessfullyStoppedAStartedBackendService'</span></li><li>              });</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                <span class="hljs-string">`Failed to stop AppServiceExtensionAbility. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            });</li><li>          })</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">//...</span></li><li>      }</li><li>
</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//...</span></li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>已启动的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability" target="_blank">AppServiceExtensionAbility</a>组件停止自身。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppServiceExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MyAppServiceExtAbility]'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppServiceExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AppServiceExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want</span>) {</li><li>  <span class="hljs-comment">// 执行业务逻辑</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">terminateSelf</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'----------- terminateSelf succeed -----------'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`terminateSelf failed, error.code: <span class="hljs-subst">${error.code}</span>, error.message: $   {error.message}`</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="连接一个后台服务">连接一个后台服务<i class="anchor-icon anchor-icon-link" anchorid="连接一个后台服务" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="客户端连接服务端" class="firsth2">客户端连接服务端<i class="anchor-icon anchor-icon-link" anchorid="客户端连接服务端" tips="复制节点链接"></i></h3>          <p>客户端可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#connectappserviceextensionability20" target="_blank">connectAppServiceExtensionAbility()</a>连接服务端（在Want对象中指定连接的目标服务），服务端的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appserviceextensionability#onconnect" target="_blank">onConnect()</a>就会被调用，并在该回调方法中接收到客户端传递过来的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">Want</a>对象。</p>     <p>服务端的AppServiceExtensionAbility组件会在onConnect()中返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#iremoteobject" target="_blank">IRemoteObject</a>对象给客户端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions" target="_blank">ConnectOptions</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions#onconnect" target="_blank">onConnect()</a>方法。开发者通过该IRemoteObject定义通信接口，实现客户端与服务端的RPC交互。多个客户端可以同时连接到同一个后台服务，客户端完成与服务端的交互后，客户端需要通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#disconnectappserviceextensionability20" target="_blank">disconnectAppServiceExtensionAbility()</a>来断开连接。如果所有连接到某个后台服务的客户端均已断开连接，则系统会销毁该服务。</p>     <ul>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#connectappserviceextensionability20" target="_blank">connectAppServiceExtensionAbility()</a>建立与后台服务的连接。示例中的context的获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Page_AppServiceExtensionAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>  <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.stagemodelabilitydevelop'</span>,</li><li>  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'MyAppServiceExtAbility'</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: common.<span class="hljs-property">ConnectOptions</span> = {</li><li>  <span class="hljs-title function_">onConnect</span>(elementName, <span class="hljs-attr">remote</span>: rpc.<span class="hljs-property">IRemoteObject</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onConnect callback'</span>);</li><li>    <span class="hljs-keyword">if</span> (remote === <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnect remote is null`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 通过remote进行通信</span></li><li>  },</li><li>  <span class="hljs-title function_">onDisconnect</span>(elementName): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onDisconnect callback'</span>);</li><li>  },</li><li>  <span class="hljs-title function_">onFailed</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onFailed callback'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(code));</li><li>  }</li><li>};</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span>_AppServiceExtensionAbility {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// UIAbilityContext</span></li><li>            <span class="hljs-comment">// 建立连接后返回的Id需要保存下来，在解绑服务时需要作为参数传入</span></li><li>            connectionId = context.<span class="hljs-title function_">connectAppServiceExtensionAbility</span>(want, options);</li><li>            <span class="hljs-comment">// 成功连接后台服务</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>              <span class="hljs-attr">message</span>: <span class="hljs-string">'SuccessfullyConnectBackendService'</span></li><li>            });</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`connectionId is : <span class="hljs-subst">${connectionId}</span>`</span>);</li><li>          })</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">//...</span></li><li>      }</li><li>
</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//...</span></li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#disconnectappserviceextensionability20" target="_blank">disconnectAppServiceExtensionAbility()</a>断开与后台服务的连接。</p>       <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Page_AppServiceExtensionAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span>_AppServiceExtensionAbility {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// UIAbilityContext</span></li><li>            <span class="hljs-comment">// connectionId为调用connectServiceExtensionAbility接口时的返回值，需开发者自行维护</span></li><li>            context.<span class="hljs-title function_">disconnectAppServiceExtensionAbility</span>(connectionId).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'disconnectAppServiceExtensionAbility success'</span>);</li><li>              <span class="hljs-comment">// 成功断连后台服务</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-attr">message</span>: <span class="hljs-string">'SuccessfullyDisconnectBackendService'</span></li><li>              });</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'disconnectAppServiceExtensionAbility failed'</span>);</li><li>            });</li><li>          })</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">//...</span></li><li>      }</li><li>
</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//...</span></li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="客户端与服务端通信">客户端与服务端通信<i class="anchor-icon anchor-icon-link" anchorid="客户端与服务端通信" tips="复制节点链接"></i></h3>          <p>客户端在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions#onconnect" target="_blank">onConnect()</a>中获取到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#iremoteobject" target="_blank">rpc.IRemoteObject</a>对象后便可与服务端进行通信。</p>     <p><strong>客户端</strong>：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#sendmessagerequest9" target="_blank">sendMessageRequest</a>接口向服务端发送消息。</p>     <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Page_AppServiceExtensionAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REQUEST_CODE</span> = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>  <span class="hljs-attr">deviceId</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.stagemodelabilitydevelop'</span>,</li><li>  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'MyAppServiceExtAbility'</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: common.<span class="hljs-property">ConnectOptions</span> = {</li><li>  <span class="hljs-title function_">onConnect</span>(elementName, remote): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onConnect callback'</span>);</li><li>    <span class="hljs-keyword">if</span> (remote === <span class="hljs-literal">null</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnect remote is null`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> option = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageOption</span>();</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageSequence</span>();</li><li>    <span class="hljs-keyword">let</span> reply = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageSequence</span>();</li><li>
</li><li>    <span class="hljs-comment">// 写入请求数据</span></li><li>    data.<span class="hljs-title function_">writeInt</span>(<span class="hljs-number">1</span>);</li><li>    data.<span class="hljs-title function_">writeInt</span>(<span class="hljs-number">2</span>);</li><li>
</li><li>    remote.<span class="hljs-title function_">sendMessageRequest</span>(<span class="hljs-variable constant_">REQUEST_CODE</span>, data, reply, option).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: rpc.RequestResult</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (ret.<span class="hljs-property">errCode</span> === <span class="hljs-number">0</span>) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`sendRequest got result`</span>);</li><li>        <span class="hljs-keyword">let</span> sum = ret.<span class="hljs-property">reply</span>.<span class="hljs-title function_">readInt</span>();</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`sendRequest success, sum:<span class="hljs-subst">${sum}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`sendRequest failed`</span>);</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`sendRequest failed, <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    });</li><li>  },</li><li>  <span class="hljs-title function_">onDisconnect</span>(elementName): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onDisconnect callback'</span>);</li><li>  },</li><li>  <span class="hljs-title function_">onFailed</span>(code): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onFailed callback'</span>);</li><li>  }</li><li>};</li><li>
</li><li><span class="hljs-comment">// 调用connectAppServiceExtensionAbility相关代码</span></li><li><span class="hljs-comment">//...</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span>_AppServiceExtensionAbility {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// UIAbilityContext</span></li><li>            connectionId = context.<span class="hljs-title function_">connectAppServiceExtensionAbility</span>(want, options);</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`connectionId is : <span class="hljs-subst">${connectionId}</span>`</span>);</li><li>          })</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><strong>服务端</strong>：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#onremotemessagerequest9" target="_blank">onRemoteMessageRequest</a>接口接收客户端发送的消息。</p>     <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppServiceExtensionAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MyAppServiceExtAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// 开发者需要在这个类型里对接口进行实现</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Stub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {</li><li>  <span class="hljs-title function_">onRemoteMessageRequest</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>,</li><li>    <span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">reply</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">options</span>: rpc.<span class="hljs-property">MessageOption</span>): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onRemoteMessageRequest'</span>);</li><li>    <span class="hljs-keyword">let</span> sum = data.<span class="hljs-title function_">readInt</span>() + data.<span class="hljs-title function_">readInt</span>();</li><li>    reply.<span class="hljs-title function_">writeInt</span>(sum);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 服务端实现</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppServiceExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AppServiceExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'MyAppServiceExtAbility onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'MyAppServiceExtAbility onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onConnect</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): rpc.<span class="hljs-property">RemoteObject</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'MyAppServiceExtAbility onConnect'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stub</span>(<span class="hljs-string">'test'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDisconnect</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'MyAppServiceExtAbility onDisconnect'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="服务端对客户端身份校验">服务端对客户端身份校验<i class="anchor-icon anchor-icon-link" anchorid="服务端对客户端身份校验" tips="复制节点链接"></i></h3>          <p>部分开发者需要使用AppServiceExtensionAbility组件提供一些较为敏感的服务，可以通过如下方式对客户端身份进行校验。</p>     <p><strong>通过callerTokenId对客户端进行鉴权</strong></p>     <p>通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#getcallingtokenid8" target="_blank">getCallingTokenId()</a>接口获取客户端的tokenID，再调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#verifyaccesstokensync9" target="_blank">verifyAccessTokenSync()</a>接口判断客户端是否有某个具体权限，由于当前不支持自定义权限，因此只能校验当前<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-permissions">系统所定义的权限</a>。示例代码如下：</p>     <div _ngcontent-qjk-c106="" class="highlight-div"><div _ngcontent-qjk-c106="" class="highlight-div-header"><div _ngcontent-qjk-c106="" class="highlight-div-header-left"><div _ngcontent-qjk-c106="" class="handle-button expand-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjk-c106="" class="highlight-div-header-right"><div _ngcontent-qjk-c106="" class="handle-button ai-button"></div><div _ngcontent-qjk-c106="" class="handle-button line-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjk-c106="" class="handle-button theme-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjk-c106="" class="handle-button copy-button"><div _ngcontent-qjk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppServiceExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[AppServiceExtImpl]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// 开发者需要在这个类里进行实现</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Stub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {</li><li>  <span class="hljs-title function_">onRemoteMessageRequest</span>(</li><li>    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>,</li><li>    <span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">reply</span>: rpc.<span class="hljs-property">MessageSequence</span>,</li><li>    <span class="hljs-attr">options</span>: rpc.<span class="hljs-property">MessageOption</span>): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>    <span class="hljs-comment">// 开发者自行实现业务逻辑</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onRemoteMessageRequest: <span class="hljs-subst">${data}</span>`</span>);</li><li>    <span class="hljs-keyword">let</span> callerUid = rpc.<span class="hljs-property">IPCSkeleton</span>.<span class="hljs-title function_">getCallingUid</span>();</li><li>    bundleManager.<span class="hljs-title function_">getBundleNameByUid</span>(callerUid).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">callerBundleName</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'getBundleNameByUid: '</span> + callerBundleName);</li><li>      <span class="hljs-comment">// 对客户端包名进行识别</span></li><li>      <span class="hljs-keyword">if</span> (callerBundleName !== <span class="hljs-string">'com.samples.stagemodelabilitydevelop'</span>) { <span class="hljs-comment">// 识别不通过</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'The caller bundle is not in trustlist, reject'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    <span class="hljs-comment">// 识别通过，执行正常业务逻辑</span></li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'getBundleNameByUid failed: '</span> + err.<span class="hljs-property">message</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-keyword">let</span> callerTokenId = rpc.<span class="hljs-property">IPCSkeleton</span>.<span class="hljs-title function_">getCallingTokenId</span>();</li><li>    <span class="hljs-keyword">let</span> accessManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-comment">// 所校验的具体权限由开发者自行选择，此处ohos.permission.GET_BUNDLE_INFO_PRIVILEGED只作为示例</span></li><li>    <span class="hljs-keyword">let</span> grantStatus = accessManager.<span class="hljs-title function_">verifyAccessTokenSync</span>(callerTokenId, <span class="hljs-string">'ohos.permission.GET_BUNDLE_INFO_PRIVILEGED'</span>);</li><li>    <span class="hljs-keyword">if</span> (grantStatus === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_DENIED</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'PERMISSION_DENIED'</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'verify access token success.'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppServiceExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AppServiceExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onConnect</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): rpc.<span class="hljs-property">RemoteObject</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stub</span>(<span class="hljs-string">'test'</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 其他生命周期</span></li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>