<h1 _ngcontent-yuq-c119="" class="doc-title ng-star-inserted" title="使用AudioCapturer开发音频录制功能"> 使用AudioCapturer开发音频录制功能 </h1>

<div _ngcontent-yuq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>AudioCapturer是音频采集器，用于录制PCM（Pulse Code Modulation）音频数据，适合有音频开发经验的开发者实现更灵活的录制功能。</p>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>使用AudioCapturer录制音频涉及到AudioCapturer实例的创建、音频采集参数的配置、采集的开始与停止、资源的释放等。本开发指导将以一次录制音频数据的过程为例，向开发者讲解如何使用AudioCapturer进行音频录制，建议搭配<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiocapturer" target="_blank">AudioCapturer的API说明</a>阅读。</p>     <p>下图展示了AudioCapturer的状态变化，在创建实例后，调用对应的方法可以进入指定的状态实现对应的行为。需要注意的是在确定的状态执行不合适的方法可能导致AudioCapturer发生错误，建议开发者在调用状态转换的方法前进行状态检查，避免程序运行产生预期以外的结果。</p>     <p><strong>图1</strong> AudioCapturer状态变化示意图</p>     <p><span><img originheight="594" originwidth="591" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114424.57946104372783445601814314015570:50001231000000:2800:9AABEB36D69C4F6B88109ED8E61203632B06B7AF324771E8C4961346E1D088C9.png" width="591" height="594"></span></p>     <p>使用on('stateChange')方法可以监听AudioCapturer的状态变化，每个状态对应值与说明见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audiostate8" target="_blank">AudioState</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤及注意事项" class="firsth2">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>配置音频采集参数并创建AudioCapturer实例，音频采集参数的详细信息可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-i#audiocaptureroptions8" target="_blank">AudioCapturerOptions</a>。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>当设置Mic音频源（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#sourcetype8" target="_blank">SourceType</a>为SOURCE_TYPE_MIC、SOURCE_TYPE_VOICE_RECOGNITION、SOURCE_TYPE_VOICE_COMMUNICATION、SOURCE_TYPE_VOICE_MESSAGE、SOURCE_TYPE_LIVE（从API version 20开始支持））时，需要申请麦克风权限ohos.permission.MICROPHONE，申请方式参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>        </div></div></div>       <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li> </li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">audioStreamInfo</span>: audio.<span class="hljs-property">AudioStreamInfo</span> = {</li><li>   <span class="hljs-attr">samplingRate</span>: audio.<span class="hljs-property">AudioSamplingRate</span>.<span class="hljs-property">SAMPLE_RATE_48000</span>, <span class="hljs-comment">// 采样率。</span></li><li>   <span class="hljs-attr">channels</span>: audio.<span class="hljs-property">AudioChannel</span>.<span class="hljs-property">CHANNEL_2</span>, <span class="hljs-comment">// 通道。</span></li><li>   <span class="hljs-attr">sampleFormat</span>: audio.<span class="hljs-property">AudioSampleFormat</span>.<span class="hljs-property">SAMPLE_FORMAT_S16LE</span>, <span class="hljs-comment">// 采样格式。</span></li><li>   <span class="hljs-attr">encodingType</span>: audio.<span class="hljs-property">AudioEncodingType</span>.<span class="hljs-property">ENCODING_TYPE_RAW</span> <span class="hljs-comment">// 编码格式。</span></li><li> };</li><li> </li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturerInfo</span>: audio.<span class="hljs-property">AudioCapturerInfo</span> = {</li><li>   <span class="hljs-attr">source</span>: audio.<span class="hljs-property">SourceType</span>.<span class="hljs-property">SOURCE_TYPE_MIC</span>, <span class="hljs-comment">// 音源类型：Mic音频源。根据业务场景配置，参考SourceType。</span></li><li>   <span class="hljs-attr">capturerFlags</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 音频采集器标志。</span></li><li> };</li><li> </li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturerOptions</span>: audio.<span class="hljs-property">AudioCapturerOptions</span> = {</li><li>   <span class="hljs-attr">streamInfo</span>: audioStreamInfo,</li><li>   <span class="hljs-attr">capturerInfo</span>: audioCapturerInfo</li><li> };</li><li> </li><li> audio.<span class="hljs-title function_">createAudioCapturer</span>(audioCapturerOptions, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke createAudioCapturer failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Invoke createAudioCapturer succeeded.'</span>);</li><li>     <span class="hljs-keyword">let</span> audioCapturer = data;</li><li>   }</li><li> });</li></ol></pre></div></div></li>      <li>       <p>调用on('readData')方法，订阅监听音频数据读入回调。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ul>          <li><strong>线程管理</strong>：不建议使用多线程来处理数据读取。若需使用多线程读取数据，需要做好线程管理。</li>          <li><strong>线程耗时</strong>：readData 方法所在的线程中，不建议执行耗时任务。否则可能会导致数据处理线程响应回调延迟，进而引发录音数据缺失、卡顿、杂音等音频效果问题。</li>         </ul>        </div></div></div>       <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li> <span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Options</span> {</li><li>   offset?: <span class="hljs-built_in">number</span>;</li><li>   length?: <span class="hljs-built_in">number</span>;</li><li> }</li><li>
</li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">bufferSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li> <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext。</span></li><li> <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-keyword">let</span> path = context.<span class="hljs-property">cacheDir</span>;</li><li> <span class="hljs-keyword">let</span> filePath = path + <span class="hljs-string">'/StarWars10s-2C-48000-4SW.pcm'</span>;</li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li> <span class="hljs-keyword">let</span> <span class="hljs-title function_">readDataCallback</span> = (<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt; {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Options</span> = {</li><li>     <span class="hljs-attr">offset</span>: bufferSize,</li><li>     <span class="hljs-attr">length</span>: buffer.<span class="hljs-property">byteLength</span></li><li>   }</li><li>   fs.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, buffer, options);</li><li>   bufferSize += buffer.<span class="hljs-property">byteLength</span>;</li><li> };</li><li>
</li><li> audioCapturer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'readData'</span>, readDataCallback);</li></ol></pre></div></div></li>      <li>       <p>调用start()方法进入running状态，开始录制音频。</p>       <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioCapturer.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Capturer start failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer start success.'</span>);</li><li>   }</li><li> });</li></ol></pre></div></div></li>      <li>       <p>调用stop()方法停止录制。</p>       <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioCapturer.<span class="hljs-title function_">stop</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Capturer stop failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer stopped.'</span>);</li><li>   }</li><li> });</li></ol></pre></div></div></li>      <li>       <p>调用release()方法销毁实例，释放资源。</p>       <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioCapturer.<span class="hljs-title function_">release</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`capturer release failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'capturer released.'</span>);</li><li>   }</li><li> });</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h3>          <p>下面展示了使用AudioCapturer录制音频的完整示例代码。</p>     <div _ngcontent-yuq-c106="" class="highlight-div"><div _ngcontent-yuq-c106="" class="highlight-div-header"><div _ngcontent-yuq-c106="" class="highlight-div-header-left"><div _ngcontent-yuq-c106="" class="handle-button expand-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yuq-c106="" class="highlight-div-header-right"><div _ngcontent-yuq-c106="" class="handle-button ai-button"></div><div _ngcontent-yuq-c106="" class="handle-button line-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yuq-c106="" class="handle-button theme-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yuq-c106="" class="handle-button copy-button"><div _ngcontent-yuq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yuq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'AudioCapturerDemo'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Options</span> {</li><li>  offset?: <span class="hljs-built_in">number</span>;</li><li>  length?: <span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturer</span>: audio.<span class="hljs-property">AudioCapturer</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioStreamInfo</span>: audio.<span class="hljs-property">AudioStreamInfo</span> = {</li><li>  <span class="hljs-attr">samplingRate</span>: audio.<span class="hljs-property">AudioSamplingRate</span>.<span class="hljs-property">SAMPLE_RATE_48000</span>, <span class="hljs-comment">// 采样率。</span></li><li>  <span class="hljs-attr">channels</span>: audio.<span class="hljs-property">AudioChannel</span>.<span class="hljs-property">CHANNEL_2</span>, <span class="hljs-comment">// 通道。</span></li><li>  <span class="hljs-attr">sampleFormat</span>: audio.<span class="hljs-property">AudioSampleFormat</span>.<span class="hljs-property">SAMPLE_FORMAT_S16LE</span>, <span class="hljs-comment">// 采样格式。</span></li><li>  <span class="hljs-attr">encodingType</span>: audio.<span class="hljs-property">AudioEncodingType</span>.<span class="hljs-property">ENCODING_TYPE_RAW</span> <span class="hljs-comment">// 编码格式。</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturerInfo</span>: audio.<span class="hljs-property">AudioCapturerInfo</span> = {</li><li>  <span class="hljs-attr">source</span>: audio.<span class="hljs-property">SourceType</span>.<span class="hljs-property">SOURCE_TYPE_MIC</span>, <span class="hljs-comment">// 音源类型：Mic音频源。根据业务场景配置，参考SourceType。</span></li><li>  <span class="hljs-attr">capturerFlags</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 音频采集器标志。</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturerOptions</span>: audio.<span class="hljs-property">AudioCapturerOptions</span> = {</li><li>  <span class="hljs-attr">streamInfo</span>: audioStreamInfo,</li><li>  <span class="hljs-attr">capturerInfo</span>: audioCapturerInfo</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">readDataCallback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt;;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initArguments</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">bufferSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> path = context.<span class="hljs-property">cacheDir</span>;</li><li>  <span class="hljs-keyword">let</span> filePath = path + <span class="hljs-string">'/StarWars10s-2C-48000-4SW.pcm'</span>;</li><li>  file = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  readDataCallback = <span class="hljs-function">(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Options</span> = {</li><li>      <span class="hljs-attr">offset</span>: bufferSize,</li><li>      <span class="hljs-attr">length</span>: buffer.<span class="hljs-property">byteLength</span></li><li>    }</li><li>    fs.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, buffer, options);</li><li>    bufferSize += buffer.<span class="hljs-property">byteLength</span>;</li><li>  };</li><li>}</li><li>
</li><li><span class="hljs-comment">// 初始化，创建实例，设置监听事件。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {</li><li>  audio.<span class="hljs-title function_">createAudioCapturer</span>(audioCapturerOptions, <span class="hljs-function">(<span class="hljs-params">err, capturer</span>) =&gt;</span> { <span class="hljs-comment">// 创建AudioCapturer实例。</span></li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke createAudioCapturer failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: create AudioCapturer success`</span>);</li><li>    audioCapturer = capturer;</li><li>    <span class="hljs-keyword">if</span> (audioCapturer !== <span class="hljs-literal">undefined</span>) {</li><li>      audioCapturer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'readData'</span>, readDataCallback);</li><li>    }</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开始一次音频采集。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioCapturer !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">let</span> stateGroup = [audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_PREPARED</span>, audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_PAUSED</span>, audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_STOPPED</span>];</li><li>    <span class="hljs-keyword">if</span> (stateGroup.<span class="hljs-title function_">indexOf</span>(audioCapturer.<span class="hljs-property">state</span>.<span class="hljs-title function_">valueOf</span>()) === -<span class="hljs-number">1</span>) { <span class="hljs-comment">// 当且仅当状态为STATE_PREPARED、STATE_PAUSED和STATE_STOPPED之一时才能启动采集。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: start failed`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动采集。</span></li><li>    audioCapturer.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Capturer start failed.'</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer start success.'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 停止采集。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioCapturer !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-comment">// 只有采集器状态为STATE_RUNNING或STATE_PAUSED的时候才可以停止。</span></li><li>    <span class="hljs-keyword">if</span> (audioCapturer.<span class="hljs-property">state</span>.<span class="hljs-title function_">valueOf</span>() !== audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_RUNNING</span> &amp;&amp; audioCapturer.<span class="hljs-property">state</span>.<span class="hljs-title function_">valueOf</span>() !== audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_PAUSED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer is not running or paused'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 停止采集。</span></li><li>    audioCapturer.<span class="hljs-title function_">stop</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Capturer stop failed.'</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer stop success.'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 销毁实例，释放资源。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioCapturer !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-comment">// 采集器状态不是STATE_RELEASED或STATE_NEW状态，才能release。</span></li><li>    <span class="hljs-keyword">if</span> (audioCapturer.<span class="hljs-property">state</span>.<span class="hljs-title function_">valueOf</span>() === audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_RELEASED</span> || audioCapturer.<span class="hljs-property">state</span>.<span class="hljs-title function_">valueOf</span>() === audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_NEW</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer already released'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放资源。</span></li><li>    audioCapturer.<span class="hljs-title function_">release</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Capturer release failed.'</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Capturer release success.'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Scroll</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'初始化'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">12</span> });</li><li>          }</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'45%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'25%'</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span> })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>            <span class="hljs-title function_">initArguments</span>(context);</li><li>            <span class="hljs-title function_">init</span>();</li><li>          });</li><li>
</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'开始录制'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">12</span> });</li><li>          }</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'45%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'25%'</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span> })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-title function_">start</span>();</li><li>          });</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'停止录制'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">12</span> });</li><li>          }</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'audio_effect_manager_card'</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'45%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'25%'</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span> })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-title function_">stop</span>();</li><li>          });</li><li>
</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'释放资源'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">12</span> });</li><li>          }</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'45%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'25%'</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span> })</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-title function_">release</span>();</li><li>          });</li><li>        }</li><li>        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">12</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置静音打断模式">设置静音打断模式<i class="anchor-icon anchor-icon-link" anchorid="设置静音打断模式" tips="复制节点链接"></i></h3>          <p>如果需要实现录音全程不被系统基于焦点并发规则打断的效果，提供将打断策略从停止录音切换为静音录制的功能，录音过程中也不影响其他应用启动录音。开发者在创建AudioCapturer实例时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiocapturer#setwillmutewheninterrupted20" target="_blank">setWillMuteWhenInterrupted</a>接口设置是否开启静音打断模式。默认不开启，此时由音频焦点策略管理并发音频流的执行顺序。开启后，被其他应用打断导致停止或暂停录制时会进入静音录制状态，在此状态下录制的音频没有声音。</p>    </div>    <div class="tiledSection">     <h3 id="回声消除功能">回声消除功能<i class="anchor-icon anchor-icon-link" anchorid="回声消除功能" tips="复制节点链接"></i></h3>          <p>回声消除功能可在支持的设备上有效消除录音过程中的回声干扰，提升音频采集质量。开发者可通过指定特定的Mic音频源<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#sourcetype8" target="_blank">SourceType</a>（SOURCE_TYPE_VOICE_COMMUNICATION、SOURCE_TYPE_LIVE）来启用该功能，系统将会自动对采集的音频信号进行回声消除处理。</p>     <p>在启用前，建议先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#isacousticechocancelersupported20" target="_blank">isAcousticEchoCancelerSupported</a>接口（从API version 20开始支持）查询当前设备对音频输入源类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#sourcetype8" target="_blank">SourceType</a>是否支持回声消除功能，以确保功能的可用性。若支持，则可在创建音频录制构造器时设置相应的Mic音频源，从而激活回声消除处理流程。</p>    </div>   </div>   <div></div></div>