<h1 _ngcontent-ijc-c119="" class="doc-title ng-star-inserted" title="使用AudioHaptic开发音振协同播放功能"> 使用AudioHaptic开发音振协同播放功能 </h1>

<div _ngcontent-ijc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>AudioHaptic提供音频与振动协同播放及管理的方法，适用于需要在播放音频时同步发起振动的场景，如来电铃声随振、键盘按键反馈、消息通知反馈等。</p>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>使用AudioHaptic播放音频并同步开启振动，涉及到音频及振动资源的管理、音频时延模式及音频流使用类型的配置、音振播放器的创建及管理等。本开发指导将以一次音振协同播放的过程为例，向开发者讲解如何使用AudioHaptic进行音振协同播放，建议配合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-audiohaptic#audiohapticmanager" target="_blank">AudioHaptic的API说明</a>阅读。</p>    </div>    <div class="tiledSection">     <h3 id="权限申请" class="firsth2">权限申请<i class="anchor-icon anchor-icon-link" anchorid="权限申请" tips="复制节点链接"></i></h3>          <p>如果应用创建的AudioHapticPlayer需要触发振动，则需要校验应用是否拥有该权限：ohos.permission.VIBRATE。</p>     <ol>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>     </ol>    </div>    <div class="tiledSection">     <h3 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>获取音振管理器实例，并注册音频及振动资源，资源支持情况可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-audiohaptic#audiohapticmanager" target="_blank">AudioHapticManager</a>。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>开发者可通过如下两种方式注册资源：</p>         <ul>          <li>方式1：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-audiohaptic#registersource" target="_blank">registerSource</a>接口，通过文件URI来注册资源。</li>          <li>方式2（推荐）：从API version 20开始，支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-audiohaptic#registersourcefromfd20" target="_blank">registerSourceFromFd</a>接口，通过文件描述符来注册资源，更便于开发者使用。</li>         </ul>        </div></div></div>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio, audioHaptic } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioHapticManagerInstance</span>: audioHaptic.<span class="hljs-property">AudioHapticManager</span> = audioHaptic.<span class="hljs-title function_">getAudioHapticManager</span>();</li><li>
</li><li><span class="hljs-comment">// 方法1：使用registerSource接口注册资源。</span></li><li><span class="hljs-keyword">let</span> audioUri = <span class="hljs-string">'data/audioTest.wav'</span>; <span class="hljs-comment">// 此处仅作示例，实际使用时需要将文件替换为应用目标音频资源的Uri。</span></li><li><span class="hljs-keyword">let</span> hapticUri = <span class="hljs-string">'data/hapticTest.json'</span>; <span class="hljs-comment">// 此处仅作示例，实际使用时需要将文件替换为应用目标振动资源的Uri。</span></li><li><span class="hljs-keyword">let</span> idForUri = <span class="hljs-number">0</span>;</li><li>
</li><li>audioHapticManagerInstance.<span class="hljs-title function_">registerSource</span>(audioUri, hapticUri).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Promise returned to indicate that the source id of the registered source <span class="hljs-subst">${value}</span>.`</span>);</li><li>  idForUri = value;</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register source <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li><li>
</li><li><span class="hljs-comment">// 方法2：使用registerSourceFromFd接口注册资源。</span></li><li><span class="hljs-keyword">let</span> idForFd = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext。</span></li><li><span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> audioFile = context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-string">'audioTest.ogg'</span>); <span class="hljs-comment">// 此处仅作示例，实际使用时需要将文件替换为应用rawfile目录下的对应文件。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioFd</span>: audioHaptic.<span class="hljs-property">AudioHapticFileDescriptor</span> = {</li><li>  <span class="hljs-attr">fd</span>: audioFile.<span class="hljs-property">fd</span>,</li><li>  <span class="hljs-attr">offset</span>: audioFile.<span class="hljs-property">offset</span>,</li><li>  <span class="hljs-attr">length</span>: audioFile.<span class="hljs-property">length</span>,</li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> hapticFile = context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-string">'hapticTest.json'</span>); <span class="hljs-comment">// 此处仅作示例，实际使用时需要将文件替换为应用rawfile目录下的对应文件。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hapticFd</span>: audioHaptic.<span class="hljs-property">AudioHapticFileDescriptor</span> = {</li><li>  <span class="hljs-attr">fd</span>: hapticFile.<span class="hljs-property">fd</span>,</li><li>  <span class="hljs-attr">offset</span>: hapticFile.<span class="hljs-property">offset</span>,</li><li>  <span class="hljs-attr">length</span>: hapticFile.<span class="hljs-property">length</span>,</li><li>};</li><li>
</li><li>audioHapticManagerInstance.<span class="hljs-title function_">registerSourceFromFd</span>(audioFd, hapticFd).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in doing registerSourceFromFd.'</span>);</li><li>  idForFd = value;</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to registerSourceFromFd. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>设置音振播放器参数，各参数作用可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-audiohaptic#audiohapticmanager" target="_blank">AudioHapticManager</a>。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">latencyMode</span>: audioHaptic.<span class="hljs-property">AudioLatencyMode</span> = audioHaptic.<span class="hljs-property">AudioLatencyMode</span>.<span class="hljs-property">AUDIO_LATENCY_MODE_FAST</span>;</li><li>audioHapticManagerInstance.<span class="hljs-title function_">setAudioLatencyMode</span>(idForFd, latencyMode);</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">usage</span>: audio.<span class="hljs-property">StreamUsage</span> = audio.<span class="hljs-property">StreamUsage</span>.<span class="hljs-property">STREAM_USAGE_NOTIFICATION</span>;</li><li>audioHapticManagerInstance.<span class="hljs-title function_">setStreamUsage</span>(idForFd, usage);</li></ol></pre></div></div></li>      <li>       <p>创建AudioHapticPlayer实例。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: audioHaptic.<span class="hljs-property">AudioHapticPlayerOptions</span> = {<span class="hljs-attr">muteAudio</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">muteHaptics</span>: <span class="hljs-literal">false</span>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioHapticPlayer</span>: audioHaptic.<span class="hljs-property">AudioHapticPlayer</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>audioHapticManagerInstance.<span class="hljs-title function_">createPlayer</span>(idForFd, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value: audioHaptic.AudioHapticPlayer</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Create the audio haptic player successfully.`</span>);</li><li>  audioHapticPlayer = value;</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create player <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>调用start()方法，开启音频播放并同步开启振动。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioHapticPlayer.<span class="hljs-title function_">start</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Promise returned to indicate that start playing successfully.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start playing. <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>调用stop()方法，停止音频播放并同步停止振动。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioHapticPlayer.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Promise returned to indicate that stop playing successfully.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop playing. <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>释放AudioHapticPlayer实例。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioHapticPlayer.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Promise returned to indicate that release the audio haptic player successfully.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to release the audio haptic player. <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>将已注册的音频及振动资源移除注册。</p>       <div _ngcontent-ijc-c106="" class="highlight-div"><div _ngcontent-ijc-c106="" class="highlight-div-header"><div _ngcontent-ijc-c106="" class="highlight-div-header-left"><div _ngcontent-ijc-c106="" class="handle-button expand-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ijc-c106="" class="highlight-div-header-right"><div _ngcontent-ijc-c106="" class="handle-button ai-button"></div><div _ngcontent-ijc-c106="" class="handle-button line-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ijc-c106="" class="handle-button theme-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ijc-c106="" class="handle-button copy-button"><div _ngcontent-ijc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ijc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioHapticManagerInstance.<span class="hljs-title function_">unregisterSource</span>(idForFd).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Promise returned to indicate that unregister source successfully`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister source <span class="hljs-subst">${err}</span>`</span>);</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>