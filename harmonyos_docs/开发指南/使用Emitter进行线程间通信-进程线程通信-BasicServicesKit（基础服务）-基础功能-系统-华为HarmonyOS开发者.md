<h1 _ngcontent-owr-c119="" class="doc-title ng-star-inserted" title="使用Emitter进行线程间通信"> 使用Emitter进行线程间通信 </h1>

<div _ngcontent-owr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Emitter是一种作用在进程内的事件处理机制，为应用程序提供订阅事件、发布事件、取消事件订阅的能力。</p>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>Emitter用于同一进程内相同线程或不同线程间的事件处理，事件异步执行。使用时需要先订阅一个事件，然后发布该事件，发布完成后Emitter会将已发布的事件分发给订阅者，订阅者就会执行该事件订阅时设置的回调方法。当不需要订阅该事件时应及时取消订阅释放Emitter资源。</p>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>          <p>Emitter通过维护一个内部事件队列，来进行任务分发。应用需要先订阅某个事件并设置好该事件的回调方法，当应用程序发布事件后，就会往队列里面插入一个事件。任务队列会串行执行队列里面的任务，执行任务时会调用该任务订阅者的回调方法进行事件处理。</p>     <p><span><img originheight="529" originwidth="803" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115039.20713211677048566001733400738039:50001231000000:2800:9AF7C41BFC6BEC7A4FD3615F70B27369430DB29E3DFC129E93A76BBE4AFEFE6C.png" width="803" height="529"></span></p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter" target="_blank">Emitter接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.1" valign="top" width="33.33333333333333%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.2" valign="top" width="33.33333333333333%">用途</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">on</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">订阅事件</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">持续订阅事件，直至该事件被取消订阅。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">once</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">订阅事件</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">订阅事件一次。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">emit</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">发布事件</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">发布事件一次。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">off</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">取消事件订阅</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">取消事件订阅后，将不再接收该事件的消息。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>使用Emitter实现事件订阅、事件发送以及事件删除，开发步骤如下。</p>     <ol>      <li>       <p>导入模块。</p>       <div _ngcontent-owr-c106="" class="highlight-div"><div _ngcontent-owr-c106="" class="highlight-div-header"><div _ngcontent-owr-c106="" class="highlight-div-header-left"><div _ngcontent-owr-c106="" class="handle-button expand-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owr-c106="" class="highlight-div-header-right"><div _ngcontent-owr-c106="" class="handle-button ai-button"></div><div _ngcontent-owr-c106="" class="handle-button line-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owr-c106="" class="handle-button theme-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owr-c106="" class="handle-button copy-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { emitter, <span class="hljs-title class_">Callback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>订阅事件。</p>       <p>订阅事件使用on（持续订阅）或者once（单次订阅）接口进行订阅，设置要订阅的事件以及接收到事件后的回调函数。</p>       <div _ngcontent-owr-c106="" class="highlight-div"><div _ngcontent-owr-c106="" class="highlight-div-header"><div _ngcontent-owr-c106="" class="highlight-div-header-left"><div _ngcontent-owr-c106="" class="handle-button expand-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owr-c106="" class="highlight-div-header-right"><div _ngcontent-owr-c106="" class="handle-button ai-button"></div><div _ngcontent-owr-c106="" class="handle-button line-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owr-c106="" class="handle-button theme-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owr-c106="" class="handle-button copy-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 定义一个eventId为1的事件。</span></li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">event</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>   <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span></li><li> };</li><li> <span class="hljs-comment">// 定义一个事件的回调处理函数，当收到对应的事件后执行回调函数</span></li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;emitter.<span class="hljs-property">EventData</span>&gt; = <span class="hljs-function">(<span class="hljs-params">eventData: emitter.EventData</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`eventData: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventData)}</span>`</span>);</li><li> }</li><li>
</li><li> <span class="hljs-comment">// 收到eventId为1的事件后执行回调函数</span></li><li> emitter.<span class="hljs-title function_">on</span>(event, callback);</li></ol></pre></div></div>       <div _ngcontent-owr-c106="" class="highlight-div"><div _ngcontent-owr-c106="" class="highlight-div-header"><div _ngcontent-owr-c106="" class="highlight-div-header-left"><div _ngcontent-owr-c106="" class="handle-button expand-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owr-c106="" class="highlight-div-header-right"><div _ngcontent-owr-c106="" class="handle-button ai-button"></div><div _ngcontent-owr-c106="" class="handle-button line-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owr-c106="" class="handle-button theme-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owr-c106="" class="handle-button copy-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 收到eventId为1的事件后执行回调函数。</span></li><li> <span class="hljs-comment">// 注意：once订阅只接收一次事件，on订阅则一直接收直到取消订阅为止。</span></li><li> emitter.<span class="hljs-title function_">once</span>(event, callback);</li></ol></pre></div></div></li>      <li>       <p>发送事件。</p>       <p>发送事件使用emit接口进行发送，设置要发送的事件以及要传递的参数。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>emit接口支持跨线程传输数据对象，需要遵循数据跨线程传输的规格约束，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/serializable-overview">线程间通信对象</a>。目前不支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State装饰器</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed装饰器</a>等装饰器修饰的复杂类型数据。</li>          <li>使用emit接口发布某个事件后，不保证该事件立刻执行，执行时间取决于事件队列里面的事件数量以及各事件的执行效率。</li>         </ul>        </div></div></div>       <div _ngcontent-owr-c106="" class="highlight-div"><div _ngcontent-owr-c106="" class="highlight-div-header"><div _ngcontent-owr-c106="" class="highlight-div-header-left"><div _ngcontent-owr-c106="" class="handle-button expand-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owr-c106="" class="highlight-div-header-right"><div _ngcontent-owr-c106="" class="handle-button ai-button"></div><div _ngcontent-owr-c106="" class="handle-button line-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owr-c106="" class="handle-button theme-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owr-c106="" class="handle-button copy-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义一个eventId为1的事件，事件优先级为Low。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">event</span>: emitter.<span class="hljs-property">InnerEvent</span> = {</li><li>  <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-attr">priority</span>: emitter.<span class="hljs-property">EventPriority</span>.<span class="hljs-property">LOW</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">eventData</span>: emitter.<span class="hljs-property">EventData</span> = {</li><li>  <span class="hljs-attr">data</span>: {</li><li>    <span class="hljs-attr">content</span>: <span class="hljs-string">'emitter'</span>,</li><li>    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-attr">isEmpty</span>: <span class="hljs-literal">false</span></li><li>  }</li><li>};</li><li>
</li><li><span class="hljs-comment">// 发送eventId为1的事件，事件内容为eventData。</span></li><li>emitter.<span class="hljs-title function_">emit</span>(event, eventData);</li></ol></pre></div></div></li>      <li>       <p>取消事件订阅。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>当不需要订阅某个事件时，需要及时取消订阅避免造成内存泄漏。</li>          <li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter#emitteroff" target="_blank">off</a>接口取消某个事件订阅后，已通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter#emitteremit" target="_blank">emit</a>接口发布但尚未被执行的事件将被取消。</li>         </ul>        </div></div></div>       <div _ngcontent-owr-c106="" class="highlight-div"><div _ngcontent-owr-c106="" class="highlight-div-header"><div _ngcontent-owr-c106="" class="highlight-div-header-left"><div _ngcontent-owr-c106="" class="handle-button expand-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-owr-c106="" class="highlight-div-header-right"><div _ngcontent-owr-c106="" class="handle-button ai-button"></div><div _ngcontent-owr-c106="" class="handle-button line-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-owr-c106="" class="handle-button theme-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-owr-c106="" class="handle-button copy-button"><div _ngcontent-owr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-owr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 取消eventId为1的事件。</span></li><li>emitter.<span class="hljs-title function_">off</span>(<span class="hljs-number">1</span>);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>