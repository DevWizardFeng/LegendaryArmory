<h1 _ngcontent-edl-c119="" class="doc-title ng-star-inserted" title="使用HKDF进行密钥派生(C/C++)"> 使用HKDF进行密钥派生(C/C++) </h1>

<div _ngcontent-edl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对应算法规格请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-key-derivation-overview#hkdf算法">密钥派生算法规格：HKDF</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_create" target="_blank">OH_CryptoKdfParams_Create</a>，指定字符串参数'HKDF'，创建密钥派生参数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_setparam" target="_blank">OH_CryptoKdfParams_SetParam</a>，设置HKDF所需的参数。示例如下：</p>       <ul>        <li>CRYPTO_KDF_KEY_DATABLOB：用于生成派生密钥的原始密钥材料。</li>        <li>CRYPTO_KDF_SALT_DATABLOB：盐值。</li>        <li>CRYPTO_KDF_INFO_DATABLOB：应用程序特定的信息（可选）。</li>       </ul></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_create" target="_blank">OH_CryptoKdf_Create</a>，指定字符串参数'HKDF|SHA256|EXTRACT_AND_EXPAND'，创建密钥派生函数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_derive" target="_blank">OH_CryptoKdf_Derive</a>，指定目标密钥的字节长度，进行密钥派生。</p></li>     </ol>     <div _ngcontent-edl-c106="" class="highlight-div"><div _ngcontent-edl-c106="" class="highlight-div-header"><div _ngcontent-edl-c106="" class="highlight-div-header-left"><div _ngcontent-edl-c106="" class="handle-button expand-button"><div _ngcontent-edl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-edl-c106="" class="highlight-div-header-right"><div _ngcontent-edl-c106="" class="handle-button ai-button"></div><div _ngcontent-edl-c106="" class="handle-button line-button"><div _ngcontent-edl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-edl-c106="" class="handle-button theme-button"><div _ngcontent-edl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-edl-c106="" class="handle-button copy-button"><div _ngcontent-edl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-edl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestHkdf</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建HKDF参数对象。</span></li><li>    OH_CryptoKdfParams *params = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoKdfParams_Create</span>(<span class="hljs-string">"HKDF"</span>, &amp;params);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置原始密钥材料。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *keyData = <span class="hljs-string">"012345678901234567890123456789"</span>;</li><li>    Crypto_DataBlob key = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(keyData)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(keyData)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_KEY_DATABLOB, &amp;key);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置盐值。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *saltData = <span class="hljs-string">"saltstring"</span>;</li><li>    Crypto_DataBlob salt = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(saltData)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(saltData)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SALT_DATABLOB, &amp;salt);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置应用程序特定信息（可选）。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *infoData = <span class="hljs-string">"infostring"</span>;</li><li>    Crypto_DataBlob info = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(infoData)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(infoData)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_INFO_DATABLOB, &amp;info);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建密钥派生函数对象。</span></li><li>    OH_CryptoKdf *kdfCtx = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Create</span>(<span class="hljs-string">"HKDF|SHA256|EXTRACT_AND_EXPAND"</span>, &amp;kdfCtx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 派生密钥。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">uint32_t</span> keyLength = <span class="hljs-number">32</span>; <span class="hljs-comment">// 生成32字节的密钥。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Derive</span>(kdfCtx, params, keyLength, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Derived key length: %u\n"</span>, out.len);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>    <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>