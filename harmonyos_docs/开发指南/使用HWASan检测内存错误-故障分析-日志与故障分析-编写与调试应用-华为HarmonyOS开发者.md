<h1 _ngcontent-wmw-c119="" class="doc-title ng-star-inserted" title="使用HWASan检测内存错误"> 使用HWASan检测内存错误 </h1>

<div _ngcontent-wmw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000002062364617"><p id="ZH-CN_TOPIC_0000002478334490__p179511281708">HWASan（Hardware-Assisted Address Sanitizer）是一款类似于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-asan">ASan</a>的内存错误检测工具。 与ASan相比，HWASan使用的内存减少很多，因而更适合用于整个系统的清理。关于HWASan的检测原理和异常检测类型请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-hwasan-detection" target="_blank">HWASan</a>。</p> <div class="tiledSection"><h2 id="section133541626131519">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section133541626131519" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002478334490__p147958281506">与ASan相比，HWASan具有如下特征：</p> <ul id="ZH-CN_TOPIC_0000002478334490__ul2640644181619"><li id="li12640114414163">CPU开销约为2倍。</li><li id="li13136946171613">代码大小开销为40% - 50%。</li><li id="li1653484710167">RAM开销为10% - 35%。</li></ul> <p id="ZH-CN_TOPIC_0000002478334490__p1779617285013">HWASan能检测到ASan所能检测到的同一系列错误：</p> <ul id="ZH-CN_TOPIC_0000002478334490__ul794532914619"><li id="li1394616291163">堆栈和堆缓冲区上溢/下溢。</li><li id="li14346123216618">释放之后的堆使用情况。</li><li id="li113183619617">重复释放/错误释放。</li></ul> <p id="ZH-CN_TOPIC_0000002478334490__p11796128303">和ASan相比，HWASan具有以下优点：</p> <ul id="ZH-CN_TOPIC_0000002478334490__ul8697023142617"><li id="li069732311268">HWASan不需要安全区来检测buffer overflow，既极大地降低了工具对于内存的消耗，也不会出现ASan中某些overflow检测不到的情况。</li><li id="li1604225192611">HWASan不需要隔离区来检测UseAfterFree，因此不会出现ASan中某些UseAfterFree检测不到的情况。</li><li id="li06428279811">对于内存二次释放free场景，使能HWASan，无需代码插桩也能检测。</li><li id="li4440326163918">此外，HWASan还可以检测返回之后的堆栈使用情况。</li></ul> <p id="ZH-CN_TOPIC_0000002478334490__p2046212153719">从DevEco Studio 5.1.1 Beta1版本开始，HWASan检测能力增强：</p> <ul id="ZH-CN_TOPIC_0000002478334490__ul17859142153814"><li id="li2859442113816">UseAfterFree检测能力增强，能够检测到未插桩代码的UseAfterFree行为。</li></ul> </div> <div class="tiledSection"><h2 id="section498613573569">约束条件<i class="anchor-icon anchor-icon-link" anchorid="section498613573569" tips="复制节点链接"></i></h2><ul id="ZH-CN_TOPIC_0000002478334490__ul14251114611919"><li id="li125174614910">HWASan检测仅适用于AArch64架构的硬件。</li><li id="li2065910471997">ASan、TSan、UBSan、HWASan不能同时开启，四个只能开启其中一个。</li></ul> </div> <div class="tiledSection"><h2 id="section38898177587">使能HWASan<i class="anchor-icon anchor-icon-link" anchorid="section38898177587" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section62000715418" class="firsth2">方式一<i class="anchor-icon anchor-icon-link" anchorid="section62000715418" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002478334490__p137001524113015">点击<strong><strong>Run &gt; Edit Configurations &gt;</strong> Diagnostics</strong>，勾选<strong>Hardware-Assisted Address Sanitizer</strong>开启检测。</p> <p id="ZH-CN_TOPIC_0000002478334490__p2095819231657"><span><img originheight="277" originwidth="675" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104840.05595104367506938114937723362287:50001231000000:2800:40BB7EDCE9E34824008015A375F0F108EFCEA3572F32F9B1A560674E93D67CDE.png" width="675" height="277"></span></p> </div> <div class="tiledSection"><h3 id="section31022911513">方式二<i class="anchor-icon anchor-icon-link" anchorid="section31022911513" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002478334490__ol86211583456"><li id="li3626582453">修改工程目录下的AppScope/app.json5文件，添加HWASan配置开关。<div _ngcontent-wmw-c106="" class="highlight-div"><div _ngcontent-wmw-c106="" class="highlight-div-header"><div _ngcontent-wmw-c106="" class="highlight-div-header-left"><div _ngcontent-wmw-c106="" class="handle-button expand-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wmw-c106="" class="highlight-div-header-right"><div _ngcontent-wmw-c106="" class="handle-button ai-button"></div><div _ngcontent-wmw-c106="" class="handle-button line-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wmw-c106="" class="handle-button theme-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wmw-c106="" class="handle-button copy-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wmw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478334490__screen1020855412382" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"hwasanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478334490__p207025404312"><span><img originheight="203" originwidth="989" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104840.23830016303193018116681763846521:50001231000000:2800:C99F7A1869FBF530A838993F0361E1BD019124123A43EDEDD3A62D6CB6C423A1.png" width="920" height="188.8372093023256"></span></p> </li><li id="li462558114515">在需要使能HWASan的模块中，通过添加构建参数开启HWASan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数：<div _ngcontent-wmw-c106="" class="highlight-div"><div _ngcontent-wmw-c106="" class="highlight-div-header"><div _ngcontent-wmw-c106="" class="highlight-div-header-left"><div _ngcontent-wmw-c106="" class="handle-button expand-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wmw-c106="" class="highlight-div-header-right"><div _ngcontent-wmw-c106="" class="handle-button ai-button"></div><div _ngcontent-wmw-c106="" class="handle-button line-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wmw-c106="" class="handle-button theme-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wmw-c106="" class="handle-button copy-button"><div _ngcontent-wmw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wmw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478334490__screen145851536135510" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_HWASAN=ON"</span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478334490__p1590626682"><span><img originheight="175" originwidth="443" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104840.49561397701169290920816641838674:50001231000000:2800:0CAC5412E111CF147A42AD81ABFB6383B7023A0684D84C5FAC96983DFA0CD7ED.png" width="443" height="175"></span></p> </li></ol> </div> <div class="tiledSection"><h2 id="section1080616409587">启用HWASan<i class="anchor-icon anchor-icon-link" anchorid="section1080616409587" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478334490__ol187491562592"><li id="li1606115855917">运行或调试当前应用。</li><li id="li1074911569593">当程序出现内存错误时，弹出HWASan log信息，点击信息中的链接即可跳转至引起内存错误的代码处。<p id="ZH-CN_TOPIC_0000002478334490__p135731853153915"><span><img originheight="730" originwidth="1428" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104840.73841150714818032456805944590058:50001231000000:2800:2D9713FF7F53ABBC32C59CB5116D52054CF55D1948A86A595DE6EC3B5DB0D44D.png" width="920" height="470.30812324929974"></span></p> </li><li id="li1733431252611">如果是release应用，本地无工程代码，可以使用AnalyzeStackTrace功能，提供要解析堆栈的so，解析结果为源码地址。<p id="ZH-CN_TOPIC_0000002478334490__p41504113300"><span><img originheight="400" originwidth="1460" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104840.97680357155081156021539841077991:50001231000000:2800:4544D9A2DCB4849671F3A4B7B89276DE0145CB794022A78DD61DFBA6E45A3566.png" width="920" height="252.05479452054794"></span></p> </li></ol> </div> </div> <div></div></div>