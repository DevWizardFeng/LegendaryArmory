<h1 _ngcontent-cnw-c119="" class="doc-title ng-star-inserted" title="使用HiCollie检测业务线程卡死卡顿问题（C/C++）"> 使用HiCollie检测业务线程卡死卡顿问题（C/C++） </h1>

<div _ngcontent-cnw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>用户在使用应用时，如果出现点击无反应或应用无响应等情况，并且持续时间超过一定限制，就会被定义为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines">应用冻屏</a>。本文面向开发者介绍HiCollie模块对外提供检测业务线程卡死、卡顿，以及上报卡死事件的能力。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_Init_StuckDetection</td>         <td class="cellrowborder" valign="top" width="50%">          <p>注册应用业务线程卡死的周期性检测任务。用户实现回调函数, 用于定时检测业务线程卡死情况。</p>          <p>默认检测时间：3s上报BUSSINESS_THREAD_BLOCK_3S告警事件，6s上报BUSSINESS_THREAD_BLOCK_6S卡死事件。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_Init_StuckDetectionWithTimeout</td>         <td class="cellrowborder" valign="top" width="50%">          <p>注册应用业务线程卡死的周期性检测任务。用户实现回调函数, 用于定时检测业务线程卡死情况。</p>          <p>开发者可以设置卡死检测时间，可设置的时间范围：[3, 15]，单位：s。</p>          <p>说明：从API version 18开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_Init_JankDetection</td>         <td class="cellrowborder" valign="top" width="50%">          <p>注册应用业务线程卡顿检测的回调函数。</p>          <p>线程卡顿监控功能需要开发者实现两个卡顿检测回调函数，分别放在业务线程处理事件的前后。作为插桩函数，监控业务线程处理事件执行情况。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_Report</td>         <td class="cellrowborder" valign="top" width="50%">          <p>上报应用业务线程卡死事件，生成卡死故障日志，辅助定位应用卡死问题。</p>          <p>先调用OH_HiCollie_Init_StuckDetection或OH_HiCollie_Init_StuckDetectionWithTimeout接口，初始化检测的task；</p>          <p>如果task任务超时，结合业务逻辑，调用OH_HiCollie_Report接口上报卡死事件。</p></td>        </tr>             </tbody></table></div>     </div>     <p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hicollie-h" target="_blank">HiCollie</a>。</p>    </div>    <div class="tiledSection">     <h2 id="检测原理">检测原理<i class="anchor-icon anchor-icon-link" anchorid="检测原理" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>业务线程卡顿OH_HiCollie_Init_JankDetection故障规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events#检测原理">主线程超时事件检测原理</a>。</p></li>      <li>       <p>业务线程卡死故障：</p>       <p>（1）OH_HiCollie_Init_StuckDetection检测原理：应用的watchdog线程会周期性进行业务线程判活检测。当判活检测超过3s没有被执行，上报BUSSINESS_THREAD_BLOCK_3S线程告警事件；超过6s依然没有被执行，会上报BUSSINESS_THREAD_BLOCK_6S线程卡死事件。两个事件根据系统匹配规则生成appfreeze故障日志。</p>       <p>（2）OH_HiCollie_Init_StuckDetectionWithTimeout检测原理：应用的watchdog线程会周期性进行业务线程判活检测。当判活检测超过stuckTimeout时间没有被执行，上报BUSSINESS_THREAD_BLOCK_3S告警事件；超过stuckTimeout * 2时间，依然没有被执行，会上报BUSSINESS_THREAD_BLOCK_6S线程卡死事件。两个事件匹配生成appfreeze故障日志。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="日志规格">日志规格<i class="anchor-icon anchor-icon-link" anchorid="日志规格" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>业务线程卡死故障日志以appfreeze-开头，生成在“设备/data/log/faultlog/faultlogger/”路径下。该日志文件名格式为“appfreeze-应用包名-应用UID-秒级时间”。具体规格可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines#日志规格">应用冻屏（AppFreeze）日志规格</a>。</p></li>      <li>       <p>OH_HiCollie_Init_StuckDetection日志规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/apptask-timeout-guidelines#日志规格">主线程超时事件日志规格</a>。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>下文将展示如何在应用内增加一个按钮，并单击该按钮以调用HiCollie Ndk接口。</p>     <ol>      <li>       <p>新建Native C++工程，目录结构如下：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="yml prettyprint linenums hljs language-yaml" hw-language="yml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">entry:</span></li><li>  <span class="hljs-attr">src:</span></li><li>    <span class="hljs-attr">main:</span></li><li>      <span class="hljs-attr">cpp:</span></li><li>        <span class="hljs-attr">types:</span></li><li>          <span class="hljs-attr">libentry:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">index.d.ts</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">CMakeLists.txt</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">napi_init.cpp</span></li><li>      <span class="hljs-attr">ets:</span></li><li>        <span class="hljs-attr">entryability:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-string">EntryAbility.ts</span></li><li>        <span class="hljs-attr">pages:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-string">Index.ets</span></li></ol></pre></div></div></li>      <li>       <p>编辑“CMakeLists.txt”文件，添加源文件及动态库：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 新增动态库依赖libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(日志输出)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libohhicollie.so)</li></ol></pre></div></div></li>      <li>       <p>编辑“napi_init.cpp”文件，导入依赖的文件，定义LOG_TAG，下述代码步骤用于模拟卡死卡顿场景，具体使用请结合业务需要。示例代码如下：</p>       <p>（1）<strong>应用线程卡顿检测</strong>： OH_HiCollie_Init_JankDetection，示例代码如下：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hicollie/hicollie.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"JankTest"</span></span></li><li>
</li><li><span class="hljs-comment">//定义两个回调函数对象</span></li><li><span class="hljs-type">static</span> OH_HiCollie_BeginFunc beginFunc_;</li><li><span class="hljs-type">static</span> OH_HiCollie_EndFunc endFunc_;</li><li>
</li><li><span class="hljs-comment">//定义监控应用显示开始、结束的回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitBeginFunc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* eventName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(eventName)</span></span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"InitBeginFunc eventName: %{public}s"</span>, str.<span class="hljs-built_in">c_str</span>());</li><li>}</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitEndFunc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* eventName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(eventName)</span></span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"OH_HiCollie_EndFunc eventName: %{public}s"</span>, str.<span class="hljs-built_in">c_str</span>());</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">StartDelayTimer</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>  <span class="hljs-comment">//等待1s</span></li><li>  std::<span class="hljs-function">chrono::seconds <span class="hljs-title">delay</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>;</li><li>  <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"OH_HiCollie_Init_JankDetection delay before"</span>);</li><li>  std::this_thread::<span class="hljs-built_in">sleep_for</span>(delay);</li><li>  <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"OH_HiCollie_Init_JankDetection delay after"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">//定义子线程回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestJankDetection</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 初始化回调函数参数</span></li><li>    beginFunc_ = InitBeginFunc;</li><li>    endFunc_ = InitEndFunc;</li><li>    HiCollie_DetectionParam param {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-comment">// 初始化线程卡顿监控函数</span></li><li>    <span class="hljs-type">int</span> initResult = <span class="hljs-built_in">OH_HiCollie_Init_JankDetection</span>(&amp;beginFunc_, &amp;endFunc_, param);</li><li>    <span class="hljs-comment">// 线程启动1s内，不进行检测</span></li><li>    <span class="hljs-built_in">StartDelayTimer</span>();</li><li>    <span class="hljs-comment">// 成功结果：0</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"OH_HiCollie_Init_JankDetection: %{public}d"</span>, initResult);</li><li>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-number">3</span>) {</li><li>        <span class="hljs-comment">// 设置处理开始回调函数，监控线程任务执行开始时长</span></li><li>        <span class="hljs-built_in">beginFunc_</span>(<span class="hljs-string">"TestBegin"</span>);</li><li>        <span class="hljs-comment">// 休眠350ms，模拟任务线程处理事件卡顿场景</span></li><li>        <span class="hljs-built_in">usleep</span>(<span class="hljs-number">350</span> * <span class="hljs-number">1000</span>);</li><li>        <span class="hljs-comment">// 设置处理结束回调函数，监控线程任务执行结束时长</span></li><li>        <span class="hljs-built_in">endFunc_</span>(<span class="hljs-string">"TestEnd"</span>);</li><li>        count++;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestHiCollieJankNdk</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建子线程</span></li><li>    <span class="hljs-function">std::thread <span class="hljs-title">threadObj</span><span class="hljs-params">(TestJankDetection)</span></span>;</li><li>    <span class="hljs-comment">// 执行TestJankDetection任务</span></li><li>    threadObj.<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"testHiCollieJankNdk"</span>, <span class="hljs-literal">nullptr</span>, TestHiCollieJankNdk, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>       <p>（2）<strong>应用线程卡死检测</strong>： OH_HiCollie_Init_StuckDetection, 示例代码如下：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"napi/native_api.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"hilog/log.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"hicollie/hicollie.h"</span></li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">atomic</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">thread</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">string</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">unistd</span>.<span class="hljs-title class_">h</span>&gt;</li><li>
</li><li>#<span class="hljs-variable">undef</span> <span class="hljs-variable">LOG_TAG</span></li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">LOG_TAG</span> <span class="hljs-string">"StruckTest"</span></li><li>
</li><li><span class="hljs-comment">// 自定义休眠时间，模拟卡死场景</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">int64_t</span> <span class="hljs-variable">BLOCK_TIME</span> = <span class="hljs-number">3</span>;</li><li><span class="hljs-comment">// 设置应用线程执行任务情况标志位, true-正常，false-卡死</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt; <span class="hljs-title class_">appThreadIsAlive_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt;(<span class="hljs-keyword">true</span>);</li><li><span class="hljs-comment">// 设置上报应用线程卡死事件标志位</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt; <span class="hljs-title class_">isSixSecondEvent_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt;(<span class="hljs-keyword">false</span>);</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">ReportEvent</span>() {</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">temp</span> = <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">load</span>();</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">reportResult</span> = <span class="hljs-title function_">OH_HiCollie_Report</span>(&amp;<span class="hljs-title class_">temp</span>);</li><li>    <span class="hljs-comment">// 成功：0</span></li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"OH_HiCollie_Report: %{public}d, isSixSecondEvent: %{public}d"</span>, <span class="hljs-variable">reportResult</span>, <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">load</span>());</li><li>    <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-title class_">temp</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">SetTimeout</span>()</li><li>{</li><li>  <span class="hljs-variable">int64_t</span> <span class="hljs-variable">now</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>&gt;(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::</li><li>    <span class="hljs-variable">system_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title class_">count</span>();</li><li>  <span class="hljs-title function_">sleep</span>(<span class="hljs-variable">BLOCK_TIME</span>);</li><li>  <span class="hljs-variable">int64_t</span> <span class="hljs-variable">currentTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>&gt;(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::</li><li>    <span class="hljs-variable">system_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title class_">count</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">currentTime</span> - <span class="hljs-variable">now</span> &lt; <span class="hljs-title class_">BLOCK_TIME</span>) {</li><li>    <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">true</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者可自定义周期性检测任务</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Timer</span>()</li><li>{</li><li>  <span class="hljs-comment">// 每隔3s检查应用是否正常执行任务</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">load</span>()) {</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"Check appThread isAlive."</span>);</li><li>    <span class="hljs-comment">// 更新appThreadIsAlive_，正常执行下次检测时为true</span></li><li>    <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>    <span class="hljs-comment">// 模拟超时场景</span></li><li>    <span class="hljs-title function_">SetTimeout</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-title function_">ReportEvent</span>();</li><li>}</li><li>
</li><li><span class="hljs-comment">//定义子线程回调函数</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">InitStuckDetection</span>()</li><li>{</li><li>  <span class="hljs-comment">// 初始化线程卡死监控函数</span></li><li>  <span class="hljs-variable">int</span> <span class="hljs-variable">initResult</span> = <span class="hljs-title function_">OH_HiCollie_Init_StuckDetection</span>(<span class="hljs-variable">Timer</span>);</li><li>  <span class="hljs-comment">// 成功结果：0</span></li><li>  <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"OH_HiCollie_Init_StuckDetection: %{public}d"</span>, <span class="hljs-variable">initResult</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">TestHiCollieStuckNdk</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>)</li><li>{</li><li>  <span class="hljs-comment">// 创建子线程</span></li><li>  <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">threadObj</span>(<span class="hljs-title class_">InitStuckDetection</span>);</li><li>  <span class="hljs-comment">// 执行任务</span></li><li>  <span class="hljs-variable">threadObj</span>.<span class="hljs-title function_">join</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">EXTERN_C_START</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">Init</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_value</span> <span class="hljs-variable">exports</span>)</li><li>{</li><li>    <span class="hljs-variable">napi_property_descriptor</span> <span class="hljs-variable">desc</span>[] = {</li><li>        { <span class="hljs-string">"testHiCollieStuckNdk"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">TestHiCollieStuckNdk</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span> },</li><li>    };</li><li>    <span class="hljs-title function_">napi_define_properties</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">exports</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>[<span class="hljs-number">0</span>]), <span class="hljs-variable">desc</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">exports</span>;</li><li>}</li><li><span class="hljs-variable">EXTERN_C_END</span></li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_module</span> <span class="hljs-variable">demoModule</span> = {</li><li>    .<span class="hljs-variable">nm_version</span> = <span class="hljs-number">1</span>,</li><li>    .<span class="hljs-variable">nm_flags</span> = <span class="hljs-number">0</span>,</li><li>    .<span class="hljs-variable">nm_filename</span> = <span class="hljs-variable">nullptr</span>,</li><li>    .<span class="hljs-variable">nm_register_func</span> = <span class="hljs-variable">Init</span>,</li><li>    .<span class="hljs-variable">nm_modname</span> = <span class="hljs-string">"entry"</span>,</li><li>    .<span class="hljs-variable">nm_priv</span> = ((<span class="hljs-variable">void</span>*)<span class="hljs-number">0</span>),</li><li>    .<span class="hljs-variable">reserved</span> = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-variable">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-title function_">__attribute__</span>((<span class="hljs-variable">constructor</span>)) <span class="hljs-variable">void</span> <span class="hljs-title function_">RegisterEntryModule</span>(<span class="hljs-variable">void</span>)</li><li>{</li><li>    <span class="hljs-title function_">napi_module_register</span>(&amp;<span class="hljs-title class_">demoModule</span>);</li><li>}</li></ol></pre></div></div>       <p>（3）<strong>应用线程卡死检测，自定义检测时间</strong>： OH_HiCollie_Init_StuckDetectionWithTimeout，示例代码如下：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"napi/native_api.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"hilog/log.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"hicollie/hicollie.h"</span></li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">thread</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">string</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">unistd</span>.<span class="hljs-title class_">h</span>&gt;</li><li>
</li><li>#<span class="hljs-variable">undef</span> <span class="hljs-variable">LOG_TAG</span></li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">LOG_TAG</span> <span class="hljs-string">"StruckTest"</span></li><li>
</li><li><span class="hljs-comment">// 自定义休眠时间，模拟卡死场景</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">int64_t</span> <span class="hljs-variable">BLOCK_TIME</span> = <span class="hljs-number">5</span>;</li><li><span class="hljs-comment">// 设置应用线程执行任务情况标志位, true-正常， false-卡死</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt; <span class="hljs-title class_">appThreadIsAlive_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt;(<span class="hljs-keyword">true</span>);</li><li><span class="hljs-comment">// 设置上报应用线程卡死事件标志位</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt; <span class="hljs-title class_">isSixSecondEvent_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic</span>&lt;<span class="hljs-title class_">bool</span>&gt;&gt;(<span class="hljs-keyword">false</span>);</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">ReportEvent</span>() {</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">temp</span> = <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">load</span>();</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">reportResult</span> = <span class="hljs-title function_">OH_HiCollie_Report</span>(&amp;<span class="hljs-title class_">temp</span>);</li><li>    <span class="hljs-comment">// 成功：0</span></li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"OH_HiCollie_Report: %{public}d, isSixSecondEvent: %{public}d"</span>, <span class="hljs-variable">reportResult</span>, <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">load</span>());</li><li>    <span class="hljs-variable">isSixSecondEvent_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-title class_">temp</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">SetTimeout</span>()</li><li>{</li><li>  <span class="hljs-variable">int64_t</span> <span class="hljs-variable">now</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>&gt;(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::</li><li>    <span class="hljs-variable">system_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title class_">count</span>();</li><li>  <span class="hljs-title function_">sleep</span>(<span class="hljs-variable">BLOCK_TIME</span>);</li><li>  <span class="hljs-variable">int64_t</span> <span class="hljs-variable">currentTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>&gt;(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::</li><li>    <span class="hljs-variable">system_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title class_">count</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">currentTime</span> - <span class="hljs-variable">now</span> &lt; <span class="hljs-title class_">BLOCK_TIME</span>) {</li><li>    <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">true</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者可自定义周期性检测任务</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Timer</span>()</li><li>{</li><li>  <span class="hljs-comment">// 每隔5s检查应用是否正常执行任务</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">load</span>()) {</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"Check appThread isAlive."</span>);</li><li>    <span class="hljs-comment">// 更新appThreadIsAlive_，正常执行下次检测时为true</span></li><li>    <span class="hljs-variable">appThreadIsAlive_</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>    <span class="hljs-comment">// 模拟超时场景</span></li><li>    <span class="hljs-title function_">SetTimeout</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-title function_">ReportEvent</span>();</li><li>}</li><li>
</li><li><span class="hljs-comment">//定义子线程回调函数</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">InitStuckDetectionWithTimeout</span>()</li><li>{</li><li>  <span class="hljs-comment">// 初始化线程卡死监控函数</span></li><li>  <span class="hljs-variable">int</span> <span class="hljs-variable">initResult</span> = <span class="hljs-title function_">OH_HiCollie_Init_StuckDetectionWithTimeout</span>(<span class="hljs-variable">Timer</span>, <span class="hljs-variable">BLOCK_TIME</span>);</li><li>  <span class="hljs-comment">// 成功结果：0</span></li><li>  <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"OH_HiCollie_Init_StuckDetection: %{public}d"</span>, <span class="hljs-variable">initResult</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">TestHiCollieStuckWithTimeoutNdk</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>)</li><li>{</li><li>  <span class="hljs-comment">// 创建子线程</span></li><li>  <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">threadObj</span>(<span class="hljs-title class_">InitStuckDetectionWithTimeout</span>);</li><li>  <span class="hljs-comment">// 执行任务</span></li><li>  <span class="hljs-variable">threadObj</span>.<span class="hljs-title function_">join</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">EXTERN_C_START</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">Init</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_value</span> <span class="hljs-variable">exports</span>)</li><li>{</li><li>    <span class="hljs-variable">napi_property_descriptor</span> <span class="hljs-variable">desc</span>[] = {</li><li>        { <span class="hljs-string">"testHiCollieStuckWithTimeoutNdk"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">TestHiCollieStuckWithTimeoutNdk</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span> },</li><li>    };</li><li>    <span class="hljs-title function_">napi_define_properties</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">exports</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>[<span class="hljs-number">0</span>]), <span class="hljs-variable">desc</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">exports</span>;</li><li>}</li><li><span class="hljs-variable">EXTERN_C_END</span></li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_module</span> <span class="hljs-variable">demoModule</span> = {</li><li>    .<span class="hljs-variable">nm_version</span> = <span class="hljs-number">1</span>,</li><li>    .<span class="hljs-variable">nm_flags</span> = <span class="hljs-number">0</span>,</li><li>    .<span class="hljs-variable">nm_filename</span> = <span class="hljs-variable">nullptr</span>,</li><li>    .<span class="hljs-variable">nm_register_func</span> = <span class="hljs-variable">Init</span>,</li><li>    .<span class="hljs-variable">nm_modname</span> = <span class="hljs-string">"entry"</span>,</li><li>    .<span class="hljs-variable">nm_priv</span> = ((<span class="hljs-variable">void</span>*)<span class="hljs-number">0</span>),</li><li>    .<span class="hljs-variable">reserved</span> = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-variable">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-title function_">__attribute__</span>((<span class="hljs-variable">constructor</span>)) <span class="hljs-variable">void</span> <span class="hljs-title function_">RegisterEntryModule</span>(<span class="hljs-variable">void</span>)</li><li>{</li><li>    <span class="hljs-title function_">napi_module_register</span>(&amp;<span class="hljs-title class_">demoModule</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>将TestHiCollieNdk注册为ArkTS接口。</p>       <p>（1）OH_HiCollie_Init_JankDetection示例，编辑“index.d.ts”文件，定义ArkTS接口：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testHiCollieJankNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>       <p>（2）OH_HiCollie_Init_StuckDetection示例，编辑“index.d.ts”文件，定义ArkTS接口：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testHiCollieStuckNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>       <p>（3）OH_HiCollie_Init_StuckDetectionWithTimeout示例，编辑“index.d.ts”文件，定义ArkTS接口：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testHiCollieStuckWithTimeoutNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑“Index.ets”文件：</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">//选择下方对应的功能，可在此处添加不同的点击事件</span></li><li>        </li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>（1）添加点击事件，触发OH_HiCollie_Init_JankDetection方法。</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testHiCollieJankNdk"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(testNapi.<span class="hljs-property">testHiCollieJankNdk</span>);</li><li>}</li></ol></pre></div></div>       <p>（2）添加点击事件，触发OH_HiCollie_Init_StuckDetection方法。</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testHiCollieStuckNdk"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(testNapi.<span class="hljs-property">testHiCollieStuckNdk</span>);</li><li>}</li></ol></pre></div></div>       <p>（3）添加点击事件，触发OH_HiCollie_Init_StuckDetectionWithTimeout方法。</p>       <div _ngcontent-cnw-c106="" class="highlight-div"><div _ngcontent-cnw-c106="" class="highlight-div-header"><div _ngcontent-cnw-c106="" class="highlight-div-header-left"><div _ngcontent-cnw-c106="" class="handle-button expand-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cnw-c106="" class="highlight-div-header-right"><div _ngcontent-cnw-c106="" class="handle-button ai-button"></div><div _ngcontent-cnw-c106="" class="handle-button line-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cnw-c106="" class="handle-button theme-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cnw-c106="" class="handle-button copy-button"><div _ngcontent-cnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cnw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Button</span>(<span class="hljs-string">"testHiCollieStuckWithTimeoutNdk"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(testNapi.<span class="hljs-property">testHiCollieStuckWithTimeoutNdk</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。</p></li>      <li>       <p>在DevEco Studio的底部，切换到“Log”窗口，过滤自定义的LOG_TAG。</p>       <p>（1）点击“testHiCollieJankNdk”按钮。</p>       <p>此时窗口将显示通过OH_HiCollie_Init_JankDetection接口获取的应用业务线程采样栈的超时信息。可以通过订阅hiappevent获取对应的事件，参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events-arkts">订阅主线程超时事件</a>。</p>       <p>（2）点击“testHiCollieStuckNdk”按钮。</p>       <p>此时窗口将显示通过OH_HiCollie_Init_StuckDetection接口，初始化卡死检测回调函数。可以根据实际业务场景，自行定义卡死检测函数。</p>       <p>（3）点击“testHiCollieStuckWithTimeoutNdk”按钮。</p>       <p>此时窗口将显示通过OH_HiCollie_Init_StuckDetectionWithTimeout接口，初始化卡死检测回调函数。可以根据实际业务场景，自行定义卡死检测函数，及卡死检测时间。</p></li>     </ol>    </div>   </div>   <div></div></div>