<h1 _ngcontent-rxc-c119="" class="doc-title ng-star-inserted" title="使用HiCollie监控函数执行时间超长问题（C/C++）"> 使用HiCollie监控函数执行时间超长问题（C/C++） </h1>

<div _ngcontent-rxc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>任务执行超时指要监控的业务代码逻辑执行时长超过业务逻辑预期时间。本文面向开发者介绍HiCollie模块对外提供函数执行时间超长的检测能力。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_SetTimer</td>         <td class="cellrowborder" valign="top" width="50%">          <p>注册定时器，用于检测函数或代码块执行是否超过自定义时间。</p>          <p>结合OH_HiCollie_CancelTimer接口配套使用，应在调用耗时的函数之前使用。</p>          <p>说明：从API version 18开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_HiCollie_CancelTimer</td>         <td class="cellrowborder" valign="top" width="50%">          <p>取消定时器。</p>          <p>结合OH_HiCollie_SetTimer接口配套使用，执行函数或代码块后使用，OH_HiCollie_CancelTimer通过id将该任务取消；</p>          <p>若未在自定义时间内取消，则执行回调函数，在特定自定义超时动作下，生成故障日志。</p>          <p>说明：从API version 18开始，支持该接口。</p></td>        </tr>             </tbody></table></div>     </div>     <ul>      <li>       <p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hicollie-h" target="_blank">HiCollie</a>。</p></li>      <li>       <p>函数执行时间超长故障日志以syswarning-开头，生成在“设备/data/log/faultlog/faultlogger/”路径下。文件名格式为“syswarning-应用包名-应用UID-秒级时间.log”。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>下文将展示如何在应用内增加一个按钮，并单击该按钮以调用HiCollie Ndk接口。</p>     <ol>      <li>       <p>新建Native C++工程，目录结构如下：</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="yml prettyprint linenums hljs language-yaml" hw-language="yml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">entry:</span></li><li>  <span class="hljs-attr">src:</span></li><li>    <span class="hljs-attr">main:</span></li><li>      <span class="hljs-attr">cpp:</span></li><li>        <span class="hljs-attr">types:</span></li><li>          <span class="hljs-attr">libentry:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">index.d.ts</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">CMakeLists.txt</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">napi_init.cpp</span></li><li>      <span class="hljs-attr">ets:</span></li><li>        <span class="hljs-attr">entryability:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-string">EntryAbility.ts</span></li><li>        <span class="hljs-attr">pages:</span></li><li>          <span class="hljs-bullet">-</span> <span class="hljs-string">Index.ets</span></li></ol></pre></div></div></li>      <li>       <p>编辑“CMakeLists.txt”文件，添加源文件及动态库。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 依赖动态库libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>（日志输出），libohhicollie<span class="hljs-selector-class">.so</span>（HiCollie对外检测接口）</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libohhicollie.so)</li></ol></pre></div></div></li>      <li>       <p>编辑“napi_init.cpp”文件，导入依赖头文件、定义LOG_TAG与测试方法以及注册TestHiCollieTimerNdk为ArkTS接口。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hicollie/hicollie.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"testTag"</span></span></li><li>
</li><li><span class="hljs-comment">//定义回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CallBack</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span></span></li><li><span class="hljs-function"></span>{</li><li>  <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiCollieTimerNdk CallBack"</span>);  <span class="hljs-comment">// 回调函数中打印日志</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestHiCollieTimerNdk</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>  <span class="hljs-type">int</span> id;</li><li>  HiCollie_SetTimerParam param = {<span class="hljs-string">"testTimer"</span>, <span class="hljs-number">1</span>, CallBack, <span class="hljs-literal">nullptr</span>, HiCollie_Flag::HICOLLIE_FLAG_LOG};  <span class="hljs-comment">// 设置HiCollieTimer 参数（Timer任务名，超时时间，回调函数，回调函数参数，超时发生后行为）</span></li><li>  HiCollie_ErrorCode errorCode = <span class="hljs-built_in">OH_HiCollie_SetTimer</span>(param, &amp;id);  <span class="hljs-comment">// 注册HiCollieTimer函数执行时长超时检测一次性任务</span></li><li>  <span class="hljs-keyword">if</span> (errorCode == HICOLLIE_SUCCESS) {  <span class="hljs-comment">// HiCollieTimer任务注册成功</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiCollieTimer taskId: %{public}d"</span>, id); <span class="hljs-comment">// 打印任务id</span></li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);  <span class="hljs-comment">// 模拟执行耗时函数，在这里简单的将线程阻塞2s</span></li><li>    <span class="hljs-built_in">OH_HiCollie_CancelTimer</span>(id);  <span class="hljs-comment">// 根据id取消已注册任务</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"TestHiCollieTimerNdk"</span>, <span class="hljs-literal">nullptr</span>, TestHiCollieTimerNdk, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }      <span class="hljs-comment">// 将TestHiCollieTimerNdk注册为ArkTS接口</span></li><li>   };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编辑“index.d.ts”文件，定义ArkTS接口。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TestHiCollieTimerNdk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑“Index.ets”文件。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"TestHiCollieTimerNdk"</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(testNapi.<span class="hljs-property">TestHiCollieTimerNdk</span>);  <span class="hljs-comment">//添加点击事件，触发testHiCollieTimerNdk方法。</span></li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。</p></li>      <li>       <p>在DevEco Studio的底部，切换到“Log-&gt;HiLog”窗口，设置日志的过滤条件为“testTag”。</p>       <p>（1）点击“TestHiCollieTimerNdk”按钮执行程序，日志窗口打印任务id。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>.../testTag ... HiCollieTimer taskId: x</li></ol></pre></div></div>       <p>（2）等待2s后，执行回调函数，日志窗口打印。</p>       <div _ngcontent-rxc-c106="" class="highlight-div"><div _ngcontent-rxc-c106="" class="highlight-div-header"><div _ngcontent-rxc-c106="" class="highlight-div-header-left"><div _ngcontent-rxc-c106="" class="handle-button expand-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rxc-c106="" class="highlight-div-header-right"><div _ngcontent-rxc-c106="" class="handle-button ai-button"></div><div _ngcontent-rxc-c106="" class="handle-button line-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rxc-c106="" class="handle-button theme-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rxc-c106="" class="handle-button copy-button"><div _ngcontent-rxc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rxc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>.../testTag ... HiCollieTimerNdk CallBack</li></ol></pre></div></div>       <p>获取故障文件信息相关内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-apphicollie-events-ndk">订阅任务执行超时事件（C/C++）</a> 订阅获取。</p></li>     </ol>    </div>   </div>   <div></div></div>