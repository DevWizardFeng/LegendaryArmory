<h1 _ngcontent-vwl-c119="" class="doc-title ng-star-inserted" title="使用HiTraceChain打点（ArkTS）"> 使用HiTraceChain打点（ArkTS） </h1>

<div _ngcontent-vwl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>分布式跟踪接口由HiTraceChain模块提供，详细API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hitracechain" target="_blank">分布式跟踪ArkTS API</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.begin(name: string, flags?: number = HiTraceFlag.DEFAULT): HiTraceId</td>         <td class="cellrowborder" valign="top" width="50%">开始跟踪，并返回创建的HiTraceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.end(id: HiTraceId): void</td>         <td class="cellrowborder" valign="top" width="50%">结束跟踪。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.getId(): HiTraceId</td>         <td class="cellrowborder" valign="top" width="50%">获取跟踪标识。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.setId(id: HiTraceId): void</td>         <td class="cellrowborder" valign="top" width="50%">设置跟踪标识。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.clearId(): void</td>         <td class="cellrowborder" valign="top" width="50%">清除跟踪标识。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.createSpan(): HiTraceId</td>         <td class="cellrowborder" valign="top" width="50%">创建跟踪分支。创建一个HiTraceId，使用当前线程TLS中的chainId、spanId初始化HiTraceId的chainId、parentSpanId，并为HiTraceId生成一个新的spanId，返回该HiTraceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.isValid(id: HiTraceId): boolean</td>         <td class="cellrowborder" valign="top" width="50%">          <p>判断HiTraceId是否有效。</p>          <p>true：HiTraceId有效；false：HiTraceId无效。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.isFlagEnabled(id: HiTraceId, flag: HiTraceFlag): boolean</td>         <td class="cellrowborder" valign="top" width="50%">          <p>判断HiTraceId中指定的跟踪标志是否已启用。</p>          <p>true：指定的跟踪标志已启用；false：指定的跟踪标志未启用。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.enableFlag(id: HiTraceId, flag: HiTraceFlag): void</td>         <td class="cellrowborder" valign="top" width="50%">启用HiTraceId中指定的跟踪标志。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hiTraceChain.tracepoint(mode: HiTraceCommunicationMode, type: HiTraceTracepointType, id: HiTraceId, msg?: string): void</td>         <td class="cellrowborder" valign="top" width="50%">HiTraceMeter跟踪信息埋点。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>HiTraceChain在ArkTS中的使用方法参考以下示例，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracechain-intro#约束与限制">约束与限制</a>，了解常见的支持与不支持HiTraceChain自动传递的机制。</p>    </div>    <div class="tiledSection">     <h3 id="asyncawait和promisethen异步任务中使用hitracechain" class="firsth2">async/await和promise/then异步任务中使用HiTraceChain<i class="anchor-icon anchor-icon-link" anchorid="asyncawait和promisethen异步任务中使用hitracechain" tips="复制节点链接"></i></h3>          <p>async/await和promise/then异步任务支持HiTraceChain自动传递，示例结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-app-events-arkts">应用事件订阅</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracemeter-guidelines-arkts">HiTraceMeter性能跟踪</a>，说明分布式跟踪在ArkTS中的使用方法。</p>     <ol>      <li>       <p>在DevEco Studio中新建工程，选择“Empty Ability”，SDK版本选择19及以上（示例工程使用的HiTraceMeter接口从API version 19开始支持），工程的目录结构如下：</p>       <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>├── entry</li><li>│   ├── src</li><li>│       ├── main</li><li>│       │   ├── ets</li><li>│       │   │   ├── entryability</li><li>│       │   │   │   └── EntryAbility.ets</li><li>│       │   │   ├── entrybackupability</li><li>│       │   │   │   └── EntryBackupAbility.ets</li><li>│       │   │   └── pages</li><li>│       │   │       └── Index.ets</li></ol></pre></div></div></li>      <li>       <p>编辑“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，使用HiTraceChain跟踪异步任务，完整的示例代码如下：</p>       <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog, hiTraceChain, hiTraceMeter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test3</span>(<span class="hljs-params"></span>) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"test3"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test2</span>(<span class="hljs-params"></span>) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"test2"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test1</span>(<span class="hljs-params"></span>) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"test1_1"</span>);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">test2</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"test1_2"</span>);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">test3</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"test1_3"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"clickTime=0"</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">clickTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">350</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>++;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"clickTime="</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>;</li><li>            <span class="hljs-comment">// 业务开始前，开启分布式跟踪</span></li><li>            <span class="hljs-comment">// INCLUDE_ASYNC表示会在系统支持的异步机制里自动传递HiTraceId</span></li><li>            <span class="hljs-keyword">let</span> traceId = hiTraceChain.<span class="hljs-title function_">begin</span>(<span class="hljs-string">"testTag: hiTraceChain begin"</span>, hiTraceChain.<span class="hljs-property">HiTraceFlag</span>.<span class="hljs-property">INCLUDE_ASYNC</span>);</li><li>            <span class="hljs-comment">// 开始HiTraceMeter同步打点，该接口API version 19开始支持</span></li><li>            hiTraceMeter.<span class="hljs-title function_">startSyncTrace</span>(hiTraceMeter.<span class="hljs-property">HiTraceOutputLevel</span>.<span class="hljs-property">COMMERCIAL</span>, <span class="hljs-string">"onClick"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>
</li><li>            <span class="hljs-comment">// 在按钮点击函数中进行事件打点，以记录按钮点击事件</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">eventParams</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = { <span class="hljs-string">'click_time'</span>: <span class="hljs-number">100</span> };</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">eventInfo</span>: hiAppEvent.<span class="hljs-property">AppEventInfo</span> = {</li><li>              <span class="hljs-comment">// 事件领域定义</span></li><li>              <span class="hljs-attr">domain</span>: <span class="hljs-string">"button"</span>,</li><li>              <span class="hljs-comment">// 事件名称定义</span></li><li>              <span class="hljs-attr">name</span>: <span class="hljs-string">"click"</span>,</li><li>              <span class="hljs-comment">// 事件类型定义</span></li><li>              <span class="hljs-attr">eventType</span>: hiAppEvent.<span class="hljs-property">EventType</span>.<span class="hljs-property">BEHAVIOR</span>,</li><li>              <span class="hljs-comment">// 事件参数定义</span></li><li>              <span class="hljs-attr">params</span>: eventParams</li><li>            };</li><li>            hiAppEvent.<span class="hljs-title function_">write</span>(eventInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"Succeeded in writing an app event"</span>);</li><li>              <span class="hljs-comment">// 按钮点击事件处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in hiAppEvent"</span>);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">`HiAppEvent err.code: <span class="hljs-subst">${err.code}</span>, err.message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>              <span class="hljs-comment">// 异常处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in hiAppEvent"</span>);</li><li>            });</li><li>
</li><li>            <span class="hljs-comment">// 创建Promise对象执行随机数生成任务，若随机数大于0.5，则正常返回结果，反之则返回异常信息</span></li><li>            <span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span>, reject: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"promise task"</span>);</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">randomNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</li><li>              <span class="hljs-keyword">if</span> (randomNumber &gt; <span class="hljs-number">0.5</span>) {</li><li>                <span class="hljs-title function_">resolve</span>(randomNumber);</li><li>              } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Random number is too small'</span>));</li><li>              }</li><li>            });</li><li>
</li><li>            <span class="hljs-comment">// then方法的回调函数处理Promise对象的执行结果</span></li><li>            promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 成功时执行</span></li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"Random number is %{public}d"</span>, result);</li><li>              <span class="hljs-comment">// 回调函数处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in promise/then"</span>);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 失败时执行</span></li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, error.<span class="hljs-property">message</span>);</li><li>              <span class="hljs-comment">// 异常处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in promise/then"</span>);</li><li>            });</li><li>
</li><li>            <span class="hljs-comment">// 执行async/await异步任务</span></li><li>            <span class="hljs-keyword">let</span> res = <span class="hljs-title function_">test1</span>();</li><li>            <span class="hljs-comment">// then方法的回调函数处理异步任务的执行结果</span></li><li>            res.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"then task"</span>);</li><li>              <span class="hljs-comment">// 功能同hiTraceChain.end，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">clearId</span>();</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in async/await"</span>);</li><li>            });</li><li>
</li><li>            <span class="hljs-comment">// 结束HiTraceMeter同步打点，该接口API version 19开始支持</span></li><li>            hiTraceMeter.<span class="hljs-title function_">finishSyncTrace</span>(hiTraceMeter.<span class="hljs-property">HiTraceOutputLevel</span>.<span class="hljs-property">COMMERCIAL</span>);</li><li>            <span class="hljs-comment">// 业务结束后，关闭分布式跟踪</span></li><li>            hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in main thread"</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。在DevEco Studio Terminal窗口中执行以下命令，捕获10秒内的应用trace，并使用关键字“onClick”过滤示例代码中hiTraceMeter.startSyncTrace和hiTraceMeter.finishSyncTrace生成的trace日志。</p>       <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>PS D:\xxx\xxx&gt; hdc shell</li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hitrace -t 10 app | grep onClick</span></li></ol></pre></div></div></li>      <li>       <p>点击设备上的“clickTime=0”按钮（需在10秒内完成，否则步骤3捕获不到trace数据），触发业务逻辑。</p></li>      <li>       <p>查看运行结果。</p>       <ul>        <li>         <p>设备屏幕上按钮显示“clickTime=1”，表示点击了按钮一次，已触发业务逻辑。</p></li>        <li>         <p>在DevEco Studio Log窗口查看分布式跟踪的相关信息。</p>         <ul>          <li>           <p>示例所有hilog打印均使用了“testTag”，因此可以使用关键字“testTag”过滤日志，查看该业务代码打印的hilog日志。</p>           <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>06-04 17:46:45.156   55451-55451   C02D33/com.exa...tion/HiTraceC  com.examp...lication  I     [a92ab116052648e 0 0]HiTraceBegin name:testTag: hiTraceChain begin flags:0x01.</li><li>06-04 17:46:45.157   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 0 0]promise task</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 0 0]test1_1</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 0 0]test2</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     hiTraceChain end in main thread</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 3457eff 0]test1_2</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 3457eff 0]test3</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  E     [a92ab116052648e 1bb5a1b 35d9c46]Random number is too small</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     hiTraceChain end in promise/then</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 2ddfb70 3457eff]test1_3</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 225a1d9 2ddfb70]then task</li><li>06-04 17:46:45.158   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     hiTraceChain end in async/await</li><li>06-04 17:46:45.163   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab116052648e 3a75cb2 520a92]Succeeded in writing an app event</li><li>06-04 17:46:45.163   55451-55451   A00000/com.exa...ation/testTag  com.examp...lication  I     hiTraceChain end in hiAppEvent</li></ol></pre></div></div></li>          <li>           <p>hilog日志前附加的[chainId spanId parentSpanId]格式的信息即为HiTraceId信息，例如[a92ab116052648e 2ddfb70 3457eff]表示跟踪链标识chainId值为a92ab116052648e，分支标识spanId值为2ddfb70，父分支标识parentSpanId值为3457eff。</p></li>          <li>           <p>示例得到的跟踪链标识chainId值为a92ab116052648e，可使用chainId值过滤日志，查看业务完整的调用链hilog日志。</p></li>          <li>           <p>promise/then和async/await异步机制都会自动传递HiTraceId，并生成分支标识，例如示例hilog日志中的3457eff、2ddfb70、225a1d9等，均为异步任务自动生成的分支标识。</p></li>          <li>           <p>hiTraceChain.end()和hiTraceChain.clear()都可以结束跟踪，跟踪结束后，hilog日志不再携带HiTraceId信息。</p></li>         </ul></li>        <li>         <p>在DevEco Studio Terminal窗口查看trace数据，HiTraceChain跟踪开启期间，HiTraceMeter打点得到的trace日志会自动携带HiTraceId信息。</p>         <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li> e.myapplication-55451   (  55451) [010] .... 27164.174417: tracing_mark_write: B|55451|H:[a92ab116052648e,0,0]#onClick|M62|clickTime=1</li></ol></pre></div></div></li>       </ul></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="异步宏任务setinterval和settimeout中使用hitracechain">异步宏任务setInterval和setTimeout中使用HiTraceChain<i class="anchor-icon anchor-icon-link" anchorid="异步宏任务setinterval和settimeout中使用hitracechain" tips="复制节点链接"></i></h3>          <p>异步宏任务setInterval和setTimeout不支持HiTraceChain自动传递，以下示例说明如何使用hiTraceChain.getId()、hiTraceChain.setId()接口传递HiTraceId，如何使用hiTraceChain.createSpan()接口创建分支标识，进行分布式跟踪。</p>     <ol>      <li>       <p>在DevEco Studio中新建工程，选择“Empty Ability”，工程的目录结构如下：</p>       <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>├── entry</li><li>│   ├── src</li><li>│       ├── main</li><li>│       │   ├── ets</li><li>│       │   │   ├── entryability</li><li>│       │   │   │   └── EntryAbility.ets</li><li>│       │   │   ├── entrybackupability</li><li>│       │   │   │   └── EntryBackupAbility.ets</li><li>│       │   │   └── pages</li><li>│       │   │       └── Index.ets</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，使用HiTraceChain跟踪异步任务，完整的示例代码如下：</p>       <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog, hiTraceChain } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"clickTime=0"</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">clickTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">350</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>++;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"clickTime="</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>;</li><li>            <span class="hljs-comment">// 获取当前线程的HiTraceId</span></li><li>            <span class="hljs-keyword">let</span> traceId = hiTraceChain.<span class="hljs-title function_">getId</span>();</li><li>            <span class="hljs-comment">// 如果traceId无效，为当前线程开启分布式跟踪</span></li><li>            <span class="hljs-keyword">if</span> (!hiTraceChain.<span class="hljs-title function_">isValid</span>(traceId)) {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"HiTraceId is invalid, begin hiTraceChain"</span>);</li><li>              traceId = hiTraceChain.<span class="hljs-title function_">begin</span>(<span class="hljs-string">"testTag: hiTraceChain begin"</span>);</li><li>              <span class="hljs-comment">// 使能traceId的INCLUDE_ASYNC，INCLUDE_ASYNC表示会在系统支持的异步机制里自动传递HiTraceId</span></li><li>              hiTraceChain.<span class="hljs-title function_">enableFlag</span>(traceId, hiTraceChain.<span class="hljs-property">HiTraceFlag</span>.<span class="hljs-property">INCLUDE_ASYNC</span>);</li><li>              <span class="hljs-comment">// 将使能INCLUDE_ASYNC的HiTraceId设置到当前线程</span></li><li>              hiTraceChain.<span class="hljs-title function_">setId</span>(traceId);</li><li>              <span class="hljs-comment">// 查询INCLUDE_ASYNC是否设置成功</span></li><li>              <span class="hljs-keyword">if</span> (hiTraceChain.<span class="hljs-title function_">isFlagEnabled</span>(hiTraceChain.<span class="hljs-title function_">getId</span>(), hiTraceChain.<span class="hljs-property">HiTraceFlag</span>.<span class="hljs-property">INCLUDE_ASYNC</span>)) {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"HiTraceFlag INCLUDE_ASYNC is enabled"</span>);</li><li>              }</li><li>            }</li><li>
</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span>, reject: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 创建异步重复定时任务，每1s执行一次</span></li><li>              <span class="hljs-keyword">let</span> intervalID = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-comment">// 为当前异步重复定时任务设置HiTraceId</span></li><li>                hiTraceChain.<span class="hljs-title function_">setId</span>(traceId);</li><li>                <span class="hljs-keyword">const</span> <span class="hljs-attr">randomNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"Interval 1s: randomNumber is %{public}d"</span>, randomNumber);</li><li>                <span class="hljs-comment">// 关闭当前异步重复定时任务的分布式跟踪</span></li><li>                hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              }, <span class="hljs-number">1000</span>)</li><li>
</li><li>              <span class="hljs-comment">// 创建异步定时任务，2.5s后执行，结束异步重复定时任务</span></li><li>              <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-comment">// 为异步定时任务设置HiTraceId</span></li><li>                hiTraceChain.<span class="hljs-title function_">setId</span>(traceId);</li><li>                <span class="hljs-comment">// 为异步定时任务生成分支标识spanId</span></li><li>                <span class="hljs-keyword">let</span> traceIdTimeout = hiTraceChain.<span class="hljs-title function_">createSpan</span>();</li><li>                <span class="hljs-comment">// 为异步定时任务设置带spanId的HiTraceId</span></li><li>                hiTraceChain.<span class="hljs-title function_">setId</span>(traceIdTimeout);</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"setTimeout 2.5s"</span>);</li><li>                <span class="hljs-comment">// 结束异步重复定时任务</span></li><li>                <span class="hljs-built_in">clearInterval</span>(intervalID);</li><li>                <span class="hljs-keyword">const</span> <span class="hljs-attr">randomNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</li><li>                <span class="hljs-keyword">if</span> (randomNumber &gt; <span class="hljs-number">0.5</span>) {</li><li>                  <span class="hljs-title function_">resolve</span>(randomNumber);</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Random number is too small'</span>));</li><li>                }</li><li>                <span class="hljs-comment">// 关闭异步定时任务的分布式跟踪</span></li><li>                hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>              }, <span class="hljs-number">2500</span>)</li><li>            })</li><li>
</li><li>            promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 成功时执行</span></li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">"Random number is %{public}d"</span>, result);</li><li>              <span class="hljs-comment">// 回调函数处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 失败时执行</span></li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, error.<span class="hljs-property">message</span>);</li><li>              <span class="hljs-comment">// 异常处理结束，关闭异步处理分支的分布式跟踪</span></li><li>              hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>            });</li><li>
</li><li>            <span class="hljs-comment">// 业务结束后，关闭分布式跟踪</span></li><li>            hiTraceChain.<span class="hljs-title function_">end</span>(traceId);</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"hiTraceChain end in main thread"</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程，点击设备上“clickTime=0”按钮，触发业务逻辑。</p></li>      <li>       <p>查看运行结果。</p>       <ul>        <li>设备屏幕上按钮显示“clickTime=1”，表示点击了按钮一次，已触发业务逻辑。</li>        <li>在DevEco Studio Log窗口查看分布式跟踪的相关信息。         <ul>          <li>           <p>示例所有hilog打印均使用了“testTag”，因此可以使用关键字“testTag”过滤日志，查看该业务代码打印的hilog日志。</p>           <div _ngcontent-vwl-c106="" class="highlight-div"><div _ngcontent-vwl-c106="" class="highlight-div-header"><div _ngcontent-vwl-c106="" class="highlight-div-header-left"><div _ngcontent-vwl-c106="" class="handle-button expand-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vwl-c106="" class="highlight-div-header-right"><div _ngcontent-vwl-c106="" class="handle-button ai-button"></div><div _ngcontent-vwl-c106="" class="handle-button line-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vwl-c106="" class="handle-button theme-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vwl-c106="" class="handle-button copy-button"><div _ngcontent-vwl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vwl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>06-05 15:46:04.544   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     HiTraceId is invalid, begin hiTraceChain</li><li>06-05 15:46:04.544   49568-49568   C02D33/com.exa...tion/HiTraceC  com.examp...lication  I     [a92ab34b3c84ea7 0 0]HiTraceBegin name:testTag: hiTraceChain begin flags:0x00.</li><li>06-05 15:46:04.544   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab34b3c84ea7 0 0]HiTraceFlag INCLUDE_ASYNC is enabled</li><li>06-05 15:46:04.544   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     hiTraceChain end in main thread</li><li>06-05 15:46:05.547   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab34b3c84ea7 0 0]Interval 1s: randomNumber is 0.863610</li><li>06-05 15:46:06.548   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab34b3c84ea7 0 0]Interval 1s: randomNumber is 0.365460</li><li>06-05 15:46:07.047   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab34b3c84ea7 3cafdfd 0]setTimeout 2.5s</li><li>06-05 15:46:07.048   49568-49568   A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab34b3c84ea7 dc842f 3cafdfd]Random number is 0.524236</li></ol></pre></div></div></li>          <li>           <p>hilog日志前附加的[chainId spanId parentSpanId]格式的信息即为HiTraceId信息，例如[a92ab34b3c84ea7 dc842f 3cafdfd]表示跟踪链标识chainId值为a92ab34b3c84ea7，分支标识spanId值为dc842f，父分支标识parentSpanId值为3cafdfd。</p></li>          <li>           <p>示例得到的chainId值为a92ab34b3c84ea7，可使用chainId值过滤日志，查看业务完整的调用链hilog日志。</p></li>         </ul></li>       </ul></li>     </ol>    </div>   </div>   <div></div></div>