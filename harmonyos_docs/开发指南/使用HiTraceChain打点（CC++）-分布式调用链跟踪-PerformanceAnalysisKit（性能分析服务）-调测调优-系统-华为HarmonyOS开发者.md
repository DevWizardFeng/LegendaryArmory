<h1 _ngcontent-ldh-c119="" class="doc-title ng-star-inserted" title="使用HiTraceChain打点（C/C++）"> 使用HiTraceChain打点（C/C++） </h1>

<div _ngcontent-ldh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>分布式跟踪接口由HiTraceChain模块提供，详细API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-trace-h" target="_blank">分布式跟踪C API</a>。</p>     <p>下表所示的接口提供基本的分布式跟踪功能，ArkTS中也有相应的接口。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.3.1.1" valign="top" width="50%">方法</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.3.1.2" valign="top" width="50%">接口描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">HiTraceId OH_HiTrace_BeginChain(const char *name, int flags)</td>         <td class="cellrowborder" valign="top" width="50%">开始跟踪，并返回创建的HiTraceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_EndChain()</td>         <td class="cellrowborder" valign="top" width="50%">停止跟踪。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">HiTraceId OH_HiTrace_GetId()</td>         <td class="cellrowborder" valign="top" width="50%">从当前线程TLS中获取跟踪标识。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_SetId(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">将当前线程TLS中的跟踪标识设置为id。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_ClearId(void)</td>         <td class="cellrowborder" valign="top" width="50%">清除当前线程的跟踪标识。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">HiTraceId OH_HiTrace_CreateSpan(void)</td>         <td class="cellrowborder" valign="top" width="50%">创建跟踪分支。创建一个HiTraceId，使用当前线程TLS中的chainId、spanId初始化HiTraceId的chainId、parentSpanId，并为HiTraceId生成一个新的spanId，返回该HiTraceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">bool OH_HiTrace_IsIdValid(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>判断HiTraceId是否有效。</p>          <p>true：HiTraceId有效；false：HiTraceId无效。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">bool OH_HiTrace_IsFlagEnabled(const HiTraceId *id, HiTrace_Flag flag)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>判断HiTraceId中指定的跟踪标志是否已启用。</p>          <p>true：指定的跟踪标志已启用；false：指定的跟踪标志未启用。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_EnableFlag(const HiTraceId *id, HiTrace_Flag flag)</td>         <td class="cellrowborder" valign="top" width="50%">启用HiTraceId中指定的跟踪标志。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_Tracepoint(HiTrace_Communication_Mode mode, HiTrace_Tracepoint_Type type, const HiTraceId *id, const char *fmt, ...)</td>         <td class="cellrowborder" valign="top" width="50%">HiTraceMeter跟踪信息埋点。</td>        </tr>             </tbody></table></div>     </div>     <p>下表所示的接口提供对HiTraceId的一些拓展操作，这些接口仅在C/C++中提供。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.6.1.3.1.1" valign="top" width="50%">方法</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.6.1.3.1.2" valign="top" width="50%">接口描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_InitId(HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">初始化HiTraceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiTrace_GetFlags(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">获取HiTraceId中设置的跟踪标志位。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_SetFlags(HiTraceId *id, int flags)</td>         <td class="cellrowborder" valign="top" width="50%">设置跟踪标志位到HiTraceId中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">uint64_t OH_HiTrace_GetChainId(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">获取HiTraceId中的跟踪链ID。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_SetChainId(HiTraceId *id, uint64_t chainId)</td>         <td class="cellrowborder" valign="top" width="50%">设置跟踪链ID到HiTraceId中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">uint64_t OH_HiTrace_GetSpanId(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">获取HiTraceId中的分支ID。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_SetSpanId(HiTraceId *id, uint64_t spanId)</td>         <td class="cellrowborder" valign="top" width="50%">设置分支ID到HiTraceId中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">uint64_t OH_HiTrace_GetParentSpanId(const HiTraceId *id)</td>         <td class="cellrowborder" valign="top" width="50%">获取HiTraceId中的父分支ID。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_SetParentSpanId(HiTraceId *id, uint64_t parentSpanId)</td>         <td class="cellrowborder" valign="top" width="50%">设置父分支ID到HiTraceId中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiTrace_IdToBytes(const HiTraceId* id, uint8_t* pIdArray, int len)</td>         <td class="cellrowborder" valign="top" width="50%">将HiTraceId转换为字节数组，用于缓存或通信传递。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_IdFromBytes(HiTraceId *id, const uint8_t *pIdArray, int len)</td>         <td class="cellrowborder" valign="top" width="50%">根据字节数组创建HiTraceId。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>std::thread不支持自动传递HiTraceId，开发示例展示了该场景下分布式跟踪的使用方法。开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracechain-intro#约束与限制">约束与限制</a>，了解常见的支持与不支持HiTraceChain自动传递的机制。</p>     <ol>      <li>       <p>在DevEco Studio中新建工程，选择“Native C++”，工程的目录结构如下：</p>       <div _ngcontent-ldh-c106="" class="highlight-div"><div _ngcontent-ldh-c106="" class="highlight-div-header"><div _ngcontent-ldh-c106="" class="highlight-div-header-left"><div _ngcontent-ldh-c106="" class="handle-button expand-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldh-c106="" class="highlight-div-header-right"><div _ngcontent-ldh-c106="" class="handle-button ai-button"></div><div _ngcontent-ldh-c106="" class="handle-button line-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldh-c106="" class="handle-button theme-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldh-c106="" class="handle-button copy-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldh-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>├── entry</li><li>│   ├── src</li><li>│       ├── main</li><li>│       │   ├── cpp</li><li>│       │   │   ├── CMakeLists.txt</li><li>│       │   │   ├── napi_init.cpp</li><li>│       │   │   └── types</li><li>│       │   │       └── libentry</li><li>│       │   │           ├── Index.d.ts</li><li>│       │   │           └── oh-package.json5</li><li>│       │   ├── ets</li><li>│       │   │   ├── entryability</li><li>│       │   │   │   └── EntryAbility.ets</li><li>│       │   │   ├── entrybackupability</li><li>│       │   │   │   └── EntryBackupAbility.ets</li><li>│       │   │   └── pages</li><li>│       │   │       └── Index.ets</li></ol></pre></div></div></li>      <li>       <p>在“entry &gt; src &gt; main &gt; cpp &gt; CMakeLists.txt”文件中新增libhitrace_ndk.z.so和libhilog_ndk.z.so动态链接库，完整的文件内容如下：</p>       <div _ngcontent-ldh-c106="" class="highlight-div"><div _ngcontent-ldh-c106="" class="highlight-div-header"><div _ngcontent-ldh-c106="" class="highlight-div-header-left"><div _ngcontent-ldh-c106="" class="handle-button expand-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldh-c106="" class="highlight-div-header-right"><div _ngcontent-ldh-c106="" class="handle-button ai-button"></div><div _ngcontent-ldh-c106="" class="handle-button line-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldh-c106="" class="handle-button theme-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldh-c106="" class="handle-button copy-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldh-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)</li><li><span class="hljs-built_in">project</span>(HiTraceChainTest03)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhitrace_ndk.z.so libhilog_ndk.z.so)</li></ol></pre></div></div></li>      <li>       <p>编辑“entry &gt; src &gt; main &gt; cpp &gt; napi_init.cpp”文件，使用HiTraceChain跟踪多线程任务，完整的示例代码如下：</p>       <div _ngcontent-ldh-c106="" class="highlight-div"><div _ngcontent-ldh-c106="" class="highlight-div-header"><div _ngcontent-ldh-c106="" class="highlight-div-header-left"><div _ngcontent-ldh-c106="" class="handle-button expand-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldh-c106="" class="highlight-div-header-right"><div _ngcontent-ldh-c106="" class="handle-button ai-button"></div><div _ngcontent-ldh-c106="" class="handle-button line-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldh-c106="" class="handle-button theme-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldh-c106="" class="handle-button copy-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hitrace/trace.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"testTag"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Print2</span><span class="hljs-params">(HiTraceId id)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 为当前线程设置HiTraceId</span></li><li>    <span class="hljs-built_in">OH_HiTrace_SetId</span>(&amp;id);</li><li>    <span class="hljs-comment">// 生成分支标识spanId</span></li><li>    id = <span class="hljs-built_in">OH_HiTrace_CreateSpan</span>();</li><li>    <span class="hljs-comment">// 为当前线程设置带spanId的HiTraceId</span></li><li>    <span class="hljs-built_in">OH_HiTrace_SetId</span>(&amp;id);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"Print2"</span>);</li><li>    <span class="hljs-comment">// 结束当前线程分布式跟踪，功能同OH_HiTrace_EndChain()</span></li><li>    <span class="hljs-built_in">OH_HiTrace_ClearId</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"Print2, HiTraceChain end"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Print1</span><span class="hljs-params">(HiTraceId id)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 为当前线程设置HiTraceId</span></li><li>    <span class="hljs-built_in">OH_HiTrace_SetId</span>(&amp;id);</li><li>    <span class="hljs-comment">// 生成分支标识spanId</span></li><li>    id = <span class="hljs-built_in">OH_HiTrace_CreateSpan</span>();</li><li>    <span class="hljs-comment">// 为当前线程设置带spanId的HiTraceId</span></li><li>    <span class="hljs-built_in">OH_HiTrace_SetId</span>(&amp;id);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"Print1"</span>);</li><li>    std::<span class="hljs-built_in">thread</span>(Print2, <span class="hljs-built_in">OH_HiTrace_GetId</span>()).<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-comment">// 结束当前线程分布式跟踪</span></li><li>    <span class="hljs-built_in">OH_HiTrace_EndChain</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"Print1, HiTraceChain end"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 任务开始，开启分布式跟踪</span></li><li>    HiTraceId hiTraceId = <span class="hljs-built_in">OH_HiTrace_BeginChain</span>(<span class="hljs-string">"testTag: hiTraceChain begin"</span>, HiTrace_Flag::HITRACE_FLAG_DEFAULT);</li><li>    <span class="hljs-comment">// 判断生成的hiTraceId是否有效，有效则输出一行hilog日志</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_HiTrace_IsIdValid</span>(&amp;hiTraceId)) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HiTraceId is valid"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 使能HITRACE_FLAG_INCLUDE_ASYNC标志位，表示会在系统支持的异步机制里自动传递HiTraceId</span></li><li>    <span class="hljs-built_in">OH_HiTrace_EnableFlag</span>(&amp;hiTraceId, HiTrace_Flag::HITRACE_FLAG_INCLUDE_ASYNC);</li><li>    <span class="hljs-comment">// 判断hitraceId的HITRACE_FLAG_INCLUDE_ASYNC标志位是否已经使能，使能则把hiTraceId设置到当前线程TLS中</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_HiTrace_IsFlagEnabled</span>(&amp;hiTraceId, HiTrace_Flag::HITRACE_FLAG_INCLUDE_ASYNC)) {</li><li>        <span class="hljs-built_in">OH_HiTrace_SetId</span>(&amp;hiTraceId);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"HITRACE_FLAG_INCLUDE_ASYNC is enabled"</span>);</li><li>    }</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">1</span>], &amp;valuetype1);</li><li>
</li><li>    <span class="hljs-type">double</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>
</li><li>    <span class="hljs-type">double</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>
</li><li>    napi_value sum;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, value0 + value1, &amp;sum);</li><li>
</li><li>    <span class="hljs-comment">// 创建线程执行打印任务，传递当前线程的HiTraceId</span></li><li>    std::<span class="hljs-built_in">thread</span>(Print1, <span class="hljs-built_in">OH_HiTrace_GetId</span>()).<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-comment">// 任务结束，结束分布式跟踪</span></li><li>    <span class="hljs-built_in">OH_HiTrace_EndChain</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"Add, HiTraceChain end"</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>       <p>编辑“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，在按钮点击事件里调用Add方法，完整的示例代码如下：</p>       <div _ngcontent-ldh-c106="" class="highlight-div"><div _ngcontent-ldh-c106="" class="highlight-div-header"><div _ngcontent-ldh-c106="" class="highlight-div-header-left"><div _ngcontent-ldh-c106="" class="handle-button expand-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldh-c106="" class="highlight-div-header-right"><div _ngcontent-ldh-c106="" class="handle-button ai-button"></div><div _ngcontent-ldh-c106="" class="handle-button line-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldh-c106="" class="handle-button theme-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldh-c106="" class="handle-button copy-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"clickTime=0"</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">clickTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">350</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>++;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">"clickTime="</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickTime</span>;</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。然后点击设备上“clickTime=0”按钮，触发业务逻辑。</p></li>      <li>       <p>在DevEco Studio Log窗口查看分布式跟踪的相关信息。</p>       <ul>        <li>         <p>设备屏幕上按钮显示“clickTime=1”，表示已点击了按钮一次并触发业务逻辑。</p></li>        <li>         <p>示例所有hilog打印均使用了“testTag”，因此可以使用“testTag”关键字过滤日志，查看该业务代码打印的hilog信息。</p>         <div _ngcontent-ldh-c106="" class="highlight-div"><div _ngcontent-ldh-c106="" class="highlight-div-header"><div _ngcontent-ldh-c106="" class="highlight-div-header-left"><div _ngcontent-ldh-c106="" class="handle-button expand-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldh-c106="" class="highlight-div-header-right"><div _ngcontent-ldh-c106="" class="handle-button ai-button"></div><div _ngcontent-ldh-c106="" class="handle-button line-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldh-c106="" class="handle-button theme-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldh-c106="" class="handle-button copy-button"><div _ngcontent-ldh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldh-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>06-05 21:26:01.006   9944-9944     C02D33/com.exa...tion/HiTraceC  com.examp...lication  I     [a92ab19ae90197d 0 0]HiTraceBegin name:testTag: hiTraceChain begin flags:0x00.</li><li>06-05 21:26:01.006   9944-9944     A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab19ae90197d 0 0]HiTraceId is valid</li><li>06-05 21:26:01.006   9944-9944     A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab19ae90197d 0 0]HITRACE_FLAG_INCLUDE_ASYNC is enabled</li><li>06-05 21:26:01.007   9944-9944     A00000/com.exa...ation/testTag  com.examp...lication  I     Add, HiTraceChain end</li><li>06-05 21:26:01.007   9944-9944     A00000/com.exa...ation/testTag  com.examp...lication  I     Test NAPI 2 + 3 = 5</li><li>06-05 21:26:01.007   9944-13961    A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab19ae90197d 2544fdb 0]Print1</li><li>06-05 21:26:01.007   9944-13961    A00000/com.exa...ation/testTag  com.examp...lication  I     Print1, HiTraceChain end</li><li>06-05 21:26:01.008   9944-13962    A00000/com.exa...ation/testTag  com.examp...lication  I     [a92ab19ae90197d 236699a 2544fdb]Print2</li><li>06-05 21:26:01.008   9944-13962    A00000/com.exa...ation/testTag  com.examp...lication  I     Print2, HiTraceChain end</li></ol></pre></div></div></li>        <li>         <p>hilog日志前附加的[chainId spanId parentSpanId]格式的信息即为HiTraceId信息，例如[a92ab19ae90197d 236699a 2544fdb]表示跟踪链标识chainId值为a92ab19ae90197d，分支标识spanId值为236699a，父分支标识parentSpanId值为2544fdb。</p></li>        <li>         <p>通过手动传递HiTraceId，创建spanId，并将其设置到std::thread创建的子线程中，子线程中运行的Print1和Print2业务的hilog日志也携带上同主线程一致的跟踪标识“a92ab19ae90197d”。</p></li>        <li>         <p>使用OH_HiTrace_EndChain()或OH_HiTrace_ClearId()结束分布式跟踪后，hilog打印信息不再携带HiTraceId信息。</p></li>       </ul></li>     </ol>    </div>   </div>   <div></div></div>