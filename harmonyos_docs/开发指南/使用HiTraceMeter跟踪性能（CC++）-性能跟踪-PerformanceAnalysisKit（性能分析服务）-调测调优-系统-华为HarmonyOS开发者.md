<h1 _ngcontent-lnj-c119="" class="doc-title ng-star-inserted" title="使用HiTraceMeter跟踪性能（C/C++）"> 使用HiTraceMeter跟踪性能（C/C++） </h1>

<div _ngcontent-lnj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>HiTraceMeter提供系统性能打点接口。开发者在关键代码位置调用这些API，能够有效跟踪进程轨迹，查看系统和应用性能。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>性能打点跟踪接口由HiTraceMeter模块提供，详细API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-trace-h" target="_blank">Hitrace C API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">方法</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">接口描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_StartTraceEx(HiTrace_Output_Level level, const char* name, const char* customArgs)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>开启一个同步时间片跟踪事件，分级控制跟踪输出。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_FinishTraceEx(HiTrace_Output_Level level)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>结束一个同步时间片跟踪事件，分级控制跟踪输出。</p>          <p>level必须与流程开始的OH_HiTrace_StartTraceEx()对应参数值保持一致。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_StartAsyncTraceEx(HiTrace_Output_Level level, const char* name, int32_t taskId, const char* customCategory, const char* customArgs)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>开启一个异步时间片跟踪事件，分级控制跟踪输出。</p>          <p>taskId是trace中用来表示关联的ID，如果有多个name相同的任务并行执行，则开发者每次调用OH_HiTrace_StartAsyncTraceEx()时，传入的taskId需不同；如果具有相同name的任务是串行执行的，则taskId可以相同。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_FinishAsyncTraceEx(HiTrace_Output_Level level, const char* name, int32_t taskId)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>结束一个异步时间片跟踪事件，分级控制跟踪输出。</p>          <p>level、name和taskId必须与流程开始的OH_HiTrace_StartAsyncTraceEx()对应参数值保持一致。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_HiTrace_CountTraceEx(HiTrace_Output_Level level, const char* name, int64_t count)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>整数跟踪事件，分级控制跟踪输出。</p>          <p>name、count两个参数分别用来标记一个跟踪的整数变量名及整数值。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">bool OH_HiTrace_IsTraceEnabled(void)</td>         <td class="cellrowborder" valign="top" width="50%">          <p>判断当前是否开启应用trace捕获。</p>          <p>使用hitrace命令行工具等方式开启采集时返回true，未开启采集或停止采集后返回false，此时调用HiTraceMeter性能跟踪打点接口无效。</p>          <p><strong>说明</strong>：从API version 19开始，支持该接口。</p></td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracemeter-view#用户态trace格式说明">用户态trace格式</a>使用竖线 | 作为分隔符，所以通过HiTraceMeter接口传递的字符串类型参数应避免包含该字符，以防止trace解析异常。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="接口分类" class="firsth2">接口分类<i class="anchor-icon anchor-icon-link" anchorid="接口分类" tips="复制节点链接"></i></h3>          <p>HiTraceMeter打点接口主要分为三类：同步时间片跟踪接口、异步时间片跟踪接口和整数跟踪接口。HiTraceMeter接口实现均为同步，同步和异步针对的是被跟踪的业务。同步业务使用同步时间片跟踪接口，异步业务使用异步时间片跟踪接口。HiTraceMeter打点接口可与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracechain-guidelines-ndk">HiTraceChain</a>一起使用，进行跨设备、跨进程或跨线程的打点关联与分析。</p>    </div>    <div class="tiledSection">     <h3 id="接口使用场景">接口使用场景<i class="anchor-icon anchor-icon-link" anchorid="接口使用场景" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>同步时间片跟踪接口</p>       <p>用于顺序执行的打点场景，需按序成对使用OH_HiTrace_StartTraceEx()接口和OH_HiTrace_FinishTraceEx()接口，否则会导致trace文件在smartperf等可视化工具上显示异常。</p></li>      <li>       <p>异步时间片跟踪接口</p>       <p>在异步操作执行前调用OH_HiTrace_StartAsyncTraceEx()接口进行开始打点，在异步操作完成后调用OH_HiTrace_FinishAsyncTraceEx()接口进行结束打点。</p>       <p>解析trace时，通过name和taskId参数识别不同的异步跟踪。所以这两个接口必须按序成对使用，并传入相同的name和taskId。</p>       <p>不同的异步流程中应使用不同的name和taskId，但在异步跟踪流程不会同时发生的情况下，可以使用相同的name和taskId。</p>       <p>调用错误会导致trace文件在smartperf等可视化工具上显示异常。</p></li>      <li>       <p>整数跟踪接口</p>       <p>用于跟踪整数变量。整数值变动时调用OH_HiTrace_CountTraceEx()接口，可在smartperf的泳道图中观察变动情况。由于从开始采集到首次打点存在时间差，这段时间的数值无法查看。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="参数解析">参数解析<i class="anchor-icon anchor-icon-link" anchorid="参数解析" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.1" valign="top" width="33.33333333333333%">参数名</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.2" valign="top" width="33.33333333333333%">类型</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">level</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">enum</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>跟踪输出级别，低于系统阈值的跟踪将不会被输出。</p>          <p>log版本阈值为HITRACE_LEVEL_INFO，nolog版本阈值为HITRACE_LEVEL_COMMERCIAL。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">name</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">const char*</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">要跟踪的任务名称或整数变量名称。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">taskId</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">int32_t</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">用来表示关联的ID，如果有多个name相同的任务并行执行，则开发者每次调用OH_HiTrace_StartAsyncTraceEx()时，传入的taskId需不同。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">count</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">int64_t</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">整数变量的值。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">customCategory</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">const char*</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>自定义聚类名称，用于聚合同一类异步跟踪打点。</p>          <p>若不需要聚类，可传入一个空字符串。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">customArgs</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">const char*</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>自定义键值对，若有多组键值对，使用逗号进行分隔，例"key1=value1,key2=value2"。</p>          <p>若不需要该参数，可传入一个空字符串。</p></td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hitracemeter-view#用户态trace格式说明">用户态trace</a>总长度限制为512字符，超过部分将会被截断。建议name、customCategory和customArgs三个字段的总长度不超过420字符，以避免trace被截断。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下为一个使用HiTraceMeter打点接口的Native C++应用示例。</p>    </div>    <div class="tiledSection">     <h3 id="步骤一创建项目" class="firsth2">步骤一：创建项目<i class="anchor-icon anchor-icon-link" anchorid="步骤一创建项目" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在DevEco Studio中新建工程，选择“Native C++”，工程的目录结构如下。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>├── entry</li><li>│   ├── src</li><li>│       ├── main</li><li>│       │   ├── cpp</li><li>│       │   │   ├── CMakeLists.txt</li><li>│       │   │   ├── napi_init.cpp</li><li>│       │   │   └── types</li><li>│       │   │       └── libentry</li><li>│       │   │           ├── Index.d.ts</li><li>│       │   │           └── oh-package.json5</li><li>│       │   ├── ets</li><li>│       │   │   ├── entryability</li><li>│       │   │   │   └── EntryAbility.ets</li><li>│       │   │   ├── entrybackupability</li><li>│       │   │   │   └── EntryBackupAbility.ets</li><li>│       │   │   └── pages</li><li>│       │   │       └── Index.ets</li></ol></pre></div></div></li>      <li>       <p>在“entry &gt; src &gt; main &gt; cpp &gt; CMakeLists.txt”文件中新增libhitrace_ndk.z.so和libhilog_ndk.z.so动态链接库，完整的文件内容如下。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)</li><li><span class="hljs-built_in">project</span>(HiTraceChainTest03)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhitrace_ndk.z.so libhilog_ndk.z.so)</li></ol></pre></div></div></li>      <li>       <p>编辑“entry &gt; src &gt; main &gt; cpp &gt; napi_init.cpp”文件，在Add函数中调用HiTraceMeter NDK_C接口进行性能打点跟踪，完整的示例代码如下。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hitrace/trace.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"traceTest"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 第一个异步跟踪任务开始</span></li><li>    <span class="hljs-built_in">OH_HiTrace_StartAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1001</span>, <span class="hljs-string">"categoryTest"</span>, <span class="hljs-string">"key=value"</span>);</li><li>    <span class="hljs-comment">// 开始计数任务</span></li><li>    <span class="hljs-type">int64_t</span> traceCount = <span class="hljs-number">0</span>;</li><li>    traceCount++;</li><li>    <span class="hljs-built_in">OH_HiTrace_CountTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestCountTrace"</span>, traceCount);</li><li>    <span class="hljs-comment">// 业务流程</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"myTraceTest running, taskId: 1001"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 第二个异步跟踪任务开始，同时第一个跟踪的同名任务还没结束，出现了并行执行，对应接口的taskId需要不同</span></li><li>    <span class="hljs-built_in">OH_HiTrace_StartAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1002</span>, <span class="hljs-string">"categoryTest"</span>, <span class="hljs-string">"key=value"</span>);</li><li>    <span class="hljs-comment">// 开始计数任务</span></li><li>    traceCount++;</li><li>    <span class="hljs-built_in">OH_HiTrace_CountTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestCountTrace"</span>, traceCount);</li><li>    <span class="hljs-comment">// 业务流程</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"myTraceTest running, taskId: 1002"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 结束taskId为1001的异步跟踪任务</span></li><li>    <span class="hljs-built_in">OH_HiTrace_FinishAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1001</span>);</li><li>    <span class="hljs-comment">// 结束taskId为1002的异步跟踪任务</span></li><li>    <span class="hljs-built_in">OH_HiTrace_FinishAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1002</span>);</li><li>
</li><li>    <span class="hljs-comment">// 开始同步跟踪任务</span></li><li>    <span class="hljs-built_in">OH_HiTrace_StartTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestSyncTrace"</span>, <span class="hljs-string">"key=value"</span>);</li><li>    <span class="hljs-comment">// 业务流程</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"myTraceTest running, synchronizing trace"</span>);</li><li>    <span class="hljs-comment">// 结束同步跟踪任务</span></li><li>    <span class="hljs-built_in">OH_HiTrace_FinishTraceEx</span>(HITRACE_LEVEL_COMMERCIAL);</li><li>
</li><li>    <span class="hljs-comment">// 若通过HiTraceMeter性能打点接口传递的参数的生成过程比较复杂，此时可以通过isTraceEnabled判断当前是否开启应用trace捕获，</span></li><li>    <span class="hljs-comment">// 在未开启应用trace捕获时，避免该部分性能损耗</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_HiTrace_IsTraceEnabled</span>()) {</li><li>        <span class="hljs-type">char</span> customArgs[<span class="hljs-number">128</span>] = <span class="hljs-string">"key0=value0"</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> index = <span class="hljs-number">1</span>; index &lt; <span class="hljs-number">10</span>; index++) {</li><li>            <span class="hljs-type">char</span> buffer[<span class="hljs-number">16</span>];</li><li>            <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-string">",key%d=value%d"</span>, index, index);</li><li>            <span class="hljs-built_in">strncat</span>(customArgs, buffer, <span class="hljs-built_in">sizeof</span>(customArgs) - <span class="hljs-built_in">strlen</span>(customArgs) - <span class="hljs-number">1</span>);</li><li>        }</li><li>        <span class="hljs-built_in">OH_HiTrace_StartAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1003</span>, <span class="hljs-string">"categoryTest"</span>, customArgs);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"myTraceTest running, taskId: 1003"</span>);</li><li>        <span class="hljs-built_in">OH_HiTrace_FinishAsyncTraceEx</span>(HITRACE_LEVEL_COMMERCIAL, <span class="hljs-string">"myTestAsyncTrace"</span>, <span class="hljs-number">1003</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LogType::LOG_APP, <span class="hljs-string">"myTraceTest running, trace is not enabled"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">size_t</span> requireArgc = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">1</span>], &amp;valuetype1);</li><li>
</li><li>    <span class="hljs-type">double</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>
</li><li>    <span class="hljs-type">double</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>
</li><li>    napi_value sum;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, value0 + value1, &amp;sum);</li><li>
</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="步骤二采集trace信息并查看">步骤二：采集trace信息并查看<i class="anchor-icon anchor-icon-link" anchorid="步骤二采集trace信息并查看" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在DevEco Studio Terminal窗口中执行如下命令，开启应用trace捕获。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>PS D:\xxx\xxx&gt; hdc shell</li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hitrace --trace_begin app</span></li></ol></pre></div></div></li>      <li>       <p>单击DevEco Studio界面上的运行按钮，启动应用。点击应用界面的“Hello World”文本，执行包含HiTraceMeter打点的业务逻辑。然后执行如下命令抓取trace数据，并使用“myTest”关键字过滤trace数据（示例打点接口传递的name字段前缀均为“myTest”）。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hitrace --trace_dump | grep myTest</span></li></ol></pre></div></div>       <p>成功抓取的trace数据如下所示。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708093: tracing_mark_write: S|49837|H:myTestAsyncTrace|1001|M62|categoryTest|key=value</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708103: tracing_mark_write: C|49837|H:myTestCountTrace|1|M62</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708201: tracing_mark_write: S|49837|H:myTestAsyncTrace|1002|M62|categoryTest|key=value</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708209: tracing_mark_write: C|49837|H:myTestCountTrace|2|M62</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708239: tracing_mark_write: F|49837|H:myTestAsyncTrace|1001|M62</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708246: tracing_mark_write: F|49837|H:myTestAsyncTrace|1002|M62</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708252: tracing_mark_write: B|49837|H:myTestSyncTrace|M62|key=value</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708301: tracing_mark_write: S|49837|H:myTestAsyncTrace|1003|M62|categoryTest|key0=value0,key1=value1,key2=value2,key3=value3,key4=value4,key5=value5,key6=value6,key7=value7,key8=value8,key9=value9</li><li>&lt;...&gt;-49837   (-------) [002] .... 349137.708323: tracing_mark_write: F|49837|H:myTestAsyncTrace|1003|M62</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="步骤三停止采集trace">步骤三：停止采集trace<i class="anchor-icon anchor-icon-link" anchorid="步骤三停止采集trace" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>执行以下命令，结束应用trace捕获。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hitrace --trace_finish</span></li></ol></pre></div></div></li>      <li>       <p>再次点击应用界面的“Hello World”文本，此时应用trace捕获已关闭，OH_HiTrace_IsTraceEnabled()接口返回false。在DevEco Studio Log窗口使用关键字“not enabled”进行过滤，会打印如下日志。</p>       <div _ngcontent-lnj-c106="" class="highlight-div"><div _ngcontent-lnj-c106="" class="highlight-div-header"><div _ngcontent-lnj-c106="" class="highlight-div-header-left"><div _ngcontent-lnj-c106="" class="handle-button expand-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lnj-c106="" class="highlight-div-header-right"><div _ngcontent-lnj-c106="" class="handle-button ai-button"></div><div _ngcontent-lnj-c106="" class="handle-button line-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lnj-c106="" class="handle-button theme-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lnj-c106="" class="handle-button copy-button"><div _ngcontent-lnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lnj-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>myTraceTest running, trace is not enabled</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>log版本在使用hitrace --trace_finish命令停止采集后会自动拉起快照模式，打开应用trace捕获，此时OH_HiTrace_IsTraceEnabled()接口返回true，不会打印上述日志。</p>        </div></div></div></li>     </ol>    </div>   </div>   <div></div></div>