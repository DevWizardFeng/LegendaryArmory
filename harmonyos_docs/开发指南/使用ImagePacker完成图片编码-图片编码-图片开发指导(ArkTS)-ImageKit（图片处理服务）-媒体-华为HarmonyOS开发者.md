<h1 _ngcontent-mxt-c119="" class="doc-title ng-star-inserted" title="使用ImagePacker完成图片编码"> 使用ImagePacker完成图片编码 </h1>

<div _ngcontent-mxt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>图片编码指将PixelMap压缩成不同格式的图片文件，用于保存和传输。</p>    <p>支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagepacker#packtodata13-1" target="_blank">PackToData</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagepacker#packtofile11-2" target="_blank">PackToFile</a>将PixelMap编码为JPEG、WebP、PNG和HEIC格式。</p>    <p>从API version 18开始，支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagepacker#packtodatafrompixelmapsequence18" target="_blank">PackToDataFromPixelmapSequence</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagepacker#packtofilefrompixelmapsequence18" target="_blank">PackToFileFromPixelmapSequence</a>将多个PixelMap编码为GIF格式。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>图片编码相关API的详细介绍请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagepacker" target="_blank">图片编码接口说明</a>。</p>    </div>    <div class="tiledSection">     <h3 id="图片编码进文件流" class="firsth2">图片编码进文件流<i class="anchor-icon anchor-icon-link" anchorid="图片编码进文件流" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>创建图像编码ImagePacker对象。</p>       <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入相关模块包。</span></li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> imagePackerApi = image.<span class="hljs-title function_">createImagePacker</span>();</li></ol></pre></div></div></li>      <li>       <p>设置编码输出流和编码参数。</p>       <ul>        <li>         <p>format为图像的编码格式；quality为图像质量，范围从0-100，100为最佳质量。</p>         <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">           <p>根据MIME标准，标准编码格式为image/jpeg。当使用image编码时，PackingOption.format设置为image/jpeg，image编码后的文件扩展名可设为.jpg或.jpeg，可在支持image/jpeg解码的平台上使用。</p>          </div></div></div>         <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> packOpts : image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>:<span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>:<span class="hljs-number">98</span> };</li></ol></pre></div></div></li>        <li>         <p>编码为hdr内容(需要资源本身为hdr，支持jpeg格式)。</p>         <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>packOpts.<span class="hljs-property">desiredDynamicRange</span> = image.<span class="hljs-property">PackingDynamicRange</span>.<span class="hljs-property">AUTO</span>;</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>进行图片编码，并保存编码后的图片。</p>       <p>方法一：通过PixelMap进行编码。</p>       <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">packToDataFromPixelMap</span>(<span class="hljs-params">context : Context, pixelMap : image.PixelMap</span>) {</li><li>  <span class="hljs-keyword">const</span> imagePackerApi = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>  <span class="hljs-keyword">let</span> packOpts : image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>:<span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>:<span class="hljs-number">98</span> };</li><li>  imagePackerApi.<span class="hljs-title function_">packToData</span>(pixelMap, packOpts).<span class="hljs-title function_">then</span>( <span class="hljs-function">(<span class="hljs-params">data : <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// data 为编码获取到的文件流，写入文件保存即可得到一张图片。</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to pack the image. And the error is: '</span> + error);</li><li>  })</li><li>}</li></ol></pre></div></div>       <p>方法二：通过imageSource进行编码。</p>       <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">packToDataFromImageSource</span>(<span class="hljs-params">context : Context, imageSource : image.ImageSource</span>) {</li><li>  <span class="hljs-keyword">const</span> imagePackerApi = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>  <span class="hljs-keyword">let</span> packOpts : image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>:<span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>:<span class="hljs-number">98</span> };</li><li>  imagePackerApi.<span class="hljs-title function_">packToData</span>(imageSource, packOpts).<span class="hljs-title function_">then</span>( <span class="hljs-function">(<span class="hljs-params">data : <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// data 为编码获取到的文件流，写入文件保存即可得到一张图片。</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to pack the image. And the error is: '</span> + error);</li><li>  })</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="图片编码进文件">图片编码进文件<i class="anchor-icon anchor-icon-link" anchorid="图片编码进文件" tips="复制节点链接"></i></h3>          <p>在编码时，开发者可以传入对应的文件路径，编码后的内存数据将直接写入文件。</p>     <p>方法一：通过PixelMap编码进文件。</p>     <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">packToFile</span>(<span class="hljs-params">context : Context, pixelMap : image.PixelMap</span>) {</li><li>  <span class="hljs-keyword">const</span> imagePackerApi = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>  <span class="hljs-keyword">let</span> packOpts : image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>:<span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>:<span class="hljs-number">98</span> };</li><li>  <span class="hljs-keyword">const</span> path : <span class="hljs-built_in">string</span> = context.<span class="hljs-property">cacheDir</span> + <span class="hljs-string">"/pixel_map.jpg"</span>;</li><li>  <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(path, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>  imagePackerApi.<span class="hljs-title function_">packToFile</span>(pixelMap, file.<span class="hljs-property">fd</span>, packOpts).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 直接编码进文件。</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to pack the image. And the error is: '</span> + error);</li><li>  }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>  })</li><li>}</li></ol></pre></div></div>     <p>方法二：通过imageSource编码进文件。</p>     <div _ngcontent-mxt-c106="" class="highlight-div"><div _ngcontent-mxt-c106="" class="highlight-div-header"><div _ngcontent-mxt-c106="" class="highlight-div-header-left"><div _ngcontent-mxt-c106="" class="handle-button expand-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mxt-c106="" class="highlight-div-header-right"><div _ngcontent-mxt-c106="" class="handle-button ai-button"></div><div _ngcontent-mxt-c106="" class="handle-button line-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mxt-c106="" class="handle-button theme-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mxt-c106="" class="handle-button copy-button"><div _ngcontent-mxt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mxt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">packToFile</span>(<span class="hljs-params">context : Context, imageSource : image.ImageSource</span>) {</li><li>  <span class="hljs-keyword">const</span> imagePackerApi = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>  <span class="hljs-keyword">let</span> packOpts : image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>:<span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>:<span class="hljs-number">98</span> };</li><li>  <span class="hljs-keyword">const</span> filePath : <span class="hljs-built_in">string</span> = context.<span class="hljs-property">cacheDir</span> + <span class="hljs-string">"/image_source.jpg"</span>;</li><li>  <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>  imagePackerApi.<span class="hljs-title function_">packToFile</span>(imageSource, file.<span class="hljs-property">fd</span>, packOpts).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 直接编码进文件。</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to pack the image. And the error is: '</span> + error);</li><li>  }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>  })</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="图片编码保存进图库">图片编码保存进图库<i class="anchor-icon anchor-icon-link" anchorid="图片编码保存进图库" tips="复制节点链接"></i></h3>          <p>可以将图片编码保存到应用沙箱，然后使用媒体文件管理相关接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">保存媒体库资源</a>。</p>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/image-compression" target="_blank">图片压缩</a></li>     </ul>    </div>   </div>   <div></div></div>