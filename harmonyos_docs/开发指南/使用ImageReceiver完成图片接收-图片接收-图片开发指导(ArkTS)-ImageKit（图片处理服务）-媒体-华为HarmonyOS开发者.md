<h1 _ngcontent-kyi-c119="" class="doc-title ng-star-inserted" title="使用ImageReceiver完成图片接收"> 使用ImageReceiver完成图片接收 </h1>

<div _ngcontent-kyi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>图片接收类ImageReceiver用于获取组件surface id，接收最新的图片和读取下一张图片，以及释放ImageReceiver实例。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>Receiver作为消费者，需要有对应的生产者提供数据才能实现完整功能。常见的生产者是相机的拍照流或预览流。ImageReceiver只作为图片的接收方、消费者，在ImageReceiver设置的size、format等属性实际上并不会生效，图片createImageReceiver时传入的参数不产生实际影响。图片属性需要在发送方、生产者进行设置，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">相机创建预览流</a>时配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#profile" target="_blank">profile</a>。</p>     </div></div></div>    <p>ImageReceiver可以接收相机预览流中的图片，实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-dual-channel-preview">双路预览</a>。</p>    <p>ImageReceiver信息相关API的详细介绍请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">API参考</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>创建ImageReceiver对象，获取SurfaceId创建预览流，注册图像监听，按需处理预览流每帧图像。</p>     <ol>      <li>       <p>创建ImageReceiver对象，通过ImageReceiver对象可获取预览流SurfaceId。</p>       <div _ngcontent-kyi-c106="" class="highlight-div"><div _ngcontent-kyi-c106="" class="highlight-div-header"><div _ngcontent-kyi-c106="" class="highlight-div-header-left"><div _ngcontent-kyi-c106="" class="handle-button expand-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kyi-c106="" class="highlight-div-header-right"><div _ngcontent-kyi-c106="" class="handle-button ai-button"></div><div _ngcontent-kyi-c106="" class="handle-button line-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kyi-c106="" class="handle-button theme-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kyi-c106="" class="handle-button copy-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kyi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>; <span class="hljs-comment">// 请使用设备支持profile的size的宽。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// 请使用设备支持profile的size的高。</span></li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initImageReceiver</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建ImageReceiver对象。createImageReceiver的参数不会对接收到的数据产生实际影响。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>: image.<span class="hljs-property">Size</span> = { <span class="hljs-attr">width</span>: imageWidth, <span class="hljs-attr">height</span>: imageHeight };</li><li>  <span class="hljs-keyword">let</span> imageReceiver = image.<span class="hljs-title function_">createImageReceiver</span>(size, image.<span class="hljs-property">ImageFormat</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-number">8</span>);</li><li>  <span class="hljs-comment">// 获取预览流SurfaceId。</span></li><li>  <span class="hljs-keyword">let</span> imageReceiverSurfaceId = <span class="hljs-keyword">await</span> imageReceiver.<span class="hljs-title function_">getReceivingSurfaceId</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initImageReceiver imageReceiverSurfaceId:<span class="hljs-subst">${imageReceiverSurfaceId}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>注册监听处理预览流每帧图像数据：通过ImageReceiver组件中imageArrival事件监听获取底层返回的图像数据，详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">Image API参考</a>。</p>       <div _ngcontent-kyi-c106="" class="highlight-div"><div _ngcontent-kyi-c106="" class="highlight-div-header"><div _ngcontent-kyi-c106="" class="highlight-div-header-left"><div _ngcontent-kyi-c106="" class="handle-button expand-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kyi-c106="" class="highlight-div-header-right"><div _ngcontent-kyi-c106="" class="handle-button ai-button"></div><div _ngcontent-kyi-c106="" class="handle-button line-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kyi-c106="" class="handle-button theme-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kyi-c106="" class="handle-button copy-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kyi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onImageArrival</span>(<span class="hljs-params">receiver: image.ImageReceiver</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// 注册imageArrival监听。</span></li><li>  receiver.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 获取图像。</span></li><li>    receiver.<span class="hljs-title function_">readNextImage</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError, nextImage: image.Image</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err || nextImage === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readNextImage failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 解析图像内容。</span></li><li>      nextImage.<span class="hljs-title function_">getComponent</span>(image.<span class="hljs-property">ComponentType</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">imgComponent</span>: image.<span class="hljs-property">Component</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (err || imgComponent === <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getComponent failed'</span>);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (imgComponent.<span class="hljs-property">byteBuffer</span>) {</li><li>          <span class="hljs-comment">// 详情见下方解析图片buffer数据参考，本示例以方式一为例。</span></li><li>          <span class="hljs-keyword">let</span> width = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>; <span class="hljs-comment">// 获取图片的宽。</span></li><li>          <span class="hljs-keyword">let</span> height = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>; <span class="hljs-comment">// 获取图片的高。</span></li><li>          <span class="hljs-keyword">let</span> stride = imgComponent.<span class="hljs-property">rowStride</span>; <span class="hljs-comment">// 获取图片的stride。</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">`getComponent with width:<span class="hljs-subst">${width}</span> height:<span class="hljs-subst">${height}</span> stride:<span class="hljs-subst">${stride}</span>`</span>);</li><li>          <span class="hljs-comment">// stride与width一致。</span></li><li>          <span class="hljs-keyword">if</span> (stride == width) {</li><li>            <span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, {</li><li>              <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>              <span class="hljs-attr">srcPixelFormat</span>: <span class="hljs-number">8</span>,</li><li>            })</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// stride与width不一致。</span></li><li>            <span class="hljs-keyword">const</span> dstBufferSize = width * height * <span class="hljs-number">1.5</span></li><li>            <span class="hljs-keyword">const</span> dstArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dstBufferSize)</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height * <span class="hljs-number">1.5</span>; j++) {</li><li>              <span class="hljs-keyword">const</span> srcBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, j * stride, width)</li><li>              dstArr.<span class="hljs-title function_">set</span>(srcBuf, j * width)</li><li>            }</li><li>            <span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(dstArr.<span class="hljs-property">buffer</span>, {</li><li>              <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>              <span class="hljs-attr">srcPixelFormat</span>: <span class="hljs-number">8</span>,</li><li>            })</li><li>          }</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'byteBuffer is null'</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 确保当前buffer没有在使用的情况下，可进行资源释放。</span></li><li>        <span class="hljs-comment">// 如果对buffer进行异步操作，需要在异步操作结束后再释放该资源（nextImage.release()）。</span></li><li>        nextImage.<span class="hljs-title function_">release</span>();</li><li>      })</li><li>    })</li><li>  })</li><li>}</li></ol></pre></div></div>       <p>通过 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#component9" target="_blank">image.Component</a> 解析图片buffer数据参考：</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>需要确认图像的宽width是否与行距rowStride一致，如果不一致可参考以下方式处理：</p>        </div></div></div>       <p>方式一：去除imgComponent.byteBuffer中stride数据，拷贝得到新的buffer，调用不支持stride的接口处理buffer。</p>       <div _ngcontent-kyi-c106="" class="highlight-div"><div _ngcontent-kyi-c106="" class="highlight-div-header"><div _ngcontent-kyi-c106="" class="highlight-div-header-left"><div _ngcontent-kyi-c106="" class="handle-button expand-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kyi-c106="" class="highlight-div-header-right"><div _ngcontent-kyi-c106="" class="handle-button ai-button"></div><div _ngcontent-kyi-c106="" class="handle-button line-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kyi-c106="" class="handle-button theme-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kyi-c106="" class="handle-button copy-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kyi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 以NV21为例（YUV_420_SP格式的图片）YUV_420_SP内存计算公式：长x宽+(长x宽)/2。</span></li><li><span class="hljs-keyword">const</span> dstBufferSize = width * height * <span class="hljs-number">1.5</span>;</li><li><span class="hljs-keyword">const</span> dstArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dstBufferSize);</li><li><span class="hljs-comment">// 逐行读取buffer数据。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height * <span class="hljs-number">1.5</span>; j++) {</li><li>  <span class="hljs-comment">// imgComponent.byteBuffer的每行数据拷贝前width个字节到dstArr中。</span></li><li>  <span class="hljs-keyword">const</span> srcBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, j * stride, width);</li><li>  dstArr.<span class="hljs-title function_">set</span>(srcBuf, j * width);</li><li>}</li><li><span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(dstArr.<span class="hljs-property">buffer</span>, {</li><li>  <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width }, <span class="hljs-attr">srcPixelFormat</span>: <span class="hljs-number">8</span></li><li>});</li></ol></pre></div></div>       <p>方式二：根据stride*height创建pixelMap，然后调用pixelMap的cropSync方法裁剪掉多余的像素。</p>       <div _ngcontent-kyi-c106="" class="highlight-div"><div _ngcontent-kyi-c106="" class="highlight-div-header"><div _ngcontent-kyi-c106="" class="highlight-div-header-left"><div _ngcontent-kyi-c106="" class="handle-button expand-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kyi-c106="" class="highlight-div-header-right"><div _ngcontent-kyi-c106="" class="handle-button ai-button"></div><div _ngcontent-kyi-c106="" class="handle-button line-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kyi-c106="" class="handle-button theme-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kyi-c106="" class="handle-button copy-button"><div _ngcontent-kyi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kyi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建pixelMap，width宽传行距stride的值。</span></li><li><span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, {</li><li>  <span class="hljs-attr">size</span>:{<span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: stride}, <span class="hljs-attr">srcPixelFormat</span>: <span class="hljs-number">8</span>});</li><li><span class="hljs-comment">// 裁剪多余的像素。</span></li><li>pixelMap.<span class="hljs-title function_">cropSync</span>({<span class="hljs-attr">size</span>:{<span class="hljs-attr">width</span>:width, <span class="hljs-attr">height</span>:height}, <span class="hljs-attr">x</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">0</span>});</li></ol></pre></div></div>       <p>方式三：将原始imgComponent.byteBuffer和stride信息一起传给支持stride的接口处理。</p></li>     </ol>    </div>   </div>   <div></div></div>