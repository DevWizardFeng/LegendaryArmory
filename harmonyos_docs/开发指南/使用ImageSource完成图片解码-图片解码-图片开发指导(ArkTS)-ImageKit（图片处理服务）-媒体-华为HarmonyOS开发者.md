<h1 _ngcontent-pug-c119="" class="doc-title ng-star-inserted" title="使用ImageSource完成图片解码"> 使用ImageSource完成图片解码 </h1>

<div _ngcontent-pug-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>将所支持格式的图片文件解码成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>，以便在应用或系统中显示或处理图片。当前支持的图片文件格式包括JPEG、PNG、GIF、WebP、BMP、SVG、ICO、DNG、HEIC。不同硬件设备的支持情况可能不同 。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>图片解码相关API的详细介绍请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource" target="_blank">图片解码接口说明</a>。</p>     <ol>      <li>       <p>全局导入Image模块。</p>       <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取图片。</p>       <ul>        <li>         <p>方法一：通过沙箱路径直接获取。该方法仅适用于应用沙箱中的图片。更多细节请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径">获取应用文件路径</a>。应用沙箱的介绍及如何向应用沙箱推送文件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory">文件管理</a>。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getFilePath</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">cacheDir</span> + <span class="hljs-string">'/test.jpg'</span>;</li><li>  <span class="hljs-keyword">return</span> filePath;</li><li>}</li></ol></pre></div></div></li>        <li>         <p>方法二：通过沙箱路径获取图片的文件描述符。具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">file.fs API参考文档</a>。该方法需要导入@kit.CoreFileKit模块。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getFileFd</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">cacheDir</span> + <span class="hljs-string">'/test.jpg'</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(filePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span> = file?.<span class="hljs-property">fd</span>;</li><li>  <span class="hljs-keyword">return</span> fd;</li><li>}</li></ol></pre></div></div></li>        <li>         <p>方法三：通过资源管理器获取资源文件的ArrayBuffer。具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfilecontent9-1" target="_blank">资源管理器API参考文档</a>。该方法需要导入@kit.LocalizationKit模块。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getFileBuffer</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceMgr</span>: resourceManager.<span class="hljs-property">ResourceManager</span> = context.<span class="hljs-property">resourceManager</span>;</li><li>    <span class="hljs-comment">// 获取资源文件内容，返回Uint8Array。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">fileData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">await</span> resourceMgr.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'test.jpg'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Successfully got RawFileContent'</span>);</li><li>    <span class="hljs-comment">// 转为ArrayBuffer并返回。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = fileData.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to get RawFileContent"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre></div></div></li>        <li>         <p>方法四：通过资源管理器获取资源文件的RawFileDescriptor。具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfd9-1" target="_blank">资源管理器API参考文档</a>。该方法需要导入@kit.LocalizationKit模块。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getRawFd</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;resourceManager.<span class="hljs-property">RawFileDescriptor</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceMgr</span>: resourceManager.<span class="hljs-property">ResourceManager</span> = context.<span class="hljs-property">resourceManager</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">rawFileDescriptor</span>: resourceManager.<span class="hljs-property">RawFileDescriptor</span> = <span class="hljs-keyword">await</span> resourceMgr.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'test.jpg'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Successfully got RawFileDescriptor'</span>);</li><li>    <span class="hljs-keyword">return</span> rawFileDescriptor;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to get RawFileDescriptor:'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>创建ImageSource实例。</p>       <ul>        <li>         <p>方法一：通过沙箱路径创建ImageSource。沙箱路径可以通过步骤2的方法一获取。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// path为已获得的沙箱路径。</span></li><li><span class="hljs-keyword">const</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(filePath);</li></ol></pre></div></div></li>        <li>         <p>方法二：通过文件描述符fd创建ImageSource。文件描述符可以通过步骤2的方法二获取。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// fd为已获得的文件描述符。</span></li><li><span class="hljs-keyword">const</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(fd);</li></ol></pre></div></div></li>        <li>         <p>方法三：通过缓冲区数组创建ImageSource。缓冲区数组可以通过步骤2的方法三获取。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(buffer);</li></ol></pre></div></div></li>        <li>         <p>方法四：通过资源文件的RawFileDescriptor创建ImageSource。RawFileDescriptor可以通过步骤2的方法四获取。</p>         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(rawFileDescriptor);</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>设置解码参数DecodingOptions，解码获取pixelMap图片对象。</p>       <ul>        <li>设置期望的format进行解码：         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建ImageSource，请选择3中合适的方法替换。</span></li><li><span class="hljs-keyword">let</span> fd : <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">let</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(fd);</li><li><span class="hljs-comment">// 配置解码选项参数。</span></li><li><span class="hljs-keyword">let</span> decodingOptions : image.<span class="hljs-property">DecodingOptions</span> = {</li><li>   <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>,</li><li>   <span class="hljs-attr">desiredPixelFormat</span>: image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>,</li><li>};</li><li><span class="hljs-comment">// 创建pixelMap。</span></li><li>imageSource.<span class="hljs-title function_">createPixelMap</span>(decodingOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pixelMap : image.PixelMap</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in creating PixelMap"</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err : BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to create PixelMap"</span>);</li><li>});</li></ol></pre></div></div></li>        <li>HDR图片解码         <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建ImageSource，请选择3中合适的方法替换。</span></li><li><span class="hljs-keyword">let</span> fd : <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">let</span> imageSource : image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(fd);</li><li><span class="hljs-comment">// 配置解码选项参数。</span></li><li><span class="hljs-keyword">let</span> decodingOptions : image.<span class="hljs-property">DecodingOptions</span> = {</li><li>   <span class="hljs-comment">//设置为AUTO会根据图片资源格式解码，如果图片资源为HDR资源则会解码为HDR的pixelMap。</span></li><li>   <span class="hljs-attr">desiredDynamicRange</span>: image.<span class="hljs-property">DecodingDynamicRange</span>.<span class="hljs-property">AUTO</span>,</li><li>};</li><li><span class="hljs-comment">// 创建pixelMap。</span></li><li>imageSource.<span class="hljs-title function_">createPixelMap</span>(decodingOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pixelMap : image.PixelMap</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in creating PixelMap"</span>);</li><li>   <span class="hljs-comment">// 判断pixelMap是否为hdr内容。</span></li><li>   <span class="hljs-keyword">let</span> info = pixelMap.<span class="hljs-title function_">getImageInfoSync</span>();</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pixelMap isHdr:"</span> + info.<span class="hljs-property">isHdr</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err : BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to create PixelMap"</span>);</li><li>});</li></ol></pre></div></div></li>       </ul>       <p>解码完成，获取到pixelMap对象后，可以进行后续<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-transformation">图片处理</a>。</p></li>      <li>       <p>释放pixelMap和imageSource。</p>       <p>确认pixelMap和imageSource的异步方法已经执行完成，不再使用该变量后，可按需手动调用下面方法释放。</p>       <div _ngcontent-pug-c106="" class="highlight-div"><div _ngcontent-pug-c106="" class="highlight-div-header"><div _ngcontent-pug-c106="" class="highlight-div-header-left"><div _ngcontent-pug-c106="" class="handle-button expand-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pug-c106="" class="highlight-div-header-right"><div _ngcontent-pug-c106="" class="handle-button ai-button"></div><div _ngcontent-pug-c106="" class="handle-button line-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pug-c106="" class="handle-button theme-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pug-c106="" class="handle-button copy-button"><div _ngcontent-pug-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pug-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 请务必在确认pixelMap不需要再使用时，再进行释放。</span></li><li><span class="hljs-comment">// pixelMap.release();</span></li><li><span class="hljs-comment">// 请务必在确认imageSource不需要再使用时，再进行释放。</span></li><li><span class="hljs-comment">// imageSource.release();</span></li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ol>          <li>释放imageSource的合适时机：createPixelMap执行完成，成功获取pixelMap后，如果确定不再使用imageSource的其他方法，可以手动释放imageSource。由于解码得到的pixelMap是一个独立的实例，imageSource的释放不会导致pixelMap不可用。</li>          <li>释放pixelMap的合适时机：如果使用系统的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-image" target="_blank">Image组件</a>进行图片显示，无需手动释放，Image组件会自动管理传递给它的pixelMap；如果应用自行处理pixelMap，则推荐在页面切换、应用退后台等场景下手动释放老页面pixelMap；在内存资源紧张的场景，推荐释放除当前页面外其他不可见页面的PixelMap。</li>         </ol>        </div></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/ImageGetAndSave" target="_blank">实现图片获取与保存功能</a></li>      <li><a href="https://gitee.com/harmonyos_samples/watermark" target="_blank">水印添加能力</a></li>     </ul>    </div>   </div>   <div></div></div>