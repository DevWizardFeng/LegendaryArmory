<h1 _ngcontent-abi-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule处理图像信息"> 使用Image_NativeModule处理图像信息 </h1>

<div _ngcontent-abi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>图像信息类，用于设置和读取图像的矩形大小、组件信息和像素信息。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加依赖" class="firsth2">添加依赖<i class="anchor-icon anchor-icon-link" anchorid="添加依赖" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libohimage.so，libimage_receiver.so，libnative_image.so 以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-abi-c106="" class="highlight-div"><div _ngcontent-abi-c106="" class="highlight-div-header"><div _ngcontent-abi-c106="" class="highlight-div-header-left"><div _ngcontent-abi-c106="" class="handle-button expand-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-abi-c106="" class="highlight-div-header-right"><div _ngcontent-abi-c106="" class="handle-button ai-button"></div><div _ngcontent-abi-c106="" class="handle-button line-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-abi-c106="" class="handle-button theme-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-abi-c106="" class="handle-button copy-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-abi-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libohimage.so libimage_receiver.so libnative_image.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <div _ngcontent-abi-c106="" class="highlight-div"><div _ngcontent-abi-c106="" class="highlight-div-header"><div _ngcontent-abi-c106="" class="highlight-div-header-left"><div _ngcontent-abi-c106="" class="handle-button expand-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-abi-c106="" class="highlight-div-header-right"><div _ngcontent-abi-c106="" class="handle-button ai-button"></div><div _ngcontent-abi-c106="" class="handle-button line-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-abi-c106="" class="handle-button theme-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-abi-c106="" class="handle-button copy-button"><div _ngcontent-abi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-abi-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_receiver_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_WIDTH 320</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_HEIGHT 480</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_CAPACITY 2</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ImageNativeCTest</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建 OH_ImageReceiverOptions 实例。</span></li><li>    OH_ImageReceiverOptions* options = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_Create</span>(&amp;options);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest create image receiver options failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    Image_Size imgSize;</li><li>    imgSize.width = IMAGE_WIDTH;</li><li>    imgSize.height = IMAGE_HEIGHT;</li><li>
</li><li>    <span class="hljs-comment">// 设置 OH_ImageReceiverOptions 的 size 属性。该属性仅为必要入参，实际上不会生效，图片属性由生产者决定，如相机。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetSize</span>(options, imgSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest set image receiver options size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置 OH_ImageReceiverOptions 的 capacity 属性。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetCapacity</span>(options, IMAGE_CAPACITY);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest set image receiver options capacity failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建 OH_ImageReceiverNative 实例。</span></li><li>    OH_ImageReceiverNative* receiver = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Create</span>(options, &amp;receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest create image receiver failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverNative 的下一个图片对象。</span></li><li>    OH_ImageNative* image = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_ReadNextImage</span>(receiver, &amp;image);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver next image failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的 size 属性。该属性实际上不会生效，图片属性由生产者决定，如相机。</span></li><li>    Image_Size imgSizeRead;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetImageSize</span>(image, &amp;imgSizeRead);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的组件列表的元素个数。</span></li><li>    <span class="hljs-type">size_t</span> componentTypeSize = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetComponentTypes</span>(image, <span class="hljs-literal">nullptr</span>, &amp;componentTypeSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image component types failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的组件列表。</span></li><li>    <span class="hljs-type">uint32_t</span>* components = <span class="hljs-keyword">new</span> <span class="hljs-type">uint32_t</span>[componentTypeSize];</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetComponentTypes</span>(image, &amp;components, &amp;componentTypeSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image component types failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">delete</span> [] components;</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">delete</span> [] components;</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的缓冲区对象。</span></li><li>    OH_NativeBuffer* nativeBuffer = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetByteBuffer</span>(image, components[<span class="hljs-number">0</span>], &amp;nativeBuffer);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image byte buffer failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的缓冲区大小。</span></li><li>    <span class="hljs-type">size_t</span> nativeBufferSize = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetBufferSize</span>(image, components[<span class="hljs-number">0</span>], &amp;nativeBufferSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image buffer size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的像素行宽。</span></li><li>    <span class="hljs-type">int32_t</span> rowStride = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetRowStride</span>(image, components[<span class="hljs-number">0</span>], &amp;rowStride);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image row stride failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的像素大小。</span></li><li>    <span class="hljs-type">int32_t</span> pixelStride = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetPixelStride</span>(image, components[<span class="hljs-number">0</span>], &amp;pixelStride);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image pixel stride failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);<span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 对象所对应的时间戳信息。</span></li><li>    <span class="hljs-type">int64_t</span> timestamp = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetTimestamp</span>(image, &amp;timestamp);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get timestamp failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageNative 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image native failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageReceiverOptions 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image receiver options failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageReceiverOptions 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image receiver failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>