<h1 _ngcontent-qoo-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule完成位图操作"> 使用Image_NativeModule完成位图操作 </h1>

<div _ngcontent-qoo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>创建位图，获取位图的宽、高、pixelFormat、alphaType、rowStride信息、对位图进行操作以及释放位图实例。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加链接库" class="firsth2">添加链接库<i class="anchor-icon anchor-icon-link" anchorid="添加链接库" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libpixelmap.so以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-qoo-c106="" class="highlight-div"><div _ngcontent-qoo-c106="" class="highlight-div-header"><div _ngcontent-qoo-c106="" class="highlight-div-header-left"><div _ngcontent-qoo-c106="" class="handle-button expand-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qoo-c106="" class="highlight-div-header-right"><div _ngcontent-qoo-c106="" class="handle-button ai-button"></div><div _ngcontent-qoo-c106="" class="handle-button line-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qoo-c106="" class="handle-button theme-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qoo-c106="" class="handle-button copy-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qoo-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libpixelmap.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <p><strong>位图接口使用示例</strong></p>     <p>在初始化参数后创建Pixelmap实例，进行图片像素数据的读写，对图片进行缩放、位置变换、反转、旋转、裁剪等操作。</p>     <div _ngcontent-qoo-c106="" class="highlight-div"><div _ngcontent-qoo-c106="" class="highlight-div-header"><div _ngcontent-qoo-c106="" class="highlight-div-header-left"><div _ngcontent-qoo-c106="" class="handle-button expand-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qoo-c106="" class="highlight-div-header-right"><div _ngcontent-qoo-c106="" class="handle-button ai-button"></div><div _ngcontent-qoo-c106="" class="handle-button line-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qoo-c106="" class="handle-button theme-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qoo-c106="" class="handle-button copy-button"><div _ngcontent-qoo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qoo-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-function">Image_ErrorCode <span class="hljs-title">PixelmapTest</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint8_t</span> data[<span class="hljs-number">96</span>];</li><li>    <span class="hljs-type">size_t</span> dataSize = <span class="hljs-number">96</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; dataSize; i++) {</li><li>        data[i] = i + <span class="hljs-number">1</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建参数结构体实例，并设置参数。</span></li><li>    OH_Pixelmap_InitializationOptions *createOpts;</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_Create</span>(&amp;createOpts);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetWidth</span>(createOpts, <span class="hljs-number">6</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetHeight</span>(createOpts, <span class="hljs-number">4</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetPixelFormat</span>(createOpts, PIXEL_FORMAT_RGBA_8888);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetAlphaType</span>(createOpts, PIXELMAP_ALPHA_TYPE_UNKNOWN);</li><li>
</li><li>    <span class="hljs-comment">// 创建Pixelmap实例。</span></li><li>    OH_PixelmapNative *pixelmap = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_PixelmapNative_CreatePixelmap</span>(data, dataSize, createOpts, &amp;pixelmap);</li><li>
</li><li>    <span class="hljs-comment">// 读取图像像素数据，结果写入数组里。</span></li><li>    <span class="hljs-type">uint8_t</span> destination[<span class="hljs-number">96</span>];</li><li>    <span class="hljs-type">size_t</span> destinationSize = <span class="hljs-number">96</span>;</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_ReadPixels</span>(pixelmap, destination, &amp;destinationSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_ReadPixels failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取缓冲区中的图片数据，结果写入Pixelmap中。</span></li><li>    <span class="hljs-type">uint8_t</span> source[<span class="hljs-number">96</span>];</li><li>    <span class="hljs-type">size_t</span> sourceSize = <span class="hljs-number">96</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sourceSize; i++) {</li><li>        source[i] = i + <span class="hljs-number">1</span>;</li><li>    }</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_WritePixels</span>(pixelmap, source, sourceSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_WritePixels failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建图片信息实例，并获取图像像素信息。</span></li><li>    OH_Pixelmap_ImageInfo *imageInfo;</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_Create</span>(&amp;imageInfo);</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_GetImageInfo</span>(pixelmap, imageInfo);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_GetImageInfo failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取图片的宽，高，pixel格式，透明度等信息。</span></li><li>    <span class="hljs-type">uint32_t</span> width, height, rowStride;</li><li>    <span class="hljs-type">int32_t</span> pixelFormat, alphaType;</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetWidth</span>(imageInfo, &amp;width);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetHeight</span>(imageInfo, &amp;height);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetRowStride</span>(imageInfo, &amp;rowStride);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetPixelFormat</span>(imageInfo, &amp;pixelFormat);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetAlphaType</span>(imageInfo, &amp;alphaType);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_Release</span>(imageInfo);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest GetImageInfo success, width: %{public}d, height: %{public}d, rowStride: %{public}d, pixelFormat: %{public}d, alphaType: %{public}d."</span>, width, height, rowStride, pixelFormat, alphaType);</li><li>
</li><li>    <span class="hljs-comment">// 设置透明比率来让Pixelmap达到对应的透明效果。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Opacity</span>(pixelmap, <span class="hljs-number">0.5</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Opacity failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 对图片进行缩放。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Scale</span>(pixelmap, <span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Scale failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 对图片进行位置变换。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Translate</span>(pixelmap, <span class="hljs-number">50.0</span>, <span class="hljs-number">10.0</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Translate failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 对图片进行旋转。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Rotate</span>(pixelmap, <span class="hljs-number">90.0</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Rotate failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 对图片进行翻转。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Flip</span>(pixelmap, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Flip failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 对图片进行裁剪。</span></li><li>    Image_Region region;</li><li>    region.x = <span class="hljs-number">100</span>;</li><li>    region.y = <span class="hljs-number">100</span>;</li><li>    region.width = <span class="hljs-number">6</span>;</li><li>    region.height = <span class="hljs-number">4</span>;</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Crop</span>(pixelmap, &amp;region);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePixelmapNativeCTest pixelmapTest OH_PixelmapNative_Crop failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放Pixelmap, InitializationOptions实例。</span></li><li>    <span class="hljs-built_in">OH_PixelmapNative_Release</span>(pixelmap);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_Release</span>(createOpts);</li><li>    <span class="hljs-keyword">return</span> IMAGE_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-comment">// PixelMap预乘/非预乘格式转换示例。</span></li><li><span class="hljs-function">Image_ErrorCode <span class="hljs-title">PixelmapConverAlphaTypeTest</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint8_t</span> data[<span class="hljs-number">96</span>];</li><li>    <span class="hljs-type">size_t</span> dataSize = <span class="hljs-number">96</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; dataSize; i++) {</li><li>        data[i] = i + <span class="hljs-number">1</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建参数结构体实例，并设置参数。</span></li><li>    OH_Pixelmap_InitializationOptions *createOpts;</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_Create</span>(&amp;createOpts);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetWidth</span>(createOpts, <span class="hljs-number">6</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetHeight</span>(createOpts, <span class="hljs-number">4</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetSrcPixelFormat</span>(createOpts, PIXEL_FORMAT_RGBA_8888);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetPixelFormat</span>(createOpts, PIXEL_FORMAT_RGBA_8888);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetAlphaType</span>(createOpts, PIXELMAP_ALPHA_TYPE_UNPREMULTIPLIED);</li><li>
</li><li>    <span class="hljs-comment">// 创建非预乘格式的位图实例。</span></li><li>    OH_PixelmapNative *SrcPixelmap = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_PixelmapNative_CreatePixelmap</span>(data, dataSize, createOpts, &amp;SrcPixelmap);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"PixelmapConverAlphaTypeTest CreateSrcPixelMap failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建预乘格式的位图实例，该DstPixelmap实例将用于保存SrcPixelmap转换AlphaType后的数据。</span></li><li>    OH_PixelmapNative *DstPixelmap = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetAlphaType</span>(createOpts, PIXELMAP_ALPHA_TYPE_PREMULTIPLIED);</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_CreatePixelmap</span>(data, dataSize, createOpts, &amp;DstPixelmap);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"PixelmapConverAlphaTypeTest CreateDstPixelMap failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 转换AlphaType，SrcPixelmap的数据将被转换为预乘格式，并保存到DstPixelmap中。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_ConvertAlphaFormat</span>(SrcPixelmap, DstPixelmap, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"PixelmapConverAlphaTypeTest ConvertAlphaFormat failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放Pixelmap，InitializationOptions实例。</span></li><li>    <span class="hljs-built_in">OH_PixelmapNative_Release</span>(SrcPixelmap);</li><li>    <span class="hljs-built_in">OH_PixelmapNative_Release</span>(DstPixelmap);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_Release</span>(createOpts);</li><li>    <span class="hljs-keyword">return</span> errCode;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>