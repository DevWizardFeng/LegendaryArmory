<h1 _ngcontent-srk-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule完成图片接收"> 使用Image_NativeModule完成图片接收 </h1>

<div _ngcontent-srk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>图像接收类，用于获取组件surface id、接收最新的图片和读取下一张图片、释放ImageReceiver实例。结合camera API实现的相机预览示例代码可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-preview-imagereceiver">C/C++预览流二次处理示例</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>ImageReceiver只作为图片的接收方、消费者，在ImageReceiver设置的size、format等属性实际上并不会生效。图片属性需要在发送方、生产者进行设置，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-preview">预览(C/C++)</a>设置previewProfiles。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加依赖" class="firsth2">添加依赖<i class="anchor-icon anchor-icon-link" anchorid="添加依赖" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libohimage.so、libimage_receiver.so、libnative_image.so以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-srk-c106="" class="highlight-div"><div _ngcontent-srk-c106="" class="highlight-div-header"><div _ngcontent-srk-c106="" class="highlight-div-header-left"><div _ngcontent-srk-c106="" class="handle-button expand-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srk-c106="" class="highlight-div-header-right"><div _ngcontent-srk-c106="" class="handle-button ai-button"></div><div _ngcontent-srk-c106="" class="handle-button line-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srk-c106="" class="handle-button theme-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srk-c106="" class="handle-button copy-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srk-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libohimage.so libimage_receiver.so libnative_image.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在DevEco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <div _ngcontent-srk-c106="" class="highlight-div"><div _ngcontent-srk-c106="" class="highlight-div-header"><div _ngcontent-srk-c106="" class="highlight-div-header-left"><div _ngcontent-srk-c106="" class="handle-button expand-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srk-c106="" class="highlight-div-header-right"><div _ngcontent-srk-c106="" class="handle-button ai-button"></div><div _ngcontent-srk-c106="" class="handle-button line-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srk-c106="" class="handle-button theme-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srk-c106="" class="handle-button copy-button"><div _ngcontent-srk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srk-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_receiver_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_WIDTH 320</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_HEIGHT 480</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMAGE_CAPACITY 2</span></li><li>
</li><li><span class="hljs-type">static</span> OH_ImageReceiverNative* receiver = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> OH_ImageReceiverOptions* options = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnCallback</span><span class="hljs-params">(OH_ImageReceiverNative *receiver)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// callback回调处理接收到的图像数据。</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest buffer available."</span>);</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverNative 的下一个图片对象。</span></li><li>    OH_ImageNative* image = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverNative_ReadNextImage</span>(receiver, &amp;image);</li><li>    <span class="hljs-comment">// 结合实际使用情况，此处也可以调用OH_ImageReceiverNative_ReadLatestImage方法获取图像数据。</span></li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver next image failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 应用自行处理image图像数据。</span></li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageNative 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image native failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ImageReceiverNativeCTest</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建 OH_ImageReceiverOptions 实例。</span></li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_Create</span>(&amp;options);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest create image receiver options failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    Image_Size imgSize;</li><li>    imgSize.width = IMAGE_WIDTH;</li><li>    imgSize.height = IMAGE_HEIGHT;</li><li>
</li><li>    <span class="hljs-comment">// 设置 OH_ImageReceiverOptions 的 size 属性。该属性仅为必要入参，实际上不会生效，图片属性由生产者决定，如相机。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetSize</span>(options, imgSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest set image receiver options size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置 OH_ImageReceiverOptions 的 capacity 属性。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetCapacity</span>(options, IMAGE_CAPACITY);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest set image receiver options capacity failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverOptions 的 size 属性。该属性实际上不会生效，图片属性由生产者决定，如相机。</span></li><li>    Image_Size imgSizeRead;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_GetSize</span>(options, &amp;imgSizeRead);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver options size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 检查读取到的 size 值是否为设定值。该值实际上不会生效，图片宽高由生产者决定，如相机。</span></li><li>    <span class="hljs-keyword">if</span> (imgSizeRead.width != IMAGE_WIDTH || imgSizeRead.height != IMAGE_HEIGHT) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver options size failed, width: %{public}d, height: %{public}d."</span>, imgSizeRead.width, imgSizeRead.height);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverOptions 的 capacity 属性。</span></li><li>    <span class="hljs-type">int32_t</span> capacity = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_GetCapacity</span>(options, &amp;capacity);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver options capacity failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 检查读取到的 capacity 值是否为设定值。</span></li><li>    <span class="hljs-keyword">if</span> (capacity != IMAGE_CAPACITY) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver options capacity failed, capacity: %{public}d."</span>, capacity);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建 OH_ImageReceiverNative 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Create</span>(options, &amp;receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest create image receiver failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 注册一个回调事件，每当接收到新的图片，该回调事件就会响应。</span></li><li>    <span class="hljs-type">uint64_t</span> surfaceID = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_On</span>(receiver, OnCallback);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest image receiver on failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverNative 的 surfaceID 属性。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_GetReceivingSurfaceId</span>(receiver, &amp;surfaceID);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver surfaceID failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver surfaceID: %{public}lu."</span>, surfaceID);</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverNative 的 size 属性。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_GetSize</span>(receiver, &amp;imgSizeRead);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver size failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver size: width = %{public}d, height = %{public}d."</span>, imgSizeRead.width, imgSizeRead.height);</li><li>
</li><li>    <span class="hljs-comment">// 读取 OH_ImageReceiverNative 的 capacity 属性。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_GetCapacity</span>(receiver, &amp;capacity);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver capacity failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>        <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest get image receiver capacity: %{public}d."</span>, capacity);</li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageReceiverOptions 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_Release</span>(options);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image receiver options failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 在合适时机释放ImageReceiverNative相关资源。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ImageReceiverRelease</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 关闭被 OH_ImageReceiverNative_On 开启的回调事件。</span></li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Off</span>(receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest image receiver off failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放 OH_ImageReceiverOptions 实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Release</span>(receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest release image receiver failed, errCode: %{public}d."</span>, errCode);</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>