<h1 _ngcontent-atg-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule完成图片编码"> 使用Image_NativeModule完成图片编码 </h1>

<div _ngcontent-atg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>图像编码类，用于创建以及释放ImagePacker实例。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加链接库" class="firsth2">添加链接库<i class="anchor-icon anchor-icon-link" anchorid="添加链接库" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libimage_packer.so 以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-atg-c106="" class="highlight-div"><div _ngcontent-atg-c106="" class="highlight-div-header"><div _ngcontent-atg-c106="" class="highlight-div-header-left"><div _ngcontent-atg-c106="" class="handle-button expand-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-atg-c106="" class="highlight-div-header-right"><div _ngcontent-atg-c106="" class="handle-button ai-button"></div><div _ngcontent-atg-c106="" class="handle-button line-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-atg-c106="" class="handle-button theme-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-atg-c106="" class="handle-button copy-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-atg-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libimage_source.so libimage_packer.so libpixelmap.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <p><strong>编码接口使用示例</strong></p>     <p>在创建ImagePacker实例，指定编码参数后将ImageSource或Pixelmap编码至文件或者缓冲区。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>根据MIME标准，标准编码格式为image/jpeg。当使用image编码时，编码参数中的编码格式image_MimeType设置为image/jpeg，image编码后的文件扩展名可设为.jpg或.jpeg，可在支持image/jpeg解码的平台上使用。</p>      </div></div></div>     <div _ngcontent-atg-c106="" class="highlight-div"><div _ngcontent-atg-c106="" class="highlight-div-header"><div _ngcontent-atg-c106="" class="highlight-div-header-left"><div _ngcontent-atg-c106="" class="handle-button expand-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-atg-c106="" class="highlight-div-header-right"><div _ngcontent-atg-c106="" class="handle-button ai-button"></div><div _ngcontent-atg-c106="" class="handle-button line-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-atg-c106="" class="handle-button theme-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-atg-c106="" class="handle-button copy-button"><div _ngcontent-atg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-atg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;set&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_common.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_packer_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_source_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-type">static</span> std::set&lt;std::string&gt; g_encodeSupportedFormats;</li><li>
</li><li><span class="hljs-function">Image_MimeType <span class="hljs-title">GetMimeTypeIfEncodable</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> it = g_encodeSupportedFormats.<span class="hljs-built_in">find</span>(format);</li><li>    <span class="hljs-keyword">if</span> (it == g_encodeSupportedFormats.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-keyword">return</span> {<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-string">""</span>), <span class="hljs-number">0</span>};</li><li>    }</li><li>    <span class="hljs-keyword">return</span> {<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(format), <span class="hljs-built_in">strlen</span>(format)};</li><li>}</li><li>
</li><li><span class="hljs-function">Image_ErrorCode <span class="hljs-title">packToFileFromImageSourceTest</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">//创建ImagePacker实例。</span></li><li>    OH_ImagePackerNative *testPacker = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImagePackerNative_Create</span>(&amp;testPacker);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest CreatePacker OH_ImagePackerNative_Create failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>    <span class="hljs-comment">// 获取编码能力范围。</span></li><li>    Image_MimeType* mimeType = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImagePackerNative_GetSupportedFormats</span>(&amp;mimeType, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest OH_ImagePackerNative_GetSupportedFormats failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> count = <span class="hljs-number">0</span>; count &lt; length; count++) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Encode supportedFormats:%{public}s"</span>, mimeType[count].data);</li><li>        <span class="hljs-keyword">if</span> (mimeType[count].data != <span class="hljs-literal">nullptr</span>) {</li><li>            g_encodeSupportedFormats.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">string</span>(mimeType[count].data));</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 创建ImageSource实例。</span></li><li>    OH_ImageSourceNative* imageSource = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_CreateFromFd</span>(fd, &amp;imageSource);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest OH_ImageSourceNative_CreateFromFd  failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 指定编码参数，将ImageSource直接编码进文件。</span></li><li>    OH_PackingOptions *option = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_PackingOptions_Create</span>(&amp;option);</li><li>    Image_MimeType image_MimeType = <span class="hljs-built_in">GetMimeTypeIfEncodable</span>(MIME_TYPE_JPEG);</li><li>    <span class="hljs-keyword">if</span> (image_MimeType.data == <span class="hljs-literal">nullptr</span> || image_MimeType.size == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest GetMimeTypeIfEncodable failed, format can't support encode."</span>);</li><li>        <span class="hljs-keyword">return</span> IMAGE_BAD_PARAMETER;</li><li>    }</li><li>    <span class="hljs-built_in">OH_PackingOptions_SetMimeType</span>(option, &amp;image_MimeType);</li><li>    <span class="hljs-comment">// 编码为hdr内容（需要资源本身为hdr，支持jpeg格式）。</span></li><li>    <span class="hljs-built_in">OH_PackingOptions_SetDesiredDynamicRange</span>(option, IMAGE_PACKER_DYNAMIC_RANGE_AUTO);</li><li>    errCode = <span class="hljs-built_in">OH_ImagePackerNative_PackToFileFromImageSource</span>(testPacker, option, imageSource, fd);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest OH_ImagePackerNative_PackToFileFromImageSource failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放ImagePacker实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImagePackerNative_Release</span>(testPacker);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS)</li><li>    {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest ReleasePacker OH_ImagePackerNative_Release failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>    <span class="hljs-comment">// 释放ImageSource实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_Release</span>(imageSource);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS)</li><li>    {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest ReleasePacker OH_ImageSourceNative_Release failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> IMAGE_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-function">Image_ErrorCode <span class="hljs-title">packToFileFromPixelmapTest</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> *buffer, <span class="hljs-type">size_t</span> bufferSize, <span class="hljs-type">int</span> fd)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建ImagePacker实例。</span></li><li>    OH_ImagePackerNative *testPacker = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImagePackerNative_Create</span>(&amp;testPacker);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest CreatePacker OH_ImagePackerNative_Create failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建Pixelmap实例。</span></li><li>    OH_Pixelmap_InitializationOptions *createOpts;</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_Create</span>(&amp;createOpts);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetWidth</span>(createOpts, <span class="hljs-number">6</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetHeight</span>(createOpts, <span class="hljs-number">4</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetPixelFormat</span>(createOpts, <span class="hljs-number">3</span>);</li><li>    <span class="hljs-built_in">OH_PixelmapInitializationOptions_SetAlphaType</span>(createOpts, <span class="hljs-number">0</span>);</li><li>    OH_PixelmapNative *pixelmap = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_CreatePixelmap</span>(buffer, bufferSize, createOpts, &amp;pixelmap);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest OH_PixelmapNative_CreatePixelmap  failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 指定编码参数，将PixelMap直接编码进文件。</span></li><li>    OH_PackingOptions *option = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_PackingOptions_Create</span>(&amp;option);</li><li>    <span class="hljs-type">char</span> type[] = <span class="hljs-string">"image/jpeg"</span>;</li><li>    Image_MimeType image_MimeType = {type, <span class="hljs-built_in">strlen</span>(type)};</li><li>    <span class="hljs-built_in">OH_PackingOptions_SetMimeType</span>(option, &amp;image_MimeType);</li><li>    errCode = <span class="hljs-built_in">OH_ImagePackerNative_PackToFileFromPixelmap</span>(testPacker, option, pixelmap, fd);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest OH_ImagePackerNative_PackToFileFromPixelmap  failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放ImagePacker实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImagePackerNative_Release</span>(testPacker);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS)</li><li>    {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest ReleasePacker OH_ImagePackerNative_Release failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放Pixelmap实例。</span></li><li>    errCode = <span class="hljs-built_in">OH_PixelmapNative_Release</span>(pixelmap);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS)</li><li>    {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImagePackerNativeCTest ReleasePacker OH_PixelmapNative_Release failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> errCode;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> IMAGE_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>