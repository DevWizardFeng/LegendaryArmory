<h1 _ngcontent-wau-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule完成图片解码"> 使用Image_NativeModule完成图片解码 </h1>

<div _ngcontent-wau-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>创建ImageSource，获取位图的宽、高信息，以及释放ImageSource实例。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加链接库" class="firsth2">添加链接库<i class="anchor-icon anchor-icon-link" anchorid="添加链接库" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libimage_source.so、libpixelmap.so以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-wau-c106="" class="highlight-div"><div _ngcontent-wau-c106="" class="highlight-div-header"><div _ngcontent-wau-c106="" class="highlight-div-header-left"><div _ngcontent-wau-c106="" class="handle-button expand-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wau-c106="" class="highlight-div-header-right"><div _ngcontent-wau-c106="" class="handle-button ai-button"></div><div _ngcontent-wau-c106="" class="handle-button line-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wau-c106="" class="handle-button theme-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wau-c106="" class="handle-button copy-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wau-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libimage_source.so libpixelmap.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <p><strong>解码接口使用示例</strong></p>     <p>在创建ImageSource实例后，进行指定属性值的获取和修改、通过解码参数创建PixelMap对象、获取图像帧数等操作。</p>     <div _ngcontent-wau-c106="" class="highlight-div"><div _ngcontent-wau-c106="" class="highlight-div-header"><div _ngcontent-wau-c106="" class="highlight-div-header-left"><div _ngcontent-wau-c106="" class="handle-button expand-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wau-c106="" class="highlight-div-header-right"><div _ngcontent-wau-c106="" class="handle-button ai-button"></div><div _ngcontent-wau-c106="" class="handle-button line-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wau-c106="" class="handle-button theme-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wau-c106="" class="handle-button copy-button"><div _ngcontent-wau-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wau-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_common.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_source_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_0 0</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_1 1</span></li><li>
</li><li><span class="hljs-comment">// 处理napi返回值。</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">getJsResult</span><span class="hljs-params">(napi_env env, <span class="hljs-type">int</span> result)</span> </span>{</li><li>    napi_value resultNapi = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;resultNapi);</li><li>    <span class="hljs-keyword">return</span> resultNapi;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">sourceTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value argValue[NUM_1] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">size_t</span> argCount = NUM_1;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argCount, argValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>) != napi_ok || argCount &lt; NUM_1 ||</li><li>        argValue[NUM_0] == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest napi_get_cb_info failed, argCount: %{public}lu."</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(argCount));</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, IMAGE_BAD_PARAMETER);</li><li>    }</li><li>    <span class="hljs-type">char</span> name[<span class="hljs-number">1024</span>];</li><li>    <span class="hljs-type">size_t</span> nameSize = <span class="hljs-number">1024</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argValue[NUM_0], name, <span class="hljs-number">1024</span>, &amp;nameSize);</li><li>    <span class="hljs-comment">// 获取解码能力范围。</span></li><li>    Image_MimeType* mimeType = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetSupportedFormats</span>(&amp;mimeType, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetSupportedFormats failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> count = <span class="hljs-number">0</span>; count &lt; length; count++) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Decode supportedFormats:%{public}s"</span>, mimeType[count].data);</li><li>    }</li><li>    <span class="hljs-comment">// 创建ImageSource实例。</span></li><li>    OH_ImageSourceNative *source = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_CreateFromUri</span>(name, nameSize, &amp;source);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_CreateFromUri failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建定义图片信息的结构体对象，并获取图片信息。</span></li><li>    OH_ImageSource_Info *imageInfo;</li><li>    <span class="hljs-built_in">OH_ImageSourceInfo_Create</span>(&amp;imageInfo);</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetImageInfo</span>(source, <span class="hljs-number">0</span>, imageInfo);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetImageInfo failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取指定属性键的值。</span></li><li>    <span class="hljs-type">uint32_t</span> width, height;</li><li>    <span class="hljs-built_in">OH_ImageSourceInfo_GetWidth</span>(imageInfo, &amp;width);</li><li>    <span class="hljs-built_in">OH_ImageSourceInfo_GetHeight</span>(imageInfo, &amp;height);</li><li>    <span class="hljs-built_in">OH_ImageSourceInfo_Release</span>(imageInfo);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetImageInfo success, width: %{public}d, height: %{public}d."</span>, width, height);</li><li>    Image_String getKey;</li><li>    <span class="hljs-type">const</span> std::string PIXEL_X_DIMENSION = <span class="hljs-string">"PixelXDimension"</span>;</li><li>    getKey.data = (<span class="hljs-type">char</span> *)PIXEL_X_DIMENSION.<span class="hljs-built_in">c_str</span>();</li><li>    getKey.size = PIXEL_X_DIMENSION.<span class="hljs-built_in">length</span>();</li><li>    Image_String getValue;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetImageProperty</span>(source, &amp;getKey, &amp;getValue);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetImageProperty failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 修改指定属性键的值。</span></li><li>    Image_String setKey;</li><li>    <span class="hljs-type">const</span> std::string ORIENTATION = <span class="hljs-string">"Orientation"</span>;</li><li>    setKey.data = (<span class="hljs-type">char</span> *)ORIENTATION.<span class="hljs-built_in">c_str</span>();</li><li>    setKey.size = ORIENTATION.<span class="hljs-built_in">length</span>();</li><li>    Image_String setValue;</li><li>    setValue.data = (<span class="hljs-type">char</span> *)<span class="hljs-string">"4"</span>;</li><li>    setValue.size = <span class="hljs-number">1</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_ModifyImageProperty</span>(source, &amp;setKey, &amp;setValue);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_ModifyImageProperty failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 通过图片解码参数创建PixelMap对象。</span></li><li>    OH_DecodingOptions *ops = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_DecodingOptions_Create</span>(&amp;ops);</li><li>    <span class="hljs-comment">// 设置为AUTO会根据图片资源格式解码，如果图片资源为HDR资源则会解码为HDR的pixelmap。</span></li><li>    <span class="hljs-built_in">OH_DecodingOptions_SetDesiredDynamicRange</span>(ops, IMAGE_DYNAMIC_RANGE_AUTO);</li><li>    OH_PixelmapNative *resPixMap = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// ops参数支持传入nullptr, 当不需要设置解码参数时，不用创建。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_CreatePixelmap</span>(source, ops, &amp;resPixMap);</li><li>    <span class="hljs-built_in">OH_DecodingOptions_Release</span>(ops);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_CreatePixelmap failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 判断pixelmap是否为hdr内容。</span></li><li>    OH_Pixelmap_ImageInfo *pixelmapImageInfo = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_Create</span>(&amp;pixelmapImageInfo);</li><li>    <span class="hljs-built_in">OH_PixelmapNative_GetImageInfo</span>(resPixMap, pixelmapImageInfo);</li><li>    <span class="hljs-type">bool</span> pixelmapIsHdr;</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_GetDynamicRange</span>(pixelmapImageInfo, &amp;pixelmapIsHdr);</li><li>    <span class="hljs-built_in">OH_PixelmapImageInfo_Release</span>(pixelmapImageInfo);</li><li>
</li><li>    <span class="hljs-comment">// 获取图像帧数。</span></li><li>    <span class="hljs-type">uint32_t</span> frameCnt = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetFrameCount</span>(source, &amp;frameCnt);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetFrameCount failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 通过图片解码参数创建Pixelmap列表。</span></li><li>    OH_DecodingOptions *opts = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_DecodingOptions_Create</span>(&amp;opts);</li><li>    OH_PixelmapNative **resVecPixMap = <span class="hljs-keyword">new</span> OH_PixelmapNative*[frameCnt];</li><li>    <span class="hljs-type">size_t</span> outSize = frameCnt;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_CreatePixelmapList</span>(source, opts, resVecPixMap, outSize);</li><li>    <span class="hljs-built_in">OH_DecodingOptions_Release</span>(opts);</li><li>    <span class="hljs-keyword">delete</span>[] resVecPixMap;</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_CreatePixelmapList failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取图像延迟时间列表。</span></li><li>    <span class="hljs-type">int32_t</span> *delayTimeList = <span class="hljs-keyword">new</span> <span class="hljs-type">int32_t</span>[frameCnt];</li><li>    <span class="hljs-type">size_t</span> size = frameCnt;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetDelayTimeList</span>(source, delayTimeList, size);</li><li>    <span class="hljs-keyword">delete</span>[] delayTimeList;</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest OH_ImageSourceNative_GetDelayTimeList failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放ImageSource实例。</span></li><li>    <span class="hljs-built_in">OH_ImageSourceNative_Release</span>(source);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest sourceTest success."</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, IMAGE_SUCCESS);</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>