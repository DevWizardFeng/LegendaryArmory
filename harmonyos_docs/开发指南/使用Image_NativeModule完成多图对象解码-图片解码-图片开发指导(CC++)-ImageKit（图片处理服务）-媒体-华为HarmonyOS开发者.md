<h1 _ngcontent-kto-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule完成多图对象解码"> 使用Image_NativeModule完成多图对象解码 </h1>

<div _ngcontent-kto-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>创建ImageSource，解码得到Picture，以及释放ImageSource实例。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加链接库" class="firsth2">添加链接库<i class="anchor-icon anchor-icon-link" anchorid="添加链接库" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libimage_source.so 以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-kto-c106="" class="highlight-div"><div _ngcontent-kto-c106="" class="highlight-div-header"><div _ngcontent-kto-c106="" class="highlight-div-header-left"><div _ngcontent-kto-c106="" class="handle-button expand-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kto-c106="" class="highlight-div-header-right"><div _ngcontent-kto-c106="" class="handle-button ai-button"></div><div _ngcontent-kto-c106="" class="handle-button line-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kto-c106="" class="handle-button theme-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kto-c106="" class="handle-button copy-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kto-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libimage_source.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">API文档</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <p><strong>解码接口使用示例</strong></p>     <p>在创建ImageSource实例后，进行指定属性值的获取和修改，通过解码参数创建PixelMap对象，获取图像帧数等操作。</p>     <div _ngcontent-kto-c106="" class="highlight-div"><div _ngcontent-kto-c106="" class="highlight-div-header"><div _ngcontent-kto-c106="" class="highlight-div-header-left"><div _ngcontent-kto-c106="" class="handle-button expand-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kto-c106="" class="highlight-div-header-right"><div _ngcontent-kto-c106="" class="handle-button ai-button"></div><div _ngcontent-kto-c106="" class="handle-button line-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kto-c106="" class="handle-button theme-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kto-c106="" class="handle-button copy-button"><div _ngcontent-kto-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kto-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">hilog</span>/<span class="hljs-title class_">log</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">multimedia</span>/<span class="hljs-title class_">image_framework</span>/<span class="hljs-title class_">image</span>/<span class="hljs-title class_">image_native</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">multimedia</span>/<span class="hljs-title class_">image_framework</span>/<span class="hljs-title class_">image</span>/<span class="hljs-title class_">image_packer_native</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">multimedia</span>/<span class="hljs-title class_">image_framework</span>/<span class="hljs-title class_">image</span>/<span class="hljs-title class_">image_source_native</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">multimedia</span>/<span class="hljs-title class_">image_framework</span>/<span class="hljs-title class_">image</span>/<span class="hljs-title class_">picture_native</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">multimedia</span>/<span class="hljs-title class_">image_framework</span>/<span class="hljs-title class_">image</span>/<span class="hljs-title class_">pixelmap_native</span>.<span class="hljs-title class_">h</span>&gt;</li><li>
</li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">AUTO</span> <span class="hljs-number">0</span></li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">SDR</span> <span class="hljs-number">1</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImagePictureNative</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">Image_ErrorCode</span> <span class="hljs-variable">errorCode</span> = <span class="hljs-variable">IMAGE_SUCCESS</span>;</li><li>    <span class="hljs-variable">OH_DecodingOptionsForPicture</span> *<span class="hljs-variable">options</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_ImagePackerNative</span> *<span class="hljs-variable">imagePacker</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_PackingOptions</span> *<span class="hljs-variable">packerOptions</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_PictureNative</span> *<span class="hljs-variable">picture</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_ImageSourceNative</span> *<span class="hljs-variable">source</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">ImagePictureNative</span>() {}</li><li>    ~<span class="hljs-title function_">ImagePictureNative</span>() {}</li><li>};</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageAuxiliaryPictureNative</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">Image_ErrorCode</span> <span class="hljs-variable">errorCode</span> = <span class="hljs-variable">IMAGE_SUCCESS</span>;</li><li>    <span class="hljs-variable">Image_AuxiliaryPictureType</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">AUXILIARY_PICTURE_TYPE_GAINMAP</span>;</li><li>    <span class="hljs-variable">OH_AuxiliaryPictureNative</span> *<span class="hljs-variable">auxiliaryPicture</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">BUFF_SIZE</span> = <span class="hljs-number">640</span> * <span class="hljs-number">480</span> * <span class="hljs-number">4</span>;     <span class="hljs-comment">//辅助图size 长*宽*每像素占用字节数。</span></li><li>    <span class="hljs-title function_">ImageAuxiliaryPictureNative</span>() {}</li><li>    ~<span class="hljs-title function_">ImageAuxiliaryPictureNative</span>() {}</li><li>};</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">ImagePictureNative</span> *<span class="hljs-variable">thisPicture</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ImagePictureNative</span>();</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">ImageAuxiliaryPictureNative</span> *<span class="hljs-variable">thisAuxiliaryPicture</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ImageAuxiliaryPictureNative</span>();</li><li>
</li><li><span class="hljs-comment">// 释放ImageSource。</span></li><li><span class="hljs-variable">Image_ErrorCode</span> <span class="hljs-title function_">ReleaseImageSource</span>(<span class="hljs-variable">OH_ImageSourceNative</span> *&amp;<span class="hljs-title class_">source</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">source</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> = <span class="hljs-title function_">OH_ImageSourceNative_Release</span>(<span class="hljs-variable">source</span>);</li><li>        <span class="hljs-variable">source</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>;</li><li>    }</li><li>    <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"ReleaseImageSource source is null !"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">IMAGE_SUCCESS</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 处理napi返回值。</span></li><li><span class="hljs-variable">napi_value</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">int</span> <span class="hljs-variable">result</span>) {</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">resultNapi</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">result</span>, &amp;<span class="hljs-title class_">resultNapi</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">resultNapi</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创造解码参数。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">CreateDecodingOptions</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> = <span class="hljs-title function_">OH_DecodingOptionsForPicture_Create</span>(&amp;<span class="hljs-title class_">thisPicture</span>-&gt;<span class="hljs-title class_">options</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> != <span class="hljs-variable">IMAGE_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_DecodingOptionsForPicture_Create failed, errCode: %{public}d."</span>,</li><li>            <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_DecodingOptionsForPicture_Create success !"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 配置解码参数 从应用层传入。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">SetDesiredAuxiliaryPictures</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>) != <span class="hljs-variable">napi_ok</span> || <span class="hljs-variable">argc</span> &lt; <span class="hljs-number">1</span> || <span class="hljs-title class_">args</span>[<span class="hljs-number">0</span>] == <span class="hljs-title class_">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"napi_get_cb_info failed !"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">IMAGE_BAD_PARAMETER</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">length</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_array_length</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"napi_get_array_length failed !"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">IMAGE_UNKNOWN_ERROR</span>);</li><li>    }</li><li>    <span class="hljs-variable">Image_AuxiliaryPictureType</span> <span class="hljs-variable">typeList</span>[<span class="hljs-variable">length</span>];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">index</span> &lt; <span class="hljs-title class_">length</span>; <span class="hljs-title class_">index</span>++) {</li><li>        <span class="hljs-variable">napi_value</span> <span class="hljs-variable">element</span>;</li><li>        <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">ulType</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-title function_">napi_get_element</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">index</span>, &amp;<span class="hljs-title class_">element</span>);</li><li>        <span class="hljs-title function_">napi_get_value_uint32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">element</span>, &amp;<span class="hljs-title class_">ulType</span>);</li><li>        <span class="hljs-variable">typeList</span>[<span class="hljs-variable">index</span>] = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">Image_AuxiliaryPictureType</span>&gt;(<span class="hljs-variable">ulType</span>);</li><li>        <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"ulType is :%{public}d"</span>, <span class="hljs-variable">ulType</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> =</li><li>        <span class="hljs-title function_">OH_DecodingOptionsForPicture_SetDesiredAuxiliaryPictures</span>(<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">options</span>, <span class="hljs-variable">typeList</span>, <span class="hljs-variable">length</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> != <span class="hljs-variable">IMAGE_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_DecodingOptionsForPicture_SetDesiredAuxiliaryPictures failed,errCode: %{public}d."</span>,</li><li>            <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_DecodingOptionsForPicture_SetDesiredAuxiliaryPictures success !"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">// 解码。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">CreatePictureByImageSource</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">result</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>) != <span class="hljs-variable">napi_ok</span> || <span class="hljs-variable">argc</span> &lt; <span class="hljs-number">1</span> || <span class="hljs-title class_">args</span>[<span class="hljs-number">0</span>] == <span class="hljs-title class_">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"CreatePicture_ napi_get_cb_info failed !"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">IMAGE_BAD_PARAMETER</span>);</li><li>    }</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">filePath</span>[<span class="hljs-number">1024</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">filePathSize</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">filePath</span>, <span class="hljs-number">1024</span>, &amp;<span class="hljs-title class_">filePathSize</span>);</li><li>    <span class="hljs-title function_">ReleaseImageSource</span>(<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">source</span>);</li><li>
</li><li>    <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> = <span class="hljs-title function_">OH_ImageSourceNative_CreateFromUri</span>(<span class="hljs-variable">filePath</span>, <span class="hljs-variable">filePathSize</span>, &amp;<span class="hljs-title class_">thisPicture</span>-&gt;<span class="hljs-title class_">source</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> != <span class="hljs-variable">IMAGE_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_ImageSourceNative_CreateFromUri failed, errCode: %{public}d."</span>,</li><li>            <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_ImageSourceNative_CreateFromUri success !"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> =</li><li>        <span class="hljs-title function_">OH_ImageSourceNative_CreatePicture</span>(<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">source</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">options</span>, &amp;<span class="hljs-title class_">thisPicture</span>-&gt;<span class="hljs-title class_">picture</span>);</li><li>    <span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> = <span class="hljs-title function_">OH_PictureNative_GetAuxiliaryPicture</span>(<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">picture</span>,</li><li>        <span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-keyword">type</span>, &amp;<span class="hljs-title class_">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">auxiliaryPicture</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> == <span class="hljs-variable">IMAGE_SUCCESS</span>) {</li><li>        <span class="hljs-variable">uint8_t</span>* <span class="hljs-variable">buff</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">uint8_t</span>[<span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">BUFF_SIZE</span>];</li><li>        <span class="hljs-title function_">OH_AuxiliaryPictureNative_ReadPixels</span>(<span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">auxiliaryPicture</span>, <span class="hljs-variable">buff</span>,</li><li>            &amp;<span class="hljs-title class_">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">BUFF_SIZE</span>);</li><li>        <span class="hljs-title function_">OH_AuxiliaryPictureNative_Release</span>(<span class="hljs-variable">thisAuxiliaryPicture</span>-&gt;<span class="hljs-title class_">auxiliaryPicture</span>);</li><li>        <span class="hljs-variable">delete</span> []<span class="hljs-variable">buff</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span> != <span class="hljs-variable">IMAGE_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"ImageSourceNative_CreatePicture failed, errCode: %{public}d."</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getJsResult</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">errorCode</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span> =</li><li>            <span class="hljs-title function_">napi_create_external</span>(<span class="hljs-variable">env</span>, <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">thisPicture</span>-&gt;<span class="hljs-title class_">picture</span>), <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> != <span class="hljs-variable">napi_ok</span>) {</li><li>            <span class="hljs-title function_">napi_throw_error</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-string">"Failed to create external object"</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-title function_">OH_LOG_DEBUG</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"ImageSourceNative_CreatePicture success !"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>