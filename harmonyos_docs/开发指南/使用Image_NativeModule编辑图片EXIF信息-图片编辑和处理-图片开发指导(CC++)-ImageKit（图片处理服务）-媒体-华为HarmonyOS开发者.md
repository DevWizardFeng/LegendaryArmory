<h1 _ngcontent-kql-c119="" class="doc-title ng-star-inserted" title="使用Image_NativeModule编辑图片EXIF信息"> 使用Image_NativeModule编辑图片EXIF信息 </h1>

<div _ngcontent-kql-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Image Kit提供图片EXIF信息的读取与编辑能力。</p>    <p>EXIF（Exchangeable image file format）是专门为数码相机的照片设定的文件格式，可以记录数码照片的属性信息和拍摄数据。当前支持JPEG、PNG、HEIF格式，且需要图片包含EXIF信息。</p>    <p>在图库等应用中，需要查看或修改数码照片的EXIF信息。由于摄像机的手动镜头参数无法自动写入到EXIF信息中或者因为相机断电等原因会导致拍摄时间出错，这时需要手动修改错误的EXIF数据，即可使用本功能。</p>    <p>HarmonyOS目前仅支持对部分EXIF信息的查看和修改，具体支持的范围请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-common-h#变量" target="_blank">OHOS_IMAGE_PROPERTY_XXX</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加链接库" class="firsth2">添加链接库<i class="anchor-icon anchor-icon-link" anchorid="添加链接库" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libimage_source.so 以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so libimage_source.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>EXIF信息的读取与编辑相关C API接口的详细介绍请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-source-native-h#oh_imagesourcenative_getimageproperty" target="_blank">OH_ImageSource_GetImageProperty</a> 和 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-source-native-h#oh_imagesourcenative_modifyimageproperty" target="_blank">OH_ImageSource_ModifyImageProperty</a>。</p>     <p>在Deveco Studio新建Native C++应用，默认生成的项目中包含index.ets文件，在entry\src\main\cpp目录下会自动生成一个cpp文件（hello.cpp或napi_init.cpp，本示例以hello.cpp文件名为例）。在hello.cpp中实现C API接口调用逻辑，示例代码如下：</p>     <p><strong>读取和编辑图片EXIF信息接口使用示例</strong></p>     <p>在创建ImageSource实例后，读取、编辑EXIF信息。</p>     <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_source_native.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TAG"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_0 0</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_1 1</span></li><li>
</li><li><span class="hljs-comment">// 处理napi返回值。</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">getJsResult</span><span class="hljs-params">(napi_env env, <span class="hljs-type">int</span> result)</span> </span>{</li><li>    napi_value resultNapi = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, result, &amp;resultNapi);</li><li>    <span class="hljs-keyword">return</span> resultNapi;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">exifTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value argValue[NUM_1] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">size_t</span> argCount = NUM_1;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argCount, argValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>) != napi_ok || argCount &lt; NUM_1 ||</li><li>        argValue[NUM_0] == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest exifTest napi_get_cb_info failed, argCount: %{public}lu."</span>, argCount);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, IMAGE_BAD_PARAMETER);</li><li>    }</li><li>    <span class="hljs-type">char</span> name[<span class="hljs-number">1024</span>];</li><li>    <span class="hljs-type">size_t</span> nameSize = <span class="hljs-number">1024</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argValue[NUM_0], name, <span class="hljs-number">1024</span>, &amp;nameSize);</li><li>
</li><li>    <span class="hljs-comment">//创建ImageSource实例。</span></li><li>    OH_ImageSourceNative *source = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageSourceNative_CreateFromUri</span>(name, nameSize, &amp;source);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest exifTest OH_ImageSourceNative_CreateFromUri failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 读取EXIF信息，OHOS_IMAGE_PROPERTY_BITS_PER_SAMPLE为每个像素比特数。</span></li><li>    Image_String getKey;</li><li>    <span class="hljs-type">const</span> std::string PIXEL_X_DIMENSION = OHOS_IMAGE_PROPERTY_BITS_PER_SAMPLE;</li><li>    getKey.data = (<span class="hljs-type">char</span> *)PIXEL_X_DIMENSION.<span class="hljs-built_in">c_str</span>();</li><li>    getKey.size = PIXEL_X_DIMENSION.<span class="hljs-built_in">length</span>();</li><li>    Image_String getValue;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_GetImageProperty</span>(source, &amp;getKey, &amp;getValue);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest exifTest OH_ImageSourceNative_GetImageProperty failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 编辑EXIF信息，OHOS_IMAGE_PROPERTY_ORIENTATION为图片方向。</span></li><li>    Image_String setKey;</li><li>    <span class="hljs-type">const</span> std::string ORIENTATION = OHOS_IMAGE_PROPERTY_ORIENTATION;</li><li>    setKey.data = (<span class="hljs-type">char</span> *)ORIENTATION.<span class="hljs-built_in">c_str</span>();</li><li>    setKey.size = ORIENTATION.<span class="hljs-built_in">length</span>();</li><li>    Image_String setValue;</li><li>    setValue.data = (<span class="hljs-type">char</span> *)<span class="hljs-string">"4"</span>;</li><li>    setValue.size = <span class="hljs-number">1</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageSourceNative_ModifyImageProperty</span>(source, &amp;setKey, &amp;setValue);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest exifTest OH_ImageSourceNative_ModifyImageProperty failed, errCode: %{public}d."</span>, errCode);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, errCode);</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">//释放ImageSource实例。</span></li><li>    <span class="hljs-built_in">OH_ImageSourceNative_Release</span>(source);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageSourceNativeCTest exifTest success."</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getJsResult</span>(env, IMAGE_SUCCESS);</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>