<h1 _ngcontent-qno-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API感知JSVM引擎生命周期管理"> 使用JSVM-API感知JSVM引擎生命周期管理 </h1>

<div _ngcontent-qno-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API提供了注册回调函数的能力，用于监测JavaScript虚拟机的内存GC。开发者可以在垃圾回收前后添加自定义逻辑，从而在垃圾回收时执行优化、调试或性能监控操作。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>在JavaScript中，内存的垃圾回收是自动进行的，用户并不直接感知JavaScript虚拟机的GC行为。每次GC执行之前，JS引擎会先进入一个"Prologue"阶段。每次GC执行之后，JS引擎会进入一个"Epilogue"阶段。"Prologue"阶段是GC的初始阶段，主要目标是做一些准备工作，以确保垃圾回收能够顺利进行。"Epilogue"阶段则是垃圾回收的最终清理和整理，确保内存恢复到一个正常的状态，并为下一次分配做好准备。在这两个阶段，JS引擎会分别调用用户提前注册的函数。用户可以在"Prologue"阶段所执行的注册函数中暂停某些任务、记录内存使用情况、执行性能调优等。在"Epilogue"阶段所执行的注册函数中，也可以去记录GC后的内存状态、启动后续的任务等等。</p> <p>JSVM-API提供了OH_JSVM_AddHandlerForGC接口，可以在VM中注册回调函数。通过传入JSVM_CB_TRIGGER_BEFORE_GC来控制回调函数在"Prologue"阶段执行；通过传入JSVM_CB_TRIGGER_AFTER_GC来控制回调函数在"Epilogue"阶段执行。通过OH_JSVM_RemoveHandlerForGC，可以从VM中移除注册过的回调函数。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AddHandlerForGC</td> <td class="cellrowborder" valign="top" width="50%">用于向VM中注册回调函数</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RemoveHandlerForGC</td> <td class="cellrowborder" valign="top" width="50%">用于从VM中移除注册过的回调函数</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_addhandlerforgc--oh_jsvm_removehandlerforgc" class="firsth2">OH_JSVM_AddHandlerForGC &amp; OH_JSVM_RemoveHandlerForGC<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_addhandlerforgc--oh_jsvm_removehandlerforgc" tips="复制节点链接"></i></h3><p>可以多次调用OH_JSVM_AddHandlerForGC向VM注册回调函数，所有注册的回调函数都会生效。注册时，以回调函数指针和native-data作为键。如果多次注册存在相同的键，则视为无效注册，并返回JSVM_INVALID_ARG错误码。在相同触发条件下，回调函数的回调顺序与注册顺序不严格一致。</p> <p>通过OH_JSVM_RemoveHandlerForGC可以从VM中移除注册过的回调函数。重复移除具有相同key的回调函数，则会判定为无效移除，并返回JSVM_INVALID_ARG错误码。</p> <p><strong>cpp部分代码</strong></p> <div _ngcontent-qno-c106="" class="highlight-div"><div _ngcontent-qno-c106="" class="highlight-div-header"><div _ngcontent-qno-c106="" class="highlight-div-header-left"><div _ngcontent-qno-c106="" class="handle-button expand-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qno-c106="" class="highlight-div-header-right"><div _ngcontent-qno-c106="" class="handle-button ai-button"></div><div _ngcontent-qno-c106="" class="handle-button line-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qno-c106="" class="handle-button theme-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qno-c106="" class="handle-button copy-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qno-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> before_flag1 = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> before_flag2 = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> after_flag1 = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> after_flag2 = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnBeforeGC</span><span class="hljs-params">(JSVM_VM vm, JSVM_GCType gcType, JSVM_GCCallbackFlags flags, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"== before GC =="</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"gc type: %{public}d"</span>, gcType);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"gc flag: %{public}d"</span>, flags);</li><li>    before_flag1 = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnBeforeGC2</span><span class="hljs-params">(JSVM_VM vm, JSVM_GCType gcType, JSVM_GCCallbackFlags flags, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"== before GC2 =="</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"gc type: %{public}d"</span>, gcType);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"gc flag: %{public}d"</span>, flags);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"data: %{public}d"</span>, *(<span class="hljs-type">int</span>*)data);</li><li>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*)data == <span class="hljs-number">2024</span>) {</li><li>        before_flag2 = <span class="hljs-literal">true</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnAfterGC</span><span class="hljs-params">(JSVM_VM vm, JSVM_GCType gcType, JSVM_GCCallbackFlags flags, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    after_flag1 = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnAfterGC2</span><span class="hljs-params">(JSVM_VM vm, JSVM_GCType gcType, JSVM_GCCallbackFlags flags, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    after_flag2 = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnAfterGC3</span><span class="hljs-params">(JSVM_VM vm, JSVM_GCType gcType, JSVM_GCCallbackFlags flags, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    after_flag2 = <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">TriggerGC</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">bool</span> remove_repeated = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-type">bool</span> remove_notAdded = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-type">bool</span> add_repeated = <span class="hljs-literal">false</span>;</li><li>    before_flag1 = <span class="hljs-literal">false</span>;</li><li>    before_flag2 = <span class="hljs-literal">false</span>;</li><li>    after_flag1 = <span class="hljs-literal">false</span>;</li><li>    after_flag2 = <span class="hljs-literal">false</span>;</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>    <span class="hljs-comment">// 设置两个回调函数，在GC执行之前触发回调</span></li><li>    <span class="hljs-type">int</span> data = <span class="hljs-number">2024</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_AddHandlerForGC</span>(vm, JSVM_CB_TRIGGER_BEFORE_GC, OnBeforeGC, JSVM_GC_TYPE_ALL, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_AddHandlerForGC</span>(vm, JSVM_CB_TRIGGER_BEFORE_GC, OnBeforeGC2, JSVM_GC_TYPE_ALL, (<span class="hljs-type">void</span>*)(&amp;data)));</li><li>    <span class="hljs-comment">// 设置两个回调函数，在GC执行之后触发回调</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_AddHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC, JSVM_GC_TYPE_ALL, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_AddHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC2, JSVM_GC_TYPE_ALL, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-comment">// (OnAfterGC2, NULL)的组合已经注册过了，重复注册为无效行为</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_JSVM_AddHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC2, JSVM_GC_TYPE_ALL, <span class="hljs-literal">NULL</span>) == JSVM_INVALID_ARG) {</li><li>        add_repeated = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 移除OnAfter2回调函数</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_RemoveHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC2, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-comment">// 重复移除OnAfter2属于无效用法</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_JSVM_RemoveHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC2, <span class="hljs-literal">NULL</span>) == JSVM_INVALID_ARG) {</li><li>        remove_repeated = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 移除从未设置过的函数属于无效用法</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_JSVM_RemoveHandlerForGC</span>(vm, JSVM_CB_TRIGGER_AFTER_GC, OnAfterGC3, <span class="hljs-literal">NULL</span>) == JSVM_INVALID_ARG) {</li><li>        remove_notAdded = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 通知引擎当前存在比较大的内存压力，能大概率触发JS引擎的GC流程。</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_MemoryPressureNotification</span>(env, JSVM_MEMORY_PRESSURE_LEVEL_CRITICAL));</li><li>    <span class="hljs-keyword">if</span> ((before_flag1) &amp;&amp;</li><li>        (before_flag2) &amp;&amp;</li><li>        (after_flag1) &amp;&amp;</li><li>        (!after_flag2) &amp;&amp;</li><li>        (remove_repeated) &amp;&amp;</li><li>        (remove_notAdded) &amp;&amp;</li><li>        (add_repeated)) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger GC: success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger GC: failed"</span>);</li><li>    }</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = TriggerGC},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"triggerGC"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例测试JS</strong></p> <div _ngcontent-qno-c106="" class="highlight-div"><div _ngcontent-qno-c106="" class="highlight-div-header"><div _ngcontent-qno-c106="" class="highlight-div-header-left"><div _ngcontent-qno-c106="" class="handle-button expand-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qno-c106="" class="highlight-div-header-right"><div _ngcontent-qno-c106="" class="handle-button ai-button"></div><div _ngcontent-qno-c106="" class="handle-button line-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qno-c106="" class="handle-button theme-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qno-c106="" class="handle-button copy-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qno-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(triggerGC();)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出下面结果：</p> <div _ngcontent-qno-c106="" class="highlight-div"><div _ngcontent-qno-c106="" class="highlight-div-header"><div _ngcontent-qno-c106="" class="highlight-div-header-left"><div _ngcontent-qno-c106="" class="handle-button expand-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qno-c106="" class="highlight-div-header-right"><div _ngcontent-qno-c106="" class="handle-button ai-button"></div><div _ngcontent-qno-c106="" class="handle-button line-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qno-c106="" class="handle-button theme-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qno-c106="" class="handle-button copy-button"><div _ngcontent-qno-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qno-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>== before GC ==</li><li>gc type: <span class="hljs-number">4</span></li><li>gc flag: <span class="hljs-number">4</span></li><li>== before GC2 ==</li><li>gc type: <span class="hljs-number">4</span></li><li>gc flag: <span class="hljs-number">4</span></li><li>data: <span class="hljs-number">2024</span></li><li>JSVM Trigger GC: success</li></ol></pre></div></div> </div> </div> <div></div></div>