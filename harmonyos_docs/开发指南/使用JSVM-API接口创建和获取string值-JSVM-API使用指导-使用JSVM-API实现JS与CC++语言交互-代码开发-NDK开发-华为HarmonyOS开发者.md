<h1 _ngcontent-nej-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口创建和获取string值"> 使用JSVM-API接口创建和获取string值 </h1>

<div _ngcontent-nej-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用JSVM-API的六个字符串接口，可以实现JSVM模块与JavaScript字符串的交互功能。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>string是编程中常用的数据类型。用于存储和操作文本数据，它可用于构建用户界面元素，如标签、按钮和文本框，处理用户输入，验证和格式化数据。不同的编码方案支持不同的字符集和语言，以下是一些主要的编码方案及其区别：</p> <ul><li><strong>ASCII</strong>：ASCII是最早的字符编码方案之一，使用7位编码，只能表示英文字母、数字和一些基本符号。它是许多其他编码方案的基础。</li><li><strong>UTF-8</strong>：UTF-8是一种变长编码方案，可以表示全球范围的字符集。它使用8位编码，根据字符的不同范围使用不同长度的字节序列。UTF-8是互联网上广泛使用的编码方案。</li><li><strong>UTF-16</strong>：UTF-16是一种定长或变长编码方案，使用16位编码。它可以表示全球范围的字符集，并且适用于较大的字符集。</li><li><strong>ISO-8859-1（Latin-1）</strong>：ISO-8859-1是一种单字节编码方案，使用8位编码。它主要用于表示拉丁字母字符集，包括欧洲大部分语言。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringUtf8</td> <td class="cellrowborder" valign="top" width="50%">获取给定JavaScript string对象的Utf8编码字符串。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringUtf8</td> <td class="cellrowborder" valign="top" width="50%">根据Utf8编码的字符串创建一个JavaScript string对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringUtf16</td> <td class="cellrowborder" valign="top" width="50%">获取给定JavaScript string对象的Utf16编码字符串。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringUtf16</td> <td class="cellrowborder" valign="top" width="50%">根据Utf16编码的字符串数据创建JavaScript string对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueStringLatin1</td> <td class="cellrowborder" valign="top" width="50%">获取给定JavaScript string对象的Latin-1编码字符串。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateStringLatin1</td> <td class="cellrowborder" valign="top" width="50%">根据Latin-1编码的字符串创建一个JavaScript string对象。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>。本文仅展示接口对应的C++相关代码。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getvaluestringutf8" class="firsth2">OH_JSVM_GetValueStringUtf8<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getvaluestringutf8" tips="复制节点链接"></i></h3><p>OH_JSVM_GetValueStringUtf8接口可以将JavaScript的字符类型的数据转换为utf8编码的字符。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_GetValueStringUtf8的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetValueStringUtf8</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;length);</li><li>    <span class="hljs-type">char</span> *buf = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(length + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">if</span> (buf == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"malloc failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, length + <span class="hljs-number">1</span>);</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], buf, length + <span class="hljs-number">1</span>, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringUtf8 fail"</span>);</li><li>        <span class="hljs-built_in">free</span>(buf);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringUtf8 success: %{public}s"</span>, buf);</li><li>    }</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, buf, length, &amp;result);</li><li>    <span class="hljs-built_in">free</span>(buf);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// GetValueStringUtf8注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetValueStringUtf8},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetValueStringUtf8方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getValueStringUtf8"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let data = "aaBC+-$%^你好123";</span></li><li><span class="hljs-string">    let script = getValueStringUtf8(data);</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM GetValueStringUtf8 success: aaBC+-$%^你好<span class="hljs-number">123</span></li></ol></pre></div></div> <p><strong>注意事项</strong>：getValueStringUtf8(arg)入参arg非字符串型数据时接口会调用失败。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createstringutf8">OH_JSVM_CreateStringUtf8<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createstringutf8" tips="复制节点链接"></i></h3><p>用于创建一个UTF-8编码的JavaScript字符串。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreateStringUtf8的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateStringUtf8</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *str = <span class="hljs-string">u8"你好, World!, succeed in creating UTF-8 string!"</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-built_in">strlen</span>(str);</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, str, length, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Failed to create UTF-8 string"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateStringUtf8 success: %{public}s"</span>, str);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// CreateStringUtf8注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateStringUtf8},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateStringUtf8方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createStringUtf8"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let script = createStringUtf8();</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM CreateStringUtf8 success: 你好, World!, succeed in creating UTF<span class="hljs-number">-8</span> string!</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getvaluestringutf16">OH_JSVM_GetValueStringUtf16<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getvaluestringutf16" tips="复制节点链接"></i></h3><p>OH_JSVM_GetValueStringUtf16，将JavaScript的字符类型的数据转换为utf16编码的字符。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;codecvt&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;locale&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// OH_JSVM_GetValueStringUtf16的样例方法</span></li><li><span class="hljs-comment">// 定义字符串缓冲区的最大长度</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> MAX_BUFFER_SIZE = <span class="hljs-number">128</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetValueStringUtf16</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">char16_t</span> buffer[MAX_BUFFER_SIZE] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-comment">// 字符串的缓冲区大小</span></li><li>    <span class="hljs-type">size_t</span> bufferSize = MAX_BUFFER_SIZE;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_GetValueStringUtf16</span>(env, args[<span class="hljs-number">0</span>], buffer, bufferSize, &amp;length);</li><li>    <span class="hljs-comment">// 将 char16_t 转换为 std::u16string</span></li><li>    std::u16string u16str = {buffer};</li><li>    <span class="hljs-comment">// 将 std::u16string 转换为 std::string</span></li><li>    std::wstring_convert&lt;std::codecvt_utf8_utf16&lt;<span class="hljs-type">char16_t</span>&gt;, <span class="hljs-type">char16_t</span>&gt; converter;</li><li>    std::string str = converter.<span class="hljs-built_in">to_bytes</span>(u16str);</li><li>    <span class="hljs-comment">// 获取字符串返回结果</span></li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringUtf16 fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringUtf16 success: %{public}s"</span>, str.<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// GetValueStringUtf16注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetValueStringUtf16},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetValueStringUtf16方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getValueStringUtf16"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let data = "ahello。";</span></li><li><span class="hljs-string">    let script = getValueStringUtf16(data);</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM GetValueStringUtf16 success: ahello。</li></ol></pre></div></div> <p><strong>注意事项</strong>：getValueStringUtf16(arg)的参数arg必须是字符串，否则接口会调用失败。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createstringutf16">OH_JSVM_CreateStringUtf16<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createstringutf16" tips="复制节点链接"></i></h3><p>用于创建一个UTF-16编码的JavaScript字符串。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;codecvt&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;locale&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// OH_JSVM_CreateStringUtf16的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateStringUtf16</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char16_t</span> *str = <span class="hljs-string">u"你好, World!, succeed in creating UTF-16 string!"</span>;</li><li>    <span class="hljs-function">std::u16string <span class="hljs-title">ustr</span><span class="hljs-params">(str)</span></span>;</li><li>    <span class="hljs-type">size_t</span> length = ustr.<span class="hljs-built_in">length</span>();</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateStringUtf16</span>(env, str, length, &amp;result);</li><li>    std::u16string u16str = {str};</li><li>    <span class="hljs-comment">// 将 std::u16string 转换为 std::string</span></li><li>    std::wstring_convert&lt;std::codecvt_utf8_utf16&lt;<span class="hljs-type">char16_t</span>&gt;, <span class="hljs-type">char16_t</span>&gt; converter;</li><li>    std::string strResult = converter.<span class="hljs-built_in">to_bytes</span>(u16str);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CreateStringUtf16 fail"</span>);</li><li>    }<span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateStringUtf16 success: %{public}s"</span>, strResult.<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// CreateStringUtf16注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateStringUtf16},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateStringUtf16方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createStringUtf16"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let script = createStringUtf16();</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM CreateStringUtf16 success: 你好, World!, succeed in creating UTF<span class="hljs-number">-16</span> string!</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getvaluestringlatin1">OH_JSVM_GetValueStringLatin1<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getvaluestringlatin1" tips="复制节点链接"></i></h3><p>OH_JSVM_GetValueStringLatin1接口可以将JavaScript的字符类型的数据转换为ISO-8859-1编码的字符。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_GetValueStringLatin1的样例方法</span></li><li><span class="hljs-comment">// 定义字符串缓冲区的最大长度</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> MAX_BUFFER_SIZE = <span class="hljs-number">128</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetValueStringLatin1</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">char</span> buf[MAX_BUFFER_SIZE];</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    JSVM_Value jsvmRes = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_GetValueStringLatin1</span>(env, args[<span class="hljs-number">0</span>], buf, MAX_BUFFER_SIZE, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringLatin1 fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueStringLatin1 success: %{public}s"</span>, buf);</li><li>    }</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringLatin1</span>(env, buf, length, &amp;jsvmRes);</li><li>    <span class="hljs-keyword">return</span> jsvmRes;</li><li>}</li><li><span class="hljs-comment">// GetValueStringLatin1注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetValueStringLatin1},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetValueStringLatin1方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getValueStringLatin1"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let data = "中文";</span></li><li><span class="hljs-string">    let script = getValueStringLatin1(data);</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果（ISO-8859-1编码不支持中文，传入中文字符会导致乱码）：</p> <p><span><img originheight="24" originwidth="322" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114340.48729501957519357396580621553421:50001231000000:2800:94E3C4A284D422939A8A2CF398DC04EC9A4C6F402DDCDD68BBBE56D1D329EFDC.png" width="322" height="24"></span></p> <p><strong>注意事项</strong>：getValueStringLatin1(arg)入参arg必须为字符串类型，否则接口调用会失败。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createstringlatin1">OH_JSVM_CreateStringLatin1<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createstringlatin1" tips="复制节点链接"></i></h3><p>用于创建一个Latin1编码的JavaScript字符串。</p> <p>cpp部分代码：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-comment">// CreateStringLatin1注册回调</span></li><li><span class="hljs-comment">// 定义字符串缓冲区的最大长度</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> MAX_BUFFER_SIZE = <span class="hljs-number">128</span>;</li><li><span class="hljs-comment">// OH_JSVM_CreateStringLatin1的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateStringLatin1</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *str = <span class="hljs-string">"Hello, World! éçñ, succeed in creating Latin1 string!"</span>;</li><li>    <span class="hljs-type">size_t</span> length = JSVM_AUTO_LENGTH;</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateStringLatin1</span>(env, str, length, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CreateStringLatin1 fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-type">char</span> buf[MAX_BUFFER_SIZE];</li><li>        <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetValueStringLatin1</span>(env, result, buf, MAX_BUFFER_SIZE, &amp;length);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateStringLatin1 success: %{public}s"</span>, buf);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateStringLatin1},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateStringLatin1方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createStringLatin1"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    let script = createStringLatin1();</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-nej-c106="" class="highlight-div"><div _ngcontent-nej-c106="" class="highlight-div-header"><div _ngcontent-nej-c106="" class="highlight-div-header-left"><div _ngcontent-nej-c106="" class="handle-button expand-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nej-c106="" class="highlight-div-header-right"><div _ngcontent-nej-c106="" class="handle-button ai-button"></div><div _ngcontent-nej-c106="" class="handle-button line-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nej-c106="" class="handle-button theme-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nej-c106="" class="handle-button copy-button"><div _ngcontent-nej-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nej-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM CreateStringLatin1 success: Hello, World! éçñ, succeed in creating Latin1 string!</li></ol></pre></div></div> </div> </div> <div></div></div>