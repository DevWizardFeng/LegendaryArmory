<h1 _ngcontent-huq-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口创建多个引擎执行JS代码并销毁"> 使用JSVM-API接口创建多个引擎执行JS代码并销毁 </h1>

<div _ngcontent-huq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>开发者通过createJsCore方法来创建一个新的JS运行时环境，并通过该方法获得一个CoreID。然后，通过evaluateJS方法使用CoreID对应的运行环境来运行JS代码，在JS代码中创建promise并异步执行函数。最后，使用releaseJsCore方法来销毁CoreID对应的运行环境。</p> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> <p>创建多个JS运行时环境并运行JS代码</p> <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;map&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;deque&gt;</span></span></li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li><li><span class="hljs-comment">// 定义map管理每个独立vm环境</span></li><li><span class="hljs-type">static</span> map&lt;<span class="hljs-type">int</span>, JSVM_VM *&gt; g_vmMap;</li><li><span class="hljs-type">static</span> map&lt;<span class="hljs-type">int</span>, JSVM_Env *&gt; g_envMap;</li><li><span class="hljs-type">static</span> map&lt;<span class="hljs-type">int</span>, JSVM_CallbackStruct *&gt; g_callBackStructMap;</li><li><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> ENVTAG_NUMBER = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">static</span> std::mutex envMapLock;</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> g_aa = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_COND(cond)                                                                                               \</span></li><li><span class="hljs-meta">    do {                                                                                                               \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!(cond)) {                                                                                                 \</span></li><li><span class="hljs-meta">            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = false"</span>, __FILE__, __LINE__);      \</span></li><li><span class="hljs-meta">            return -1;                                                                                                 \</span></li><li><span class="hljs-meta">        }                                                                                                              \</span></li><li><span class="hljs-meta">    } while (0)</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Task</span>() = <span class="hljs-keyword">default</span>;</li><li>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Run</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;</li><li>};</li><li><span class="hljs-type">static</span> map&lt;<span class="hljs-type">int</span>, deque&lt;Task *&gt;&gt; g_taskQueueMap;</li><li>
</li><li><span class="hljs-comment">// 自定义ConsoleInfo方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ConsoleInfo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">char</span> log[<span class="hljs-number">256</span>] = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-type">size_t</span> log_length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>
</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], log, <span class="hljs-number">255</span>, &amp;log_length));</li><li>    log[<span class="hljs-number">255</span>] = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: %{public}s"</span>, log);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义创建Promise方法用以在JS代码中创建Promise</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreatePromise</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: CreatePromise start"</span>);</li><li>    <span class="hljs-type">int</span> envID = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-comment">// 通过当前env获取envID</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = g_envMap.<span class="hljs-built_in">begin</span>(); it != g_envMap.<span class="hljs-built_in">end</span>(); ++it) {</li><li>        <span class="hljs-keyword">if</span> (*it-&gt;second == env) {</li><li>            envID = it-&gt;first;</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (envID == <span class="hljs-number">-1</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: CreatePromise envID failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    JSVM_Value promise;</li><li>    JSVM_Deferred deferred;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreatePromise</span>(env, &amp;deferred, &amp;promise));</li><li>    <span class="hljs-comment">// 设计ReadTask类用以将promise对象的deferred加入执行队列</span></li><li>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadTask</span> : <span class="hljs-keyword">public</span> Task {</li><li>    <span class="hljs-keyword">public</span>:</li><li>        <span class="hljs-built_in">ReadTask</span>(JSVM_Env env, JSVM_Deferred deferred, <span class="hljs-type">int</span> envNum) : <span class="hljs-built_in">env_</span>(env), <span class="hljs-built_in">envID_</span>(envNum), <span class="hljs-built_in">deferred_</span>(deferred) {}</li><li>        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Run</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{</li><li>            <span class="hljs-comment">// string str = "TEST RUN OH_JSVM_ResolveDeferred";</span></li><li>            <span class="hljs-type">int</span> envID = <span class="hljs-number">0</span>;</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = g_envMap.<span class="hljs-built_in">begin</span>(); it != g_envMap.<span class="hljs-built_in">end</span>(); ++it) {</li><li>                <span class="hljs-keyword">if</span> (*it-&gt;second == env_) {</li><li>                    envID = it-&gt;first;</li><li>                    <span class="hljs-keyword">break</span>;</li><li>                }</li><li>            }</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: CreatePromise %{public}d"</span>, envID);</li><li>            JSVM_Value result;</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env_, envID, &amp;result) != JSVM_OK) {</li><li>                <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_JSVM_ResolveDeferred</span>(env_, deferred_, result) != JSVM_OK) {</li><li>                <span class="hljs-keyword">return</span>;</li><li>            }</li><li>        }</li><li>
</li><li>    <span class="hljs-keyword">private</span>:</li><li>        JSVM_Env env_;</li><li>        <span class="hljs-type">int</span> envID_;</li><li>        JSVM_Deferred deferred_;</li><li>    };</li><li>    g_taskQueueMap[envID].<span class="hljs-built_in">push_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ReadTask</span>(env, deferred, envID));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: CreatePromise end"</span>);</li><li>    <span class="hljs-keyword">return</span> promise;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义Add方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">Add</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>    <span class="hljs-type">double</span> num1 = <span class="hljs-number">0</span>, num2 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">0</span>], &amp;num1));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">1</span>], &amp;num2));</li><li>    JSVM_Value sum = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateDouble</span>(env, num1 + num2, &amp;sum));</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义AssertEqual方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">AssertEqual</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>
</li><li>    <span class="hljs-type">bool</span> isStrictEquals = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_StrictEquals</span>(env, args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>], &amp;isStrictEquals));</li><li>
</li><li>    <span class="hljs-keyword">if</span> (isStrictEquals) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST RESULT: PASS"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST RESULT: FAILED"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">fromOHStringValue</span><span class="hljs-params">(JSVM_Env &amp;env, JSVM_Value &amp;value, std::string &amp;result)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, value, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;size));</li><li>    <span class="hljs-type">char</span> *resultStr = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[size + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, value, resultStr, size + <span class="hljs-number">1</span>, &amp;size));</li><li>    result = resultStr;</li><li>    <span class="hljs-keyword">delete</span>[] resultStr;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 提供创建JSVM运行环境的对外接口并返回对应唯一ID</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">CreateJsCore</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *result)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateJsCore START"</span>);</li><li>    g_taskQueueMap[ENVTAG_NUMBER] = deque&lt;Task *&gt;{};</li><li>
</li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        JSVM_InitOptions init_options;</li><li>        <span class="hljs-built_in">memset</span>(&amp;init_options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(init_options));</li><li>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_Init</span>(&amp;init_options));</li><li>        g_aa++;</li><li>    }</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock_guard</span><span class="hljs-params">(envMapLock)</span></span>;</li><li>
</li><li>    <span class="hljs-comment">// 虚拟机实例</span></li><li>    g_vmMap[ENVTAG_NUMBER] = <span class="hljs-keyword">new</span> JSVM_VM;</li><li>    JSVM_CreateVMOptions options;</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, g_vmMap[ENVTAG_NUMBER]));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(*g_vmMap[ENVTAG_NUMBER], &amp;vmScope));</li><li>
</li><li>    <span class="hljs-comment">// 新环境</span></li><li>    g_envMap[ENVTAG_NUMBER] = <span class="hljs-keyword">new</span> JSVM_Env;</li><li>    g_callBackStructMap[ENVTAG_NUMBER] = <span class="hljs-keyword">new</span> JSVM_CallbackStruct[<span class="hljs-number">4</span>];</li><li>
</li><li>    <span class="hljs-comment">// 注册用户提供的本地函数的回调函数指针和数据，通过JSVM-API暴露给js</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {</li><li>        g_callBackStructMap[ENVTAG_NUMBER][i].data = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">0</span>].callback = ConsoleInfo;</li><li>    g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">1</span>].callback = Add;</li><li>    g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">2</span>].callback = AssertEqual;</li><li>    g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">3</span>].callback = CreatePromise;</li><li>    JSVM_PropertyDescriptor descriptors[] = {</li><li>        {<span class="hljs-string">"consoleinfo"</span>, <span class="hljs-literal">NULL</span>, &amp;g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>        {<span class="hljs-string">"add"</span>, <span class="hljs-literal">NULL</span>, &amp;g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>        {<span class="hljs-string">"assertEqual"</span>, <span class="hljs-literal">NULL</span>, &amp;g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>        {<span class="hljs-string">"createPromise"</span>, <span class="hljs-literal">NULL</span>, &amp;g_callBackStructMap[ENVTAG_NUMBER][<span class="hljs-number">3</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>    };</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(*g_vmMap[ENVTAG_NUMBER], <span class="hljs-built_in">sizeof</span>(descriptors) / <span class="hljs-built_in">sizeof</span>(descriptors[<span class="hljs-number">0</span>]), descriptors,</li><li>                            g_envMap[ENVTAG_NUMBER]));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(*g_vmMap[ENVTAG_NUMBER], vmScope));</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateJsCore END"</span>);</li><li>    *result = ENVTAG_NUMBER;</li><li>    ENVTAG_NUMBER++;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 对外提供释放JSVM环境接口，通过envId释放对应环境</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">ReleaseJsCore</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> coreEnvId)</span> </span>{</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock_guard</span><span class="hljs-params">(envMapLock)</span></span>;</li><li>    </li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM ReleaseJsCore START"</span>);</li><li>    <span class="hljs-built_in">CHECK_COND</span>(g_envMap.<span class="hljs-built_in">count</span>(coreEnvId) != <span class="hljs-number">0</span> &amp;&amp; g_envMap[coreEnvId] != <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(*g_envMap[coreEnvId]));</li><li>    g_envMap[coreEnvId] = <span class="hljs-literal">nullptr</span>;</li><li>    g_envMap.<span class="hljs-built_in">erase</span>(coreEnvId);</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(*g_vmMap[coreEnvId]));</li><li>    g_vmMap[coreEnvId] = <span class="hljs-literal">nullptr</span>;</li><li>    g_vmMap.<span class="hljs-built_in">erase</span>(coreEnvId);</li><li>    <span class="hljs-keyword">delete</span>[] g_callBackStructMap[coreEnvId];</li><li>    g_callBackStructMap[coreEnvId] = <span class="hljs-literal">nullptr</span>;</li><li>    g_callBackStructMap.<span class="hljs-built_in">erase</span>(coreEnvId);</li><li>    g_taskQueueMap.<span class="hljs-built_in">erase</span>(coreEnvId);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM ReleaseJsCore END"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> std::mutex mutexLock;</li><li><span class="hljs-comment">// 对外提供执行JS代码接口，通过coreID在对应的JSVN环境中执行JS代码</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">EvaluateJS</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> envId, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *source, std::string &amp;res)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM EvaluateJS START"</span>);</li><li>
</li><li>    <span class="hljs-built_in">CHECK_COND</span>(g_envMap.<span class="hljs-built_in">count</span>(envId) != <span class="hljs-number">0</span> &amp;&amp; g_envMap[envId] != <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    JSVM_Env env = *g_envMap[envId];</li><li>    JSVM_VM vm = *g_vmMap[envId];</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>    JSVM_Value result;</li><li>
</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock_guard</span><span class="hljs-params">(mutexLock)</span></span>;</li><li>    {</li><li>        <span class="hljs-comment">// 创建JSVM环境</span></li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(*g_envMap[envId], &amp;envScope));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(*g_envMap[envId], &amp;handleScope));</li><li>
</li><li>        <span class="hljs-comment">// 通过script调用测试函数</span></li><li>        JSVM_Script script;</li><li>        JSVM_Value jsSrc;</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, source, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>        JSVM_ValueType type;</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_Typeof</span>(env, result, &amp;type));</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST type: %{public}d"</span>, type);</li><li>        <span class="hljs-comment">// Execute tasks in the current env event queue</span></li><li>        <span class="hljs-keyword">while</span> (!g_taskQueueMap[envId].<span class="hljs-built_in">empty</span>()) {</li><li>            <span class="hljs-keyword">auto</span> task = g_taskQueueMap[envId].<span class="hljs-built_in">front</span>();</li><li>            g_taskQueueMap[envId].<span class="hljs-built_in">pop_front</span>();</li><li>            task-&gt;<span class="hljs-built_in">Run</span>();</li><li>            <span class="hljs-keyword">delete</span> task;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">if</span> (type == JSVM_STRING) {</li><li>            <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">fromOHStringValue</span>(env, result, res) != <span class="hljs-number">-1</span>);</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == JSVM_BOOLEAN) {</li><li>            <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;</li><li>            <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, result, &amp;ret));</li><li>            ret ? res = <span class="hljs-string">"true"</span> : res = <span class="hljs-string">"false"</span>;</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == JSVM_NUMBER) {</li><li>            <span class="hljs-type">int32_t</span> num = <span class="hljs-number">0</span>;</li><li>            <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, result, &amp;num));</li><li>            res = std::<span class="hljs-built_in">to_string</span>(num);</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == JSVM_OBJECT) {</li><li>            JSVM_Value objResult;</li><li>            <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_JsonStringify</span>(env, result, &amp;objResult));</li><li>            <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">fromOHStringValue</span>(env, objResult, res) != <span class="hljs-number">-1</span>);</li><li>        }</li><li>    }</li><li>    {</li><li>        <span class="hljs-type">bool</span> aal = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PumpMessageLoop</span>(*g_vmMap[envId], &amp;aal));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PerformMicrotaskCheckpoint</span>(*g_vmMap[envId]));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(*g_envMap[envId], handleScope));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(*g_envMap[envId], envScope));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(*g_vmMap[envId], vmScope));</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM EvaluateJS END"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> source1[] = <span class="hljs-string">"{\</span></li><li><span class="hljs-string">        let a = \"hello World\";\</span></li><li><span class="hljs-string">        consoleinfo(a);\</span></li><li><span class="hljs-string">        const mPromise = createPromise();\</span></li><li><span class="hljs-string">        mPromise.then((result) =&gt; {\</span></li><li><span class="hljs-string">          assertEqual(result, 0);\</span></li><li><span class="hljs-string">        });\</span></li><li><span class="hljs-string">        a;\</span></li><li><span class="hljs-string">    };"</span>;</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> source2[] = <span class="hljs-string">"{\</span></li><li><span class="hljs-string">        let a = \"second hello\";\</span></li><li><span class="hljs-string">        consoleinfo(a);\</span></li><li><span class="hljs-string">        let b = add(99, 1);\</span></li><li><span class="hljs-string">        assertEqual(100, b);\</span></li><li><span class="hljs-string">        assertEqual(add(99, 1), 100);\</span></li><li><span class="hljs-string">        createPromise().then((result) =&gt; {\</span></li><li><span class="hljs-string">            assertEqual(result, 1);\</span></li><li><span class="hljs-string">        });\</span></li><li><span class="hljs-string">        a;\</span></li><li><span class="hljs-string">    };"</span>;</li><li>
</li><li>    <span class="hljs-comment">// 创建首个运行环境，并绑定TS回调</span></li><li>    <span class="hljs-type">uint32_t</span> coreId1 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">CreateJsCore</span>(&amp;coreId1) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"TEST coreId: %{public}d"</span>, coreId1);</li><li>    <span class="hljs-comment">// 在首个运行环境中执行JS代码</span></li><li>    std::string result1;</li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">EvaluateJS</span>(coreId1, source1, result1) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"TEST evaluateJS: %{public}s"</span>, result1.<span class="hljs-built_in">c_str</span>());</li><li>
</li><li>    <span class="hljs-comment">// 创建第二个运行环境，并绑定TS回调</span></li><li>    <span class="hljs-type">uint32_t</span> coreId2 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">CreateJsCore</span>(&amp;coreId2) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"TEST coreId: %{public}d"</span>, coreId2);</li><li>    <span class="hljs-comment">// 在第二个运行环境中执行JS代码</span></li><li>    std::string result2;</li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">EvaluateJS</span>(coreId2, source2, result2) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"TEST evaluateJS: %{public}s"</span>, result2.<span class="hljs-built_in">c_str</span>());</li><li>
</li><li>    <span class="hljs-comment">// 释放首个运行环境</span></li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">ReleaseJsCore</span>(coreId1) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// 释放第二个运行环境</span></li><li>    <span class="hljs-built_in">CHECK_COND</span>(<span class="hljs-built_in">ReleaseJsCore</span>(coreId2) == <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Test NAPI end"</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>预计的输出结果：</p> <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM CreateJsCore START</li><li>JSVM CreateJsCore END</li><li>TEST coreId: <span class="hljs-number">0</span></li><li>JSVM EvaluateJS START</li><li>JSVM API TEST: hello World</li><li>JSVM API TEST: CreatePromise start</li><li>JSVM API TEST: CreatePromise end</li><li>JSVM API TEST type: <span class="hljs-number">4</span></li><li>JSVM API TEST: CreatePromise <span class="hljs-number">0</span></li><li>JSVM API TEST RESULT: PASS</li><li>JSVM EvaluateJS END</li><li>TEST evaluateJS: hello World</li><li>JSVM CreateJsCore START</li><li>JSVM CreateJsCore END</li><li>TEST coreId: <span class="hljs-number">1</span></li><li>JSVM EvaluateJS START</li><li>JSVM API TEST: second hello</li><li>JSVM API TEST RESULT: PASS</li><li>JSVM API TEST RESULT: PASS</li><li>JSVM API TEST: CreatePromise start</li><li>JSVM API TEST: CreatePromise end</li><li>JSVM API TEST type: <span class="hljs-number">4</span></li><li>JSVM API TEST: CreatePromise <span class="hljs-number">1</span></li><li>JSVM API TEST RESULT: PASS</li><li>JSVM EvaluateJS END</li><li>TEST evaluateJS: second hello</li><li>JSVM ReleaseJsCore START</li><li>JSVM ReleaseJsCore END</li><li>JSVM ReleaseJsCore START</li><li>JSVM ReleaseJsCore END</li><li>Test NAPI end</li></ol></pre></div></div> </div> </div> <div></div></div>