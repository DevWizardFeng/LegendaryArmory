<h1 _ngcontent-tjj-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口处理异步操作"> 使用JSVM-API接口处理异步操作 </h1>

<div _ngcontent-tjj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用JSVM-API接口处理异步操作。异步操作是指需要一定时间才能完成的操作，例如从网络下载数据或读取大型文件。与同步操作不同，异步操作不会阻塞主线程，而是会在后台执行。当异步操作完成后，事件循环将把它放入任务队列中，等待主线程空闲时执行。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>Promise是JavaScript中用来处理异步操作的对象，Promise有pending（待定）、fulfilled（已兑现）和rejected（已拒绝）三种状态，Promise的初始状态是pending，resolve函数可以使其状态从pending变为fulfilled（已兑现），reject函数可以使其状态从pending变为rejected(已拒绝)，一旦兑现或拒绝Promise的状态将不能更改。下面是一些基本概念：</p> <ul><li><strong>同步</strong>： 同步是指代码按照顺序一行一行地执行，每行代码的执行都会等待上一行代码执行完成后再继续执行。在同步执行中，如果某个操作需要花费较长时间，那么整个程序的执行就会被阻塞，直到该操作完成才能继续执行后续代码。</li><li><strong>异步</strong>：异步是指任务可以同时执行，不需要等待上一个任务结束。在JavaScript中，常见的异步操作包括定时器、事件监听、网络请求等。异步任务不会阻塞后续任务的执行，而是通过回调函数或Promise对象来处理任务的结果。</li><li><strong>Promise</strong>：Promise是一个JavaScript对象，用于处理异步操作。Promise作用于外部，通常通过then、catch和finally方法暴露给外部以添加自定义逻辑。</li><li><strong>deferred</strong>：deferred是延迟对象，它可以与Promise对象关联，设置Promise的回调函数resolve和reject。deferred作用于内部，维护异步模型的状态并设置回调函数resolve和reject。</li><li><strong>resolve</strong>：此函数可以将Promise的状态从pending（待定）改为fulfilled（已兑现），向resolve中传入的参数可以在Promise对象的then方法中获取。</li><li><strong>reject</strong>：此函数可以将Promise的状态从pending（待定）改为rejected（已拒绝），向reject中传入的参数可以在Promise对象的catch方法中获取。</li></ul> <p>这些基本概念在处理异步操作中非常重要，开发者需要通过适当的方法来处理异步操作，Promise可以链式调用多个异步操作，使代码清晰整洁，便于维护。JSVM-API提供的方法可以帮助开发者在JSVM模块中处理JavaScript中的异步操作。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsPromise</td> <td class="cellrowborder" valign="top" width="50%">查询Promise是否为Promise对象</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreatePromise</td> <td class="cellrowborder" valign="top" width="50%">创建一个延迟对象和一个JavaScript promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ResolveDeferred</td> <td class="cellrowborder" valign="top" width="50%">通过与之关联的延迟对象来解析JavaScript promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RejectDeferred</td> <td class="cellrowborder" valign="top" width="50%">通过与之关联的延迟对象来拒绝JavaScript promise</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_PromiseRegisterHandler</td> <td class="cellrowborder" valign="top" width="50%">为 Promise 创建兑现或拒绝后的回调</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_ispromise" class="firsth2">OH_JSVM_IsPromise<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_ispromise" tips="复制节点链接"></i></h3><p>判断给定的JSVM_Value是否表示一个Promise对象。</p> <p>cpp部分代码</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_IsPromise的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IsPromise</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> isPromise = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsPromise</span>(env, args[<span class="hljs-number">0</span>], &amp;isPromise);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsPromise fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsPromise success:%{public}d"</span>, isPromise);</li><li>    }</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, isPromise, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// IsPromise注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = IsPromise},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// IsPromise方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"isPromise"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(isPromise())JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>JSVM OH_JSVM_IsPromise success:0</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createpromise">OH_JSVM_CreatePromise<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createpromise" tips="复制节点链接"></i></h3><p>OH_JSVM_CreatePromise用于创建一个Promise对象。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_resolvedeferred--oh_jsvm_rejectdeferred">OH_JSVM_ResolveDeferred &amp; OH_JSVM_RejectDeferred<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_resolvedeferred--oh_jsvm_rejectdeferred" tips="复制节点链接"></i></h3><p>用于对Promise关联的deferred对象进行解析，OH_JSVM_ResolveDeferred将其从挂起状态转换为已兑现状态，OH_JSVM_RejectDeferred将其从挂起状态转换为已拒绝状态。</p> <p>cpp部分代码</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreatePromise、OH_JSVM_ResolveDeferred、OH_JSVM_RejectDeferred的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreatePromise</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Deferred defer = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Value promise = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreatePromise</span>(env, &amp;defer, &amp;promise);</li><li>    <span class="hljs-type">bool</span> isPromise = <span class="hljs-literal">false</span>;</li><li>    JSVM_Value returnIsPromise = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_IsPromise</span>(env, promise, &amp;isPromise);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CreatePromise fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreatePromise success:%{public}d"</span>, isPromise);</li><li>    }</li><li>    <span class="hljs-comment">// 将布尔值转为可以返回的JSVM_Value</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, isPromise, &amp;returnIsPromise);</li><li>    <span class="hljs-keyword">return</span> returnIsPromise;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ResolveRejectDeferred</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获得并解析参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    JSVM_Value args[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 第一个参数为向resolve传入的信息，第二个参数为向reject传入的信息，第三个参数为Promise的状态</span></li><li>    <span class="hljs-type">bool</span> status = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, args[<span class="hljs-number">2</span>], &amp;status);</li><li>    <span class="hljs-comment">// 创建Promise对象</span></li><li>    JSVM_Deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Value promise = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status createStatus = <span class="hljs-built_in">OH_JSVM_CreatePromise</span>(env, &amp;deferred, &amp;promise);</li><li>    <span class="hljs-keyword">if</span> (createStatus != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_JSVM_ThrowError</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Create promise failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 根据第三个参数设置resolve或reject</span></li><li>    <span class="hljs-keyword">if</span> (status) {</li><li>        <span class="hljs-built_in">OH_JSVM_ResolveDeferred</span>(env, deferred, args[<span class="hljs-number">0</span>]);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OH_JSVM_ResolveDeferred resolve"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_JSVM_RejectDeferred</span>(env, deferred, args[<span class="hljs-number">1</span>]);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OH_JSVM_RejectDeferred reject"</span>);</li><li>    }</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// CreatePromise,ResolveRejectDeferred注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreatePromise},</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = ResolveRejectDeferred},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreatePromise,ResolveRejectDeferred方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createPromise"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"resolveRejectDeferred"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(createPromise();</span></li><li><span class="hljs-string">                                 resolveRejectDeferred('success', 'fail', true);</span></li><li><span class="hljs-string">                                 resolveRejectDeferred('success', 'fail', false);)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">CreatePromise</span> <span class="hljs-variable">success</span>:<span class="hljs-number">1</span></li><li><span class="hljs-variable">OH_JSVM_ResolveDeferred</span> <span class="hljs-variable">resolve</span></li><li><span class="hljs-variable">OH_JSVM_RejectDeferred</span> <span class="hljs-variable">reject</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="oh_jsvm_promiseregisterhandler">OH_JSVM_PromiseRegisterHandler<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_promiseregisterhandler" tips="复制节点链接"></i></h2><p>用于设置 Promise 解析或拒绝后的回调，等效于调用原生的 Promise.then() 或 Promise.catch()。</p> <p>以下仅对 cpp 部分代码进行展示，其余框架代码如 TestJSVM 函数参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-execute_tasks">使用JSVM-API接口进行任务队列相关开发</a> OH_JSVM_SetMicrotaskPolicy 段落中的实现。</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">PromiseRegisterHandler</span><span class="hljs-params">(JSVM_VM vm, JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *defineFunction = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">        var x1 = 0;</span></li><li><span class="hljs-string">        var x2 = 0;</span></li><li><span class="hljs-string">        function f1(x) {</span></li><li><span class="hljs-string">            x1 = x;</span></li><li><span class="hljs-string">            return x + 1;</span></li><li><span class="hljs-string">        }</span></li><li><span class="hljs-string">        function f2(x) {</span></li><li><span class="hljs-string">            x2 = x;</span></li><li><span class="hljs-string">            return x + 1;</span></li><li><span class="hljs-string">        }</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *init = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">        x1 = 0;</span></li><li><span class="hljs-string">        x2 = 0;</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>
</li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc;</li><li>    JSVM_Value result;</li><li>
</li><li>    <span class="hljs-comment">// 定义 JS 函数 f1 和 f2</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, defineFunction, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-comment">// 初始化 x1， x2 为 0</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, init, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-comment">// 获取函数 f1 和 f2</span></li><li>    JSVM_Value global;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;global));</li><li>    JSVM_Value f1;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"f1"</span>, &amp;f1));</li><li>    JSVM_Value f2;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"f2"</span>, &amp;f2));</li><li>
</li><li>    <span class="hljs-comment">// 创建 Promise</span></li><li>    JSVM_Value promise;</li><li>    JSVM_Deferred deferred;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreatePromise</span>(env, &amp;deferred, &amp;promise));</li><li>    <span class="hljs-comment">// 为 promise 注册回调函数，并将 then 调用的结果（新的 Promise）赋值给 promise1</span></li><li>    JSVM_Value promise1;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PromiseRegisterHandler</span>(env, promise, f1, <span class="hljs-literal">nullptr</span>, &amp;promise1));</li><li>    <span class="hljs-comment">// 为 promise1 注册回调函数</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PromiseRegisterHandler</span>(env, promise1, f2, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>
</li><li>    <span class="hljs-comment">// 获取 promise 解析前 x1 和 x2 的值</span></li><li>    JSVM_Value x1;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"x1"</span>, &amp;x1));</li><li>    <span class="hljs-type">int32_t</span> x1Int = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, x1, &amp;x1Int));</li><li>    JSVM_Value x2;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"x2"</span>, &amp;x2));</li><li>    <span class="hljs-type">int32_t</span> x2Int = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, x2, &amp;x2Int));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Before promise resolved, x1: %{public}d, x2: %{public}d"</span>, x1Int, x2Int);</li><li>
</li><li>    <span class="hljs-comment">// 解析 promise</span></li><li>    JSVM_Value resolveValue;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">2</span>, &amp;resolveValue));</li><li>    <span class="hljs-keyword">if</span> (deferred != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_ResolveDeferred</span>(env, deferred, resolveValue);</li><li>        deferred = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取 promise 解析后 x1 和 x2 的值</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"x1"</span>, &amp;x1));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, x1, &amp;x1Int));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"x2"</span>, &amp;x2));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, x2, &amp;x2Int));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"After promise resolved, x1: %{public}d, x2: %{public}d"</span>, x1Int, x2Int);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunDemo</span><span class="hljs-params">(JSVM_VM vm, JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">PromiseRegisterHandler</span>(vm, env) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Run PromiseRegisterHandler failed"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-tjj-c106="" class="highlight-div"><div _ngcontent-tjj-c106="" class="highlight-div-header"><div _ngcontent-tjj-c106="" class="highlight-div-header-left"><div _ngcontent-tjj-c106="" class="handle-button expand-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tjj-c106="" class="highlight-div-header-right"><div _ngcontent-tjj-c106="" class="handle-button ai-button"></div><div _ngcontent-tjj-c106="" class="handle-button line-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tjj-c106="" class="handle-button theme-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tjj-c106="" class="handle-button copy-button"><div _ngcontent-tjj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tjj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">Before</span> <span class="hljs-string">promise</span> <span class="hljs-string">resolved,</span> <span class="hljs-attr">x1:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">x2:</span> <span class="hljs-number">0</span></li><li><span class="hljs-string">After</span> <span class="hljs-string">promise</span> <span class="hljs-string">resolved,</span> <span class="hljs-attr">x1:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span> <span class="hljs-attr">x2:</span> <span class="hljs-number">3</span></li></ol></pre></div></div> </div> </div> <div></div></div>