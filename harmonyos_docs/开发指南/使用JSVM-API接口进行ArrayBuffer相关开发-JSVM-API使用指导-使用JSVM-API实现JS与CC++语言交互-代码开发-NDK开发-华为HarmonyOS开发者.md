<h1 _ngcontent-gee-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行ArrayBuffer相关开发"> 使用JSVM-API接口进行ArrayBuffer相关开发 </h1>

<div _ngcontent-gee-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>ArrayBuffer 是 JavaScript 中的一种数据类型，用于表示通用的、固定长度的原始二进制数据缓冲区。它提供了一种在 JavaScript 中有效地表示和操作原始二进制数据的方式。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><ul><li><strong>ArrayBuffer</strong>：ArrayBuffer 对象用来表示一个通用的、固定长度的原始二进制数据缓冲区。不能直接操作 ArrayBuffer 的内容，而是需要通过包装成 TypedArray 对象或 DataView 对象来读写。ArrayBuffer 常用于处理固定长度的原始二进制数据，如文件、网络数据包等。</li><li><strong>生命周期和内存管理</strong>：在使用 JSVM 处理 ArrayBuffer 时，需要特别注意对象的生命周期管理，确保及时释放内存。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetArraybufferInfo</td> <td class="cellrowborder" valign="top" width="50%">检索 ArrayBuffer 的底层数据缓冲区及其长度。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">判断一个 JavaScript 对象是否为 ArrayBuffer 类型对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DetachArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">调用 ArrayBuffer 对象的 Detach 操作。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsDetachedArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">检查给定的 ArrayBuffer 是否已被分离(Detached)。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateArraybuffer</td> <td class="cellrowborder" valign="top" width="50%">创建一个指定大小的 ArrayBuffer 对象。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API 接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应 C++ 相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getarraybufferinfo" class="firsth2">OH_JSVM_GetArraybufferInfo<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getarraybufferinfo" tips="复制节点链接"></i></h3><p>检索 ArrayBuffer 的底层数据缓冲区及其长度。</p> <p>cpp部分代码：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_GetArraybufferInfo的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetArraybufferInfo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// 解析传递的参数</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 检查参数是否为ArrayBuffer</span></li><li>    <span class="hljs-type">bool</span> isArrayBuffer = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_IsArraybuffer</span>(env, args[<span class="hljs-number">0</span>], &amp;isArrayBuffer);</li><li>    <span class="hljs-keyword">if</span> (!isArrayBuffer) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetArraybufferInfo isArrayBuffer:false"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">void</span> *data;</li><li>    <span class="hljs-type">size_t</span> byteLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 获取ArrayBuffer的底层数据缓冲区和长度</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_GetArraybufferInfo</span>(env, args[<span class="hljs-number">0</span>], &amp;data, &amp;byteLength);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetArraybufferInfo: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetArraybufferInfo: success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> args[<span class="hljs-number">0</span>];</li><li>}</li><li><span class="hljs-comment">// GetArraybufferInfo注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetArraybufferInfo},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetArraybufferInfo方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getArraybufferInfo"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">getArraybufferInfo(new ArrayBuffer(10));</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM GetArraybufferInfo:</span> <span class="hljs-string">success</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_isarraybuffer">OH_JSVM_IsArraybuffer<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_isarraybuffer" tips="复制节点链接"></i></h3><p>判断一个 JavaScript 对象是否为 ArrayBuffer 类型对象。</p> <p>cpp部分代码：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_IsArraybuffer的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IsArrayBuffer</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 调用OH_JSVM_IsArraybuffer接口判断给定入参是否为ArrayBuffer数据</span></li><li>    <span class="hljs-type">bool</span> isArrayBuffer = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsArraybuffer</span>(env, args[<span class="hljs-number">0</span>], &amp;isArrayBuffer);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM IsArrayBuffer: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM IsArrayBuffer: success"</span>);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM IsArrayBuffer: %{public}d"</span>, isArrayBuffer);</li><li>    }</li><li>    JSVM_Value boolean = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, isArrayBuffer, &amp;boolean);</li><li>    <span class="hljs-keyword">return</span> boolean;</li><li>}</li><li><span class="hljs-comment">// IsArrayBuffer注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = IsArrayBuffer},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// IsArrayBuffer方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"isArrayBuffer"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">isArrayBuffer(new ArrayBuffer(8));</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM IsArrayBuffer:</span> <span class="hljs-string">success</span></li><li><span class="hljs-attr">JSVM IsArrayBuffer:</span> <span class="hljs-number">1</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_detacharraybuffer">OH_JSVM_DetachArraybuffer<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_detacharraybuffer" tips="复制节点链接"></i></h3><p>调用 ArrayBuffer 对象的 Detach 操作。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_isdetachedarraybuffer">OH_JSVM_IsDetachedArraybuffer<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_isdetachedarraybuffer" tips="复制节点链接"></i></h3><p>检查给定的 ArrayBuffer 是否已被分离。</p> <p>cpp部分代码：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_DetachArraybuffer、OH_JSVM_IsDetachedArraybuffer的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">DetachArraybuffer</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    JSVM_Value arraybuffer = args[<span class="hljs-number">0</span>];</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_DetachArraybuffer</span>(env, arraybuffer);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM DetachArraybuffer: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM DetachArraybuffer: success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> arraybuffer;</li><li>}</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IsDetachedArraybuffer</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    JSVM_Value arraybuffer = args[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-built_in">OH_JSVM_DetachArraybuffer</span>(env, arraybuffer);</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsDetachedArraybuffer</span>(env, arraybuffer, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM IsDetachedArraybuffer: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM IsDetachedArraybuffer: success"</span>);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM IsArrayBuffer: %{public}d"</span>, result);</li><li>    }</li><li>    JSVM_Value isDetached = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, result, &amp;isDetached);</li><li>    <span class="hljs-keyword">return</span> isDetached;</li><li>}</li><li><span class="hljs-comment">// DetachArraybuffer、IsDetachedArraybuffer注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = DetachArraybuffer},</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = IsDetachedArraybuffer},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// DetachArraybuffer、IsDetachedArraybuffer方法别名，TS侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"detachArraybuffer"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"isDetachedArraybuffer"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">let arrayBuffer = new ArrayBuffer(10);</span></li><li><span class="hljs-string">detachArraybuffer(arrayBuffer);</span></li><li><span class="hljs-string">isDetachedArraybuffer(arrayBuffer);</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">DetachArraybuffer</span>: <span class="hljs-title class_">success</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">IsDetachedArraybuffer</span>: <span class="hljs-title class_">success</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">IsArrayBuffer</span>: <span class="hljs-number">1</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createarraybuffer">OH_JSVM_CreateArraybuffer<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createarraybuffer" tips="复制节点链接"></i></h3><p>创建一个指定大小的 ArrayBuffer 对象。</p> <p>cpp部分代码：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreateArraybuffer的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateArraybuffer</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 解析传递的参数</span></li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">int32_t</span> value = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, argv[<span class="hljs-number">0</span>], &amp;value));</li><li>    length = <span class="hljs-built_in">size_t</span>(value);</li><li>    <span class="hljs-type">void</span> *data;</li><li>    <span class="hljs-comment">// 创建一个新的ArrayBuffer</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateArraybuffer</span>(env, length, &amp;data, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CreateArraybuffer: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateArraybuffer: success"</span>);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM ArrayBuffer length: %{public}d"</span>, length);</li><li>    }</li><li>    <span class="hljs-comment">// 返回创建好的ArrayBuffer</span></li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// CreateArraybuffer注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateArraybuffer},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateArraybuffer方法别名，供TS侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createArraybuffer"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">createArraybuffer(8);</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-gee-c106="" class="highlight-div"><div _ngcontent-gee-c106="" class="highlight-div-header"><div _ngcontent-gee-c106="" class="highlight-div-header-left"><div _ngcontent-gee-c106="" class="handle-button expand-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gee-c106="" class="highlight-div-header-right"><div _ngcontent-gee-c106="" class="handle-button ai-button"></div><div _ngcontent-gee-c106="" class="handle-button line-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gee-c106="" class="handle-button theme-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gee-c106="" class="handle-button copy-button"><div _ngcontent-gee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gee-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM CreateArraybuffer:</span> <span class="hljs-string">success</span></li><li><span class="hljs-attr">JSVM ArrayBuffer length:</span> <span class="hljs-number">8</span></li></ol></pre></div></div> </div> </div> <div></div></div>