<h1 _ngcontent-rda-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行Trace相关开发"> 使用JSVM-API接口进行Trace相关开发 </h1>

<div _ngcontent-rda-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API中trace相关接口用于在运行时采集并输出各种类型运行时信息。该能力可用于在JSVM模块中定位问题与性能分析。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>JSVM-API中的Trace相关接口能够通过指定一系列分类，采集这些分类所属的JSVM内部事件信息，并以JSON格式通过用户指定的回调函数输出。</p> <p>在JSVM-API中，通过支持Trace相关能力，JSVM模块能够更紧密地与JavaScript环境集成，提高复杂问题定位和性能分析能力。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_TraceStart</td> <td class="cellrowborder" valign="top" width="50%">以指定事件类型与事件数量限制，开始采集运行时信息。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_TraceStop</td> <td class="cellrowborder" valign="top" width="50%">停止采集信息，并以JSON格式在用户指定的回调函数中进行输出。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="使用trace接口进行数据采集" class="firsth2">使用Trace接口进行数据采集<i class="anchor-icon anchor-icon-link" anchorid="使用trace接口进行数据采集" tips="复制节点链接"></i></h3><p>cpp 部分代码：</p> <div _ngcontent-rda-c106="" class="highlight-div"><div _ngcontent-rda-c106="" class="highlight-div-header"><div _ngcontent-rda-c106="" class="highlight-div-header-left"><div _ngcontent-rda-c106="" class="handle-button expand-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rda-c106="" class="highlight-div-header-right"><div _ngcontent-rda-c106="" class="handle-button ai-button"></div><div _ngcontent-rda-c106="" class="handle-button line-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rda-c106="" class="handle-button theme-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rda-c106="" class="handle-button copy-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rda-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OutputStream</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> size, <span class="hljs-type">void</span> *streamData)</span> </span>{</li><li>    <span class="hljs-function">std::string <span class="hljs-title">value</span><span class="hljs-params">(data, size)</span></span>;</li><li>    *(std::string *)streamData = std::<span class="hljs-built_in">string</span>(data, size);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// OH_JSVM_TraceStart/OH_JSVM_TraceStop样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">Trace</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// start trace with categories</span></li><li>    std::vector&lt;JSVM_TraceCategory&gt; categories = {JSVM_TRACE_VM};</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_TraceStart</span>(categories.<span class="hljs-built_in">size</span>(), categories.<span class="hljs-built_in">data</span>(), <span class="hljs-string">"trace test"</span>, <span class="hljs-number">0</span>));</li><li>
</li><li>    <span class="hljs-comment">// run and trace</span></li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* trace_js = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">      function map(x, y) {</span></li><li><span class="hljs-string">        return {"a": x, "b": y};</span></li><li><span class="hljs-string">      }</span></li><li><span class="hljs-string">      for (var i = 0; i &lt; 80000; ++i) {</span></li><li><span class="hljs-string">        var x = map(i, i);</span></li><li><span class="hljs-string">      }</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, trace_js, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>    </li><li>    <span class="hljs-comment">// stop trace and write file</span></li><li>    std::string data;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_TraceStop</span>(OutputStream, (<span class="hljs-type">void</span> *)&amp;data));</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Trace success:%{public}s"</span>, data.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-comment">// Trace注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = Trace},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// Trace方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"trace"</span>, <span class="hljs-literal">nullptr</span>, method, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(trace())JS"</span>;</li></ol></pre></div></div> <p>预计的输出结果:</p> <div _ngcontent-rda-c106="" class="highlight-div"><div _ngcontent-rda-c106="" class="highlight-div-header"><div _ngcontent-rda-c106="" class="highlight-div-header-left"><div _ngcontent-rda-c106="" class="handle-button expand-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rda-c106="" class="highlight-div-header-right"><div _ngcontent-rda-c106="" class="handle-button ai-button"></div><div _ngcontent-rda-c106="" class="handle-button line-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rda-c106="" class="handle-button theme-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rda-c106="" class="handle-button copy-button"><div _ngcontent-rda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">Trace</span> <span class="hljs-variable">success</span>:{<span class="hljs-string">"trace test"</span>:[{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364468711</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">139452</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"B"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeBefore"</span>:<span class="hljs-number">1592824</span>,<span class="hljs-string">"type"</span>:<span class="hljs-string">"allocation failure"</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364468727</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">139463</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"X"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"V8.GCScavenger"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">203</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">203</span>,<span class="hljs-string">"args"</span>:{}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364468949</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">139684</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"E"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeAfter"</span>:<span class="hljs-number">173472</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364471055</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">141792</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"B"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeBefore"</span>:<span class="hljs-number">1208672</span>,<span class="hljs-string">"type"</span>:<span class="hljs-string">"allocation failure"</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364471060</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">141796</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"X"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"V8.GCScavenger"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">110</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">110</span>,<span class="hljs-string">"args"</span>:{}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364471182</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">141918</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"E"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeAfter"</span>:<span class="hljs-number">173472</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364472901</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">143638</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"B"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeBefore"</span>:<span class="hljs-number">1221944</span>,<span class="hljs-string">"type"</span>:<span class="hljs-string">"allocation failure"</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364472905</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">143641</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"X"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"V8.GCScavenger"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">26</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">26</span>,<span class="hljs-string">"args"</span>:{}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364472940</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">143675</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"E"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeAfter"</span>:<span class="hljs-number">173472</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364474583</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">145319</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"B"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeBefore"</span>:<span class="hljs-number">1221944</span>,<span class="hljs-string">"type"</span>:<span class="hljs-string">"allocation failure"</span>}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364474585</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">145321</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"X"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"V8.GCScavenger"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">17</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">16</span>,<span class="hljs-string">"args"</span>:{}},{<span class="hljs-string">"pid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">54485</span>,<span class="hljs-string">"ts"</span>:<span class="hljs-number">341364474608</span>,<span class="hljs-string">"tts"</span>:<span class="hljs-number">145343</span>,<span class="hljs-string">"ph"</span>:<span class="hljs-string">"E"</span>,<span class="hljs-string">"cat"</span>:<span class="hljs-string">"devtools.timeline,v8"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"MinorGC"</span>,<span class="hljs-string">"dur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"tdur"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"args"</span>:{<span class="hljs-string">"usedHeapSizeAfter"</span>:<span class="hljs-number">173472</span>}}]}</li></ol></pre></div></div> <p>注：用户运行demo输出的结果不一定与给出参考结果相等，id的分配方式和用户环境相关</p> </div> </div> <div></div></div>