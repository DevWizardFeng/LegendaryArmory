<h1 _ngcontent-dji-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行WebAssembly模块相关开发"> 使用JSVM-API接口进行WebAssembly模块相关开发 </h1>

<div _ngcontent-dji-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API WebAssembly 接口提供了 WebAssembly 字节码编译、WebAssembly 函数优化、WebAssembly cache 序列化和反序列化的能力。</p> <p>权限要求：WebAssembly相关接口需要应用拥有JIT权限才能执行，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-apply-jit-profile">JSVM 申请JIT权限指导</a>申请对应权限。</p> <p>运行限制：当前 JSVM 版本在坚盾守护模式下将禁用 WebAssembly 全部功能模块。开发者需针对此限制进行应用兼容性评估，具体技术规范详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-secure-shield-mode">JSVM 坚盾守护模式</a>。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><ul><li><strong>wasm module</strong>：表示一个 WebAssembly 模块，(WebAssembly 简称为wasm)，通过OH_JSVM_CompileWasmModule可以将wasm字节码或wasm cache创建为wasm module。通过 OH_JSVM_IsWasmModuleObject 接口可以判断一个 JSVM_Value 是否是一个 wasm module。</li><li><strong>wasm function</strong>：表示 wasm module 中定义的函数，wasm function 在导出后被外部代码使用。OH_JSVM_CompileWasmFunction 接口提供了将 wasm function 编译为优化后的机器码的能力，方便开发者对指定 wasm function 提前编译和函数粒度的并行编译。</li><li><strong>wasm cache</strong>：对 wasm module 中的机器码进行序列化，生成的数据被称为 wasm cache。wasm cache 的创建和释放接口分别为 OH_JSVM_CreateWasmCache 和 OH_JSVM_ReleaseCache (对应的 cacheType 为 JSVM_CACHE_TYPE_WASM)。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileWasmModule</td> <td class="cellrowborder" valign="top" width="50%">将 wasm 字节码同步编译为 wasm module。如果提供了 cache 参数，先尝试将 cache 反序列为 wasm module，反序列化失败后再执行编译。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CompileWasmFunction</td> <td class="cellrowborder" valign="top" width="50%">将 wasm module 中指定编号的函数编译为优化后的机器码，目前只使能了最高的优化等级，函数编号的合法性由接口调用者保证。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsWasmModuleObject</td> <td class="cellrowborder" valign="top" width="50%">判断传入的值是否是wasm module。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateWasmCache</td> <td class="cellrowborder" valign="top" width="50%">将 wasm module 中的机器码序列化为 wasm cache，如果 wasm module 不包含机器码，会导致序列化失败。如果没有 JIT 权限支持，则打印一行日志提示开发者。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReleaseCache</td> <td class="cellrowborder" valign="top" width="50%">释放由 JSVM 接口生成的 cache。传入的 cacheType 和 cacheData 必须匹配，否则会产生未定义行为。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="code-cache-校验规格说明">code cache 校验规格说明<i class="anchor-icon anchor-icon-link" anchorid="code-cache-校验规格说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" valign="top" width="50%">规格</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" valign="top" width="50%">规格说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">完整性校验</td> <td class="cellrowborder" valign="top" width="50%">由用户保证</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">兼容性校验</td> <td class="cellrowborder" valign="top" width="50%">校验生成 cache 的 JSVM 版本与编译选项是否与当前一致</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">一致性校验</td> <td class="cellrowborder" valign="top" width="50%">由用户保证</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a> 了解 JSVM-API 接口开发流程。本文仅展示接口对应的 C++ 代码。</p> <p>cpp 部分代码：</p> <div _ngcontent-dji-c106="" class="highlight-div"><div _ngcontent-dji-c106="" class="highlight-div-header"><div _ngcontent-dji-c106="" class="highlight-div-header-left"><div _ngcontent-dji-c106="" class="handle-button expand-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dji-c106="" class="highlight-div-header-right"><div _ngcontent-dji-c106="" class="handle-button ai-button"></div><div _ngcontent-dji-c106="" class="handle-button line-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dji-c106="" class="handle-button theme-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dji-c106="" class="handle-button copy-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CHECK_STATUS</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_STATUS(cond)                           \</span></li><li><span class="hljs-meta">    do {                                             \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!(cond)) {                               \</span></li><li><span class="hljs-meta">            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"CHECK FAILED"</span>);   \</span></li><li><span class="hljs-meta">        }                                            \</span></li><li><span class="hljs-meta">    } while (0)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li>
</li><li><span class="hljs-comment">// 判断一个 JSVM_Value 是否是 wasm module</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">IsWasmModuleObject</span><span class="hljs-params">(JSVM_Env env, JSVM_Value value)</span> </span>{</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsWasmModuleObject</span>(env, value, &amp;result);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 由 C 字符串创建 JSVM string</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateString</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span> </span>{</li><li>    JSVM_Value jsvmStr;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, str, JSVM_AUTO_LENGTH, &amp;jsvmStr);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-keyword">return</span> jsvmStr;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 由 C int32_t 创建 JSVM number</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateInt32</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">int32_t</span> val)</span> </span>{</li><li>    JSVM_Value jsvmInt32;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, val, &amp;jsvmInt32);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-keyword">return</span> jsvmInt32;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 对 wasm module 进行实例化</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">InstantiateWasmModule</span><span class="hljs-params">(JSVM_Env env, JSVM_Value wasmModule)</span> </span>{</li><li>    JSVM_Status status = JSVM_OK;</li><li>    JSVM_Value globalThis;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;globalThis);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    JSVM_Value webAssembly;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, globalThis, <span class="hljs-built_in">CreateString</span>(env, <span class="hljs-string">"WebAssembly"</span>), &amp;webAssembly);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    JSVM_Value webAssemblyInstance;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, webAssembly, <span class="hljs-built_in">CreateString</span>(env, <span class="hljs-string">"Instance"</span>), &amp;webAssemblyInstance);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    JSVM_Value instance;</li><li>    JSVM_Value argv[] = {wasmModule};</li><li>    status = <span class="hljs-built_in">OH_JSVM_NewInstance</span>(env, webAssemblyInstance, <span class="hljs-number">1</span>, argv, &amp;instance);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-keyword">return</span> instance;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取 wasm 字节码 (add 模块)</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; <span class="hljs-title">GetAddWasmBuffer</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// 以下 wasmBuffer 对应的 wasm 字节码文本格式如下所示，只包含了一个函数 add</span></li><li>    <span class="hljs-comment">// (module</span></li><li>    <span class="hljs-comment">//   (func $add (param $lhs i32) (param $rhs i32) (result i32)</span></li><li>    <span class="hljs-comment">//     local.get $lhs</span></li><li>    <span class="hljs-comment">//     local.get $rhs</span></li><li>    <span class="hljs-comment">//     i32.add</span></li><li>    <span class="hljs-comment">//   )</span></li><li>    <span class="hljs-comment">//   (export "add" (func $add))</span></li><li>    <span class="hljs-comment">// )</span></li><li>    std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; wasmBuffer = {<span class="hljs-number">0x00</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x01</span>,</li><li>                                       <span class="hljs-number">0x60</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>,</li><li>                                       <span class="hljs-number">0x07</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x01</span>,</li><li>                                       <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x0b</span>};</li><li>    <span class="hljs-keyword">return</span> wasmBuffer;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 验证 wasm instance 功能 (add 模块)</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">VerifyAddWasmInstance</span><span class="hljs-params">(JSVM_Env env, JSVM_Value wasmInstance)</span> </span>{</li><li>    JSVM_Status status = JSVM_OK;</li><li>    <span class="hljs-comment">// 从 wasm instance 获取 exports.add 函数</span></li><li>    JSVM_Value exports;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, wasmInstance, <span class="hljs-built_in">CreateString</span>(env, <span class="hljs-string">"exports"</span>), &amp;exports);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    JSVM_Value add;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, exports, <span class="hljs-built_in">CreateString</span>(env, <span class="hljs-string">"add"</span>), &amp;add);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    <span class="hljs-comment">// 执行 exports.add(1, 2)，期望得到结果 3</span></li><li>    JSVM_Value undefined;</li><li>    <span class="hljs-built_in">OH_JSVM_GetUndefined</span>(env, &amp;undefined);</li><li>    JSVM_Value one = <span class="hljs-built_in">CreateInt32</span>(env, <span class="hljs-number">1</span>);</li><li>    JSVM_Value two = <span class="hljs-built_in">CreateInt32</span>(env, <span class="hljs-number">2</span>);</li><li>    JSVM_Value argv[] = {one, two};</li><li>    JSVM_Value result;</li><li>    status = <span class="hljs-built_in">OH_JSVM_CallFunction</span>(env, undefined, add, <span class="hljs-number">2</span>, argv, &amp;result);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-type">int32_t</span> resultInt32 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, result, &amp;resultInt32);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(resultInt32 == <span class="hljs-number">3</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// WebAssembly demo 主函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">WasmDemo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_Status status = JSVM_OK;</li><li>    std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; wasmBuffer = <span class="hljs-built_in">GetAddWasmBuffer</span>();</li><li>    <span class="hljs-type">uint8_t</span> *wasmBytecode = wasmBuffer.<span class="hljs-built_in">data</span>();</li><li>    <span class="hljs-type">size_t</span> wasmBytecodeLength = wasmBuffer.<span class="hljs-built_in">size</span>();</li><li>    JSVM_Value wasmModule;</li><li>    <span class="hljs-comment">// 根据 wasm 字节码得到 wasm module</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_CompileWasmModule</span>(env, wasmBytecode, wasmBytecodeLength, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, &amp;wasmModule);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(<span class="hljs-built_in">IsWasmModuleObject</span>(env, wasmModule));</li><li>
</li><li>    <span class="hljs-comment">// 对当前 wasm module 中定义的第一个函数 (即 add) 执行编译优化</span></li><li>    <span class="hljs-type">int32_t</span> functionIndex = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 注意：当前只支持 high level optimization，即传入 JSVM_WASM_OPT_BASELINE 和传入 JSVM_WASM_OPT_HIGH 效果是一样的</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_CompileWasmFunction</span>(env, wasmModule, functionIndex, JSVM_WASM_OPT_HIGH);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-comment">// 对编译得到的 wasm module 进行实例化</span></li><li>    JSVM_Value wasmInstance = <span class="hljs-built_in">InstantiateWasmModule</span>(env, wasmModule);</li><li>    <span class="hljs-comment">// 对实例化的 wasm instance 中的函数进行功能验证</span></li><li>    <span class="hljs-built_in">VerifyAddWasmInstance</span>(env, wasmInstance);</li><li>
</li><li>    <span class="hljs-comment">// 创建 wasm cache</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *wasmCacheData = <span class="hljs-literal">NULL</span>;</li><li>    <span class="hljs-type">size_t</span> wasmCacheLength = <span class="hljs-number">0</span>;</li><li>    status = <span class="hljs-built_in">OH_JSVM_CreateWasmCache</span>(env, wasmModule, &amp;wasmCacheData, &amp;wasmCacheLength);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>    <span class="hljs-comment">// 期望 wasm cache 创建成功</span></li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(wasmCacheData != <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(wasmCacheLength &gt; <span class="hljs-number">0</span>);</li><li>
</li><li>    <span class="hljs-comment">// 通过将 wasm cache 赋值来模拟 cache 持久化，实际使用场景可能将 wasm cache 保存到文件</span></li><li>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; <span class="hljs-title">cacheBuffer</span><span class="hljs-params">(wasmCacheData, wasmCacheData + wasmCacheLength)</span></span>;</li><li>
</li><li>    <span class="hljs-comment">// cache 一旦保存完成后，需要显式释放，以免发生内存泄露</span></li><li>    <span class="hljs-comment">// 注意：传入的 JSVM_CacheType 必须匹配</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_ReleaseCache</span>(env, wasmCacheData, JSVM_CACHE_TYPE_WASM);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    <span class="hljs-comment">// 使用 wasm code 反序列化来生成 wasm module</span></li><li>    <span class="hljs-type">bool</span> cacheRejected = <span class="hljs-literal">false</span>;</li><li>    JSVM_Value wasmModule2;</li><li>    status = <span class="hljs-built_in">OH_JSVM_CompileWasmModule</span>(env, wasmBytecode, wasmBytecodeLength, cacheBuffer.<span class="hljs-built_in">data</span>(), cacheBuffer.<span class="hljs-built_in">size</span>(),</li><li>                                       &amp;cacheRejected, &amp;wasmModule2);</li><li>   </li><li>    <span class="hljs-comment">// 传入的 wasm cache 如果是匹配的，且内部校验通过 (如版本)，则会接受 cache</span></li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(!cacheRejected);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(<span class="hljs-built_in">IsWasmModuleObject</span>(env, wasmModule2));</li><li>
</li><li>    <span class="hljs-comment">// 对反序列化得到的 wasmModule2 进行同样的操作：函数编译、实例化、验证功能，期望也都是通过的</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_CompileWasmFunction</span>(env, wasmModule2, functionIndex, JSVM_WASM_OPT_HIGH);</li><li>    <span class="hljs-built_in">CHECK_STATUS</span>(status == JSVM_OK);</li><li>
</li><li>    JSVM_Value wasmInstance2 = <span class="hljs-built_in">InstantiateWasmModule</span>(env, wasmModule2);</li><li>    <span class="hljs-built_in">VerifyAddWasmInstance</span>(env, wasmInstance2);</li><li>
</li><li>    JSVM_Value result;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM resultInt: %{public}d"</span>, result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// WasmDemo 方法注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = WasmDemo}</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// 将 C++ callback WasmDemo 函数注册为 JSVM globalThis.wasmDemo 属性，供 JS 侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"wasmDemo"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(wasmDemo())JS"</span>;</li></ol></pre></div></div> <p>预期输出</p> <div _ngcontent-dji-c106="" class="highlight-div"><div _ngcontent-dji-c106="" class="highlight-div-header"><div _ngcontent-dji-c106="" class="highlight-div-header-left"><div _ngcontent-dji-c106="" class="handle-button expand-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dji-c106="" class="highlight-div-header-right"><div _ngcontent-dji-c106="" class="handle-button ai-button"></div><div _ngcontent-dji-c106="" class="handle-button line-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dji-c106="" class="handle-button theme-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dji-c106="" class="handle-button copy-button"><div _ngcontent-dji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dji-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM resultInt:</span> <span class="hljs-number">975178312</span></li></ol></pre></div></div> </div> </div> <div></div></div>