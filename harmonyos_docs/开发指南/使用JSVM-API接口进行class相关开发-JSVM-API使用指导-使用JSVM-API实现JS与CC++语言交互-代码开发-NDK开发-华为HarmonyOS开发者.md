<h1 _ngcontent-pns-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行class相关开发"> 使用JSVM-API接口进行class相关开发 </h1>

<div _ngcontent-pns-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用JSVM-API接口进行class相关开发，处理JavaScript中的类，例如定义类、构造实例等。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>在使用JSVM-API接口进行class相关开发时，需要理解以下基本概念：</p> <ul><li><strong>类</strong>：类是用于创建对象的模板。它提供了一种封装数据和行为的方式，以便于对数据进行处理和操作。类在JavaScript中是建立在原型（prototype）的基础上的，并且还引入了一些类独有的语法和语义。</li><li><strong>实例</strong>：实例是通过类创建具体的对象。类定义了对象的结构和行为，而实例则是类的具体表现。通过实例化类，我们可以访问类中定义的属性和方法，并且每个实例都具有自己的属性值。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_NewInstance</td> <td class="cellrowborder" valign="top" width="50%">通过给定的构造函数，创建一个实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetNewTarget</td> <td class="cellrowborder" valign="top" width="50%">获取函数的元属性new.target。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineClass</td> <td class="cellrowborder" valign="top" width="50%">用于在JavaScript中定义一个类，并与对应的C类进行封装和交互。它提供了创建类的构造函数、定义属性和方法的能力，支持C和JavaScript之间的数据交互。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Wrap</td> <td class="cellrowborder" valign="top" width="50%">在JavaScript对象中封装原生实例。稍后可以使用OH_JSVM_Unwrap()解包原生实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Unwrap</td> <td class="cellrowborder" valign="top" width="50%">解包先前封装在JavaScript对象中的原生实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_RemoveWrap</td> <td class="cellrowborder" valign="top" width="50%">解包先前封装在JavaScript对象中的原生实例，并释放封装。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DefineClassWithOptions</td> <td class="cellrowborder" valign="top" width="50%">定义一个具有给定类名、构造函数、属性和回调处理程序、父类的JavaScript类，并根据传入了DefineClassOptions来决定是否需要为所定义的Class设置属性代理、预留internal-field槽位、为class作为函数进行调用时设置函数回调。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_newinstance" class="firsth2">OH_JSVM_NewInstance<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_newinstance" tips="复制节点链接"></i></h3><p>通过给定的构造函数，构建一个实例。</p> <p>cpp部分代码</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li>
</li><li><span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">(JSVM_Env env, JSVM_Value val)</span> </span>{</li><li>    JSVM_Value jsonString = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_JsonStringify</span>(env, val, &amp;jsonString));</li><li>    <span class="hljs-type">size_t</span> totalLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, jsonString, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;totalLen));</li><li>    <span class="hljs-type">size_t</span> needLen = totalLen + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">char</span>* buff = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[needLen];</li><li>    std::<span class="hljs-built_in">memset</span>(buff, <span class="hljs-number">0</span>, needLen);</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, jsonString, buff, needLen, &amp;totalLen));</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(buff)</span></span>;</li><li>    <span class="hljs-keyword">delete</span>[] buff;</li><li>    <span class="hljs-keyword">return</span> str;</li><li>}</li><li>
</li><li><span class="hljs-comment">// OH_JSVM_NewInstance的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">NewInstance</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// 获取js侧传入的两个参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用OH_JSVM_NewInstance接口，实例化一个对象，将这个对象返回</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_NewInstance</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, &amp;args[<span class="hljs-number">1</span>], &amp;result));</li><li>    std::string str = <span class="hljs-built_in">ToString</span>(env, result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NewInstance:%{public}s"</span>, str.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 通过给定的构造函数，构建一个实例。</span></li><li><span class="hljs-comment">// NewInstance注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = NewInstance},</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-comment">// NewInstance方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"newInstance"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例JS</strong></p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">   function Fruit(name) {</span></li><li><span class="hljs-string">       this.name = name;</span></li><li><span class="hljs-string">   }</span></li><li><span class="hljs-string">   newInstance(Fruit, "apple");</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出下面的结果：</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>NewInstance:{<span class="hljs-string">"name"</span>:<span class="hljs-string">"apple"</span>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getnewtarget">OH_JSVM_GetNewTarget<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getnewtarget" tips="复制节点链接"></i></h3><p>用于获取函数的元属性new.target值。在JavaScript中，new.target是一个特殊的元属性，用于检测函数或构造函数是否是通过 'new' 运算符被调用的。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_defineclass">OH_JSVM_DefineClass<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_defineclass" tips="复制节点链接"></i></h3><p>用于在JavaScript中定义一个类，并与对应的C类进行封装和交互。它提供了创建类的构造函数、定义属性和方法的能力，以及在C和JavaScript之间进行数据交互的支持。</p> <p>cpp部分代码</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">CreateInstance</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_Value newTarget;</li><li>    <span class="hljs-comment">// 获取构造函数的new.target值</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetNewTarget</span>(env, info, &amp;newTarget));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Create Instance"</span>);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NAPI MyObject::New %{public}s"</span>, newTarget != <span class="hljs-literal">nullptr</span> ? <span class="hljs-string">"newTarget != nullptr"</span> : <span class="hljs-string">"newTarget == nullptr"</span>);</li><li>    JSVM_Value jsObject = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;jsObject));</li><li>    JSVM_Value jsName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"name"</span>, JSVM_AUTO_LENGTH, &amp;jsName));</li><li>    JSVM_Value jsValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"lilei"</span>, JSVM_AUTO_LENGTH, &amp;jsValue));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetProperty</span>(env, jsObject, jsName, jsValue));</li><li>    <span class="hljs-keyword">return</span> jsObject;</li><li>}</li><li>
</li><li><span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">(JSVM_Env env, JSVM_Value val)</span> </span>{</li><li>    JSVM_Value jsonString = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_JsonStringify</span>(env, val, &amp;jsonString));</li><li>    <span class="hljs-type">size_t</span> totalLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, jsonString, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;totalLen));</li><li>    <span class="hljs-type">size_t</span> needLen = totalLen + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">char</span>* buff = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[needLen];</li><li>    std::<span class="hljs-built_in">memset</span>(buff, <span class="hljs-number">0</span>, needLen);</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, jsonString, buff, needLen, &amp;totalLen));</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(buff)</span></span>;</li><li>    <span class="hljs-keyword">delete</span>[] buff;</li><li>    <span class="hljs-keyword">return</span> str;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 封装c++中的自定义数据结构</span></li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">DefineClass</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_CallbackStruct param;</li><li>    param.data = <span class="hljs-literal">nullptr</span>;</li><li>    param.callback = CreateInstance;</li><li>    JSVM_Value cons;</li><li>    <span class="hljs-comment">// 用于在JavaScript中定义一个类</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_DefineClass</span>(env, <span class="hljs-string">"MyObject"</span>, JSVM_AUTO_LENGTH, &amp;param, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;cons));</li><li>    JSVM_Value instanceValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 作为class的构造函数调用</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_NewInstance</span>(env, cons, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;instanceValue));</li><li>    std::string str = <span class="hljs-built_in">ToString</span>(env, instanceValue);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NewInstance:%{public}s"</span>, str.<span class="hljs-built_in">c_str</span>());</li><li>    </li><li>    <span class="hljs-comment">// 作为普通的函数调用</span></li><li>    JSVM_Value global = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;global));</li><li>    JSVM_Value key;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Constructor"</span>, JSVM_AUTO_LENGTH, &amp;key));</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetProperty</span>(env, global, key, cons));</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CallFunction</span>(env, global, cons, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;result));</li><li>    std::string buf = <span class="hljs-built_in">ToString</span>(env, result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"NewInstance:%{public}s"</span>, buf.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册DefineClass的方法</span></li><li>JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = DefineClass},</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-comment">// DefineClass方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"defineClass"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例JS</strong></p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    defineClass();</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出下面的结果：</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Create Instance</li><li>
</li><li>NAPI MyObject::New newTarget != <span class="hljs-literal">nullptr</span></li><li>
</li><li>NewInstance:{<span class="hljs-string">"name"</span>:<span class="hljs-string">"lilei"</span>}</li><li>
</li><li>Create Instance</li><li>
</li><li>NAPI MyObject::New newTarget == <span class="hljs-literal">nullptr</span></li><li>
</li><li>NewInstance:{<span class="hljs-string">"name"</span>:<span class="hljs-string">"lilei"</span>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_wrap">OH_JSVM_Wrap<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_wrap" tips="复制节点链接"></i></h3><p>在JavaScript对象中封装原生实例。稍后可以使用OH_JSVM_Unwrap()解包原生实例</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_unwrap">OH_JSVM_Unwrap<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_unwrap" tips="复制节点链接"></i></h3><p>解包JavaScript对象中先前封装的原生实例</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_removewrap">OH_JSVM_RemoveWrap<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_removewrap" tips="复制节点链接"></i></h3><p>解包先前封装在JavaScript对象中的原生实例并释放封装</p> <p>cpp部分代码</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// OH_JSVM_GetNewTarget、OH_JSVM_DefineClass、OH_JSVM_Wrap、OH_JSVM_Unwrap、OH_JSVM_RemoveWrap的样例方法</span></li><li>
</li><li><span class="hljs-comment">// 自定义类结构体Object</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Object</span> {</li><li>    std::string name;</li><li>    <span class="hljs-type">int32_t</span> age;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 定义一个回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">DerefItem</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM deref_item"</span>);</li><li>    (<span class="hljs-type">void</span>)hint;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">WrapObject</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM wrap"</span>);</li><li>    Object obj;</li><li>    <span class="hljs-comment">// 设置Object属性</span></li><li>    obj.name = <span class="hljs-string">"lilei"</span>;</li><li>    obj.age = <span class="hljs-number">18</span>;</li><li>    Object *objPointer = &amp;obj;</li><li>    <span class="hljs-comment">// 获取回调信息中的参数数量和将要被封装的值</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value toWrap = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, &amp;toWrap, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-comment">// OH_JSVM_Wrap将自定义结构Object进行封装</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_Wrap</span>(env, toWrap, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(objPointer), DerefItem, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>    Object *data;</li><li>    <span class="hljs-comment">// OH_JSVM_UnWrap解包先前封装在JavaScript对象中的原生实例</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_Unwrap</span>(env, toWrap, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> **&gt;(&amp;data)));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM name: %{public}s"</span>, data-&gt;name.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM age: %{public}d"</span>, data-&gt;age);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">RemoveWrap</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM removeWrap"</span>);</li><li>    Object obj;</li><li>    <span class="hljs-comment">// 设置Object属性</span></li><li>    obj.name = <span class="hljs-string">"lilei"</span>;</li><li>    obj.age = <span class="hljs-number">18</span>;</li><li>    Object *objPointer = &amp;obj;</li><li>    <span class="hljs-comment">// 获取回调信息中的参数数量和将要被封装的值</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value toWrap = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, &amp;toWrap, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-comment">// 将自定义结构Object封装</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_Wrap</span>(env, toWrap, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(objPointer), DerefItem, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>    Object *data;</li><li>    <span class="hljs-comment">// 解包先前封装的object，并移除封装</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_RemoveWrap</span>(env, toWrap, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> **&gt;(&amp;objPointer)));</li><li>    <span class="hljs-comment">// 检查是否已被移除</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_Unwrap</span>(env, toWrap, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> **&gt;(&amp;data));</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_RemoveWrap success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// WrapObject、RemoveWrap注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = WrapObject},</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = RemoveWrap},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// WrapObject、RemoveWrap方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"wrapObject"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"removeWrap"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例JS</strong></p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    class Obj {};</span></li><li><span class="hljs-string">    wrapObject(new Obj());</span></li><li><span class="hljs-string">    removeWrap(new Obj());</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出下面的结果：</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM wrap</li><li>
</li><li>JSVM name: lilei</li><li>
</li><li>JSVM age: <span class="hljs-number">18</span></li><li>
</li><li>JSVM removeWrap</li><li>
</li><li>JSVM OH_JSVM_RemoveWrap success</li><li>
</li><li>JSVM deref_item</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_defineclasswithoptions">OH_JSVM_DefineClassWithOptions<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_defineclasswithoptions" tips="复制节点链接"></i></h3> <p><strong>Note:</strong></p>  <p>传入的父类class必须是通过OH_JSVM_DefineClass系列接口创建出来的，否则被视为无效参数，返回JSVM_INVALID_ARG错误码。</p> <p>目前支持以下的DefineClassOptions:</p>  <ul><li>JSVM_DEFINE_CLASS_NORMAL: 按正常模式创建Class。默认缺省状态为JSVM_DEFINE_CLASS_NORMAL状态。</li><li>JSVM_DEFINE_CLASS_WITH_COUNT: 为所创建的Class预留interfield槽位。</li><li>JSVM_DEFINE_CLASS_WITH_PROPERTY_HANDLER: 为所创建的Class设置监听拦截属性以及设置作为函数调用时回调函数。</li></ul> <p>cpp部分代码</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-type">static</span> JSVM_PropertyHandlerConfigurationStruct propertyCfg{</li><li>  <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span></li><li>};</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> g_call_as_function_flag = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> g_set_named_property_flag = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> g_call_as_constructor_flag = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> g_properties_flag = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">SetNamedPropertyCbInfo2</span><span class="hljs-params">(JSVM_Env env, JSVM_Value name, JSVM_Value property, JSVM_Value thisArg,</span></span></li><li><span class="hljs-function">    JSVM_Value data)</span></li><li><span class="hljs-function"></span>{</li><li>    g_set_named_property_flag = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">return</span> property;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">Add</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    g_properties_flag = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-type">double</span> num1 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">double</span> num2 = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">0</span>], &amp;num1);</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, args[<span class="hljs-number">1</span>], &amp;num2);</li><li>    JSVM_Value sum = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateDouble</span>(env, num1 + num2, &amp;sum);</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">(JSVM_Env jsvm_env, JSVM_Value val)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Value js_string;</li><li>    <span class="hljs-built_in">OH_JSVM_CoerceToString</span>(jsvm_env, val, &amp;js_string);</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(jsvm_env, js_string, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;length);</li><li>    <span class="hljs-type">size_t</span> capacity = length + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">auto</span> buffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(capacity);</li><li>    <span class="hljs-type">size_t</span> copy_length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(jsvm_env, js_string, buffer.<span class="hljs-built_in">get</span>(), capacity, &amp;copy_length);</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(buffer.get())</span></span>;</li><li>    <span class="hljs-keyword">return</span> str;</li><li>}</li><li>
</li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">Run</span><span class="hljs-params">(JSVM_Env env, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 1. 将const char*转换成JS_String。</span></li><li>    JSVM_Value str;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, s, JSVM_AUTO_LENGTH, &amp;str));</li><li>    <span class="hljs-comment">// 2. 将JS_String转换成JS_Script。</span></li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, str, <span class="hljs-literal">nullptr</span>, JSVM_AUTO_LENGTH,   <span class="hljs-literal">false</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>    <span class="hljs-comment">// 3. 执行JS_Script。</span></li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">TestDefineClassWithOptions</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    g_call_as_function_flag = <span class="hljs-literal">false</span>;</li><li>    g_set_named_property_flag = <span class="hljs-literal">false</span>;</li><li>    g_call_as_constructor_flag = <span class="hljs-literal">false</span>;</li><li>    g_properties_flag = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// 1. Define parent-class.</span></li><li>    JSVM_Value parentClass = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_CallbackStruct parentClassConstructor;</li><li>    parentClassConstructor.data = <span class="hljs-literal">nullptr</span>;</li><li>    parentClassConstructor.callback = [](JSVM_Env env, JSVM_CallbackInfo info) -&gt; JSVM_Value {</li><li>        JSVM_Value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">return</span> thisVar;</li><li>    };</li><li>    JSVM_Value fooVal;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"bar"</span>, JSVM_AUTO_LENGTH, &amp;fooVal);</li><li>    JSVM_PropertyDescriptor des[<span class="hljs-number">2</span>];</li><li>    des[<span class="hljs-number">0</span>] = {</li><li>        .utf8name = <span class="hljs-string">"foo"</span>,</li><li>        .value = fooVal,</li><li>    };</li><li>    JSVM_CallbackStruct parentProperties[] = {</li><li>        {.callback = Add, .data = <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    des[<span class="hljs-number">1</span>] = {</li><li>        .utf8name = <span class="hljs-string">"add"</span>,</li><li>        .method = &amp;parentProperties[<span class="hljs-number">0</span>],</li><li>    };</li><li>    JSVM_DefineClassOptions options[<span class="hljs-number">1</span>];</li><li>    options[<span class="hljs-number">0</span>].id = JSVM_DEFINE_CLASS_WITH_COUNT;</li><li>    options[<span class="hljs-number">0</span>].content.num = <span class="hljs-number">3</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_DefineClassWithOptions</span>(env, <span class="hljs-string">"parentClass"</span>, JSVM_AUTO_LENGTH, &amp;parentClassConstructor, <span class="hljs-number">2</span>, des,</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, options, &amp;parentClass));</li><li>  </li><li>    <span class="hljs-comment">// 2. Define sub-class.</span></li><li>    JSVM_Value subClass = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_CallbackStruct subClassConstructor;</li><li>    subClassConstructor.data = <span class="hljs-literal">nullptr</span>;</li><li>    subClassConstructor.callback = [](JSVM_Env env, JSVM_CallbackInfo info) -&gt; JSVM_Value {</li><li>        JSVM_Value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        g_call_as_constructor_flag = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">return</span> thisVar;</li><li>    };</li><li>    JSVM_DefineClassOptions subOptions[<span class="hljs-number">2</span>];</li><li>    JSVM_CallbackStruct callAsFuncParam;</li><li>    callAsFuncParam.data = <span class="hljs-literal">nullptr</span>;</li><li>    callAsFuncParam.callback = [](JSVM_Env env, JSVM_CallbackInfo info) -&gt; JSVM_Value {</li><li>        JSVM_Value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        g_call_as_function_flag = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">return</span> thisVar;</li><li>    };</li><li>    propertyCfg.genericNamedPropertySetterCallback = SetNamedPropertyCbInfo2;</li><li>    JSVM_PropertyHandler propertyHandler = {</li><li>        .propertyHandlerCfg = &amp;propertyCfg,</li><li>        .callAsFunctionCallback = &amp;callAsFuncParam,</li><li>    };</li><li>    subOptions[<span class="hljs-number">0</span>].id = JSVM_DEFINE_CLASS_WITH_COUNT;</li><li>    subOptions[<span class="hljs-number">0</span>].content.num = <span class="hljs-number">4</span>;</li><li>    subOptions[<span class="hljs-number">1</span>].id = JSVM_DEFINE_CLASS_WITH_PROPERTY_HANDLER;</li><li>    subOptions[<span class="hljs-number">1</span>].content.ptr = &amp;propertyHandler;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_DefineClassWithOptions</span>(env, <span class="hljs-string">"subClass"</span>, JSVM_AUTO_LENGTH, &amp;subClassConstructor, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>,</li><li>        parentClass, <span class="hljs-number">2</span>, subOptions, &amp;subClass));</li><li>    <span class="hljs-comment">// 3. Verify the validity of 'constructor'.</span></li><li>    JSVM_Value subInstance;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_NewInstance</span>(env, subClass, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;subInstance));</li><li>
</li><li>    JSVM_Value globalVal;</li><li>    <span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;globalVal);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, globalVal, <span class="hljs-string">"obj"</span>, subInstance);</li><li>
</li><li>    <span class="hljs-comment">// 4. Verify the validity of 'parentClass'.</span></li><li>    JSVM_Value subRes = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, subInstance, <span class="hljs-string">"foo"</span>, &amp;subRes));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ToString</span>(env, subRes).<span class="hljs-built_in">compare</span>(<span class="hljs-string">"bar"</span>) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Run OH_JSVM_DefineClassWithOptions: Failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 5. Verify the validity of 'properties'.</span></li><li>    <span class="hljs-built_in">Run</span>(env, <span class="hljs-string">"obj.add(3, 4);"</span>);</li><li>    <span class="hljs-comment">// 6. Verify the validity of 'options'.</span></li><li>    <span class="hljs-built_in">Run</span>(env, <span class="hljs-string">"obj()"</span>);</li><li>    <span class="hljs-built_in">Run</span>(env, <span class="hljs-string">"obj.x = 123;"</span>);</li><li>    <span class="hljs-keyword">if</span> (g_call_as_function_flag &amp;&amp;</li><li>    g_set_named_property_flag &amp;&amp;</li><li>    g_call_as_constructor_flag &amp;&amp;</li><li>    g_properties_flag) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Run OH_JSVM_DefineClassWithOptions: Success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Run OH_JSVM_DefineClassWithOptions: Failed"</span>);</li><li>    }</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = TestDefineClassWithOptions},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"testDefineClassWithOptions"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例JS</strong></p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(testDefineClassWithOptions();)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出下面的结果：</p> <div _ngcontent-pns-c106="" class="highlight-div"><div _ngcontent-pns-c106="" class="highlight-div-header"><div _ngcontent-pns-c106="" class="highlight-div-header-left"><div _ngcontent-pns-c106="" class="handle-button expand-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pns-c106="" class="highlight-div-header-right"><div _ngcontent-pns-c106="" class="handle-button ai-button"></div><div _ngcontent-pns-c106="" class="handle-button line-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pns-c106="" class="handle-button theme-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pns-c106="" class="handle-button copy-button"><div _ngcontent-pns-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pns-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Run OH_JSVM_DefineClassWithOptions: Success</li></ol></pre></div></div> </div> </div> <div></div></div>