<h1 _ngcontent-cfq-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行debug操作"> 使用JSVM-API接口进行debug操作 </h1>

<div _ngcontent-cfq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API中提供接口，可以启用/禁用特定JSVM_Env下的指定debug选项。目前支持的debug选项有JSVM_SCOPE_CHECK。  </p> </div>  <div class="tiledSection"><h2 id="debug选项介绍">debug选项介绍<i class="anchor-icon anchor-icon-link" anchorid="debug选项介绍" tips="复制节点链接"></i></h2><p>debug选项皆为JSVM_DebugOption类型。  </p> </div>  <div class="tiledSection"><h3 id="jsvm_scope_check" class="firsth2">JSVM_SCOPE_CHECK<i class="anchor-icon anchor-icon-link" anchorid="jsvm_scope_check" tips="复制节点链接"></i></h3><ul><li>开发者在开发时，可能会出现在HandleScope结束后，调用上一次HandleScope内的JSVM_Value类型变量，导致程序崩溃。JSVM_SCOPE_CHECK为scope校验手段，校验当前调用的JSVM_Value类型变量是否超出HandleScope作用域，如果超出，则抛出错误“Run in wrong HandleScope”。</li><li>开启该debug选项后，若JSVM-API创建了JSVM_Value，则在hilog中有“ADD_VAL_TO_SCOPE_CHECK in function: [函数名]”输出，例如“ADD_VAL_TO_SCOPE_CHECK in function: OH_JSVM_GetBoolean”。若JSVM-API使用了JSVM_Value，则在hilog中有“CHECK_SCOPE in function: [函数名]”输出，表示对使用的JSVM_Value进行了HandleScope校验，例如“CHECK_SCOPE in function: OH_JSVM_IsBoolean”。</li></ul> <p> </p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetDebugOption</td> <td class="cellrowborder" valign="top" width="50%">启用/禁用特定JSVM_Env的指定debug选项。传入的debug选项参数debugOption必须为JSVM_DebugOption类型，布尔值参数isEnabled用于控制是否开启该debug选项。此API仅供debug时使用，开启后可能会带来性能下降。</td> </tr>  </tbody></table></div> </div> <p> </p> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="jsvm_debugoption" class="firsth2">JSVM_DebugOption<i class="anchor-icon anchor-icon-link" anchorid="jsvm_debugoption" tips="复制节点链接"></i></h3><p>仅需替换<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>示例代码中的“TestJSVM()”函数即可运行。</p> <ul><li>在正确的HandleScope内调用JSVM_Value类型变量。</li></ul> <div _ngcontent-cfq-c106="" class="highlight-div"><div _ngcontent-cfq-c106="" class="highlight-div-header"><div _ngcontent-cfq-c106="" class="highlight-div-header-left"><div _ngcontent-cfq-c106="" class="handle-button expand-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cfq-c106="" class="highlight-div-header-right"><div _ngcontent-cfq-c106="" class="handle-button ai-button"></div><div _ngcontent-cfq-c106="" class="handle-button line-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cfq-c106="" class="handle-button theme-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cfq-c106="" class="handle-button copy-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cfq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_InitOptions initOptions = {<span class="hljs-number">0</span>};</li><li>    JSVM_VM vm;</li><li>    JSVM_Env env = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>
</li><li>    <span class="hljs-comment">// 初始化JavaScript引擎实例</span></li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        g_aa++;</li><li>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions));</li><li>    }</li><li>    <span class="hljs-comment">// 创建JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env));</li><li>    <span class="hljs-comment">// 打开JSVM_SCOPE_CHECK校验选项</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_SetDebugOption</span>(env, JSVM_SCOPE_CHECK, <span class="hljs-literal">true</span>));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    <span class="hljs-comment">// 打开HandleScope</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>
</li><li>    <span class="hljs-comment">// 通过script调用测试函数</span></li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc, result;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcCallNative, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-type">bool</span> boolResult = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-comment">// OH_JSVM_IsBoolean接口调用JSVM_Value类型变量result</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsBoolean</span>(env, result, &amp;boolResult);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsBoolean: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsBoolean: success: %{public}d"</span>, boolResult);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 销毁JSVM环境</span></li><li>    <span class="hljs-comment">// 关闭HandleScope</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope));</li><li>    <span class="hljs-comment">// 关闭JSVM_SCOPE_CHECK校验选项</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_SetDebugOption</span>(env, JSVM_SCOPE_CHECK, <span class="hljs-literal">false</span>));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>hilog中有以下结果输出：</p> <div _ngcontent-cfq-c106="" class="highlight-div"><div _ngcontent-cfq-c106="" class="highlight-div-header"><div _ngcontent-cfq-c106="" class="highlight-div-header-left"><div _ngcontent-cfq-c106="" class="handle-button expand-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cfq-c106="" class="highlight-div-header-right"><div _ngcontent-cfq-c106="" class="handle-button ai-button"></div><div _ngcontent-cfq-c106="" class="handle-button line-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cfq-c106="" class="handle-button theme-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cfq-c106="" class="handle-button copy-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cfq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">NewString</span></li><li><span class="hljs-variable">CHECK_SCOPE</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_CompileScript</span></li><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_GetCbInfo</span></li><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_GetCbInfo</span></li><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_GetCbInfo</span></li><li><span class="hljs-variable">CHECK_SCOPE</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_StrictEquals</span></li><li><span class="hljs-variable">CHECK_SCOPE</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_StrictEquals</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">OH_JSVM_StrictEquals</span>: <span class="hljs-title class_">success</span>: <span class="hljs-number">0</span></li><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_GetBoolean</span></li><li><span class="hljs-variable">ADD_VAL_TO_SCOPE_CHECK</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_RunScript</span></li><li><span class="hljs-variable">CHECK_SCOPE</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">function</span>: <span class="hljs-title class_">OH_JSVM_IsBoolean</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">OH_JSVM_IsBoolean</span>: <span class="hljs-title class_">success</span>: <span class="hljs-number">1</span></li></ol></pre></div></div> <ul><li>在错误的HandleScope内调用JSVM_Value类型变量。</li></ul> <div _ngcontent-cfq-c106="" class="highlight-div"><div _ngcontent-cfq-c106="" class="highlight-div-header"><div _ngcontent-cfq-c106="" class="highlight-div-header-left"><div _ngcontent-cfq-c106="" class="handle-button expand-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cfq-c106="" class="highlight-div-header-right"><div _ngcontent-cfq-c106="" class="handle-button ai-button"></div><div _ngcontent-cfq-c106="" class="handle-button line-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cfq-c106="" class="handle-button theme-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cfq-c106="" class="handle-button copy-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cfq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_InitOptions initOptions = {<span class="hljs-number">0</span>};</li><li>    JSVM_VM vm;</li><li>    JSVM_Env env = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>
</li><li>    <span class="hljs-comment">// 初始化JavaScript引擎实例</span></li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        g_aa++;</li><li>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions));</li><li>    }</li><li>    <span class="hljs-comment">// 创建JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env));</li><li>    <span class="hljs-comment">// 打开JSVM_SCOPE_CHECK校验选项</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_SetDebugOption</span>(env, JSVM_SCOPE_CHECK, <span class="hljs-literal">true</span>));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    <span class="hljs-comment">// 打开HandleScope</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>
</li><li>    <span class="hljs-comment">// 通过script调用测试函数</span></li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc, result;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcCallNative, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-type">bool</span> boolResult = <span class="hljs-literal">true</span>;</li><li>
</li><li>    <span class="hljs-comment">// 销毁JSVM环境</span></li><li>    <span class="hljs-comment">// 关闭HandleScope</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-comment">// OH_JSVM_IsBoolean接口在错误的HandleScope调用JSVM_Value类型变量result</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsBoolean</span>(env, result, &amp;boolResult);</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope));</li><li>    <span class="hljs-comment">// 关闭JSVM_SCOPE_CHECK校验选项</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_SetDebugOption</span>(env, JSVM_SCOPE_CHECK, <span class="hljs-literal">false</span>));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>程序崩溃，有cppcrash日志生成，在hilog中可以检索到类似以下的信息：</p> <div _ngcontent-cfq-c106="" class="highlight-div"><div _ngcontent-cfq-c106="" class="highlight-div-header"><div _ngcontent-cfq-c106="" class="highlight-div-header-left"><div _ngcontent-cfq-c106="" class="handle-button expand-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cfq-c106="" class="highlight-div-header-right"><div _ngcontent-cfq-c106="" class="handle-button ai-button"></div><div _ngcontent-cfq-c106="" class="handle-button line-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cfq-c106="" class="handle-button theme-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cfq-c106="" class="handle-button copy-button"><div _ngcontent-cfq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cfq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">Fatal</span> <span class="hljs-title class_">Error</span> <span class="hljs-title class_">Position</span> : <span class="hljs-string">"../../../../../../../arkcompiler/jsvm/src/js_native_api_v8.cpp"</span>:<span class="hljs-number">4537</span></li><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">Fatal</span> <span class="hljs-title class_">Error</span> <span class="hljs-title class_">Message</span> : <span class="hljs-string">"Run in wrong HandleScope"</span></li></ol></pre></div></div> </div> </div> <div></div></div>