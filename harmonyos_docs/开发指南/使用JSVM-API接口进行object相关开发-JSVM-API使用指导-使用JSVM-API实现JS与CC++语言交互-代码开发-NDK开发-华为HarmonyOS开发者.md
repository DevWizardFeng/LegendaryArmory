<h1 _ngcontent-ibg-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行object相关开发"> 使用JSVM-API接口进行object相关开发 </h1>

<div _ngcontent-ibg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用JSVM-API接口进行object相关开发，处理JavaScript对象的基本操作，例如创建对象、获取原型、冻结和密封对象，检查对象的类型等。这些操作是在处理JavaScript对象时非常常见的，提供了一种与JavaScript对象交互的方式。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>在JSVM接口开发中，经常需要定义和操作对象。例如，创建一个接口，该接口接受一个对象作为输入参数，对该对象执行某些操作，并返回一个结果对象。在这个过程中，需要确保接口的定义清晰、规范，并且与对象的属性和方法相兼容。</p> <ul><li><strong>接口（API）</strong>：接口定义了组件之间的交互协议，包括输入参数、输出结果以及可能的错误处理。通过接口，组件可以相互调用和交换数据，而无需了解对方的内部实现细节。</li><li><strong>对象（Object）</strong>：在JavaScript，对象是一种复合数据类型，允许存储多个不同类型的值作为一个单独的实体。对象是属性和方法的集合。属性是与对象相关联的值，而方法则是对象可以执行的操作。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetPrototype</td> <td class="cellrowborder" valign="top" width="50%">获取给定JavaScript对象的原型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateObject</td> <td class="cellrowborder" valign="top" width="50%">创建一个默认的JavaScript Object对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectFreeze</td> <td class="cellrowborder" valign="top" width="50%">冻结给定的对象，防止向其添加新属性，删除现有属性，防止更改现有属性的可枚举性、可配置性或可写性，并防止更改现有属性的值。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ObjectSeal</td> <td class="cellrowborder" valign="top" width="50%">密封给定的对象。这可以防止向其添加新属性，以及将所有现有属性标记为不可配置。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Typeof</td> <td class="cellrowborder" valign="top" width="50%">返回JavaScript对象的类型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_Instanceof</td> <td class="cellrowborder" valign="top" width="50%">判断一个对象是否是某个构造函数的实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_TypeTagObject</td> <td class="cellrowborder" valign="top" width="50%">将type_tag指针的值与JavaScript对象或外部对象相关联。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CheckObjectTypeTag</td> <td class="cellrowborder" valign="top" width="50%">检查给定的类型标签是否与对象上的类型标签匹配。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSymbol</td> <td class="cellrowborder" valign="top" width="50%">根据给定的描述符创建一个Symbol对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SymbolFor</td> <td class="cellrowborder" valign="top" width="50%">在全局注册表中搜索具有给定描述的现有Symbol，如果该Symbol已经存在，它将被返回，否则将在注册表中创建一个新Symbol。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateExternal</td> <td class="cellrowborder" valign="top" width="50%">创建一个包装了外部指针的JavaScript对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetValueExternal</td> <td class="cellrowborder" valign="top" width="50%">获取先前传递给OH_JSVM_CreateExternal的外部数据指针。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getprototype" class="firsth2">OH_JSVM_GetPrototype<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getprototype" tips="复制节点链接"></i></h3><p>该函数用于获取给定JavaScript对象的原型。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-comment">// GetPrototype注册回调</span></li><li><span class="hljs-comment">// OH_JSVM_GetPrototype的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetPrototype</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    JSVM_Value result{<span class="hljs-literal">nullptr</span>};</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_GetPrototype</span>(env, argv[<span class="hljs-number">0</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetPrototype fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetPrototype success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetPrototype},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetPrototype方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getPrototype"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(const myObject = {};</span></li><li><span class="hljs-string">    const proto = getPrototype(myObject);</span></li><li><span class="hljs-string">    console.info(proto === Object.prototype);)JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">GetPrototype</span> success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createobject">OH_JSVM_CreateObject<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createobject" tips="复制节点链接"></i></h3><p>该函数创建一个默认的JavaScript Object对象。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreateObject的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateObject</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 创建一个空对象</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;object);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CreateObject fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateObject success"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 设置对象的属性</span></li><li>    JSVM_Value name = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 设置属性名为 "name"</span></li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"name"</span>, JSVM_AUTO_LENGTH, &amp;name);</li><li>    JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 设置属性值为 "Hello from N-API!"</span></li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Hello OH_JSVM_CreateObject!"</span>, JSVM_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-comment">// 将属性设置到对象上</span></li><li>    <span class="hljs-built_in">OH_JSVM_SetProperty</span>(env, object, name, value);</li><li>    <span class="hljs-keyword">return</span> object;</li><li>}</li><li><span class="hljs-comment">// CreateObject注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateObject},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateObject方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createObject"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(createObject())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">CreateObject</span> success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_objectfreeze">OH_JSVM_ObjectFreeze<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_objectfreeze" tips="复制节点链接"></i></h3><p>冻结给定的对象，防止向其添加新属性，移除现有属性，防止更改现有属性的可枚举性、可配置性或可写性，并防止更改现有属性的值。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_ObjectFreeze的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ObjectFreeze</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 接受一个JavaScript侧传入的object</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 调用接口OH_JSVM_ObjectFreeze将传入的object冻结</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_ObjectFreeze</span>(env, argv[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">if</span> (status == JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Test JSVM OH_JSVM_ObjectFreeze success"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 测试冻结后的对象中属性能否修改</span></li><li>    JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">111111</span>, &amp;value);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, argv[<span class="hljs-number">0</span>], <span class="hljs-string">"data"</span>, value);</li><li>    <span class="hljs-comment">// 将冻结后修改过的属性返回JavaScript侧</span></li><li>    <span class="hljs-keyword">return</span> argv[<span class="hljs-number">0</span>];</li><li>}</li><li><span class="hljs-comment">// ObjectFreeze注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = ObjectFreeze},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// ObjectFreeze方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"objectFreeze"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(let obj = { data: 55, message: "hello world"};</span></li><li><span class="hljs-string">  objectFreeze(obj))JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> OH_JSVM_ObjectFreeze success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_objectseal">OH_JSVM_ObjectSeal<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_objectseal" tips="复制节点链接"></i></h3><p>密封给定的对象。这可以防止向该对象添加新属性，以及将所有现有属性标记为不可配置。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_ObjectSeal的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ObjectSeal</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 接受一个JavaScript侧传入的object</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 调用接口OH_JSVM_ObjectSeal将传入的object封闭，使其无法添加新的属性</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_ObjectSeal</span>(env, argv[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">if</span> (status == JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Test JSVM OH_JSVM_ObjectSeal success"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 检查封闭后的对象中属性能否修改、删除、新增</span></li><li>    <span class="hljs-comment">// 封闭后对象修改</span></li><li>    JSVM_Value changeValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">111111</span>, &amp;changeValue);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, argv[<span class="hljs-number">0</span>], <span class="hljs-string">"data"</span>, changeValue);</li><li>    <span class="hljs-comment">// 封闭后对象删除</span></li><li>    JSVM_Value deleteProperty = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"message"</span>, JSVM_AUTO_LENGTH, &amp;deleteProperty);</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_DeleteProperty</span>(env, argv[<span class="hljs-number">0</span>], deleteProperty, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (result) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Test JSVM OH_JSVM_ObjectSeal failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 封闭后对象新增</span></li><li>    JSVM_Value addValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"addValue"</span>, JSVM_AUTO_LENGTH, &amp;addValue);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, argv[<span class="hljs-number">0</span>], <span class="hljs-string">"newProperty"</span>, addValue);</li><li>    <span class="hljs-comment">// 将封闭后改动过的对象返回JavaScript侧</span></li><li>    <span class="hljs-keyword">return</span> argv[<span class="hljs-number">0</span>];</li><li>}</li><li><span class="hljs-comment">// ObjectSeal注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = ObjectSeal},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// ObjectSeal方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"objectSeal"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS( let obj = { data: 55, message: "hello world"};</span></li><li><span class="hljs-string">  objectSeal(obj))JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> OH_JSVM_ObjectSeal success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_typeof">OH_JSVM_Typeof<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_typeof" tips="复制节点链接"></i></h3><p>返回JavaScript对象的类型。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_Typeof的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetTypeof</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    JSVM_ValueType valueType;</li><li>    <span class="hljs-built_in">OH_JSVM_Typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valueType);</li><li>    JSVM_Value type = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">switch</span> (valueType) {</li><li>        <span class="hljs-keyword">case</span> JSVM_UNDEFINED:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is undefined"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is undefined"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_NULL:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is null"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is null"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_BOOLEAN:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is boolean"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is boolean"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_NUMBER:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is number"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is number"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_STRING:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is string"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is string"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_SYMBOL:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is symbol"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is symbol"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_OBJECT:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is object"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is object"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_FUNCTION:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is function"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is function"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_EXTERNAL:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is external"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is external"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> JSVM_BIGINT:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type is bigint"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Input type is bigint"</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">default</span>:</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Input type does not match any"</span>);</li><li>            <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">" "</span>, JSVM_AUTO_LENGTH, &amp;type);</li><li>            <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> type;</li><li>}</li><li><span class="hljs-comment">// GetTypeof注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetTypeof},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetTypeof方法别名，TS侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getTypeof"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(getTypeof(true);)JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">Input</span> <span class="hljs-keyword">type</span> is <span class="hljs-built_in">boolean</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_instanceof">OH_JSVM_Instanceof<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_instanceof" tips="复制节点链接"></i></h3><p>判断一个对象是否是某个构造函数的实例。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_Instanceof的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">InstanceOf</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取两个JavaScript侧传入的参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_Instanceof</span>(env, args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM InstanceOf fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM InstanceOf：%{public}d"</span>, result);</li><li>    }</li><li>    JSVM_Value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, result, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li><li><span class="hljs-comment">// InstanceOf注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = InstanceOf},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// InstanceOf方法别名，TS侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"instanceOf"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(class Person {</span></li><li><span class="hljs-string">        name;</span></li><li><span class="hljs-string">        age;</span></li><li><span class="hljs-string">        constructor(name, age) {</span></li><li><span class="hljs-string">          this.name = name;</span></li><li><span class="hljs-string">          this.age = age;</span></li><li><span class="hljs-string">        }</span></li><li><span class="hljs-string">      }</span></li><li><span class="hljs-string">     instanceOf(new Person('Alice', 30), Person);</span></li><li><span class="hljs-string">     ;)JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">InstanceOf</span>：<span class="hljs-number">1</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_typetagobject">OH_JSVM_TypeTagObject<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_typetagobject" tips="复制节点链接"></i></h3><p>使用类型标签type_tag来标记JavaScript对象，这样在后续操作中可以更精确地识别JavaScript对象。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_checkobjecttypetag">OH_JSVM_CheckObjectTypeTag<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_checkobjecttypetag" tips="复制节点链接"></i></h3><p>检查给定的类型标签是否与对象上的类型标签匹配。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUMBERINT_FOUR 4</span></li><li><span class="hljs-comment">// 定义一个静态常量JSVM_TypeTag数组存储类型标签</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> JSVM_TypeTag TagsData[NUMBERINT_FOUR] = {</li><li>    {<span class="hljs-number">0x9e4b2449547061b3</span>, <span class="hljs-number">0x33999f8a6516c499</span>},</li><li>    {<span class="hljs-number">0x1d55a794c53a726d</span>, <span class="hljs-number">0x43633f509f9c944e</span>},</li><li>    {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>}, <span class="hljs-comment">// 用于表示无标签或默认标签</span></li><li>    {<span class="hljs-number">0x6a971439f5b2e5d7</span>, <span class="hljs-number">0x531dc28a7e5317c0</span>},</li><li>};</li><li><span class="hljs-comment">// OH_JSVM_TypeTagObject的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">SetTypeTagToObject</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取两个JavaScript侧传入的参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取索引数字转换为JSVM_Value</span></li><li>    <span class="hljs-type">int32_t</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, args[<span class="hljs-number">1</span>], &amp;index);</li><li>    <span class="hljs-comment">// 给参数（对象）设置类型标签</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_TypeTagObject</span>(env, args[<span class="hljs-number">0</span>], &amp;TagsData[index]);</li><li>    <span class="hljs-comment">// 将bool结果转换为JSVM_Value并返回</span></li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM SetTypeTagToObject fail"</span>);</li><li>        <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">false</span>, &amp;result);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM SetTypeTagToObject success"</span>);</li><li>        <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;result);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// OH_JSVM_CheckObjectTypeTag的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CheckObjectTypeTag</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取两个JavaScript侧传入的参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取索引数字转换为JSVM_Value</span></li><li>    <span class="hljs-type">int32_t</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, args[<span class="hljs-number">1</span>], &amp;index);</li><li>    <span class="hljs-comment">// 检查对象的类型标签</span></li><li>    <span class="hljs-type">bool</span> checkResult = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CheckObjectTypeTag</span>(env, args[<span class="hljs-number">0</span>], &amp;TagsData[index], &amp;checkResult);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM CheckObjectTypeTag fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CheckObjectTypeTag:%{public}d"</span>, checkResult);</li><li>    }</li><li>    <span class="hljs-comment">// 将bool结果转换为JSVM_Value并返回</span></li><li>    JSVM_Value checked = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, checkResult, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li><span class="hljs-comment">// SetTypeTagToObject，CheckObjectTypeTag注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = SetTypeTagToObject},</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CheckObjectTypeTag},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// SetTypeTagToObject，CheckObjectTypeTag方法别名，TS侧调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"setTypeTagToObject"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"checkObjectTypeTag"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">         class Obj {</span></li><li><span class="hljs-string">           data;</span></li><li><span class="hljs-string">           message;</span></li><li><span class="hljs-string">         }</span></li><li><span class="hljs-string">         let obj= { data: 0, message: "hello world"};</span></li><li><span class="hljs-string">         setTypeTagToObject(obj, 0);</span></li><li><span class="hljs-string">         checkObjectTypeTag(obj,0);)JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">SetTypeTagToObject</span> success</li><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">CheckObjectTypeTag</span>:<span class="hljs-number">1</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createexternal">OH_JSVM_CreateExternal<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createexternal" tips="复制节点链接"></i></h3><p>创建一个包装了外部指针的JavaScript对象。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>JavaScript对象被垃圾回收时，包装的外部指针指向的内容不被GC直接管理，仅调用传入的第三个参数对应的函数（如果传入时不为nullptr）。</p>  </div></div></div> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreateExternal的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateExternal</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> dataSize = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">malloc</span>(dataSize);</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Failed to malloc."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(data, <span class="hljs-number">0</span>, dataSize);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    JSVM_Value external = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateExternal</span>(</li><li>        env, data, [](JSVM_Env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint) {<span class="hljs-built_in">free</span>(data);}, (<span class="hljs-type">void</span> *)testStr, &amp;external);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Failed to create external data, status:%{public}d."</span>, status);</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        data = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateExternal success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> external;</li><li>}</li><li><span class="hljs-comment">// CreateExternal注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateExternal},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateExternal方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createExternal"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(createExternal())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">CreateExternal</span> success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_getvalueexternal">OH_JSVM_GetValueExternal<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_getvalueexternal" tips="复制节点链接"></i></h3><p>OH_JSVM_CreateExternal可以创建并包装自定义的C/C++对象，并将其公开给JavaScript代码，而OH_JSVM_GetValueExternal则用于获取OH_JSVM_CreateExternal所包装的外部对象的指针。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_GetValueExternal的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetValueExternal</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> data = <span class="hljs-number">0x12345</span>;</li><li>    JSVM_Value externalValue = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateExternal</span>(env, (<span class="hljs-type">void</span>*)&amp;data, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;externalValue);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CreateExternal fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CreateExternal success"</span>);</li><li>    }</li><li>    <span class="hljs-type">void</span> *data_value;</li><li>    status = <span class="hljs-built_in">OH_JSVM_GetValueExternal</span>(env, externalValue, &amp;data_value);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueExternal fail"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM GetValueExternal success"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 将符号位转化为int类型传出去</span></li><li>    JSVM_Value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int</span> retData = *<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span> *&gt;(data_value);</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, retData, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li><li><span class="hljs-comment">// GetValueExternal注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = GetValueExternal},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// GetValueExternal方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"getValueExternal"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(getValueExternal())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> OH_JSVM_CreateExternal success</li><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">GetValueExternal</span> success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createsymbol">OH_JSVM_CreateSymbol<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createsymbol" tips="复制节点链接"></i></h3><p>用于创建一个新的Symbol。Symbol是一种特殊的数据类型，用于表示唯一的标识符。与字符串或数字不同，符号的值是唯一的，即使两个符号具有相同的描述，它们也是不相等的。符号通常用作对象属性的键，以确保属性的唯一性。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_CreateSymbol的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateSymbol</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *des = <span class="hljs-string">"only"</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, des, JSVM_AUTO_LENGTH, &amp;result);</li><li>    JSVM_Value returnSymbol = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateSymbol</span>(env, result, &amp;returnSymbol);</li><li>    JSVM_ValueType valuetypeSymbol;</li><li>    <span class="hljs-built_in">OH_JSVM_Typeof</span>(env, returnSymbol, &amp;valuetypeSymbol);</li><li>    <span class="hljs-keyword">if</span> (valuetypeSymbol == JSVM_SYMBOL) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateSymbol Success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM CreateSymbol fail"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> returnSymbol;</li><li>}</li><li><span class="hljs-comment">// CreateSymbol注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = CreateSymbol},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateSymbol方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"createSymbol"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(createSymbol())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">CreateSymbol</span> <span class="hljs-title class_">Success</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_symbolfor">OH_JSVM_SymbolFor<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_symbolfor" tips="复制节点链接"></i></h3><p>在全局注册表中搜索具有给定描述的现有Symbol，如果该Symbol已经存在，它将被返回，否则将在注册表中创建一个新Symbol。</p> <p>cpp部分代码：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// 定义一个常量，用于存储最大字符串长度</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> MAX_BUFFER_SIZE = <span class="hljs-number">128</span>;</li><li><span class="hljs-comment">// OH_JSVM_SymbolFor的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">SymbolFor</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Value description = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"test_demo"</span>, <span class="hljs-number">9</span>, &amp;description);</li><li>    <span class="hljs-type">char</span> buffer[MAX_BUFFER_SIZE];</li><li>    <span class="hljs-type">size_t</span> bufferSize = MAX_BUFFER_SIZE;</li><li>    <span class="hljs-type">size_t</span> copied = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, description, buffer, bufferSize, &amp;copied);</li><li>    JSVM_Value symbol = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateSymbol</span>(env, description, &amp;symbol);</li><li>    JSVM_Value result_symbol = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_SymbolFor</span>(env, buffer, copied, &amp;result_symbol);</li><li>    JSVM_ValueType valuetypeSymbol;</li><li>    <span class="hljs-built_in">OH_JSVM_Typeof</span>(env, result_symbol, &amp;valuetypeSymbol);</li><li>    <span class="hljs-keyword">if</span> (valuetypeSymbol == JSVM_SYMBOL &amp;&amp; status == JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_SymbolFor success"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 返回结果</span></li><li>    <span class="hljs-keyword">return</span> result_symbol;</li><li>}</li><li><span class="hljs-comment">// SymbolFor注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = SymbolFor},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// SymbolFor方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"symbolFor"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(symbolFor())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果：</p> <div _ngcontent-ibg-c106="" class="highlight-div"><div _ngcontent-ibg-c106="" class="highlight-div-header"><div _ngcontent-ibg-c106="" class="highlight-div-header-left"><div _ngcontent-ibg-c106="" class="handle-button expand-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ibg-c106="" class="highlight-div-header-right"><div _ngcontent-ibg-c106="" class="handle-button ai-button"></div><div _ngcontent-ibg-c106="" class="handle-button line-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ibg-c106="" class="handle-button theme-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ibg-c106="" class="handle-button copy-button"><div _ngcontent-ibg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ibg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JSVM</span> OH_JSVM_SymbolFor success</li></ol></pre></div></div> </div> </div> <div></div></div>