<h1 _ngcontent-lte-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行private相关开发"> 使用JSVM-API接口进行private相关开发 </h1>

<div _ngcontent-lte-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API 提供操作私有属性的接口。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>JSVM-API提供创建private key的能力，并支持在对象上使用该key进行属性的创建与删除，同时持久化保存private key symbol。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateDataReference</td> <td class="cellrowborder" valign="top" width="50%">在JSVM中创建一个带有指定引用计数的数据引用。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetReferenceData</td> <td class="cellrowborder" valign="top" width="50%">检查指定的引用是否有效, 返回该引用关联的JavaScript数据, 无效result设置为NULL。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreatePrivate</td> <td class="cellrowborder" valign="top" width="50%">创建一个js private key对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetPrivate</td> <td class="cellrowborder" valign="top" width="50%">为传入的object设置一个private属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetPrivate</td> <td class="cellrowborder" valign="top" width="50%">获取传入的object中private key对应的private属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DeletePrivate</td> <td class="cellrowborder" valign="top" width="50%">删除传入的object中private key对应的private属性。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="使用接口创建-private-key-并添加对应-private-property随后删除" class="firsth2">使用接口创建 private key 并添加对应 private property，随后删除<i class="anchor-icon anchor-icon-link" anchorid="使用接口创建-private-key-并添加对应-private-property随后删除" tips="复制节点链接"></i></h3><p>cpp部分代码</p> <div _ngcontent-lte-c106="" class="highlight-div"><div _ngcontent-lte-c106="" class="highlight-div-header"><div _ngcontent-lte-c106="" class="highlight-div-header-left"><div _ngcontent-lte-c106="" class="handle-button expand-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lte-c106="" class="highlight-div-header-right"><div _ngcontent-lte-c106="" class="handle-button ai-button"></div><div _ngcontent-lte-c106="" class="handle-button line-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lte-c106="" class="handle-button theme-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lte-c106="" class="handle-button copy-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lte-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">privateTest</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_VM vm;</li><li>    JSVM_HandleScope outerScope;</li><li>    <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;outerScope);</li><li>
</li><li>    JSVM_HandleScope handleScope;</li><li>    JSVM_Data privateKey;</li><li>    JSVM_Value object;</li><li>    JSVM_Value property;</li><li>    JSVM_Ref privateRef;</li><li>    {</li><li>        <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>        <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;object);</li><li>        <span class="hljs-built_in">OH_JSVM_CreatePrivate</span>(env, <span class="hljs-literal">nullptr</span>, &amp;privateKey);</li><li>        <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">1</span>, &amp;property);</li><li>        <span class="hljs-built_in">OH_JSVM_SetPrivate</span>(env, object, privateKey, property);</li><li>        <span class="hljs-built_in">OH_JSVM_GetPrivate</span>(env, object, privateKey, &amp;property);</li><li>        <span class="hljs-type">int</span> propertyValue = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, property, &amp;propertyValue);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"private property set: %{public}d\n"</span>, propertyValue);</li><li>        <span class="hljs-built_in">OH_JSVM_DeletePrivate</span>(env, object, privateKey);</li><li>        <span class="hljs-built_in">OH_JSVM_GetPrivate</span>(env, object, privateKey, &amp;property);</li><li>        <span class="hljs-type">bool</span> isUndefined = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_IsUndefined</span>(env, property, &amp;isUndefined);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"private property deleted is undefined: %{public}d\n"</span>, isUndefined);</li><li>        <span class="hljs-built_in">OH_JSVM_CreateDataReference</span>(env, privateKey, <span class="hljs-number">1</span>, &amp;privateRef);</li><li>        <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>    }</li><li>    {</li><li>        <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>        <span class="hljs-built_in">OH_JSVM_GetReferenceData</span>(env, privateRef, &amp;privateKey);</li><li>        <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;object);</li><li>        <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">2</span>, &amp;property);</li><li>        <span class="hljs-built_in">OH_JSVM_SetPrivate</span>(env, object, privateKey, property);</li><li>        <span class="hljs-built_in">OH_JSVM_GetPrivate</span>(env, object, privateKey, &amp;property);</li><li>        <span class="hljs-type">int</span> propertyValue = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, property, &amp;propertyValue);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"second private property set: %{public}d\n"</span>, propertyValue);</li><li>        <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, outerScope);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = privateTest},</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-comment">// wrapperObject方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"privateTest"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试JS</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(privateTest();)JS"</span>;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="预期输出结果">预期输出结果<i class="anchor-icon anchor-icon-link" anchorid="预期输出结果" tips="复制节点链接"></i></h2><div _ngcontent-lte-c106="" class="highlight-div"><div _ngcontent-lte-c106="" class="highlight-div-header"><div _ngcontent-lte-c106="" class="highlight-div-header-left"><div _ngcontent-lte-c106="" class="handle-button expand-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lte-c106="" class="highlight-div-header-right"><div _ngcontent-lte-c106="" class="handle-button ai-button"></div><div _ngcontent-lte-c106="" class="handle-button line-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lte-c106="" class="handle-button theme-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lte-c106="" class="handle-button copy-button"><div _ngcontent-lte-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lte-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-vbnet" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">property</span> <span class="hljs-keyword">set</span>: <span class="hljs-number">1</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">property</span> deleted <span class="hljs-built_in">is</span> undefined: <span class="hljs-number">1</span></li><li>second <span class="hljs-keyword">private</span> <span class="hljs-keyword">property</span> <span class="hljs-keyword">set</span>: <span class="hljs-number">2</span></li></ol></pre></div></div> </div> </div> <div></div></div>