<h1 _ngcontent-vhw-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行任务队列相关开发"> 使用JSVM-API接口进行任务队列相关开发 </h1>

<div _ngcontent-vhw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>在虚拟机内启动任务队列，检查队列中是否有待处理的微任务。任务队列可由外部事件循环执行。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><ul><li><strong>任务队列</strong>：用于管理异步任务的调度和执行，确保任务按顺序处理。</li><li><strong>微任务</strong>：微任务是一种任务调度机制，主要用于处理那些需要尽快执行的较小任务，它们通常具有较高的优先级。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_PumpMessageLoop</td> <td class="cellrowborder" valign="top" width="50%">启动任务队列的运行</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_PerformMicrotaskCheckpoint</td> <td class="cellrowborder" valign="top" width="50%">执行任务队列里的微任务</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetMicrotaskPolicy</td> <td class="cellrowborder" valign="top" width="50%">设置微任务执行策略</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅展示接口对应的C++相关代码。</p> <p>权限要求：Wasm字节码需要应用拥有JIT权限才能执行，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-apply-jit-profile">JSVM 申请JIT权限指导</a>申请对应权限。</p> <p>运行限制：当前 JSVM 版本在坚盾守护模式下将禁用 WebAssembly 全部功能模块。开发者需针对此限制进行应用兼容性评估，具体技术规范详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-secure-shield-mode">JSVM 坚盾守护模式</a>。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_pumpmessageloop--oh_jsvm_performmicrotaskcheckpoint" class="firsth2">OH_JSVM_PumpMessageLoop &amp; OH_JSVM_PerformMicrotaskCheckpoint<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_pumpmessageloop--oh_jsvm_performmicrotaskcheckpoint" tips="复制节点链接"></i></h3><p>启动任务队列，执行任务。</p> <p>cpp部分代码：</p> <div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> g_aa = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// 待执行的js代码</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *STR_TASK = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">    // wasm 字节码 (以add 模块为例)</span></li><li><span class="hljs-string">    // 以下 wasmBuffer 对应的 wasm 字节码文本格式如下所示，只包含了一个函数 add</span></li><li><span class="hljs-string">    // (module</span></li><li><span class="hljs-string">    //   (func $add (param $lhs i32) (param $rhs i32) (result i32)</span></li><li><span class="hljs-string">    //     local.get $lhs</span></li><li><span class="hljs-string">    //     local.get $rhs</span></li><li><span class="hljs-string">    //     i32.add</span></li><li><span class="hljs-string">    //   )</span></li><li><span class="hljs-string">    //   (export "add" (func $add))</span></li><li><span class="hljs-string">    // )</span></li><li><span class="hljs-string">    var wasmBytes = new Uint8Array([0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x07, 0x01,</span></li><li><span class="hljs-string">                                       0x60, 0x02, 0x7f, 0x7f, 0x01, 0x7f, 0x03, 0x02, 0x01, 0x00, 0x07,</span></li><li><span class="hljs-string">                                       0x07, 0x01, 0x03, 0x61, 0x64, 0x64, 0x00, 0x00, 0x0a, 0x09, 0x01,</span></li><li><span class="hljs-string">                                       0x07, 0x00, 0x20, 0x00, 0x20, 0x01, 0x6a, 0x0b]);</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">    var p = WebAssembly.instantiate(wasmBytes, {});</span></li><li><span class="hljs-string">    p.then((result) =&gt; {</span></li><li><span class="hljs-string">        consoleinfo("Called with instance " + result);</span></li><li><span class="hljs-string">    });</span></li><li><span class="hljs-string">    p.finally(() =&gt; {</span></li><li><span class="hljs-string">       consoleinfo("Called Finally");</span></li><li><span class="hljs-string">    });</span></li><li><span class="hljs-string">)JS"</span>;</li><li>
</li><li><span class="hljs-comment">// 保证js代码中的打印信息可以正常输出</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">ConsoleInfo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">char</span> log[<span class="hljs-number">256</span>] = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-type">size_t</span> logLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>));</li><li>
</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, args[<span class="hljs-number">0</span>], log, <span class="hljs-number">255</span>, &amp;logLength);</li><li>    log[<span class="hljs-number">255</span>] = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM API TEST: %{public}s"</span>, log);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册consoleinfo的方法</span></li><li>JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = ConsoleInfo},</li><li>};</li><li>JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"consoleinfo"</span>, <span class="hljs-literal">NULL</span>, &amp;param[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span> </span>{</li><li>    JSVM_InitOptions init_options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;init_options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(init_options));</li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;init_options);</li><li>        g_aa++;</li><li>    }</li><li>    <span class="hljs-comment">// 创建JavaScript虚拟机实例,打开虚拟机作用域</span></li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions options;</li><li>    <span class="hljs-built_in">memset</span>(&amp;options, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(options));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;options, &amp;vm));</li><li>    JSVM_VMScope vm_scope;</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vm_scope));</li><li>    </li><li>    JSVM_Env env;</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env));</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    JSVM_HandleScope handlescope;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handlescope));</li><li>    JSVM_Value sourcecodevalue;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, STR_TASK, <span class="hljs-built_in">strlen</span>(STR_TASK), &amp;sourcecodevalue));</li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, sourcecodevalue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    JSVM_Value result;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>    <span class="hljs-type">bool</span> rst = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">auto</span> start = std::chrono::system_clock::<span class="hljs-built_in">now</span>();</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</li><li>        <span class="hljs-comment">// 如果任务队列中没有任务启动，则rst设置为false</span></li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PumpMessageLoop</span>(vm, &amp;rst));</li><li>        <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PerformMicrotaskCheckpoint</span>(vm));</li><li>        <span class="hljs-comment">// 定时退出</span></li><li>        <span class="hljs-keyword">auto</span> now = std::chrono::system_clock::<span class="hljs-built_in">now</span>();</li><li>        <span class="hljs-keyword">auto</span> cost = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(now - start).<span class="hljs-built_in">count</span>();</li><li>        <span class="hljs-keyword">if</span> (cost &gt; <span class="hljs-number">100</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 关闭并销毁环境和虚拟机</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handlescope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vm_scope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">API</span> <span class="hljs-variable">TEST</span>: <span class="hljs-title class_">Called</span> <span class="hljs-title class_">with</span> <span class="hljs-title class_">instance</span> [<span class="hljs-title class_">object</span> <span class="hljs-title class_">Object</span>]</li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">API</span> <span class="hljs-variable">TEST</span>: <span class="hljs-title class_">Called</span> <span class="hljs-title class_">Finally</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_setmicrotaskpolicy">OH_JSVM_SetMicrotaskPolicy<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_setmicrotaskpolicy" tips="复制节点链接"></i></h3><p>修改微任务执行策略，通过该接口，用户可以将策略设置为 JSVM_MicrotaskPolicy::JSVM_MICROTASK_EXPLICIT 或 JSVM_MicrotaskPolicy::JSVM_MICROTASK_AUTO。默认模式下，微任务的执行策略为 JSVM_MicrotaskPolicy::JSVM_MICROTASK_AUTO。</p> <p>微任务策略：</p> <ul><li>JSVM_MicrotaskPolicy::JSVM_MICROTASK_EXPLICIT ： 微任务在用户调用 OH_JSVM_PerformMicrotaskCheckpoint 后执行</li><li>JSVM_MicrotaskPolicy::JSVM_MICROTASK_AUTO： 微任务在 JS 调用栈为空时自动执行</li></ul> <p>cpp 部分代码</p> <div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// OH_JSVM_SetMicrotaskPolicy的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">SetMicrotaskPolicy</span><span class="hljs-params">(JSVM_VM vm, JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-comment">// 默认或将策略设置为 JSVM_MICROTASK_AUTO 的行为</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *scriptEvalMicrotask = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">        evaluateMicrotask = false;</span></li><li><span class="hljs-string">        Promise.resolve().then(()=&gt;{</span></li><li><span class="hljs-string">            evaluateMicrotask = true;</span></li><li><span class="hljs-string">        });</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, scriptEvalMicrotask, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>    JSVM_Value global;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;global));</li><li>    JSVM_Value hasEvaluateMicrotask;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"evaluateMicrotask"</span>, &amp;hasEvaluateMicrotask));</li><li>    <span class="hljs-type">bool</span> val = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, hasEvaluateMicrotask, &amp;val));</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Policy :JSVM_MICROTASK_AUTO, evaluateMicrotask : %{public}d"</span>, val);</li><li>
</li><li>    <span class="hljs-comment">// 策略设置为 JSVM_MICROTASK_EXPLICIT 的行为</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_SetMicrotaskPolicy</span>(vm, JSVM_MicrotaskPolicy::JSVM_MICROTASK_EXPLICIT));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"evaluateMicrotask"</span>, &amp;hasEvaluateMicrotask));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, hasEvaluateMicrotask, &amp;val));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(</li><li>        LOG_APP,</li><li>        <span class="hljs-string">"Policy :JSVM_MICROTASK_AUTO, evaluateMicrotask before calling OH_JSVM_PerformMicrotaskCheckpoint: %{public}d"</span>,</li><li>        val);</li><li>
</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_PerformMicrotaskCheckpoint</span>(vm));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetNamedProperty</span>(env, global, <span class="hljs-string">"evaluateMicrotask"</span>, &amp;hasEvaluateMicrotask));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetValueBool</span>(env, hasEvaluateMicrotask, &amp;val));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(</li><li>        LOG_APP,</li><li>        <span class="hljs-string">"Policy :JSVM_MICROTASK_AUTO, evaluateMicrotask after calling OH_JSVM_PerformMicrotaskCheckpoint: %{public}d"</span>,</li><li>        val);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunDemo</span><span class="hljs-params">(JSVM_VM vm, JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">SetMicrotaskPolicy</span>(vm, env) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Run Microtask Policy failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span> </span>{</li><li>    JSVM_InitOptions initOptions = {<span class="hljs-number">0</span>};</li><li>    JSVM_VM vm;</li><li>    JSVM_Env env = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 初始化JavaScript引擎实例</span></li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        g_aa++;</li><li>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions));</li><li>    }</li><li>    <span class="hljs-comment">// 创建JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>
</li><li>    <span class="hljs-comment">// 通过script调用测试函数</span></li><li>    <span class="hljs-built_in">RunDemo</span>(vm, env);</li><li>
</li><li>    <span class="hljs-comment">// 销毁JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>预期输出结果：</p> <div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Policy</span> :<span class="hljs-title class_">JSVM_MICROTASK_AUTO</span>, <span class="hljs-variable">evaluateMicrotask</span> : <span class="hljs-number">1</span></li><li><span class="hljs-variable">Policy</span> :<span class="hljs-title class_">JSVM_MICROTASK_AUTO</span>, <span class="hljs-variable">evaluateMicrotask</span> <span class="hljs-variable">before</span> <span class="hljs-variable">calling</span> <span class="hljs-variable">OH_JSVM_PerformMicrotaskCheckpoint</span>: <span class="hljs-number">0</span></li><li><span class="hljs-variable">Policy</span> :<span class="hljs-title class_">JSVM_MICROTASK_AUTO</span>, <span class="hljs-variable">evaluateMicrotask</span> <span class="hljs-variable">after</span> <span class="hljs-variable">calling</span> <span class="hljs-variable">OH_JSVM_PerformMicrotaskCheckpoint</span>: <span class="hljs-number">1</span></li></ol></pre></div></div> </div> </div> <div></div></div>