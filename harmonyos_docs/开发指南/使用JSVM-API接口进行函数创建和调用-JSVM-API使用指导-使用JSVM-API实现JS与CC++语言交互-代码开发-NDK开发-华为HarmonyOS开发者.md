<h1 _ngcontent-ypi-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行函数创建和调用"> 使用JSVM-API接口进行函数创建和调用 </h1>

<div _ngcontent-ypi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>函数调用允许开发者从JSVM模块中调用JavaScript函数，并传参，或者直接在JSVM模块中创建一个JavaScript函数。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>函数是一种重要的编程概念，用于执行特定任务，提升代码可读性与复用性，简化复杂操作，并实现代码的模块化和结构化，便于理解、维护和扩展。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetCbInfo</td> <td class="cellrowborder" valign="top" width="50%">从给定的callback info中获取有关调用的详细信息，如参数和this指针。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CallFunction</td> <td class="cellrowborder" valign="top" width="50%">在C/C++侧调用JavaScript方法。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsFunction</td> <td class="cellrowborder" valign="top" width="50%">判断对象是否为函数对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateFunction</td> <td class="cellrowborder" valign="top" width="50%">用于创建JavaScript函数,用于从JavaScript环境中调用C/C++代码中的函数, 需要设置到一个JavaScript对象中才可以进行调用。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm-function整合测试" class="firsth2">OH_JSVM function整合测试<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm-function整合测试" tips="复制节点链接"></i></h3><p>cpp测试全量代码，入口为TEST_FUNC</p> <div _ngcontent-ypi-c106="" class="highlight-div"><div _ngcontent-ypi-c106="" class="highlight-div-header"><div _ngcontent-ypi-c106="" class="highlight-div-header-left"><div _ngcontent-ypi-c106="" class="handle-button expand-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ypi-c106="" class="highlight-div-header-right"><div _ngcontent-ypi-c106="" class="handle-button ai-button"></div><div _ngcontent-ypi-c106="" class="handle-button line-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ypi-c106="" class="handle-button theme-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ypi-c106="" class="handle-button copy-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ypi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"APP"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_RET(cond) \</span></li><li><span class="hljs-meta">  <span class="hljs-keyword">if</span> ((cond)) { \</span></li><li><span class="hljs-meta">    const JSVM_ExtendedErrorInfo* info; \</span></li><li><span class="hljs-meta">    OH_JSVM_GetLastErrorInfo(env, &amp;info); \</span></li><li><span class="hljs-meta">    OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d message = %{public}s"</span>, __FILE__, __LINE__, cond, info != nullptr ? info-&gt;errorMessage : <span class="hljs-string">""</span>); \</span></li><li><span class="hljs-meta">    return -1;   \</span></li><li><span class="hljs-meta">  }</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK(cond) \</span></li><li><span class="hljs-meta">  <span class="hljs-keyword">if</span> (!(cond)) { \</span></li><li><span class="hljs-meta">     OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d"</span>, __FILE__, __LINE__, cond); \</span></li><li><span class="hljs-meta">     return -1;   \</span></li><li><span class="hljs-meta">  }</span></li><li>
</li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">NativeCreateFunctionTest</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    JSVM_Value thisArg;</li><li>    <span class="hljs-comment">// 获取callback 参数信息</span></li><li>    JSVM_Status ret = <span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, &amp;argv[<span class="hljs-number">0</span>], &amp;thisArg, &amp;data);</li><li>    <span class="hljs-keyword">if</span> (ret != JSVM_OK) {</li><li>      <span class="hljs-type">const</span> JSVM_ExtendedErrorInfo* info;</li><li>      <span class="hljs-built_in">OH_JSVM_GetLastErrorInfo</span>(env, &amp;info);</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d message = %{public}s"</span>, __FILE__, __LINE__, ret, info != <span class="hljs-literal">nullptr</span> ? info-&gt;errorMessage : <span class="hljs-string">""</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">char</span> message[<span class="hljs-number">256</span>];</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringLatin1</span>(env, argv[<span class="hljs-number">0</span>], message, <span class="hljs-number">256</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"jsvm: %{public}s; callback data null"</span>, message);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"jsvm: %{public}s; %{public}s"</span>, message, (<span class="hljs-type">char</span>*)data);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TEST_FUNC</span><span class="hljs-params">()</span> </span>{</li><li>    JSVM_InitOptions initOptions{};</li><li>    JSVM_VM vm;</li><li>    JSVM_Env env = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">bool</span> isVMInit = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">if</span> (!isVMInit) {</li><li>        isVMInit = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-comment">// 单个进程只用初始化一次</span></li><li>        <span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions);</li><li>    }</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;env));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>
</li><li>    <span class="hljs-comment">// 创建并检查函数</span></li><li>    <span class="hljs-type">char</span> hello[] = <span class="hljs-string">"Hello World!"</span>;</li><li>    JSVM_CallbackStruct cb = {NativeCreateFunctionTest, (<span class="hljs-type">void</span>*)hello};</li><li>    JSVM_Value func;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateFunction</span>(env, <span class="hljs-string">""</span>, JSVM_AUTO_LENGTH, &amp;cb, &amp;func));</li><li>    <span class="hljs-type">bool</span> isFunction = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_IsFunction</span>(env, func, &amp;isFunction));</li><li>    <span class="hljs-built_in">CHECK</span>(isFunction);</li><li>
</li><li>    <span class="hljs-comment">// 将函数设置到全局对象中</span></li><li>    JSVM_Value global;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_GetGlobal</span>(env, &amp;global));</li><li>    JSVM_Value key;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"NativeFunc"</span>, JSVM_AUTO_LENGTH, &amp;key));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_SetProperty</span>(env, global, key, func));</li><li>
</li><li>    <span class="hljs-comment">// 通过call 接口调用函数</span></li><li>    JSVM_Value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"jsvm api call function"</span>, JSVM_AUTO_LENGTH, &amp;argv[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CallFunction</span>(env, global, func, <span class="hljs-number">1</span>, argv, &amp;result));</li><li>
</li><li>    <span class="hljs-comment">// 通过script调用函数</span></li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(NativeFunc('js source call function');)JS"</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcCallNative, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <p>预期的输出</p> <div _ngcontent-ypi-c106="" class="highlight-div"><div _ngcontent-ypi-c106="" class="highlight-div-header"><div _ngcontent-ypi-c106="" class="highlight-div-header-left"><div _ngcontent-ypi-c106="" class="handle-button expand-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ypi-c106="" class="highlight-div-header-right"><div _ngcontent-ypi-c106="" class="handle-button ai-button"></div><div _ngcontent-ypi-c106="" class="handle-button line-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ypi-c106="" class="handle-button theme-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ypi-c106="" class="handle-button copy-button"><div _ngcontent-ypi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ypi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">jsvm</span>: <span class="hljs-title class_">jsvm</span> <span class="hljs-title class_">api</span> <span class="hljs-title class_">call</span> <span class="hljs-title class_">function</span>; <span class="hljs-title class_">Hello</span> <span class="hljs-title class_">World</span>!</li><li><span class="hljs-variable">jsvm</span>: <span class="hljs-title class_">js</span> <span class="hljs-title class_">source</span> <span class="hljs-title class_">call</span> <span class="hljs-title class_">function</span>; <span class="hljs-title class_">Hello</span> <span class="hljs-title class_">World</span>!</li></ol></pre></div></div> </div> </div> <div></div></div>