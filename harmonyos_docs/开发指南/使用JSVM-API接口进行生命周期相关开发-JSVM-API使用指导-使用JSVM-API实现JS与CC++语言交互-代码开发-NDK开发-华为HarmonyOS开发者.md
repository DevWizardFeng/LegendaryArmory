<h1 _ngcontent-xtq-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行生命周期相关开发"> 使用JSVM-API接口进行生命周期相关开发 </h1>

<div _ngcontent-xtq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>在JSVM-API中，JSVM_Value是一个表示JavaScript值的抽象类型，它可以表示任何JavaScript值，包括基本类型（如数字、字符串、布尔值）和对象类型（如数组、函数、对象等）。</p> <p>JSVM_Value的生命周期与JavaScript值的生命周期相关。JavaScript值被垃圾回收后，JSVM_Value将不再有效。避免在JavaScript值不存在时使用JSVM_Value。</p> <p>框架层的scope通常用于管理JSVM_Value的生命周期。在JSVM-API中，可以使用OH_JSVM_OpenHandleScope和OH_JSVM_CloseHandleScope函数来创建和销毁scope。通过在scope内创建JSVM_Value，可以确保在scope结束时自动释放JSVM_Value，避免内存泄漏。</p> <p>JSVM_Ref是一个JSVM-API类型，用于管理JSVM_Value的生命周期。JSVM_Ref允许您在JSVM_Value的生命周期内保持对其的引用，即使它已经超出了其原始上下文的范围。这使得您可以在不同的上下文中共享JSVM_Value，并确保在不再需要时正确释放其内存。</p> <p>合理使用OH_JSVM_OpenHandleScope和OH_JSVM_CloseHandleScope管理JSVM_Value的生命周期，避免发生内存泄漏问题。</p> <p>每个JSVM_Value属于特定的HandleScope，HandleScope通过OH_JSVM_OpenHandleScope和OH_JSVM_CloseHandleScope来建立和关闭，HandleScope关闭后，所属的JSVM_Value就会自动释放。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>JSVM-API提供了一组功能，使开发人员能够在JSVM-API模块中创建和操作JavaScript对象，管理引用和生命周期，并注册垃圾回收回调函数等。下面是一些基本概念：</p> <ul><li><strong>作用域</strong>：用于创建一个范围，在范围内声明的引用在范围外部将不再生效。JSVM-API提供了创建、关闭普通和可逃逸的作用域的函数。</li><li><strong>引用管理</strong>：JSVM-API提供函数来创建、删除和管理对象的引用，以延长对象的生命周期，并避免在使用对象时发生内存泄漏。</li><li><strong>可逃逸的作用域</strong>：允许在创建的作用域中声明的对象返回到父作用域，通过OH_JSVM_OpenEscapableHandleScope和OH_JSVM_CloseEscapableHandleScope进行管理。</li><li><strong>垃圾回收回调</strong>：允许注册回调函数，以便在JavaScript对象被垃圾回收时执行特定的清理操作。</li></ul> <p>这些基本概念使开发人员安全且有效地操作JavaScript对象，并确保正确管理对象的生命周期。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenHandleScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个Handle scope，确保scope范围内的JSVM_Value不被GC回收。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseHandleScope</td> <td class="cellrowborder" valign="top" width="50%">关闭Handle scope。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_OpenEscapableHandleScope</td> <td class="cellrowborder" valign="top" width="50%">打开一个新的scope逃逸Handle scope，在关闭该scope之前创建的对象与父作用域有相同的生命周期。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CloseEscapableHandleScope</td> <td class="cellrowborder" valign="top" width="50%">关闭一个scope，在此scope范围外创建的对象不受父作用域保护。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_EscapeHandle</td> <td class="cellrowborder" valign="top" width="50%">将JavaScript对象的句柄提升到外部作用域，确保在外部作用域中可以持续地使用该对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateReference</td> <td class="cellrowborder" valign="top" width="50%">以指定的引用计数为JavaScript对象创建一个新的引用，该引用将指向传入的对象，引用允许在不同的上下文中使用和共享对象，并且可以有效地跟踪对象的生命周期。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_DeleteReference</td> <td class="cellrowborder" valign="top" width="50%">释放由OH_JSVM_CreateReference创建的引用，确保对象在不再被使用时能够被正确地释放和回收，避免内存泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReferenceRef</td> <td class="cellrowborder" valign="top" width="50%">增加由OH_JSVM_CreateReference创建的引用的引用计数，以确保对象在有引用时不会被提前释放。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ReferenceUnref</td> <td class="cellrowborder" valign="top" width="50%">减少引用计数，用于管理引用计数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_GetReferenceValue</td> <td class="cellrowborder" valign="top" width="50%">减少由OH_JSVM_CreateReference创建的引用的引用计数，以确保没有任何引用指向该对象时能正确地释放和回收。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AddFinalizer</td> <td class="cellrowborder" valign="top" width="50%">为对象添加JSVM_Finalize回调，以便在JavaScript对象被垃圾回收时调用来释放原生对象。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅展示接口对应的C++代码。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_openhandlescopeoh_jsvm_closehandlescope" class="firsth2">OH_JSVM_OpenHandleScope、OH_JSVM_CloseHandleScope<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_openhandlescopeoh_jsvm_closehandlescope" tips="复制节点链接"></i></h3><p>通过接口OH_JSVM_OpenHandleScope创建上下文环境，并使用OH_JSVM_CloseHandleScope关闭。这用于管理JavaScript对象的生命周期，确保在JSVM-API模块中正确处理JavaScript对象句柄，避免垃圾回收问题。</p> <p>cpp 部分代码：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// OH_JSVM_OpenHandleScope、OH_JSVM_CloseHandleScope的三种样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">HandleScopeFor</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// 在for循环中频繁调用JSVM接口创建js对象时，要加handle_scope及时释放不再使用的资源。</span></li><li>    <span class="hljs-comment">// 下面例子中，每次循环结束局部变量res的生命周期已结束，因此加scope及时释放其持有的js对象，防止内存泄漏</span></li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DIFF_VALUE_TEN_THOUSAND = <span class="hljs-number">10000</span>;</li><li>    JSVM_Value checked = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; DIFF_VALUE_TEN_THOUSAND; i++) {</li><li>        JSVM_HandleScope scope = <span class="hljs-literal">nullptr</span>;</li><li>        JSVM_Status status = <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;scope);</li><li>        <span class="hljs-keyword">if</span> (status != JSVM_OK || scope == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">false</span>, &amp;checked);</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_OpenHandleScope: failed"</span>);</li><li>            <span class="hljs-keyword">return</span> checked;</li><li>        }</li><li>        JSVM_Value res = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;res);</li><li>        status = <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, scope);</li><li>        <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CloseHandleScope: failed"</span>);</li><li>        }</li><li>    }</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM HandleScopeFor: success"</span>);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-comment">// HandleScopeFor注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.callback = HandleScopeFor, .data = <span class="hljs-literal">nullptr</span>},</li><li>};</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// HandleScopeFor方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"HandleScopeFor"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">"HandleScopeFor()"</span>;</li></ol></pre></div></div> <p>预期输出</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM HandleScopeFor:</span> <span class="hljs-string">success</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_openescapablehandlescopeoh_jsvm_closeescapablehandlescopeoh_jsvm_escapehandle">OH_JSVM_OpenEscapableHandleScope、OH_JSVM_CloseEscapableHandleScope、OH_JSVM_EscapeHandle<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_openescapablehandlescopeoh_jsvm_closeescapablehandlescopeoh_jsvm_escapehandle" tips="复制节点链接"></i></h3><p>通过接口 OH_JSVM_OpenEscapableHandleScope 创建出一个可逃逸的 handle scope，可将 1 个范围内声明的值返回到父作用域。创建的 scope 需使用 OH_JSVM_CloseEscapableHandleScope 进行关闭。OH_JSVM_EscapeHandle 将传入的 JavaScript 对象的生命周期提升到其父作用域。</p> <p>通过上述接口可以更灵活的使用管理传入的 JavaScript 对象，特别是在处理跨作用域的值传递时非常有用。</p> <p>cpp 部分代码：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// OH_JSVM_OpenEscapableHandleScope、OH_JSVM_CloseEscapableHandleScope、OH_JSVM_EscapeHandle的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">EscapableHandleScopeTest</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个可逃逸的句柄作用域</span></li><li>    JSVM_EscapableHandleScope scope = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_OpenEscapableHandleScope</span>(env, &amp;scope);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_OpenEscapableHandleScope: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 在可逃逸的句柄作用域内创建一个obj</span></li><li>    JSVM_Value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;obj);</li><li>    <span class="hljs-comment">// 在对象中添加属性</span></li><li>    JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Test jsvm_escapable_handle_scope"</span>, JSVM_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, obj, <span class="hljs-string">"name"</span>, value);</li><li>    <span class="hljs-comment">// 调用OH_JSVM_EscapeHandle将对象逃逸到作用域之外</span></li><li>    JSVM_Value escapedObj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_EscapeHandle</span>(env, scope, obj, &amp;escapedObj);</li><li>    <span class="hljs-comment">// 关闭可逃逸的句柄作用域，清理资源</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_CloseEscapableHandleScope</span>(env, scope);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CloseEscapableHandleScope: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 此时的escapedObj已逃逸，可以在作用域外继续使用escapedObj</span></li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"name"</span>, JSVM_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">OH_JSVM_HasProperty</span>(env, escapedObj, value, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (result) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM EscapableHandleScopeTest: success"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> escapedObj;</li><li>}</li><li>
</li><li><span class="hljs-comment">// EscapableHandleScopeTest注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.callback = EscapableHandleScopeTest, .data = <span class="hljs-literal">nullptr</span>},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// EscapableHandleScopeTest方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"escapableHandleScopeTest"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">"escapableHandleScopeTest()"</span>;</li></ol></pre></div></div> <p>预期输出</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM EscapableHandleScopeTest:</span> <span class="hljs-string">success</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_createreferenceoh_jsvm_deletereferenceoh_jsvm_getreferencevalue">OH_JSVM_CreateReference、OH_JSVM_DeleteReference、OH_JSVM_GetReferenceValue<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createreferenceoh_jsvm_deletereferenceoh_jsvm_getreferencevalue" tips="复制节点链接"></i></h3><ol><li>调用 OH_JSVM_CreateReference 为 JavaScript 变量创建一个引用，以延长其生命周期。</li><li>调用 OH_JSVM_GetReferenceValue 获取与引用关联的 JavaScript 变量。</li><li>调用 OH_JSVM_DeleteReference 删除传入的引用。</li></ol> <p>调用者需要自己管理引用生命周期，引用有效期间 JavaScript 变量不会被垃圾回收处理。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_referencerefoh_jsvm_referenceunref">OH_JSVM_ReferenceRef、OH_JSVM_ReferenceUnref<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_referencerefoh_jsvm_referenceunref" tips="复制节点链接"></i></h3><p>增加/减少传入的引用的引用计数，并获取新的计数。当引用计数被置为 0 后，对于可以被设置为弱引用的 JavaScript 类型（对象、函数、外部变量），引用将被置为弱引用，在垃圾回收机制认为必要的时候该变量会被回收，当变量被回收后，调用 OH_JSVM_GetReferenceValue 会获得 C NULL；对于不可被置为弱引用的 JavaScript 类型，该引用会被清除，调用 OH_JSVM_GetReferenceValue 会获得 C NULL。</p> <p>cpp 部分代码：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">UseReference</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建 JavaScript 对象</span></li><li>    JSVM_Value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;obj);</li><li>    JSVM_Value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"UseReference"</span>, JSVM_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">OH_JSVM_SetNamedProperty</span>(env, obj, <span class="hljs-string">"name"</span>, value);</li><li>    </li><li>    JSVM_Ref g_ref = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 创建对JavaScript对象的引用</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateReference</span>(env, obj, <span class="hljs-number">1</span>, &amp;g_ref);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 增加传入引用的引用计数并返回生成的引用计数</span></li><li>    <span class="hljs-type">uint32_t</span> result = <span class="hljs-number">0u</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_ReferenceRef</span>(env, g_ref, &amp;result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_ReferenceRef, count = %{public}d."</span>, result);</li><li>    <span class="hljs-keyword">if</span> (result != <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_ReferenceRef: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//  减少传入引用的引用计数并返回生成的引用计数</span></li><li>    <span class="hljs-type">uint32_t</span> num = <span class="hljs-number">0u</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_ReferenceUnref</span>(env, g_ref, &amp;num);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_ReferenceUnref, count = %{public}d."</span>, num);</li><li>    <span class="hljs-keyword">if</span> (num != <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    JSVM_Value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 通过调用OH_JSVM_GetReferenceValue获取引用的JavaScript对象</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_GetReferenceValue</span>(env, g_ref, &amp;object);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_GetReferenceValue: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 不再使用引用，通过调用OH_JSVM_DeleteReference删除对JavaScript对象的引用</span></li><li>    status = <span class="hljs-built_in">OH_JSVM_DeleteReference</span>(env, g_ref);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_DeleteReference: failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 将获取到的对象返回</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM UseReference success"</span>);</li><li>    <span class="hljs-keyword">return</span> object;</li><li>}</li><li>
</li><li><span class="hljs-comment">// CreateReference、UseReference、DeleteReference注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.callback = UseReference, .data = <span class="hljs-literal">nullptr</span>},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// CreateReference、UseReference、DeleteReference方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"useReference"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">"useReference()"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>JSVM OH_JSVM_ReferenceRef, count = 2.</li><li>JSVM OH_JSVM_ReferenceUnref, count = 1.</li><li>JSVM UseReference success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_addfinalizer">OH_JSVM_AddFinalizer<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_addfinalizer" tips="复制节点链接"></i></h3><p>为 JavaScript 对象添加 JSVM_Finalize 回调，当 JavaScript 对象被垃圾回收时执行函数回调，该接口通常被用于释放与 JavaScript 对象相关的原生对象。如果传入的参数类型不是 JavaScript 对象，该接口调用失败并返回错误码。</p> <p>Finalizer 方法被注册后无法取消，如果在调用 OH_JSVM_DestroyEnv 前均未被执行，则在 OH_JSVM_DestroyEnv 时执行。</p> <p>cpp 部分代码：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">AddFinalizer</span><span class="hljs-params">(JSVM_VM vm, JSVM_Env env)</span> </span>{</li><li>    <span class="hljs-comment">// 打开 handlescope</span></li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>    <span class="hljs-comment">// 创建 object 并设置回调</span></li><li>    JSVM_Value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateObject</span>(env, &amp;obj));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_AddFinalizer</span>(</li><li>        env, obj, <span class="hljs-literal">nullptr</span>,</li><li>        [](JSVM_Env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint) -&gt; <span class="hljs-type">void</span> {</li><li>            <span class="hljs-comment">// Finalizer 方法，可在该方法中清理 Native 对象</span></li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM: finalizer called."</span>);</li><li>        },</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM: finalizer added."</span>);</li><li>    <span class="hljs-comment">// 关闭 handlescope，触发 GC，GC 时 Finalizer 会被调用</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM: before call gc."</span>);</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_MemoryPressureNotification</span>(env, JSVM_MemoryPressureLevel::JSVM_MEMORY_PRESSURE_LEVEL_CRITICAL));</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM: after call gc."</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">RunDemo</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">AddFinalizer</span>(vm, env) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Run PromiseRegisterHandler failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// RunDemo注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = RunDemo},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// RunDemo方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"RunDemo"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(RunDemo();)JS"</span>;</li></ol></pre></div></div> <p>预期结果：</p> <div _ngcontent-xtq-c106="" class="highlight-div"><div _ngcontent-xtq-c106="" class="highlight-div-header"><div _ngcontent-xtq-c106="" class="highlight-div-header-left"><div _ngcontent-xtq-c106="" class="handle-button expand-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xtq-c106="" class="highlight-div-header-right"><div _ngcontent-xtq-c106="" class="handle-button ai-button"></div><div _ngcontent-xtq-c106="" class="handle-button line-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xtq-c106="" class="handle-button theme-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xtq-c106="" class="handle-button copy-button"><div _ngcontent-xtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xtq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">JSVM</span>: finalizer added.</li><li><span class="hljs-attr">JSVM</span>: before call gc.</li><li><span class="hljs-attr">JSVM</span>: finalizer called.</li><li><span class="hljs-attr">JSVM</span>: after call gc.</li></ol></pre></div></div> </div> </div> <div></div></div>