<h1 _ngcontent-bim-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API接口进行虚拟机快照相关开发"> 使用JSVM-API接口进行虚拟机快照相关开发 </h1>

<div _ngcontent-bim-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JavaScript虚拟机（JSVM）的快照创建功能，将当前运行时的JavaScript程序状态保存为一个快照文件，这个快照文件包含了当前的堆内存、执行上下文、函数闭包等信息。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><ul><li><strong>虚拟机启动快照</strong>：虚拟机在某个特定时间点的状态快照，包含了当前虚拟机的所有内部状态和数据。通过创建一个启动快照，可以在之后的时间点恢复虚拟机到相同的状态。</li></ul> <p>创建和使用虚拟机启动快照可以简化一些复杂的编程任务，提高JSVM中虚拟机的管理和维护效率，增强程序的灵活性和稳定性。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateSnapshot</td> <td class="cellrowborder" valign="top" width="50%">用于创建虚拟机的启动快照</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateEnvFromSnapshot</td> <td class="cellrowborder" valign="top" width="50%">基于虚拟机的起始快照，创建一个新的环境</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="oh_jsvm_createsnapshot--oh_jsvm_createenvfromsnapshot" class="firsth2">OH_JSVM_CreateSnapshot &amp; OH_JSVM_CreateEnvFromSnapshot<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_createsnapshot--oh_jsvm_createenvfromsnapshot" tips="复制节点链接"></i></h3><p>用于创建和使用虚拟机的启动快照。</p> <p>cpp部分代码：</p> <p><strong>注意事项</strong>: 需要在OH_JSVM_Init的时候，将JSVM对外部的依赖注册到initOptions.externalReferences中。</p> <div _ngcontent-bim-c106="" class="highlight-div"><div _ngcontent-bim-c106="" class="highlight-div-header"><div _ngcontent-bim-c106="" class="highlight-div-header-left"><div _ngcontent-bim-c106="" class="handle-button expand-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bim-c106="" class="highlight-div-header-right"><div _ngcontent-bim-c106="" class="handle-button ai-button"></div><div _ngcontent-bim-c106="" class="handle-button line-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bim-c106="" class="handle-button theme-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bim-c106="" class="handle-button copy-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bim-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"TEST_TAG"</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> g_aa = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_RET(theCall)                                                                           \</span></li><li><span class="hljs-meta">    do {                                                                                             \</span></li><li><span class="hljs-meta">        JSVM_Status cond = theCall;                                                                  \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> ((cond) != JSVM_OK) {                                                                     \</span></li><li><span class="hljs-meta">            const JSVM_ExtendedErrorInfo *info;                                                      \</span></li><li><span class="hljs-meta">            OH_JSVM_GetLastErrorInfo(env, &amp;info);                                                    \</span></li><li><span class="hljs-meta">            OH_LOG_ERROR(LOG_APP,                                                                    \</span></li><li><span class="hljs-meta">                <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d message = %{public}s"</span>, \</span></li><li><span class="hljs-meta">                __FILE__,                                                                            \</span></li><li><span class="hljs-meta">                __LINE__,                                                                            \</span></li><li><span class="hljs-meta">                cond,                                                                                \</span></li><li><span class="hljs-meta">                info != nullptr ? info-&gt;errorMessage : <span class="hljs-string">""</span>);                                          \</span></li><li><span class="hljs-meta">            return -1;                                                                               \</span></li><li><span class="hljs-meta">        }                                                                                            \</span></li><li><span class="hljs-meta">    } while (0)</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK(theCall)                                                                                              \</span></li><li><span class="hljs-meta">    do {                                                                                                            \</span></li><li><span class="hljs-meta">        JSVM_Status cond = theCall;                                                                                 \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> ((cond) != JSVM_OK) {                                                                                    \</span></li><li><span class="hljs-meta">            OH_LOG_ERROR(                                                                                           \</span></li><li><span class="hljs-meta">                LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d"</span>, __FILE__, __LINE__, cond); \</span></li><li><span class="hljs-meta">            return -1;                                                                                              \</span></li><li><span class="hljs-meta">        }                                                                                                           \</span></li><li><span class="hljs-meta">    } while (0)</span></li><li>
</li><li><span class="hljs-comment">// 用于调用theCall并检查其返回值是否为JSVM_OK。</span></li><li><span class="hljs-comment">// 如果不是，则调用GET_AND_THROW_LAST_ERROR处理错误并返回retVal。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> JSVM_CALL_BASE(env, theCall, retVal)                                                         \</span></li><li><span class="hljs-meta">    do {                                                                                             \</span></li><li><span class="hljs-meta">        JSVM_Status cond = theCall;                                                                  \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (cond != JSVM_OK) {                                                                       \</span></li><li><span class="hljs-meta">            const JSVM_ExtendedErrorInfo *info;                                                      \</span></li><li><span class="hljs-meta">            OH_JSVM_GetLastErrorInfo(env, &amp;info);                                                    \</span></li><li><span class="hljs-meta">            OH_LOG_ERROR(LOG_APP,                                                                    \</span></li><li><span class="hljs-meta">                <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d ret = %{public}d message = %{public}s"</span>, \</span></li><li><span class="hljs-meta">                __FILE__,                                                                            \</span></li><li><span class="hljs-meta">                __LINE__,                                                                            \</span></li><li><span class="hljs-meta">                cond,                                                                                \</span></li><li><span class="hljs-meta">                info != nullptr ? info-&gt;errorMessage : <span class="hljs-string">""</span>);                                          \</span></li><li><span class="hljs-meta">            return retVal;                                                                           \</span></li><li><span class="hljs-meta">        }                                                                                            \</span></li><li><span class="hljs-meta">    } while (0)</span></li><li>
</li><li><span class="hljs-comment">// JSVM_CALL_BASE的简化版本，返回nullptr</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> JSVM_CALL(theCall) JSVM_CALL_BASE(env, theCall, nullptr)</span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> MAX_BUFFER_SIZE = <span class="hljs-number">128</span>;</li><li><span class="hljs-comment">// CreateHelloString()函数需绑定到JSVM虚拟机, 用于OH_JSVM_CreateSnapshot虚拟机快照的正常创建</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateHelloString</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_Value outPut;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"Hello world!"</span>, JSVM_AUTO_LENGTH, &amp;outPut);</li><li>    <span class="hljs-keyword">return</span> outPut;</li><li>}</li><li><span class="hljs-comment">// 提供外部引用的方式以便JavaScript环境可以调用绑定的函数</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct helloCb = {CreateHelloString, <span class="hljs-literal">nullptr</span>};</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-type">intptr_t</span> externals[] = {</li><li>    (<span class="hljs-type">intptr_t</span>)&amp;helloCb,</li><li>    <span class="hljs-number">0</span>,</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">RunVMScript</span><span class="hljs-params">(JSVM_Env env, std::string &amp;src)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 打开handleScope作用域</span></li><li>    JSVM_HandleScope handleScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>    JSVM_Value jsStr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, src.<span class="hljs-built_in">c_str</span>(), src.<span class="hljs-built_in">size</span>(), &amp;jsStr);</li><li>    <span class="hljs-comment">// 编译JavaScript代码</span></li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsStr, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>    <span class="hljs-comment">// 执行JavaScript代码</span></li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>    <span class="hljs-comment">// 关闭handleScope作用域</span></li><li>    <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li><span class="hljs-comment">// OH_JSVM_CreateSnapshot的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">CreateVMSnapshot</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建JavaScript虚拟机实例,打开虚拟机作用域</span></li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions vmOptions;</li><li>    <span class="hljs-built_in">memset</span>(&amp;vmOptions, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(vmOptions));</li><li>    <span class="hljs-comment">// isForSnapshotting设置该虚拟机是否用于创建快照</span></li><li>    vmOptions.isForSnapshotting = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;vmOptions, &amp;vm);</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>    <span class="hljs-comment">// 创建JavaScript环境,打开环境作用域</span></li><li>    JSVM_Env env;</li><li>    <span class="hljs-comment">// 将native函数注册成JavaScript可调用的方法</span></li><li>    JSVM_PropertyDescriptor descriptor[] = {</li><li>        {<span class="hljs-string">"createHelloString"</span>, <span class="hljs-literal">nullptr</span>, &amp;helloCb, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    };</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-number">1</span>, descriptor, &amp;env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    <span class="hljs-comment">// 使用OH_JSVM_CreateSnapshot创建虚拟机的启动快照</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *blobData = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> blobSize = <span class="hljs-number">0</span>;</li><li>    JSVM_Env envs[<span class="hljs-number">1</span>] = {env};</li><li>    <span class="hljs-built_in">OH_JSVM_CreateSnapshot</span>(vm, <span class="hljs-number">1</span>, envs, &amp;blobData, &amp;blobSize);</li><li>    <span class="hljs-comment">// 将snapshot保存到文件中</span></li><li>    <span class="hljs-comment">// 保存快照数据，/data/storage/el2/base/files/test_blob.bin为沙箱路径</span></li><li>    <span class="hljs-comment">// 以包名为com.example.jsvm为例，实际文件会保存到/data/app/el2/100/base/com.example.jsvm/files/test_blob.bin</span></li><li>    <span class="hljs-function">std::ofstream <span class="hljs-title">file</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">        <span class="hljs-string">"/data/storage/el2/base/files/test_blob.bin"</span>, std::ios::out | std::ios::binary | std::ios::trunc)</span>;</li><li>    file.<span class="hljs-built_in">write</span>(blobData, blobSize);</li><li>    file.<span class="hljs-built_in">close</span>();</li><li>    <span class="hljs-comment">// 关闭并销毁环境和虚拟机</span></li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunVMSnapshot</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// blobData的生命周期不能短于vm的生命周期</span></li><li>    <span class="hljs-comment">// 从文件中读取snapshot</span></li><li>    std::vector&lt;<span class="hljs-type">char</span>&gt; blobData;</li><li>    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">"/data/storage/el2/base/files/test_blob.bin"</span>, std::ios::in | std::ios::binary | std::ios::ate)</span></span>;</li><li>    <span class="hljs-type">size_t</span> blobSize = file.<span class="hljs-built_in">tellg</span>();</li><li>    blobData.<span class="hljs-built_in">resize</span>(blobSize);</li><li>    file.<span class="hljs-built_in">seekg</span>(<span class="hljs-number">0</span>, std::ios::beg);</li><li>    file.<span class="hljs-built_in">read</span>(blobData.<span class="hljs-built_in">data</span>(), blobSize);</li><li>    file.<span class="hljs-built_in">close</span>();</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Test JSVM RunVMSnapshot read file blobSize = : %{public}ld"</span>, blobSize);</li><li>    <span class="hljs-comment">// 使用快照数据创建虚拟机实例</span></li><li>    JSVM_VM vm;</li><li>    JSVM_CreateVMOptions vmOptions;</li><li>    <span class="hljs-built_in">memset</span>(&amp;vmOptions, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(vmOptions));</li><li>    vmOptions.snapshotBlobData = blobData.<span class="hljs-built_in">data</span>();</li><li>    vmOptions.snapshotBlobSize = blobSize;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateVM</span>(&amp;vmOptions, &amp;vm);</li><li>    JSVM_VMScope vmScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope);</li><li>    <span class="hljs-comment">// 从快照中创建环境env</span></li><li>    JSVM_Env env;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateEnvFromSnapshot</span>(vm, <span class="hljs-number">0</span>, &amp;env);</li><li>    JSVM_EnvScope envScope;</li><li>    <span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope);</li><li>    <span class="hljs-comment">// 执行js脚本，快照记录的env中定义了createHelloString()</span></li><li>    std::string src = <span class="hljs-string">"createHelloString()"</span>;</li><li>    JSVM_Value result = <span class="hljs-built_in">RunVMScript</span>(env, src);</li><li>    <span class="hljs-comment">// 环境关闭前检查脚本运行结果</span></li><li>    <span class="hljs-type">char</span> str[MAX_BUFFER_SIZE];</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueStringUtf8</span>(env, result, str, MAX_BUFFER_SIZE, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(str, <span class="hljs-string">"Hello world!"</span>) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"jsvm fail file: %{public}s line: %{public}d"</span>, __FILE__, __LINE__);</li><li>    }</li><li>    <span class="hljs-comment">// 关闭并销毁环境和虚拟机</span></li><li>    <span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env);</li><li>    <span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope);</li><li>    <span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">AdjustExternalMemory</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 在创建虚拟机快照时，如果存在对外部的依赖，需要在OH_JSVM_Init时，将外部依赖注册到initOptions.externalReferences中</span></li><li>    <span class="hljs-comment">// 创建虚拟机快照并将快照保存到文件中</span></li><li>    <span class="hljs-built_in">CreateVMSnapshot</span>();</li><li>    <span class="hljs-comment">// snapshot可以记录下特定的js执行环境，可以跨进程通过snapshot快速还原出js执行上下文环境</span></li><li>    <span class="hljs-built_in">RunVMSnapshot</span>();</li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateInt32</span>(env, <span class="hljs-number">0</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = AdjustExternalMemory},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// AdjustExternalMemory方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"adjustExternalMemory"</span>, <span class="hljs-literal">nullptr</span>, method, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试JS</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(adjustExternalMemory();)JS"</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">TestJSVM</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    JSVM_InitOptions initOptions = {<span class="hljs-number">0</span>};</li><li>    JSVM_VM vm;</li><li>    JSVM_Env env = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_VMScope vmScope;</li><li>    JSVM_EnvScope envScope;</li><li>    JSVM_HandleScope handleScope;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-comment">// 初始化JavaScript引擎实例</span></li><li>    <span class="hljs-keyword">if</span> (g_aa == <span class="hljs-number">0</span>) {</li><li>        g_aa++;</li><li>        initOptions.externalReferences = externals;</li><li>        <span class="hljs-type">int</span> argc = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-type">char</span> **argv = <span class="hljs-literal">nullptr</span>;</li><li>        initOptions.argc = &amp;argc;</li><li>        initOptions.argv = argv;</li><li>        <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_Init</span>(&amp;initOptions));</li><li>    }</li><li>    <span class="hljs-comment">// 创建JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateVM</span>(<span class="hljs-literal">nullptr</span>, &amp;vm));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CreateEnv</span>(vm, <span class="hljs-built_in">sizeof</span>(descriptor) / <span class="hljs-built_in">sizeof</span>(descriptor[<span class="hljs-number">0</span>]), descriptor, &amp;env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_OpenVMScope</span>(vm, &amp;vmScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenEnvScope</span>(env, &amp;envScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope));</li><li>
</li><li>    <span class="hljs-comment">// 通过script调用测试函数</span></li><li>    JSVM_Script script;</li><li>    JSVM_Value jsSrc;</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, srcCallNative, JSVM_AUTO_LENGTH, &amp;jsSrc));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result));</li><li>
</li><li>    <span class="hljs-comment">// 销毁JSVM环境</span></li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope));</li><li>    <span class="hljs-built_in">CHECK_RET</span>(<span class="hljs-built_in">OH_JSVM_CloseEnvScope</span>(env, envScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_CloseVMScope</span>(vm, vmScope));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyEnv</span>(env));</li><li>    <span class="hljs-built_in">CHECK</span>(<span class="hljs-built_in">OH_JSVM_DestroyVM</span>(vm));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">TestJSVM</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Init"</span>);</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"runTest"</span>, <span class="hljs-literal">nullptr</span>, RunTest, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>
</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule); }</li></ol></pre></div></div> <p>ArkTS侧示例代码：</p> <div _ngcontent-bim-c106="" class="highlight-div"><div _ngcontent-bim-c106="" class="highlight-div-header"><div _ngcontent-bim-c106="" class="highlight-div-header-left"><div _ngcontent-bim-c106="" class="handle-button expand-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bim-c106="" class="highlight-div-header-right"><div _ngcontent-bim-c106="" class="handle-button ai-button"></div><div _ngcontent-bim-c106="" class="handle-button line-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bim-c106="" class="handle-button theme-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bim-c106="" class="handle-button copy-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bim-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> napitest <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// runtest</span></li><li>            napitest.<span class="hljs-title function_">runTest</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <p>执行结果</p> <p>在LOG中输出：</p> <div _ngcontent-bim-c106="" class="highlight-div"><div _ngcontent-bim-c106="" class="highlight-div-header"><div _ngcontent-bim-c106="" class="highlight-div-header-left"><div _ngcontent-bim-c106="" class="handle-button expand-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bim-c106="" class="highlight-div-header-right"><div _ngcontent-bim-c106="" class="handle-button ai-button"></div><div _ngcontent-bim-c106="" class="handle-button line-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bim-c106="" class="handle-button theme-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bim-c106="" class="handle-button copy-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bim-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300064</span></li></ol></pre></div></div> <p>多次点击屏幕,LOG中输出:</p> <div _ngcontent-bim-c106="" class="highlight-div"><div _ngcontent-bim-c106="" class="highlight-div-header"><div _ngcontent-bim-c106="" class="highlight-div-header-left"><div _ngcontent-bim-c106="" class="handle-button expand-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bim-c106="" class="highlight-div-header-right"><div _ngcontent-bim-c106="" class="handle-button ai-button"></div><div _ngcontent-bim-c106="" class="handle-button line-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bim-c106="" class="handle-button theme-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bim-c106="" class="handle-button copy-button"><div _ngcontent-bim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bim-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300176</span></li><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300064</span></li><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300160</span></li><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300032</span></li><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300176</span></li><li><span class="hljs-title class_">Test</span> <span class="hljs-variable constant_">JSVM</span> <span class="hljs-title class_">RunVMSnapshot</span> read file blobSize = : <span class="hljs-number">300048</span></li></ol></pre></div></div> <p>上述执行结果是因为在读取快照文件时，blobSize 的值来源于快照文件的大小（通过 file.tellg() 获取）。快照文件的大小直接决定了 blobSize 的值，所以会输出不同的值。</p> </div> </div> <div></div></div>