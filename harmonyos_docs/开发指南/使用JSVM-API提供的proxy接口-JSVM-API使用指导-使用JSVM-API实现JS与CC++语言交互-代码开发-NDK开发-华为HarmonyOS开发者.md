<h1 _ngcontent-enj-c119="" class="doc-title ng-star-inserted" title="使用 JSVM-API 提供的proxy接口"> 使用 JSVM-API 提供的proxy接口 </h1>

<div _ngcontent-enj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API 提供了创建 Proxy、判断 JSVM_Value 是否为 Proxy 类型和获取 Proxy 中的目标对象的接口。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_CreateProxy</td> <td class="cellrowborder" valign="top" width="50%">创建 Proxy，等价于在 js 中执行 new Proxy(target, handler)</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_IsProxy</td> <td class="cellrowborder" valign="top" width="50%">判断传入的 JSVM_Value 是否为 Proxy 类型</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_ProxyGetTarget</td> <td class="cellrowborder" valign="top" width="50%">获取给定 proxy 的目标对象</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅展示接口对应的C++相关代码。</p> <p>cpp 部分代码</p> <div _ngcontent-enj-c106="" class="highlight-div"><div _ngcontent-enj-c106="" class="highlight-div-header"><div _ngcontent-enj-c106="" class="highlight-div-header-left"><div _ngcontent-enj-c106="" class="handle-button expand-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-enj-c106="" class="highlight-div-header-right"><div _ngcontent-enj-c106="" class="handle-button ai-button"></div><div _ngcontent-enj-c106="" class="handle-button line-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-enj-c106="" class="handle-button theme-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-enj-c106="" class="handle-button copy-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-enj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// OH_JSVM_CreateProxy 的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">CreateProxy</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// 接受两个入参，第 1 个参数为 target，第 2 个参数为 handler</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    JSVM_Value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-comment">// 用 OH_JSVM_CreateProxy 为目标对象创建代理</span></li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_CreateProxy</span>(env, args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CreateProxy: failed: %{public}d"</span>, status);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_CreateProxy: success"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// OH_JSVM_IsProxy 的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">IsProxy</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-comment">// 调用 OH_JSVM_IsProxy 判断 JSVM_Value 是否为代理</span></li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_IsProxy</span>(env, args[<span class="hljs-number">0</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsProxy: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_IsProxy: success: %{public}s"</span>, result ? <span class="hljs-string">"is a proxy"</span> : <span class="hljs-string">"is not a proxy"</span>);</li><li>    }</li><li>    JSVM_Value isProxy;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, result, &amp;isProxy));</li><li>    <span class="hljs-keyword">return</span> isProxy;</li><li>}</li><li>
</li><li><span class="hljs-comment">// OH_JSVM_ProxyGetTarget 的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">GetProxyTarget</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    JSVM_Value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetCbInfo</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>));</li><li>    <span class="hljs-comment">// 调用 OH_JSVM_ProxyGetTarget 获取代理中的目标对象</span></li><li>    JSVM_Value result = <span class="hljs-literal">nullptr</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_ProxyGetTarget</span>(env, args[<span class="hljs-number">0</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_ProxyGetTarget: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_ProxyGetTarget: success"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Proxy 相关回调注册</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {{.data = <span class="hljs-literal">nullptr</span>, .callback = CreateProxy},</li><li>                                      {.data = <span class="hljs-literal">nullptr</span>, .callback = IsProxy},</li><li>                                      {.data = <span class="hljs-literal">nullptr</span>, .callback = GetProxyTarget}};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// Proxy 相关回调别名</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"CreateProxy"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"IsProxy"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>    {<span class="hljs-string">"GetProxyTarget"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT}};</li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">       target = {</span></li><li><span class="hljs-string">         message1: "hello",</span></li><li><span class="hljs-string">         message2: "everyone",</span></li><li><span class="hljs-string">       };</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">       handler = {</span></li><li><span class="hljs-string">         get(target, prop, receiver) {</span></li><li><span class="hljs-string">           return "world";</span></li><li><span class="hljs-string">         },</span></li><li><span class="hljs-string">       };</span></li><li><span class="hljs-string"></span></li><li><span class="hljs-string">       proxy = CreateProxy(target, handler)</span></li><li><span class="hljs-string">       isProxy = IsProxy(proxy)</span></li><li><span class="hljs-string">       target1 = GetProxyTarget(proxy)</span></li><li><span class="hljs-string">)JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果</p> <div _ngcontent-enj-c106="" class="highlight-div"><div _ngcontent-enj-c106="" class="highlight-div-header"><div _ngcontent-enj-c106="" class="highlight-div-header-left"><div _ngcontent-enj-c106="" class="handle-button expand-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-enj-c106="" class="highlight-div-header-right"><div _ngcontent-enj-c106="" class="handle-button ai-button"></div><div _ngcontent-enj-c106="" class="handle-button line-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-enj-c106="" class="handle-button theme-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-enj-c106="" class="handle-button copy-button"><div _ngcontent-enj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-enj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">OH_JSVM_CreateProxy</span>: <span class="hljs-title class_">success</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">OH_JSVM_IsProxy</span>: <span class="hljs-title class_">success</span>: <span class="hljs-keyword">is</span> <span class="hljs-title class_">a</span> <span class="hljs-title class_">proxy</span></li><li><span class="hljs-variable">JSVM</span> <span class="hljs-variable">OH_JSVM_ProxyGetTarget</span>: <span class="hljs-title class_">success</span></li></ol></pre></div></div> </div> </div> <div></div></div>