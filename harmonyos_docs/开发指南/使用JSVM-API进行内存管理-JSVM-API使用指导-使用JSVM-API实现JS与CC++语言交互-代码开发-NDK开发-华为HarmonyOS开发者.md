<h1 _ngcontent-afo-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API进行内存管理"> 使用JSVM-API进行内存管理 </h1>

<div _ngcontent-afo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API提供了一组用于管理JavaScript虚拟机内存的API，可以更好地控制JavaScript代码使用的内存，并优化内存管理和垃圾回收机制。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>在JavaScript中，内存管理和垃圾回收是自动进行的。JavaScript虚拟机负责跟踪对象的分配和释放，并在必要时回收不再使用的内存。但是，在某些情况下，JSVM可能会消耗大量的内存，这可能会导致内存不足的错误。为了避免这种情况，JSVM-API提供了一些接口，以便更好地控制内存管理和垃圾回收机制。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_AdjustExternalMemory</td> <td class="cellrowborder" valign="top" width="50%">用于管理由JavaScript对象持有的外部分配内存</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_MemoryPressureNotification</td> <td class="cellrowborder" valign="top" width="50%">通知虚拟机系统内存不足并有选择地触发垃圾回收</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>。本文仅展示接口对应C++及ArkTS相关代码。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_adjustexternalmemory" class="firsth2">OH_JSVM_AdjustExternalMemory<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_adjustexternalmemory" tips="复制节点链接"></i></h3><p>设置JavaScript对象保持活动状态的外部分配内存的数量</p> <p>cpp部分代码：</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_AdjustExternalMemory的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">AdjustExternalMemory</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 分配1MB的内存</span></li><li>    <span class="hljs-type">int64_t</span> change = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;</li><li>    <span class="hljs-type">int64_t</span> adjustedValue = <span class="hljs-number">0</span>;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_AdjustExternalMemory</span>(env, change, &amp;adjustedValue);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_AdjustExternalMemory: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_AdjustExternalMemory: success"</span>);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Allocate memory size: %{public}d"</span>, adjustedValue);</li><li>    }</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li><span class="hljs-comment">// AdjustExternalMemory注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = AdjustExternalMemory},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// AdjustExternalMemory方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"adjustExternalMemory"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p>样例测试JS</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li>const char *srcCallNative = <span class="hljs-string">R"JS(adjustExternalMemory())JS"</span>;</li></ol></pre></div></div> <p>输出结果：</p> <p>在LOG中输出以下信息：</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM OH_JSVM_AdjustExternalMemory: success</li><li>JSVM Allocate memory size: <span class="hljs-number">1048576</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_memorypressurenotification">OH_JSVM_MemoryPressureNotification<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_memorypressurenotification" tips="复制节点链接"></i></h3><p>使用OH_JSVM_MemoryPressureNotification通知虚拟机系统内存不足并有选择地触发垃圾回收。</p> <p>cpp部分代码：</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// OH_JSVM_MemoryPressureNotification的样例方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">MemoryPressureNotification</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 设置当前JSVM的内存压力级别</span></li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_MemoryPressureNotification</span>(env, JSVM_MEMORY_PRESSURE_LEVEL_CRITICAL);</li><li>    <span class="hljs-keyword">if</span> (status != JSVM_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_MemoryPressureNotification: failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM OH_JSVM_MemoryPressureNotification: success"</span>);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Current JSVM memory pressure level: %{public}d"</span>, JSVM_MEMORY_PRESSURE_LEVEL_CRITICAL);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-comment">// MemoryPressureNotification注册回调</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = MemoryPressureNotification},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// MemoryPressureNotification方法别名，供JS调用</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"memoryPressureNotification"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p>样例测试JS</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li>const char *srcCallNative = <span class="hljs-string">R"JS(memoryPressureNotification())JS"</span>;</li></ol></pre></div></div> <p>输出结果：</p> <p>在LOG中输出以下信息：</p> <div _ngcontent-afo-c106="" class="highlight-div"><div _ngcontent-afo-c106="" class="highlight-div-header"><div _ngcontent-afo-c106="" class="highlight-div-header-left"><div _ngcontent-afo-c106="" class="handle-button expand-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afo-c106="" class="highlight-div-header-right"><div _ngcontent-afo-c106="" class="handle-button ai-button"></div><div _ngcontent-afo-c106="" class="handle-button line-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afo-c106="" class="handle-button theme-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afo-c106="" class="handle-button copy-button"><div _ngcontent-afo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM OH_JSVM_MemoryPressureNotification: success</li><li>JSVM Current JSVM memory pressure level: <span class="hljs-number">2</span></li></ol></pre></div></div> </div> </div> <div></div></div>