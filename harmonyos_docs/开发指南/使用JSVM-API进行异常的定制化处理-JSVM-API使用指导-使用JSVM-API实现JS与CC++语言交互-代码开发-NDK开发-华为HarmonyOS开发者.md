<h1 _ngcontent-sng-c119="" class="doc-title ng-star-inserted" title="使用JSVM-API进行异常的定制化处理"> 使用JSVM-API进行异常的定制化处理 </h1>

<div _ngcontent-sng-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>JSVM-API提供了一组用于处理JSVM异常的接口。通过这些接口，可以向JSVM注册回调函数。当JSVM触发异常时，会调用已注册的回调函数。</p> <p>这些接口提供对JS引擎错误的定制化处理，帮助开发者管理运行时错误和异常。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>当JS引擎遇到内存不足的问题时，系统会抛出一个OOM Error，如果开发者提前向JS引擎中注册了OOM Error的处理函数，系统就会调用这个设置的处理函数，开发者可以在处理函数中执行一些清理或者日志记录操作。</p> <p>当JS引擎发生致命错误，例如执行JavaScript代码时出现无法恢复的错误，系统会抛出一个Fatal Error，并调用用户预先设置的处理函数。在该处理函数中，可以输出额外日志或报告错误，避免程序直接崩溃。</p> <p>当JavaScript中的Promise被拒绝，而这个拒绝又没有被catch处理时，系统就会抛出一个Promise Reject，同时系统会调用用户提前设置的处理Promise Reject的函数。在这个处理函数中，用户可以处理未捕获的Promise拒绝。</p> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">功能说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetHandlerForOOMError</td> <td class="cellrowborder" valign="top" width="50%">用于在VM中设置处理OOM Error的函数</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetHandlerForFatalError</td> <td class="cellrowborder" valign="top" width="50%">用于在VM中设置处理Fatal Error的函数</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_JSVM_SetHandlerForPromiseReject</td> <td class="cellrowborder" valign="top" width="50%">用于在VM中设置处理Promise Reject的函数</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>JSVM-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>，本文仅对接口对应C++相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="oh_jsvm_sethandlerforoomerror" class="firsth2">OH_JSVM_SetHandlerForOOMError<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_sethandlerforoomerror" tips="复制节点链接"></i></h3><p>通过OH_JSVM_SetHandlerForOOMError，用户可以设置处理OOM Error的函数。当多次调用这个API进行函数设置时，仅最后一次设置会生效。当用户传入的设置函数为NULL时，则表示取消之前设置的处理函数。</p> <p><strong>cpp部分代码：</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csetjmp&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> jmp_buf buf;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> oomHandlerFinished = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnOOMError</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *location, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *detail, <span class="hljs-type">bool</span> isHeapOOM)</span></span></li><li><span class="hljs-function"></span>{</li><li>    oomHandlerFinished = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">longjmp</span>(buf, <span class="hljs-number">1</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">TriggerOOMError</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    oomHandlerFinished = <span class="hljs-literal">false</span>;</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm));</li><li>    <span class="hljs-comment">// 设置OOM Error处理函数</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForOOMError</span>(vm, OnOOMError));</li><li>    <span class="hljs-type">bool</span> oomed = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">setjmp</span>(buf);</li><li>    <span class="hljs-keyword">if</span> (!oomed) {</li><li>        oomed = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-comment">// 触发OOM</span></li><li>        std::vector&lt;JSVM_Value&gt; arrayVec;</li><li>        <span class="hljs-type">int</span> loopCount = <span class="hljs-number">1000</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; loopCount; i++) {</li><li>            JSVM_Value array;</li><li>            <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateArrayWithLength</span>(env, <span class="hljs-number">0xffffff</span>, &amp;array));</li><li>            arrayVec.<span class="hljs-built_in">push_back</span>(array);</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (oomHandlerFinished) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger OOM Error: success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger OOM Error: failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 取消对OOM Error处理函数的设置</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForOOMError</span>(vm, <span class="hljs-literal">NULL</span>));</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = TriggerOOMError},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"triggerOOMError"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例测试JS</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcCallNative = <span class="hljs-string">R"JS(triggerOOMError();)JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果</strong></p> <p>在LOG中输出： </p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM Trigger OOM Error: success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_sethandlerforfatalerror">OH_JSVM_SetHandlerForFatalError<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_sethandlerforfatalerror" tips="复制节点链接"></i></h3><p>通过OH_JSVM_SetHandlerForFatalError，用户可以设置处理Fatal Error的函数。当多次调用这个API进行函数设置时，仅最后一次设置会生效。当用户传入的设置函数为NULL时，则表示取消之前设置的处理函数。</p> <p><strong>cpp部分代码：</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csetjmp&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-type">static</span> jmp_buf buf;</li><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> fatalHandlerFinished = <span class="hljs-literal">false</span>;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnFatalError</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *location, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *message)</span></span></li><li><span class="hljs-function"></span>{</li><li>    fatalHandlerFinished = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Run in 106"</span>);</li><li>    <span class="hljs-built_in">longjmp</span>(buf, <span class="hljs-number">1</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">TriggerFatalError</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    fatalHandlerFinished = <span class="hljs-literal">false</span>;</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm));</li><li>    <span class="hljs-comment">// 设置Fatal Error处理函数</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForFatalError</span>(vm, OnFatalError));</li><li>    <span class="hljs-type">bool</span> fataled = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">setjmp</span>(buf);</li><li>    <span class="hljs-keyword">if</span> (!fataled) {</li><li>        fataled = <span class="hljs-literal">true</span>;</li><li>        std::vector&lt;JSVM_Value&gt; arrayVec;</li><li>        <span class="hljs-type">int</span> loopCount = <span class="hljs-number">1000</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; loopCount; i++) {</li><li>            JSVM_Value array;</li><li>            <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_CreateArrayWithLength</span>(env, <span class="hljs-number">0xffffff</span>, &amp;array));</li><li>            arrayVec.<span class="hljs-built_in">push_back</span>(array);</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (fatalHandlerFinished) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger Fatal Error: success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger Fatal Error: failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 取消对Fatal Error处理函数的设置</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForFatalError</span>(vm, <span class="hljs-literal">NULL</span>));</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = TriggerFatalError},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"triggerFatalError"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例测试JS</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(triggerFatalError())JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果：</strong></p> <p>在LOG中输出： </p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM Trigger Fatal Error: success</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="oh_jsvm_sethandlerforpromisereject">OH_JSVM_SetHandlerForPromiseReject<i class="anchor-icon anchor-icon-link" anchorid="oh_jsvm_sethandlerforpromisereject" tips="复制节点链接"></i></h3><p>通过OH_JSVM_SetHandlerForPromiseReject，用户可以设置处理Promise Reject的函数。当多次调用这个API进行函数设置时，仅最后一次设置会生效。当用户传入的设置函数为NULL时，则表示取消之前设置的处理函数。</p> <p><strong>cpp部分代码：</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> <span class="hljs-type">bool</span> promiseRejectHandlerFinished = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnPromiseReject</span><span class="hljs-params">(JSVM_Env env, JSVM_PromiseRejectEvent rejectEvent, JSVM_Value rejectInfo)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_IsObject</span>(env, rejectInfo, &amp;result);</li><li>    JSVM_Value promise;</li><li>    JSVM_Value key1;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"promise"</span>, JSVM_AUTO_LENGTH, &amp;key1);</li><li>    <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, rejectInfo, key1, &amp;promise);</li><li>    <span class="hljs-type">bool</span> isPromise = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_IsPromise</span>(env, promise, &amp;isPromise);</li><li>    JSVM_Value value;</li><li>    JSVM_Value key2;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, <span class="hljs-string">"value"</span>, JSVM_AUTO_LENGTH, &amp;key2);</li><li>    <span class="hljs-built_in">OH_JSVM_GetProperty</span>(env, rejectInfo, key2, &amp;value);</li><li>    JSVM_Value js_number;</li><li>    <span class="hljs-built_in">OH_JSVM_CoerceToNumber</span>(env, value, &amp;js_number);</li><li>    <span class="hljs-type">double</span> res = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_GetValueDouble</span>(env, js_number, &amp;res);</li><li>    <span class="hljs-keyword">if</span> (res == <span class="hljs-number">42</span> &amp;&amp; isPromise) {</li><li>        promiseRejectHandlerFinished = <span class="hljs-literal">true</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> JSVM_Value <span class="hljs-title">TriggerPromiseReject</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    promiseRejectHandlerFinished = <span class="hljs-literal">false</span>;</li><li>    JSVM_VM vm;</li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_GetVM</span>(env, &amp;vm));</li><li>    <span class="hljs-comment">// 设置Promise Reject处理函数</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForPromiseReject</span>(vm, OnPromiseReject));</li><li>    JSVM_Value strVal;</li><li>    <span class="hljs-type">char</span> *str = <span class="hljs-string">"new Promise((resolve, reject) =&gt; { reject(42); })"</span>;</li><li>    <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, str, JSVM_AUTO_LENGTH, &amp;strVal);</li><li>    JSVM_Script script;</li><li>    <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, strVal, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>    JSVM_Value result;</li><li>    JSVM_Status status = <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (promiseRejectHandlerFinished) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger Promise Reject: success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"JSVM Trigger Promise Reject: failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 取消对Promise Reject处理函数的设置</span></li><li>    <span class="hljs-built_in">JSVM_CALL</span>(<span class="hljs-built_in">OH_JSVM_SetHandlerForPromiseReject</span>(vm, <span class="hljs-literal">NULL</span>));</li><li>    JSVM_Value checked;</li><li>    <span class="hljs-built_in">OH_JSVM_GetBoolean</span>(env, <span class="hljs-literal">true</span>, &amp;checked);</li><li>    <span class="hljs-keyword">return</span> checked;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = TriggerPromiseReject},</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li>
</li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"triggerPromiseReject"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li></ol></pre></div></div> <p><strong>样例测试JS</strong></p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(triggerPromiseReject())JS"</span>;</li></ol></pre></div></div> <p><strong>执行结果：</strong></p> <p>在LOG中输出： </p> <div _ngcontent-sng-c106="" class="highlight-div"><div _ngcontent-sng-c106="" class="highlight-div-header"><div _ngcontent-sng-c106="" class="highlight-div-header-left"><div _ngcontent-sng-c106="" class="handle-button expand-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sng-c106="" class="highlight-div-header-right"><div _ngcontent-sng-c106="" class="handle-button ai-button"></div><div _ngcontent-sng-c106="" class="handle-button line-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sng-c106="" class="handle-button theme-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sng-c106="" class="handle-button copy-button"><div _ngcontent-sng-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sng-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>JSVM Trigger Promise Reject: success</li></ol></pre></div></div> </div> </div> <div></div></div>