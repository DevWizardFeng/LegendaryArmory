<h1 _ngcontent-fto-c119="" class="doc-title ng-star-inserted" title="使用MediaAssetManager请求媒体资源(C/C++)"> 使用MediaAssetManager请求媒体资源(C/C++) </h1>

<div _ngcontent-fto-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用MediaAssetManager可以实现请求媒体资源到目标沙箱路径，本开发指导将以请求一张图片作为示例，向开发者讲解MediaAssetManager相关功能。</p>    <p>请求图片资源的全流程包含：创建MediaAssetManager，设置请求资源，请求图片资源，取消本次请求(可选)。</p>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>在CMake脚本中链接动态库</p>     <div _ngcontent-fto-c106="" class="highlight-div"><div _ngcontent-fto-c106="" class="highlight-div-header"><div _ngcontent-fto-c106="" class="highlight-div-header-left"><div _ngcontent-fto-c106="" class="handle-button expand-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fto-c106="" class="highlight-div-header-right"><div _ngcontent-fto-c106="" class="handle-button ai-button"></div><div _ngcontent-fto-c106="" class="handle-button line-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fto-c106="" class="handle-button theme-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fto-c106="" class="handle-button copy-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fto-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libmedia_asset_manager.so)</li></ol></pre></div></div>     <p>开发者通过引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-media-asset-manager-capi-h" target="_blank">media_asset_manager_capi.h</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-media-asset-base-capi-h" target="_blank">media_asset_base_capi.h</a>头文件，使用MediaAssetManager相关API。</p>     <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mediaassetmanager" target="_blank">MediaAssetManager API</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>开发前，需要参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-preparation">开发准备</a>，申请ohos.permission.READ_IMAGEVIDEO权限。</p>      </div></div></div>     <ol>      <li>创建实例：OH_MediaAssetManager_Create()。</li>      <li>设置资源：设置资源请求回调、设置资源请求策略、设置源图片Uri和目标Uri。</li>      <li>请求图片资源：调用OH_MediaAssetManager_RequestImageForPath()请求图片资源到目标Uri。</li>      <li>取消请求：调用OH_MediaAssetManager_CancelRequest()。(可选)</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-fto-c106="" class="highlight-div"><div _ngcontent-fto-c106="" class="highlight-div-header"><div _ngcontent-fto-c106="" class="highlight-div-header-left"><div _ngcontent-fto-c106="" class="handle-button expand-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fto-c106="" class="highlight-div-header-right"><div _ngcontent-fto-c106="" class="handle-button ai-button"></div><div _ngcontent-fto-c106="" class="handle-button line-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fto-c106="" class="handle-button theme-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fto-c106="" class="handle-button copy-button"><div _ngcontent-fto-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fto-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/media_library/media_asset_base_capi.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/media_library/media_asset_manager_capi.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> ERROR_REQUEST_ID[UUID_STR_MAX_LENGTH] = <span class="hljs-string">"00000000-0000-0000-0000-000000000000"</span>;</li><li>
</li><li><span class="hljs-comment">// 资源请求回调</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OnDataPrepared</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> result, MediaLibrary_RequestId requestIdStruct)</span></li><li>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OnDataPrepared requestId: %s result: %d\n"</span>, requestIdStruct.requestId, result);</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-comment">// 创建MediaAssetManager实例</span></li><li>    OH_MediaAssetManager *manager = OH_MediaAssetManager_Create();</li><li>    <span class="hljs-keyword">if</span> (manager == nullptr) {</li><li>        <span class="hljs-comment">// 处理异常。</span></li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Get MediaAssetManager failed.\n"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// 设置资源请求回调</span></li><li>        OH_MediaLibrary_OnDataPrepared callback = OnDataPrepared;</li><li>        </li><li>        <span class="hljs-comment">// 设置资源请求策略</span></li><li>        MediaLibrary_RequestOptions options;</li><li>        options.deliveryMode = MEDIA_LIBRARY_HIGH_QUALITY_MODE;</li><li>
</li><li>        <span class="hljs-comment">// 预置图片资源Uri，默认为高质量图片。注：以下Uri是示例，开发者需根据实际情况创建或获取</span></li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *srcUri = <span class="hljs-string">"file://media/Photo/87/VID_1712195295_025/request_image_src.jpg"</span>;</li><li>
</li><li>        <span class="hljs-comment">// 提供目标路径Uri。注：以下Uri是示例，开发者需根据实际情况创建或获取</span></li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *destUri = <span class="hljs-string">"file://media/Photo/9/IMG_1712195237_008/request_image_dest.jpg"</span>;</li><li>
</li><li>        <span class="hljs-comment">// 将图片资源请求到目标路径</span></li><li>        MediaLibrary_RequestId requestIdStruct = OH_MediaAssetManager_RequestImageForPath(manager, srcUri,</li><li>            options, destUri, callback);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(requestIdStruct.requestId, ERROR_REQUEST_ID) == <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-comment">// 处理异常</span></li><li>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Request image failed requestId：%s\n"</span>, requestIdStruct.requestId);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// 请求成功，打印请求Id</span></li><li>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Request image success, requestId: %s\n"</span>, requestIdStruct.requestId);</li><li>
</li><li>            <span class="hljs-comment">// 调用CancelRequest接口，用来取消尚在处理中的请求</span></li><li>            <span class="hljs-comment">// 注：OH_MediaAssetManager_CancelRequest不是必须流程，开发者可根据实际情况选择是否调用该接口来取消尚未回调返回的资源请求</span></li><li>            <span class="hljs-type">bool</span> ret = OH_MediaAssetManager_CancelRequest(manager, requestIdStruct);</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>