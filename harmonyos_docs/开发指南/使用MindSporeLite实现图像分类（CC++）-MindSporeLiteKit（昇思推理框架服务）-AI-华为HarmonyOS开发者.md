<h1 _ngcontent-ref-c119="" class="doc-title ng-star-inserted" title="使用MindSpore Lite实现图像分类（C/C++）"> 使用MindSpore Lite实现图像分类（C/C++） </h1>

<div _ngcontent-ref-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景说明">场景说明<i class="anchor-icon anchor-icon-link" anchorid="场景说明" tips="复制节点链接"></i></h2>          <p>开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>，在UI代码中直接集成MindSpore Lite能力，快速部署AI算法，进行AI模型推理，实现图像分类的应用。</p>     <p>图像分类可实现对图像中物体的识别，在医学影像分析、自动驾驶、电子商务、人脸识别等领域有广泛的应用。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>N-API：用于构建ArkTS本地化组件的一套接口。可利用N-API，将C/C++开发的库封装成ArkTS模块。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2>          <ol>      <li>选择图像分类模型。</li>      <li>在端侧使用MindSpore Lite推理模型，实现对选择的图片进行分类。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>          <p>安装DevEco Studio，要求版本 &gt;= 4.1，并更新SDK到API 11或以上。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>本文以对相册的一张图片进行推理为例，提供使用MindSpore Lite实现图像分类的开发指导。</p>    </div>    <div class="tiledSection">     <h3 id="选择模型" class="firsth2">选择模型<i class="anchor-icon anchor-icon-link" anchorid="选择模型" tips="复制节点链接"></i></h3>          <p>本示例程序中使用的图像分类模型文件为<a href="https://download.mindspore.cn/model_zoo/official/lite/mobilenetv2_openimage_lite/1.5/mobilenetv2.ms" target="_blank">mobilenetv2.ms</a>，放置在entry/src/main/resources/rawfile工程目录下。</p>     <p>如果开发者有其他图像分类的预训练模型，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/mindspore-lite-converter-guidelines">MindSpore Lite 模型转换</a>介绍，将原始模型转换成.ms格式。</p>    </div>    <div class="tiledSection">     <h3 id="编写推理代码">编写推理代码<i class="anchor-icon anchor-icon-link" anchorid="编写推理代码" tips="复制节点链接"></i></h3>          <p>在 entry/src/main/cpp/mslite_napi.cpp，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>实现端侧推理，推理代码流程如下。</p>     <ol>      <li>       <p>引用对应的头文件</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file_manager.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/model.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/context.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/status.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/tensor.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>读取模型文件</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGI</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGD</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGW</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_WARN, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGE</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li></ol></pre></div></div>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">ReadModelFile</span><span class="hljs-params">(NativeResourceManager *nativeResourceManager, <span class="hljs-type">const</span> std::string &amp;modelName, <span class="hljs-type">size_t</span> *modelSize)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(nativeResourceManager, modelName.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">if</span> (rawFile == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Open model file failed"</span>);</li><li>        <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">long</span> fileSize = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>    <span class="hljs-keyword">if</span> (fileSize &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: FileSize not correct"</span>);</li><li>    }</li><li>    <span class="hljs-type">void</span> *modelBuffer = <span class="hljs-built_in">malloc</span>(fileSize);</li><li>    <span class="hljs-keyword">if</span> (modelBuffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: malloc failed"</span>);</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, modelBuffer, fileSize);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: OH_ResourceManager_ReadRawFile failed"</span>);</li><li>        <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>    *modelSize = fileSize;</li><li>    <span class="hljs-keyword">return</span> modelBuffer;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建上下文，设置线程数、设备类型等参数，并加载模型。本样例模型，不支持使用NNRt推理。</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DestroyModelBuffer</span><span class="hljs-params">(<span class="hljs-type">void</span> **buffer)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(*buffer);</li><li>    *buffer = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">OH_AI_ContextHandle <span class="hljs-title">CreateMSLiteContext</span><span class="hljs-params">(<span class="hljs-type">void</span> *modelBuffer)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Set executing context for model.</span></li><li>    <span class="hljs-keyword">auto</span> context = <span class="hljs-built_in">OH_AI_ContextCreate</span>();</li><li>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;modelBuffer);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Create MSLite context failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 本样例模型，不支持配置OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_NNRT)</span></li><li>    <span class="hljs-keyword">auto</span> cpu_device_info = <span class="hljs-built_in">OH_AI_DeviceInfoCreate</span>(OH_AI_DEVICETYPE_CPU);</li><li>
</li><li>    <span class="hljs-built_in">OH_AI_DeviceInfoSetEnableFP16</span>(cpu_device_info, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-built_in">OH_AI_ContextAddDeviceInfo</span>(context, cpu_device_info);</li><li>    </li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Build MSLite context success.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> context;</li><li>}</li><li>
</li><li><span class="hljs-function">OH_AI_ModelHandle <span class="hljs-title">CreateMSLiteModel</span><span class="hljs-params">(<span class="hljs-type">void</span> *modelBuffer, <span class="hljs-type">size_t</span> modelSize, OH_AI_ContextHandle context)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Create model</span></li><li>    <span class="hljs-keyword">auto</span> model = <span class="hljs-built_in">OH_AI_ModelCreate</span>();</li><li>    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;modelBuffer);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Allocate MSLite Model failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// Build model object</span></li><li>    <span class="hljs-keyword">auto</span> build_ret = <span class="hljs-built_in">OH_AI_ModelBuild</span>(model, modelBuffer, modelSize, OH_AI_MODELTYPE_MINDIR, context);</li><li>    <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;modelBuffer);</li><li>    <span class="hljs-keyword">if</span> (build_ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_AI_ModelDestroy</span>(&amp;model);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Build MSLite model failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Build MSLite model success.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> model;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置模型输入数据，执行模型推理。</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> K_NUM_PRINT_OF_OUT_DATA = <span class="hljs-number">20</span>;</li></ol></pre></div></div>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置模型输入数据</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FillInputTensor</span><span class="hljs-params">(OH_AI_TensorHandle input, std::vector&lt;<span class="hljs-type">float</span>&gt; input_data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AI_TensorGetDataType</span>(input) == OH_AI_DATATYPE_NUMBERTYPE_FLOAT32) {</li><li>        <span class="hljs-type">float</span> *data = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">OH_AI_TensorGetMutableData</span>(input);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">OH_AI_TensorGetElementNum</span>(input); i++) {</li><li>            data[i] = input_data[i];</li><li>        }</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 执行模型推理</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RunMSLiteModel</span><span class="hljs-params">(OH_AI_ModelHandle model, std::vector&lt;<span class="hljs-type">float</span>&gt; input_data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Set input data for model.</span></li><li>    <span class="hljs-keyword">auto</span> inputs = <span class="hljs-built_in">OH_AI_ModelGetInputs</span>(model);</li><li>    <span class="hljs-keyword">auto</span> ret = <span class="hljs-built_in">FillInputTensor</span>(inputs.handle_list[<span class="hljs-number">0</span>], input_data);</li><li>    <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: RunMSLiteModel set input error.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// Get model output.</span></li><li>    <span class="hljs-keyword">auto</span> outputs = <span class="hljs-built_in">OH_AI_ModelGetOutputs</span>(model);</li><li>
</li><li>    <span class="hljs-comment">// Predict model.</span></li><li>    <span class="hljs-keyword">auto</span> predict_ret = <span class="hljs-built_in">OH_AI_ModelPredict</span>(model, inputs, &amp;outputs, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (predict_ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: MSLite Predict error.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Run MSLite model Predict success.\n"</span>);</li><li>
</li><li>    <span class="hljs-comment">// Print output tensor data.</span></li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Get model outputs:\n"</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outputs.handle_num; i++) {</li><li>        <span class="hljs-keyword">auto</span> tensor = outputs.handle_list[i];</li><li>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor %{public}d name is: %{public}s.\n"</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(i),</li><li>             <span class="hljs-built_in">OH_AI_TensorGetName</span>(tensor));</li><li>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor %{public}d size is: %{public}d.\n"</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(i),</li><li>             (<span class="hljs-type">int</span>)<span class="hljs-built_in">OH_AI_TensorGetDataSize</span>(tensor));</li><li>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor data is:\n"</span>);</li><li>        <span class="hljs-keyword">auto</span> out_data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">float</span> *&gt;(<span class="hljs-built_in">OH_AI_TensorGetData</span>(tensor));</li><li>        std::stringstream outStr;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; (i &lt; <span class="hljs-built_in">OH_AI_TensorGetElementNum</span>(tensor)) &amp;&amp; (i &lt;= K_NUM_PRINT_OF_OUT_DATA); i++) {</li><li>            outStr &lt;&lt; out_data[i] &lt;&lt; <span class="hljs-string">" "</span>;</li><li>        }</li><li>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: %{public}s"</span>, outStr.<span class="hljs-built_in">str</span>().<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用以上方法，实现完整的模型推理流程。</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunDemo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// run demo</span></li><li>    napi_value error_ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">-1</span>, &amp;error_ret);</li><li>    <span class="hljs-comment">// 传入数据处理</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> isArray = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_array</span>(env, argv[<span class="hljs-number">0</span>], &amp;isArray);</li><li>    <span class="hljs-type">uint32_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 获取数组的长度</span></li><li>    <span class="hljs-built_in">napi_get_array_length</span>(env, argv[<span class="hljs-number">0</span>], &amp;length);</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: argv array length = %{public}d"</span>, length);</li><li>    std::vector&lt;<span class="hljs-type">float</span>&gt; input_data;</li><li>    <span class="hljs-type">double</span> param = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {</li><li>        napi_value value;</li><li>        <span class="hljs-built_in">napi_get_element</span>(env, argv[<span class="hljs-number">0</span>], i, &amp;value);</li><li>        <span class="hljs-built_in">napi_get_value_double</span>(env, value, &amp;param);</li><li>        input_data.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">float</span>&gt;(param));</li><li>    }</li><li>    std::stringstream outstr;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; K_NUM_PRINT_OF_OUT_DATA; i++) {</li><li>        outstr &lt;&lt; input_data[i] &lt;&lt; <span class="hljs-string">" "</span>;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: input_data = %{public}s"</span>, outstr.<span class="hljs-built_in">str</span>().<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-comment">// Read model file</span></li><li>    <span class="hljs-type">const</span> std::string modelName = <span class="hljs-string">"mobilenetv2.ms"</span>;</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Run model: %{public}s"</span>, modelName.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-type">size_t</span> modelSize;</li><li>    <span class="hljs-keyword">auto</span> resourcesManager = <span class="hljs-built_in">OH_ResourceManager_InitNativeResourceManager</span>(env, argv[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-keyword">auto</span> modelBuffer = <span class="hljs-built_in">ReadModelFile</span>(resourcesManager, modelName, &amp;modelSize);</li><li>    <span class="hljs-keyword">if</span> (modelBuffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Read model failed"</span>);</li><li>        <span class="hljs-keyword">return</span> error_ret;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Read model file success"</span>);</li><li>    </li><li>    <span class="hljs-keyword">auto</span> context = <span class="hljs-built_in">CreateMSLiteContext</span>(modelBuffer);</li><li>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: MSLiteFwk Build context failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> error_ret;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> model = <span class="hljs-built_in">CreateMSLiteModel</span>(modelBuffer, modelSize, context);</li><li>    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_AI_ContextDestroy</span>(&amp;context);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: MSLiteFwk Build model failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> error_ret;</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">RunMSLiteModel</span>(model, input_data);</li><li>    <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_AI_ModelDestroy</span>(&amp;model);</li><li>        <span class="hljs-built_in">OH_AI_ContextDestroy</span>(&amp;context);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: RunMSLiteModel failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> error_ret;</li><li>    }</li><li>    napi_value out_data;</li><li>    <span class="hljs-built_in">napi_create_array</span>(env, &amp;out_data);</li><li>    <span class="hljs-keyword">auto</span> outputs = <span class="hljs-built_in">OH_AI_ModelGetOutputs</span>(model);</li><li>    OH_AI_TensorHandle output_0 = outputs.handle_list[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-type">float</span> *output0Data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">float</span> *&gt;(<span class="hljs-built_in">OH_AI_TensorGetMutableData</span>(output_0));</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">OH_AI_TensorGetElementNum</span>(output_0); i++) {</li><li>        napi_value element;</li><li>        <span class="hljs-built_in">napi_create_double</span>(env, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">double</span>&gt;(output0Data[i]), &amp;element);</li><li>        <span class="hljs-built_in">napi_set_element</span>(env, out_data, i, element);</li><li>    }</li><li>    <span class="hljs-built_in">OH_AI_ModelDestroy</span>(&amp;model);</li><li>    <span class="hljs-built_in">OH_AI_ContextDestroy</span>(&amp;context);</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Exit runDemo()"</span>);</li><li>    <span class="hljs-keyword">return</span> out_data;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写CMake脚本，链接MindSpore Lite动态库。</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span>.<span class="hljs-number">1</span>)</li><li><span class="hljs-built_in">project</span>(MindSporeLiteCDemo)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_PATH}</li><li>                    ${NATIVERENDER_PATH}/include)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED mslite_napi.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC mindspore_lite_ndk)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC hilog_ndk.z)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC rawfile.z)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC ace_napi.z)</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="使用n-api将c动态库封装成arkts模块">使用N-API将C++动态库封装成ArkTS模块<i class="anchor-icon anchor-icon-link" anchorid="使用n-api将c动态库封装成arkts模块" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在 entry/src/main/cpp/types/libentry/Index.d.ts，定义ArkTS接口runDemo() 。内容如下：</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">runDemo</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>[], b:<span class="hljs-built_in">Object</span></span>) =&gt;</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt;;</li></ol></pre></div></div></li>      <li>       <p>在 oh-package.json5 文件，将API与so相关联，成为一个完整的ArkTS模块：</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"libentry.so"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./Index.d.ts"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MindSpore Lite inference module"</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="实现图像输入和预处理并执行推理">实现图像输入和预处理，并执行推理<i class="anchor-icon anchor-icon-link" anchorid="实现图像输入和预处理并执行推理" tips="复制节点链接"></i></h3>          <ol>      <li>此处以获取相册图片为例，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker" target="_blank">@ohos.file.picker</a> 实现相册图片文件的选择。</li>      <li>根据模型的输入尺寸，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image" target="_blank">@ohos.multimedia.image</a> （实现图片处理）、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">@ohos.file.fs</a> （实现基础文件操作） API对选择图片进行裁剪、获取图片buffer数据，并进行标准化处理。</li>      <li>在 entry/src/main/ets/pages/Index.ets 中，调用封装的ArkTS模块，最后对推理结果进行处理。</li>     </ol>     <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> msliteNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'MindSporeLite'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">PERMISSIONS</span>: <span class="hljs-title class_">Permissions</span>[] = [<span class="hljs-string">'ohos.permission.READ_IMAGEVIDEO'</span>];</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'MindSporeLite C Demo'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">modelName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'mobilenetv2.ms'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">modelInputHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">224</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">modelInputWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">224</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">max</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">maxIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">maxArray</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">maxIndexArray</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        <span class="hljs-title class_">Button</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'photo'</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> resMgr = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">resourceManager</span>;</li><li>          <span class="hljs-keyword">if</span> (resMgr === <span class="hljs-literal">null</span> || resMgr === <span class="hljs-literal">undefined</span>){</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_ERR: get resMgr failed.`</span>);</li><li>            <span class="hljs-keyword">return</span></li><li>          }</li><li>
</li><li>          <span class="hljs-comment">// 获取相册图片</span></li><li>          <span class="hljs-comment">// 1.创建图片文件选择实例</span></li><li>          <span class="hljs-keyword">let</span> photoSelectOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>
</li><li>          <span class="hljs-comment">// 2.设置选择媒体文件类型为IMAGE，设置选择媒体文件的最大数目</span></li><li>          photoSelectOptions.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;</li><li>          photoSelectOptions.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>
</li><li>          <span class="hljs-comment">// 3.创建图库选择器实例，调用select()接口拉起图库界面进行文件选择。文件选择成功后，返回photoSelectResult结果集。</span></li><li>          <span class="hljs-keyword">let</span> photoPicker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>          photoPicker.<span class="hljs-title function_">select</span>(photoSelectOptions,</li><li>            <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">photoSelectResult</span>: photoAccessHelper.<span class="hljs-property">PhotoSelectResult</span>) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (err) {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                  <span class="hljs-string">`MS_LITE_ERR: PhotoViewPicker.select failed with err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                <span class="hljs-string">`MS_LITE_LOG: PhotoViewPicker.select successfully, uri: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(photoSelectResult)}</span>`</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">uris</span> = photoSelectResult.<span class="hljs-property">photoUris</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: uri: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.uris}</span>`</span>);</li><li>
</li><li>              <span class="hljs-comment">// 预处理图片数据</span></li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-comment">// 1.使用fileIo.openSync接口，通过uri打开这个文件得到fd</span></li><li>                <span class="hljs-keyword">let</span> file = fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uris</span>[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: file fd: <span class="hljs-subst">${file.fd}</span>`</span>);</li><li>
</li><li>                <span class="hljs-comment">// 2.通过fd使用fileIo.readSync接口读取这个文件内的数据</span></li><li>                <span class="hljs-keyword">let</span> inputBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">4096000</span>);</li><li>                <span class="hljs-keyword">let</span> readLen = fileIo.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, inputBuffer);</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                  <span class="hljs-string">`MS_LITE_LOG: readSync data to file succeed and inputBuffer size is: <span class="hljs-subst">${readLen}</span>`</span>);</li><li>
</li><li>                <span class="hljs-comment">// 3.通过PixelMap预处理</span></li><li>                <span class="hljs-keyword">let</span> imageSource = image.<span class="hljs-title function_">createImageSource</span>(file.<span class="hljs-property">fd</span>);</li><li>                <span class="hljs-keyword">if</span> (imageSource === <span class="hljs-literal">undefined</span>) {</li><li>                  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_ERR: createImageSource failed.`</span>);</li><li>                  <span class="hljs-keyword">return</span></li><li>                }</li><li>                imageSource.<span class="hljs-title function_">createPixelMap</span>({ <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pixelMap</span>) =&gt;</span> {</li><li>                  pixelMap.<span class="hljs-title function_">getImageInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>                    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                      <span class="hljs-string">`MS_LITE_LOG: info.width = <span class="hljs-subst">${info.size.width}</span>`</span>);</li><li>                    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                      <span class="hljs-string">`MS_LITE_LOG: info.height = <span class="hljs-subst">${info.size.height}</span>`</span>);</li><li>
</li><li>                    <span class="hljs-comment">// 4.根据模型输入的尺寸，将图片裁剪为对应的size，获取图片buffer数据readBuffer</span></li><li>                    pixelMap.<span class="hljs-title function_">scale</span>(<span class="hljs-number">256.0</span> / info.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>, <span class="hljs-number">256.0</span> / info.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      pixelMap.<span class="hljs-title function_">crop</span>({</li><li>                        <span class="hljs-attr">x</span>: <span class="hljs-number">16</span>,</li><li>                        <span class="hljs-attr">y</span>: <span class="hljs-number">16</span>,</li><li>                        <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputHeight</span>, <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputWidth</span> }</li><li>                      }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>                        <span class="hljs-keyword">let</span> info = <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">getImageInfo</span>();</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: crop info.width = <span class="hljs-subst">${info.size.width}</span>`</span>);</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: crop info.height = <span class="hljs-subst">${info.size.height}</span>`</span>);</li><li>                        <span class="hljs-comment">// 需要创建的像素buffer大小</span></li><li>                        <span class="hljs-keyword">let</span> readBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputHeight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputWidth</span> * <span class="hljs-number">4</span>);</li><li>                        <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">readPixelsToBuffer</span>(readBuffer);</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: Succeeded in reading image pixel data, buffer: <span class="hljs-subst">${readBuffer.byteLength}</span>`</span>);</li><li>                        <span class="hljs-comment">// 处理readBuffer，转换成float32格式，并进行标准化处理</span></li><li>                        <span class="hljs-keyword">const</span> imageArr =</li><li>                          <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(readBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputHeight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputWidth</span> * <span class="hljs-number">4</span>));</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: imageArr length: <span class="hljs-subst">${imageArr.length}</span>`</span>);</li><li>
</li><li>                        <span class="hljs-keyword">let</span> means = [<span class="hljs-number">0.485</span>, <span class="hljs-number">0.456</span>, <span class="hljs-number">0.406</span>];</li><li>                        <span class="hljs-keyword">let</span> stds = [<span class="hljs-number">0.229</span>, <span class="hljs-number">0.224</span>, <span class="hljs-number">0.225</span>];</li><li>                        <span class="hljs-keyword">let</span> float32View = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputHeight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelInputWidth</span> * <span class="hljs-number">3</span>);</li><li>                        <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; imageArr.<span class="hljs-property">length</span>; i++) {</li><li>                          <span class="hljs-keyword">if</span> ((i + <span class="hljs-number">1</span>) % <span class="hljs-number">4</span> === <span class="hljs-number">0</span>) {</li><li>                            float32View[index] = (imageArr[i - <span class="hljs-number">3</span>] / <span class="hljs-number">255.0</span> - means[<span class="hljs-number">0</span>]) / stds[<span class="hljs-number">0</span>]; <span class="hljs-comment">// B</span></li><li>                            float32View[index+<span class="hljs-number">1</span>] = (imageArr[i - <span class="hljs-number">2</span>] / <span class="hljs-number">255.0</span> - means[<span class="hljs-number">1</span>]) / stds[<span class="hljs-number">1</span>]; <span class="hljs-comment">// G</span></li><li>                            float32View[index+<span class="hljs-number">2</span>] = (imageArr[i - <span class="hljs-number">1</span>] / <span class="hljs-number">255.0</span> - means[<span class="hljs-number">2</span>]) / stds[<span class="hljs-number">2</span>]; <span class="hljs-comment">// R</span></li><li>                            index += <span class="hljs-number">3</span>;</li><li>                          }</li><li>                        }</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: float32View length: <span class="hljs-subst">${float32View.length}</span>`</span>);</li><li>                        <span class="hljs-keyword">let</span> printStr = <span class="hljs-string">'float32View data:'</span>;</li><li>                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {</li><li>                          printStr += <span class="hljs-string">' '</span> + float32View[i];</li><li>                        }</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: float32View data: <span class="hljs-subst">${printStr}</span>`</span>);</li><li>
</li><li>                        <span class="hljs-comment">// 调用c++的runDemo</span></li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: *** Start MSLite Demo ***`</span>);</li><li>
</li><li>                        <span class="hljs-keyword">let</span> <span class="hljs-attr">output</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = msliteNapi.<span class="hljs-title function_">runDemo</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(float32View), resMgr);</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_WARN: output length = <span class="hljs-subst">${output.length}</span>, value = <span class="hljs-subst">${output.slice(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>)}</span>`</span>);</li><li>
</li><li>                        <span class="hljs-comment">// 取分类占比的最大值top5</span></li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span> = <span class="hljs-number">0</span>;</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndex</span> = <span class="hljs-number">0</span>;</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxArray</span> = [];</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndexArray</span> = [];</li><li>                        <span class="hljs-keyword">let</span> newArray = output.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span>);</li><li>                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> n = <span class="hljs-number">0</span>; n &lt; <span class="hljs-number">5</span>; n++) {</li><li>                          <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span> = output[<span class="hljs-number">0</span>];</li><li>                          <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndex</span> = <span class="hljs-number">0</span>;</li><li>                          <span class="hljs-comment">// 取最大值</span></li><li>                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> m = <span class="hljs-number">0</span>; m &lt; newArray.<span class="hljs-property">length</span>; m++) {</li><li>                            <span class="hljs-keyword">if</span> (newArray[m] &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span>) {</li><li>                              <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span> = newArray[m];</li><li>                              <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndex</span> = m;</li><li>                            }</li><li>                          }</li><li>                          <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span> * <span class="hljs-number">10000</span>));</li><li>                          <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndexArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxIndex</span>);</li><li>                          <span class="hljs-comment">// filter数组过滤函数</span></li><li>                          newArray = newArray.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">max</span>);</li><li>                        }</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: max: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.maxArray}</span>`</span>);</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: maxIndex: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.maxIndexArray}</span>`</span>);</li><li>
</li><li>                        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_LOG: *** Finished MSLite Demo ***`</span>);</li><li>                      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>                        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                          <span class="hljs-string">`MS_LITE_ERR: getRawFileContent promise error is: <span class="hljs-subst">${error}</span>`</span>);</li><li>                      })</li><li>                    })</li><li>                    <span class="hljs-comment">// 5.关闭文件</span></li><li>                    fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>                  })</li><li>                })</li><li>              } <span class="hljs-keyword">catch</span> (err) {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                  <span class="hljs-string">`MS_LITE_ERR: uri: open file fd failed. <span class="hljs-subst">${err}</span>`</span>);</li><li>              }</li><li>            })</li><li>        })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在DevEco Studio中连接设备，点击Run entry，编译Hap，有如下显示：</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>Launching com.samples.mindsporelitecdemo</li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell aa force-stop com.samples.mindsporelitecdemo</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell <span class="hljs-built_in">mkdir</span> data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc file send C:\Users\xxx\MindSporeLiteCDemo\entry\build\default\outputs\default\entry-default-signed.hap <span class="hljs-string">"data/local/tmp/xxx"</span></span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell bm install -p data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell <span class="hljs-built_in">rm</span> -rf data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell aa start -a EntryAbility -b com.samples.mindsporelitecdemo</span></li></ol></pre></div></div></li>      <li>       <p>在设备屏幕点击photo按钮，选择图片，点击确定。设备屏幕显示所选图片的分类结果，在日志打印结果中，过滤关键字”MS_LITE“，可得到如下结果：</p>       <div _ngcontent-ref-c106="" class="highlight-div"><div _ngcontent-ref-c106="" class="highlight-div-header"><div _ngcontent-ref-c106="" class="highlight-div-header-left"><div _ngcontent-ref-c106="" class="handle-button expand-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ref-c106="" class="highlight-div-header-right"><div _ngcontent-ref-c106="" class="handle-button ai-button"></div><div _ngcontent-ref-c106="" class="handle-button line-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ref-c106="" class="handle-button theme-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ref-c106="" class="handle-button copy-button"><div _ngcontent-ref-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ref-c106="" class="highlight-scroll-div"><pre class="verilog prettyprint linenums hljs language-cangjie" hw-language="verilog" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.001</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">PhotoViewPicker</span>.<span class="hljs-title class_">select</span> <span class="hljs-title class_">successfully</span>, <span class="hljs-variable">photoSelectResult</span> <span class="hljs-variable">uri</span>: {<span class="hljs-string">"photoUris"</span>:[<span class="hljs-string">"file://media/Photo/13/IMG_1501955351_012/plant.jpg"</span>]}</li><li>...</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.627</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">crop</span> <span class="hljs-title class_">info</span>.<span class="hljs-title class_">width</span> = <span class="hljs-number">224</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.627</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">crop</span> <span class="hljs-title class_">info</span>.<span class="hljs-title class_">height</span> = <span class="hljs-number">224</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.628</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Succeeded</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">reading</span> <span class="hljs-title class_">image</span> <span class="hljs-title class_">pixel</span> <span class="hljs-title class_">data</span>, <span class="hljs-variable">buffer</span>: <span class="hljs-number">200704</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.971</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">float32View</span> <span class="hljs-title class_">data</span>: <span class="hljs-title class_">float32View</span> <span class="hljs-title class_">data</span>: <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span> <span class="hljs-number">1.4722440242767334</span> <span class="hljs-number">1.2385478019714355</span> <span class="hljs-number">1.308123230934143</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">52.971</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: *** <span class="hljs-title class_">Start</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">Demo</span> ***</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.454</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Build</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">success</span>.</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.753</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Run</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">Predict</span> <span class="hljs-title class_">success</span>.</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.753</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Get</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">outputs</span>:</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.753</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-number">0</span> <span class="hljs-title class_">name</span> <span class="hljs-keyword">is</span>: <span class="hljs-title class_">Default</span>/<span class="hljs-variable">head</span>-<span class="hljs-variable">MobileNetV2Head</span>/<span class="hljs-variable">Sigmoid</span>-<span class="hljs-variable">op466</span>.</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.753</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-title class_">data</span> <span class="hljs-keyword">is</span>:</li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.753</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]            <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-number">3.43385e-06</span> <span class="hljs-number">1.40285e-05</span> <span class="hljs-number">9.11969e-07</span> <span class="hljs-number">4.91007e-05</span> <span class="hljs-number">9.50266e-07</span> <span class="hljs-number">3.94537e-07</span> <span class="hljs-number">0.0434676</span> <span class="hljs-number">3.97196e-05</span> <span class="hljs-number">0.00054832</span> <span class="hljs-number">0.000246202</span> <span class="hljs-number">1.576e-05</span> <span class="hljs-number">3.6494e-06</span> <span class="hljs-number">1.23553e-05</span> <span class="hljs-number">0.196977</span> <span class="hljs-number">5.3028e-05</span> <span class="hljs-number">3.29346e-05</span> <span class="hljs-number">4.90475e-07</span> <span class="hljs-number">1.66109e-06</span> <span class="hljs-number">7.03273e-06</span> <span class="hljs-number">8.83677e-07</span> <span class="hljs-number">3.1365e-06</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.781</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">W</span>     <span class="hljs-variable">MS_LITE_WARN</span>: <span class="hljs-title class_">output</span> <span class="hljs-title class_">length</span> =  <span class="hljs-number">500</span> ;<span class="hljs-variable">value</span> =  <span class="hljs-number">0.0000034338463592575863</span>,<span class="hljs-number">0.000014028532859811094</span>,<span class="hljs-number">9.119685273617506e-7</span>,<span class="hljs-number">0.000049100715841632336</span>,<span class="hljs-number">9.502661555416125e-7</span>,<span class="hljs-number">3.945370394831116e-7</span>,<span class="hljs-number">0.04346757382154465</span>,<span class="hljs-number">0.00003971960904891603</span>,<span class="hljs-number">0.0005483203567564487</span>,<span class="hljs-number">0.00024620210751891136</span>,<span class="hljs-number">0.000015759984307806008</span>,<span class="hljs-number">0.0000036493988773145247</span>,<span class="hljs-number">0.00001235533181898063</span>,<span class="hljs-number">0.1969769448041916</span>,<span class="hljs-number">0.000053027983085485175</span>,<span class="hljs-number">0.000032934600312728435</span>,<span class="hljs-number">4.904751449430478e-7</span>,<span class="hljs-number">0.0000016610861166554969</span>,<span class="hljs-number">0.000007032729172351537</span>,<span class="hljs-number">8.836767619868624e-7</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.831</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">max</span>:<span class="hljs-number">9497</span>,<span class="hljs-number">7756</span>,<span class="hljs-number">1970</span>,<span class="hljs-number">435</span>,<span class="hljs-number">46</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.831</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">maxIndex</span>:<span class="hljs-number">323</span>,<span class="hljs-number">46</span>,<span class="hljs-number">13</span>,<span class="hljs-number">6</span>,<span class="hljs-number">349</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">05</span> <span class="hljs-number">17</span>:<span class="hljs-number">15</span>:<span class="hljs-number">53.831</span>   <span class="hljs-number">4684</span>-<span class="hljs-number">4684</span>    <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                   <span class="hljs-variable">pid</span>-<span class="hljs-number">4684</span>              <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: *** <span class="hljs-title class_">Finished</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">Demo</span> ***</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="效果示意">效果示意<i class="anchor-icon anchor-icon-link" anchorid="效果示意" tips="复制节点链接"></i></h3>          <p>在设备上，点击photo按钮，选择相册中的一张图片，点击确定。在图片下方显示此图片占比前4的分类信息。</p>     <p><span><img originheight="597" originwidth="342" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114226.67261500378065161763879291227750:50001231000000:2800:4DF7B6C081D0E3A39C520F80D32A1EFC64B06BC749CCBA9D1E646960B9EC9E05.png" width="342" height="597"></span> <span><img originheight="669" originwidth="391" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114226.15679987586556534194554925158546:50001231000000:2800:56A5657E38D30ECA51E3BCB7A8AF07D5F47910D622E9FA3FA13E46CB81F3F1DA.png" width="391" height="669"></span></p>     <p><span><img originheight="619" originwidth="395" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114227.18817916281941408884036437567473:50001231000000:2800:0FD1E3798B657CC07A7E9E13B06DF22B9BEAE6B5B3B3337F684BE88E41188FBF.png" width="395" height="619"></span> <span><img originheight="662" originwidth="345" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114227.53463512221389155759408208455482:50001231000000:2800:746813DA7C9DEC1F11EDAB8CA038B402D0C317C8F962EB35A0B5782363F21706.png" width="345" height="662"></span></p>    </div>   </div>   <div></div></div>