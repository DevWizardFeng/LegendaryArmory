<h1 _ngcontent-vqp-c119="" class="doc-title ng-star-inserted" title="使用MindSpore Lite实现语音识别（C/C++）"> 使用MindSpore Lite实现语音识别（C/C++） </h1>

<div _ngcontent-vqp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景说明">场景说明<i class="anchor-icon anchor-icon-link" anchorid="场景说明" tips="复制节点链接"></i></h2>          <p>开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>，在UI代码中集成MindSpore Lite能力，快速部署AI算法，进行AI模型推理，实现语音识别的应用。</p>     <p>语音识别可以将一段音频信息转换为文本，在智能语音助手、语音输入、语音搜索等领域有广泛的应用。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>N-API：用于构建ArkTS本地化组件的一套接口。可利用N-API，将C/C++开发的库封装成ArkTS模块。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2>          <ol>      <li>选择语音识别模型。</li>      <li>在端侧使用MindSpore Lite推理模型，实现对语音文件的语音识别。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>          <p>安装DevEco Studio，要求版本 &gt;= 5.0.2，并更新SDK到API 14或以上。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>本文以对语音识别模型进行推理为例，提供使用MindSpore Lite实现语音识别应用的开发指导。</p>    </div>    <div class="tiledSection">     <h3 id="选择模型" class="firsth2">选择模型<i class="anchor-icon anchor-icon-link" anchorid="选择模型" tips="复制节点链接"></i></h3>          <p>本示例程序中使用的语音识别模型文件为tiny-encoder.ms、tiny-decoder-main.ms、tiny-decoder-loop.ms，放置在entry/src/main/resources/rawfile工程目录下。</p>    </div>    <div class="tiledSection">     <h3 id="编写播放音频代码">编写播放音频代码<i class="anchor-icon anchor-icon-link" anchorid="编写播放音频代码" tips="复制节点链接"></i></h3>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media" target="_blank">@ohos.multimedia.media</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio" target="_blank">@ohos.multimedia.audio</a>，实现播放音频的功能。</p>     <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// player.ets</span></li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'MindSporeLite'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayerDemo</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isSeek</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 用于区分模式是否支持seek操作。</span></li><li>  <span class="hljs-comment">// 注册avplayer回调函数。</span></li><li>  <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-params">avPlayer: media.AVPlayer</span>) {</li><li>    <span class="hljs-comment">// seek操作结果回调函数。</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seekDone'</span>, <span class="hljs-function">(<span class="hljs-params">seekDoneTime: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: AVPlayer seek succeeded, seek time is <span class="hljs-subst">${seekDoneTime}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// error回调监听函数，当avPlayer在操作过程中出现错误时调用reset接口触发重置流程。</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>        <span class="hljs-string">`MS_LITE_ERR: Invoke avPlayer failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      avPlayer.<span class="hljs-title function_">reset</span>(); <span class="hljs-comment">// 调用reset重置资源，触发idle状态。</span></li><li>    });</li><li>    <span class="hljs-comment">// 状态机变化回调函数。</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">state</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">reason</span>: media.<span class="hljs-property">StateChangeReason</span>) =&gt; {</li><li>      <span class="hljs-keyword">switch</span> (state) {</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'idle'</span>: <span class="hljs-comment">// 成功调用reset接口后触发该状态机上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state idle called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">release</span>(); <span class="hljs-comment">// 调用release接口销毁实例对象。</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// avplayer 设置播放源后触发该状态上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state initialized called.'</span>);</li><li>          avPlayer.<span class="hljs-property">audioRendererInfo</span> = {</li><li>            <span class="hljs-attr">usage</span>: audio.<span class="hljs-property">StreamUsage</span>.<span class="hljs-property">STREAM_USAGE_MUSIC</span>, <span class="hljs-comment">// 音频流使用类型：音乐。根据业务场景配置。</span></li><li>            <span class="hljs-attr">rendererFlags</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 音频渲染器标志。</span></li><li>          };</li><li>          avPlayer.<span class="hljs-title function_">prepare</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>: <span class="hljs-comment">// prepare调用成功后上报该状态机。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state prepared called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">play</span>(); <span class="hljs-comment">// 调用播放接口开始播放。</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'playing'</span>: <span class="hljs-comment">// play成功调用后触发该状态机上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state playing called.'</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSeek</span>) {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer start to seek.'</span>);</li><li>            avPlayer.<span class="hljs-title function_">seek</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 将播放位置移动到音频的开始。</span></li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// 当播放模式不支持seek操作时继续播放到结尾。</span></li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer wait to play end.'</span>);</li><li>          }</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'paused'</span>: <span class="hljs-comment">// pause成功调用后触发该状态机上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state paused called.'</span>);</li><li>          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer paused wait to play again'</span>);</li><li>            avPlayer.<span class="hljs-title function_">play</span>(); <span class="hljs-comment">// 暂停3s后再次调用播放接口开始播放。</span></li><li>          }, <span class="hljs-number">3000</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>: <span class="hljs-comment">// 播放结束后触发该状态机上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state completed called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">// 调用播放结束接口。</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'stopped'</span>: <span class="hljs-comment">// stop接口成功调用后触发该状态机上报。</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state stopped called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">reset</span>(); <span class="hljs-comment">// 调用reset接口初始化avplayer状态。</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'released'</span>:</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state released called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'MS_LITE_LOG: AVPlayer state unknown called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 使用资源管理接口获取音频文件并通过fdSrc属性进行播放。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">avPlayerFdSrcDemo</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 创建avPlayer实例对象。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avPlayer</span>: media.<span class="hljs-property">AVPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// 创建状态机变化回调函数。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>(avPlayer);</li><li>    <span class="hljs-comment">// 通过UIAbilityContext的resourceManager成员的getRawFd接口获取媒体资源播放地址。</span></li><li>    <span class="hljs-comment">// 返回类型为{fd,offset,length},fd为HAP包fd地址，offset为媒体资源偏移量，length为播放长度。</span></li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'zh.wav'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avFileDescriptor</span>: media.<span class="hljs-property">AVFileDescriptor</span> =</li><li>      { <span class="hljs-attr">fd</span>: fileDescriptor.<span class="hljs-property">fd</span>, <span class="hljs-attr">offset</span>: fileDescriptor.<span class="hljs-property">offset</span>, <span class="hljs-attr">length</span>: fileDescriptor.<span class="hljs-property">length</span> };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSeek</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 支持seek操作。</span></li><li>    <span class="hljs-comment">// 为fdSrc赋值触发initialized状态机上报。</span></li><li>    avPlayer.<span class="hljs-property">fdSrc</span> = avFileDescriptor;</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="编写识别音频代码">编写识别音频代码<i class="anchor-icon anchor-icon-link" anchorid="编写识别音频代码" tips="复制节点链接"></i></h3>          <p>在 entry/src/main/cpp/mslite_napi.cpp，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>，依次对3个模型进行推理，推理代码流程如下。</p>     <ol>      <li>       <p>引用对应的头文件。说明：需要用户下载三方库，其中librosa来源是<a href="https://github.com/ewan-xu/LibrosaCpp" target="_blank">LibrosaCpp</a>，libsamplerate来源是<a href="https://github.com/libsndfile/libsamplerate" target="_blank">libsamplerate</a>，下载后置于entry/src/main/cpp/third_party目录下。AudioFile.h、base64.h、base64.cc来源是<a href="https://github.com/ml-inory/whisper.axera/tree/main/cpp/src" target="_blank">whisper.axera</a>，下载后置于entry/src/main/cpp/src目录下。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioFile.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"base64.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"utils.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;librosa/librosa.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/context.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/model.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/status.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/tensor.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mindspore/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;numeric&gt;</span> </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file_manager.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>读取音频文件、模型文件等，转换为buffer数据。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGI</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGD</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGW</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_WARN, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li><li><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">LOGE</span>(...) ((void)<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_DOMAIN, "[MSLiteNapi]", __VA_ARGS__))</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">using</span> BinBuffer = std::pair&lt;<span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>&gt;;</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">BinBuffer <span class="hljs-title">ReadBinFile</span><span class="hljs-params">(NativeResourceManager *nativeResourceManager, <span class="hljs-type">const</span> std::string &amp;modelName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(nativeResourceManager, modelName.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">if</span> (rawFile == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Open model file failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">long</span> fileSize = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>    <span class="hljs-keyword">if</span> (fileSize &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: FileSize not correct"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">void</span> *buffer = <span class="hljs-built_in">malloc</span>(fileSize);</li><li>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: OH_ResourceManager_ReadRawFile failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, buffer, fileSize);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: OH_ResourceManager_ReadRawFile failed"</span>);</li><li>        <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(buffer, fileSize);</li><li>}</li><li>
</li><li><span class="hljs-function">BinBuffer <span class="hljs-title">ReadTokens</span><span class="hljs-params">(NativeResourceManager *nativeResourceManager, <span class="hljs-type">const</span> std::string &amp;modelName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(nativeResourceManager, modelName.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">if</span> (rawFile == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Open model file failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">long</span> fileSize = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>    <span class="hljs-keyword">if</span> (fileSize &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: FileSize not correct"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">void</span> *buffer = <span class="hljs-built_in">malloc</span>(fileSize);</li><li>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: OH_ResourceManager_ReadRawFile failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, buffer, fileSize);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: OH_ResourceManager_ReadRawFile failed"</span>);</li><li>        <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BinBuffer</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>    <span class="hljs-function">BinBuffer <span class="hljs-title">res</span><span class="hljs-params">(buffer, fileSize)</span></span>;</li><li>    <span class="hljs-keyword">return</span> res;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建上下文，设置设备类型，并加载模型。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DestroyModelBuffer</span><span class="hljs-params">(<span class="hljs-type">void</span> **buffer)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(*buffer);</li><li>    *buffer = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">OH_AI_ModelHandle <span class="hljs-title">CreateMSLiteModel</span><span class="hljs-params">(BinBuffer &amp;bin)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建并配置上下文</span></li><li>    <span class="hljs-keyword">auto</span> context = <span class="hljs-built_in">OH_AI_ContextCreate</span>();</li><li>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;bin.first);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Create MSLite context failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> cpu_device_info = <span class="hljs-built_in">OH_AI_DeviceInfoCreate</span>(OH_AI_DEVICETYPE_CPU);</li><li>    <span class="hljs-built_in">OH_AI_DeviceInfoSetEnableFP16</span>(cpu_device_info, <span class="hljs-literal">false</span>);</li><li>    <span class="hljs-built_in">OH_AI_ContextAddDeviceInfo</span>(context, cpu_device_info);</li><li>
</li><li>    <span class="hljs-comment">// 创建模型</span></li><li>    <span class="hljs-keyword">auto</span> model = <span class="hljs-built_in">OH_AI_ModelCreate</span>();</li><li>    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;bin.first);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Allocate MSLite Model failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 加载与编译模型，模型的类型为OH_AI_MODELTYPE_MINDIR</span></li><li>    <span class="hljs-keyword">auto</span> build_ret = <span class="hljs-built_in">OH_AI_ModelBuild</span>(model, bin.first, bin.second, OH_AI_MODELTYPE_MINDIR, context);</li><li>    <span class="hljs-built_in">DestroyModelBuffer</span>(&amp;bin.first);</li><li>    <span class="hljs-keyword">if</span> (build_ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_AI_ModelDestroy</span>(&amp;model);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Build MSLite model failed.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: Build MSLite model success.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> model;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置模型输入数据，执行模型推理。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> K_NUM_PRINT_OF_OUT_DATA = <span class="hljs-number">20</span>;</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FillInputTensor</span><span class="hljs-params">(OH_AI_TensorHandle input, <span class="hljs-type">const</span> BinBuffer &amp;bin)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AI_TensorGetDataSize</span>(input) != bin.second) {</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_INPUT_PARAM_INVALID;</li><li>    }</li><li>    <span class="hljs-type">char</span> *data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">OH_AI_TensorGetMutableData</span>(input);</li><li>    <span class="hljs-built_in">memcpy</span>(data, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)bin.first, <span class="hljs-built_in">OH_AI_TensorGetDataSize</span>(input));</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 执行模型推理</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RunMSLiteModel</span><span class="hljs-params">(OH_AI_ModelHandle model, std::vector&lt;BinBuffer&gt; inputBins)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 设置模型的输入数据</span></li><li>    <span class="hljs-keyword">auto</span> inputs = <span class="hljs-built_in">OH_AI_ModelGetInputs</span>(model);</li><li>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; inputBins.<span class="hljs-built_in">size</span>(); i++)</li><li>    {</li><li>        <span class="hljs-keyword">auto</span> ret = <span class="hljs-built_in">FillInputTensor</span>(inputs.handle_list[i], inputBins[i]);</li><li>        <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>            <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: set input %{public}d error.\n"</span>, i);</li><li>            <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取模型的输出张量</span></li><li>    <span class="hljs-keyword">auto</span> outputs = <span class="hljs-built_in">OH_AI_ModelGetOutputs</span>(model);</li><li>
</li><li>    <span class="hljs-comment">// 模型推理</span></li><li>    <span class="hljs-keyword">auto</span> predict_ret = <span class="hljs-built_in">OH_AI_ModelPredict</span>(model, inputs, &amp;outputs, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (predict_ret != OH_AI_STATUS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_AI_ModelDestroy</span>(&amp;model);</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: MSLite Predict error.\n"</span>);</li><li>        <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: Run MSLite model Predict success.\n"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 打印输出数据</span></li><li>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: Get model outputs:\n"</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outputs.handle_num; i++) {</li><li>        <span class="hljs-keyword">auto</span> tensor = outputs.handle_list[i];</li><li>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor %{public}d name is: %{public}s.\n"</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(i),</li><li>             <span class="hljs-built_in">OH_AI_TensorGetName</span>(tensor));</li><li>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor %{public}d size is: %{public}d.\n"</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(i),</li><li>             (<span class="hljs-type">int</span>)<span class="hljs-built_in">OH_AI_TensorGetDataSize</span>(tensor));</li><li>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: - Tensor data is:\n"</span>);</li><li>        <span class="hljs-keyword">auto</span> out_data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">float</span> *&gt;(<span class="hljs-built_in">OH_AI_TensorGetData</span>(tensor));</li><li>        std::stringstream outStr;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; (i &lt; <span class="hljs-built_in">OH_AI_TensorGetElementNum</span>(tensor)) &amp;&amp; (i &lt;= K_NUM_PRINT_OF_OUT_DATA); i++) {</li><li>            outStr &lt;&lt; out_data[i] &lt;&lt; <span class="hljs-string">" "</span>;</li><li>        }</li><li>        <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">"MS_LITE_LOG: %{public}s"</span>, outStr.<span class="hljs-built_in">str</span>().<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用以上方法，实现3个模型的推理流程。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">float</span> NEG_INF = -std::numeric_limits&lt;<span class="hljs-type">float</span>&gt;::<span class="hljs-built_in">infinity</span>();</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_SOT = <span class="hljs-number">50258</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_TRANSCRIBE = <span class="hljs-number">50359</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_TRANSLATE = <span class="hljs-number">50358</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_NO_TIMESTAMPS = <span class="hljs-number">50363</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_EOT = <span class="hljs-number">50257</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_BLANK = <span class="hljs-number">220</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_NO_SPEECH = <span class="hljs-number">50362</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_N_TEXT_CTX = <span class="hljs-number">448</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> WHISPER_N_TEXT_STATE = <span class="hljs-number">384</span>;</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> WHISPER_SAMPLE_RATE = <span class="hljs-number">16000</span>;</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">BinBuffer <span class="hljs-title">GetMSOutput</span><span class="hljs-params">(OH_AI_TensorHandle output)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">float</span> *outputData = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">float</span> *&gt;(<span class="hljs-built_in">OH_AI_TensorGetMutableData</span>(output));</li><li>    <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">OH_AI_TensorGetDataSize</span>(output);</li><li>    <span class="hljs-keyword">return</span> {outputData, size};</li><li>}</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SuppressTokens</span><span class="hljs-params">(BinBuffer &amp;logits, <span class="hljs-type">bool</span> isInitial)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">auto</span> logits_data = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">float</span> *&gt;(logits.first);</li><li>    <span class="hljs-keyword">if</span> (isInitial) {</li><li>        logits_data[WHISPER_EOT] = NEG_INF;</li><li>        logits_data[WHISPER_BLANK] = NEG_INF;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 其他令牌的抑制</span></li><li>    logits_data[WHISPER_NO_TIMESTAMPS] = NEG_INF;</li><li>    logits_data[WHISPER_SOT] = NEG_INF;</li><li>    logits_data[WHISPER_NO_SPEECH] = NEG_INF;</li><li>    logits_data[WHISPER_TRANSLATE] = NEG_INF;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">int</span>&gt; <span class="hljs-title class_">LoopPredict</span>(<span class="hljs-keyword">const</span> <span class="hljs-title class_">OH_AI_ModelHandle</span> <span class="hljs-title class_">model</span>, <span class="hljs-keyword">const</span> <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">n_layer_cross_k</span>,</li><li>                             <span class="hljs-keyword">const</span> <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">n_layer_cross_v</span>, <span class="hljs-keyword">const</span> <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">logits_init</span>,</li><li>                             <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">out_n_layer_self_k_cache</span>, <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">out_n_layer_self_v_cache</span>,</li><li>                             <span class="hljs-keyword">const</span> <span class="hljs-title class_">BinBuffer</span> &amp;<span class="hljs-title class_">data_embedding</span>, <span class="hljs-keyword">const</span> <span class="hljs-title class_">int</span> <span class="hljs-title class_">loop</span>, <span class="hljs-keyword">const</span> <span class="hljs-title class_">int</span> <span class="hljs-title class_">offset_init</span>)</li><li>{</li><li>    <span class="hljs-variable">BinBuffer</span> <span class="hljs-variable">logits</span>{<span class="hljs-variable">nullptr</span>, <span class="hljs-number">51865</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>)};</li><li>    <span class="hljs-variable">logits</span>.<span class="hljs-variable">first</span> = <span class="hljs-title function_">malloc</span>(<span class="hljs-variable">logits</span>.<span class="hljs-variable">second</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">logits</span>.<span class="hljs-variable">first</span>) {</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Fail to malloc!\n"</span>);</li><li>        <span class="hljs-keyword">return</span> {};</li><li>    }</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">logits_init_src</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-variable">logits_init</span>.<span class="hljs-variable">first</span>) + <span class="hljs-number">51865</span> * <span class="hljs-number">3</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>);</li><li>    <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">logits</span>.<span class="hljs-variable">first</span>, <span class="hljs-variable">logits_init_src</span>, <span class="hljs-variable">logits</span>.<span class="hljs-variable">second</span>);</li><li>    <span class="hljs-title function_">SuppressTokens</span>(<span class="hljs-variable">logits</span>, <span class="hljs-keyword">true</span>);</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">int</span>&gt; <span class="hljs-title class_">output_token</span>;</li><li>    <span class="hljs-variable">float</span> *<span class="hljs-variable">logits_data</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">float</span> *&gt;(<span class="hljs-variable">logits</span>.<span class="hljs-variable">first</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">max_token_id</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">float</span> <span class="hljs-variable">max_token</span> = <span class="hljs-variable">logits_data</span>[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">logits</span>.<span class="hljs-title class_">second</span> / <span class="hljs-title class_">sizeof</span>(<span class="hljs-title class_">float</span>); <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">logits_data</span>[<span class="hljs-variable">i</span>] &gt; <span class="hljs-variable">max_token</span>) {</li><li>            <span class="hljs-variable">max_token_id</span> = <span class="hljs-variable">i</span>;</li><li>            <span class="hljs-variable">max_token</span> = <span class="hljs-variable">logits_data</span>[<span class="hljs-variable">i</span>];</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">offset</span> = <span class="hljs-variable">offset_init</span>;</li><li>    <span class="hljs-variable">BinBuffer</span> <span class="hljs-variable">slice</span>{<span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>};</li><li>    <span class="hljs-variable">slice</span>.<span class="hljs-variable">second</span> = <span class="hljs-variable">WHISPER_N_TEXT_STATE</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>);</li><li>    <span class="hljs-variable">slice</span>.<span class="hljs-variable">first</span> = <span class="hljs-title function_">malloc</span>(<span class="hljs-variable">slice</span>.<span class="hljs-variable">second</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">slice</span>.<span class="hljs-variable">first</span>) {</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Fail to malloc!\n"</span>);</li><li>        <span class="hljs-keyword">return</span> {};</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">out_n_layer_self_k_cache_new</span> = <span class="hljs-variable">out_n_layer_self_k_cache</span>;</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">out_n_layer_self_v_cache_new</span> = <span class="hljs-variable">out_n_layer_self_v_cache</span>;</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">size_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">loop</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">max_token_id</span> == <span class="hljs-variable">WHISPER_EOT</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">output_token</span>.<span class="hljs-title function_">push_back</span>(<span class="hljs-variable">max_token_id</span>);</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt; <span class="hljs-title class_">mask</span>(<span class="hljs-title class_">WHISPER_N_TEXT_CTX</span>, <span class="hljs-number">0.0</span><span class="hljs-title class_">f</span>);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">size_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">WHISPER_N_TEXT_CTX</span> - <span class="hljs-title class_">offset</span> - <span class="hljs-number">1</span>; ++<span class="hljs-title class_">i</span>) {</li><li>            <span class="hljs-variable">mask</span>[<span class="hljs-variable">i</span>] = <span class="hljs-variable">NEG_INF</span>;</li><li>        }</li><li>        <span class="hljs-variable">BinBuffer</span> <span class="hljs-variable">tokens</span>{&amp;<span class="hljs-title class_">max_token_id</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">int</span>)};</li><li>
</li><li>        <span class="hljs-variable">void</span> *<span class="hljs-variable">data_embedding_src</span> =</li><li>            <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-variable">data_embedding</span>.<span class="hljs-variable">first</span>) + <span class="hljs-variable">offset</span> * <span class="hljs-variable">WHISPER_N_TEXT_STATE</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>);</li><li>        <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">slice</span>.<span class="hljs-variable">first</span>, <span class="hljs-variable">data_embedding_src</span>, <span class="hljs-variable">slice</span>.<span class="hljs-variable">second</span>);</li><li>        <span class="hljs-variable">BinBuffer</span> <span class="hljs-title function_">mask_bin</span>(<span class="hljs-variable">mask</span>.<span class="hljs-title function_">data</span>(), <span class="hljs-variable">mask</span>.<span class="hljs-title function_">size</span>() * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>));</li><li>        <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">RunMSLiteModel</span>(<span class="hljs-variable">model</span>, {<span class="hljs-variable">tokens</span>, <span class="hljs-variable">out_n_layer_self_k_cache_new</span>, <span class="hljs-variable">out_n_layer_self_v_cache_new</span>,</li><li>                                         <span class="hljs-variable">n_layer_cross_k</span>, <span class="hljs-variable">n_layer_cross_v</span>, <span class="hljs-variable">slice</span>, <span class="hljs-variable">mask_bin</span>});</li><li>
</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">outputs</span> = <span class="hljs-title function_">OH_AI_ModelGetOutputs</span>(<span class="hljs-variable">model</span>);</li><li>        <span class="hljs-variable">logits</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">outputs</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">0</span>]);</li><li>        <span class="hljs-variable">out_n_layer_self_k_cache_new</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">outputs</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">1</span>]);</li><li>        <span class="hljs-variable">out_n_layer_self_v_cache_new</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">outputs</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">2</span>]);</li><li>        <span class="hljs-variable">offset</span>++;</li><li>        <span class="hljs-title function_">SuppressTokens</span>(<span class="hljs-variable">logits</span>, <span class="hljs-keyword">false</span>);</li><li>        <span class="hljs-variable">logits_data</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">float</span> *&gt;(<span class="hljs-variable">logits</span>.<span class="hljs-variable">first</span>);</li><li>        <span class="hljs-variable">max_token</span> = <span class="hljs-variable">logits_data</span>[<span class="hljs-number">0</span>];</li><li>
</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">logits</span>.<span class="hljs-title class_">second</span> / <span class="hljs-title class_">sizeof</span>(<span class="hljs-title class_">float</span>); <span class="hljs-title class_">j</span>++) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">logits_data</span>[<span class="hljs-variable">j</span>] &gt; <span class="hljs-variable">max_token</span>) {</li><li>                <span class="hljs-variable">max_token_id</span> = <span class="hljs-variable">j</span>;</li><li>                <span class="hljs-variable">max_token</span> = <span class="hljs-variable">logits_data</span>[<span class="hljs-variable">j</span>];</li><li>            }</li><li>        }</li><li>        <span class="hljs-title function_">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: run decoder loop %{public}d ok!\n token = %{public}d"</span>, <span class="hljs-variable">i</span>, <span class="hljs-variable">max_token_id</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">output_token</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">string</span>&gt; <span class="hljs-title class_">ProcessDataLines</span>(<span class="hljs-keyword">const</span> <span class="hljs-title class_">BinBuffer</span> <span class="hljs-title class_">token_txt</span>)</li><li>{</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">data_ptr</span> = <span class="hljs-variable">token_txt</span>.<span class="hljs-variable">first</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">data_size</span> = <span class="hljs-variable">token_txt</span>.<span class="hljs-variable">second</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">string</span>&gt; <span class="hljs-title class_">tokens</span>;</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">char_data</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-title class_">char</span> *&gt;(<span class="hljs-variable">data_ptr</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">stringstream</span> <span class="hljs-title class_">ss</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span>(<span class="hljs-title class_">char_data</span>, <span class="hljs-variable">char_data</span> <span class="hljs-variable">+ data_size</span>));</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">line</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">getline</span>(<span class="hljs-title class_">ss</span>, <span class="hljs-title class_">line</span>)) {</li><li>        <span class="hljs-variable">size_t</span> <span class="hljs-variable">space_pos</span> = <span class="hljs-variable">line</span>.<span class="hljs-title function_">find</span>(<span class="hljs-string">' '</span>);</li><li>        <span class="hljs-variable">tokens</span>.<span class="hljs-title function_">push_back</span>(<span class="hljs-variable">line</span>.<span class="hljs-title function_">substr</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">space_pos</span>));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">tokens</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">RunDemo</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>)</li><li>{</li><li>    <span class="hljs-comment">// 执行样例推理</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">error_ret</span>;</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, -<span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">error_ret</span>);</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">argv</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">argv</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">resourcesManager</span> = <span class="hljs-title function_">OH_ResourceManager_InitNativeResourceManager</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">argv</span>[<span class="hljs-number">0</span>]);</li><li>
</li><li>    <span class="hljs-comment">// 数据预处理</span></li><li>    <span class="hljs-title class_">AudioFile</span>&lt;<span class="hljs-title class_">float</span>&gt; <span class="hljs-variable">audioFile</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">filePath</span> = <span class="hljs-string">"zh.wav"</span>;</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">audioBin</span> = <span class="hljs-title function_">ReadBinFile</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-variable">filePath</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioBin</span>.<span class="hljs-variable">first</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Fail to read  %{public}s!"</span>, <span class="hljs-variable">filePath</span>.<span class="hljs-title function_">c_str</span>());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">dataSize</span> = <span class="hljs-variable">audioBin</span>.<span class="hljs-variable">second</span>;</li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">dataBuffer</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">audioBin</span>.<span class="hljs-variable">first</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">ok</span> = <span class="hljs-variable">audioFile</span>.<span class="hljs-title function_">loadFromMemory</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;(<span class="hljs-title class_">dataBuffer</span>, <span class="hljs-variable">dataBuffer</span> <span class="hljs-variable">+ dataSize</span>));</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">ok</span>) {</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"MS_LITE_ERR: Fail to read  %{public}s!"</span>, <span class="hljs-variable">filePath</span>.<span class="hljs-title function_">c_str</span>());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt; <span class="hljs-title class_">data</span>(<span class="hljs-title class_">audioFile</span>.<span class="hljs-title class_">samples</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-title function_">ResampleAudio</span>(<span class="hljs-variable">data</span>, <span class="hljs-variable">audioFile</span>.<span class="hljs-title function_">getSampleRate</span>(), <span class="hljs-variable">WHISPER_SAMPLE_RATE</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">SRC_SINC_BEST_QUALITY</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt; <span class="hljs-title class_">audio</span>(<span class="hljs-title class_">data</span>);</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">padding</span> = <span class="hljs-number">480000</span>;</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">sr</span> = <span class="hljs-number">16000</span>;</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">n_fft</span> = <span class="hljs-number">480</span>;</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">n_hop</span> = <span class="hljs-number">160</span>;</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">n_mel</span> = <span class="hljs-number">80</span>;</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">fmin</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 最小频率，默认值为0.0 Hz</span></li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">fmax</span> =</li><li>        <span class="hljs-variable">sr</span> /</li><li>        <span class="hljs-number">2.0</span>; <span class="hljs-comment">// 最大频率，默认值为采样率（sr/2.0）的一半</span></li><li>    <span class="hljs-variable">audio</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-variable">audio</span>.<span class="hljs-title function_">end</span>(), <span class="hljs-variable">padding</span>, <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt;&gt; <span class="hljs-title class_">mels_T</span> =</li><li>        <span class="hljs-variable">librosa</span>::<span class="hljs-title class_">Feature</span>::<span class="hljs-title class_">melspectrogram</span>(<span class="hljs-title class_">audio</span>, <span class="hljs-title class_">sr</span>, <span class="hljs-title class_">n_fft</span>, <span class="hljs-title class_">n_hop</span>, "<span class="hljs-title class_">hann</span>", <span class="hljs-keyword">true</span>, "<span class="hljs-title class_">reflect</span>", <span class="hljs-number">2</span>.<span class="hljs-title class_">f</span>, <span class="hljs-title class_">n_mel</span>, <span class="hljs-title class_">fmin</span>, <span class="hljs-title class_">fmax</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"mels: "</span> &lt;&lt; <span class="hljs-title class_">std</span>::<span class="hljs-title class_">endl</span>;</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt;&gt; <span class="hljs-title class_">mels</span> = <span class="hljs-title function_">TransposeMel</span>(<span class="hljs-variable">mels_T</span>);</li><li>    <span class="hljs-title function_">ProcessMelSpectrogram</span>(<span class="hljs-variable">mels</span>);</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">float</span>&gt; <span class="hljs-title class_">inputMels</span>(<span class="hljs-title class_">mels</span>.<span class="hljs-title class_">size</span>() <span class="hljs-variable">* mels</span>[<span class="hljs-number">0</span>].<span class="hljs-title class_">size</span>(), <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">mels</span>.<span class="hljs-title class_">size</span>(); <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-title class_">mels</span>[<span class="hljs-title class_">i</span>].<span class="hljs-title class_">begin</span>(), <span class="hljs-title class_">mels</span>[<span class="hljs-title class_">i</span>].<span class="hljs-title class_">end</span>(), <span class="hljs-title class_">inputMels</span>.<span class="hljs-title class_">begin</span>() <span class="hljs-variable">+ i</span> <span class="hljs-variable">* mels</span>[<span class="hljs-number">0</span>].<span class="hljs-title class_">size</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">BinBuffer</span> <span class="hljs-title function_">inputMelsBin</span>(<span class="hljs-variable">inputMels</span>.<span class="hljs-title function_">data</span>(), <span class="hljs-variable">inputMels</span>.<span class="hljs-title function_">size</span>() * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>));</li><li>
</li><li>    <span class="hljs-comment">// tiny-encoder.ms模型推理</span></li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">encoderBin</span> = <span class="hljs-title function_">ReadBinFile</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-string">"tiny-encoder.ms"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">encoderBin</span>.<span class="hljs-variable">first</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">free</span>(<span class="hljs-variable">dataBuffer</span>);</li><li>        <span class="hljs-variable">dataBuffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">encoder</span> = <span class="hljs-title function_">CreateMSLiteModel</span>(<span class="hljs-variable">encoderBin</span>);</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">RunMSLiteModel</span>(<span class="hljs-variable">encoder</span>, {<span class="hljs-variable">inputMelsBin</span>});</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">OH_AI_STATUS_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">encoder</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>    <span class="hljs-title function_">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: run encoder ok!\n"</span>);</li><li>
</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">outputs</span> = <span class="hljs-title function_">OH_AI_ModelGetOutputs</span>(<span class="hljs-variable">encoder</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">n_layer_cross_k</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">outputs</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">n_layer_cross_v</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">outputs</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">1</span>]);</li><li>
</li><li>    <span class="hljs-comment">// tiny-decoder-main.ms模型推理</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">int</span>&gt; <span class="hljs-title class_">SOT_SEQUENCE</span> = {<span class="hljs-variable">WHISPER_SOT</span>,</li><li>                                     <span class="hljs-variable">WHISPER_SOT</span> + <span class="hljs-number">1</span> + <span class="hljs-number">1</span>,</li><li>                                     <span class="hljs-variable">WHISPER_TRANSCRIBE</span>, <span class="hljs-variable">WHISPER_NO_TIMESTAMPS</span>};</li><li>    <span class="hljs-variable">BinBuffer</span> <span class="hljs-title function_">sotSequence</span>(<span class="hljs-variable">SOT_SEQUENCE</span>.<span class="hljs-title function_">data</span>(), <span class="hljs-variable">SOT_SEQUENCE</span>.<span class="hljs-title function_">size</span>() * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">int</span>));</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">decoder_main_path</span> = <span class="hljs-string">"tiny-decoder-main.ms"</span>;</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">decoderMainBin</span> = <span class="hljs-title function_">ReadBinFile</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-variable">decoder_main_path</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">decoderMainBin</span>.<span class="hljs-variable">first</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">encoder</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">decoder_main</span> = <span class="hljs-title function_">CreateMSLiteModel</span>(<span class="hljs-variable">decoderMainBin</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret2</span> = <span class="hljs-title function_">RunMSLiteModel</span>(<span class="hljs-variable">decoder_main</span>, {<span class="hljs-variable">sotSequence</span>, <span class="hljs-variable">n_layer_cross_k</span>, <span class="hljs-variable">n_layer_cross_v</span>});</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret2</span> != <span class="hljs-variable">OH_AI_STATUS_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">decoder_main</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>    <span class="hljs-title function_">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: run decoder_main ok!\n"</span>);</li><li>
</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">decoderMainOut</span> = <span class="hljs-title function_">OH_AI_ModelGetOutputs</span>(<span class="hljs-variable">decoder_main</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">logitsBin</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">decoderMainOut</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">out_n_layer_self_k_cache_Bin</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">decoderMainOut</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">out_n_layer_self_v_cache_Bin</span> = <span class="hljs-title function_">GetMSOutput</span>(<span class="hljs-variable">decoderMainOut</span>.<span class="hljs-variable">handle_list</span>[<span class="hljs-number">2</span>]);</li><li>
</li><li>    <span class="hljs-comment">// tiny-decoder-loop.ms模型推理</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">modelName3</span> = <span class="hljs-string">"tiny-decoder-loop.ms"</span>;</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">modelBuffer3</span> = <span class="hljs-title function_">ReadBinFile</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-variable">modelName3</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">decoder_loop</span> = <span class="hljs-title function_">CreateMSLiteModel</span>(<span class="hljs-variable">modelBuffer3</span>);</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">dataName_embedding</span> = <span class="hljs-string">"tiny-positional_embedding.bin"</span>; <span class="hljs-comment">// 获取输入数据</span></li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">data_embedding</span> = <span class="hljs-title function_">ReadBinFile</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-variable">dataName_embedding</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">data_embedding</span>.<span class="hljs-variable">first</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">encoder</span>);</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">decoder_main</span>);</li><li>        <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">decoder_loop</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">error_ret</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">loop_times</span> = <span class="hljs-variable">WHISPER_N_TEXT_CTX</span> - <span class="hljs-variable">SOT_SEQUENCE</span>.<span class="hljs-title function_">size</span>();</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">offset_init</span> = <span class="hljs-variable">SOT_SEQUENCE</span>.<span class="hljs-title function_">size</span>();</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">output_tokens</span> =</li><li>        <span class="hljs-title function_">LoopPredict</span>(<span class="hljs-variable">decoder_loop</span>, <span class="hljs-variable">n_layer_cross_k</span>, <span class="hljs-variable">n_layer_cross_v</span>, <span class="hljs-variable">logitsBin</span>, <span class="hljs-variable">out_n_layer_self_k_cache_Bin</span>,</li><li>                    <span class="hljs-variable">out_n_layer_self_v_cache_Bin</span>, <span class="hljs-variable">data_embedding</span>, <span class="hljs-variable">loop_times</span>, <span class="hljs-variable">offset_init</span>);</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">string</span>&gt; <span class="hljs-title class_">token_tables</span> = <span class="hljs-title function_">ProcessDataLines</span>(<span class="hljs-title function_">ReadTokens</span>(<span class="hljs-variable">resourcesManager</span>, <span class="hljs-string">"tiny-tokens.txt"</span>));</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">result</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">auto</span> <span class="hljs-variable">i</span> : <span class="hljs-title class_">output_tokens</span>) {</li><li>        <span class="hljs-variable">char</span> <span class="hljs-variable">str</span>[<span class="hljs-number">1024</span>];</li><li>        <span class="hljs-title function_">base64_decode</span>((<span class="hljs-keyword">const</span> <span class="hljs-variable">uint8</span> *)<span class="hljs-variable">token_tables</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">c_str</span>(), (<span class="hljs-variable">uint32</span>)<span class="hljs-variable">token_tables</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">size</span>(), <span class="hljs-variable">str</span>);</li><li>        <span class="hljs-variable">result</span> += <span class="hljs-variable">str</span>;</li><li>    }</li><li>    <span class="hljs-title function_">LOGI</span>(<span class="hljs-string">"MS_LITE_LOG: result is -&gt; %{public}s"</span>, <span class="hljs-variable">result</span>.<span class="hljs-title function_">c_str</span>());</li><li>
</li><li>    <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">encoder</span>);</li><li>    <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">decoder_main</span>);</li><li>    <span class="hljs-title function_">OH_AI_ModelDestroy</span>(&amp;<span class="hljs-title class_">decoder_loop</span>);</li><li>
</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">out_data</span>;</li><li>    <span class="hljs-title function_">napi_create_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">result</span>.<span class="hljs-title function_">c_str</span>(), <span class="hljs-variable">result</span>.<span class="hljs-title function_">length</span>(), &amp;<span class="hljs-title class_">out_data</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">out_data</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写CMake脚本，链接MindSpore Lite动态库。</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)</li><li><span class="hljs-built_in">project</span>(test)</li><li># AudioFile<span class="hljs-selector-class">.h</span></li><li><span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)</li><li><span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED TRUE)</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_PATH}</li><li>                    ${NATIVERENDER_PATH}/include)</li><li>
</li><li># libsamplerate</li><li><span class="hljs-built_in">set</span>(LIBSAMPLERATE_DIR ${NATIVERENDER_PATH}/third_party/libsamplerate)</li><li><span class="hljs-built_in">include_directories</span>(${LIBSAMPLERATE_DIR}/include)</li><li><span class="hljs-built_in">add_subdirectory</span>(${LIBSAMPLERATE_DIR})</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_PATH}/third_party/opencc/include/opencc)</li><li># <span class="hljs-attribute">src</span></li><li><span class="hljs-built_in">aux_source_directory</span>(src SRC_DIR)</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_PATH}/src)</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${CMAKE_SOURCE_DIR}/third_party)</li><li>
</li><li><span class="hljs-built_in">file</span>(GLOB SRC src/*.cc)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED mslite_napi.cpp ${SRC})</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC samplerate)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC mindspore_lite_ndk)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC hilog_ndk.z)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC rawfile.z)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC ace_napi.z)</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="使用n-api将c动态库封装成arkts模块">使用N-API将C++动态库封装成ArkTS模块<i class="anchor-icon anchor-icon-link" anchorid="使用n-api将c动态库封装成arkts模块" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在 entry/src/main/cpp/types/libentry/Index.d.ts，定义ArkTS接口runDemo() 。内容如下：</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">runDemo</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">Object</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div></li>      <li>       <p>在 oh-package.json5 文件，将API与so相关联，成为一个完整的ArkTS模块：</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"libentry.so"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./Index.d.ts"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MindSpore Lite inference module."</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="调用封装的arkts模块进行推理并输出结果">调用封装的ArkTS模块进行推理并输出结果<i class="anchor-icon anchor-icon-link" anchorid="调用封装的arkts模块进行推理并输出结果" tips="复制节点链接"></i></h3>          <p>在 entry/src/main/ets/pages/Index.ets 中，调用封装的ArkTS模块，最后对推理结果进行处理。</p>     <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> msliteNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">AVPlayerDemo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./player'</span>;</li><li><span class="hljs-keyword">import</span> { transverter, <span class="hljs-title class_">TransverterType</span>, <span class="hljs-title class_">TransverterLanguage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@nutpi/chinese_transverter"</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'MindSporeLite'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'MSLite Whisper Demo'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">wavName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'zh.wav'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>);</li><li>        <span class="hljs-title class_">Button</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'播放示例音频'</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>        })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt;{</li><li>          <span class="hljs-comment">// 通过实例调用类中的函数</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: begin to play wav.`</span>);</li><li>          <span class="hljs-keyword">let</span> myClass = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayerDemo</span>();</li><li>          myClass.<span class="hljs-title function_">avPlayerFdSrcDemo</span>();</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'识别示例音频'</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">20</span></li><li>        })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> resMgr = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">resourceManager</span>;</li><li>          <span class="hljs-keyword">if</span> (resMgr === <span class="hljs-literal">undefined</span> || resMgr === <span class="hljs-literal">null</span>) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_ERR: get resourceManager failed.`</span>);</li><li>            <span class="hljs-keyword">return</span></li><li>          }</li><li>          <span class="hljs-comment">// 调用封装的runDemo函数</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: *** Start MSLite Demo ***`</span>);</li><li>          <span class="hljs-keyword">let</span> output = msliteNapi.<span class="hljs-title function_">runDemo</span>(resMgr);</li><li>          <span class="hljs-keyword">if</span> (output === <span class="hljs-literal">null</span> || output.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_ERR: runDemo failed.`</span>);</li><li>            <span class="hljs-keyword">return</span></li><li>          }</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>            <span class="hljs-string">`MS_LITE_LOG: output length = <span class="hljs-subst">${output.length}</span>; value = <span class="hljs-subst">${output.slice(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>)}</span>`</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = output;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`MS_LITE_LOG: *** Finished MSLite Demo ***`</span>);</li><li>        })</li><li>
</li><li>        <span class="hljs-comment">// 显示识别内容</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>) {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'识别内容: \n'</span> + <span class="hljs-title function_">transverter</span>({</li><li>            <span class="hljs-attr">type</span>: <span class="hljs-title class_">TransverterType</span>.<span class="hljs-property">SIMPLIFIED</span>,</li><li>            <span class="hljs-attr">str</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>,</li><li>            <span class="hljs-attr">language</span>: <span class="hljs-title class_">TransverterLanguage</span>.<span class="hljs-property">ZH_CN</span></li><li>          }) + <span class="hljs-string">'\n'</span>).<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'20%'</span>)</li><li>        }</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在DevEco Studio中连接设备，点击Run entry，编译Hap，有如下显示：</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>Launching com.samples.mindsporelitecdemoasr</li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell aa force-stop com.samples.mindsporelitecdemoasr</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell <span class="hljs-built_in">mkdir</span> data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc file send E:\xxx\entry\build\default\outputs\default\entry-default-signed.hap <span class="hljs-string">"data/local/tmp/xxx"</span></span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell bm install -p data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell <span class="hljs-built_in">rm</span> -rf data/local/tmp/xxx</span></li><li><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdc shell aa start -a EntryAbility -b com.samples.mindsporelitecdemoasr</span></li><li>com.samples.mindsporelitecdemoasr successfully launched...</li></ol></pre></div></div></li>      <li>       <p>在设备屏幕点击播放示例音频按钮，会播放本示例音频文件。点击识别示例音频按钮，设备屏幕显示本示例音频文件的中文内容。在日志打印结果中，过滤关键字”MS_LITE_LOG“，可得到如下结果：</p>       <div _ngcontent-vqp-c106="" class="highlight-div"><div _ngcontent-vqp-c106="" class="highlight-div-header"><div _ngcontent-vqp-c106="" class="highlight-div-header-left"><div _ngcontent-vqp-c106="" class="handle-button expand-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqp-c106="" class="highlight-div-header-right"><div _ngcontent-vqp-c106="" class="handle-button ai-button"></div><div _ngcontent-vqp-c106="" class="handle-button line-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqp-c106="" class="handle-button theme-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqp-c106="" class="handle-button copy-button"><div _ngcontent-vqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqp-c106="" class="highlight-scroll-div"><pre class="verilog prettyprint linenums hljs language-cangjie" hw-language="verilog" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.200</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">begin</span> <span class="hljs-title class_">to</span> <span class="hljs-title class_">play</span> <span class="hljs-title class_">wav</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.210</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     [<span class="hljs-variable">a92ab1e0f831191</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">initialized</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.228</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     [<span class="hljs-variable">a92ab1e0f831191</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">prepared</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.242</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">playing</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.242</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">start</span> <span class="hljs-title class_">to</span> <span class="hljs-title class_">seek</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">44.372</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">seek</span> <span class="hljs-title class_">succeeded</span>, <span class="hljs-variable">seek</span> <span class="hljs-variable">time</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49.621</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">completed</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49.646</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">stopped</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49.647</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">idle</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49.649</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">AVPlayer</span> <span class="hljs-title class_">state</span> <span class="hljs-title class_">released</span> <span class="hljs-title class_">called</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53.282</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: *** <span class="hljs-title class_">Start</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">Demo</span> ***</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53.926</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Build</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">success</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Run</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">Predict</span> <span class="hljs-title class_">success</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Get</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">outputs</span>:</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-number">0</span> <span class="hljs-title class_">name</span> <span class="hljs-keyword">is</span>: <span class="hljs-title class_">n_layer_cross_k</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-number">0</span> <span class="hljs-title class_">size</span> <span class="hljs-keyword">is</span>: <span class="hljs-number">9216000</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-title class_">data</span> <span class="hljs-keyword">is</span>:</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: -<span class="hljs-number">1.14678</span> -<span class="hljs-number">2.30223</span> <span class="hljs-number">0.868679</span> <span class="hljs-number">0.284441</span> <span class="hljs-number">1.03233</span> -<span class="hljs-number">2.02062</span> <span class="hljs-number">0.688163</span> -<span class="hljs-number">0.732034</span> -<span class="hljs-number">1.10553</span> <span class="hljs-number">1.43459</span> <span class="hljs-number">0.083885</span> -<span class="hljs-number">0.116173</span> -<span class="hljs-number">0.772636</span> <span class="hljs-number">1.5466</span> -<span class="hljs-number">0.631993</span> -<span class="hljs-number">0.897929</span> -<span class="hljs-number">0.0501685</span> -<span class="hljs-number">1.62517</span> <span class="hljs-number">0.375988</span> -<span class="hljs-number">1.77772</span> -<span class="hljs-number">0.432178</span></li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-number">1</span> <span class="hljs-title class_">name</span> <span class="hljs-keyword">is</span>: <span class="hljs-title class_">n_layer_cross_v</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-number">1</span> <span class="hljs-title class_">size</span> <span class="hljs-keyword">is</span>: <span class="hljs-number">9216000</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: - <span class="hljs-title class_">Tensor</span> <span class="hljs-title class_">data</span> <span class="hljs-keyword">is</span>:</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.260</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-number">0.0876085</span> -<span class="hljs-number">0.560317</span> -<span class="hljs-number">0.652518</span> -<span class="hljs-number">0.116969</span> -<span class="hljs-number">0.182608</span> -<span class="hljs-number">9.40531e-05</span> <span class="hljs-number">0.186293</span> <span class="hljs-number">0.123206</span> <span class="hljs-number">0.0127445</span> <span class="hljs-number">0.0708352</span> -<span class="hljs-number">0.489624</span> -<span class="hljs-number">0.226322</span> -<span class="hljs-number">0.0686949</span> -<span class="hljs-number">0.0341293</span> -<span class="hljs-number">0.0719619</span> <span class="hljs-number">0.103588</span> <span class="hljs-number">0.398025</span> -<span class="hljs-number">0.444261</span> <span class="hljs-number">0.396124</span> -<span class="hljs-number">0.347295</span> <span class="hljs-number">0.00541205</span></li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.430</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Build</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">success</span>.</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">54.462</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">D</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">Run</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">model</span> <span class="hljs-title class_">Predict</span> <span class="hljs-title class_">success</span>.</li><li>......</li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">55.272</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A00000</span>/[<span class="hljs-variable">MSLiteNapi</span>]             <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: <span class="hljs-title class_">run</span> <span class="hljs-title class_">decoder</span> <span class="hljs-title class_">loop</span> <span class="hljs-number">16</span> <span class="hljs-title class_">ok</span>!</li><li>                                                                                                <span class="hljs-variable">token</span> = <span class="hljs-number">50257</span></li><li><span class="hljs-number">05</span>-<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">53</span>:<span class="hljs-number">55.334</span>   <span class="hljs-number">1679</span>-<span class="hljs-number">1679</span>     <span class="hljs-title class_">A03d00</span>/<span class="hljs-variable">JSAPP</span>                    <span class="hljs-variable">com</span>.<span class="hljs-variable">sampl</span>...<span class="hljs-variable">cdemoasr</span>  <span class="hljs-variable">I</span>     <span class="hljs-variable">MS_LITE_LOG</span>: *** <span class="hljs-title class_">Finished</span> <span class="hljs-title class_">MSLite</span> <span class="hljs-title class_">Demo</span> ***</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="效果示意">效果示意<i class="anchor-icon anchor-icon-link" anchorid="效果示意" tips="复制节点链接"></i></h3>          <p>在设备上，点击<strong>播放示例音频</strong>按钮，会播放本示例音频文件。点击<strong>识别示例音频</strong>按钮，设备屏幕显示本示例音频文件的中文内容。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.3.1.1" valign="top" width="50%">初始页面</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.3.1.2" valign="top" width="50%">点击识别示例音频按钮后</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%"><span><img originheight="550" originwidth="266" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114227.11773071512306290617904384719756:50001231000000:2800:A12B907E6A4FCF3AF34CF149AC45B2726B713D0AF0B6FEDAACB954DC9C0562AD.png" class="notEnlarge" width="266" height="550"></span></td>         <td class="cellrowborder" valign="top" width="50%"><span><img originheight="541" originwidth="276" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114227.99544852552902580179231740921790:50001231000000:2800:B7FF7D0ECAEE689B71BC33B03CA7AD0F16A96F398E84BEFDE41BD2078756E87B.png" class="notEnlarge" width="276" height="541"></span></td>        </tr>             </tbody></table></div>     </div>    </div>   </div>   <div></div></div>