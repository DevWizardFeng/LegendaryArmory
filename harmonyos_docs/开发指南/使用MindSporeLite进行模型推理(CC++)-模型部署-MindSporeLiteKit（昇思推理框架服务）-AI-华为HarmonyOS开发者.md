<h1 _ngcontent-aiu-c119="" class="doc-title ng-star-inserted" title="使用MindSpore Lite进行模型推理 (C/C++)"> 使用MindSpore Lite进行模型推理 (C/C++) </h1>

<div _ngcontent-aiu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>MindSpore Lite是一款AI引擎，它提供了面向不同硬件设备AI模型推理的功能，目前已经在图像分类、目标识别、人脸识别、文字识别等应用中广泛使用。</p>     <p>本文介绍使用MindSpore Lite推理引擎进行模型推理的通用开发流程。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p>在进行开发前，请先了解以下概念。</p>     <p><strong>张量</strong>：它与数组和矩阵非常相似，是MindSpore Lite网络运算中的基本数据结构。</p>     <p><strong>Float16推理模式</strong>： Float16又称半精度，它使用16比特表示一个数。Float16推理模式表示推理的时候用半精度进行推理。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>这里给出MindSpore Lite推理的通用开发流程中涉及的一些接口，具体请见下列表格。更多接口及详细内容，请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>。</p>    </div>    <div class="tiledSection">     <h3 id="context-相关接口" class="firsth2">Context 相关接口<i class="anchor-icon anchor-icon-link" anchorid="context-相关接口" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_ContextHandle OH_AI_ContextCreate()</td>         <td class="cellrowborder" valign="top" width="50%">创建一个上下文的对象。注意：此接口需跟OH_AI_ContextDestroy配套使用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextSetThreadNum(OH_AI_ContextHandle context, int32_t thread_num)</td>         <td class="cellrowborder" valign="top" width="50%">设置运行时的线程数量。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextSetThreadAffinityMode(OH_AI_ContextHandle context, int mode)</td>         <td class="cellrowborder" valign="top" width="50%">设置运行时线程绑定CPU核心的策略，按照CPU物理核频率分为大、中、小三种类型的核心，并且仅需绑大核或者绑中核，不需要绑小核。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_DeviceInfoHandle OH_AI_DeviceInfoCreate(OH_AI_DeviceType device_type)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个运行时设备信息对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextDestroy(OH_AI_ContextHandle *context)</td>         <td class="cellrowborder" valign="top" width="50%">释放上下文对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_DeviceInfoSetEnableFP16(OH_AI_DeviceInfoHandle device_info, bool is_fp16)</td>         <td class="cellrowborder" valign="top" width="50%">设置是否开启Float16推理模式，仅CPU/GPU设备可用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextAddDeviceInfo(OH_AI_ContextHandle context, OH_AI_DeviceInfoHandle device_info)</td>         <td class="cellrowborder" valign="top" width="50%">添加运行时设备信息。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="model-相关接口">Model 相关接口<i class="anchor-icon anchor-icon-link" anchorid="model-相关接口" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_ModelHandle OH_AI_ModelCreate()</td>         <td class="cellrowborder" valign="top" width="50%">创建一个模型对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_Status OH_AI_ModelBuildFromFile(OH_AI_ModelHandle model, const char *model_path,OH_AI_ModelType model_type, const OH_AI_ContextHandle model_context)</td>         <td class="cellrowborder" valign="top" width="50%">通过模型文件加载并编译MindSpore Lite模型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ModelDestroy(OH_AI_ModelHandle *model)</td>         <td class="cellrowborder" valign="top" width="50%">释放一个模型对象。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="tensor-相关接口">Tensor 相关接口<i class="anchor-icon anchor-icon-link" anchorid="tensor-相关接口" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_TensorHandleArray OH_AI_ModelGetInputs(const OH_AI_ModelHandle model)</td>         <td class="cellrowborder" valign="top" width="50%">获取模型的输入张量数组结构体。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int64_t OH_AI_TensorGetElementNum(const OH_AI_TensorHandle tensor)</td>         <td class="cellrowborder" valign="top" width="50%">获取张量元素数量。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">const char *OH_AI_TensorGetName(const OH_AI_TensorHandle tensor)</td>         <td class="cellrowborder" valign="top" width="50%">获取张量的名称。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_DataType OH_AI_TensorGetDataType(const OH_AI_TensorHandle tensor)</td>         <td class="cellrowborder" valign="top" width="50%">获取张量数据类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void *OH_AI_TensorGetMutableData(const OH_AI_TensorHandle tensor)</td>         <td class="cellrowborder" valign="top" width="50%">获取可变的张量数据指针。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>使用MindSpore Lite进行模型推理的开发流程如下图所示。</p>     <p><strong>图 1</strong> 使用MindSpore Lite进行模型推理的开发流程</p>     <p><span><img originheight="331" originwidth="791" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114230.60695690003952616934887262576063:50001231000000:2800:F3139D31BB04F232DE6FFFC137E138F93C26590B35A634E17D7494B9CDB23390.png" width="791" height="331"></span></p>     <p>进入主要流程之前需要先引用相关的头文件，并编写函数生成随机的输入，具体如下：</p>     <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mindspore/model.h"</span></span></li><li>
</li><li><span class="hljs-comment">//生成随机的输入</span></li><li><span class="hljs-type">int</span> <span class="hljs-title function_">GenerateInputDataWithRandom</span><span class="hljs-params">(OH_AI_TensorHandleArray inputs)</span> {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inputs.handle_num; ++i) {</li><li>    <span class="hljs-type">float</span> *input_data = (<span class="hljs-type">float</span> *)OH_AI_TensorGetMutableData(inputs.handle_list[i]);</li><li>    <span class="hljs-keyword">if</span> (input_data == <span class="hljs-literal">NULL</span>) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"MSTensorGetMutableData failed.\n"</span>);</li><li>      <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> num = OH_AI_TensorGetElementNum(inputs.handle_list[i]);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> divisor = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; num; j++) {</li><li>      input_data[j] = (<span class="hljs-type">float</span>)(rand() % divisor) / divisor;  <span class="hljs-comment">// 0--0.9f</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li></ol></pre></div></div>     <p>然后进入主要的开发步骤，具体包括模型的准备、读取、编译、推理和释放，具体开发过程及细节请见下文的开发步骤及示例。</p>     <ol>      <li>       <p>模型准备。</p>       <p>需要的模型可以直接下载，也可以通过模型转换工具获得。</p>       <ul>        <li>下载模型的格式若为.ms，则可以直接使用。本文以mobilenetv2.ms为例。</li>        <li>如果是第三方框架的模型，比如 TensorFlow、TensorFlow Lite、Caffe、ONNX等，可以使用<a href="https://www.mindspore.cn/lite/docs/zh-CN/master/use/downloads.html#2-3-0" target="_blank">模型转换工具</a>转换为.ms格式的模型文件。</li>       </ul></li>      <li>       <p>创建上下文，设置线程数、设备类型等参数。</p>       <p>以下介绍两种典型情形。</p>       <p>情形1：仅创建CPU推理上下文。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建并配置上下文，设置运行时的线程数量为2，绑核策略为大核优先</span></li><li>OH_AI_ContextHandle context = OH_AI_ContextCreate();</li><li><span class="hljs-keyword">if</span> (context == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ContextCreate failed.\n"</span>);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li><span class="hljs-type">const</span> <span class="hljs-type">int</span> thread_num = <span class="hljs-number">2</span>;</li><li>OH_AI_ContextSetThreadNum(context, thread_num);</li><li>OH_AI_ContextSetThreadAffinityMode(context, <span class="hljs-number">1</span>);</li><li><span class="hljs-comment">//设置运行设备为CPU，不使用Float16推理</span></li><li>OH_AI_DeviceInfoHandle cpu_device_info = OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);</li><li><span class="hljs-keyword">if</span> (cpu_device_info == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>OH_AI_DeviceInfoSetEnableFP16(cpu_device_info, <span class="hljs-literal">false</span>);</li><li>OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</li></ol></pre></div></div>       <p>情形2：创建NNRT（Neural Network Runtime）和CPU异构推理上下文。</p>       <p>NNRT是面向AI领域的跨芯片推理计算运行时，一般来说，NNRT对接的加速硬件如NPU，推理能力较强，但支持的算子规格少；而通用CPU推理能力较弱，但支持算子规格更全面。MindSpore Lite支持配置NNRT硬件和CPU异构推理：优先将模型算子调度到NNRT推理，若某些算子NNRT不支持，将其调度到CPU进行推理。通过下面的操作即可配置NNRT/CPU异构推理。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建并配置上下文，设置运行时的线程数量为2，绑核策略为大核优先</span></li><li>OH_AI_ContextHandle context = OH_AI_ContextCreate();</li><li><span class="hljs-keyword">if</span> (context == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ContextCreate failed.\n"</span>);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li><span class="hljs-comment">// 优先使用NNRT推理。</span></li><li><span class="hljs-comment">// 这里利用查找到的第一个ACCELERATORS类别的NNRT硬件，来创建nnrt设备信息，并设置硬件使用高性能模式推理。还可以通过如：OH_AI_GetAllNNRTDeviceDescs()接口获取当前环境中所有NNRT硬件的描述信息，按设备名、类型等信息查找，找到某一具体设备作为NNRT推理硬件。</span></li><li>OH_AI_DeviceInfoHandle nnrt_device_info = OH_AI_CreateNNRTDeviceInfoByType(OH_AI_NNRTDEVICE_ACCELERATOR);</li><li><span class="hljs-keyword">if</span> (nnrt_device_info == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>OH_AI_DeviceInfoSetPerformanceMode(nnrt_device_info, OH_AI_PERFORMANCE_HIGH);</li><li>OH_AI_ContextAddDeviceInfo(context, nnrt_device_info);</li><li>
</li><li><span class="hljs-comment">// 其次设置CPU推理。</span></li><li>OH_AI_DeviceInfoHandle cpu_device_info = OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);</li><li><span class="hljs-keyword">if</span> (cpu_device_info == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</li></ol></pre></div></div></li>      <li>       <p>创建、加载与编译模型。</p>       <p>调用OH_AI_ModelBuildFromFile加载并编译模型。</p>       <p>本例中传入OH_AI_ModelBuildFromFile的argv[1]参数是从控制台中输入的模型文件路径。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建模型</span></li><li>OH_AI_ModelHandle model = OH_AI_ModelCreate();</li><li><span class="hljs-keyword">if</span> (model == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelCreate failed.\n"</span>);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 加载与编译模型，模型的类型为OH_AI_MODELTYPE_MINDIR</span></li><li><span class="hljs-keyword">if</span> (access(argv[<span class="hljs-number">1</span>], F_OK) != <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"model file not exists.\n"</span>);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li><span class="hljs-type">int</span> ret = OH_AI_ModelBuildFromFile(model, argv[<span class="hljs-number">1</span>], OH_AI_MODELTYPE_MINDIR, context);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelBuildFromFile failed, ret: %d.\n"</span>, ret);</li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>输入数据。</p>       <p>模型执行之前需要向输入的张量中填充数据。本例使用随机的数据对模型进行填充。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获得输入张量</span></li><li>OH_AI_TensorHandleArray inputs = OH_AI_ModelGetInputs(model);</li><li><span class="hljs-keyword">if</span> (inputs.handle_list == <span class="hljs-literal">NULL</span>) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelGetInputs failed, ret: %d.\n"</span>, ret);</li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-comment">// 使用随机数据填充张量</span></li><li>ret = GenerateInputDataWithRandom(inputs);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"GenerateInputDataWithRandom failed, ret: %d.\n"</span>, ret);</li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>执行推理。</p>       <p>使用OH_AI_ModelPredict接口进行模型推理。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 执行模型推理</span></li><li>OH_AI_TensorHandleArray outputs;</li><li>ret = OH_AI_ModelPredict(model, inputs, &amp;outputs, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelPredict failed, ret: %d.\n"</span>, ret);</li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取输出。</p>       <p>模型推理结束之后，可以通过输出张量得到推理结果。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取模型的输出张量，并打印</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outputs.handle_num; ++i) {</li><li>  OH_AI_TensorHandle tensor = outputs.handle_list[i];</li><li>  <span class="hljs-type">long</span> <span class="hljs-type">long</span> element_num = OH_AI_TensorGetElementNum(tensor);</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Tensor name: %s, tensor size is %zu ,elements num: %lld.\n"</span>, OH_AI_TensorGetName(tensor),</li><li>        OH_AI_TensorGetDataSize(tensor), element_num);</li><li>  <span class="hljs-type">const</span> <span class="hljs-type">float</span> *data = (<span class="hljs-type">const</span> <span class="hljs-type">float</span> *)OH_AI_TensorGetData(tensor);</li><li>  <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TensorGetData failed.\n"</span>);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"output data is:\n"</span>);</li><li>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> max_print_num = <span class="hljs-number">50</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; element_num &amp;&amp; j &lt;= max_print_num; ++j) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%f "</span>, data[j]);</li><li>  }</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>释放模型。</p>       <p>不再使用MindSpore Lite推理框架时，需要释放已经创建的模型。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放模型和上下文</span></li><li>OH_AI_ModelDestroy(&amp;model);</li><li>OH_AI_ContextDestroy(&amp;context);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>编写CMakeLists.txt。</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.14</span>)</li><li><span class="hljs-built_in">project</span>(Demo)</li><li>
</li><li><span class="hljs-built_in">add_executable</span>(demo main.c)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(</li><li>        demo</li><li>        mindspore_lite_ndk</li><li>        pthread</li><li>        dl</li><li>)</li></ol></pre></div></div>       <ul>        <li>         <p>使用ohos-sdk交叉编译，需要指定CMake的工具链路径，即：-DCMAKE_TOOLCHAIN_FILE="/{sdkPath}/native/build/cmake/ohos.toolchain.cmake"。</p>         <p>其中，sdkPath为DevEco Studio安装目录下的SDK路径，可在DevEco Studio工程界面，点击<strong>File</strong> &gt; <strong>Settings...</strong> &gt; <strong>HarmonyOS SDK</strong>，查看<strong>Location</strong>获取。</p></li>        <li>         <p>工具链默认编译64位的程序，如果要编译32位，需要添加：-DOHOS_ARCH="armeabi-v7a"。</p></li>       </ul></li>      <li>       <p>运行。</p>       <ul>        <li>使用hdc_std连接设备，并将demo和mobilenetv2.ms推送到设备中的相同目录。</li>        <li>使用hdc_std shell进入设备，并进入demo所在的目录执行如下命令，即可得到结果。</li>       </ul>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>./demo mobilenetv2.ms</li></ol></pre></div></div>       <p>得到如下输出:</p>       <div _ngcontent-aiu-c106="" class="highlight-div"><div _ngcontent-aiu-c106="" class="highlight-div-header"><div _ngcontent-aiu-c106="" class="highlight-div-header-left"><div _ngcontent-aiu-c106="" class="handle-button expand-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aiu-c106="" class="highlight-div-header-right"><div _ngcontent-aiu-c106="" class="handle-button ai-button"></div><div _ngcontent-aiu-c106="" class="handle-button line-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aiu-c106="" class="handle-button theme-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aiu-c106="" class="handle-button copy-button"><div _ngcontent-aiu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aiu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_"># </span><span class="language-bash">./demo ./mobilenetv2.ms</span></li><li>Tensor name: Softmax-65, tensor size is 4004 ,elements num: 1001.</li><li>output data is:</li><li>0.000018 0.000012 0.000026 0.000194 0.000156 0.001501 0.000240 0.000825 0.000016 0.000006 0.000007 0.000004 0.000004 0.000004 0.000015 0.000099 0.000011 0.000013 0.000005 0.000023 0.000004 0.000008 0.000003 0.000003 0.000008 0.000014 0.000012 0.000006 0.000019 0.000006 0.000018 0.000024 0.000010 0.000002 0.000028 0.000372 0.000010 0.000017 0.000008 0.000004 0.000007 0.000010 0.000007 0.000012 0.000005 0.000015 0.000007 0.000040 0.000004 0.000085 0.000023</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>