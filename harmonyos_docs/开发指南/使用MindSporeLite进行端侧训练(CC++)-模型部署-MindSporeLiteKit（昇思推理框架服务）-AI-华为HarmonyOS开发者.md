<h1 _ngcontent-nmp-c119="" class="doc-title ng-star-inserted" title="使用MindSpore Lite进行端侧训练 (C/C++)"> 使用MindSpore Lite进行端侧训练 (C/C++) </h1>

<div _ngcontent-nmp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>MindSpore Lite是一款AI引擎，它提供了面向不同硬件设备AI模型推理的功能，目前已经在图像分类、目标识别、人脸识别、文字识别等应用中广泛使用，同时支持在端侧设备上进行部署训练，让模型在实际业务场景中自适应用户的行为。</p>     <p>本文介绍使用MindSpore Lite端侧AI引擎进行模型训练的通用开发流程。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>此处给出使用MindSpore Lite进行模型训练相关的部分接口，具体请见下方表格。更多接口及详细内容，请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-mindspore" target="_blank">MindSpore</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_ContextHandle OH_AI_ContextCreate()</td>         <td class="cellrowborder" valign="top" width="50%">创建一个上下文的对象。注意：此接口需跟OH_AI_ContextDestroy配套使用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_DeviceInfoHandle OH_AI_DeviceInfoCreate(OH_AI_DeviceType device_type)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个运行时设备信息对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextDestroy(OH_AI_ContextHandle *context)</td>         <td class="cellrowborder" valign="top" width="50%">释放上下文对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ContextAddDeviceInfo(OH_AI_ContextHandle context, OH_AI_DeviceInfoHandle device_info)</td>         <td class="cellrowborder" valign="top" width="50%">添加运行时设备信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_TrainCfgHandle OH_AI_TrainCfgCreate()</td>         <td class="cellrowborder" valign="top" width="50%">创建训练配置对象指针。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_TrainCfgDestroy(OH_AI_TrainCfgHandle *train_cfg)</td>         <td class="cellrowborder" valign="top" width="50%">销毁训练配置对象指针。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_ModelHandle OH_AI_ModelCreate()</td>         <td class="cellrowborder" valign="top" width="50%">创建一个模型对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_Status OH_AI_TrainModelBuildFromFile(OH_AI_ModelHandle model, const char *model_path, OH_AI_ModelType model_type, const OH_AI_ContextHandle model_context, const OH_AI_TrainCfgHandle train_cfg)</td>         <td class="cellrowborder" valign="top" width="50%">通过模型文件加载并编译MindSpore Lite训练模型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_Status OH_AI_RunStep(OH_AI_ModelHandle model, const OH_AI_KernelCallBack before, const OH_AI_KernelCallBack after)</td>         <td class="cellrowborder" valign="top" width="50%">单步训练模型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_Status OH_AI_ModelSetTrainMode(OH_AI_ModelHandle model, bool train)</td>         <td class="cellrowborder" valign="top" width="50%">设置训练模式。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AI_Status OH_AI_ExportModel(OH_AI_ModelHandle model, OH_AI_ModelType model_type, const char *model_file, OH_AI_QuantizationType quantization_type, bool export_inference_only, char **output_tensor_name, size_t num)</td>         <td class="cellrowborder" valign="top" width="50%">导出训练后的ms模型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_AI_ModelDestroy(OH_AI_ModelHandle *model)</td>         <td class="cellrowborder" valign="top" width="50%">释放一个模型对象。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>使用MindSpore Lite进行模型训练的开发流程如下图所示。</p>     <p><strong>图 1</strong> 使用MindSpore Lite进行模型训练的开发流程</p>     <p><span><img originheight="316" originwidth="620" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114239.59072204780076179935371106898847:50001231000000:2800:09AC57D5C4009201578EEE534E3094A58BED257DA6A2CAE6DDA50187FD1AA2EB.png" width="620" height="316"></span></p>     <p>进入主要流程之前需要先引用相关的头文件，并编写函数生成随机的输入，具体如下：</p>     <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mindspore/model.h"</span></span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">GenerateInputDataWithRandom</span><span class="hljs-params">(OH_AI_TensorHandleArray inputs)</span> {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inputs.handle_num; ++i) {</li><li>    <span class="hljs-type">float</span> *input_data = (<span class="hljs-type">float</span> *)OH_AI_TensorGetMutableData(inputs.handle_list[i]);</li><li>    <span class="hljs-keyword">if</span> (input_data == <span class="hljs-literal">NULL</span>) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TensorGetMutableData failed.\n"</span>);</li><li>      <span class="hljs-keyword">return</span>  OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> num = OH_AI_TensorGetElementNum(inputs.handle_list[i]);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> divisor = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; num; j++) {</li><li>      input_data[j] = (<span class="hljs-type">float</span>)(rand() % divisor) / divisor;  <span class="hljs-comment">// 0--0.9f</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li></ol></pre></div></div>     <p>然后进入主要的开发步骤，包括模型的准备、读取、编译、训练、模型导出和释放，具体开发过程及细节请见下文的开发步骤及示例。</p>     <ol>      <li>       <p>模型准备。</p>       <p>准备的模型格式为.ms，本文以lenet_train.ms为例（此模型是提前准备的ms模型，本文相关效果仅以此模型文件为例）。开发者请自行准备所需的模型，可以按如下步骤操作：</p>       <ul>        <li>首先基于MindSpore架构使用Python创建网络模型，并导出为.mindir文件，详细指南参考<a href="https://www.mindspore.cn/tutorials/zh-CN/r2.1/beginner/quick_start.html" target="_blank">这里</a>。</li>        <li>然后将.mindir模型文件转换成.ms文件，转换操作步骤可以参考<a href="https://www.mindspore.cn/lite/docs/zh-CN/r2.1/use/converter_train.html" target="_blank">训练模型转换</a>，.ms文件可以导入端侧设备并基于MindSpore Lite端侧框架进行训练。</li>       </ul></li>      <li>       <p>创建上下文，设置设备类型、训练配置等参数。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create and init context, add CPU device info</span></li><li>OH_AI_ContextHandle context = OH_AI_ContextCreate();</li><li><span class="hljs-keyword">if</span> (context == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ContextCreate failed.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>
</li><li>OH_AI_DeviceInfoHandle cpu_device_info = OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);</li><li><span class="hljs-keyword">if</span> (cpu_device_info == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</li><li>
</li><li><span class="hljs-comment">// Create trainCfg</span></li><li>OH_AI_TrainCfgHandle trainCfg = OH_AI_TrainCfgCreate();</li><li><span class="hljs-keyword">if</span> (trainCfg == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TrainCfgCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建、加载与编译模型。</p>       <p>调用OH_AI_TrainModelBuildFromFile加载并编译模型。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create model</span></li><li>OH_AI_ModelHandle model = OH_AI_ModelCreate();</li><li><span class="hljs-keyword">if</span> (model == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelCreate failed.\n"</span>);</li><li>    OH_AI_TrainCfgDestroy(&amp;trainCfg);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Build model</span></li><li><span class="hljs-type">int</span> ret = OH_AI_TrainModelBuildFromFile(model, model_file, OH_AI_MODELTYPE_MINDIR, context, trainCfg);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TrainModelBuildFromFile failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>输入数据。</p>       <p>模型执行之前需要向输入的张量中填充数据。本例使用随机的数据对模型进行填充。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Get Inputs</span></li><li>OH_AI_TensorHandleArray inputs = OH_AI_ModelGetInputs(model);</li><li><span class="hljs-keyword">if</span> (inputs.handle_list == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelGetInputs failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Generate random data as input data.</span></li><li>ret = GenerateInputDataWithRandom(inputs);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"GenerateInputDataWithRandom failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>执行训练。</p>       <p>使用OH_AI_ModelSetTrainMode接口设置训练模式，使用OH_AI_RunStep接口进行模型训练。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set Train Mode</span></li><li>ret = OH_AI_ModelSetTrainMode(model, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelSetTrainMode failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Model Train Step</span></li><li>ret = OH_AI_RunStep(model, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_RunStep failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Train Step Success.\n"</span>);</li></ol></pre></div></div></li>      <li>       <p>导出训练后模型。</p>       <p>使用OH_AI_ExportModel接口导出训练后模型。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Export Train Model</span></li><li>ret = OH_AI_ExportModel(model, OH_AI_MODELTYPE_MINDIR, export_train_model, OH_AI_NO_QUANT, <span class="hljs-literal">false</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ExportModel train failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Train Model Success.\n"</span>);</li><li>
</li><li><span class="hljs-comment">// Export Inference Model</span></li><li>ret = OH_AI_ExportModel(model, OH_AI_MODELTYPE_MINDIR, export_infer_model, OH_AI_NO_QUANT, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ExportModel inference failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Inference Model Success.\n"</span>);</li></ol></pre></div></div></li>      <li>       <p>释放模型。</p>       <p>不再使用MindSpore Lite推理框架时，需要释放已经创建的模型。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Delete model and context.</span></li><li>OH_AI_ModelDestroy(&amp;model);</li><li>OH_AI_ContextDestroy(&amp;context);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>编写CMakeLists.txt。</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>cmake_minimum_required(VERSION <span class="hljs-number">3.14</span>)</li><li>project(TrainDemo)</li><li>
</li><li>add_executable(train_demo main.c)</li><li>
</li><li>target_link_libraries(</li><li>        train_demo</li><li>        mindspore_lite_ndk</li><li>)</li></ol></pre></div></div>       <ul>        <li>         <p>使用ohos-sdk交叉编译，需要对CMake设置native工具链路径，即：-DCMAKE_TOOLCHAIN_FILE="/xxx/native/build/cmake/ohos.toolchain.cmake"。</p></li>        <li>         <p>编译命令如下，其中OHOS_NDK需要设置为native工具链路径：</p>         <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>  mkdir -p build</li><li>
</li><li>  cd ./build || exit</li><li>  OHOS_NDK=""</li><li>  cmake -G "Unix Makefiles" \</li><li>        -S ../ \</li><li>        -DCMAKE_TOOLCHAIN_FILE="$OHOS_NDK/build/cmake/ohos.toolchain.cmake" \</li><li>        -DOHOS_ARCH=arm64-v8a \</li><li>        -DCMAKE_BUILD_TYPE=Release</li><li>
</li><li>  make</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>运行编译的可执行程序。</p>       <ul>        <li>使用hdc连接设备，并将train_demo和lenet_train.ms推送到设备中的相同目录。</li>        <li>使用hdc shell进入设备，并进入train_demo所在的目录执行如下命令，即可得到结果。</li>       </ul>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>./train_demo ./lenet_train.ms export_train_model export_infer_model</li></ol></pre></div></div>       <p>得到如下输出：</p>       <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>Train Step Success.</li><li>Export Train Model Success.</li><li>Export Inference Model Success.</li><li>Tensor name: Default/network-WithLossCell/_backbone-LeNet5/fc3-Dense/BiasAdd-op121, tensor size is 80, elements num: 20.</li><li>output data is:</li><li>0.000265 0.000231 0.000254 0.000269 0.000238 0.000228</li></ol></pre></div></div>       <p>在train_demo所在目录可以看到导出的两个模型文件：export_train_model.ms和export_infer_model.ms。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-nmp-c106="" class="highlight-div"><div _ngcontent-nmp-c106="" class="highlight-div-header"><div _ngcontent-nmp-c106="" class="highlight-div-header-left"><div _ngcontent-nmp-c106="" class="handle-button expand-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmp-c106="" class="highlight-div-header-right"><div _ngcontent-nmp-c106="" class="handle-button ai-button"></div><div _ngcontent-nmp-c106="" class="handle-button line-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmp-c106="" class="handle-button theme-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmp-c106="" class="handle-button copy-button"><div _ngcontent-nmp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mindspore/model.h"</span></span></li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">GenerateInputDataWithRandom</span><span class="hljs-params">(OH_AI_TensorHandleArray inputs)</span> {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inputs.handle_num; ++i) {</li><li>    <span class="hljs-type">float</span> *input_data = (<span class="hljs-type">float</span> *)OH_AI_TensorGetMutableData(inputs.handle_list[i]);</li><li>    <span class="hljs-keyword">if</span> (input_data == <span class="hljs-literal">NULL</span>) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TensorGetMutableData failed.\n"</span>);</li><li>      <span class="hljs-keyword">return</span>  OH_AI_STATUS_LITE_ERROR;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> num = OH_AI_TensorGetElementNum(inputs.handle_list[i]);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> divisor = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; num; j++) {</li><li>      input_data[j] = (<span class="hljs-type">float</span>)(rand() % divisor) / divisor;  <span class="hljs-comment">// 0--0.9f</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">ModelPredict</span><span class="hljs-params">(<span class="hljs-type">char</span>* model_file)</span> {</li><li>  <span class="hljs-comment">// Create and init context, add CPU device info</span></li><li>  OH_AI_ContextHandle context = OH_AI_ContextCreate();</li><li>  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ContextCreate failed.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>
</li><li>  OH_AI_DeviceInfoHandle cpu_device_info = OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);</li><li>  <span class="hljs-keyword">if</span> (cpu_device_info == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>  OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</li><li>
</li><li>  <span class="hljs-comment">// Create model</span></li><li>  OH_AI_ModelHandle model = OH_AI_ModelCreate();</li><li>  <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Build model</span></li><li>  <span class="hljs-type">int</span> ret = OH_AI_ModelBuildFromFile(model, model_file, OH_AI_MODELTYPE_MINDIR, context);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelBuildFromFile failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Get Inputs</span></li><li>  OH_AI_TensorHandleArray inputs = OH_AI_ModelGetInputs(model);</li><li>  <span class="hljs-keyword">if</span> (inputs.handle_list == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelGetInputs failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Generate random data as input data.</span></li><li>  ret = GenerateInputDataWithRandom(inputs);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"GenerateInputDataWithRandom failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Model Predict</span></li><li>  OH_AI_TensorHandleArray outputs;</li><li>  ret = OH_AI_ModelPredict(model, inputs, &amp;outputs, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"MSModelPredict failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Print Output Tensor Data.</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outputs.handle_num; ++i) {</li><li>    OH_AI_TensorHandle tensor = outputs.handle_list[i];</li><li>    <span class="hljs-type">int64_t</span> element_num = OH_AI_TensorGetElementNum(tensor);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Tensor name: %s, tensor size is %ld ,elements num: %ld.\n"</span>, OH_AI_TensorGetName(tensor),</li><li>           OH_AI_TensorGetDataSize(tensor), element_num);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> *data = (<span class="hljs-type">const</span> <span class="hljs-type">float</span> *)OH_AI_TensorGetData(tensor);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"output data is:\n"</span>);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> max_print_num = <span class="hljs-number">50</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; element_num &amp;&amp; j &lt;= max_print_num; ++j) {</li><li>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%f "</span>, data[j]);</li><li>    }</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);</li><li>  }</li><li>
</li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">TrainDemo</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv)</span> {</li><li>  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">4</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Model file must be provided.\n"</span>);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Train Model path must be provided.\n"</span>);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Inference Model path must be provided.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *model_file = argv[<span class="hljs-number">1</span>];</li><li>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *export_train_model = argv[<span class="hljs-number">2</span>];</li><li>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *export_infer_model = argv[<span class="hljs-number">3</span>];</li><li>
</li><li>  <span class="hljs-comment">// Create and init context, add CPU device info</span></li><li>  OH_AI_ContextHandle context = OH_AI_ContextCreate();</li><li>  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ContextCreate failed.\n"</span>);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>
</li><li>  OH_AI_DeviceInfoHandle cpu_device_info = OH_AI_DeviceInfoCreate(OH_AI_DEVICETYPE_CPU);</li><li>  <span class="hljs-keyword">if</span> (cpu_device_info == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_DeviceInfoCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>  OH_AI_ContextAddDeviceInfo(context, cpu_device_info);</li><li>
</li><li>  <span class="hljs-comment">// Create trainCfg</span></li><li>  OH_AI_TrainCfgHandle trainCfg = OH_AI_TrainCfgCreate();</li><li>  <span class="hljs-keyword">if</span> (trainCfg == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TrainCfgCreate failed.\n"</span>);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Create model</span></li><li>  OH_AI_ModelHandle model = OH_AI_ModelCreate();</li><li>  <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelCreate failed.\n"</span>);</li><li>    OH_AI_TrainCfgDestroy(&amp;trainCfg);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> OH_AI_STATUS_LITE_ERROR;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Build model</span></li><li>  <span class="hljs-type">int</span> ret = OH_AI_TrainModelBuildFromFile(model, model_file, OH_AI_MODELTYPE_MINDIR, context, trainCfg);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_TrainModelBuildFromFile failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Get Inputs</span></li><li>  OH_AI_TensorHandleArray inputs = OH_AI_ModelGetInputs(model);</li><li>  <span class="hljs-keyword">if</span> (inputs.handle_list == <span class="hljs-literal">NULL</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelGetInputs failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Generate random data as input data.</span></li><li>  ret = GenerateInputDataWithRandom(inputs);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"GenerateInputDataWithRandom failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Set Train Mode</span></li><li>  ret = OH_AI_ModelSetTrainMode(model, <span class="hljs-literal">true</span>);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ModelSetTrainMode failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Model Train Step</span></li><li>  ret = OH_AI_RunStep(model, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_RunStep failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Train Step Success.\n"</span>);</li><li>
</li><li>  <span class="hljs-comment">// Export Train Model</span></li><li>  ret = OH_AI_ExportModel(model, OH_AI_MODELTYPE_MINDIR, export_train_model, OH_AI_NO_QUANT, <span class="hljs-literal">false</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ExportModel train failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Train Model Success.\n"</span>);</li><li>
</li><li>  <span class="hljs-comment">// Export Inference Model</span></li><li>  ret = OH_AI_ExportModel(model, OH_AI_MODELTYPE_MINDIR, export_infer_model, OH_AI_NO_QUANT, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_AI_ExportModel inference failed, ret: %d.\n"</span>, ret);</li><li>    OH_AI_ModelDestroy(&amp;model);</li><li>    OH_AI_ContextDestroy(&amp;context);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Export Inference Model Success.\n"</span>);</li><li>
</li><li>  <span class="hljs-comment">// Delete model and context.</span></li><li>  OH_AI_ModelDestroy(&amp;model);</li><li>  OH_AI_ContextDestroy(&amp;context);</li><li>
</li><li>  <span class="hljs-comment">// Use The Exported Model to predict</span></li><li>  <span class="hljs-type">char</span> *exported_model = <span class="hljs-built_in">strcat</span>(export_infer_model, <span class="hljs-string">".ms"</span>);</li><li>  ret = ModelPredict(exported_model);</li><li>  <span class="hljs-keyword">if</span> (ret != OH_AI_STATUS_SUCCESS) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Exported Model to predict failed, ret: %d.\n"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> OH_AI_STATUS_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv)</span> { <span class="hljs-keyword">return</span> TrainDemo(argc, argv); }</li></ol></pre></div></div>    </div>   </div>   <div></div></div>