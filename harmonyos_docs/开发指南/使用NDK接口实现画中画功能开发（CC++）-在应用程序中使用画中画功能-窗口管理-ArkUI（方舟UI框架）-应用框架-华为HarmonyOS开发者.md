<h1 _ngcontent-knp-c119="" class="doc-title ng-star-inserted" title="使用NDK接口实现画中画功能开发（C/C++）"> 使用NDK接口实现画中画功能开发（C/C++） </h1>

<div _ngcontent-knp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文以视频播放为例，介绍通过NDK接口实现画中画功能的基本开发步骤。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>从API version 20开始，支持使用NDK接口实现画中画功能开发。</li><li>支持在Phone、PC/2in1、Tablet设备使用NDK接口实现画中画功能开发。</li></ul> </div></div></div> <div class="tiledSection"><h2 id="section15228151181313">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15228151181313" tips="复制节点链接"></i></h2><ul><li>画中画窗口中画面的呈现不通过传入XComponent Controller实现，而是通过渲染surfaceId（在开启画中画回调中获取）对应的组件实现。</li><li>与typeNode实现方式相同，系统不缓存页面。如需进行页面操作，应用需要开启画中画生命周期监听，在对应周期内进行对应操作。</li><li>不支持设置自动拉起画中画。</li></ul> </div> <div class="tiledSection"><h2 id="section1623125242713">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1623125242713" tips="复制节点链接"></i></h2><p>示例中的视频播放器简易实现逻辑如下：</p> </div> <ol><li><span>通过OH_PictureInPicture_CreatePipConfig创建画中画参数配置器，并通过OH_PictureInPicture_SetPipMainWindowId、OH_PictureInPicture_SetPipTemplateType、OH_PictureInPicture_SetPipRect、OH_PictureInPicture_SetPipControlGroup、OH_PictureInPicture_SetPipNapiEnv接口在画中画参数配置器中设置初始配置信息。</span></li><li><span>创建画中画控制器，后续可根据返回的控制器标识controllerId注册生命周期事件以及控制事件回调。通过OH_PictureInPicture_CreatePip接口创建画中画控制器实例，并缓存对应的控制器标识。建议在创建完成后立即调用OH_PictureInPicture_DestroyPipConfig销毁画中画参数配置器，以免发生内存泄漏。</span></li><li><span>通过OH_PictureInPicture_RegisterStartPipCallback接口注册启动画中画回调，并根据返回的surfaceId渲染视频画面。同时应用可以按需注册其他需要监听的事件回调。</span></li><li><span>通过OH_PictureInPicture_StartPip启动画中画。</span></li><li><span>通过OH_PictureInPicture_UpdatePipContentSize更新媒体源尺寸信息。</span></li><li><span>通过OH_PictureInPicture_StopPip关闭画中画。</span></li><li><span>通过OH_PictureInPicture_UnregisterStartPipCallback解注册画中画启动回调，避免内存泄漏。同时应用可以按需解注册其他已注册的事件回调。</span></li></ol> <p>以上步骤涉及的各文件及示例可见下文。</p> <p>Node-API模块注册，具体使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines" target="_blank">Native API在应用工程中的使用指导</a>。</p> <div class="p">本文件仅作为参考示例，异常处理及错误码打印由开发者按需处理。<div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstddef&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"window_manager/oh_window_pip.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"js_native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"rawfile/raw_file_manager.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_MSG_TAG <span class="hljs-string">"PiPMain"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG(format, ...) ((void)OH_LOG_Print(LOG_APP, LOG_INFO, 0xFF00, LOG_MSG_TAG, format, ##__VA_ARGS__))</span></li><li>napi_ref jsCallback;</li><li>napi_env env_;</li><li>
</li><li>napi_ref jsLifecycleCallback;</li><li>napi_env lifeEnv_;</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">int32_t</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_int32</span>(env, jsValue, &amp;value) == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">uint32_t</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_uint32</span>(env, jsValue, &amp;value) == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">int64_t</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_int64</span>(env, jsValue, &amp;value) == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">uint64_t</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int64_t</span> num;</li><li>    <span class="hljs-keyword">auto</span> res = <span class="hljs-built_in">napi_get_value_int64</span>(env, jsValue, &amp;num);</li><li>    <span class="hljs-keyword">if</span> (res == napi_ok) {</li><li>        value = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(num);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> res == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">double</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_double</span>(env, jsValue, &amp;value) == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">bool</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_bool</span>(env, jsValue, &amp;value) == napi_ok;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsNumber</span><span class="hljs-params">(napi_env env, napi_value jsValue, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int32_t</span> num;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_int32</span>(env, jsValue, &amp;num) != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">0</span> || num &gt; <span class="hljs-number">255</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 越界无效</span></li><li>    }</li><li>    value = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(num);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> T&gt;</span></li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ConvertFromJsValue</span><span class="hljs-params">(napi_env env, napi_value jsValue, T&amp; value)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (jsValue == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">using</span> ValueType = std::<span class="hljs-type">remove_cv_t</span>&lt;std::<span class="hljs-type">remove_reference_t</span>&lt;T&gt;&gt;;</li><li>    <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(std::is_same_v&lt;ValueType, <span class="hljs-type">bool</span>&gt;)</span> </span>{</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">napi_get_value_bool</span>(env, jsValue, &amp;value) == napi_ok;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_arithmetic_v&lt;ValueType&gt;) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ConvertFromJsNumber</span>(env, jsValue, value);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_same_v&lt;ValueType, std::string&gt;) {</li><li>        <span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf8</span>(env, jsValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;len) != napi_ok) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>        <span class="hljs-keyword">auto</span> buffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(len + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-type">size_t</span> strLength = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf8</span>(env, jsValue, buffer.<span class="hljs-built_in">get</span>(), len + <span class="hljs-number">1</span>, &amp;strLength) == napi_ok) {</li><li>            value = buffer.<span class="hljs-built_in">get</span>();</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>        }</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">constexpr</span> (std::is_enum_v&lt;ValueType&gt;) {</li><li>        std::<span class="hljs-type">make_signed_t</span>&lt;ValueType&gt; numberValue = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ConvertFromJsNumber</span>(env, jsValue, numberValue)) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>        value = <span class="hljs-built_in">static_cast</span>&lt;ValueType&gt;(numberValue);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PipStartPipCallback</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> controllerId, <span class="hljs-type">uint8_t</span> requestId, <span class="hljs-type">uint64_t</span> surfaceId)</span> </span>{</li><li>    <span class="hljs-keyword">if</span>(jsCallback) {</li><li>        napi_value global = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_global</span>(env_, &amp;global);</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        std::string tStr = std::<span class="hljs-built_in">to_string</span>(surfaceId);</li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* cStr = tStr.<span class="hljs-built_in">c_str</span>();</li><li>        <span class="hljs-type">size_t</span> length = <span class="hljs-built_in">strlen</span>(cStr);</li><li>        napi_value str;</li><li>        napi_status status = <span class="hljs-built_in">napi_create_string_utf8</span>(env_, cStr, length, &amp;str);</li><li>        napi_value argv[<span class="hljs-number">1</span>] = {str};</li><li>        napi_value jsCallbackValue;</li><li>        </li><li>        napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-keyword">if</span>(!jsCallback) {</li><li>            <span class="hljs-built_in">LOG</span>(<span class="hljs-string">"js callback is invalid"</span>);</li><li>        }</li><li>        <span class="hljs-built_in">napi_get_reference_value</span>(env_, jsCallback, &amp;jsCallbackValue);</li><li>        <span class="hljs-built_in">napi_call_function</span>(env_, global, jsCallbackValue, argc, argv, &amp;result);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LifecycleCallback</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> controllerId, PictureInPicture_PipState state, <span class="hljs-type">int32_t</span> errcode)</span> </span>{</li><li>    <span class="hljs-keyword">if</span>(jsLifecycleCallback) {</li><li>        napi_value global = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_global</span>(lifeEnv_, &amp;global);</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value pipState = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_int32</span>(lifeEnv_, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int32_t</span>&gt; (state), &amp;pipState);</li><li>        napi_value argv[<span class="hljs-number">1</span>] = {pipState};</li><li>        napi_value jsCallbackValue;</li><li>        </li><li>        napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-keyword">if</span>(!jsCallback) {</li><li>            <span class="hljs-built_in">LOG</span>(<span class="hljs-string">"js callback is invalid"</span>);</li><li>        }</li><li>        <span class="hljs-built_in">napi_get_reference_value</span>(lifeEnv_, jsLifecycleCallback, &amp;jsCallbackValue);</li><li>        <span class="hljs-built_in">napi_call_function</span>(lifeEnv_, global, jsCallbackValue, argc, argv, &amp;result);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PiPManager</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreatePip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StartPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RegisterStartPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DeletePip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">StopPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RegisterLifecycleListener</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>};</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::CreatePip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value config = argv[<span class="hljs-number">0</span>];</li><li>    </li><li>
</li><li>    napi_value mainWindowIdValue = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value pipTemplateTypeValue = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value widthValue = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value heightValue = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value controlGroupValue = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value pipControllerIdValue = <span class="hljs-literal">nullptr</span>;</li><li>    </li><li>    <span class="hljs-type">uint32_t</span> controllerId = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">uint32_t</span> mainWindowId = <span class="hljs-number">-1</span>;</li><li>    PictureInPicture_PipTemplateType pipTemplateType = PictureInPicture_PipTemplateType::VIDEO_PLAY;</li><li>    <span class="hljs-type">uint32_t</span> width = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">uint32_t</span> height = <span class="hljs-number">-1</span>;</li><li>    </li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"mainWindowId"</span>, &amp;mainWindowIdValue);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"pipTemplateType"</span>, &amp;pipTemplateTypeValue);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"width"</span>, &amp;widthValue);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"height"</span>, &amp;heightValue);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"controlGroup"</span>, &amp;controlGroupValue);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, config, <span class="hljs-string">"pipControllerId"</span>, &amp;pipControllerIdValue);</li><li>    </li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, mainWindowIdValue, mainWindowId);</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, pipTemplateTypeValue, pipTemplateType);</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, widthValue, width);</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, heightValue, height);</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, pipControllerIdValue, controllerId);</li><li>    </li><li>    <span class="hljs-type">uint32_t</span> size = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_array_length</span>(env, controlGroupValue, &amp;size);</li><li>    PictureInPicture_PipControlGroup controlGroup[size];</li><li>    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {</li><li>        napi_value getElementValue = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_element</span>(env, controlGroupValue, i, &amp;getElementValue);</li><li>         PictureInPicture_PipControlGroup controlType;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ConvertFromJsValue</span>(env, getElementValue, controlType)) {</li><li>            controlGroup[i] = controlType;</li><li>        }</li><li>        <span class="hljs-built_in">LOG</span>(<span class="hljs-string">"controlType: %{public}d"</span>, controlType);</li><li>    }</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    PictureInPicture_PipConfig pipConfig<span class="">;</span></li><li>    <span class="hljs-built_in">OH_PictureInPicture_CreatePipConfig</span>(&amp;pipConfig);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_SetPipMainWindowId</span>(pipConfig, mainWindowId);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_SetPipTemplateType</span>(pipConfig, pipTemplateType);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_SetPipRect</span>(pipConfig, width, height);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_SetPipControlGroup</span>(pipConfig, controlGroup, size);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_SetPipNapiEnv</span>(pipConfig, env);</li><li>    <span class="hljs-type">int32_t</span> res = <span class="hljs-built_in">OH_PictureInPicture_CreatePip</span>(pipConfig, &amp;controllerId);</li><li>    <span class="hljs-built_in">OH_PictureInPicture_DestroyPipConfig</span>(&amp;pipConfig);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, controllerId, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::StartPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value controlIdValue = argv[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-type">uint32_t</span> controlId = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, controlIdValue, controlId);</li><li>    napi_value resultValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int32_t</span> result = <span class="hljs-built_in">OH_PictureInPicture_StartPip</span>(controlId);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, result, &amp;resultValue);</li><li>    <span class="hljs-keyword">return</span> resultValue;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::RegisterStartPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value controllerIdValue = argv[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-type">uint32_t</span> controlId = <span class="hljs-number">-1</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_create_reference</span>(env, argv[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>, &amp;jsCallback);</li><li>    env_ = env;</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, controllerIdValue, controlId);</li><li>    napi_value resultValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int32_t</span> result = <span class="hljs-built_in">OH_PictureInPicture_RegisterStartPipCallback</span>(controlId, PipStartPipCallback);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, result, &amp;resultValue);</li><li>    <span class="hljs-keyword">return</span> resultValue;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::DeletePip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">uint32_t</span> controlId = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, argv[<span class="hljs-number">0</span>], controlId);</li><li>    napi_value resultValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int32_t</span> result = <span class="hljs-built_in">OH_PictureInPicture_DeletePip</span>(controlId);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, result, &amp;resultValue);</li><li>    <span class="hljs-keyword">return</span> resultValue;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::StopPip</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">uint32_t</span> controlId = <span class="hljs-number">-1</span>;</li><li>    napi_value resultValue = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, argv[<span class="hljs-number">0</span>], controlId);</li><li>    <span class="hljs-type">uint32_t</span> result = <span class="hljs-built_in">OH_PictureInPicture_StopPip</span>(controlId);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, result, &amp;resultValue);</li><li>    <span class="hljs-keyword">return</span> resultValue;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">PiPManager::RegisterLifecycleListener</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">uint32_t</span> controlId = <span class="hljs-number">-1</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_create_reference</span>(env, argv[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>, &amp;jsLifecycleCallback);</li><li>    lifeEnv_ = env;</li><li>    <span class="hljs-keyword">if</span>(status != napi_ok) {</li><li>        <span class="hljs-built_in">LOG</span>(<span class="hljs-string">"register failed %{public}d"</span>, status);</li><li>    }</li><li>    <span class="hljs-built_in">ConvertFromJsValue</span>(env, argv[<span class="hljs-number">0</span>], controlId);</li><li>    </li><li>    napi_value resultValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int32_t</span> result = <span class="hljs-built_in">OH_PictureInPicture_RegisterLifecycleListener</span>(controlId, LifecycleCallback);</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, result, &amp;resultValue);</li><li>    <span class="hljs-keyword">return</span> resultValue;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"createPip"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::CreatePip, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"startPip"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::StartPip, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"registerStartPip"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::RegisterStartPip, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"deletePip"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::DeletePip, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"stopPip"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::StopPip, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"registerLifecycleListener"</span>, <span class="hljs-literal">nullptr</span>, PiPManager::RegisterLifecycleListener, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> </div> <div class="p">Node-API接口声明。<div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PiPControlGroup</span> {</li><li>  <span class="hljs-variable constant_">VIDEO_PLAY_VIDEO_PREVIOUS_NEXT</span> = <span class="hljs-number">101</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_PLAY_FAST_FORWARD_BACKWARD</span> = <span class="hljs-number">102</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_CALL_MICROPHONE_SWITCH</span> = <span class="hljs-number">201</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_CALL_HANG_UP_BUTTON</span> = <span class="hljs-number">202</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_CALL_CAMERA_SWITCH</span> = <span class="hljs-number">203</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_CALL_MUTE_SWITCH</span> = <span class="hljs-number">204</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_MEETING_HANG_UP_BUTTON</span> = <span class="hljs-number">301</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_MEETING_CAMERA_SWITCH</span> = <span class="hljs-number">302</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_MEETING_MUTE_SWITCH</span> = <span class="hljs-number">303</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_MEETING_MICROPHONE_SWITCH</span> = <span class="hljs-number">304</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_LIVE_VIDEO_PLAY_PAUSE</span> = <span class="hljs-number">401</span>,</li><li>  <span class="hljs-variable constant_">VIDEO_LIVE_MUTE_SWITCH</span> = <span class="hljs-number">402</span>,</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PiPConfig</span> {</li><li>  <span class="hljs-attr">mainWindowId</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">pipTemplateType</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">controlGroup</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">PiPControlGroup</span>&gt;;</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createPip</span>: <span class="hljs-function">(<span class="hljs-params">config: PiPConfig</span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">startPip</span>: <span class="hljs-function">(<span class="hljs-params">controllerId: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerStartPip</span>: <span class="hljs-function">(<span class="hljs-params">controllerId: <span class="hljs-built_in">number</span>, jsCallback: <span class="hljs-built_in">Function</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">deletePip</span>: <span class="hljs-function">(<span class="hljs-params">controllerId: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">stopPip</span>: <span class="hljs-function">(<span class="hljs-params">controllerId: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerLifecycleListener</span>: <span class="hljs-function">(<span class="hljs-params">controllerId: <span class="hljs-built_in">number</span>, jsCallback: <span class="hljs-built_in">Function</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div> </div> <div class="p">CMakeLists.txt文件，用于生成对应的库文件。<div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># CMakeLists<span class="hljs-selector-class">.txt</span></li><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)</li><li><span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)</li><li><span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</li><li><span class="hljs-built_in">project</span>(MyApplication)</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libace_ndk.z.so libnative_window_manager.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> <p>EntryAbility文件示例。</p> <div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">ConfigurationConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'UIContext'</span>, ctx);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-title function_">setColorMode</span>(<span class="hljs-title class_">ConfigurationConstant</span>.<span class="hljs-property">ColorMode</span>.<span class="hljs-property">COLOR_MODE_NOT_SET</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">subWindowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClassId</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取应用主窗及ID</span></li><li>      <span class="hljs-keyword">let</span> promise = windowStage.<span class="hljs-title function_">getMainWindow</span>();</li><li>      promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to obtaining the window. Cause: The data is empty"</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        windowClass = data;</li><li>        windowClass.<span class="hljs-title function_">setUIContent</span>(<span class="hljs-string">"pages/Index"</span>);</li><li>        windowClassId = windowClass.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">id</span>;</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowId'</span>, windowClassId);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in obtaining the window'</span>)</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to obtaining the window. Cause code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to obtaining the window.`</span>);</li><li>    }</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content. Data: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) ?? <span class="hljs-string">''</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="p">示例中的视频播放需要使用AVPlayer，具体实现可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback" target="_blank">视频播放</a>。<div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// models/AVPlayer.ets</span></li><li><span class="hljs-comment">// 视频播放器简单实现</span></li><li><span class="hljs-keyword">import</span> media from <span class="hljs-string">'@ohos.multimedia.media'</span>;</li><li><span class="hljs-keyword">import</span> common from <span class="hljs-string">'@ohos.app.ability.common'</span>;</li><li><span class="hljs-keyword">import</span> { BusinessError } from <span class="hljs-string">'@ohos.base'</span>;</li><li><span class="hljs-keyword">import</span> resourceManager from <span class="hljs-string">'@ohos.resourceManager'</span>;</li><li>
</li><li>
</li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayer</span> {</li><li>  <span class="hljs-keyword">public</span> avPlayer?: media.AVPlayer;</li><li>  <span class="hljs-keyword">private</span> count: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> surfaceID: string; <span class="hljs-comment">// surfaceID用于播放画面显示，具体的值需要通过Xcomponent接口获取，相关文档链接见上面Xcomponent创建方法</span></li><li>  jumpNext: boolean = <span class="hljs-literal">false</span>;</li><li>  type: number = <span class="hljs-number">0</span>; <span class="hljs-comment">// 用于区分主界面的player还是pip界面的player</span></li><li>  state_: string = <span class="hljs-string">''</span></li><li>  playStatus: boolean = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(surfaceID: string, type: number) {</li><li>    <span class="hljs-keyword">this</span>.surfaceID = surfaceID;</li><li>    <span class="hljs-keyword">this</span>.type = type</li><li>  }</li><li>
</li><li>  setSurfaceId(id: string) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avPlayer) {</li><li>      <span class="hljs-keyword">this</span>.surfaceID = id;</li><li>      <span class="hljs-keyword">this</span>.avPlayer.surfaceId = id;</li><li>    }</li><li>  }</li><li>
</li><li>  updatePlayStatus(status: boolean) {</li><li>    <span class="hljs-keyword">this</span>.playStatus = status;</li><li>  }</li><li>  <span class="hljs-comment">// 注册avplayer回调函数</span></li><li>  setAVPlayerCallback() {</li><li>    <span class="hljs-comment">// seek操作结果回调函数</span></li><li>    <span class="hljs-keyword">this</span>.avPlayer?.on(<span class="hljs-string">'seekDone'</span>, (seekDoneTime: number) =&gt; {</li><li>      console.info(`PipMain AVPlayer seek succeeded, seek time <span class="hljs-keyword">is</span> ${seekDoneTime}`);</li><li>    })</li><li>    <span class="hljs-comment">// error回调监听函数,当avPlayer在操作过程中出现错误时调用reset接口触发重置流程</span></li><li>    <span class="hljs-keyword">this</span>.avPlayer?.on(<span class="hljs-string">'error'</span>, (err: BusinessError) =&gt; {</li><li>      console.error(`PipMain Invoke avPlayer failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>      <span class="hljs-keyword">this</span>.avPlayer?.reset(); <span class="hljs-comment">// 调用reset重置资源，触发idle状态</span></li><li>    })</li><li>    <span class="hljs-comment">// 状态机变化回调函数</span></li><li>    <span class="hljs-keyword">this</span>.avPlayer?.on(<span class="hljs-string">'stateChange'</span>, async (state, reason) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayer) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.state_ = state;</li><li>      switch (state) {</li><li>        case <span class="hljs-string">'idle'</span>: <span class="hljs-comment">// 成功调用reset接口后触发该状态机上报</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state idle called.'</span>);</li><li>          <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.jumpNext) {</li><li>            <span class="hljs-keyword">this</span>.avPlayer.release(); <span class="hljs-comment">// 调用release接口销毁实例对象</span></li><li>          } <span class="hljs-keyword">else</span> {</li><li>            let uiContext: UIContext = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'UIContext'</span>) <span class="hljs-keyword">as</span> UIContext;</li><li>            let context = uiContext.getHostContext() <span class="hljs-keyword">as</span> common.UIAbilityContext;</li><li>            let fileDescriptor: resourceManager.RawFileDescriptor;</li><li>            fileDescriptor = await context.resourceManager.getRawFd(<span class="hljs-string">'640x360.mp4'</span>);</li><li>            <span class="hljs-comment">// 为fdSrc赋值触发initialized状态机上报</span></li><li>            <span class="hljs-keyword">this</span>.avPlayer.fdSrc = fileDescriptor;</li><li>          }</li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// avplayer 设置播放源后触发该状态上报</span></li><li>          console.info(<span class="hljs-string">'initialized called.'</span>);</li><li>          <span class="hljs-keyword">this</span>.avPlayer.surfaceId = <span class="hljs-keyword">this</span>.surfaceID; <span class="hljs-comment">// 设置显示画面，当播放的资源为纯音频时无需设置</span></li><li>          <span class="hljs-keyword">this</span>.avPlayer.prepare().then(() =&gt; {</li><li>            console.info(<span class="hljs-string">'AVPlayer prepare succeeded.'</span>);</li><li>          }, (err: BusinessError) =&gt; {</li><li>            console.error(`Invoke prepare failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>          });</li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'prepared'</span>: <span class="hljs-comment">// prepare调用成功后上报该状态机</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state prepared called.'</span>);</li><li>          <span class="hljs-keyword">this</span>.avPlayer.play(); <span class="hljs-comment">// 调用播放接口开始播放</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'playing'</span>: <span class="hljs-comment">// play成功调用后触发该状态机上报</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state playing called.'</span>);</li><li>          <span class="hljs-keyword">this</span>.jumpNext = <span class="hljs-literal">false</span>;</li><li>          <span class="hljs-keyword">this</span>.count++;</li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'paused'</span>: <span class="hljs-comment">// pause成功调用后触发该状态机上报</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state paused called.'</span>);</li><li>          <span class="hljs-comment">// this.avPlayer.play(); // 再次播放接口开始播放</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'completed'</span>: <span class="hljs-comment">// 播放结束后触发该状态机上报</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state completed called.'</span>);</li><li>          <span class="hljs-keyword">this</span>.playNext();</li><li>          ; <span class="hljs-comment">//调用播放结束接口</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'stopped'</span>: <span class="hljs-comment">// stop接口成功调用后触发该状态机上报</span></li><li>          console.info(<span class="hljs-string">'AVPlayer state stopped called.'</span>);</li><li>          <span class="hljs-keyword">this</span>.avPlayer.reset(); <span class="hljs-comment">// 调用reset接口初始化avplayer状态</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        case <span class="hljs-string">'released'</span>:</li><li>          console.info(<span class="hljs-string">'AVPlayer state released called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        default:</li><li>          console.info(<span class="hljs-string">'AVPlayer state unknown called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    })</li><li>    <span class="hljs-keyword">this</span>.avPlayer?.on(<span class="hljs-string">'videoSizeChange'</span>, (width: number, height: number) =&gt; {</li><li>      console.log(<span class="hljs-string">"videoSizeChange width:"</span> + width + <span class="hljs-string">" height:"</span> + height);</li><li>      let context = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'UIContext'</span>) <span class="hljs-keyword">as</span> common.UIAbilityContext;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 以下demo为使用资源管理接口获取打包在HAP内的媒体资源文件并通过fdSrc属性进行播放示例</span></li><li>  async avPlayerFdSrc() {</li><li>    <span class="hljs-comment">// 创建avPlayer实例对象</span></li><li>    console.log(<span class="hljs-string">'avPlayerFdSrc'</span>);</li><li>    <span class="hljs-keyword">this</span>.avPlayer = await media.createAVPlayer();</li><li>
</li><li>    <span class="hljs-comment">// 创建状态机变化回调函数</span></li><li>    <span class="hljs-keyword">this</span>.setAVPlayerCallback();</li><li>    <span class="hljs-comment">// 通过UIAbilityContext的resourceManager成员的getRawFd接口获取媒体资源播放地址</span></li><li>    <span class="hljs-comment">// 返回类型为{fd,offset,length},fd为HAP包fd地址，offset为媒体资源偏移量，length为播放长度</span></li><li>
</li><li>    let context = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'UIContext'</span>) <span class="hljs-keyword">as</span> common.UIAbilityContext;</li><li>    let fileDescriptor = await context.resourceManager.getRawFd(<span class="hljs-string">'640x360.mp4'</span>);</li><li>    console.log(<span class="hljs-string">'getRawFd'</span>);</li><li>    <span class="hljs-comment">// 为fdSrc赋值触发initialized状态机上报</span></li><li>    <span class="hljs-keyword">this</span>.avPlayer.fdSrc = fileDescriptor;</li><li>  }</li><li>
</li><li>  async playNext() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avPlayer === <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.jumpNext = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.avPlayer?.stop();</li><li>  }</li><li>
</li><li>  play() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state_ === <span class="hljs-string">'paused'</span>) {</li><li>      <span class="hljs-keyword">this</span>.avPlayer?.play();</li><li>    }</li><li>  }</li><li>
</li><li>  pause() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state_ === <span class="hljs-string">'playing'</span>) {</li><li>      <span class="hljs-keyword">this</span>.avPlayer?.pause();</li><li>    }</li><li>  }</li><li>
</li><li>  stopAvPlayer() {</li><li>    console.log(<span class="hljs-string">"stopAvPlayer&gt;&gt;&gt;"</span>)</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayer) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.avPlayer.stop();</li><li>    console.log(<span class="hljs-string">"stopping&gt;&gt;&gt;"</span>);</li><li>    <span class="hljs-keyword">this</span>.avPlayer.reset();</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="p">应用界面布局文件，用于演示画中画基本功能。<div _ngcontent-knp-c106="" class="highlight-div"><div _ngcontent-knp-c106="" class="highlight-div-header"><div _ngcontent-knp-c106="" class="highlight-div-header-left"><div _ngcontent-knp-c106="" class="handle-button expand-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knp-c106="" class="highlight-div-header-right"><div _ngcontent-knp-c106="" class="handle-button ai-button"></div><div _ngcontent-knp-c106="" class="handle-button line-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knp-c106="" class="handle-button theme-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knp-c106="" class="handle-button copy-button"><div _ngcontent-knp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-comment">// 画中画功能演示界面</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-package">testNapi</span>, {<span class="hljs-variable">PiPConfig</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">PiPWindow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">AVPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../models/AVPlayer'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span> = <span class="hljs-string">'PipMain'</span>;</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PiPControlGroup</span> {</li><li>  <span class="hljs-variable">VIDEO_PLAY_VIDEO_PREVIOUS_NEXT</span> = <span class="hljs-number">101</span>,</li><li>  <span class="hljs-variable">VIDEO_PLAY_FAST_FORWARD_BACKWARD</span> = <span class="hljs-number">102</span>,</li><li>  <span class="hljs-variable">VIDEO_CALL_MICROPHONE_SWITCH</span> = <span class="hljs-number">201</span>,</li><li>  <span class="hljs-variable">VIDEO_CALL_HANG_UP_BUTTON</span> = <span class="hljs-number">202</span>,</li><li>  <span class="hljs-variable">VIDEO_CALL_CAMERA_SWITCH</span> = <span class="hljs-number">203</span>,</li><li>  <span class="hljs-variable">VIDEO_CALL_MUTE_SWITCH</span> = <span class="hljs-number">204</span>,</li><li>  <span class="hljs-variable">VIDEO_MEETING_HANG_UP_BUTTON</span> = <span class="hljs-number">301</span>,</li><li>  <span class="hljs-variable">VIDEO_MEETING_CAMERA_SWITCH</span> = <span class="hljs-number">302</span>,</li><li>  <span class="hljs-variable">VIDEO_MEETING_MUTE_SWITCH</span> = <span class="hljs-number">303</span>,</li><li>  <span class="hljs-variable">VIDEO_MEETING_MICROPHONE_SWITCH</span> = <span class="hljs-number">304</span>,</li><li>  <span class="hljs-variable">VIDEO_LIVE_VIDEO_PLAY_PAUSE</span> = <span class="hljs-number">401</span>,</li><li>  <span class="hljs-variable">VIDEO_LIVE_MUTE_SWITCH</span> = <span class="hljs-number">402</span>,</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-variable">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">controllerId</span>: <span class="hljs-title class_">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">contentWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">contentHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">pipType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPTemplateType</span> = <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPTemplateType</span>.<span class="hljs-variable">VIDEO_PLAY</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">pipControlGroups</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">PiPControlGroup</span>&gt; = [];</li><li>  <span class="hljs-variable">player</span>?: <span class="hljs-title class_">AVPlayer</span>;</li><li>  <span class="hljs-variable">surfaceId</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-variable">changeSurface</span> = (<span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span>.<span class="hljs-title function_">setSurfaceId</span>(<span class="hljs-variable">surfaceId</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">change</span> <span class="hljs-variable">surface</span> <span class="hljs-variable">failed</span>`);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">onStateChange</span> = (<span class="hljs-variable">state</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPState</span>) =&gt; {</li><li>    <span class="hljs-title function_">switch</span>(<span class="hljs-variable">state</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_START</span>:</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">ABOUT_TO_START</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">STARTED</span>:</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">STARTED</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_STOP</span>:</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">ABOUT_TO_STOP</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">STOPPED</span>:</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>) {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">changeSurface</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>?.<span class="hljs-title function_">getXComponentSurfaceId</span>());</li><li>        }</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">STOPPED</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_RESTORE</span>:</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">changeSurface</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>);</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">ABOUT_TO_RESTORE</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ERROR</span>:</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">ERROR</span>`);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-variable">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">RelativeContainer</span>() {</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">20</span> }) {</li><li>
</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'更换模板'</span>)</li><li>          .<span class="hljs-title function_">bindMenu</span>([</li><li>            {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'视频'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipType</span> = <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPTemplateType</span>.<span class="hljs-variable">VIDEO_PLAY</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipControlGroups</span> = [<span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_PLAY_VIDEO_PREVIOUS_NEXT</span>];</li><li>              }</li><li>            },</li><li>            {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'通话'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipType</span> = <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPTemplateType</span>.<span class="hljs-variable">VIDEO_CALL</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipControlGroups</span> = [<span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_CALL_HANG_UP_BUTTON</span>,</li><li>                  <span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_CALL_CAMERA_SWITCH</span>, <span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_CALL_MICROPHONE_SWITCH</span>];</li><li>              }</li><li>            },</li><li>            {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'会议'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipType</span> = <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPTemplateType</span>.<span class="hljs-variable">VIDEO_MEETING</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipControlGroups</span> = [<span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_MEETING_MICROPHONE_SWITCH</span>, <span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_MEETING_HANG_UP_BUTTON</span>,</li><li>                  <span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_MEETING_CAMERA_SWITCH</span>];</li><li>              }</li><li>            },</li><li>            {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'直播'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipType</span> = <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPTemplateType</span>.<span class="hljs-variable">VIDEO_LIVE</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipControlGroups</span> = [<span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_LIVE_VIDEO_PLAY_PAUSE</span>, <span class="hljs-variable">PiPControlGroup</span>.<span class="hljs-variable">VIDEO_LIVE_MUTE_SWITCH</span>];</li><li>              }</li><li>            }</li><li>          ])</li><li>      }</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#DDDDDD'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">SpaceAround</span>)</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-variable">top</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Top</span> },</li><li>        <span class="hljs-variable">middle</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">Center</span> }</li><li>      })</li><li>      .<span class="hljs-title function_">id</span>(<span class="hljs-string">'pip_type_control'</span>)</li><li>      <span class="hljs-title function_">XComponent</span>({</li><li>        <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>,</li><li>        <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">mXComponentController</span></li><li>      })</li><li>        .<span class="hljs-title function_">onLoad</span>(() =&gt; {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>) {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>          }</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">AVPlayer</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>, <span class="hljs-number">1</span>);</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span>.<span class="hljs-title function_">avPlayerFdSrc</span>();</li><li>        })</li><li>        .<span class="hljs-title function_">onDestroy</span>(() =&gt; {</li><li>          <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">XComponent</span> <span class="hljs-variable">onDestroy</span>`);</li><li>        })</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-string">'800px'</span> })</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">10</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#888888'</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-variable">bottom</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Center</span> },</li><li>          <span class="hljs-variable">middle</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'x_component'</span>)</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-string">'800px'</span> })</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'创建画中画'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">windowId</span>: <span class="hljs-title class_">number</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowId'</span>);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">PiPConfig</span> = {</li><li>              <span class="hljs-variable">mainWindowId</span>: <span class="hljs-title class_">windowId</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">number</span>,</li><li>              <span class="hljs-variable">pipTemplateType</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">pipType</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">contentWidth</span>,</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">contentHeight</span>,</li><li>              <span class="hljs-variable">controlGroup</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">pipControlGroups</span></li><li>            }</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span> = <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">createPip</span>(<span class="hljs-variable">config</span>);</li><li>            <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">registerStartPip</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">changeSurface</span>);</li><li>            <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">registerLifecycleListener</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">onStateChange</span>);</li><li>          })</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'开启画中画'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">startPip</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-variable">top</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'x_component'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Bottom</span> },</li><li>        <span class="hljs-variable">left</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">Start</span> }</li><li>      })</li><li>      .<span class="hljs-title function_">id</span>(<span class="hljs-string">'pip_control'</span>)</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'关闭画中画'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">stopPip</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span>);</li><li>          })</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'删除控制器'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-variable">testNapi</span>.<span class="hljs-title function_">deletePip</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">controllerId</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-variable">top</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'pip_control'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Bottom</span> },</li><li>        <span class="hljs-variable">left</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">Start</span> }</li><li>      })</li><li>    }</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-string">'100%'</span> })</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="408.27675000000005" originheight="1480" originwidth="640" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114842.81438314087265793623178905839958:50001231000000:2800:FB1AF61483220A1A79F8E83BB98F16D765E958AD8D27D662FFC9F30880EBFF50.gif" title="点击放大" width="208.47750000000002"></span></p> <div class="tiledSection"><h2 id="section272177265">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section272177265" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/guide-snippets/tree/master/ArkUIWindowPipSamples/WindowPip" target="_blank">实现画中画效果</a></li></ul> </div> </div> <div></div></div>