<h1 _ngcontent-vdd-c119="" class="doc-title ng-star-inserted" title="使用Neon指令扩展"> 使用Neon指令扩展 </h1>

<div _ngcontent-vdd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ARM Neon是ARM架构的SIMD（Single Instruction Multiple Data）扩展实现，提供一条指令处理多个数据的并行处理能力，广泛用于多媒体编解码、2D/3D图形处理等领域，提高执行性能。</p> <p>Neon扩展从ARMv7开始被采用，目前在Cortex-A7、Cortex-A12、Cortex-A15处理器中被设置为默认选项，但在其余的ARMv7 Cortex-A系列中是可选项。具体技术细节请参考《<a href="https://developer.arm.com/documentation/dht0002/a/Introducing-NEON/What-is-SIMD-/ARM-SIMD-instructions?lang=en" target="_blank">Introducing NEON Development Article</a>》。</p> <p>ARMv8a架构CPU默认集成Neon扩展，在AArch64与AArch32两种状态下都支持，详细请参考ARM官方文档《<a href="https://developer.arm.com/documentation/102474/0100/Fundamentals-of-Armv8-Neon-technology" target="_blank">Learn the architecture - Introducing Neon</a>》。</p>  <div class="tiledSection"><h2 id="harmonyos架构支持情况">HarmonyOS架构支持情况<i class="anchor-icon anchor-icon-link" anchorid="harmonyos架构支持情况" tips="复制节点链接"></i></h2><p>在HarmonyOS系统中，arm64-v8a ABI下默认已经开启了对Neon扩展的支持；在armeabi-v7a ABI下，为了能够尽可能的支持ARMv7a架构设备，默认不开启Neon扩展。</p> <p>在HarmonyOS SDK的LLVM工具链中，为armeabi-v7a ABI提供了对多种配置的预编译运行时库的支持，供开发者根据不同的配置进行选择。具体目录结构如下，native-root表示NDK所在的native包解压根目录。</p> <div _ngcontent-vdd-c106="" class="highlight-div"><div _ngcontent-vdd-c106="" class="highlight-div-header"><div _ngcontent-vdd-c106="" class="highlight-div-header-left"><div _ngcontent-vdd-c106="" class="handle-button expand-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdd-c106="" class="highlight-div-header-right"><div _ngcontent-vdd-c106="" class="handle-button ai-button"></div><div _ngcontent-vdd-c106="" class="handle-button line-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdd-c106="" class="handle-button theme-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdd-c106="" class="handle-button copy-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdd-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>{native-root}/llvm/lib/clang/current/lib/arm-linux-ohos/</li><li>    |-- a7_hard_neon-vfpv4</li><li>    |       |-- clang_rt.crtbegin.o</li><li>    |       |-- clang_rt.crtend.o</li><li>    |       |-- ...</li><li>    |</li><li>    |-- a7_soft</li><li>    |       |-- clang_rt.crtbegin.o</li><li>    |       |-- clang_rt.crtend.o</li><li>    |       |-- ...</li><li>    |</li><li>    |-- a7_softfp_neon-vfpv4</li><li>            |-- clang_rt.crtbegin.o</li><li>            |-- clang_rt.crtend.o</li><li>            |-- ...</li></ol></pre></div></div> <p>其中hard、soft、softfp是float-abi，未指定默认采用softfp；neon-vfpv4就是-mfpu指定的参数类型，LLVM工具链根据相应编译参数选择依赖不同架构配置的二进制库。</p> </div>  <div class="tiledSection"><h2 id="如何使用">如何使用<i class="anchor-icon anchor-icon-link" anchorid="如何使用" tips="复制节点链接"></i></h2><p>使用Neon扩展的主要通过如下几种方式：</p> <ul><li><p>使用LLVM的Auto-Vectorization特性，由编译器来生成对应指令，默认开启，可以通过-fno-vectorize关闭，具体参考《<a href="https://llvm.org/docs/Vectorizers.html" target="_blank">Auto-Vectorization in LLVM</a>》。</p>  </li><li><p>使用Neon intrinsics库，方便开发者直接操作低阶Neon指令。</p>  </li><li><p>手工写Neon汇编指令。</p>  </li></ul> <p>详细可以参考《<a href="https://developer.arm.com/Architectures/Neon" target="_blank">Arm Neon架构</a>》。</p> </div>  <div class="tiledSection"><h2 id="举例说明">举例说明<i class="anchor-icon anchor-icon-link" anchorid="举例说明" tips="复制节点链接"></i></h2><p>下面举例说明在一个armeabi-v7a HarmonyOS C++工程中如何使用Neon intrinsics。</p> <ol><li><p>使用Neon intrinsics需要在源码包含arm_neon.h头文件，由于该特性与CPU架构强相关，在包含该头文件时，推荐用cpu features等宏括起来。</p>  <div _ngcontent-vdd-c106="" class="highlight-div"><div _ngcontent-vdd-c106="" class="highlight-div-header"><div _ngcontent-vdd-c106="" class="highlight-div-header-left"><div _ngcontent-vdd-c106="" class="handle-button expand-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdd-c106="" class="highlight-div-header-right"><div _ngcontent-vdd-c106="" class="handle-button ai-button"></div><div _ngcontent-vdd-c106="" class="handle-button line-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdd-c106="" class="handle-button theme-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdd-c106="" class="handle-button copy-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"cpu_features_macros.h"</span></span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">call_neon_intrinsics</span><span class="hljs-params">(<span class="hljs-type">short</span> *output, <span class="hljs-type">const</span> <span class="hljs-type">short</span>* input, <span class="hljs-type">const</span> <span class="hljs-type">short</span>* kernel, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> kernelSize)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-type">int</span> nn, offset = -kernelSize/<span class="hljs-number">2</span>;</li><li>   <span class="hljs-keyword">for</span> (nn = <span class="hljs-number">0</span>; nn &lt; width; nn++)</li><li>   {</li><li>        <span class="hljs-type">int</span> mm, sum = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-type">int32x4_t</span> sum_vec = <span class="hljs-built_in">vdupq_n_s32</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// Neon指令函数</span></li><li>        <span class="hljs-keyword">for</span>(mm = <span class="hljs-number">0</span>; mm &lt; kernelSize/<span class="hljs-number">4</span>; mm++)</li><li>        {</li><li>            <span class="hljs-type">int16x4_t</span>  kernel_vec = <span class="hljs-built_in">vld1_s16</span>(kernel + mm*<span class="hljs-number">4</span>);</li><li>            <span class="hljs-type">int16x4_t</span>  input_vec = <span class="hljs-built_in">vld1_s16</span>(input + (nn+offset+mm*<span class="hljs-number">4</span>));</li><li>            sum_vec = <span class="hljs-built_in">vmlal_s16</span>(sum_vec, kernel_vec, input_vec);</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>   }</li><li>   <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>  </li><li><p>在函数实现处，根据CPU特性调用对应的实现函数。</p>  <div _ngcontent-vdd-c106="" class="highlight-div"><div _ngcontent-vdd-c106="" class="highlight-div-header"><div _ngcontent-vdd-c106="" class="highlight-div-header-left"><div _ngcontent-vdd-c106="" class="handle-button expand-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdd-c106="" class="highlight-div-header-right"><div _ngcontent-vdd-c106="" class="handle-button ai-button"></div><div _ngcontent-vdd-c106="" class="handle-button line-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdd-c106="" class="handle-button theme-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdd-c106="" class="handle-button copy-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{</li><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined (CPU_FEATURES_ARCH_ARM)</span></li><li>  <span class="hljs-type">static</span> <span class="hljs-type">const</span> ArmFeatures features = <span class="hljs-built_in">GetArmInfo</span>().features;</li><li>  <span class="hljs-comment">// 根据features的字段进行支持cpu features的特性判断</span></li><li>  <span class="hljs-keyword">if</span> (features.neon) {</li><li>    <span class="hljs-comment">// Run optimized code.</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// call normal function writed in c</span></li><li>  }</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li>}</li></ol></pre></div></div>  </li><li><p>在CMakeLists.txt文件中添加对应选项。</p>  <div _ngcontent-vdd-c106="" class="highlight-div"><div _ngcontent-vdd-c106="" class="highlight-div-header"><div _ngcontent-vdd-c106="" class="highlight-div-header-left"><div _ngcontent-vdd-c106="" class="handle-button expand-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdd-c106="" class="highlight-div-header-right"><div _ngcontent-vdd-c106="" class="handle-button ai-button"></div><div _ngcontent-vdd-c106="" class="handle-button line-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdd-c106="" class="handle-button theme-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdd-c106="" class="handle-button copy-button"><div _ngcontent-vdd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdd-c106="" class="highlight-scroll-div"><pre class="makefile prettyprint linenums hljs language-makefile" hw-language="makefile" data-highlighted="yes"><ol class="linenums"><li>if (${OHOS_ARCH} STREQUAL <span class="hljs-string">"armeabi-v7a"</span>)</li><li>    set(CMAKE_CXX_FLAGS <span class="hljs-string">"${CMAKE_CXX_FLAGS} -mfpu=neon -mfloat-abi=softfp"</span>)</li><li><span class="hljs-keyword">endif</span> ()</li></ol></pre></div></div>  </li></ol> <p>上述步骤完成后，开发者即可在工程中使用Neon intrinsics指令。</p> </div> </div> <div></div></div>