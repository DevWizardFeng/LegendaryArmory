<h1 _ngcontent-hur-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口产生的异常日志/崩溃分析"> 使用Node-API接口产生的异常日志/崩溃分析 </h1>

<div _ngcontent-hur-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>以下维测手段多数依赖于ArkTS运行时的多线程检测能力，因此建议在调试前启用此功能。启用方法参考文档<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-multi-thread-check" target="_blank">分析CppCrash（进程崩溃）</a>。</p> <p>若无特殊说明，本章节描述的维测手段会在启用ArkTS运行时多线程检测开关的情况下，立即中断进程。</p>  <div class="tiledSection"><h2 id="数据在使用时与创建该数据时所使用的env不一致">数据在使用时，与创建该数据时所使用的env不一致<i class="anchor-icon anchor-icon-link" anchorid="数据在使用时与创建该数据时所使用的env不一致" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="各问题场景的关键日志" class="firsth2">各问题场景的关键日志<i class="anchor-icon anchor-icon-link" anchorid="各问题场景的关键日志" tips="复制节点链接"></i></h3><p>该维测手段主要包含以下两种场景：</p> <ol><li><p>调用napi方法的入参napi_env与创建napi数据结构时所使用的napi_env不一致。</p>  <p><strong>关键日志</strong></p> <p>param env not equal to its owner.</p>  </li><li><p>调用napi方法的入参napi_env与创建napi数据结构时所使用的napi_env一致，但原始napi_env已释放。</p>  <p><strong>关键日志</strong></p>  <ol><li><p>除线程安全函数相关方法外，关键日志如下：</p>  <p>owner env has been destroyed, owner id: &lt;owner id&gt; , current env id: &lt;current id&gt;.</p>  </li><li><p>线程安全函数相关方法，关键日志如下：</p>  <p>current tsfn was created by dead env, owner id: &lt;owner id&gt;, current env id: &lt;current id&gt;</p>  </li></ol>  </li></ol> <p>该维测手段当前的覆盖范围如下：</p> <ol><li>napi_get_reference_value</li><li>napi_delete_reference*</li><li>napi_queue_async_work</li><li>napi_queue_async_work_with_qos</li><li>napi_cancel_async_work</li><li>napi_call_threadsafe_function*</li><li>napi_release_threadsafe_function*</li></ol>  <p>具有*标志的接口，仅能触发第二种场景的维测信息，不含有*标志的接口，能触发以上两种场景的维测信息。</p>  </div>  <div class="tiledSection"><h3 id="案例及示例代码">案例及示例代码<i class="anchor-icon anchor-icon-link" anchorid="案例及示例代码" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>下面的代码仅用于构造异常场景，触发异常分支的DFX日志。在充分理解其意图前，请勿将其应用到业务场景中。</p>  </div></div></div> <p><strong>基础工具类</strong></p> <p>定义一个工具类，便于在后续构造两种异常场景。</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK(cond)                                                 \</span></li><li><span class="hljs-meta">    do {                                                            \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (cond) {                                                 \</span></li><li><span class="hljs-meta">            OH_LOG_FATAL(LOG_APP, <span class="hljs-string">"Failed to check `"</span> #cond <span class="hljs-string">"`"</span>);   \</span></li><li><span class="hljs-meta">            std::abort();                                           \</span></li><li><span class="hljs-meta">        }                                                           \</span></li><li><span class="hljs-meta">    } while(0)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_EQ(lhs, rhs) CHECK(lhs == rhs)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_NE(lhs, rhs) CHECK(lhs != rhs)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_NOT_NULL(val) CHECK(val != nullptr)</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> STRICT_NAPI_CALL(call)                                      \</span></li><li><span class="hljs-meta">    do {                                                            \</span></li><li><span class="hljs-meta">        napi_status ret = (call);                                   \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (ret != napi_ok) {                                       \</span></li><li><span class="hljs-meta">            OH_LOG_FATAL(LOG_APP, <span class="hljs-string">"Failed to execute `"</span> #call <span class="hljs-string">"`, "</span> \</span></li><li><span class="hljs-meta">                <span class="hljs-string">"return code is: %{public}d"</span>, ret);                 \</span></li><li><span class="hljs-meta">            std::abort();                                           \</span></li><li><span class="hljs-meta">        }                                                           \</span></li><li><span class="hljs-meta">    } while(0)</span></li><li>
</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CallbackInfo</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">CallbackInfo</span>(napi_env env, napi_callback_info info)</li><li>        : <span class="hljs-built_in">env_</span>(env)</li><li>    {</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc_, <span class="hljs-literal">nullptr</span>, &amp;thisVar_, &amp;data_);</li><li>        <span class="hljs-keyword">if</span> (argc_ &gt; <span class="hljs-number">0</span>) {</li><li>            argv_ = <span class="hljs-keyword">new</span> napi_value[argc_];</li><li>            <span class="hljs-built_in">CHECK_NOT_NULL</span>(argv_);</li><li>            <span class="hljs-built_in">memset</span>(argv_, <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">sizeof</span>(argv_));</li><li>            <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc_, argv_, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>        }</li><li>    }</li><li>    ~<span class="hljs-built_in">CallbackInfo</span>()</li><li>    {</li><li>        <span class="hljs-keyword">if</span> (argc_ &gt; <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">delete</span>[] argv_;</li><li>            argv_ = <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">GetArgc</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> argc_; }</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> napi_value* <span class="hljs-title">GetArgs</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> argv_; }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> napi_value <span class="hljs-title">GetArg</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index)</span> <span class="hljs-type">const</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">if</span> (index &gt;= argc_) {</li><li>            napi_value undefined = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-built_in">napi_get_undefined</span>(env_, &amp;undefined);</li><li>            <span class="hljs-keyword">return</span> undefined;</li><li>        }</li><li>        <span class="hljs-keyword">return</span> argv_[index];</li><li>    }</li><li>    <span class="hljs-keyword">inline</span> napi_value <span class="hljs-keyword">operator</span>[](<span class="hljs-type">size_t</span> index) <span class="hljs-type">const</span></li><li>    {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetArg</span>(index);</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    napi_env env_ { <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-type">size_t</span> argc_ { <span class="hljs-number">0</span> };</li><li>    napi_value* argv_ { <span class="hljs-literal">nullptr</span> };</li><li>    napi_value thisVar_ { <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-type">void</span>* data_ { <span class="hljs-literal">nullptr</span> };</li><li>};</li><li>
</li><li><span class="hljs-comment">// 构造相同（或不同）地址的napi_env，以便能触发不同的DFX信息</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">EngineProxy</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">EngineProxy</span>()</li><li>    {</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env_));</li><li>        <span class="hljs-comment">// 5: 使napi_env地址复用更容易</span></li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {</li><li>            <span class="hljs-built_in">RecreateOnce</span>();</li><li>        }</li><li>    }</li><li>
</li><li>    ~<span class="hljs-built_in">EngineProxy</span>()</li><li>    {</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_destroy_ark_runtime</span>(&amp;env_));</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">RecreateSame</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Recreate</span>(<span class="hljs-literal">true</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">RecreateDiff</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Recreate</span>(<span class="hljs-literal">false</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">napi_env</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> env_;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 重新创建napi_env，直到地址与原始env相同（或不同）</span></li><li>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Recreate</span><span class="hljs-params">(<span class="hljs-type">bool</span> requireSame)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* recreateTypeTag = requireSame ? <span class="hljs-string">"same"</span> : <span class="hljs-string">"different"</span>;</li><li>        napi_env old = env_;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_RETRY_TIMES; i++) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">RecreateOnce</span>(old) == requireSame) {</li><li>                <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Succeed to recreate env with %{public}s pointer "</span></li><li>                    <span class="hljs-string">"address after retried %{public}d times."</span>, recreateTypeTag, i);</li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>            }</li><li>        }</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Failed to recreate env with %{public}s pointer "</span></li><li>            <span class="hljs-string">"address after retried %{public}d times."</span>, recreateTypeTag, MAX_RETRY_TIMES);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-comment">// 重新创建napi_env，返回新地址是否与原地址相同</span></li><li>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RecreateOnce</span><span class="hljs-params">(napi_env old = <span class="hljs-literal">nullptr</span>)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_destroy_ark_runtime</span>(&amp;env_));</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env_));</li><li>        <span class="hljs-keyword">return</span> env_ == old;</li><li>    }</li><li>
</li><li>    napi_env env_ {<span class="hljs-literal">nullptr</span>};</li><li>    </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> MAX_RETRY_TIMES = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>;</li><li>};</li></ol></pre></div></div> <p><strong>napi_ref相关接口</strong></p> <p>napi_get_reference_value 和 napi_delete_reference 的示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXGetRef: (samePtr: boolean) =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXGetRef</span><span class="hljs-params">(napi_env env, napi_callback_info cbinfo)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">CallbackInfo <span class="hljs-title">info</span><span class="hljs-params">(env, cbinfo)</span></span>;</li><li>    <span class="hljs-type">bool</span> same = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_get_value_bool</span>(env, info[<span class="hljs-number">0</span>], &amp;same));</li><li>    std::<span class="hljs-built_in">thread</span>([](<span class="hljs-type">bool</span> same) {</li><li>        EngineProxy localEnv;</li><li>        napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_create_object</span>(localEnv, &amp;obj));</li><li>        napi_ref ref = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-comment">// napi_create_reference为js对象创建了强引用，需要使用napi_delete_reference主动销毁，否则会导致js对象无法被回收，造成内存泄漏</span></li><li>        <span class="hljs-built_in">napi_create_reference</span>(localEnv, obj, <span class="hljs-number">1</span>, &amp;ref);</li><li>        <span class="hljs-keyword">if</span> (!localEnv.<span class="hljs-built_in">Recreate</span>(same)) {</li><li>            <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-built_in">napi_delete_reference</span>(localEnv, ref);</li><li>            }</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_reference_value</span>(localEnv, ref, &amp;result);</li><li>        <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">napi_delete_reference</span>(localEnv, ref);</li><li>        }</li><li>    }, same).<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXDelRef: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXDelRef</span><span class="hljs-params">(napi_env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::<span class="hljs-built_in">thread</span>([]() {</li><li>        EngineProxy localEnv;</li><li>        napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">STRICT_NAPI_CALL</span>(<span class="hljs-built_in">napi_create_object</span>(localEnv, &amp;obj));</li><li>        napi_ref ref = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-comment">// 在使用完成后调用napi_delete_reference来释放引用，避免内存泄露</span></li><li>        <span class="hljs-built_in">napi_create_reference</span>(localEnv, obj, <span class="hljs-number">1</span>, &amp;ref);</li><li>        <span class="hljs-keyword">if</span> (!localEnv.<span class="hljs-built_in">RecreateSame</span>()) {</li><li>            <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-built_in">napi_delete_reference</span>(localEnv, ref);</li><li>            }</li><li>            <span class="hljs-keyword">return</span>;</li><li>        };</li><li>        <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">napi_delete_reference</span>(localEnv, ref);</li><li>        }</li><li>    }).<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>napi_async_work相关接口</strong></p> <p>napi_queue_async_work、napi_queue_async_work_with_qos 和 napi_cancel_async_work 的示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 宏 EXPAND_ASYNC_WORK_CASE 将为 op 提供如下变量</span></li><li><span class="hljs-comment"> * @variable napi_env localEnv</span></li><li><span class="hljs-comment"> * @variable napi_async_work work</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXPAND_ASYNC_WORK_CASE(name, op)                                           \</span></li><li><span class="hljs-meta">napi_value name(napi_env env, napi_callback_info cbinfo)                           \</span></li><li><span class="hljs-meta">{                                                                                  \</span></li><li><span class="hljs-meta">    CallbackInfo info(env, cbinfo);                                                \</span></li><li><span class="hljs-meta">    bool same = true;                                                              \</span></li><li><span class="hljs-meta">    STRICT_NAPI_CALL(napi_get_value_bool(env, info[0], &amp;same));                    \</span></li><li><span class="hljs-meta">    std::thread([](bool same) {                                                    \</span></li><li><span class="hljs-meta">        EngineProxy localEnv;                                                      \</span></li><li><span class="hljs-meta">        napi_async_work work = nullptr;                                            \</span></li><li><span class="hljs-meta">        {                                                                          \</span></li><li><span class="hljs-meta">            napi_value taskName = nullptr;                                         \</span></li><li><span class="hljs-meta">            napi_create_string_utf8(localEnv, #name, NAPI_AUTO_LENGTH, &amp;taskName); \</span></li><li><span class="hljs-meta">            <span class="hljs-comment">/* 不建议使用空的 execute 回调创建 napi_async_work */</span>                    \</span></li><li><span class="hljs-meta">            <span class="hljs-comment">/* 此处可能出现内存泄漏，仅为复现 dfx 维测 */</span>                            \</span></li><li><span class="hljs-meta">            napi_create_async_work(localEnv, nullptr, taskName,                    \</span></li><li><span class="hljs-meta">                [](napi_env, void*) {}, [](napi_env, napi_status, void* ) {},      \</span></li><li><span class="hljs-meta">                nullptr, &amp;work);                                                   \</span></li><li><span class="hljs-meta">            <span class="hljs-keyword">if</span> (!localEnv.Recreate(same)) {                                        \</span></li><li><span class="hljs-meta">                <span class="hljs-keyword">if</span> (work != nullptr) {                                             \</span></li><li><span class="hljs-meta">                    napi_delete_async_work(localEnv, work);                        \</span></li><li><span class="hljs-meta">                }                                                                  \</span></li><li><span class="hljs-meta">                return;                                                            \</span></li><li><span class="hljs-meta">            }                                                                      \</span></li><li><span class="hljs-meta">        }                                                                          \</span></li><li><span class="hljs-meta">        (op);                                                                      \</span></li><li><span class="hljs-meta">        <span class="hljs-keyword">if</span> (work != nullptr) {                                                     \</span></li><li><span class="hljs-meta">            napi_delete_async_work(localEnv, work);                                \</span></li><li><span class="hljs-meta">        }                                                                          \</span></li><li><span class="hljs-meta">    }, same).detach();                                                             \</span></li><li><span class="hljs-meta">    return nullptr;                                                                \</span></li><li><span class="hljs-meta">}</span></li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXQueueWork: (samePtr: boolean) =&gt; void;</span></li><li><span class="hljs-comment"> * const triggerDFXQueueWorkWithQos: (samePtr: boolean) =&gt; void;</span></li><li><span class="hljs-comment"> * const triggerDFXCancelWork: (samePtr: boolean) =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-built_in">EXPAND_ASYNC_WORK_CASE</span>(TriggerDFXQueueWork,</li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(localEnv, work))</li><li><span class="hljs-built_in">EXPAND_ASYNC_WORK_CASE</span>(TriggerDFXQueueWorkWithQos,</li><li>    <span class="hljs-built_in">napi_queue_async_work_with_qos</span>(localEnv, work, napi_qos_default))</li><li><span class="hljs-built_in">EXPAND_ASYNC_WORK_CASE</span>(TriggerDFXCancelWork,</li><li>    <span class="hljs-built_in">napi_cancel_async_work</span>(localEnv, work))</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> EXPAND_ASYNC_WORK_CASE</span></li></ol></pre></div></div> <p><strong>napi_threadsafe_function相关接口</strong></p> <p>napi_call_threadsafe_function 和 napi_release_threadsafe_function 的示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 宏 EXPAND_THREADSAFE_FUNCTION_CASE 将为 op 提供如下变量</span></li><li><span class="hljs-comment"> * @variable napi_env localEnv</span></li><li><span class="hljs-comment"> * @variable napi_threadsafe_function tsfn</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXPAND_THREADSAFE_FUNCTION_CASE(name, op)                                       \</span></li><li><span class="hljs-meta">    napi_value name(napi_env, napi_callback_info info) {                                \</span></li><li><span class="hljs-meta">        std::thread([]() {                                                              \</span></li><li><span class="hljs-meta">            EngineProxy localEnv;                                                       \</span></li><li><span class="hljs-meta">            napi_threadsafe_function tsfn = nullptr;                                    \</span></li><li><span class="hljs-meta">            {                                                                           \</span></li><li><span class="hljs-meta">                napi_value taskName = nullptr;                                          \</span></li><li><span class="hljs-meta">                napi_create_string_utf8(localEnv, <span class="hljs-string">"Test"</span>, NAPI_AUTO_LENGTH, &amp;taskName); \</span></li><li><span class="hljs-meta">                <span class="hljs-comment">// napi_create_threadsafe_function创建线程安全函数，任务执行完成后，      \</span></span></li><li><span class="hljs-meta">                // 需调用napi_release_threadsafe_function释放</span></li><li>                <span class="hljs-built_in">napi_create_threadsafe_function</span>(                                        \</li><li>                    localEnv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, taskName, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>,                \</li><li>                    [](napi_env, <span class="hljs-type">void</span> *, <span class="hljs-type">void</span> *) {}, <span class="hljs-literal">nullptr</span>,                           \</li><li>                    [](napi_env, napi_value, <span class="hljs-type">void</span> *, <span class="hljs-type">void</span> *) {}, &amp;tsfn);                \</li><li>                <span class="hljs-keyword">if</span> (status != napi_ok) {                                                \</li><li>                    <span class="hljs-built_in">OH_INFO_ERROR</span>(LOG_APP,<span class="hljs-string">"napi_create_threadsafe_function failed"</span>);    \</li><li>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;                                                     \</li><li>                }                                                                       \</li><li>                <span class="hljs-keyword">if</span> (!localEnv.<span class="hljs-built_in">RecreateSame</span>()) {                                         \</li><li>                    <span class="hljs-keyword">return</span>;                                                             \</li><li>                };                                                                      \</li><li>            }                                                                           \</li><li>            (op);                                                                       \</li><li>        }).<span class="hljs-built_in">detach</span>();                                                                    \</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;                                                                 \</li><li>    }</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXTsfnCall: () =&gt; void;</span></li><li><span class="hljs-comment"> * const triggerDFXTsfnRelease: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-built_in">EXPAND_THREADSAFE_FUNCTION_CASE</span>(TriggerDFXTsfnCall,</li><li>    <span class="hljs-built_in">napi_call_threadsafe_function</span>(tsfn, <span class="hljs-literal">nullptr</span>, napi_tsfn_nonblocking))</li><li><span class="hljs-built_in">EXPAND_THREADSAFE_FUNCTION_CASE</span>(TriggerDFXTsfnRelease,</li><li>    <span class="hljs-built_in">napi_release_threadsafe_function</span>(tsfn, napi_tsfn_release))</li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> EXPAND_THREADSAFE_FUNCTION_CASE</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="跨线程调用">跨线程调用<i class="anchor-icon anchor-icon-link" anchorid="跨线程调用" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="覆盖范围及关键日志" class="firsth2">覆盖范围及关键日志<i class="anchor-icon anchor-icon-link" anchorid="覆盖范围及关键日志" tips="复制节点链接"></i></h3><p>大多数napi接口都不是多线程安全的，因此为这些错误用法额外增加了定位手段。</p> <p>若无特殊说明，本章节描述的维测手段会在启用ArkTS运行时多线程检测开关后，立即中断进程。</p>  <p><strong>关键日志</strong></p>  <p>current napi interface cannot run in multi-thread, thread id: &lt;env tid&gt;, current thread id: &lt;current tid&gt;</p>  <p>该维测手段覆盖范围如下：</p> <ol><li>napi_add_env_cleanup_hook*</li><li>napi_remove_env_cleanup_hook*</li><li>napi_add_async_cleanup_hook</li><li>napi_set_instance_data</li><li>napi_get_instance_data</li></ol>  <p>*：具有该标志的接口，在维测触发的情况下，仅打印带有调用栈信息的ERROR日志，并不会中断进程。</p>  </div>  <div class="tiledSection"><h3 id="案例及示例代码-1">案例及示例代码<i class="anchor-icon anchor-icon-link" anchorid="案例及示例代码-1" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>下面的代码仅用于构造异常场景，触发异常分支的DFX日志。在充分理解其意图前，请勿将其应用到业务场景中。</p>  </div></div></div> <p><strong>env_cleanup_hook相关接口</strong></p> <p>napi_add_env_cleanup_hook 和 napi_remove_env_cleanup_hook 的示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">EnvCLeanUpCallback</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>{</li><li>    <span class="hljs-type">char</span>* data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(arg);</li><li>    <span class="hljs-keyword">delete</span> data;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXClnAddXT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXClnAddXT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* data = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>;</li><li>    <span class="hljs-built_in">CHECK_NOT_NULL</span>(data);</li><li>    *data = <span class="hljs-literal">nullptr</span>;</li><li>    std::<span class="hljs-built_in">thread</span>([](napi_env env, <span class="hljs-type">char</span>* data) {</li><li>        <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    }, env, data).<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-keyword">delete</span> data;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXClnAddMT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXClnAddMT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* data = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>;</li><li>    <span class="hljs-built_in">CHECK_NOT_NULL</span>(data);</li><li>    *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-keyword">delete</span> data;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXClnRmXT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXClnRmXT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* data = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>;</li><li>    <span class="hljs-built_in">CHECK_NOT_NULL</span>(data);</li><li>    *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    std::<span class="hljs-built_in">thread</span>([](napi_env env, <span class="hljs-type">char</span>* data) {</li><li>        <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>        <span class="hljs-keyword">delete</span> data;</li><li>    }, env, data).<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXClnRmMT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXClnRmMT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* data = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>;</li><li>    <span class="hljs-built_in">CHECK_NOT_NULL</span>(data);</li><li>    *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-comment">// 解注册使用的参数与注册时的一致性，比重复解注册更值得关注</span></li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, EnvCLeanUpCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(data));</li><li>    <span class="hljs-keyword">delete</span> data;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>async_cleanup_hook相关接口</strong></p> <p>napi_add_async_cleanup_hook示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AsyncCleanupCallback</span><span class="hljs-params">(napi_async_cleanup_hook_handle handle, <span class="hljs-type">void</span> *)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_remove_async_cleanup_hook</span>(handle);</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXAsyncAddXT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXAsyncAddXT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::<span class="hljs-built_in">thread</span>([](napi_env env) {</li><li>        <span class="hljs-built_in">napi_add_async_cleanup_hook</span>(env, AsyncCleanupCallback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    }, env).<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>instance_data相关接口</strong></p> <p>napi_set_instance_data、napi_get_instance_data示例代码</p> <div _ngcontent-hur-c106="" class="highlight-div"><div _ngcontent-hur-c106="" class="highlight-div-header"><div _ngcontent-hur-c106="" class="highlight-div-header-left"><div _ngcontent-hur-c106="" class="handle-button expand-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hur-c106="" class="highlight-div-header-right"><div _ngcontent-hur-c106="" class="handle-button ai-button"></div><div _ngcontent-hur-c106="" class="handle-button line-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hur-c106="" class="handle-button theme-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hur-c106="" class="handle-button copy-button"><div _ngcontent-hur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hur-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXInsSetXT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXInsSetXT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::<span class="hljs-built_in">thread</span>([](napi_env env) {</li><li>        <span class="hljs-built_in">napi_set_instance_data</span>(env, <span class="hljs-literal">nullptr</span>, [](napi_env, <span class="hljs-type">void</span> *, <span class="hljs-type">void</span> *) {}, <span class="hljs-literal">nullptr</span>);</li><li>    }, env).<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 接口声明 index.d.ts</span></li><li><span class="hljs-comment"> * const triggerDFXInsGetXT: () =&gt; void;</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">TriggerDFXInsGetXT</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::<span class="hljs-built_in">thread</span>([](napi_env env) {</li><li>        <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_instance_data</span>(env, &amp;data);</li><li>    }, env).<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>