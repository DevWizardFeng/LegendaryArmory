<h1 _ngcontent-asa-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口从异步线程向ArkTS线程投递指定优先级和入队方式的的任务"> 使用Node-API接口从异步线程向ArkTS线程投递指定优先级和入队方式的的任务 </h1>

<div _ngcontent-asa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Node-API中的napi_call_threadsafe_function_with_priority接口的功能是从异步线程向ArkTS线程投递指定优先级和入队方式的任务，底层队列会根据任务的优先级和入队方式来处理任务。</p>  <div class="tiledSection"><h2 id="函数说明">函数说明<i class="anchor-icon anchor-icon-link" anchorid="函数说明" tips="复制节点链接"></i></h2><div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">napi_status <span class="hljs-title">napi_call_threadsafe_function_with_priority</span><span class="hljs-params">(napi_threadsafe_function func, <span class="hljs-type">void</span> *data,</span></span></li><li><span class="hljs-function">                                                        napi_task_priority priority, <span class="hljs-type">bool</span> isTail)</span>;</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">参数</th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">func</td> <td class="cellrowborder" valign="top" width="50%">线程安全方法</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">data</td> <td class="cellrowborder" valign="top" width="50%">异步线程期望传递给主线程的数据</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">priority</td> <td class="cellrowborder" valign="top" width="50%">指定任务的优先级<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-data-types-interfaces#线程安全任务优先级">napi_task_priority</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">isTail</td> <td class="cellrowborder" valign="top" width="50%">指定任务的入队方式，true代表任务从队列的尾部入队，false代表任务从队列的头部入队</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>异步线程向ArkTS主线程中投递的任务需要根据任务指定的优先级和入队方式进行处理。</p> </div>  <div class="tiledSection"><h2 id="调用异步的arkts接口示例">调用异步的ArkTS接口示例<i class="anchor-icon anchor-icon-link" anchorid="调用异步的arkts接口示例" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="示例代码" class="firsth2">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h3><ul><li><p>功能实现</p>    <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_2 = <span class="hljs-number">2</span>; <span class="hljs-comment">// 入参索引</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_12 = <span class="hljs-number">12</span>; <span class="hljs-comment">// 入参索引</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_15 = <span class="hljs-number">15</span>; <span class="hljs-comment">// 入参索引</span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CallbackData</span> {</li><li>    napi_threadsafe_function tsfn;</li><li>    napi_async_work work;</li><li>};</li><li><span class="hljs-comment">// ArkTS线程的回调实现</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">CallJs</span><span class="hljs-params">(napi_env env, napi_value jsCb, <span class="hljs-type">void</span> *context, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (env == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    napi_value resultNumber = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value undefined = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_undefined</span>(env, &amp;undefined);</li><li>    napi_value number1 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, INT_ARG_12, &amp;number1);</li><li>    napi_value number2 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, INT_ARG_15, &amp;number2);</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {number1, number2};</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, undefined, jsCb, INT_ARG_2, argv, &amp;resultNumber);</li><li>    <span class="hljs-type">int32_t</span> res = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, resultNumber, &amp;res);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 异步线程中调用该接口向ArkTS线程投递指定优先级和入队方式的任务</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ExecuteWork</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    CallbackData *callbackData = <span class="hljs-built_in">reinterpret_cast</span>&lt;CallbackData *&gt;(data);</li><li>    <span class="hljs-comment">// 执行任务为napi_priority_idle优先级，入队方式为队列尾部入队</span></li><li>    <span class="hljs-built_in">napi_call_threadsafe_function_with_priority</span>(callbackData-&gt;tsfn, <span class="hljs-literal">nullptr</span>, napi_priority_idle, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-built_in">napi_call_threadsafe_function_with_priority</span>(callbackData-&gt;tsfn, <span class="hljs-literal">nullptr</span>, napi_priority_low, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-built_in">napi_call_threadsafe_function_with_priority</span>(callbackData-&gt;tsfn, <span class="hljs-literal">nullptr</span>, napi_priority_high, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-built_in">napi_call_threadsafe_function_with_priority</span>(callbackData-&gt;tsfn, <span class="hljs-literal">nullptr</span>, napi_priority_immediate, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-comment">// 执行任务为napi_priority_high优先级，入队方式为队列头部入队</span></li><li>    <span class="hljs-built_in">napi_call_threadsafe_function_with_priority</span>(callbackData-&gt;tsfn, <span class="hljs-literal">nullptr</span>, napi_priority_high, <span class="hljs-literal">false</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">WorkComplete</span><span class="hljs-params">(napi_env env, napi_status status, <span class="hljs-type">void</span> *data)</span></span></li><li><span class="hljs-function"></span>{</li><li>    CallbackData *callbackData = <span class="hljs-built_in">reinterpret_cast</span>&lt;CallbackData *&gt;(data);</li><li>    <span class="hljs-built_in">napi_release_threadsafe_function</span>(callbackData-&gt;tsfn, napi_tsfn_release);</li><li>    <span class="hljs-built_in">napi_delete_async_work</span>(env, callbackData-&gt;work);</li><li>    callbackData-&gt;work = <span class="hljs-literal">nullptr</span>;</li><li>    callbackData-&gt;tsfn = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CallThreadSafeWithPriority</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    CallbackData *callbackData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CallbackData</span>();</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value jsCb = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;jsCb, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value resourceName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"Thread-safe Function Demo"</span>, NAPI_AUTO_LENGTH, &amp;resourceName);</li><li>    <span class="hljs-built_in">napi_create_threadsafe_function</span>(env, jsCb, <span class="hljs-literal">nullptr</span>, resourceName, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, callbackData, <span class="hljs-literal">nullptr</span>, callbackData, CallJs,</li><li>                                    &amp;callbackData-&gt;tsfn);</li><li>    <span class="hljs-built_in">napi_create_async_work</span>(env, <span class="hljs-literal">nullptr</span>, resourceName, ExecuteWork, WorkComplete, callbackData, &amp;callbackData-&gt;work);</li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, callbackData-&gt;work);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>  </li><li><p>模块注册</p>  <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册模块接口</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"callThreadSafeWithPriority"</span>, <span class="hljs-literal">nullptr</span>, CallThreadSafeWithPriority, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module nativeModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = <span class="hljs-literal">nullptr</span>,</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;nativeModule);</li><li>}</li></ol></pre></div></div>  </li><li><p>接口声明</p>    <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">callThreadSafeWithPriority</span>: <span class="hljs-function">(<span class="hljs-params">cb: (a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>  </li><li><p>编译配置</p>  <p>CMakeLists.txt文件需要按照如下配置</p>  <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li>cmake_minimum_required(VERSION 3.5.0)</li><li>project(MyApplication3)</li><li>
</li><li>set(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>if(DEFINED PACKAGE_FIND_FILE)</li><li>    include(${PACKAGE_FIND_FILE})</li><li>endif()</li><li>add_definitions( "-DLOG_TAG=\"LOG_TAG\"" )</li><li>include_directories(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li>add_library(entry SHARED napi_init.cpp)</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div>  </li><li><p>ArkTS导入头文件</p>  <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li></ol></pre></div></div>  </li><li><p>ArkTS代码示例</p>    <div _ngcontent-asa-c106="" class="highlight-div"><div _ngcontent-asa-c106="" class="highlight-div-header"><div _ngcontent-asa-c106="" class="highlight-div-header-left"><div _ngcontent-asa-c106="" class="handle-button expand-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-asa-c106="" class="highlight-div-header-right"><div _ngcontent-asa-c106="" class="handle-button ai-button"></div><div _ngcontent-asa-c106="" class="handle-button line-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-asa-c106="" class="handle-button theme-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-asa-c106="" class="handle-button copy-button"><div _ngcontent-asa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-asa-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">let</span> callback = (<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'result is '</span> + (a + b))</li><li>  <span class="hljs-keyword">return</span> a + b;</li><li>}</li><li>testNapi.<span class="hljs-title function_">callThreadSafeWithPriority</span>(callback);</li></ol></pre></div></div>  </li></ul> </div> </div> <div></div></div>