<h1 _ngcontent-hvd-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口关联数据，使其生命周期与当前环境的生命周期相关联"> 使用Node-API接口关联数据，使其生命周期与当前环境的生命周期相关联 </h1>

<div _ngcontent-hvd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>在Node-API模块中，可以使用Node-API接口将特定数据与当前环境相关联，并在需要时检索该数据。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>在Node-API中，关联数据指的是将自定义的C++数据结构与当前环境的生命周期绑定，这意味着只要当前运行环境存在，关联数据就会保持有效。</p> </div>  <div class="tiledSection"><h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2><p>以下接口可在Node-API模块中更方便地管理对象实例所需的状态信息、引用计数或其他自定义数据，它们的使用场景如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_set_instance_data</td> <td class="cellrowborder" valign="top" width="50%">绑定与当前运行的环境相关联的数据项。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_instance_data</td> <td class="cellrowborder" valign="top" width="50%">检索与当前运行的环境相关联的数据项。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="napi_set_instance_data" class="firsth2">napi_set_instance_data<i class="anchor-icon anchor-icon-link" anchorid="napi_set_instance_data" tips="复制节点链接"></i></h3><p>将需要绑定的数据与当前运行的环境相关联。</p> <p>cpp部分代码</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 定义一个结构来存储实例数据</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">InstanceData</span> {</li><li>    <span class="hljs-type">int32_t</span> value;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 对象被释放时的回调函数，用于清理实例数据</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FinalizeCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *finalize_data, <span class="hljs-type">void</span> *finalize_hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (finalize_data) {</li><li>        InstanceData *data = <span class="hljs-built_in">reinterpret_cast</span>&lt;InstanceData *&gt;(finalize_data);</li><li>        <span class="hljs-comment">// 释放内存，清除指针指向地址</span></li><li>        <span class="hljs-built_in">delete</span> (data);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetInstanceData</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">int32_t</span> instanceDataValue;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, argv[<span class="hljs-number">0</span>], &amp;instanceDataValue);</li><li>    InstanceData *instanceData = <span class="hljs-keyword">new</span> InstanceData;</li><li>    instanceData-&gt;value = instanceDataValue;</li><li>    <span class="hljs-comment">// 调用napi_set_instance_data将实例数据关联到Node-API环境，并指定FinalizeCallback函数</span></li><li>    napi_status status = <span class="hljs-built_in">napi_set_instance_data</span>(env, instanceData, FinalizeCallback, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> success = <span class="hljs-literal">true</span>;</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (status == napi_ok) {</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, success, &amp;result);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">setInstanceData</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> data = <span class="hljs-number">5</span>;</li><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">setInstanceData</span>(data);</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_set_instance_data:%{public}s'</span>, value);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_get_instance_data">napi_get_instance_data<i class="anchor-icon anchor-icon-link" anchorid="napi_get_instance_data" tips="复制节点链接"></i></h3><p>检索与当前运行的环境相关联的数据项。</p> <p>cpp部分代码</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetInstanceData</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    InstanceData *resData = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// napi_get_instance_data获取之前想关联的数据项</span></li><li>    napi_status status = <span class="hljs-built_in">napi_get_instance_data</span>(env, (<span class="hljs-type">void</span> **)&amp;resData);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value result;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, resData-&gt;value, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getInstanceData</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> data = <span class="hljs-number">5</span>;</li><li>testNapi.<span class="hljs-title function_">setInstanceData</span>(data);</li><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">getInstanceData</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_set_instance_data:%{public}d'</span>, value);</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-hvd-c106="" class="highlight-div"><div _ngcontent-hvd-c106="" class="highlight-div-header"><div _ngcontent-hvd-c106="" class="highlight-div-header-left"><div _ngcontent-hvd-c106="" class="handle-button expand-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hvd-c106="" class="highlight-div-header-right"><div _ngcontent-hvd-c106="" class="handle-button ai-button"></div><div _ngcontent-hvd-c106="" class="handle-button line-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hvd-c106="" class="handle-button theme-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hvd-c106="" class="handle-button copy-button"><div _ngcontent-hvd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hvd-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> </div> <div></div></div>