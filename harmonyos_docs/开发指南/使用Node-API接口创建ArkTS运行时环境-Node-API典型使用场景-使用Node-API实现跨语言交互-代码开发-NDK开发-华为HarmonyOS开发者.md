<h1 _ngcontent-jlc-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口创建ArkTS运行时环境"> 使用Node-API接口创建ArkTS运行时环境 </h1>

<div _ngcontent-jlc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>开发者通过pthread_create创建新线程后，可以通过napi_create_ark_runtime来创建一个新的ArkTS基础运行时环境，并通过该运行时环境加载ArkTS模块。当使用结束后，开发者需要通过napi_destroy_ark_runtime来销毁所创建的ArkTS基础运行时环境。</p> </div>  <div class="tiledSection"><h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2><p>一个进程最多只能创建64个运行时环境。</p> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><ol><li><p>接口声明、编译配置以及模块注册。</p>  <p><strong>接口声明</strong></p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createArkRuntime</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">object</span>;</li></ol></pre></div></div>    <p><strong>编译配置</strong></p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li># the minimum version of CMake.</li><li>cmake_minimum_required(VERSION 3.4.1)</li><li>project(MyApplication)</li><li>
</li><li>set(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>include_directories(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>add_library(entry SHARED create_ark_runtime.cpp)</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div>  <p>在当前模块的build-profile.json5文件中进行以下配置：</p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"./src/main/ets/pages/ObjectUtils.ets"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>    <p><strong>模块注册</strong></p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// create_ark_runtime.cpp</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"createArkRuntime"</span>, <span class="hljs-literal">nullptr</span>, CreateArkRuntime, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module nativeModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = <span class="hljs-literal">nullptr</span>,</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterQueueWorkModule</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;nativeModule);</li><li>}</li></ol></pre></div></div>   </li><li><p>新建线程并创建ArkTS基础运行时环境，加载自定义模块请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-load-module-with-info">napi_load_module_with_info</a>。</p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// create_ark_runtime.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">CreateArkRuntimeFunc</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 1. 创建基础运行环境</span></li><li>    napi_env env;</li><li>    napi_status ret = <span class="hljs-built_in">napi_create_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2. 加载自定义模块</span></li><li>    napi_value objUtils;</li><li>    ret = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"entry/src/main/ets/pages/ObjectUtils"</span>, <span class="hljs-string">"com.example.myapplication/entry"</span>, &amp;objUtils);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 3. 使用ArkTS中的logger</span></li><li>    napi_value logger;</li><li>    ret = <span class="hljs-built_in">napi_get_named_property</span>(env, objUtils, <span class="hljs-string">"Logger"</span>, &amp;logger);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    ret = <span class="hljs-built_in">napi_call_function</span>(env, objUtils, logger, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 4. 销毁ArkTS环境</span></li><li>    ret = <span class="hljs-built_in">napi_destroy_ark_runtime</span>(&amp;env);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateArkRuntime</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">pthread_t</span> tid;</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;tid, <span class="hljs-literal">nullptr</span>, CreateArkRuntimeFunc, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">pthread_join</span>(tid, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>   </li><li><p>编写ArkTS侧示例代码。</p>  <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ObjectUtils.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Logger</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"print log"</span>);</li><li>}</li></ol></pre></div></div>   <div _ngcontent-jlc-c106="" class="highlight-div"><div _ngcontent-jlc-c106="" class="highlight-div-header"><div _ngcontent-jlc-c106="" class="highlight-div-header-left"><div _ngcontent-jlc-c106="" class="handle-button expand-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jlc-c106="" class="highlight-div-header-right"><div _ngcontent-jlc-c106="" class="handle-button ai-button"></div><div _ngcontent-jlc-c106="" class="handle-button line-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jlc-c106="" class="handle-button theme-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jlc-c106="" class="handle-button copy-button"><div _ngcontent-jlc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jlc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkTS侧调用接口</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">createArkRuntime</span>();</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>