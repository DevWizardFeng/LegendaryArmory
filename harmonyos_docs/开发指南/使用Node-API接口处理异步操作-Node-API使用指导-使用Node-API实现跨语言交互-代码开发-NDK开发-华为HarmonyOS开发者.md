<h1 _ngcontent-fvf-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口处理异步操作"> 使用Node-API接口处理异步操作 </h1>

<div _ngcontent-fvf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用Node-API接口处理异步操作。异步操作是指需要一定时间才能完成的操作，例如从网络下载数据或读取大型文件。与同步操作不同，异步操作不会阻塞主线程，而是会在后台执行。将异步操作完成后的事件放入任务队列，等待主线程空闲时执行。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>Promise是ArkTS中用来处理异步操作的对象，Promise有pending（待定）、fulfilled（已兑现）和rejected（已拒绝）三种状态，Promise的初始状态是pending。resolve函数可以使其状态从pending变为fulfilled（已兑现），reject函数可以使其状态从pending变为rejected（已拒绝），一旦状态变为已兑现或已拒绝，将不能再更改。以下是一些基本概念：</p> <ul><li><strong>同步</strong>：同步是指代码按顺序执行，一行代码执行完后继续执行下一行。如果某个操作耗时较长，整个程序会被阻塞。</li><li><strong>异步</strong>：异步是指任务可以同时执行，不需要等待上一个任务结束。常见的异步操作有定时器、事件监听和网络请求等。异步任务不会阻塞后续任务的执行，而是通过回调函数或Promise对象来处理任务的结果。</li><li><strong>Promise</strong>：Promise是一个ArkTS对象，用于处理异步操作。通过then、catch和finally方法添加自定义逻辑。</li><li><strong>deferred</strong>：deferred是延迟对象，与Promise关联，设置Promise的回调函数resolve和reject。维护异步模型状态。</li><li><strong>resolve</strong>：此函数可以将Promise的状态从pending（待定）改为fulfilled（已兑现），向resolve中传入的参数可以在Promise对象的then方法中获取。</li><li><strong>reject</strong>：此函数可以将Promise的状态从pending（待定）改为rejected（已拒绝），向reject中传入的参数可以在Promise对象的catch方法中获取。</li></ul> <p>这些基本概念非常重要，开发者需要通过适当的方法来处理异步操作，使用Promise链式调用多个异步操作，使代码清晰整洁，便于维护。Node-API提供的方法可以帮助开发者在C/C++应用中处理ArkTS中的异步操作。</p> </div>  <div class="tiledSection"><h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2><p>以下Node-API接口主要用于与ArkTS Promise对象进行交互。它们的使用场景如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_is_promise</td> <td class="cellrowborder" valign="top" width="50%">检查一个napi_value是否代表一个Promise对象时，可以使用这个函数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_promise</td> <td class="cellrowborder" valign="top" width="50%">需要创建一个Promise对象时，可以使用这个函数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_resolve_deferred</td> <td class="cellrowborder" valign="top" width="50%">当你需要对promise关联的deferred对象进行resolve，将其从挂起状态转换为已兑现状态时，可以使用这个函数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_reject_deferred</td> <td class="cellrowborder" valign="top" width="50%">当你需要对promise关联的deferred对象进行reject，将其从挂起状态转换为已拒绝状态时，可以使用这个函数。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="napi_is_promise" class="firsth2">napi_is_promise<i class="anchor-icon anchor-icon-link" anchorid="napi_is_promise" tips="复制节点链接"></i></h3><p>判断给定的napi_value是否表示一个Promise对象。</p> <p>cpp部分代码</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsPromise</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_status status;</li><li>    <span class="hljs-comment">// 获取传入的参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> isPromise = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// 检查给定的入参是否为Promise对象，将结果保存在isPromise变量中</span></li><li>    status = <span class="hljs-built_in">napi_is_promise</span>(env, argv[<span class="hljs-number">0</span>], &amp;isPromise);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API napi_is_promise failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 将isPromise的值转换为napi_value中的类型返回</span></li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, isPromise, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isPromise</span>: &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> value = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</li><li><span class="hljs-comment">// 传入的对象为Promise时，返回true，否则返回false</span></li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'napi_is_promise %{public}s'</span>, testNapi.<span class="hljs-title function_">isPromise</span>(value));</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'napi_is_promise string %{public}s'</span>, testNapi.<span class="hljs-title function_">isPromise</span>(<span class="hljs-string">''</span>));</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_create_promise">napi_create_promise<i class="anchor-icon anchor-icon-link" anchorid="napi_create_promise" tips="复制节点链接"></i></h3><p>napi_create_promise用于创建一个Promise对象。</p> <p>使用该接口时应注意：</p> <ol><li>未处理异常时调用napi_create_promise会返回napi_pending_exception。</li><li>使用napi_create_promise后未判断返回值是否为napi_ok，之后使用了无效的deferred和promise会导致应用崩溃。</li></ol> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">napi_value <span class="hljs-title">NapiPromiseDemo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value promise = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status status = napi_ok;</li><li>
</li><li>    <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-string">"500"</span>, <span class="hljs-string">"common error"</span>);</li><li>
</li><li>    status = <span class="hljs-built_in">napi_create_promise</span>(env, &amp;deferred, &amp;promise); <span class="hljs-comment">// 有异常返回napi_pending_exception，且deferred、promise都为nullptr</span></li><li>    <span class="hljs-keyword">if</span> (status == napi_ok) {</li><li>        <span class="hljs-comment">// do something</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_resolve_deferred--napi_reject_deferred">napi_resolve_deferred &amp; napi_reject_deferred<i class="anchor-icon anchor-icon-link" anchorid="napi_resolve_deferred--napi_reject_deferred" tips="复制节点链接"></i></h3><p>使用napi_resolve_deferred对Promise关联的deferred对象进行解析，从挂起状态转换为已兑现状态，或从挂起状态转换为已拒绝状态。</p> <p>为确保微任务正确执行，ArkTS运行时在使用Node-API方法兑现Promise时，会触发一次微任务执行。</p> <p>CPP部分代码</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_2 = <span class="hljs-number">2</span>; <span class="hljs-comment">// 入参索引</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreatePromise</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// deferred是一个延迟对象，作用是将函数延迟一定时间再执行</span></li><li>    napi_deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value promise = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用接口创建Promise对象</span></li><li>    napi_status status = <span class="hljs-built_in">napi_create_promise</span>(env, &amp;deferred, &amp;promise);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Create promise failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 调用napi_is_promise判断napi_create_promise接口创建的是不是Promise对象</span></li><li>    <span class="hljs-type">bool</span> isPromise = <span class="hljs-literal">false</span>;</li><li>    napi_value returnIsPromise = <span class="hljs-literal">nullptr</span>;</li><li>    status = <span class="hljs-built_in">napi_is_promise</span>(env, promise, &amp;isPromise);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"napi_is_promise failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 将布尔值转为可以返回的napi_value</span></li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, isPromise, &amp;returnIsPromise);</li><li>    <span class="hljs-keyword">return</span> returnIsPromise;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ResolveRejectDeferred</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获得并解析参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    napi_value args[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 第一个参数为向resolve传入的信息，第二个参数为向reject传入的信息，第三个参数为Promise的状态</span></li><li>    <span class="hljs-type">bool</span> promiseStatus;</li><li>    napi_status status = <span class="hljs-built_in">napi_get_value_bool</span>(env, args[INT_ARG_2], &amp;promiseStatus);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"napi_get_value_bool failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建Promise对象</span></li><li>    napi_deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value promise = <span class="hljs-literal">nullptr</span>;</li><li>    status = <span class="hljs-built_in">napi_create_promise</span>(env, &amp;deferred, &amp;promise);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Create promise failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 根据第三个参数设置resolve或reject</span></li><li>    <span class="hljs-keyword">if</span> (promiseStatus) {</li><li>        <span class="hljs-built_in">napi_resolve_deferred</span>(env, deferred, args[<span class="hljs-number">0</span>]);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">napi_reject_deferred</span>(env, deferred, args[<span class="hljs-number">1</span>]);</li><li>    }</li><li>    <span class="hljs-comment">// 返回设置了resolve或reject的Promise对象</span></li><li>    <span class="hljs-keyword">return</span> promise;</li><li>}</li></ol></pre></div></div> <p>接口声明示例</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createPromise</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">resolveRejectDeferred</span>: <span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">string</span>, reject: <span class="hljs-built_in">string</span>, status: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建promise如果创建成功返回true，创建失败返回false</span></li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'napi_create_promise %{public}s'</span>, testNapi.<span class="hljs-title function_">createPromise</span>());</li><li><span class="hljs-comment">// 调用resolveRejectDeferred函数设置resolve和reject的返回结果以及Promise状态</span></li><li><span class="hljs-comment">// Promise状态为true时设置resolve，返回结果在then函数中获得</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">promiseSuccess</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; = testNapi.<span class="hljs-title function_">resolveRejectDeferred</span>(<span class="hljs-string">'success'</span>, <span class="hljs-string">'fail'</span>, <span class="hljs-literal">true</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li>promiseSuccess.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'get_resolve_deferred resolve %{public}s'</span>, res)</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'get_resolve_deferred reject %{public}s'</span>, err)</li><li>})</li><li><span class="hljs-comment">// Promise状态为false时设置reject，返回结果在catch函数中获得</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">promiseFail</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; = testNapi.<span class="hljs-title function_">resolveRejectDeferred</span>(<span class="hljs-string">'success'</span>, <span class="hljs-string">'fail'</span>, <span class="hljs-literal">false</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li>promiseFail.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'get_resolve_deferred resolve %{public}s'</span>, res)</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Node-API'</span>, <span class="hljs-string">'get_resolve_deferred reject %{public}s'</span>, err)</li><li>})</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-fvf-c106="" class="highlight-div"><div _ngcontent-fvf-c106="" class="highlight-div-header"><div _ngcontent-fvf-c106="" class="highlight-div-header-left"><div _ngcontent-fvf-c106="" class="handle-button expand-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fvf-c106="" class="highlight-div-header-right"><div _ngcontent-fvf-c106="" class="handle-button ai-button"></div><div _ngcontent-fvf-c106="" class="handle-button line-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fvf-c106="" class="handle-button theme-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fvf-c106="" class="handle-button copy-button"><div _ngcontent-fvf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fvf-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> </div> <div></div></div>