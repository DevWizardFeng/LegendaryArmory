<h1 _ngcontent-xru-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口注册和使用环境清理钩子"> 使用Node-API接口注册和使用环境清理钩子 </h1>

<div _ngcontent-xru-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>使用Node-API接口在进程退出时处理未释放资源，在Node-API模块注册清理钩子，一旦当前环境退出，这些钩子就会运行，使所有资源都被正确释放。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p>Node-API提供了注册和取消注册清理钩子函数的功能，以下是相关概念：</p>     <ul>      <li><strong>资源管理</strong>：在ArkTS中，通常需要管理一些系统资源，比如内存、文件句柄、网络连接等。这些资源必须在Node-API模块的生命周期中正确地创建、使用和释放，以避免资源泄漏和程序崩溃。资源管理通常包括初始化资源、在合适的时候清理资源，以及在清理资源时执行必要的操作，比如关闭文件或断开网络连接。</li>      <li><strong>钩子函数（Hook）</strong>：钩子函数是一种在特定事件或时间点自动执行的回调函数。在Node-API模块的上下文中，清理钩子函数通常用于在环境或进程退出时执行资源清理任务。这是因为环境或进程退出时，操作系统可能不会立即回收所有资源，因此需要通过清理钩子函数来确保所有资源都被正确释放。</li>     </ul>     <p>以上这些基本概念是理解和使用Node-API接口注册环境清理钩子的基础，下面将介绍具体的接口和使用示例。</p>    </div>    <div class="tiledSection">     <h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2>          <p>以下Node-API接口用于注册和取消不同类型的清理钩子。他们的使用场景如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">napi_add_env_cleanup_hook</td>         <td class="cellrowborder" valign="top" width="50%">注册一个环境清理钩子函数，该函数将在Node-API环境退出时被调用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">napi_remove_env_cleanup_hook</td>         <td class="cellrowborder" valign="top" width="50%">取消之前注册的环境清理钩子函数，避免其在环境清理时执行。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">napi_add_async_cleanup_hook</td>         <td class="cellrowborder" valign="top" width="50%">注册一个异步清理钩子函数，该函数将在Node-API进程退出时异步执行。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">napi_remove_async_cleanup_hook</td>         <td class="cellrowborder" valign="top" width="50%">取消之前注册的异步清理钩子函数，确保在不需要时不会执行相关的清理工作。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2>          <p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p>    </div>    <div class="tiledSection">     <h3 id="napi_add_env_cleanup_hook" class="firsth2">napi_add_env_cleanup_hook<i class="anchor-icon anchor-icon-link" anchorid="napi_add_env_cleanup_hook" tips="复制节点链接"></i></h3>          <p>用于注册一个环境清理钩子函数，该函数将在环境退出时执行。这是确保资源在环境销毁前得到清理的重要机制。</p>     <p>需要注意的是，napi_add_env_cleanup_hook接口并不支持对同一arg绑定多个回调。若出现env已销毁，但cleanup回调未被执行的情况，可以在启用ArkTS运行时<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-multi-thread-check" target="_blank">多线程检测</a>功能的前提下，查看hilog流水日志AddCleanupHook Failed, data cannot register multiple times.来查找发生注册失败的调用。</p>    </div>    <div class="tiledSection">     <h3 id="napi_remove_env_cleanup_hook">napi_remove_env_cleanup_hook<i class="anchor-icon anchor-icon-link" anchorid="napi_remove_env_cleanup_hook" tips="复制节点链接"></i></h3>          <p>用于取消之前注册的环境清理钩子函数。在某些情况下，需要在插件卸载或资源被重新分配时取消钩子函数。</p>     <p>cpp部分代码</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-comment">// 定义内存结构，包含指向数据的指针和数据的大小</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>    <span class="hljs-type">char</span> *data;</li><li>    <span class="hljs-type">size_t</span> size;</li><li>} Memory;</li><li><span class="hljs-comment">// 外部缓冲区清理回调函数，用于释放分配的内存</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ExternalFinalize</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *finalize_data, <span class="hljs-type">void</span> *finalize_hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    Memory *wrapper = (Memory *)finalize_hint;</li><li>    <span class="hljs-built_in">free</span>(wrapper-&gt;data);</li><li>    <span class="hljs-built_in">free</span>(wrapper);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API napi_add_env_cleanup_hook ExternalFinalize"</span>);</li><li>}</li><li><span class="hljs-comment">// 在环境关闭时执行一些清理操作，如清理全局变量或其他需要在环境关闭时处理的资源</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">Cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 执行清理操作</span></li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API napi_add_env_cleanup_hook cleanuped: %{public}d"</span>, *(<span class="hljs-type">int</span> *)(arg));</li><li>}</li><li><span class="hljs-comment">// 创建外部缓冲区并注册环境清理钩子函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NapiEnvCleanUpHook</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 分配内存并复制字符串数据到内存中</span></li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(<span class="hljs-string">"Hello from Node-API!"</span>)</span></span>;</li><li>    Memory *wrapper = (Memory *)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Memory));</li><li>    <span class="hljs-keyword">if</span> (wrapper == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"malloc for wrapper failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    wrapper-&gt;data = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-built_in">malloc</span>(str.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>));</li><li>    <span class="hljs-keyword">if</span> (wrapper-&gt;data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">free</span>(wrapper);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"malloc for wrapper-&gt;data failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(wrapper-&gt;data, <span class="hljs-number">0</span>, str.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-built_in">strcpy</span>(wrapper-&gt;data, str.<span class="hljs-built_in">c_str</span>());</li><li>    wrapper-&gt;size = str.<span class="hljs-built_in">size</span>();</li><li>    <span class="hljs-comment">// 创建外部缓冲区对象，并指定清理回调函数</span></li><li>    <span class="hljs-comment">// 注意：wrapper-&gt;data 的内存释放依赖于 ExternalFinalize 回调，只有 buffer 被正确持有并最终被 GC 回收时，ExternalFinalize 才会被调用，否则会导致内存泄漏。</span></li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_create_external_buffer</span>(env, wrapper-&gt;size, (<span class="hljs-type">void</span> *)wrapper-&gt;data, ExternalFinalize, wrapper, &amp;buffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-comment">// 创建失败时需主动释放内存，避免泄漏</span></li><li>        <span class="hljs-built_in">free</span>(wrapper-&gt;data);</li><li>        <span class="hljs-built_in">free</span>(wrapper);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"napi_create_external_buffer failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 静态变量作为钩子函数参数</span></li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> hookArg = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> hookParameter = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-comment">// 注册环境清理钩子函数</span></li><li>    status = <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, Cleanup, &amp;hookArg);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Test Node-API napi_add_env_cleanup_hook failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 注册环境清理钩子函数，此处不移除环境清理钩子，为了在ArkTS环境被销毁时，这个钩子函数被调用，用来模拟执行一些清理操作，例如释放资源、关闭文件等。</span></li><li>    status = <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, Cleanup, &amp;hookParameter);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Test Node-API napi_add_env_cleanup_hook failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 立即移除环境清理钩子函数，确保不会在后续环境清理时被调用</span></li><li>    <span class="hljs-comment">// 通常，当为其添加此钩子的资源无论如何都被拆除时调用这个接口</span></li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, Cleanup, &amp;hookArg);</li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, Cleanup, &amp;hookParameter);</li><li>    <span class="hljs-comment">// 返回创建的外部缓冲区对象</span></li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>}</li></ol></pre></div></div>     <p>接口声明</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">napiEnvCleanUpHook</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div>     <p>ArkTS侧示例代码</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> wk = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">"entry/ets/workers/worker.ts"</span>);</li><li><span class="hljs-comment">// 发送消息到worker线程</span></li><li>wk.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">"test NapiEnvCleanUpHook"</span>);</li><li><span class="hljs-comment">// 处理来自worker线程的消息</span></li><li>wk.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API message from worker: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(message));</li><li>  wk.<span class="hljs-title function_">terminate</span>();</li><li>};</li></ol></pre></div></div>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// worker.ts</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> parent = worker.<span class="hljs-property">workerPort</span>;</li><li><span class="hljs-comment">// 处理来自主线程的消息</span></li><li>parent.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API message from main thread: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(message));</li><li>  <span class="hljs-comment">// 发送消息到主线程</span></li><li>  parent.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Test Node-API worker:'</span> + testNapi.<span class="hljs-title function_">napiEnvCleanUpHook</span>());</li><li>};</li></ol></pre></div></div>     <p>worker相关开发配置和流程参考以下链接：</p>     <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">使用Worker进行线程间通信</a></p>    </div>    <div class="tiledSection">     <h3 id="napi_add_async_cleanup_hook">napi_add_async_cleanup_hook<i class="anchor-icon anchor-icon-link" anchorid="napi_add_async_cleanup_hook" tips="复制节点链接"></i></h3>          <p>这个接口用于注册一个异步清理钩子函数，该函数将在环境退出时异步执行。与同步钩子不同，异步钩子允许在进程退出时进行更长时间的操作，而不会阻塞进程退出。</p>    </div>    <div class="tiledSection">     <h3 id="napi_remove_async_cleanup_hook">napi_remove_async_cleanup_hook<i class="anchor-icon anchor-icon-link" anchorid="napi_remove_async_cleanup_hook" tips="复制节点链接"></i></h3>          <p>这个接口用于取消之前注册的异步清理钩子函数。与取消同步钩子类似，这通常是在不再需要钩子函数时进行的操作。</p>     <p>cpp部分代码</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 包含异步操作内容</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>    napi_env env;</li><li>    <span class="hljs-type">void</span> *testData;</li><li>    uv_async_s asyncUv;</li><li>    napi_async_cleanup_hook_handle cleanupHandle;</li><li>} AsyncContent;</li><li><span class="hljs-comment">// 删除异步工作对象并注销钩子函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">FinalizeWork</span><span class="hljs-params">(uv_handle_s *handle)</span></span></li><li><span class="hljs-function"></span>{</li><li>    AsyncContent *asyncData = <span class="hljs-built_in">reinterpret_cast</span>&lt;AsyncContent *&gt;(handle-&gt;data);</li><li>    <span class="hljs-comment">// 不再需要异步清理钩子函数的情况下，尝试将其从环境中移除</span></li><li>    napi_status result = <span class="hljs-built_in">napi_remove_async_cleanup_hook</span>(asyncData-&gt;cleanupHandle);</li><li>    <span class="hljs-keyword">if</span> (result != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(asyncData-&gt;env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Test Node-API napi_remove_async_cleanup_hook failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 释放AsyncContent</span></li><li>    <span class="hljs-built_in">free</span>(asyncData);</li><li>}</li><li><span class="hljs-comment">// 异步执行环境清理工作</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AsyncWork</span><span class="hljs-params">(uv_async_s *async)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 执行一些清理工作,比如释放动态分配的内存</span></li><li>    AsyncContent *asyncData = <span class="hljs-built_in">reinterpret_cast</span>&lt;AsyncContent *&gt;(async-&gt;data);</li><li>    </li><li>    <span class="hljs-keyword">if</span> (asyncData != <span class="hljs-literal">nullptr</span> &amp;&amp; asyncData-&gt;testData != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">free</span>(asyncData-&gt;testData);</li><li>        asyncData-&gt;testData = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 关闭libuv句柄，并触发FinalizeWork回调清理</span></li><li>    <span class="hljs-built_in">uv_close</span>((uv_handle_s *)async, FinalizeWork);</li><li>}</li><li><span class="hljs-comment">// 异步清理钩子函数，创建异步工作对象并执行</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AsyncCleanup</span><span class="hljs-params">(napi_async_cleanup_hook_handle handle, <span class="hljs-type">void</span> *info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    AsyncContent *data = <span class="hljs-built_in">reinterpret_cast</span>&lt;AsyncContent *&gt;(info);</li><li>    <span class="hljs-comment">// 获取libUv循环实例并初始化一个异步句柄，以便后续执行异步工作</span></li><li>    uv_loop_s *uvLoop;</li><li>    <span class="hljs-built_in">napi_get_uv_event_loop</span>(data-&gt;env, &amp;uvLoop);</li><li>    <span class="hljs-built_in">uv_async_init</span>(uvLoop, &amp;data-&gt;asyncUv, AsyncWork);</li><li>
</li><li>    data-&gt;asyncUv.data = data;</li><li>    data-&gt;cleanupHandle = handle;</li><li>    <span class="hljs-comment">// 发送异步信号触发AsyncWork函数执行清理工作</span></li><li>    <span class="hljs-built_in">uv_async_send</span>(&amp;data-&gt;asyncUv);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NapiAsyncCleanUpHook</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 分配AsyncContent内存</span></li><li>    AsyncContent *data = <span class="hljs-built_in">reinterpret_cast</span>&lt;AsyncContent *&gt;(<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(AsyncContent)));</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Test Node-API malloc AsyncContent failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    data-&gt;env = env;</li><li>    data-&gt;cleanupHandle = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 分配内存并复制字符串数据</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *testDataStr = <span class="hljs-string">"TestNapiAsyncCleanUpHook"</span>;</li><li>    data-&gt;testData = <span class="hljs-built_in">strdup</span>(testDataStr);</li><li>    <span class="hljs-keyword">if</span> (data-&gt;testData == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Test Node-API data-&gt;testData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 添加异步清理钩子函数</span></li><li>    napi_status status = <span class="hljs-built_in">napi_add_async_cleanup_hook</span>(env, AsyncCleanup, data, &amp;data-&gt;cleanupHandle);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">free</span>(data-&gt;testData);</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Test Node-API napi_add_async_cleanup_hook failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>     <p>由于需要包含“uv.h”库，所以需要在CMakeLists文件中添加配置：</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libuv.so)</li></ol></pre></div></div>     <p>接口声明</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">napiAsyncCleanUpHook</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div>     <p>ArkTS侧示例代码</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_add_async_cleanup_hook: %{public}s'</span>, testNapi.<span class="hljs-title function_">napiAsyncCleanUpHook</span>());</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_add_async_cleanup_hook error.message: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p>     <div _ngcontent-xru-c106="" class="highlight-div"><div _ngcontent-xru-c106="" class="highlight-div-header"><div _ngcontent-xru-c106="" class="highlight-div-header-left"><div _ngcontent-xru-c106="" class="handle-button expand-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xru-c106="" class="highlight-div-header-right"><div _ngcontent-xru-c106="" class="handle-button ai-button"></div><div _ngcontent-xru-c106="" class="handle-button line-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xru-c106="" class="handle-button theme-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xru-c106="" class="handle-button copy-button"><div _ngcontent-xru-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xru-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div>    </div>   </div>   <div></div></div>