<h1 _ngcontent-btf-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口进行ArrayBuffer相关开发"> 使用Node-API接口进行ArrayBuffer相关开发 </h1>

<div _ngcontent-btf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>ArrayBuffer是ArkTS中的一种数据类型，用于表示通用的、固定长度的原始二进制数据缓冲区。它提供了一种在ArkTS中有效地表示和操作原始二进制数据的方式。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><ul><li><strong>ArrayBuffer</strong>：ArrayBuffer对象用来表示一个通用的、固定长度的原始二进制数据缓冲区。不能直接操作ArrayBuffer的内容，而是需要包装成TypedArray对象或DataView对象来读写。ArrayBuffer常用于处理大量的二进制数据，如文件、网络数据包等。</li></ul> </div>  <div class="tiledSection"><h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2><p>以下Node-API接口用于操作ArrayBuffer类型的数据。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_is_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">检查一个值是否为ArrayBuffer，以确保正在处理正确的数据类型。需要注意的是，此函数只能判断一个值是否为ArrayBuffer，而不能判断一个值是否为TypedArray。要判断一个值是否为TypedArray，可以使用napi_is_typedarray函数。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_arraybuffer_info</td> <td class="cellrowborder" valign="top" width="50%">获取给定的ArrayBuffer对象的相关信息，包括数据指针和数据长度。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_detach_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">将ArrayBuffer底层缓冲区与ArrayBuffer对象分离。分离后可以直接在C/C++中操作数据，而无需通过Node-API接口进行数据访问。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_is_detached_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">判断给定的ArrayBuffer是否已经被分离。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API模块中创建一个具有指定字节长度的ArkTS ArrayBuffer对象。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="napi_is_arraybuffer" class="firsth2">napi_is_arraybuffer<i class="anchor-icon anchor-icon-link" anchorid="napi_is_arraybuffer" tips="复制节点链接"></i></h3><p>判断给定ArkTS value是否为ArrayBuffer。</p> <p>cpp部分代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsArrayBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 接受一个入参</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 调用napi_is_arraybuffer接口判断给定入参是否为ArrayBuffer数据</span></li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_is_arraybuffer</span>(env, args[<span class="hljs-number">0</span>], &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API napi_is_arraybuffer fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 将结果转成napi_value类型返回</span></li><li>    napi_value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, result, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isArrayBuffer</span>: &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">arrayBuffer: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-string">"123"</span>;</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_arraybuffer: %{public}s'</span>, testNapi.<span class="hljs-title function_">isArrayBuffer</span>(value));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_arraybuffer: %{public}s'</span>, testNapi.<span class="hljs-title function_">isArrayBuffer</span>(data));</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_arraybuffer error: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div> <p>输出日志：</p> <p>Test Node-API napi_is_arraybuffer: true</p> <p>Test Node-API napi_is_arraybuffer: false</p> </div>  <div class="tiledSection"><h3 id="napi_get_arraybuffer_info">napi_get_arraybuffer_info<i class="anchor-icon anchor-icon-link" anchorid="napi_get_arraybuffer_info" tips="复制节点链接"></i></h3><p>获取ArrayBuffer的底层数据缓冲区和长度。接口只能处理ArrayBuffer类型，请勿将其他类型传入接口。若想从Uint8Array类型中取到ArrayBuffer，需要在ArkTS侧执行.buffer()操作。</p> <p>cpp部分代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetArrayBufferInfo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 检查参数是否为ArrayBuffer</span></li><li>    <span class="hljs-type">bool</span> isArrayBuffer = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_arraybuffer</span>(env, args[<span class="hljs-number">0</span>], &amp;isArrayBuffer);</li><li>    <span class="hljs-keyword">if</span> (!isArrayBuffer) {</li><li>        <span class="hljs-built_in">napi_throw_type_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Argument must be an ArrayBuffer"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> byteLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 获取ArrayBuffer的底层数据缓冲区和长度</span></li><li>    napi_status status = <span class="hljs-built_in">napi_get_arraybuffer_info</span>(env, args[<span class="hljs-number">0</span>], &amp;data, &amp;byteLength);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Failed to get ArrayBuffer info"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建结果对象</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;result);</li><li>    <span class="hljs-comment">// 创建数据缓冲区的字节长度属性</span></li><li>    napi_value byteLengthValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_uint32</span>(env, byteLength, &amp;byteLengthValue);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, result, <span class="hljs-string">"byteLength"</span>, byteLengthValue);</li><li>    napi_value bufferData = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">void</span> *newData = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_arraybuffer</span>(env, byteLength, &amp;newData, &amp;bufferData);</li><li>    <span class="hljs-built_in">memcpy</span>(newData, data, byteLength);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, result, <span class="hljs-string">"buffer"</span>, bufferData);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayBufferInfo</span> {</li><li>  <span class="hljs-attr">byteLength</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>;</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getArrayBufferInfo</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-title class_">ArrayBufferInfo</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> typedArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);</li><li>  <span class="hljs-keyword">let</span> buffer = typedArray.<span class="hljs-property">buffer</span>;</li><li>  <span class="hljs-keyword">let</span> result = testNapi.<span class="hljs-title function_">getArrayBufferInfo</span>(buffer) <span class="hljs-keyword">as</span> testNapi.<span class="hljs-property">ArrayBufferInfo</span>;</li><li>  <span class="hljs-keyword">let</span> resBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(result.<span class="hljs-property">buffer</span>);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API get_arrayBuffer_info byteLength: %{public}d buffer: %{public}s'</span>, result.<span class="hljs-property">byteLength</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(resBuffer));</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API get_arrayBuffer_info error: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div> <p>输出日志：</p> <p>Test Node-API get_arrayBuffer_info:{"byteLength":10,"buffer":{}}</p> </div>  <div class="tiledSection"><h3 id="napi_detach_arraybuffer">napi_detach_arraybuffer<i class="anchor-icon anchor-icon-link" anchorid="napi_detach_arraybuffer" tips="复制节点链接"></i></h3><p>分离给定ArrayBuffer的底层数据。</p> </div>  <div class="tiledSection"><h3 id="napi_is_detached_arraybuffer">napi_is_detached_arraybuffer<i class="anchor-icon anchor-icon-link" anchorid="napi_is_detached_arraybuffer" tips="复制节点链接"></i></h3><p>判断给定的ArrayBuffer是否已被分离。</p> <p>cpp部分代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DetachedArrayBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 调用napi_detach_arraybuffer接口分离给定ArrayBuffer的底层数据</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value arrayBuffer = args[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-built_in">napi_detach_arraybuffer</span>(env, arrayBuffer);</li><li>    <span class="hljs-comment">// 将分离后的arraybuffer传出去</span></li><li>    <span class="hljs-keyword">return</span> arrayBuffer;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsDetachedArrayBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 调用napi_is_detached_arraybuffer判断给定的arraybuffer是否已被分离</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value arrayBuffer = args[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_detached_arraybuffer</span>(env, arrayBuffer, &amp;result);</li><li>    <span class="hljs-comment">// 将返回值通过napi_get_boolean接口转成napi_value传出去做打印</span></li><li>    napi_value returnValue;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, result, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">detachedArrayBuffer</span>: <span class="hljs-function">(<span class="hljs-params">buffer:<span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-title class_">ArrayBuffer</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isDetachedArrayBuffer</span>: <span class="hljs-function">(<span class="hljs-params">arrayBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">const</span> bufferArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_detached_arraybuffer one: %{public}s'</span>, testNapi.<span class="hljs-title function_">isDetachedArrayBuffer</span>(bufferArray));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_detached_arraybuffer two: %{public}s '</span>, testNapi.<span class="hljs-title function_">isDetachedArrayBuffer</span>(testNapi.<span class="hljs-title function_">detachedArrayBuffer</span>(bufferArray)));</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_detached_arraybuffer error: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div> <p>输出日志：</p> <p>Test Node-API napi_is_detached_arraybuffer one: false</p> <p>Test Node-API napi_is_detached_arraybuffer two: true</p> </div>  <div class="tiledSection"><h3 id="napi_create_arraybuffer">napi_create_arraybuffer<i class="anchor-icon anchor-icon-link" anchorid="napi_create_arraybuffer" tips="复制节点链接"></i></h3><p>用于在C/C++中创建一个具有指定字节长度的ArkTS ArrayBuffer对象，如果调用者想要直接操作缓冲区，则可以选择将底层缓冲区返回给调用者。要从ArkTS写入此缓冲区，需要创建类型化数组或DataView对象。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>napi_create_arraybuffer在byte_length为0或超大值时，data返回值将为nullptr。因此在对data进行使用前，有必要对其进行判空。</p>  </div></div></div> <p>cpp部分代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateArrayBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 解析传递的参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">int32_t</span> value;</li><li>    <span class="hljs-type">size_t</span> length;</li><li>    <span class="hljs-comment">// 将ArkTS侧传递的参数转换为size_t类型，作为napi_create_arraybuffer的参数</span></li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, argv[<span class="hljs-number">0</span>], &amp;value);</li><li>    length = <span class="hljs-built_in">size_t</span>(value);</li><li>    <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 创建一个新的ArrayBuffer</span></li><li>    <span class="hljs-built_in">napi_create_arraybuffer</span>(env, length, &amp;data, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-comment">// 确保安全后才能使用data进行操作</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 处理内存分配失败的情况</span></li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Failed to allocate memory for ArrayBuffer"</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 返回ArrayBuffer</span></li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createArrayBuffer</span>: <span class="hljs-function">(<span class="hljs-params">size: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">ArrayBuffer</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_arraybuffer:%{public}s'</span>, testNapi.<span class="hljs-title function_">createArrayBuffer</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">toString</span>());</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-btf-c106="" class="highlight-div"><div _ngcontent-btf-c106="" class="highlight-div-header"><div _ngcontent-btf-c106="" class="highlight-div-header-left"><div _ngcontent-btf-c106="" class="handle-button expand-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-btf-c106="" class="highlight-div-header-right"><div _ngcontent-btf-c106="" class="handle-button ai-button"></div><div _ngcontent-btf-c106="" class="handle-button line-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-btf-c106="" class="handle-button theme-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-btf-c106="" class="handle-button copy-button"><div _ngcontent-btf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-btf-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> <p>输出日志：</p> <p>Test Node-API napi_create_arraybuffer:[object ArrayBuffer]</p> </div>  <div class="tiledSection"><h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2><ul><li><strong>生命周期和内存管理</strong>：在使用Node-API处理ArrayBuffer时，需注意，void*类型的buffer数据段生命周期由引擎管理，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines#防止重复释放获取的buffer">不允许用户自己delete，否则会double free</a>。</li><li><strong>需注意申请buffer大小</strong>：当byte_length很大时，分配失败并不会抛异常，参数data指向的内存为nullptr。建议对*data == nullptr做严格判断，并对超大byte_length做限额检验，避免OOM。</li></ul> </div> </div> <div></div></div>