<h1 _ngcontent-hxl-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口进行buffer相关开发"> 使用Node-API接口进行buffer相关开发 </h1>

<div _ngcontent-hxl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>在ArkTS中，Buffer是一种用于处理二进制数据的数据类型。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>使用Node-API接口进行buffer相关开发时，可以通过Buffer对象实现ArkTS代码与Node-API模块之间的二进制数据交互，包括创建、操作Buffer对象，以处理I/O、网络传输等场景中的二进制数据。</p> <ul><li><strong>Buffer对象</strong>：用于表示一段二进制数据的对象。</li><li><strong>外部Buffer</strong>：在Node-API模块中创建的Buffer，可以与现有的数据关联起来而不需要复制数据到新的Buffer中。</li></ul> </div>  <div class="tiledSection"><h2 id="场景和功能使用">场景和功能使用<i class="anchor-icon anchor-icon-link" anchorid="场景和功能使用" tips="复制节点链接"></i></h2><p>以下这些接口用于有效地与ArkTS层进行交互，这使Node-API模块能够更好地处理ArkTS层的二进制数据，比如处理文件I/O、网络传输等操作：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_buffer</td> <td class="cellrowborder" valign="top" width="50%">用于创建并获取一个指定大小的ArkTS Buffer。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_buffer_copy</td> <td class="cellrowborder" valign="top" width="50%">用于创建并获取一个指定大小的ArkTS Buffer，并以给定的入参数据对buffer的缓冲区进行初始化。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_external_buffer</td> <td class="cellrowborder" valign="top" width="50%">用于创建并获取一个指定大小的ArkTS Buffer，并以给定数据进行初始化，该接口可为Buffer附带额外数据。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_buffer_info</td> <td class="cellrowborder" valign="top" width="50%">获取ArkTS Buffer底层数据缓冲区及其长度。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_is_buffer</td> <td class="cellrowborder" valign="top" width="50%">判断给定ArkTS value是否为Buffer对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_external_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">用于分配一个附加有外部数据的ArkTS ArrayBuffer。外部ArrayBuffer是一个特殊类型的ArrayBuffer，它持有对外部数据的引用而不实际拥有数据存储。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="napi_create_buffer" class="firsth2">napi_create_buffer<i class="anchor-icon anchor-icon-link" anchorid="napi_create_buffer" tips="复制节点链接"></i></h3><p>此接口用于创建Buffer对象。Buffer对象是用于在Node-API模块中操作二进制数据的一种特殊类型。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(<span class="hljs-string">"CreateBuffer"</span>)</span></span>;</li><li>    <span class="hljs-type">void</span> *bufferPtr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> bufferSize = str.<span class="hljs-built_in">size</span>();</li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用napi_create_buffer接口创建并获取一个指定大小的ArkTS Buffer</span></li><li>    napi_status status = <span class="hljs-built_in">napi_create_buffer</span>(env, bufferSize + <span class="hljs-number">1</span>, &amp;bufferPtr, &amp;buffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"napi_create_buffer failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 将字符串str的值复制到buffer的内存中</span></li><li>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *)bufferPtr, str.<span class="hljs-built_in">data</span>());</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createBuffer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_buffer: %{public}s'</span>, testNapi.<span class="hljs-title function_">createBuffer</span>().<span class="hljs-title function_">toString</span>());</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_buffer error'</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_create_buffer_copy">napi_create_buffer_copy<i class="anchor-icon anchor-icon-link" anchorid="napi_create_buffer_copy" tips="复制节点链接"></i></h3><p>本接口是Node-API中用于创建并复制数据到Buffer对象的函数。它可以在Node-API模块中创建一个新的Buffer对象，并将指定的数据复制到该Buffer对象中。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateBufferCopy</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 要copy的内容</span></li><li>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">"CreateBufferCopy"</span>;</li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用napi_create_buffer_copy接口创建buffer并将str的内容copy到buffer</span></li><li>    <span class="hljs-type">void</span>* resultData = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_create_buffer_copy</span>(env, <span class="hljs-built_in">sizeof</span>(str), str, &amp;resultData, &amp;buffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"napi_create_buffer_copy failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (resultData != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API resultData is : %{public}s."</span>, <span class="hljs-keyword">reinterpret_cast</span> &lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(resultData));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API resultData is nullptr."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createBufferCopy</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_buffer_copy: %{public}s'</span>, testNapi.<span class="hljs-title function_">createBufferCopy</span>().<span class="hljs-title function_">toString</span>());</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_buffer_copy error'</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_create_external_buffer">napi_create_external_buffer<i class="anchor-icon anchor-icon-link" anchorid="napi_create_external_buffer" tips="复制节点链接"></i></h3><p>当希望在ArkTS中使用现有的Node-API模块内存块，而不需要额外的拷贝时，可以使用napi_create_external_buffer。这将允许ArkTS层直接访问并操作该内存，避免额外的内存分配和拷贝操作。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 回调函数，用于释放内存</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FinalizeCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(data);</li><li>    data = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateExternalBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个字符串</span></li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(<span class="hljs-string">"CreateExternalBuffer"</span>)</span></span>;</li><li>    <span class="hljs-comment">// 在堆上分配内存，大小为字符串的长度</span></li><li>    <span class="hljs-type">void</span>* data = <span class="hljs-built_in">malloc</span>(str.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"malloc failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">memset</span>(data, <span class="hljs-number">0</span>, str.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 将字符串复制到分配的内存中</span></li><li>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *)(data), (<span class="hljs-type">char</span>*)(str.<span class="hljs-built_in">data</span>()));</li><li>    <span class="hljs-comment">// 使用napi_create_external_buffer接口创建并获取一个指定大小buffer</span></li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_create_external_buffer</span>(env, str.<span class="hljs-built_in">size</span>(), data, FinalizeCallback, <span class="hljs-literal">nullptr</span>, &amp;buffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"napi_create_external_buffer failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createExternalBuffer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_external_buffer: %{public}s'</span>, testNapi.<span class="hljs-title function_">createExternalBuffer</span>()</li><li>    .<span class="hljs-title function_">toString</span>());</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_create_external_buffer error'</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_get_buffer_info">napi_get_buffer_info<i class="anchor-icon anchor-icon-link" anchorid="napi_get_buffer_info" tips="复制节点链接"></i></h3><p>在ArkTS中需要对Buffer对象中的数据执行特定的操作时，可以使用此接口来获取指向数据的指针和数据长度。这样可以在Node-API模块直接对数据进行操作，而无需进行数据的拷贝。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetBufferInfo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个字符串</span></li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(<span class="hljs-string">"GetBufferInfo"</span>)</span></span>;</li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">void</span> *bufferPtr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> bufferSize = str.<span class="hljs-built_in">size</span>();</li><li>    napi_status status = <span class="hljs-built_in">napi_create_buffer</span>(env, bufferSize + <span class="hljs-number">1</span>, &amp;bufferPtr, &amp;buffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"napi_create_buffer failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *)bufferPtr, str.<span class="hljs-built_in">data</span>());</li><li>
</li><li>    <span class="hljs-comment">// 获取Buffer的信息</span></li><li>    <span class="hljs-type">void</span> *tmpBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">size_t</span> bufferLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_buffer_info</span>(env, buffer, &amp;tmpBufferPtr, &amp;bufferLength);</li><li>
</li><li>    <span class="hljs-comment">// 创建一个新的ArkTS字符串来保存Buffer的内容并返出去</span></li><li>    <span class="hljs-keyword">if</span> (bufferLength == <span class="hljs-number">0</span> || ((<span class="hljs-type">char</span>*)tmpBufferPtr)[bufferLength - <span class="hljs-number">1</span>] != <span class="hljs-string">'\0'</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Buffer is not null-terminated"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, (<span class="hljs-type">char</span>*)tmpBufferPtr, bufferLength, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getBufferInfo</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_get_buffer_info: %{public}s'</span>, testNapi.<span class="hljs-title function_">getBufferInfo</span>().<span class="hljs-title function_">toString</span>());</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_get_buffer_info error'</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_is_buffer">napi_is_buffer<i class="anchor-icon anchor-icon-link" anchorid="napi_is_buffer" tips="复制节点链接"></i></h3><p>判断给定ArkTS value是否为Buffer对象。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个Buffer对象</span></li><li>    std::string str = <span class="hljs-string">"buffer"</span>;</li><li>    napi_value buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">void</span> *bufferPtr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_buffer</span>(env, str.<span class="hljs-built_in">size</span>(), &amp;bufferPtr, &amp;buffer);</li><li>
</li><li>    <span class="hljs-comment">// 调用napi_is_buffer接口判断创建的对象是否为buffer</span></li><li>    <span class="hljs-type">bool</span> result = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_buffer</span>(env, buffer, &amp;result);</li><li>    <span class="hljs-comment">// 将结果返回出去</span></li><li>    napi_value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, result, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isBuffer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_buffer: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(testNapi.<span class="hljs-title function_">isBuffer</span>()));</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_is_buffer error'</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_create_external_arraybuffer">napi_create_external_arraybuffer<i class="anchor-icon anchor-icon-link" anchorid="napi_create_external_arraybuffer" tips="复制节点链接"></i></h3><p>分配一个附加有外部数据的ArkTS ArrayBuffer。</p> <p>cpp部分代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {</li><li>    <span class="hljs-type">uint8_t</span> *data;</li><li>    <span class="hljs-type">size_t</span> length;</li><li>} BufferData;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FinalizeCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *finalize_data, <span class="hljs-type">void</span> *finalize_hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取终结时的数据</span></li><li>    BufferData *bufferData = <span class="hljs-built_in">static_cast</span>&lt;BufferData *&gt;(finalize_hint);</li><li>
</li><li>    <span class="hljs-comment">// 执行清理操作，比如释放资源</span></li><li>    <span class="hljs-keyword">delete</span>[] bufferData-&gt;data;</li><li>    <span class="hljs-keyword">delete</span> bufferData;</li><li>}</li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">CreateExternalArraybuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个有五个元素的C++数组</span></li><li>    <span class="hljs-type">uint8_t</span> *dataArray = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[<span class="hljs-number">5</span>]{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};</li><li>    napi_value externalBuffer = <span class="hljs-literal">nullptr</span>;</li><li>    BufferData *bufferData = <span class="hljs-keyword">new</span> BufferData{dataArray, <span class="hljs-number">5</span>};</li><li>
</li><li>    <span class="hljs-comment">// 使用napi_create_external_arraybuffer创建一个外部Array Buffer对象，并指定终结回调函数</span></li><li>    napi_status status =</li><li>        <span class="hljs-built_in">napi_create_external_arraybuffer</span>(env, dataArray, <span class="hljs-number">5</span>, FinalizeCallback, bufferData, &amp;externalBuffer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-comment">// 处理错误</span></li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API napi_create_external_arraybuffer fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value outputArray;</li><li>    <span class="hljs-comment">// 使用napi_create_typedarray创建一个Array对象，并将externalBuffer对象作为参数传入</span></li><li>    status = <span class="hljs-built_in">napi_create_typedarray</span>(env, napi_int8_array, <span class="hljs-number">5</span>, externalBuffer, <span class="hljs-number">0</span>, &amp;outputArray);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-comment">// 处理错误</span></li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API napi_create_typedarray fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> outputArray;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createExternalArraybuffer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API createExternalArraybuffer: %{public}s'</span>,</li><li>           <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(testNapi.<span class="hljs-title function_">createExternalArraybuffer</span>()));</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-hxl-c106="" class="highlight-div"><div _ngcontent-hxl-c106="" class="highlight-div-header"><div _ngcontent-hxl-c106="" class="highlight-div-header-left"><div _ngcontent-hxl-c106="" class="handle-button expand-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxl-c106="" class="highlight-div-header-right"><div _ngcontent-hxl-c106="" class="handle-button ai-button"></div><div _ngcontent-hxl-c106="" class="handle-button line-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxl-c106="" class="handle-button theme-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxl-c106="" class="handle-button copy-button"><div _ngcontent-hxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxl-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> </div> <div></div></div>