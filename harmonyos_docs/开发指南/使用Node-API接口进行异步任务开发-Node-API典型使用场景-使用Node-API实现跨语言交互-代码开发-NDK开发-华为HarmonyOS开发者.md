<h1 _ngcontent-qqp-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口进行异步任务开发"> 使用Node-API接口进行异步任务开发 </h1>

<div _ngcontent-qqp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/napi#napi_create_async_work" target="_blank">napi_create_async_work</a>是Node-API接口之一，用于创建一个异步工作对象。在需要执行耗时操作的场景中使用，避免阻塞env所在的ArkTS线程，确保应用程序的性能和响应速度。例如以下场景：</p>     <ul>      <li>       <p>文件操作：读取大型文件或执行复杂的文件操作时，可以使用异步工作对象来避免阻塞env所在的ArkTS线程。</p></li>      <li>       <p>网络请求：当需要进行网络请求并等待响应时，使用异步工作对象确保主线程不被阻塞，提高应用程序的响应性能。</p></li>      <li>       <p>数据库操作：当需要执行复杂的数据库查询或写入操作时，使用异步工作对象确保主线程不被阻塞，提高应用程序的并发性能。</p></li>      <li>       <p>图像处理：当需要对大型图像进行处理或执行复杂的图像算法时，使用异步工作对象确保主线程不被阻塞，提高应用程序的实时性能。</p></li>     </ul>     <p>napi_queue_async_work接口使用uv_queue_work能力，并管理回调中napi_value的生命周期。</p>     <p>异步调用支持callback和Promise两种方式，选择哪种方式由开发者决定。以下是两种方式的示例代码：</p>     <p><span><img originheight="1082" originwidth="1070" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114337.70846570940365467708846863144707:50001231000000:2800:C0739901EC83E1FC32F3BD84260DDFD1DD5D4A747F605CECED782934C67D7098.png" width="920" height="930.3177570093458"></span></p>    </div>    <div class="tiledSection">     <h2 id="使用promise方式示例">使用Promise方式示例<i class="anchor-icon anchor-icon-link" anchorid="使用promise方式示例" tips="复制节点链接"></i></h2>          <p><span><img originheight="806" originwidth="1220" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114337.72359764400323828790505463212262:50001231000000:2800:4153B5BC31AB3CE1A9B55152FB32131399FA17C5FBCC3F9EB0CDA1AD8308243D.png" width="920" height="607.8032786885245"></span></p>     <ol>      <li>       <p>使用napi_create_async_work创建异步任务，使用napi_queue_async_work将任务加入队列，等待执行。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-comment">// 调用方提供的data context，该数据会传递给execute和complete函数</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CallbackData</span> {</li><li>    napi_async_work asyncWork = <span class="hljs-literal">nullptr</span>;</li><li>    napi_deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    napi_ref callback = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">double</span> args = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">double</span> result = <span class="hljs-number">0</span>;</li><li>};</li><li>
</li><li><span class="hljs-comment">// ···</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">AsyncWork</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_value promise = <span class="hljs-literal">nullptr</span>;</li><li>    napi_deferred deferred = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_promise</span>(env, &amp;deferred, &amp;promise);</li><li>
</li><li>    <span class="hljs-keyword">auto</span> callbackData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CallbackData</span>();</li><li>    callbackData-&gt;deferred = deferred;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;callbackData-&gt;args);</li><li>
</li><li>    napi_value resourceName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"AsyncCallback"</span>, NAPI_AUTO_LENGTH, &amp;resourceName);</li><li>    <span class="hljs-comment">// 创建异步任务</span></li><li>    <span class="hljs-built_in">napi_create_async_work</span>(env, <span class="hljs-literal">nullptr</span>, resourceName, ExecuteCB, CompleteCB, callbackData, &amp;callbackData-&gt;asyncWork);</li><li>    <span class="hljs-comment">// 将异步任务加入队列</span></li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, callbackData-&gt;asyncWork);</li><li>
</li><li>    <span class="hljs-keyword">return</span> promise;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>定义异步任务的第一个回调函数，该函数在工作线程中执行，处理具体的业务逻辑。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">ExecuteCB</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>)</li><li>{</li><li>    <span class="hljs-variable">CallbackData</span> *<span class="hljs-variable">callbackData</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackData</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">result</span> = <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">args</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>定义异步任务的第二个回调函数，该函数在主线程执行，将结果传递给ArkTS侧。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">CompleteCB</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>)</li><li>{</li><li>    <span class="hljs-variable">CallbackData</span> *<span class="hljs-variable">callbackData</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackData</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">result</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_create_double</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">result</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">result</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">napi_resolve_deferred</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">deferred</span>, <span class="hljs-variable">result</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">napi_reject_deferred</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">deferred</span>, <span class="hljs-variable">result</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">napi_delete_async_work</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">asyncWork</span>);</li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">callbackData</span>;</li><li>    <span class="hljs-variable">callbackData</span> = <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>模块初始化和ArkTS侧调用接口。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 模块初始化</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"asyncWork"</span>, <span class="hljs-literal">nullptr</span>, AsyncWork, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div>       <p>接口对应的.d.ts描述</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">asyncWork</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;;</li></ol></pre></div></div>       <p>ArkTS侧调用接口</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>testNapi.<span class="hljs-title function_">asyncWork</span>(<span class="hljs-number">1024</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'XXX'</span>, <span class="hljs-string">'result is %{public}d'</span>, result);</li><li>});</li></ol></pre></div></div>       <p>运行结果：result is 1024</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="使用callback方式示例">使用callback方式示例<i class="anchor-icon anchor-icon-link" anchorid="使用callback方式示例" tips="复制节点链接"></i></h2>          <p><span><img originheight="806" originwidth="1220" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114337.46291704105536928767688239065909:50001231000000:2800:C168E16948C66458F24F95F4900C97038828FC0BE9A446CB9E03EA90DCD726AD.png" width="920" height="607.8032786885245"></span></p>     <ol>      <li>       <p>使用napi_create_async_work创建异步任务，并使用napi_queue_async_work将异步任务加入队列，等待执行。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARGS_2 = <span class="hljs-number">2</span>; <span class="hljs-comment">// 入参索引</span></li><li>
</li><li><span class="hljs-comment">// 调用方提供的data context，该数据会传递给execute和complete函数</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CallbackData</span> {</li><li>    napi_async_work asyncWork = <span class="hljs-literal">nullptr</span>;</li><li>    napi_ref callbackRef = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">double</span> args[<span class="hljs-number">2</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">double</span> result = <span class="hljs-number">0</span>;</li><li>};</li><li>
</li><li><span class="hljs-comment">// ···</span></li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">AsyncWork</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    napi_value args[<span class="hljs-number">3</span>];</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">auto</span> asyncContext = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CallbackData</span>();</li><li>    <span class="hljs-comment">// 将接收到的参数保存到callbackData</span></li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;asyncContext-&gt;args[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;asyncContext-&gt;args[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-comment">// 将传入的callback转换为napi_ref延长其生命周期，防止被GC掉</span></li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, args[INT_ARGS_2], <span class="hljs-number">1</span>, &amp;asyncContext-&gt;callbackRef);</li><li>    napi_value resourceName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"asyncWorkCallback"</span>, NAPI_AUTO_LENGTH, &amp;resourceName);</li><li>    <span class="hljs-comment">// 创建异步任务</span></li><li>    <span class="hljs-built_in">napi_create_async_work</span>(env, <span class="hljs-literal">nullptr</span>, resourceName, ExecuteCB, CompleteCB,</li><li>                           asyncContext, &amp;asyncContext-&gt;asyncWork);</li><li>    <span class="hljs-comment">// 将异步任务加入队列</span></li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, asyncContext-&gt;asyncWork);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>定义异步任务的第一个回调函数，该函数在工作线程中执行，处理具体的业务逻辑。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">ExecuteCB</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>)</li><li>{</li><li>    <span class="hljs-variable">CallbackData</span> *<span class="hljs-variable">callbackData</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackData</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">result</span> = <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">args</span>[<span class="hljs-number">0</span>] + <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">args</span>[<span class="hljs-number">1</span>];</li><li>}</li></ol></pre></div></div></li>      <li>       <p>定义异步任务的第二个回调函数，该函数在主线程执行，将结果传递给ArkTS侧。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">CompleteCB</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>)</li><li>{</li><li>    <span class="hljs-variable">CallbackData</span> *<span class="hljs-variable">callbackData</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackData</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">callbackArg</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_create_double</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">result</span>, &amp;<span class="hljs-title class_">callbackArg</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">callback</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_get_reference_value</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">callbackRef</span>, &amp;<span class="hljs-title class_">callback</span>);</li><li>    <span class="hljs-comment">// 执行回调函数</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">result</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">undefined</span>;</li><li>    <span class="hljs-title function_">napi_get_undefined</span>(<span class="hljs-variable">env</span>, &amp;<span class="hljs-title class_">undefined</span>);</li><li>    <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">undefined</span>, <span class="hljs-variable">callback</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">callbackArg</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>    <span class="hljs-comment">// 删除napi_ref对象以及异步任务</span></li><li>    <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>    <span class="hljs-title function_">napi_delete_async_work</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">callbackData</span>-&gt;<span class="hljs-title class_">asyncWork</span>);</li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">callbackData</span>;</li><li>    <span class="hljs-variable">callbackData</span> = <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>模块初始化以及ArkTS侧调用接口。</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 模块初始化</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"asyncWork"</span>, <span class="hljs-literal">nullptr</span>, AsyncWork, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div>       <p>接口对应的.d.ts描述</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">asyncWork</span>: <span class="hljs-function">(<span class="hljs-params">arg1: <span class="hljs-built_in">number</span>, arg2: <span class="hljs-built_in">number</span>, callback: (result: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>       <p>ArkTS侧调用接口</p>       <div _ngcontent-qqp-c106="" class="highlight-div"><div _ngcontent-qqp-c106="" class="highlight-div-header"><div _ngcontent-qqp-c106="" class="highlight-div-header-left"><div _ngcontent-qqp-c106="" class="handle-button expand-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqp-c106="" class="highlight-div-header-right"><div _ngcontent-qqp-c106="" class="handle-button ai-button"></div><div _ngcontent-qqp-c106="" class="handle-button line-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqp-c106="" class="handle-button theme-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqp-c106="" class="handle-button copy-button"><div _ngcontent-qqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">num1</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">123</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">num2</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">456</span>;</li><li>testNapi.<span class="hljs-title function_">asyncWork</span>(num1, num2, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'XXX'</span>, <span class="hljs-string">'result is %{public}d'</span>, result);</li><li>});</li></ol></pre></div></div>       <p>运行结果：result is 579</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2>          <ul>      <li>调用napi_cancel_async_work接口，无论底层uv是否失败都会返回napi_ok。若因为底层uv导致取消任务失败，complete callback中的status会传入对应错误值，请在complete callback中对status进行处理。</li>      <li>       <p>NAPI的异步工作项（napi_async_work）建议单次使用。napi_queue_async_work后，该napi_async_work需在complete回调执行时或执行后，通过napi_delete_async_work完成释放。同一个napi_async_work只允许释放一次，重复释放会导致未定义行为。</p>       <p>napi_async_work的execute_cb运行在一个独立的工作线程中，该线程从uv线程池中取出。不同工作线程之间互不影响。</p></li>      <li>在任务的执行时序上，napi_async_work仅保证complete_cb在execute_cb之后执行。不同napi_async_work的execute_cb在各自的工作线程上运行，因此无法保证不同execute_cb的执行顺序。如果任务执行需要顺序，建议使用napi_threadsafe_function系列接口，这些接口是保序的。具体使用方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-thread-safety">链接</a>。</li>     </ul>    </div>   </div>   <div></div></div>