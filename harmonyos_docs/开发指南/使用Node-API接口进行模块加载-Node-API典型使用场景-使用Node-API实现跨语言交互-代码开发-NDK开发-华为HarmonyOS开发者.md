<h1 _ngcontent-ljp-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口进行模块加载"> 使用Node-API接口进行模块加载 </h1>

<div _ngcontent-ljp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Node-API中的napi_load_module_with_info接口的功能是进行模块的加载，当模块加载出来之后，可以使用函数napi_get_property获取模块导出的变量，也可以使用napi_get_named_property获取模块导出的函数，该函数可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-ark-runtime">新创建的ArkTS基础运行时环境</a>中使用，即napi_create_ark_runtime接口创建的运行时环境。</p>  <div class="tiledSection"><h2 id="函数说明">函数说明<i class="anchor-icon anchor-icon-link" anchorid="函数说明" tips="复制节点链接"></i></h2><div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">napi_status <span class="hljs-title">napi_load_module_with_info</span><span class="hljs-params">(napi_env env, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* module_info, napi_value* result)</span></span>;</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">参数</th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">env</td> <td class="cellrowborder" valign="top" width="50%">当前的虚拟机环境</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">path</td> <td class="cellrowborder" valign="top" width="50%">加载的文件路径或者模块名</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">module_info</td> <td class="cellrowborder" valign="top" width="50%">bundleName/moduleName的路径拼接</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">result</td> <td class="cellrowborder" valign="top" width="50%">加载的模块</td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <ol><li>bundleName表示AppScope/app.json5中配置的工程名；</li><li>moduleName指的是待加载模块所在的HAP下module.json5中配置的名字；</li></ol>  </div></div></div> </div>  <div class="tiledSection"><h2 id="napi_load_module_with_info支持的场景">napi_load_module_with_info支持的场景<i class="anchor-icon anchor-icon-link" anchorid="napi_load_module_with_info支持的场景" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.1" valign="top" width="33.33333333333333%">场景</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.2" valign="top" width="33.33333333333333%">详细分类</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">本地工程模块</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载模块内文件路径</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">要求路径以moduleName开头</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">本地工程模块</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载HAR模块名</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">-</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">远程包</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载远程HAR模块名</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">-</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">远程包</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载ohpm包名</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">-</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">API</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载@ohos.或 @system.</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">-</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">模块Native库</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">加载libNativeLibrary.so</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">-</td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <ol><li>加载一个模块名，实际的行为是加载该模块的入口文件，一般为index.ets/ts。</li><li>如果在HAR中加载另外一个HAR，需要确保module_info的配置正确，尤其注意moduleName应为HAP的moduleName或者HSP的moduleName。</li><li>如果在HAP/HSP中直接或间接使用了三方包，该三方包中使用napi_load_module_with_info接口加载其他模块A，则需要在HAP/HSP中也添加A的依赖。</li></ol>  </div></div></div> </div>  <div class="tiledSection"><h2 id="异常场景">异常场景<i class="anchor-icon anchor-icon-link" anchorid="异常场景" tips="复制节点链接"></i></h2><ol><li><p>在模块加载过程中，若出现包内未找到对应文件或build-profile.json5配置错误等问题，返回错误码napi_generic_failure，并打印报错日志。</p> <p><span><img originheight="88" originwidth="1666" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114339.10333159366770819045401085379175:50001231000000:2800:BA899457D490568D754FBADD15B7066728F9F98DE276178B27399515BE6CAEDA.png" width="920" height="48.595438175270104"></span></p> </li><li>系统侧发生非预期行为导致加载模块无法正常执行，将抛出cppcrash。</li></ol> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><ul><li><strong>加载模块内文件路径</strong></li></ul> <p>当加载文件中的模块时，如以下ArkTS代码：</p> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//./src/main/ets/Test.ets</span></li><li><span class="hljs-keyword">let</span> value = <span class="hljs-number">123</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Hello HarmonyOS"</span>);</li><li>}</li><li><span class="hljs-keyword">export</span> {value, test};</li></ol></pre></div></div> <ol><li><p>当前模块的build-profile.json5文件中需进行以下配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"./src/main/ets/Test.ets"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>使用napi_load_module_with_info加载Test文件，调用函数test以及获取变量value。</p>  <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">  <p>开启useNormalizedOHMUrl后（即将工程目录中与entry同级别的应用级build-profile.json5文件中strictMode属性的useNormalizedOHMUrl字段配置为true），加载模块内文件路径时：</p>  <ol><li>bundleName不会影响最终加载逻辑，会智能通过module名索引进程内对应的hap，例如：工程的bundleName为com.example.application，实际入参时填写为 com.example.application1，模块也能正常加载。</li><li>路径需要以packageName开头，packageName指的是模块的oh-package.json5中配置的name字段。</li></ol>  </div></div></div>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>     napi_value result;</li><li>     <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载Test文件中的模块</span></li><li>     napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"entry/src/main/ets/Test"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>     <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>         <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>     }</li><li>
</li><li>     napi_value testFn;</li><li>     <span class="hljs-comment">// 2. 使用napi_get_named_property获取test函数</span></li><li>     <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"test"</span>, &amp;testFn);</li><li>     <span class="hljs-comment">// 3. 使用napi_call_function调用函数test</span></li><li>     <span class="hljs-built_in">napi_call_function</span>(env, result, testFn, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>     napi_value value;</li><li>     napi_value key;</li><li>     std::string keyStr = <span class="hljs-string">"value"</span>;</li><li>     <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>     <span class="hljs-comment">// 4. 使用napi_get_property获取变量value</span></li><li>     <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;value);</li><li>     <span class="hljs-keyword">return</span> result;</li><li> }</li></ol></pre></div></div>  </li></ol> <ul><li><strong>加载源码HAR模块</strong></li></ul> <p>HAR包Index.ets文件如下：</p> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//library Index.ets</span></li><li><span class="hljs-keyword">let</span> value = <span class="hljs-number">123</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Hello HarmonyOS"</span>);</li><li>}</li><li><span class="hljs-keyword">export</span> {value, test};</li></ol></pre></div></div> <ol><li><p>在oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"library"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../library"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在使用library的模块中，对build-profile.json5进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"library"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>使用napi_load_module_with_info加载library，调用函数test以及获取变量value：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载library</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"library"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value testFn;</li><li>    <span class="hljs-comment">// 2. 使用napi_get_named_property获取test函数</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"test"</span>, &amp;testFn);</li><li>    <span class="hljs-comment">// 3. 使用napi_call_function调用函数test</span></li><li>    status = <span class="hljs-built_in">napi_call_function</span>(env, result, testFn, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value value;</li><li>    napi_value key;</li><li>    std::string keyStr = <span class="hljs-string">"value"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>    <span class="hljs-comment">// 4. 使用napi_get_property获取变量value</span></li><li>    status = <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> <ul><li><strong>加载源码HSP模块</strong></li></ul> <p>HSP包Index.ets文件如下：</p> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//hsp Index.ets</span></li><li><span class="hljs-keyword">let</span> value = <span class="hljs-number">123</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Hello World"</span>);</li><li>}</li><li><span class="hljs-keyword">export</span> {value, test};</li></ol></pre></div></div> <ol><li><p>在oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"hsp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../hsp"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在使用hsp的模块中，对build-profile.json5进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"hsp"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>使用napi_load_module_with_info加载hsp，调用函数test以及获取变量value：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载hsp</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"hsp"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value testFn;</li><li>    <span class="hljs-comment">// 2. 使用napi_get_named_property获取test函数</span></li><li>    status = <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"test"</span>, &amp;testFn);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 3. 使用napi_call_function调用函数test</span></li><li>    status = <span class="hljs-built_in">napi_call_function</span>(env, result, testFn, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value value;</li><li>    napi_value key;</li><li>    std::string keyStr = <span class="hljs-string">"value"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>    <span class="hljs-comment">// 4. 使用napi_get_property获取变量value</span></li><li>    status = <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> <ul><li><strong>加载远程HAR模块名</strong></li></ul> <ol><li><p>在oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"@ohos/hypium"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.16"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在使用@ohos/hypium的模块中，对build-profile.json5进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"@ohos/hypium"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>使用napi_load_module_with_info加载@ohos/hypium，获取DEFAULT变量：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载@ohos/hypium</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"@ohos/hypium"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value key;</li><li>    std::string keyStr = <span class="hljs-string">"DEFAULT"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>    <span class="hljs-comment">// 2. 使用napi_get_property获取DEFAULT变量</span></li><li>    napi_value defaultValue;</li><li>    <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;defaultValue);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> <ul><li><strong>加载ohpm包名</strong></li></ul> <ol><li><p>在oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"json5"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.2.3"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在使用json5的模块中，对build-profile.json5进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"json5"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>用napi_load_module_with_info加载json5，调用函数stringify：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载json5</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"json5"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value key;</li><li>    std::string keyStr = <span class="hljs-string">"default"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>    <span class="hljs-comment">// 2. 使用napi_get_property获取default对象</span></li><li>    napi_value defaultValue;</li><li>    <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;defaultValue);</li><li>
</li><li>    napi_value stringifyFn;</li><li>    <span class="hljs-comment">// 3. 使用napi_get_named_property获取stringify函数</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, defaultValue, <span class="hljs-string">"stringify"</span>, &amp;stringifyFn);</li><li>    <span class="hljs-comment">// 4. 使用napi_call_function调用函数stringify</span></li><li>    napi_value argStr;</li><li>    std::string text = <span class="hljs-string">"call json5 stringify"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, text.<span class="hljs-built_in">c_str</span>(), text.<span class="hljs-built_in">size</span>(), &amp;argStr);</li><li>    napi_value args[<span class="hljs-number">1</span>] = {argStr};</li><li>
</li><li>    napi_value returnValue;</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, defaultValue, stringifyFn, <span class="hljs-number">1</span>, args, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> <ul><li><strong>加载API模块</strong></li></ul> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载模块@ohos.hilog</span></li><li>    napi_value result;</li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"@ohos.hilog"</span>, <span class="hljs-literal">nullptr</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2. 使用napi_get_named_property获取info函数</span></li><li>    napi_value infoFn;</li><li>    status = <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"info"</span>, &amp;infoFn);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value tag;</li><li>    std::string formatStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, formatStr.<span class="hljs-built_in">c_str</span>(), formatStr.<span class="hljs-built_in">size</span>(), &amp;tag);</li><li>
</li><li>    napi_value outputString;</li><li>    std::string str = <span class="hljs-string">"Hello HarmonyOS"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, str.<span class="hljs-built_in">c_str</span>(), str.<span class="hljs-built_in">size</span>(), &amp;outputString);</li><li>
</li><li>    napi_value flag;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">0</span>, &amp;flag);</li><li>
</li><li>    napi_value args[<span class="hljs-number">3</span>] = {flag, tag, outputString};</li><li>    <span class="hljs-comment">// 3. 使用napi_call_function调用info函数</span></li><li>    status = <span class="hljs-built_in">napi_call_function</span>(env, result, infoFn, <span class="hljs-number">3</span>, args, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <ul><li><strong>加载Native库</strong></li></ul> <p>libentry.so的index.d.ts文件如下：</p> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a: number, b: number</span>) =&gt;</span> number;</li></ol></pre></div></div> <ol><li><p>在oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"libentry.so"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../src/main/cpp/types/libentry"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在使用libentry.so的模块中，对build-profile.json5进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"libentry.so"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>用napi_load_module_with_info加载libentry.so，调用函数add：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_NUM_2 = <span class="hljs-number">2</span>; <span class="hljs-comment">// int类型数值2</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_NUM_3 = <span class="hljs-number">3</span>; <span class="hljs-comment">// int类型数值3</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载libentry.so</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"libentry.so"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value addFn;</li><li>    <span class="hljs-comment">// 2. 使用napi_get_named_property获取add函数</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"add"</span>, &amp;addFn);</li><li>
</li><li>    napi_value a;</li><li>    napi_value b;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, INT_NUM_2, &amp;a);</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, INT_NUM_3, &amp;b);</li><li>    napi_value args[<span class="hljs-number">2</span>] = {a, b};</li><li>    <span class="hljs-comment">// 3. 使用napi_call_function调用函数add</span></li><li>    napi_value returnValue;</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, result, addFn, INT_NUM_2, args, &amp;returnValue);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> <ul><li><strong>HAR加载HAR模块名</strong></li></ul> <p>场景为har1加载har2，har2中的Index.ets文件如下：</p> <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//har2 Index.ets</span></li><li><span class="hljs-keyword">let</span> value = <span class="hljs-number">123</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Hello HarmonyOS"</span>);</li><li>}</li><li><span class="hljs-keyword">export</span> {value, test};</li></ol></pre></div></div> <ol><li><p>在har1中的oh-package.json5文件中配置dependencies项：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"har2"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../har2"</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在har1的build-profile.json5文件中进行配置：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"buildOption"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"arkOptions"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"runtimeOnly"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>                <span class="hljs-attr">"packages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>                    <span class="hljs-string">"har2"</span></li><li>                <span class="hljs-punctuation">]</span></li><li>            <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>  </li><li><p>在har1中使用napi_load_module_with_info加载har2，调用test函数并获取value变量：</p>  <div _ngcontent-ljp-c106="" class="highlight-div"><div _ngcontent-ljp-c106="" class="highlight-div-header"><div _ngcontent-ljp-c106="" class="highlight-div-header-left"><div _ngcontent-ljp-c106="" class="handle-button expand-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ljp-c106="" class="highlight-div-header-right"><div _ngcontent-ljp-c106="" class="handle-button ai-button"></div><div _ngcontent-ljp-c106="" class="handle-button line-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ljp-c106="" class="handle-button theme-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ljp-c106="" class="handle-button copy-button"><div _ngcontent-ljp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ljp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">loadModule</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result;</li><li>    <span class="hljs-comment">// 1. 使用napi_load_module_with_info加载har2，注意这里的moduleName为模块所在HAP包的moduleName</span></li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"har2"</span>, <span class="hljs-string">"com.example.application/entry"</span>, &amp;result);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value testFn;</li><li>    <span class="hljs-comment">// 2. 使用napi_get_named_property获取test函数</span></li><li>    status = <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"test"</span>, &amp;testFn);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 3. 使用napi_call_function调用函数test</span></li><li>    status = <span class="hljs-built_in">napi_call_function</span>(env, result, testFn, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    napi_value value;</li><li>    napi_value key;</li><li>    std::string keyStr = <span class="hljs-string">"value"</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, keyStr.<span class="hljs-built_in">c_str</span>(), keyStr.<span class="hljs-built_in">size</span>(), &amp;key);</li><li>    <span class="hljs-comment">// 4. 使用napi_get_property获取变量value</span></li><li>    status = <span class="hljs-built_in">napi_get_property</span>(env, result, key, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>