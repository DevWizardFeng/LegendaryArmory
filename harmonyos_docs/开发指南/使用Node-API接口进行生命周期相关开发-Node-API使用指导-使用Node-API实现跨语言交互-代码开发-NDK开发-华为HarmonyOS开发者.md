<h1 _ngcontent-mht-c119="" class="doc-title ng-star-inserted" title="使用Node-API接口进行生命周期相关开发"> 使用Node-API接口进行生命周期相关开发 </h1>

<div _ngcontent-mht-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>在Node-API中，napi_value是一个表示ArkTS值的抽象类型，它可以表示任何ArkTS值，包括基本类型（如数字、字符串、布尔值）和复杂对象类型（如数组、函数、对象等）。</p> <p>napi_value的生命周期与其在ArkTS中的对应值的生命周期紧密相关。当ArkTS值被垃圾回收时，与之关联的napi_value也将不再有效。重要的是不要在ArkTS值不再存在时尝试使用napi_value。</p> <p>框架层的scope通常用于管理napi_value的生命周期。在Node-API中，可以使用napi_open_handle_scope和napi_close_handle_scope函数来创建和销毁scope。通过在scope内创建napi_value，可以确保在scope结束时自动释放napi_value，避免内存泄漏。</p> <p>napi_ref是一个Node-API类型，用于管理napi_value的生命周期。napi_ref允许您在napi_value的生命周期内保持对其的引用，即使它已经超出了其原始上下文的范围。这使得您可以在不同的上下文中共享napi_value，并确保在不再需要时正确释放其内存。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>Node-API提供了一组功能，使开发人员能够在Node-API模块中创建和操作ArkTS对象，管理引用和生命周期，并注册垃圾回收回调函数等。下面是一些基本概念：</p> <ul><li><strong>作用域</strong>：用于管理ArkTS对象的生命周期。在某个作用域中创建的对象句柄，默认情况下只能在该作用域内使用。当作用域被关闭后，其中创建的对象将无法再被访问，除非显式地将它们逃逸出当前作用域。</li><li><strong>引用管理</strong>：Node-API提供函数来创建、删除和管理对象的引用，以延长对象的生命周期，避免出现对象use-after-free的问题。同时也通过引用管理去避免发生内存泄漏的问题。</li><li><strong>可逃逸的作用域</strong>：允许在创建的作用域中声明的对象返回到父作用域，通过napi_open_escapable_handle_scope和napi_close_escapable_handle_scope进行管理。</li><li><strong>垃圾回收回调</strong>：允许注册回调函数，以便在ArkTS对象被垃圾回收时执行特定的清理操作。</li></ul> <p>这些基本概念使开发人员能够在Node-API模块中安全且有效地操作ArkTS对象，并确保正确管理对象的生命周期。</p> </div>  <div class="tiledSection"><h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2><p>以下Node-API接口主要用于ArkTS对象的引用管理，并确保在Node-API模块代码中正确地处理ArkTS对象的生命周期。使用场景如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_open_handle_scope、napi_close_handle_scope</td> <td class="cellrowborder" valign="top" width="50%">主要用于管理ArkTS对象的生命周期，确保在Node-API模块代码中使用ArkTS对象时能够正确地进行内存管理。当在Node-API模块中处理ArkTS对象时，需要创建一个临时的作用域来存储对象的引用，以便在执行期间正确访问这些对象，并在执行结束后关闭这个handle scope。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_open_escapable_handle_scope、napi_close_escapable_handle_scope</td> <td class="cellrowborder" valign="top" width="50%">用于创建一个可逃逸的作用域，使得在原生函数中创建的ArkTS对象可以被正确返回到调用该函数的外部ArkTS环境中。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_escape_handle</td> <td class="cellrowborder" valign="top" width="50%">将ArkTS对象的生命周期提升到父作用域中，避免对象被意外释放。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_reference、napi_delete_reference</td> <td class="cellrowborder" valign="top" width="50%">主要用于在Node-API模块代码中管理ArkTS对象的引用，以确保对象的生命周期符合插件的需求。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_reference_ref、napi_reference_unref</td> <td class="cellrowborder" valign="top" width="50%">主要用于管理ArkTS对象引用的引用计数，以确保在多个地方共享引用时引用计数能够正确地增加和减少。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_reference_value</td> <td class="cellrowborder" valign="top" width="50%">主要用于在Node-API模块代码中获取与引用相关联的ArkTS对象，以便在Node-API模块中对其进行操作。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_add_finalizer</td> <td class="cellrowborder" valign="top" width="50%">在需要在ArkTS对象被垃圾回收前执行一些清理或释放资源的情况下，确保资源的正确释放和管理。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> <p>本文cpp部分代码所需引用的头文件如下：</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-comment">// log.h用于C++中日志打印</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li></ol></pre></div></div> <p>本文ArkTS侧示例代码所需的模块导入如下：</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_open_handle_scopenapi_close_handle_scope" class="firsth2">napi_open_handle_scope、napi_close_handle_scope<i class="anchor-icon anchor-icon-link" anchorid="napi_open_handle_scopenapi_close_handle_scope" tips="复制节点链接"></i></h3><p>通过接口napi_open_handle_scope创建一个上下文环境，并使用napi_close_handle_scope进行关闭。这组接口用于管理ArkTS对象的生命周期，确保在Node-API模块代码处理ArkTS对象时能够正确地管理其句柄，以避免出现对象错误回收的问题。</p> <p>需要注意的是，接口仅支持单层嵌套的scope结构。在任何时刻，只有一个scope处于活动状态，所有新创建的handles都将与该scope相关联。scope必须按照与打开顺序相反的顺序关闭。此外，在native方法中创建的所有scope必须在该方法返回之前被关闭。</p> <p>关于生命周期管理的代码部分也可参考下面链接：</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines#生命周期管理">生命周期管理</a></p> <p>关于典型错误使用方法的代码部分也可参考下面链接:</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-faq-about-stability#napi_open_handle_scope与napi_close_handle_scope进行生命周期相关开发典型错误场景">典型错误场景</a></p> <p>cpp部分代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_open_handle_scope、napi_close_handle_scope</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">HandleScopeTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 通过调用napi_open_handle_scope来创建一个句柄作用域</span></li><li>    napi_handle_scope scope;</li><li>    <span class="hljs-built_in">napi_open_handle_scope</span>(env, &amp;scope);</li><li>    <span class="hljs-comment">// 在句柄作用域内创建一个obj</span></li><li>    napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;obj);</li><li>    <span class="hljs-comment">// 在对象中添加属性</span></li><li>    napi_value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"handleScope"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, obj, <span class="hljs-string">"key"</span>, value);</li><li>    <span class="hljs-comment">// 在作用域内获取obj的属性并返回</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, obj, <span class="hljs-string">"key"</span>, &amp;result);</li><li>    <span class="hljs-comment">// 关闭句柄作用域，自动释放在该作用域内创建的对象句柄</span></li><li>    <span class="hljs-built_in">napi_close_handle_scope</span>(env, scope);</li><li>    <span class="hljs-comment">// 此处的result能够得到值“handleScope”</span></li><li>    <span class="hljs-keyword">return</span> result;</li><li>    <span class="hljs-comment">// result已经离开scope的作用域，继续使用可能会存在稳定性问题</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">HandleScope</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 通过调用napi_open_handle_scope来创建一个句柄作用域</span></li><li>    napi_handle_scope scope;</li><li>    <span class="hljs-built_in">napi_open_handle_scope</span>(env, &amp;scope);</li><li>    <span class="hljs-comment">// 在句柄作用域内创建一个obj</span></li><li>    napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;obj);</li><li>    <span class="hljs-comment">// 在对象中添加属性</span></li><li>    napi_value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"handleScope"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, obj, <span class="hljs-string">"key"</span>, value);</li><li>    <span class="hljs-comment">// 关闭句柄作用域，自动释放在该作用域内创建的对象句柄</span></li><li>    <span class="hljs-built_in">napi_close_handle_scope</span>(env, scope);</li><li>    <span class="hljs-comment">// 在作用域外获取obj的属性并返回，此处只能得到“undefined”</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, obj, <span class="hljs-string">"key"</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <p>index.d.ts</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">handleScopeTest</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>; <span class="hljs-comment">// napi_open_handle_scope、napi_close_handle_scope</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">handleScope</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_open_handle_scope  napi_close_handle_scope</span></li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API handleScopeTest: %{public}s'</span>,</li><li>    testNapi.<span class="hljs-title function_">handleScopeTest</span>());</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API handleScope: %{public}s'</span>, testNapi.<span class="hljs-title function_">handleScope</span>());</li><li>  <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>    <span class="hljs-string">'Test Node-API handleScopeTest errorCode: %{public}s, errorMessage: %{public}s'</span>, error.<span class="hljs-property">code</span>,</li><li>    error.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div> <p>框架层的scope嵌入在ArkTS访问native的端到端流程中，即：进入开发者自己写的native方法前open scope, native方法结束后close scope。创建的ArkTS对象的生命周期在调用结束就结束了，不会存在内存泄漏的问题。调用前后如下：</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用NewObject前会open scope</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">NewObject</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 创建一个空对象</span></li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;object);</li><li>    <span class="hljs-comment">// 设置对象的属性</span></li><li>    napi_value name = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 设置属性名为"name"</span></li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"name"</span>, NAPI_AUTO_LENGTH, &amp;name);</li><li>    napi_value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 设置属性值为"Hello from Node-API!"</span></li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"Hello from Node-API!"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-comment">// 将属性设置到对象上</span></li><li>    <span class="hljs-built_in">napi_set_property</span>(env, object, name, value);</li><li>    <span class="hljs-keyword">return</span> object;</li><li>}</li><li><span class="hljs-comment">// NewObject调用函数结束后框架层会close scope</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_open_escapable_handle_scopenapi_close_escapable_handle_scopenapi_escape_handle">napi_open_escapable_handle_scope、napi_close_escapable_handle_scope、napi_escape_handle<i class="anchor-icon anchor-icon-link" anchorid="napi_open_escapable_handle_scopenapi_close_escapable_handle_scopenapi_escape_handle" tips="复制节点链接"></i></h3><p>通过接口napi_open_escapable_handle_scope创建出一个可逃逸的handle scope，可将范围内声明的值返回到父作用域。该作用域需要使用napi_close_escapable_handle_scope进行关闭。napi_escape_handle用于提升传入的ArkTS对象的生命周期到其父作用域。</p> <p>通过上述接口可以更灵活的使用管理传入的ArkTS对象，特别是在处理跨作用域的值传递时非常有用。</p> <p>cpp部分代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_open_escapable_handle_scope、napi_close_escapable_handle_scope、napi_escape_handle</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">EscapableHandleScopeTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建一个可逃逸的句柄作用域</span></li><li>    napi_escapable_handle_scope scope;</li><li>    <span class="hljs-built_in">napi_open_escapable_handle_scope</span>(env, &amp;scope);</li><li>    <span class="hljs-comment">// 在可逃逸的句柄作用域内创建一个obj</span></li><li>    napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;obj);</li><li>    <span class="hljs-comment">// 在对象中添加属性</span></li><li>    napi_value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"Test napi_escapable_handle_scope"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, obj, <span class="hljs-string">"key"</span>, value);</li><li>    <span class="hljs-comment">// 调用napi_escape_handle将对象逃逸到作用域之外</span></li><li>    napi_value escapedObj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_escape_handle</span>(env, scope, obj, &amp;escapedObj);</li><li>    <span class="hljs-comment">// 关闭可逃逸的句柄作用域，清理资源</span></li><li>    <span class="hljs-built_in">napi_close_escapable_handle_scope</span>(env, scope);</li><li>    <span class="hljs-comment">// 在获取逃逸后的obj：escapedObj的属性并返回，此处也能够得到“napi_escapable_handle_scope”</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 为了验证逃逸的实现，可以在此处获取obj的属性，此处会得到“undefined”</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, escapedObj, <span class="hljs-string">"key"</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <p>index.d.ts</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">escapableHandleScopeTest</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>; <span class="hljs-comment">// napi_open_escapable_handle_scope、napi_close_escapable_handle_scope、napi_escape_handle</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_open_escapable_handle_scope napi_close_escapable_handle_scope、napi_escape_handle</span></li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API EscapableHandleScopeTest: %{public}s'</span>,</li><li>    testNapi.<span class="hljs-title function_">escapableHandleScopeTest</span>());</li><li>  <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>    <span class="hljs-string">'Test Node-API EscapableHandleScopeTest errorCode: %{public}s, errorMessage: %{public}s'</span>,</li><li>    error.<span class="hljs-property">code</span>,</li><li>    error.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="napi_create_referencenapi_delete_reference">napi_create_reference、napi_delete_reference<i class="anchor-icon anchor-icon-link" anchorid="napi_create_referencenapi_delete_reference" tips="复制节点链接"></i></h3><p>为Object创建一个reference，以延长其生命周期。调用者需要自己管理reference生命周期。可以调用napi_delete_reference删除传入的reference。</p> </div>  <div class="tiledSection"><h3 id="napi_reference_refnapi_reference_unref">napi_reference_ref、napi_reference_unref<i class="anchor-icon anchor-icon-link" anchorid="napi_reference_refnapi_reference_unref" tips="复制节点链接"></i></h3><p>增加/减少传入的reference的引用计数，并获取新的计数。</p> </div>  <div class="tiledSection"><h3 id="napi_get_reference_value">napi_get_reference_value<i class="anchor-icon anchor-icon-link" anchorid="napi_get_reference_value" tips="复制节点链接"></i></h3><p>获取与reference相关联的ArkTS Object。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>由于弱引用（引用计数为0的napi_ref）的释放与gc回收js对象并非同时发生。</p>  <p>因此可能在弱引用被释放前，js对象已经被回收。</p>  <p>这意味着你可能在napi_ref有效的情况下，通过本接口获取到一个空指针。</p>  </div></div></div> </div>  <div class="tiledSection"><h3 id="napi_add_finalizer">napi_add_finalizer<i class="anchor-icon anchor-icon-link" anchorid="napi_add_finalizer" tips="复制节点链接"></i></h3><p>当ArkTS Object中的对象被垃圾回收时调用注册的napi_add_finalizer回调。</p> <p>cpp部分代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个napi_ref类型的指针，用于存储创建的引用。在调用napi_add_finalizer函数前，分配一个napi_ref类型的变量，并传递其地址作为result参数。</span></li><li>napi_ref gRefFinalizer = nullptr;</li><li>
</li><li><span class="hljs-comment">// 创建一个napi_ref类型的指针，用于存储创建的引用。在调用napi_create_reference函数前，分配一个napi_ref类型的变量，并传递其地址作为result参数。</span></li><li>napi_ref gRef = nullptr;</li><li>
</li><li>void Finalizer(napi_env env, void *<span class="hljs-keyword">data</span>, void *hint)</li><li>{</li><li>    <span class="hljs-comment">// 执行资源清理操作</span></li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"Test Node-API Use Finalizer to release resources."</span>);</li><li>    <span class="hljs-comment">// do something 执行资源清理操作</span></li><li>}</li><li>
</li><li>static napi_value AddFinalizer(napi_env env, napi_callback_info info)</li><li>{</li><li>    napi_value obj = nullptr;</li><li>    napi_status status = napi_create_object(env, &amp;obj);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_object fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value value = nullptr;</li><li>    status = napi_create_string_utf8(env, <span class="hljs-string">"AddFinalizer"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_string_utf8 fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 将键值对添加到对象中</span></li><li>    status = napi_set_named_property(env, obj, <span class="hljs-string">"key"</span>, value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_set_named_property fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 注册回调函数Finalizer用于清理资源</span></li><li>    void *<span class="hljs-keyword">data</span> = {};</li><li>    status = napi_add_finalizer(env, obj, <span class="hljs-keyword">data</span>, Finalizer, nullptr, &amp;gRefFinalizer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_add_finalizer fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li><li>
</li><li>static napi_value CreateReference(napi_env env, napi_callback_info info)</li><li>{</li><li>    napi_value obj = nullptr;</li><li>    napi_status status = napi_create_object(env, &amp;obj);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_object fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value value = nullptr;</li><li>    status = napi_create_string_utf8(env, <span class="hljs-string">"CreateReference"</span>, NAPI_AUTO_LENGTH, &amp;value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_string_utf8 fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 将键值对添加到对象中</span></li><li>    status = napi_set_named_property(env, obj, <span class="hljs-string">"key"</span>, value);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_set_named_property fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 创建对ArkTS对象的引用</span></li><li>    status = napi_create_reference(env, obj, <span class="hljs-number">1</span>, &amp;gRef);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_reference fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 增加传入引用的引用计数并返回生成的引用计数</span></li><li>    uint32_t result = <span class="hljs-number">0</span>;</li><li>    status = napi_reference_ref(env, gRef, &amp;result);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"Test Node-API napi_reference_ref, count = %{public}d."</span>, result);</li><li>    uint32_t numCount = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok || result != numCount) {</li><li>        <span class="hljs-comment">// 若传入引用的引用计数未增加，则抛出错误</span></li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_reference_ref fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li><li>
</li><li>static napi_value UseReference(napi_env env, napi_callback_info info)</li><li>{</li><li>    napi_value obj = nullptr;</li><li>    <span class="hljs-comment">// 通过调用napi_get_reference_value获取引用的ArkTS对象</span></li><li>    napi_status status = napi_get_reference_value(env, gRef, &amp;obj);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_get_reference_value fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-comment">// 返回获取的对象</span></li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li><li>
</li><li>static napi_value DeleteReference(napi_env env, napi_callback_info info)</li><li>{</li><li>    <span class="hljs-comment">// 减少传入引用的引用计数并返回生成的引用计数</span></li><li>    uint32_t result = <span class="hljs-number">0</span>;</li><li>    napi_value count = nullptr;</li><li>    napi_status status = napi_reference_unref(env, gRef, &amp;result);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"Test Node-API napi_reference_unref, count = %{public}d."</span>, result);</li><li>    uint32_t numCount = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok || result != numCount) {</li><li>        <span class="hljs-comment">// 若传入引用的引用计数未减少，则抛出错误</span></li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_reference_unref fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 通过调用napi_delete_reference删除对ArkTS对象的引用</span></li><li>    status = napi_delete_reference(env, gRef);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_delete_reference fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>
</li><li>    status = napi_delete_reference(env, gRefFinalizer);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_delete_reference fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value returnResult = nullptr;</li><li>    status = napi_create_string_utf8(env, <span class="hljs-string">"napi_delete_reference success"</span>, NAPI_AUTO_LENGTH, &amp;returnResult);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, nullptr, <span class="hljs-string">"napi_create_string_utf8 fail"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> returnResult;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <p>// index.d.ts</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">addFinalizer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// napi_add_finalizer</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createReference</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// napi_create_reference、napi_reference_ref</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">useReference</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// napi_get_reference_value</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">deleteReference</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// napi_delete_reference、napi_reference_unref</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_add_finalizer</span></li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API addFinalizer: %{public}s'</span>,</li><li>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(testNapi.<span class="hljs-title function_">addFinalizer</span>()));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API createReference: %{public}s'</span>,</li><li>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(testNapi.<span class="hljs-title function_">createReference</span>()));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API useReference: %{public}s'</span>,</li><li>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(testNapi.<span class="hljs-title function_">useReference</span>()));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API deleteReference: %{public}s'</span>,</li><li>    testNapi.<span class="hljs-title function_">deleteReference</span>());</li><li>  <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>    <span class="hljs-string">'Test Node-API ReferenceTest errorCode: %{public}s, errorMessage: %{public}s'</span>, error.<span class="hljs-property">code</span>,</li><li>    error.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-mht-c106="" class="highlight-div"><div _ngcontent-mht-c106="" class="highlight-div-header"><div _ngcontent-mht-c106="" class="highlight-div-header-left"><div _ngcontent-mht-c106="" class="handle-button expand-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mht-c106="" class="highlight-div-header-right"><div _ngcontent-mht-c106="" class="handle-button ai-button"></div><div _ngcontent-mht-c106="" class="handle-button line-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mht-c106="" class="handle-button theme-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mht-c106="" class="handle-button copy-button"><div _ngcontent-mht-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mht-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> </div> <div></div></div>