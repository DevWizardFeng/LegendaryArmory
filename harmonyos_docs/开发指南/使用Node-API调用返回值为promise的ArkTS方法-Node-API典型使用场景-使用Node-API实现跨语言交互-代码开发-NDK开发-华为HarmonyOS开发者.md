<h1 _ngcontent-ive-c119="" class="doc-title ng-star-inserted" title="使用Node-API调用返回值为promise的ArkTS方法"> 使用Node-API调用返回值为promise的ArkTS方法 </h1>

<div _ngcontent-ive-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>当ArkTS的返回值为Promise时，可以按以下方式在创建的ArkTS运行环境中调用异步接口。</p> </div>  <div class="tiledSection"><h2 id="调用异步的arkts接口示例">调用异步的ArkTS接口示例<i class="anchor-icon anchor-icon-link" anchorid="调用异步的arkts接口示例" tips="复制节点链接"></i></h2><p>使用C++通过NAPI调用返回Promise的ArkTS方法。</p> <p>处理<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-promise" target="_blank">Promise </a>对象：将Promise与C++回调绑定，处理异步结果。</p> <p>转换数据类型：在回调中将JavaScript结果转换为c++可用的数据。</p> </div>  <div class="tiledSection"><h3 id="示例代码" class="firsth2">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h3><ul><li><p>模块注册</p>  <div _ngcontent-ive-c106="" class="highlight-div"><div _ngcontent-ive-c106="" class="highlight-div-header"><div _ngcontent-ive-c106="" class="highlight-div-header-left"><div _ngcontent-ive-c106="" class="handle-button expand-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ive-c106="" class="highlight-div-header-right"><div _ngcontent-ive-c106="" class="handle-button ai-button"></div><div _ngcontent-ive-c106="" class="handle-button line-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ive-c106="" class="handle-button theme-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ive-c106="" class="handle-button copy-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ive-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-comment">//解析Promise结果的回调</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ResolvedCallback</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = { <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">0</span>], &amp;result);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Promise resolved with result:%{public}d"</span>, result);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">//拒绝Promise的回调</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RejectedCallback</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = { <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_value error = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_coerce_to_string</span>(env, args[<span class="hljs-number">0</span>], &amp;error);</li><li>    <span class="hljs-type">char</span> errorMsg[<span class="hljs-number">1024</span>];</li><li>    <span class="hljs-type">size_t</span> len;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, error, errorMsg, <span class="hljs-built_in">sizeof</span>(errorMsg), &amp;len);</li><li>    <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Promise rejected with error:%{public}s"</span>, errorMsg);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CallArkTSAsync</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = { <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 初始化Promise对象</span></li><li>    napi_value promise = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, <span class="hljs-literal">nullptr</span>, argv[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;promise);</li><li>
</li><li>    <span class="hljs-comment">// 初始化thenFunc对象</span></li><li>    napi_value thenFunc = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_named_property</span>(env, promise, <span class="hljs-string">"then"</span>, &amp;thenFunc) != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 初始化onResolve对象</span></li><li>    napi_value onResolve = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 初始化onReject对象</span></li><li>    napi_value onReject = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_function</span>(env, <span class="hljs-string">"onResolve"</span>, NAPI_AUTO_LENGTH, ResolvedCallback, <span class="hljs-literal">nullptr</span>, &amp;onResolve);</li><li>    <span class="hljs-built_in">napi_create_function</span>(env, <span class="hljs-string">"onReject"</span>, NAPI_AUTO_LENGTH, RejectedCallback, <span class="hljs-literal">nullptr</span>, &amp;onReject);</li><li>    <span class="hljs-comment">// 创建参数数组</span></li><li>    napi_value thenArgv[<span class="hljs-number">2</span>] = {onResolve, onReject};</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, promise, thenFunc, <span class="hljs-number">2</span>, thenArgv, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册模块接口</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 初始化属性描述数组</span></li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"callArkTSAsync"</span>, <span class="hljs-literal">nullptr</span>, CallArkTSAsync, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-comment">// 初始化模块</span></li><li><span class="hljs-type">static</span> napi_module nativeModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = <span class="hljs-literal">nullptr</span>,</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;nativeModule);</li><li>}</li></ol></pre></div></div>  </li><li><p>接口声明</p>  <div _ngcontent-ive-c106="" class="highlight-div"><div _ngcontent-ive-c106="" class="highlight-div-header"><div _ngcontent-ive-c106="" class="highlight-div-header-left"><div _ngcontent-ive-c106="" class="handle-button expand-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ive-c106="" class="highlight-div-header-right"><div _ngcontent-ive-c106="" class="handle-button ai-button"></div><div _ngcontent-ive-c106="" class="handle-button line-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ive-c106="" class="handle-button theme-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ive-c106="" class="handle-button copy-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ive-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">callArkTSAsync</span>: <span class="hljs-function">(<span class="hljs-params">func: <span class="hljs-built_in">Function</span></span>) =&gt;</span> <span class="hljs-built_in">object</span>;</li></ol></pre></div></div>  </li><li><p>CMakeLists.txt文件需要按照以下配置：</p>  <div _ngcontent-ive-c106="" class="highlight-div"><div _ngcontent-ive-c106="" class="highlight-div-header"><div _ngcontent-ive-c106="" class="highlight-div-header-left"><div _ngcontent-ive-c106="" class="handle-button expand-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ive-c106="" class="highlight-div-header-right"><div _ngcontent-ive-c106="" class="handle-button ai-button"></div><div _ngcontent-ive-c106="" class="handle-button line-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ive-c106="" class="handle-button theme-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ive-c106="" class="handle-button copy-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ive-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li># the minimum version of CMake.</li><li>cmake_minimum_required(VERSION 3.4.1)</li><li>project(myapplication)</li><li>
</li><li>set(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>if(DEFINED PACKAGE_FIND_FILE)</li><li>    include(${PACKAGE_FIND_FILE})</li><li>endif()</li><li>
</li><li>include_directories(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>
</li><li>add_library(entry SHARED napi_init.cpp)</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div>  </li><li><p>ArkTS代码示例</p>  <div _ngcontent-ive-c106="" class="highlight-div"><div _ngcontent-ive-c106="" class="highlight-div-header"><div _ngcontent-ive-c106="" class="highlight-div-header-left"><div _ngcontent-ive-c106="" class="handle-button expand-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ive-c106="" class="highlight-div-header-right"><div _ngcontent-ive-c106="" class="handle-button ai-button"></div><div _ngcontent-ive-c106="" class="handle-button line-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ive-c106="" class="handle-button theme-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ive-c106="" class="handle-button copy-button"><div _ngcontent-ive-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ive-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SetTimeout</span>(<span class="hljs-params"></span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>);</li><li>        }, <span class="hljs-number">1000</span>);</li><li>    })</li><li>}</li><li>testNapi.<span class="hljs-title function_">callArkTSAsync</span>(<span class="hljs-title class_">SetTimeout</span>);</li></ol></pre></div></div>  </li></ul> </div> </div> <div></div></div>