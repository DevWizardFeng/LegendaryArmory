<h1 _ngcontent-tfu-c119="" class="doc-title ng-star-inserted" title="使用Node-API进行扩展能力功能开发"> 使用Node-API进行扩展能力功能开发 </h1>

<div _ngcontent-tfu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted renderOptimization" style="position: relative;"> <div> <div class="tiledSection" style="contain-intrinsic-size: auto 625px;"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-data-types-interfaces#扩展能力">扩展能力</a>接口进一步扩展了Node-API的功能，提供了一些额外的接口，用于在Node-API模块中与ArkTS进行更灵活的交互和定制，这些接口可以用于创建自定义ArkTS对象等场景。</p> <p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> <p>本文cpp部分代码所需引用的头文件如下：</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/alltypes.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li></ol></pre></div></div> <p>本文ArkTS侧示例代码所需的模块导入如下：</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div> </div>  <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 80px;"><h2 id="模块加载">模块加载<i class="anchor-icon anchor-icon-link" anchorid="模块加载" tips="复制节点链接"></i></h2></div>  <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 417px;"><h3 id="接口描述" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_load_module</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API模块中将abc文件作为模块加载，返回模块的命名空间，适用于需要在运行时动态加载模块或资源的应用程序，从而实现灵活的扩展和定制。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_load_module_with_info</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API中进行模块的加载，当模块加载出来之后，可以使用函数napi_get_property获取模块导出的变量，也可以使用napi_get_named_property获取模块导出的函数，该函数可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-ark-runtime">新创建的ArkTS基础运行时环境</a>中使用。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_module_register</td> <td class="cellrowborder" valign="top" width="50%">有些功能可能需要通过Node-API模块来实现以获得更好的性能，通过将这些功能实现为自定义模块并注册到ArkTS环境中，可以在一定程度上提高整体的性能。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 2077px;"><h3 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h3><p><strong>napi_load_module</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-load-module">使用Node-API接口在主线程中进行模块加载</a></p> <p><strong>napi_load_module_with_info</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-load-module-with-info">使用Node-API接口进行模块加载</a></p> <p><strong>napi_module_register</strong></p> <p>在ArkTS代码环境中使用Node-API模块编写的代码来实现特定的功能，可以将这部分功能封装成自定义模块，然后通过napi_module_register将其注册到ArkTS代码环境中，以实现功能的扩展和复用。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 此模块是一个Node-API的回调函数</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 接受传入两个参数</span></li><li>    <span class="hljs-type">size_t</span> requireArgc = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 将传入的napi_value类型的参数转化为double类型</span></li><li>    <span class="hljs-type">double</span> valueLeft;</li><li>    <span class="hljs-type">double</span> valueRight;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;valueLeft);</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;valueRight);</li><li>
</li><li>    <span class="hljs-comment">// 将转化后的double值相加并转成napi_value返回给ArkTS代码使用</span></li><li>    napi_value sum;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, valueLeft + valueRight, &amp;sum);</li><li>
</li><li>    <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-comment">// C++函数Init用于初始化插件，用于将ArkTS层的函数或属性与C++层的函数进行关联</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 通过napi_property_descriptor结构体，可以定义需要导出的属性，并在Node-API模块中使用。napi_define_properties将属性与实际的C++函数进行关联，使其可以被ArkTS层访问和调用</span></li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-comment">// 插件的初始化被定义在一个名为demoModule的结构体中，其中包含了模块的基本信息，比如模块的版本号、注册函数等</span></li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version =<span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-comment">// 在RegisterEntryModule函数中，使用napi_module_register函数注册并导出了这个插件</span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 模块加载</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="arkts-object相关">ArkTS Object相关<i class="anchor-icon anchor-icon-link" anchorid="arkts-object相关" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 276px;"><h3 id="接口描述-1" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-1" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_object_with_properties</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API模块中使用给定的napi_property_descriptor创建ArkTS Object。descriptor的键名必须为string，且不可转为number。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_object_with_named_properties</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API模块中使用给定的napi_value和键名创建ArkTS Object。键名必须为string，且不可转为number。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 2377px;"><h3 id="使用示例-1">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-1" tips="复制节点链接"></i></h3><p><strong>napi_create_object_with_properties</strong></p> <p>用给定的napi_property_descriptor作为属性去创建一个ArkTS对象，并且descriptor的键名必须为string，且不可转为number。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_properties</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateObjectWithProperties</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// 获取解析传递的参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 声明了一个napi_property_descriptor数组desc，其中包含了一个名为"name"的属性，其值为传入的第一个参数argv[0]。</span></li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"name"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, argv[<span class="hljs-number">0</span>], napi_default_jsproperty, <span class="hljs-literal">nullptr</span>}};</li><li>    napi_value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用napi_create_object_with_properties来创建一个新的ArkTS对象，并将属性值添加到该对象中。</span></li><li>    <span class="hljs-built_in">napi_create_object_with_properties</span>(env, &amp;object, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    napi_valuetype valueType;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, object, &amp;valueType);</li><li>    <span class="hljs-keyword">if</span> (valueType == napi_object) {</li><li>        <span class="hljs-keyword">return</span> object;</li><li>    }</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createObjectWithProperties</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> {<span class="hljs-attr">name</span>:<span class="hljs-built_in">string</span>}; <span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_properties</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_properties</span></li><li><span class="hljs-keyword">let</span> value1 = testNapi.<span class="hljs-title function_">createObjectWithProperties</span>(<span class="hljs-string">'createObject'</span>);</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_create_object_with_properties:%{public}s'</span>,</li><li>  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value1));</li></ol></pre></div></div> <p><strong>napi_create_object_with_named_properties</strong></p> <p>用于使用给定的napi_value和键名创建一个ArkTS对象，并且给定的键名必须为string，且不可转为number。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_named_properties</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateObjectWithNameProperties</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// 获取解析传递的参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key[] = {</li><li>        <span class="hljs-string">"name"</span>,</li><li>    };</li><li>    <span class="hljs-type">const</span> napi_value values[] = {</li><li>        argv[<span class="hljs-number">0</span>],</li><li>    };</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"name"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>                                        <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    napi_status status = <span class="hljs-built_in">napi_create_object_with_named_properties</span>(</li><li>        env, &amp;obj, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), key, values</li><li>    );</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createObjectWithNameProperties</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-literal">undefined</span> | { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }; <span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_named_properties</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkTS Object相关 napi_create_object_with_named_properties</span></li><li><span class="hljs-keyword">let</span> value2 = testNapi.<span class="hljs-title function_">createObjectWithNameProperties</span>(<span class="hljs-string">'ls'</span>);</li><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_create_object_with_named_properties:%{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value2));</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'TNode-API napi_create_object_with_named_properties: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="运行指定abc文件">运行指定abc文件<i class="anchor-icon anchor-icon-link" anchorid="运行指定abc文件" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 159px;"><h3 id="接口描述-2" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-2" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_run_script_path</td> <td class="cellrowborder" valign="top" width="50%">用于在Node-API模块中运行指定abc文件。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 1569px;"><h3 id="使用示例-2">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-2" tips="复制节点链接"></i></h3><p><strong>napi_run_script_path</strong></p> <p>在Node-API模块中运行abc文件。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 运行指定abc文件 napi_run_script_path</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunScriptPath</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value value = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 注意：记得在应用rawfile目录下放置.abc文件</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *scriptPath = <span class="hljs-string">"/entry/src/main/resources/rawfile/test.abc"</span>;</li><li>    <span class="hljs-comment">// 使用napi_run_script_path函数执行指定路径中的文件</span></li><li>    napi_status status = <span class="hljs-built_in">napi_run_script_path</span>(env, scriptPath, &amp;value);</li><li>    <span class="hljs-comment">// 检查是否执行成功，如果失败，返回false</span></li><li>    napi_value returnValue = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">nullptr</span> || status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">false</span>, &amp;returnValue);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;returnValue);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> returnValue;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">runScriptPath</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 运行指定abc文件 napi_run_script_path</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 运行指定abc文件 napi_run_script_path</span></li><li><span class="hljs-keyword">try</span> { <span class="hljs-comment">// 在此处执行错误返回false，成功就返回true</span></li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_run_script_path: %{public}s'</span>,</li><li>    testNapi.<span class="hljs-title function_">runScriptPath</span>());</li><li>  <span class="hljs-comment">// ···</span></li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API napi_run_script_path errorMessage: %{public}s'</span>,</li><li>    error.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// ···</span></li><li>}</li></ol></pre></div></div> <p>test.js代码，将js代码编成.abc文件，步骤如下：</p> <ol><li>在SDK的ets/build-tools/ets-loader/bin/ark/build-win/bin目录下放置test.js文件</li><li>执行命令如es2abc.exe test.js --output test.abc后便可生成test.abc文件</li></ol> <p>放入指定路径中：/entry/resources/rawfile</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {</li><li>  <span class="hljs-keyword">return</span> a + b;</li><li>}</li><li><span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="异步工作对象加入队列并指定优先级">异步工作对象加入队列并指定优先级<i class="anchor-icon anchor-icon-link" anchorid="异步工作对象加入队列并指定优先级" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 207px;"><h3 id="接口描述-3" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-3" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_queue_async_work_with_qos</td> <td class="cellrowborder" valign="top" width="50%">用于将异步工作对象加入队列，让开发者能够根据QoS优先级来管理和调度异步工作的执行，从而更好地满足程序的性能和响应需求。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-3">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-3" tips="复制节点链接"></i></h3><p><strong>napi_queue_async_work_with_qos</strong></p> <p>将异步工作对象加到队列，由底层根据传入的qos优先级去调度执行。</p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="给arkts对象绑定回调和回调所需的参数">给ArkTS对象绑定回调和回调所需的参数<i class="anchor-icon anchor-icon-link" anchorid="给arkts对象绑定回调和回调所需的参数" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 183px;"><h3 id="接口描述-4" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-4" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.15.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.15.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_coerce_to_native_binding_object</td> <td class="cellrowborder" valign="top" width="50%">用于给ArkTS对象绑定回调和回调所需的参数，其作用是为了给ArkTS对象携带Native信息。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 8190px;"><h3 id="使用示例-4">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-4" tips="复制节点链接"></i></h3><p><strong>napi_coerce_to_native_binding_object</strong></p> <p>用于给ArkTS Object绑定回调和回调所需的参数，给ArkTS Object携带Native信息。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Object</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">Object</span>() = <span class="hljs-keyword">default</span>;</li><li>    ~<span class="hljs-built_in">Object</span>() = <span class="hljs-keyword">default</span>;</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> Object* <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        Object* instance = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();</li><li>        <span class="hljs-keyword">return</span> instance;</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetAddress</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">uint64_t</span> addressVal = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(object);</li><li>        napi_value address = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_bigint_uint64</span>(env, addressVal, &amp;address);</li><li>        <span class="hljs-keyword">return</span> address;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取数组大小</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSetSize</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;Object*&gt;(object)-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-type">uint32_t</span> setSize = <span class="hljs-built_in">reinterpret_cast</span>&lt;Object*&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">size</span>();</li><li>        napi_value napiSize = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_uint32</span>(env, setSize, &amp;napiSize);</li><li>        <span class="hljs-keyword">return</span> napiSize;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 往数组里插入元素</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Store</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Store args number must be one."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        napi_valuetype type = napi_undefined;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;type);</li><li>        <span class="hljs-keyword">if</span> (type != napi_number) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Store args is not number."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">napi_get_value_uint32</span>(env, args[<span class="hljs-number">0</span>], &amp;value);</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;Object*&gt;(object)-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;Object *&gt;(object)-&gt; numberSet_.<span class="hljs-built_in">insert</span>(value);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 删除数组元素</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Erase</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Erase args number must be one."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        napi_valuetype type = napi_undefined;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;type);</li><li>        <span class="hljs-keyword">if</span> (type != napi_number) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Erase args is not number."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">napi_get_value_uint32</span>(env, args[<span class="hljs-number">0</span>], &amp;value);</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;Object*&gt;(object)-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;Object *&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">erase</span>(value);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空数组</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Clear</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;Object*&gt;(object)-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;Object *&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">clear</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-built_in">Object</span>(<span class="hljs-type">const</span> Object &amp;) = <span class="hljs-keyword">delete</span>;</li><li>    Object &amp;<span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Object &amp;) = <span class="hljs-keyword">delete</span>;</li><li>
</li><li>    std::unordered_set&lt;<span class="hljs-type">uint32_t</span>&gt; numberSet_{};</li><li>    std::mutex numberSetMutex_{};</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FinializerCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解绑回调，在序列化时调用，可在对象解绑时执行一些清理操作</span></li><li><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">DetachCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *value, <span class="hljs-type">void</span> *hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> value;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 绑定回调，在反序列化时调用</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">AttachCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span>* value, <span class="hljs-type">void</span>* hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;object);</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"getAddress"</span>, <span class="hljs-literal">nullptr</span>, Object::GetAddress, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"getSetSize"</span>, <span class="hljs-literal">nullptr</span>, Object::GetSetSize, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"store"</span>, <span class="hljs-literal">nullptr</span>, Object::Store, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"erase"</span>, <span class="hljs-literal">nullptr</span>, Object::Erase, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"clear"</span>, <span class="hljs-literal">nullptr</span>, Object::Clear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, object, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-comment">// 将JS对象object和native对象value生命周期进行绑定</span></li><li>    napi_status status = <span class="hljs-built_in">napi_wrap</span>(env, object, value, FinializerCallback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API attachCallback is failed."</span>);</li><li>    }</li><li>    <span class="hljs-comment">// JS对象携带native信息</span></li><li>    <span class="hljs-built_in">napi_coerce_to_native_binding_object</span>(env, object, DetachCallback, AttachCallback, value, hint);</li><li>    <span class="hljs-keyword">return</span> object;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"getAddress"</span>, <span class="hljs-literal">nullptr</span>, Object::GetAddress, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"getSetSize"</span>, <span class="hljs-literal">nullptr</span>, Object::GetSetSize, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"store"</span>, <span class="hljs-literal">nullptr</span>, Object::Store, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"erase"</span>, <span class="hljs-literal">nullptr</span>, Object::Erase, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"clear"</span>, <span class="hljs-literal">nullptr</span>, Object::Clear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">auto</span> object = Object::<span class="hljs-built_in">GetInstance</span>();</li><li>    napi_status status = <span class="hljs-built_in">napi_wrap</span>(env, exports, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(object), FinializerCallback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Node-API napi_wrap is failed."</span>);</li><li>    }</li><li>    <span class="hljs-built_in">napi_coerce_to_native_binding_object</span>(env, exports, DetachCallback, AttachCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(object),</li><li>                                         <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 给ArkTS对象绑定回调和回调所需的参数 napi_coerce_to_native_binding_object</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getAddress</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSetSize</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">store</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">erase</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">clear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAddress</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>: <span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"taskpool:: address is "</span> + address);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span>, c:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before store"</span>);</li><li>  testNapi.<span class="hljs-title function_">store</span>(a);</li><li>  testNapi.<span class="hljs-title function_">store</span>(b);</li><li>  testNapi.<span class="hljs-title function_">store</span>(c);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after store"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">erase</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before erase"</span>);</li><li>  testNapi.<span class="hljs-title function_">erase</span>(a);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after erase"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before clear"</span>);</li><li>  testNapi.<span class="hljs-title function_">clear</span>();</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after clear"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test01</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"host thread address is "</span> + address);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task1 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(getAddress);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task1);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task2 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task2);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task3 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task3);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task4 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">3</span>);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task4);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task5 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">5</span>);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task5);</li><li>
</li><li>    <span class="hljs-keyword">let</span> task6 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(clear);</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task6);</li><li>}</li><li>
</li><li><span class="hljs-title function_">test01</span>();</li></ol></pre></div></div> <p><strong>注意事项</strong></p> <p>对ArkTS对象A调用napi_coerce_to_native_binding_object将开发者实现的detach/attach回调和native对象信息加到A上，再将A跨线程传递。跨线程传递需要对A进行序列化和反序列化。此处的序列化与反序列化是人为控制的，需要调用后文介绍的napi_serialize、napi_deserialize接口。过程如下图所示：在当前线程thread1序列化A得到数据data，序列化阶段执行detach回调。然后将data传给目标线程thread2，在thread2中反序列化data，执行attach回调，最终得到ArkTS对象A。此处的detach/attach是告知开发者序列化与反序列化执行完毕的回调。</p> <p><span><img originheight="598" originwidth="840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114337.31893105592988248825959110333937:50001231000000:2800:7EFBB139348551D5362502BAF9A1CEF0D704541B33769BA1A3F7DE8D202D52C5.png" width="840" height="598"></span></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="事件循环">事件循环<i class="anchor-icon anchor-icon-link" anchorid="事件循环" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 204px;"><h3 id="接口描述-5" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-5" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.18.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.18.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_run_event_loop</td> <td class="cellrowborder" valign="top" width="50%">触发底层的事件循环。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_stop_event_loop</td> <td class="cellrowborder" valign="top" width="50%">停止底层的事件循环。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-5">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-5" tips="复制节点链接"></i></h3><p><strong>napi_run_event_loop、napi_stop_event_loop</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-event-loop">使用扩展的Node-API接口在异步线程中运行和停止事件循环</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="arkts基础运行时环境">ArkTS基础运行时环境<i class="anchor-icon anchor-icon-link" anchorid="arkts基础运行时环境" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 204px;"><h3 id="接口描述-6" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-6" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.21.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_ark_runtime</td> <td class="cellrowborder" valign="top" width="50%">创建基础运行时环境。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_destroy_ark_runtime</td> <td class="cellrowborder" valign="top" width="50%">销毁基础运行时环境。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-6">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-6" tips="复制节点链接"></i></h3><p><strong>napi_create_ark_runtime、napi_destroy_ark_runtime</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-ark-runtime">使用Node-API接口创建ArkTS运行时环境</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="序列化和反序列化">序列化和反序列化<i class="anchor-icon anchor-icon-link" anchorid="序列化和反序列化" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 417px;"><h3 id="接口描述-7" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-7" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.24.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.24.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_serialize</td> <td class="cellrowborder" valign="top" width="50%">将ArkTS对象转换为native数据。第一个参数env是接口执行的ArkTS环境；第二个参数object是待序列化的ArkTS对象；第三个参数transfer_list是存放需要以transfer传递的arrayBuffer的array，如不涉及可传undefined；第四个参数clone_list是存放需要克隆传递的Sendable对象的array，如不涉及可传undefined；第五个参数result是序列化结果。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_deserialize</td> <td class="cellrowborder" valign="top" width="50%">将native数据转为ArkTS对象。第一个参数env是接口执行的ArkTS环境；第二个参数buffer是序列化数据；第三个参数object是反序列化得到的结果。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_delete_serialization_data</td> <td class="cellrowborder" valign="top" width="50%">删除序列化数据。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 1633px;"><h3 id="使用示例-7">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-7" tips="复制节点链接"></i></h3><p><strong>napi_serialize、napi_deserialize、napi_delete_serialization_data</strong></p> <p>用于将ArkTS对象转换为native数据、将native数据转为ArkTS对象、删除序列化数据等操作。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 序列化和反序列化</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">AboutSerialize</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取传入的ts的一个对象作为参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value undefined = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 构造napi_serialize方法所需参数</span></li><li>    <span class="hljs-built_in">napi_get_undefined</span>(env, &amp;undefined);</li><li>    <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 调用napi_serialize方法将ts对象转化为native数据</span></li><li>    napi_status status = <span class="hljs-built_in">napi_serialize</span>(env, args[<span class="hljs-number">0</span>], undefined, undefined, &amp;data);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok || data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API napi_serialize fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 构造napi_value类型的数据，用于接收将native数据转化为ts对象后的数据</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_deserialize</span>(env, data, &amp;result);</li><li>    napi_value number = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 获取native数据转化为ts对象后的数据中的numKey属性的值</span></li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, result, <span class="hljs-string">"numKey"</span>, &amp;number);</li><li>    <span class="hljs-comment">// 判断获取到的属性值是否为number类型</span></li><li>    napi_valuetype valuetype;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, number, &amp;valuetype);</li><li>    <span class="hljs-keyword">if</span> (valuetype != napi_number) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Node-API Wrong type of argment. Expects a number."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 调用napi_delete_serialization_data方法删除序列化数据</span></li><li>    <span class="hljs-built_in">napi_delete_serialization_data</span>(env, data);</li><li>    <span class="hljs-comment">// 返回获取到的属性值</span></li><li>    <span class="hljs-keyword">return</span> number;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">aboutSerialize</span>: <span class="hljs-function">(<span class="hljs-params">obj: {numKey:<span class="hljs-built_in">number</span>}</span>) =&gt;</span> <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 序列化和反序列化</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Obj</span> {</li><li>  <span class="hljs-attr">numKey</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 序列化和反序列化</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">Obj</span> = { <span class="hljs-attr">numKey</span>: <span class="hljs-number">500</span> };</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">' Node-API aboutSerialize: %{public}d'</span>, testNapi.<span class="hljs-title function_">aboutSerialize</span>(obj));</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="根据任务指定的优先级和入队方式进行处理异步线程向arkts线程投递的任务">根据任务指定的优先级和入队方式进行处理异步线程向ArkTS线程投递的任务<i class="anchor-icon anchor-icon-link" anchorid="根据任务指定的优先级和入队方式进行处理异步线程向arkts线程投递的任务" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 159px;"><h3 id="接口描述-8" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-8" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.27.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.27.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_call_threadsafe_function_with_priority</td> <td class="cellrowborder" valign="top" width="50%">将指定优先级和入队方式的任务投递到ArkTS主线程。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-8">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-8" tips="复制节点链接"></i></h3><p><strong>napi_call_threadsafe_function_with_priority</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-call-threadsafe-function-with-priority">使用Node-API接口从异步线程向ArkTS线程投递指定优先级和入队方式的的任务</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="sendable相关">Sendable相关<i class="anchor-icon anchor-icon-link" anchorid="sendable相关" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 657px;"><h3 id="接口描述-9" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-9" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.30.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.30.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_is_sendable</td> <td class="cellrowborder" valign="top" width="50%">判断给定ArkTS value是否是Sendable的。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_define_sendable_class</td> <td class="cellrowborder" valign="top" width="50%">创建一个sendable类。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_sendable_object_with_properties</td> <td class="cellrowborder" valign="top" width="50%">使用给定的napi_property_descriptor创建一个sendable对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_sendable_array</td> <td class="cellrowborder" valign="top" width="50%">创建一个sendable数组。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_sendable_array_with_length</td> <td class="cellrowborder" valign="top" width="50%">创建一个指定长度的sendable数组。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_sendable_arraybuffer</td> <td class="cellrowborder" valign="top" width="50%">创建一个sendable ArrayBuffer。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_create_sendable_typedarray</td> <td class="cellrowborder" valign="top" width="50%">创建一个sendable TypedArray。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_wrap_sendable</td> <td class="cellrowborder" valign="top" width="50%">包裹一个native实例到ArkTS对象中。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_wrap_sendable_with_size</td> <td class="cellrowborder" valign="top" width="50%">包裹一个native实例到ArkTS对象中并指定大小。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_unwrap_sendable</td> <td class="cellrowborder" valign="top" width="50%">获取ArkTS对象包裹的native实例。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_remove_wrap_sendable</td> <td class="cellrowborder" valign="top" width="50%">移除并获取ArkTS对象包裹的native实例，移除后回调将不再触发，需手动delete释放内存。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 11977px;"><h3 id="使用示例-9">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-9" tips="复制节点链接"></i></h3><p><strong>napi_is_sendable</strong></p> <p>判断给定ArkTS value是否是Sendable的。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_is_sendable</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsSendable</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">bool</span> isSendable = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_sendable</span>(env, args[<span class="hljs-number">0</span>], &amp;isSendable);</li><li>    napi_value result;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, isSendable, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isSendable</span>: &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">a: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// Sendable相关 napi_is_sendable</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_is_sendable</span></li><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">isSendable</span>(<span class="hljs-string">'createObject'</span>);</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_is_sendable: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));</li></ol></pre></div></div> <p><strong>napi_define_sendable_class</strong></p> <p>创建一个sendable类。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">func</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value val;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"func result"</span>, NAPI_AUTO_LENGTH, &amp;val);</li><li>    <span class="hljs-keyword">return</span> val;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DefineSendableClass</span><span class="hljs-params">(napi_env env)</span> </span>{</li><li>    napi_value str;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"str"</span>, NAPI_AUTO_LENGTH, &amp;str);</li><li>
</li><li>    napi_property_descriptor props[] = {</li><li>        {<span class="hljs-string">"staticStr"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, str,</li><li>         <span class="hljs-built_in">static_cast</span>&lt;napi_property_attributes&gt;(napi_static | napi_writable), <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"staticFunc"</span>, <span class="hljs-literal">nullptr</span>, func, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_static, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"str"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, str, <span class="hljs-built_in">static_cast</span>&lt;napi_property_attributes&gt;(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span> | napi_writable),</li><li>         <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"func"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>         <span class="hljs-built_in">static_cast</span>&lt;napi_property_attributes&gt;(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">11</span> | napi_writable), <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>
</li><li>    napi_value sendableClass = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_define_sendable_class</span>(</li><li>        env, <span class="hljs-string">"SendableClass"</span>, NAPI_AUTO_LENGTH,</li><li>        [](napi_env env, napi_callback_info info) -&gt; napi_value {</li><li>            napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>            napi_value str;</li><li>            <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"instance str"</span>, NAPI_AUTO_LENGTH, &amp;str);</li><li>            napi_property_descriptor props[] = {</li><li>                {<span class="hljs-string">"str"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, str, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>                {<span class="hljs-string">"func"</span>, <span class="hljs-literal">nullptr</span>, func, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>            };</li><li>            <span class="hljs-built_in">napi_define_properties</span>(env, thisVar, <span class="hljs-built_in">sizeof</span>(props) / <span class="hljs-built_in">sizeof</span>(props[<span class="hljs-number">0</span>]), props);</li><li>            <span class="hljs-keyword">return</span> thisVar;</li><li>        },</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">sizeof</span>(props) / <span class="hljs-built_in">sizeof</span>(props[<span class="hljs-number">0</span>]), props, <span class="hljs-literal">nullptr</span>, &amp;sendableClass);</li><li>
</li><li>    <span class="hljs-keyword">return</span> sendableClass;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    napi_value cons = <span class="hljs-built_in">DefineSendableClass</span>(env);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, exports, <span class="hljs-string">"SendableClass"</span>, cons);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableClass</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-attr">staticStr</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticFunc</span>(): <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-title function_">func</span>(): <span class="hljs-built_in">string</span>;</li><li>} <span class="hljs-comment">// Sendable相关 napi_define_sendable_class</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_define_sendable_class</span></li><li><span class="hljs-keyword">let</span> value = <span class="hljs-keyword">new</span> testNapi.<span class="hljs-title class_">SendableClass</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_define_sendable_class: %{public}s'</span>, value.<span class="hljs-property">str</span>);</li></ol></pre></div></div> <p><strong>napi_create_sendable_object_with_properties</strong></p> <p>使用给定的napi_property_descriptor创建一个sendable对象。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_create_sendable_object_with_properties</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSendableObject</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value val_true;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;val_true);</li><li>    napi_property_descriptor desc1[] = {</li><li>        {<span class="hljs-string">"x"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, val_true, napi_default_jsproperty, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    napi_value obj;</li><li>    <span class="hljs-built_in">napi_create_sendable_object_with_properties</span>(env, <span class="hljs-number">1</span>, desc1, &amp;obj);</li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSendableObject</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-attr">x</span>: <span class="hljs-literal">true</span> }; <span class="hljs-comment">// Sendable相关 napi_create_sendable_object_with_properties</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_create_sendable_object_with_properties</span></li><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">getSendableObject</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_create_sendable_object_with_properties: %{public}s'</span>,</li><li>  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));</li></ol></pre></div></div> <p><strong>napi_create_sendable_array</strong></p> <p>创建一个sendable数组。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_create_sendable_array</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSendableArray</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_sendable_array</span>(env, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSendableArray</span>: <span class="hljs-function">() =&gt;</span> []; <span class="hljs-comment">// Sendable相关 napi_create_sendable_array</span></li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_create_sendable_array</span></li><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">getSendableArray</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_create_sendable_array: %{public}s'</span>,</li><li>  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));</li></ol></pre></div></div> <p><strong>napi_create_sendable_array_with_length</strong></p> <p>创建一个指定长度的sendable数组。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sendable相关 napi_create_sendable_array_with_length</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSendableArrayWithLength</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_sendable_array_with_length</span>(env, <span class="hljs-number">1</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSendableArrayWithLength</span>: <span class="hljs-function">() =&gt;</span> [];</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> value = testNapi.<span class="hljs-title function_">getSendableArrayWithLength</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Node-API napi_create_sendable_array_with_length: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value.<span class="hljs-property">length</span>));</li></ol></pre></div></div> <p><strong>napi_create_sendable_arraybuffer</strong></p> <p>创建一个sendable ArrayBuffer。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSendableArrayBuffer</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> LENGTH = <span class="hljs-number">1024</span>;</li><li>    <span class="hljs-type">void</span> *data;</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_sendable_arraybuffer</span>(env, LENGTH, &amp;data, &amp;result);</li><li>    <span class="hljs-type">bool</span> isArrayBuffer = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_arraybuffer</span>(env, result, &amp;isArrayBuffer);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"isArrayBuffer: %{public}d"</span>, isArrayBuffer);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSendableArrayBuffer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">ArrayBuffer</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>testNapi.<span class="hljs-title function_">getSendableArrayBuffer</span>();</li></ol></pre></div></div> <p><strong>napi_create_sendable_typedarray</strong></p> <p>创建一个sendable TypedArray。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSendableTypedArray</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> LENGTH = <span class="hljs-number">1024</span>;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> OFFSET = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">void</span> *data;</li><li>    napi_value arraybuffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_sendable_arraybuffer</span>(env, LENGTH, &amp;data, &amp;arraybuffer);</li><li>
</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_sendable_typedarray</span>(env, napi_uint8_array, LENGTH, arraybuffer, OFFSET, &amp;result);</li><li>    <span class="hljs-type">bool</span> isTypedArray = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-built_in">napi_is_typedarray</span>(env, result, &amp;isTypedArray);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"isTypedArray: %{public}d"</span>, isTypedArray);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSendableTypedArray</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">getSendableTypedArray</span>();</li></ol></pre></div></div> <p><strong>napi_wrap_sendable</strong></p> <p>包裹一个native实例到ArkTS对象中。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">WrapSendable</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value val_true;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;val_true);</li><li>    napi_property_descriptor desc1[] = {</li><li>        {<span class="hljs-string">"x"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, val_true, napi_default_jsproperty, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    napi_value obj;</li><li>    <span class="hljs-built_in">napi_create_sendable_object_with_properties</span>(env, <span class="hljs-number">1</span>, desc1, &amp;obj);</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">napi_wrap_sendable</span>(env, obj, (<span class="hljs-type">void</span>*)testStr, [](napi_env env, <span class="hljs-type">void</span>* data, <span class="hljs-type">void</span>* hint) {}, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">wrapSendable</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">wrapSendable</span>();</li></ol></pre></div></div> <p><strong>napi_wrap_sendable_with_size</strong></p> <p>包裹一个native实例到ArkTS对象中并指定大小。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">WrapSendableWithSize</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value val_true;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;val_true);</li><li>    napi_property_descriptor desc1[] = {</li><li>        {<span class="hljs-string">"x"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, val_true, napi_default_jsproperty, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    napi_value obj;</li><li>    <span class="hljs-built_in">napi_create_sendable_object_with_properties</span>(env, <span class="hljs-number">1</span>, desc1, &amp;obj);</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">napi_wrap_sendable_with_size</span>(env, obj, (<span class="hljs-type">void</span>*)testStr, [](napi_env env, <span class="hljs-type">void</span>* data, <span class="hljs-type">void</span>* hint) {}, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">100</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">wrapSendableWithSize</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">wrapSendableWithSize</span>();</li></ol></pre></div></div> <p><strong>napi_unwrap_sendable</strong></p> <p>获取ArkTS对象包裹的native实例。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">UnwrapSendable</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value val_true;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;val_true);</li><li>    napi_property_descriptor desc1[] = {</li><li>        {<span class="hljs-string">"x"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, val_true, napi_default_jsproperty, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    napi_value obj;</li><li>    <span class="hljs-built_in">napi_create_sendable_object_with_properties</span>(env, <span class="hljs-number">1</span>, desc1, &amp;obj);</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">napi_wrap_sendable</span>(env, obj, (<span class="hljs-type">void</span>*)testStr, [](napi_env env, <span class="hljs-type">void</span>* data, <span class="hljs-type">void</span>* hint) {}, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">char</span>* tmpTestStr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_unwrap_sendable</span>(env, obj, (<span class="hljs-type">void</span>**)&amp;tmpTestStr);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"native value is %{public}s"</span>, tmpTestStr);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">unwrapSendable</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">unwrapSendable</span>();</li></ol></pre></div></div> <p><strong>napi_remove_wrap_sendable</strong></p> <p>移除并获取ArkTS对象包裹的native实例，移除后回调将不再触发，需手动delete释放内存。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RemoveWrapSendable</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value val_true;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">true</span>, &amp;val_true);</li><li>    napi_property_descriptor desc1[] = {</li><li>        {<span class="hljs-string">"x"</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, val_true, napi_default_jsproperty, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    napi_value obj;</li><li>    <span class="hljs-built_in">napi_create_sendable_object_with_properties</span>(env, <span class="hljs-number">1</span>, desc1, &amp;obj);</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    <span class="hljs-built_in">napi_wrap_sendable</span>(env, obj, (<span class="hljs-type">void</span>*)testStr, [](napi_env env, <span class="hljs-type">void</span>* data, <span class="hljs-type">void</span>* hint) {}, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">char</span>* tmpTestStr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_remove_wrap_sendable</span>(env, obj, (<span class="hljs-type">void</span>**)&amp;tmpTestStr);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"native value is %{public}s"</span>, tmpTestStr);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">removeWrapSendable</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">removeWrapSendable</span>();</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>target_compile_definitions(entry PRIVATE LOG_DOMAIN=0xd0d0 LOG_TAG="testTag")</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="napi_wrap接口增强">napi_wrap接口增强<i class="anchor-icon anchor-icon-link" anchorid="napi_wrap接口增强" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 207px;"><h3 id="接口描述-10" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-10" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.33.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.33.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_wrap_enhance</td> <td class="cellrowborder" valign="top" width="50%">在ArkTS对象上绑定一个Node-API模块对象实例并指定实例大小，开发者可以指定绑定的回调函数是否异步执行，如果异步执行，则回调函数必须是线程安全的。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 1213px;"><h3 id="使用示例-10">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-10" tips="复制节点链接"></i></h3><p><strong>napi_wrap_enhance</strong></p> <p>在ArkTS对象上绑定一个Node-API模块对象实例并指定实例大小，开发者可以指定绑定的回调函数是否异步执行，如果异步执行，则回调函数必须是线程安全的。</p> <p>cpp部分代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestNapiWrapEnhance</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value testClass = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_define_class</span>(</li><li>        env, <span class="hljs-string">"TestClass"</span>, NAPI_AUTO_LENGTH,</li><li>        [](napi_env env, napi_callback_info info) -&gt; napi_value {</li><li>            napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>            <span class="hljs-keyword">return</span> thisVar;</li><li>        },</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;testClass);</li><li>
</li><li>    napi_value obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_new_instance</span>(env, testClass, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, &amp;obj);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* testStr = <span class="hljs-string">"test"</span>;</li><li>    napi_ref wrappedRef = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_wrap_enhance</span>(env, obj, (<span class="hljs-type">void</span>*)testStr, [](napi_env env, <span class="hljs-type">void</span>* data, <span class="hljs-type">void</span>* hint) {}, <span class="hljs-literal">false</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">sizeof</span>(testStr), &amp;wrappedRef);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">testNapiWrapEnhance</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <div _ngcontent-tfu-c106="" class="highlight-div"><div _ngcontent-tfu-c106="" class="highlight-div-header"><div _ngcontent-tfu-c106="" class="highlight-div-header-left"><div _ngcontent-tfu-c106="" class="handle-button expand-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfu-c106="" class="highlight-div-header-right"><div _ngcontent-tfu-c106="" class="handle-button ai-button"></div><div _ngcontent-tfu-c106="" class="handle-button line-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfu-c106="" class="handle-button theme-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfu-c106="" class="handle-button copy-button"><div _ngcontent-tfu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li>testNapi.<span class="hljs-title function_">testNapiWrapEnhance</span>();</li></ol></pre></div></div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="napi提供多上下文环境能力">napi提供多上下文环境能力<i class="anchor-icon anchor-icon-link" anchorid="napi提供多上下文环境能力" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 249px;"><h3 id="接口描述-11" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-11" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.36.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.36.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_ark_context</td> <td class="cellrowborder" valign="top" width="50%">创建基础运行时上下文环境。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_switch_ark_context</td> <td class="cellrowborder" valign="top" width="50%">切换到指定的运行时上下文环境。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_destroy_ark_context</td> <td class="cellrowborder" valign="top" width="50%">销毁基础运行时上下文环境。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-11">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-11" tips="复制节点链接"></i></h3><p><strong>napi_create_ark_context、napi_switch_ark_context、napi_destroy_ark_context</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-context">使用扩展的Node-API接口创建、切换和销毁上下文环境</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="napi提供通过指针访问arkts-string内存数据的功能">napi提供通过指针访问ArkTS String内存数据的功能<i class="anchor-icon anchor-icon-link" anchorid="napi提供通过指针访问arkts-string内存数据的功能" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 159px;"><h3 id="接口描述-12" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-12" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.39.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.39.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_get_buffer_string_utf16_in_critical_scope</td> <td class="cellrowborder" valign="top" width="50%">获取以Utf16编码的ArkTS String的内存数据缓冲区</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-12">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-12" tips="复制节点链接"></i></h3><p><strong>napi_get_buffer_string_utf16_in_critical_scope</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-critical">使用扩展的Node-API接口创建和销毁临界区作用域及访问字符串内容</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="napi实现临界区作用域">napi实现临界区作用域<i class="anchor-icon anchor-icon-link" anchorid="napi实现临界区作用域" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 204px;"><h3 id="接口描述-13" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-13" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.42.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.42.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_open_critical_scope</td> <td class="cellrowborder" valign="top" width="50%">打开临界区作用域</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_close_critical_scope</td> <td class="cellrowborder" valign="top" width="50%">关闭临界区作用域</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-13">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-13" tips="复制节点链接"></i></h3><p><strong>napi_open_critical_scope、napi_close_critical_scope</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-critical">使用扩展的Node-API接口创建和销毁临界区作用域及访问字符串内容</a></p> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="napi支持创建轻量级的强引用对象">napi支持创建轻量级的强引用对象<i class="anchor-icon anchor-icon-link" anchorid="napi支持创建轻量级的强引用对象" tips="复制节点链接"></i></h2></div>  <div class="tiledSection" style="contain-intrinsic-size: auto 249px;"><h3 id="接口描述-14" class="firsth2">接口描述<i class="anchor-icon anchor-icon-link" anchorid="接口描述-14" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.45.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.45.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_strong_reference</td> <td class="cellrowborder" valign="top" width="50%">创建指向ArkTS对象的强引用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_delete_strong_reference</td> <td class="cellrowborder" valign="top" width="50%">删除强引用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_strong_reference_value</td> <td class="cellrowborder" valign="top" width="50%">根据强引用对象获取其关联的ArkTS对象值</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection" style="contain-intrinsic-size: auto 140px;"><h3 id="使用示例-14">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例-14" tips="复制节点链接"></i></h3><p><strong>napi_create_strong_reference、napi_delete_strong_reference、napi_get_value_strong_reference</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-strong-reference">使用扩展的Node-API接口创建、销毁和使用强引用对象</a></p> </div> </div> <div></div></div>