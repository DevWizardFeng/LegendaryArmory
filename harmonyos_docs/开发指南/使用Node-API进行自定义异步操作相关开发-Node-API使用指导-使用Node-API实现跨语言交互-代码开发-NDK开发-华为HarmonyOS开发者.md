<h1 _ngcontent-hyr-c119="" class="doc-title ng-star-inserted" title="使用Node-API进行自定义异步操作相关开发"> 使用Node-API进行自定义异步操作相关开发 </h1>

<div _ngcontent-hyr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>使用Node-API的自定义异步操作功能，可以使ArkTS更灵活高效地处理那些可能阻塞事件循环的长时间运行任务，同时保持应用的响应性和性能。</p> </div>  <div class="tiledSection"><h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2><p>Node-API支持异步操作，这有助于处理IO密集型或计算密集型任务。这些任务通常需要非阻塞的执行方式，以避免阻塞主线程。以下是一些关于自定义异步操作的基本概念：</p> <ul><li><strong>异步模型：</strong> Node-API支持异步模型，提供了Promise和Callback两种方式来实现异步操作。Promise是一种基于未来值的编程模型，它允许开发者将异步操作的结果封装在一个对象中，并通过链式调用的方式处理异步操作的结果。Callback则是一种传统的异步编程方式，通过回调函数来处理异步操作的结果。</li><li><strong>临时结果：</strong> 当原生方法（即Node-API代码）被调用时，它会立即返回一个临时结果给ArkTS调用者。这个临时结果通常是一个表示异步操作正在进行中的标志，或者是用于后续处理异步操作结果的句柄。</li><li><strong>回调或Promise：</strong> 当异步操作完成后，结果会通过回调函数或Promise对象返回给ArkTS调用者。这样，ArkTS代码就可以在异步操作完成后继续执行后续的逻辑。</li></ul> </div>  <div class="tiledSection"><h2 id="场景和功能介绍">场景和功能介绍<i class="anchor-icon anchor-icon-link" anchorid="场景和功能介绍" tips="复制节点链接"></i></h2><p>这些Node-API接口可以在Node-API模块中执行异步操作、进行ArkTS回调以及管理相关资源的生命周期。通过使用这些函数，可以有效地与ArkTS环境进行交互，并实现复杂的异步操作。它们的使用场景如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_async_init、napi_async_destroy</td> <td class="cellrowborder" valign="top" width="50%">用于创建和销毁异步资源上下文环境。这些函数可以用于处理长时间运行的异步操作，例如文件I/O操作、网络请求等。在这些情况下，创建异步资源上下文环境，执行必要的异步任务，然后销毁资源以释放相关的资源和内容。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_make_callback</td> <td class="cellrowborder" valign="top" width="50%">用于在异步资源上下文环境中执行ArkTS回调函数。在处理异步操作的结果后，将结果传递回ArkTS代码。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_open_callback_scope、napi_close_callback_scope</td> <td class="cellrowborder" valign="top" width="50%">用于创建和关闭回调作用域。在异步操作期间执行ArkTS代码并管理其上下文。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><p>Node-API接口开发流程参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process">使用Node-API实现跨语言交互开发流程</a>，本文仅对接口对应C++及ArkTS相关代码进行展示。</p> </div>  <div class="tiledSection"><h3 id="napi_async_initnapi_async_destroy" class="firsth2">napi_async_init、napi_async_destroy<i class="anchor-icon anchor-icon-link" anchorid="napi_async_initnapi_async_destroy" tips="复制节点链接"></i></h3><p>在需要管理异步资源上下文环境的创建和销毁时，可以使用napi_async_init和napi_async_destroy来管理这些环境。需要注意的是，这些函数不支持与async_hook相关的能力，所以在使用时需要注意可能存在的一些限制。</p> </div>  <div class="tiledSection"><h3 id="napi_make_callback">napi_make_callback<i class="anchor-icon anchor-icon-link" anchorid="napi_make_callback" tips="复制节点链接"></i></h3><p>在编写Node-API模块时，异步操作完成后需调用ArkTS回调函数。可使用napi_async_init创建异步资源上下文，再使用napi_make_callback执行ArkTS回调函数。</p> </div>  <div class="tiledSection"><h3 id="napi_open_callback_scopenapi_close_callback_scope">napi_open_callback_scope、napi_close_callback_scope<i class="anchor-icon anchor-icon-link" anchorid="napi_open_callback_scopenapi_close_callback_scope" tips="复制节点链接"></i></h3><p>在需要创建一个回调作用域来确保异步操作期间ArkTS环境仍然可用时，可以使用napi_open_callback_scope创建回调作用域，然后在异步操作完成后使用napi_close_callback_scope关闭该作用域。</p> <p>cpp部分代码</p> <div _ngcontent-hyr-c106="" class="highlight-div"><div _ngcontent-hyr-c106="" class="highlight-div-header"><div _ngcontent-hyr-c106="" class="highlight-div-header-left"><div _ngcontent-hyr-c106="" class="handle-button expand-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hyr-c106="" class="highlight-div-header-right"><div _ngcontent-hyr-c106="" class="handle-button ai-button"></div><div _ngcontent-hyr-c106="" class="handle-button line-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hyr-c106="" class="handle-button theme-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hyr-c106="" class="handle-button copy-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hyr-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_2 = <span class="hljs-number">2</span>; <span class="hljs-comment">// 入参索引</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> INT_ARG_3 = <span class="hljs-number">3</span>; <span class="hljs-comment">// 入参索引</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">AsynchronousWork</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 接受四个参数</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">4</span>;</li><li>    napi_value args[<span class="hljs-number">4</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// 从回调信息中获取参数</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 提取参数中的资源、接收器对象和函数</span></li><li>    napi_value resource = args[<span class="hljs-number">0</span>];</li><li>    napi_value recv = args[<span class="hljs-number">1</span>];</li><li>    napi_value func = args[INT_ARG_2];</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    argv[<span class="hljs-number">0</span>] = args[INT_ARG_3];</li><li>    <span class="hljs-comment">// 获取函数的类型</span></li><li>    napi_valuetype funcType;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, func, &amp;funcType);</li><li>    <span class="hljs-comment">// 创建一个资源名称为"test"的字符串</span></li><li>    napi_value resourceName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"test"</span>, NAPI_AUTO_LENGTH, &amp;resourceName);</li><li>    <span class="hljs-comment">// 初始化异步上下文</span></li><li>    napi_async_context context;</li><li>    napi_status status = <span class="hljs-built_in">napi_async_init</span>(env, resource, resourceName, &amp;context);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"napi_async_init fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 打开回调作用域</span></li><li>    napi_callback_scope scope = <span class="hljs-literal">nullptr</span>;</li><li>    status = <span class="hljs-built_in">napi_open_callback_scope</span>(env, resource, context, &amp;scope);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_async_destroy</span>(env, context);</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"napi_open_callback_scope fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 调用回调函数</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (funcType == napi_function) {</li><li>        <span class="hljs-built_in">napi_make_callback</span>(env, context, recv, func, <span class="hljs-number">1</span>, argv, &amp;result);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Unexpected argument type"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 关闭回调作用域</span></li><li>    status = <span class="hljs-built_in">napi_close_callback_scope</span>(env, scope);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"napi_close_callback_scope fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 销毁异步上下文</span></li><li>    <span class="hljs-built_in">napi_async_destroy</span>(env, context);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div> <p>接口声明</p> <p>index.d.ts</p> <div _ngcontent-hyr-c106="" class="highlight-div"><div _ngcontent-hyr-c106="" class="highlight-div-header"><div _ngcontent-hyr-c106="" class="highlight-div-header-left"><div _ngcontent-hyr-c106="" class="handle-button expand-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hyr-c106="" class="highlight-div-header-right"><div _ngcontent-hyr-c106="" class="handle-button ai-button"></div><div _ngcontent-hyr-c106="" class="handle-button line-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hyr-c106="" class="handle-button theme-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hyr-c106="" class="handle-button copy-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hyr-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">asynchronousWork</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span>: <span class="hljs-built_in">Object</span>, obj: <span class="hljs-built_in">Object</span>, fun: <span class="hljs-built_in">Function</span>, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>;</li></ol></pre></div></div> <p>ArkTS侧示例代码</p> <p>导入模块</p> <div _ngcontent-hyr-c106="" class="highlight-div"><div _ngcontent-hyr-c106="" class="highlight-div-header"><div _ngcontent-hyr-c106="" class="highlight-div-header-left"><div _ngcontent-hyr-c106="" class="handle-button expand-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hyr-c106="" class="highlight-div-header-right"><div _ngcontent-hyr-c106="" class="handle-button ai-button"></div><div _ngcontent-hyr-c106="" class="handle-button line-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hyr-c106="" class="handle-button theme-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hyr-c106="" class="handle-button copy-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hyr-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { process } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div> <p>测试代码</p> <div _ngcontent-hyr-c106="" class="highlight-div"><div _ngcontent-hyr-c106="" class="highlight-div-header"><div _ngcontent-hyr-c106="" class="highlight-div-header-left"><div _ngcontent-hyr-c106="" class="handle-button expand-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hyr-c106="" class="highlight-div-header-right"><div _ngcontent-hyr-c106="" class="handle-button ai-button"></div><div _ngcontent-hyr-c106="" class="handle-button line-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hyr-c106="" class="handle-button theme-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hyr-c106="" class="handle-button copy-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hyr-c106="" class="highlight-scroll-div"><pre class="TypeScript prettyprint linenums hljs language-TypeScript" hw-language="TypeScript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API asynchronousWork: %{public}d'</span>,</li><li>    testNapi.<span class="hljs-title function_">asynchronousWork</span>({}, process.<span class="hljs-property">ProcessManager</span>, <span class="hljs-function">(<span class="hljs-params">num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> num;</li><li>    }, <span class="hljs-number">123</span>));</li><li>  <span class="hljs-comment">// ···</span></li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test Node-API asynchronousWork error: %{public}s'</span>, error.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// ···</span></li><li>}</li></ol></pre></div></div> <p>以上代码如果要在native cpp中打印日志，需在CMakeLists.txt文件中添加以下配置信息（并添加头文件：#include "hilog/log.h"）：</p> <div _ngcontent-hyr-c106="" class="highlight-div"><div _ngcontent-hyr-c106="" class="highlight-div-header"><div _ngcontent-hyr-c106="" class="highlight-div-header-left"><div _ngcontent-hyr-c106="" class="handle-button expand-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hyr-c106="" class="highlight-div-header-right"><div _ngcontent-hyr-c106="" class="handle-button ai-button"></div><div _ngcontent-hyr-c106="" class="handle-button line-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hyr-c106="" class="handle-button theme-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hyr-c106="" class="handle-button copy-button"><div _ngcontent-hyr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hyr-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>// CMakeLists.txt</li><li>add_definitions( "-DLOG_DOMAIN=0xd0d0" )</li><li>add_definitions( "-DLOG_TAG=\"testTag\"" )</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so)</li></ol></pre></div></div> </div> </div> <div></div></div>