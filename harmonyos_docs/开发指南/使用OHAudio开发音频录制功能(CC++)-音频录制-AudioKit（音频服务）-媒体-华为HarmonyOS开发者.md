<h1 _ngcontent-msd-c119="" class="doc-title ng-star-inserted" title="使用OHAudio开发音频录制功能(C/C++)"> 使用OHAudio开发音频录制功能(C/C++) </h1>

<div _ngcontent-msd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>OHAudio是系统在API version 10中引入的一套C API，此API在设计上实现归一，同时支持普通音频通路和低时延通路。仅支持PCM格式，适用于依赖Native层实现音频输入功能的场景。</p>    <p>OHAudio音频录制状态变化示意图：</p>    <p><span><img originheight="622" originwidth="708" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114427.74902145812842496669283738611470:50001231000000:2800:F2AC1C0DEC035330A00EEFE80059CD4B3FED37419AB88E93C8C9B8DD8CB736B2.png" width="708" height="622"></span></p>    <div class="tiledSection">     <h2 id="使用入门">使用入门<i class="anchor-icon anchor-icon-link" anchorid="使用入门" tips="复制节点链接"></i></h2>          <p>开发者要使用OHAudio提供的录制能力，需要添加对应的头文件。</p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libohaudio.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="添加头文件">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="添加头文件" tips="复制节点链接"></i></h3>          <p>开发者通过引入&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h" target="_blank">native_audiostreambuilder.h</a>&gt;和&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiocapturer-h" target="_blank">native_audiocapturer.h</a>&gt;头文件，使用音频录制相关API。</p>     <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiocapturer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiostreambuilder.h&gt;</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio" target="_blank">OHAudio</a>。</p>    </div>    <div class="tiledSection">     <h3 id="音频流构造器" class="firsth2">音频流构造器<i class="anchor-icon anchor-icon-link" anchorid="音频流构造器" tips="复制节点链接"></i></h3>          <p>OHAudio提供OH_AudioStreamBuilder接口，遵循构造器设计模式，用于构建音频流。开发者需要根据业务场景，指定对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_type" target="_blank">OH_AudioStream_Type</a>。</p>     <p>OH_AudioStream_Type包含两种类型：</p>     <ul>      <li>AUDIOSTREAM_TYPE_RENDERER</li>      <li>AUDIOSTREAM_TYPE_CAPTURER</li>     </ul>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_create" target="_blank">OH_AudioStreamBuilder_Create</a>创建构造器示例：</p>     <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStreamBuilder* builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, streamType);</li></ol></pre></div></div>     <p>在音频业务结束之后，开发者应该执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_destroy" target="_blank">OH_AudioStreamBuilder_Destroy</a>接口来销毁构造器。</p>     <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li></ol></pre></div></div>     <p>开发者可以通过以下几个步骤来实现一个简单的录制功能。</p>    </div>    <div class="tiledSection">     <h3 id="实现音频录制">实现音频录制<i class="anchor-icon anchor-icon-link" anchorid="实现音频录制" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>创建构造器。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStreamBuilder* builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, AUDIOSTREAM_TYPE_CAPTURER);</li></ol></pre></div></div></li>      <li>       <p>配置音频流参数。</p>       <p>创建音频录制构造器后，可以设置音频流所需要的参数，可以参考下面的案例。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置音频采样率。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSamplingRate</span>(builder, <span class="hljs-number">48000</span>);</li><li><span class="hljs-comment">// 设置音频声道。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelCount</span>(builder, <span class="hljs-number">2</span>);</li><li><span class="hljs-comment">// 设置音频采样格式。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSampleFormat</span>(builder, AUDIOSTREAM_SAMPLE_S16LE);</li><li><span class="hljs-comment">// 设置音频流的编码类型。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetEncodingType</span>(builder, AUDIOSTREAM_ENCODING_TYPE_RAW);</li><li><span class="hljs-comment">// 设置输入音频流的工作场景。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetCapturerInfo</span>(builder, AUDIOSTREAM_SOURCE_TYPE_MIC);</li></ol></pre></div></div>       <p>注意，音频录制的音频数据需要通过回调接口读入，开发者要实现回调接口，从API version 12开始支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setcapturerreaddatacallback" target="_blank">OH_AudioStreamBuilder_SetCapturerReadDataCallback</a>设置回调函数。回调函数的声明请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiocapturer-h#oh_audiocapturer_onreaddatacallback" target="_blank">OH_AudioCapturer_OnReadDataCallback</a>。</p></li>      <li>       <p>设置音频回调函数。</p>       <p>多音频并发处理可参考文档<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency">处理音频焦点事件</a>，仅接口语言差异。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义读入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MyOnReadData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* audioData,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> audioDataSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 从buffer中取出length长度的录音数据。</span></li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新录制器状态和界面。</span></li><li>}</li><li><span class="hljs-comment">// 自定义异常回调函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MyOnError</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioStream_Result error)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据error表示的音频异常信息，做出相应的处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 配置音频中断事件回调函数。</span></li><li>OH_AudioCapturer_OnInterruptCallback OnIntereruptCb = MyOnInterruptEvent;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetCapturerInterruptCallback</span>(builder, OnIntereruptCb, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li><span class="hljs-comment">// 配置音频异常回调函数。</span></li><li>OH_AudioCapturer_OnErrorCallback OnErrorCb = MyOnError;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetCapturerErrorCallback</span>(builder, OnErrorCb, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li><span class="hljs-comment">// 配置音频输入流的回调。</span></li><li>OH_AudioCapturer_OnReadDataCallback OnReadDataCb = MyOnReadData;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetCapturerReadDataCallback</span>(builder, OnReadDataCb, <span class="hljs-literal">nullptr</span>);</li></ol></pre></div></div></li>      <li>       <p>构造录制音频流。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioCapturer* audioCapturer;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_GenerateCapturer</span>(builder, &amp;audioCapturer);</li></ol></pre></div></div></li>      <li>       <p>使用音频流。</p>       <p>录制音频流中包含以下接口，用来实现对音频流的控制。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.3.1.3.1.1" valign="top" width="50%">接口</th>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.3.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioCapturer_Start(OH_AudioCapturer* capturer)</td>           <td class="cellrowborder" valign="top" width="50%">开始录制。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioCapturer_Pause(OH_AudioCapturer* capturer)</td>           <td class="cellrowborder" valign="top" width="50%">暂停录制。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioCapturer_Stop(OH_AudioCapturer* capturer)</td>           <td class="cellrowborder" valign="top" width="50%">停止录制。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioCapturer_Flush(OH_AudioCapturer* capturer)</td>           <td class="cellrowborder" valign="top" width="50%">释放缓存数据。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioCapturer_Release(OH_AudioCapturer* capturer)</td>           <td class="cellrowborder" valign="top" width="50%">释放录制实例。</td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p>释放构造器。</p>       <p>构造器不再使用时，需要释放相关资源。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="设置低时延模式">设置低时延模式<i class="anchor-icon anchor-icon-link" anchorid="设置低时延模式" tips="复制节点链接"></i></h3>          <p>当设备支持低时延通路时，开发者可以使用低时延模式创建音频录制构造器，获得更低时延的音频体验。</p>     <p>开发流程与普通录制（<a href="/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-recording#实现音频录制">实现音频录制</a>）场景一致，仅需要在步骤1创建音频录制构造器时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setlatencymode" target="_blank">OH_AudioStreamBuilder_SetLatencyMode()</a>设置低时延模式。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>当音频录制场景<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_sourcetype" target="_blank">OH_AudioStream_SourceType</a>为AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION时，不支持主动设置低时延模式，系统会根据设备的能力，决策输出的音频通路。</li>        <li>部分场景（如通话来电）下系统能力受限会回落至普通音频通路模式，缓冲区大小也会发生变化，此时应同普通音频通路模式一样根据缓冲区大小将缓冲区中数据一次性全部取走，否则录制的数据会出现不连续，导致杂音。</li>       </ul>      </div></div></div>     <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStream_LatencyMode latencyMode = AUDIOSTREAM_LATENCY_MODE_FAST;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetLatencyMode</span>(builder, latencyMode);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置静音打断模式">设置静音打断模式<i class="anchor-icon anchor-icon-link" anchorid="设置静音打断模式" tips="复制节点链接"></i></h3>          <p>静音打断模式提供将打断策略从停止录音切换为静音录制的功能，可以实现录音全程不被系统基于焦点并发规则打断的效果，并且录音过程中也不影响其他应用启动录音。开发者在创建音频录制构造器时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setcapturerwillmutewheninterrupted" target="_blank">OH_AudioStreamBuilder_SetCapturerWillMuteWhenInterrupted</a>接口设置是否开启静音打断模式。默认不开启，此时由音频焦点策略管理并发音频流的执行顺序。开启后，被其他应用打断导致停止或暂停录制时会进入静音录制状态，在此状态下录制的音频没有声音。</p>    </div>    <div class="tiledSection">     <h3 id="回声消除功能">回声消除功能<i class="anchor-icon anchor-icon-link" anchorid="回声消除功能" tips="复制节点链接"></i></h3>          <p>回声消除功能可在支持的设备上有效消除录音过程中的回声干扰，提升音频采集质量。开发者可通过指定特定的音频输入源类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_sourcetype" target="_blank">OH_AudioStream_SourceType</a>（AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION、AUDIOSTREAM_SOURCE_TYPE_LIVE）来启用该功能，系统将会自动对采集的音频信号进行回声消除处理。</p>     <p>在启用前，建议先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audio-stream-manager-h#oh_audiostreammanager_isacousticechocancelersupported" target="_blank">OH_AudioStreamManager_IsAcousticEchoCancelerSupported</a>接口（从API version 20开始支持）查询当前设备对音频输入源类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_sourcetype" target="_blank">OH_AudioStream_SourceType</a>是否支持回声消除功能，以确保功能的可用性。若支持，则可在创建音频录制构造器时通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setcapturerinfo" target="_blank">OH_AudioStreamBuilder_SetCapturerInfo</a> 设置相应的音频输入源类型，从而激活回声消除处理流程。</p>    </div>    <div class="tiledSection">     <h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2>          <p>从API version 12开始<strong>不再推荐</strong>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiocapturer-callbacks-struct" target="_blank">OH_AudioCapturer_Callbacks</a>的方式设置音频回调函数。若必须使用，需要注意在设置音频回调函数时，通过下面两种方式中的任意一种来设置音频回调函数，避免不可预期的行为。</p>     <ul>      <li>       <p>方式1：请确保<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiocapturer-callbacks-struct" target="_blank">OH_AudioCapturer_Callbacks</a>的每一个回调都被<strong>自定义的回调方法</strong>或<strong>空指针</strong>初始化。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义读入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnReadData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* buffer,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> length)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 从buffer中取出length长度的录音数据。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新录制器状态和界面。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>OH_AudioCapturer_Callbacks callbacks;</li><li>
</li><li><span class="hljs-comment">// 配置回调函数，如果需要监听，则赋值。</span></li><li>callbacks.OH_AudioCapturer_OnReadData = MyOnReadData;</li><li>callbacks.OH_AudioCapturer_OnInterruptEvent = MyOnInterruptEvent;</li><li>
</li><li><span class="hljs-comment">// （必选）如果不需要监听，使用空指针初始化。</span></li><li>callbacks.OH_AudioCapturer_OnStreamEvent = <span class="hljs-literal">nullptr</span>;</li><li>callbacks.OH_AudioCapturer_OnError = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div></li>      <li>       <p>方式2：使用前，初始化并清零结构体。</p>       <div _ngcontent-msd-c106="" class="highlight-div"><div _ngcontent-msd-c106="" class="highlight-div-header"><div _ngcontent-msd-c106="" class="highlight-div-header-left"><div _ngcontent-msd-c106="" class="handle-button expand-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-msd-c106="" class="highlight-div-header-right"><div _ngcontent-msd-c106="" class="handle-button ai-button"></div><div _ngcontent-msd-c106="" class="handle-button line-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-msd-c106="" class="handle-button theme-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-msd-c106="" class="handle-button copy-button"><div _ngcontent-msd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-msd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义读入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnReadData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* buffer,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> length)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 从buffer中取出length长度的录音数据。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioCapturer* capturer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新录制器状态和界面。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>OH_AudioCapturer_Callbacks callbacks;</li><li>
</li><li><span class="hljs-comment">// 使用前，初始化并清零结构体。</span></li><li><span class="hljs-built_in">memset</span>(&amp;callbacks, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(OH_AudioCapturer_Callbacks));</li><li>
</li><li><span class="hljs-comment">// 配置需要的回调函数。</span></li><li>callbacks.OH_AudioCapturer_OnReadData = MyOnReadData;</li><li>callbacks.OH_AudioCapturer_OnInterruptEvent = MyOnInterruptEvent;</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/audio-native" target="_blank">音频低时延录制与播放</a></li>     </ul>    </div>   </div>   <div></div></div>