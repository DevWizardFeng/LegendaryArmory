<h1 _ngcontent-ais-c119="" class="doc-title ng-star-inserted" title="使用OHAudio开发音频播放功能(C/C++)"> 使用OHAudio开发音频播放功能(C/C++) </h1>

<div _ngcontent-ais-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>OHAudio是系统在API version 10中引入的一套C API，此API在设计上实现归一，同时支持普通音频通路和低时延通路。仅支持PCM格式，适用于依赖Native层实现音频输出功能的场景。</p>    <p>OHAudio音频播放状态变化示意图：</p>    <p><span><img originheight="705" originwidth="882" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114426.79733645101756775518586725117822:50001231000000:2800:412175A80BD1ED52C28F90F9CA6A2FA505E34AC4DC52470278061F4616878491.png" width="882" height="705"></span></p>    <div class="tiledSection">     <h2 id="使用入门">使用入门<i class="anchor-icon anchor-icon-link" anchorid="使用入门" tips="复制节点链接"></i></h2>          <p>开发者要使用OHAudio提供的播放能力，需要添加对应的头文件。</p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libohaudio.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="添加头文件">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="添加头文件" tips="复制节点链接"></i></h3>          <p>开发者通过引入&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h" target="_blank">native_audiostreambuilder.h</a>&gt;和&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h" target="_blank">native_audiorenderer.h</a>&gt;头文件，使用音频播放相关API。</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiorenderer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audiostreambuilder.h&gt;</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio" target="_blank">OHAudio</a>。</p>    </div>    <div class="tiledSection">     <h3 id="音频流构造器" class="firsth2">音频流构造器<i class="anchor-icon anchor-icon-link" anchorid="音频流构造器" tips="复制节点链接"></i></h3>          <p>OHAudio提供OH_AudioStreamBuilder接口，遵循构造器设计模式，用于构建音频流。开发者需要根据业务场景，指定对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_type" target="_blank">OH_AudioStream_Type</a>。</p>     <p>OH_AudioStream_Type包含两种类型：</p>     <ul>      <li>AUDIOSTREAM_TYPE_RENDERER</li>      <li>AUDIOSTREAM_TYPE_CAPTURER</li>     </ul>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_create" target="_blank">OH_AudioStreamBuilder_Create</a>创建构造器示例：</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStreamBuilder* builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, streamType);</li></ol></pre></div></div>     <p>在音频业务结束之后，开发者应该执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_destroy" target="_blank">OH_AudioStreamBuilder_Destroy</a>接口来销毁构造器。</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li></ol></pre></div></div>     <p>开发者可以通过以下几个步骤来实现一个简单的播放功能。</p>    </div>    <div class="tiledSection">     <h3 id="实现音频播放">实现音频播放<i class="anchor-icon anchor-icon-link" anchorid="实现音频播放" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>创建构造器。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioStreamBuilder* builder;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_Create</span>(&amp;builder, AUDIOSTREAM_TYPE_RENDERER);</li></ol></pre></div></div></li>      <li>       <p>配置音频流参数。</p>       <p>关于音频采样率可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-audiorenderer-for-playback#配置合适的音频采样率">配置合适的音频采样率</a>。</p>       <p>创建音频播放构造器后，可以设置音频流所需要的参数，可以参考下面的案例。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置音频采样率。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSamplingRate</span>(builder, <span class="hljs-number">48000</span>);</li><li><span class="hljs-comment">// 设置音频声道。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelCount</span>(builder, <span class="hljs-number">2</span>);</li><li><span class="hljs-comment">// 设置音频采样格式。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetSampleFormat</span>(builder, AUDIOSTREAM_SAMPLE_S16LE);</li><li><span class="hljs-comment">// 设置音频流的编码类型。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetEncodingType</span>(builder, AUDIOSTREAM_ENCODING_TYPE_RAW);</li><li><span class="hljs-comment">// 设置输出音频流的工作场景。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererInfo</span>(builder, AUDIOSTREAM_USAGE_MUSIC);</li></ol></pre></div></div>       <p>注意，播放的音频数据要通过回调接口写入，开发者要实现回调接口，从API version 12开始支持使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setrendererwritedatacallback" target="_blank">OH_AudioStreamBuilder_SetRendererWriteDataCallback</a>设置数据回调函数。数据回调函数的声明请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiorenderer_onwritedatacallback" target="_blank">OH_AudioRenderer_OnWriteDataCallback</a>。</p></li>      <li>       <p>设置音频回调函数。</p>       <p>多音频并发处理可参考文档<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency">处理音频焦点事件</a>，仅接口语言差异。</p>       <ul>        <li>         <p>从API version 12开始<strong>推荐</strong>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiorenderer_onwritedatacallback" target="_blank">OH_AudioRenderer_OnWriteDataCallback</a>用于写入音频数据。</p>         <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">           <ul>            <li>             <p>能填满回调所需长度数据的情况下，返回AUDIO_DATA_CALLBACK_RESULT_VALID，系统会取用完整长度的数据缓冲进行播放。请不要在未填满数据的情况下返回AUDIO_DATA_CALLBACK_RESULT_VALID，否则会导致杂音、卡顿等现象。</p></li>            <li>             <p>在无法填满回调所需长度数据的情况下，建议开发者返回AUDIO_DATA_CALLBACK_RESULT_INVALID，系统不会处理该段音频数据，然后会再次向应用请求数据，确认数据填满后返回AUDIO_DATA_CALLBACK_RESULT_VALID。</p></li>            <li>             <p>回调函数结束后，音频服务会把缓冲中数据放入队列里等待播放，因此请勿在回调外再次更改缓冲中的数据。对于最后一帧，如果数据不够填满缓冲长度，开发者需要使用剩余数据拼接空数据的方式，将缓冲填满，避免缓冲内的历史脏数据对播放效果产生不良的影响。</p></li>           </ul>          </div></div></div></li>        <li>         <p>从API version 12开始可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setframesizeincallback" target="_blank">OH_AudioStreamBuilder_SetFrameSizeInCallback</a>设置audioDataSize的大小。</p></li>       </ul>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义写入数据函数。</span></li><li><span class="hljs-function">OH_AudioData_Callback_Result <span class="hljs-title">MyOnWriteData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* audioData,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> audioDataSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的数据，按audioDataSize长度写入audioData。</span></li><li>    <span class="hljs-comment">// 如果开发者不希望播放某段audioData，返回AUDIO_DATA_CALLBACK_RESULT_INVALID即可。</span></li><li>    <span class="hljs-keyword">return</span> AUDIO_DATA_CALLBACK_RESULT_VALID;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新播放器状态和界面。</span></li><li>}</li><li><span class="hljs-comment">// 自定义异常回调函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MyOnError</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioStream_Result error)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据error表示的音频异常信息，做出相应的处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 配置音频中断事件回调函数。</span></li><li>OH_AudioRenderer_OnInterruptCallback OnIntereruptCb = MyOnInterruptEvent;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererInterruptCallback</span>(builder, OnIntereruptCb, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li><span class="hljs-comment">// 配置音频异常回调函数。</span></li><li>OH_AudioRenderer_OnErrorCallback OnErrorCb = MyOnError;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererErrorCallback</span>(builder, OnErrorCb, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li><span class="hljs-comment">// 配置写入音频数据回调函数。</span></li><li>OH_AudioRenderer_OnWriteDataCallback writeDataCb = MyOnWriteData;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetRendererWriteDataCallback</span>(builder, writeDataCb, <span class="hljs-literal">nullptr</span>);</li></ol></pre></div></div></li>      <li>       <p>构造播放音频流。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AudioRenderer* audioRenderer;</li><li><span class="hljs-built_in">OH_AudioStreamBuilder_GenerateRenderer</span>(builder, &amp;audioRenderer);</li></ol></pre></div></div></li>      <li>       <p>使用音频流。</p>       <p>音频流中包含以下接口，用来实现对音频流的控制。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.3.1.3.1.1" valign="top" width="50%">接口</th>           <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.3.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioRenderer_Start(OH_AudioRenderer* renderer)</td>           <td class="cellrowborder" valign="top" width="50%">开始播放。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioRenderer_Pause(OH_AudioRenderer* renderer)</td>           <td class="cellrowborder" valign="top" width="50%">暂停播放。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioRenderer_Stop(OH_AudioRenderer* renderer)</td>           <td class="cellrowborder" valign="top" width="50%">停止播放。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioRenderer_Flush(OH_AudioRenderer* renderer)</td>           <td class="cellrowborder" valign="top" width="50%">释放缓存数据。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AudioStream_Result OH_AudioRenderer_Release(OH_AudioRenderer* renderer)</td>           <td class="cellrowborder" valign="top" width="50%">释放播放实例。</td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p>释放构造器。</p>       <p>构造器不再使用时，需要释放相关资源。</p>       <p>应用需根据实际业务需求合理使用构造器，按需创建并及时释放，避免占用过多音频资源导致异常。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_Destroy</span>(builder);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="设置音频流音量">设置音频流音量<i class="anchor-icon anchor-icon-link" anchorid="设置音频流音量" tips="复制节点链接"></i></h3>          <p>开发者可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_setvolume" target="_blank">OH_AudioRenderer_SetVolume</a>接口设置当前音频流音量值。</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 要设置的音量值，音量值的范围是[0.0, 1.0]。</span></li><li><span class="hljs-type">float</span> volume = <span class="hljs-number">0.5f</span>;</li><li>
</li><li><span class="hljs-comment">// 设置当前音频流音量值。</span></li><li><span class="hljs-function">OH_AudioStream_Result <span class="hljs-title">OH_AudioRenderer_SetVolume</span><span class="hljs-params">(audioRenderer, volume)</span></span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置低时延模式">设置低时延模式<i class="anchor-icon anchor-icon-link" anchorid="设置低时延模式" tips="复制节点链接"></i></h3>          <p>当设备支持低时延通路且采样率设置为48000Hz时，开发者可以使用低时延模式创建播放器，获得更高质量的音频体验。</p>     <p>开发流程与普通播放（<a href="/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback#实现音频播放">实现音频播放</a>）场景一致，仅需要在步骤1创建音频流构造器时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setlatencymode" target="_blank">OH_AudioStreamBuilder_SetLatencyMode()</a>设置低时延模式。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>当音频录制场景<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_usage" target="_blank">OH_AudioStream_Usage</a>为AUDIOSTREAM_USAGE_VOICE_COMMUNICATION和AUDIOSTREAM_USAGE_VIDEO_COMMUNICATION时，不支持主动设置低时延模式，系统会根据设备的能力，决策输出的音频通路。</li>        <li>低时延通路对于数据处理性能要求较高，应用数据生成缓慢时容易导致卡顿。普通音乐、视频播放场景下不建议设置该模式，仅推荐游戏、K歌等对时延敏感的应用设置低时延模式。</li>       </ul>      </div></div></div>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetLatencyMode</span>(builder, AUDIOSTREAM_LATENCY_MODE_FAST);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置音频声道布局">设置音频声道布局<i class="anchor-icon anchor-icon-link" anchorid="设置音频声道布局" tips="复制节点链接"></i></h3>          <p>播放音频文件时，可以通过设置音频的声道布局信息，指定渲染或播放时的扬声器摆位，使得渲染和播放效果更佳，获得更高质量的音频体验。</p>     <p>开发流程与普通播放（<a href="/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback#实现音频播放">实现音频播放</a>）场景一致，仅需要在步骤1创建音频流构造器时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setchannellayout" target="_blank">OH_AudioStreamBuilder_SetChannelLayout()</a>设置声道布局信息。</p>     <p>当声道布局与声道数不匹配时，创建音频流会失败。建议在设置声道布局时，确认下发的声道布局信息是否正确。</p>     <p>如果不知道准确的声道布局信息，或者开发者需要使用默认声道布局，可以不调用设置声道布局接口，或者下发CH_LAYOUT_UNKNOWN，以使用基于声道数的默认声道布局。</p>     <p>对于HOA（高阶立体环绕声）格式的音频，想要获得正确的渲染和播放效果，必须指定声道布局信息。</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetChannelLayout</span>(builder, CH_LAYOUT_STEREO);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="播放audio-vivid格式音源">播放Audio Vivid格式音源<i class="anchor-icon anchor-icon-link" anchorid="播放audio-vivid格式音源" tips="复制节点链接"></i></h3>          <p>播放Audio Vivid（菁彩三维声）格式音频文件时，需要使用与普通播放不同的数据写入回调函数，该回调可以同时写入PCM（脉冲编码调制）数据与元数据。</p>     <p>开发流程与普通播放（<a href="/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback#实现音频播放">实现音频播放</a>）场景一致，仅需要在步骤1创建音频流构造器时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setwritedatawithmetadatacallback" target="_blank">OH_AudioStreamBuilder_SetWriteDataWithMetadataCallback()</a>设置PCM数据与元数据同时写入的回调函数，同时调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setencodingtype" target="_blank">OH_AudioStreamBuilder_SetEncodingType()</a>设置编码类型为AUDIOSTREAM_ENCODING_TYPE_AUDIOVIVID。</p>     <p>在播放Audio Vivid时，帧长是固定的，不可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostreambuilder-h#oh_audiostreambuilder_setframesizeincallback" target="_blank">OH_AudioStreamBuilder_SetFrameSizeInCallback()</a>设置回调帧长。同时，在设置播放声道数和声道布局时，需要将写入音源的声床数和对象数相加后进行设置。</p>     <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义同时写入PCM数据和元数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnWriteDataWithMetadata</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* audioData,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> audioDataSize,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* metadata,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> metadataSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的PCM数据和元数据，分别按audioDataSize和metadataSize写入buffer。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置编码类型。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetEncodingType</span>(builder, AUDIOSTREAM_ENCODING_TYPE_AUDIOVIVID);</li><li><span class="hljs-comment">// 配置回调函数。</span></li><li>OH_AudioRenderer_WriteDataWithMetadataCallback metadataCallback = MyOnWriteDataWithMetadata;</li><li><span class="hljs-comment">// 设置同时写入PCM数据和元数据的回调。</span></li><li><span class="hljs-built_in">OH_AudioStreamBuilder_SetWriteDataWithMetadataCallback</span>(builder, metadataCallback, <span class="hljs-literal">nullptr</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2>          <p>从API version 12开始<strong>不再推荐</strong>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiorenderer-callbacks-struct" target="_blank">OH_AudioRenderer_Callbacks</a>的方式设置音频回调函数。若必须使用，需要注意在设置音频回调函数时，通过下面两种方式中的任意一种来设置音频回调函数，避免不可预期的行为。</p>     <ul>      <li>       <p>方式1：请确保<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiorenderer-callbacks-struct" target="_blank">OH_AudioRenderer_Callbacks</a>的每一个回调都被<strong>自定义的回调方法</strong>或<strong>空指针</strong>初始化。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义写入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnWriteData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* buffer,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> length)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的数据，按length长度写入buffer。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新播放器状态和界面。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li>OH_AudioRenderer_Callbacks callbacks;</li><li>
</li><li><span class="hljs-comment">// 配置回调函数，如果需要监听，则赋值。</span></li><li>callbacks.OH_AudioRenderer_OnWriteData = MyOnWriteData;</li><li>callbacks.OH_AudioRenderer_OnInterruptEvent = MyOnInterruptEvent;</li><li>
</li><li><span class="hljs-comment">// （必选）无触发回调场景，使用空指针初始化。从API version 11开始，开发者如果需要监听设备变化，可直接使用OH_AudioRenderer_OutputDeviceChangeCallback替代。</span></li><li>callbacks.OH_AudioRenderer_OnStreamEvent = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// （必选）如果不需要监听，使用空指针初始化。</span></li><li>callbacks.OH_AudioRenderer_OnError = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div></li>      <li>       <p>方式2：使用前，初始化并清零结构体。</p>       <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义写入数据函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnWriteData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* buffer,</span></li><li><span class="hljs-function">    <span class="hljs-type">int32_t</span> length)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 将待播放的数据，按length长度写入buffer。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li><span class="hljs-comment">// 自定义音频中断事件函数。</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">MyOnInterruptEvent</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    OH_AudioRenderer* renderer,</span></li><li><span class="hljs-function">    <span class="hljs-type">void</span>* userData,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_ForceType type,</span></li><li><span class="hljs-function">    OH_AudioInterrupt_Hint hint)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 根据type和hint表示的音频中断信息，更新播放器状态和界面。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>OH_AudioRenderer_Callbacks callbacks;</li><li>
</li><li><span class="hljs-comment">// 使用前，初始化并清零结构体。</span></li><li><span class="hljs-built_in">memset</span>(&amp;callbacks, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(OH_AudioRenderer_Callbacks));</li><li>
</li><li><span class="hljs-comment">// 配置需要的回调函数。</span></li><li>callbacks.OH_AudioRenderer_OnWriteData = MyOnWriteData;</li><li>callbacks.OH_AudioRenderer_OnInterruptEvent = MyOnInterruptEvent;</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/audio-native" target="_blank">音频低时延录制与播放</a></li>     </ul>    </div>   </div>   <div></div></div>