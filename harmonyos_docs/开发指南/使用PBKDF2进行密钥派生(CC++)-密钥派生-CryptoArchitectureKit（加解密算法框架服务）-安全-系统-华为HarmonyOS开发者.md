<h1 _ngcontent-ujv-c119="" class="doc-title ng-star-inserted" title="使用PBKDF2进行密钥派生(C/C++)"> 使用PBKDF2进行密钥派生(C/C++) </h1>

<div _ngcontent-ujv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对应的算法规格请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-key-derivation-overview#pbkdf2算法">密钥派生算法规格：PBKDF2</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_create" target="_blank">OH_CryptoKdfParams_Create</a>，指定字符串参数'PBKDF2'，创建密钥派生参数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_setparam" target="_blank">OH_CryptoKdfParams_SetParam</a>，设置PBKDF2所需的参数。示例如下：</p>       <ul>        <li>CRYPTO_KDF_KEY_DATABLOB：用于生成派生密钥的原始密码。</li>        <li>CRYPTO_KDF_SALT_DATABLOB：盐值。</li>        <li>CRYPTO_KDF_ITER_COUNT_INT：重复运算的次数，需要为正整数。</li>       </ul></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_create" target="_blank">OH_CryptoKdf_Create</a>，指定字符串参数'PBKDF2|SHA256'，创建密钥派生函数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_derive" target="_blank">OH_CryptoKdf_Derive</a>，指定目标密钥的字节长度，进行密钥派生。</p></li>     </ol>     <div _ngcontent-ujv-c106="" class="highlight-div"><div _ngcontent-ujv-c106="" class="highlight-div-header"><div _ngcontent-ujv-c106="" class="highlight-div-header-left"><div _ngcontent-ujv-c106="" class="handle-button expand-button"><div _ngcontent-ujv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ujv-c106="" class="highlight-div-header-right"><div _ngcontent-ujv-c106="" class="handle-button ai-button"></div><div _ngcontent-ujv-c106="" class="handle-button line-button"><div _ngcontent-ujv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ujv-c106="" class="handle-button theme-button"><div _ngcontent-ujv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ujv-c106="" class="handle-button copy-button"><div _ngcontent-ujv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ujv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestPbkdf2</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建PBKDF2参数对象。</span></li><li>    OH_CryptoKdfParams *params = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoKdfParams_Create</span>(<span class="hljs-string">"PBKDF2"</span>, &amp;params);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置密码。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *password = <span class="hljs-string">"123456"</span>;</li><li>    Crypto_DataBlob passwordBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(password)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(password)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_KEY_DATABLOB, &amp;passwordBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置盐值。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *salt = <span class="hljs-string">"saltstring"</span>;</li><li>    Crypto_DataBlob saltBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(salt)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(salt)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SALT_DATABLOB, &amp;saltBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置迭代次数。</span></li><li>    <span class="hljs-type">int</span> iterations = <span class="hljs-number">10000</span>;</li><li>    Crypto_DataBlob iterationsBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(&amp;iterations),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_ITER_COUNT_INT, &amp;iterationsBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建密钥派生函数对象。</span></li><li>    OH_CryptoKdf *kdfCtx = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Create</span>(<span class="hljs-string">"PBKDF2|SHA256"</span>, &amp;kdfCtx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 派生密钥。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">uint32_t</span> keyLength = <span class="hljs-number">32</span>; <span class="hljs-comment">// 生成32字节的密钥。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Derive</span>(kdfCtx, params, keyLength, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Derived key length: %u\n"</span>, out.len);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>    <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>