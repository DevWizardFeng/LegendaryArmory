<h1 _ngcontent-fuh-c119="" class="doc-title ng-star-inserted" title="使用PixelMap完成位图操作"> 使用PixelMap完成位图操作 </h1>

<div _ngcontent-fuh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当需要对目标图片中的部分区域进行处理时，可以使用位图操作功能。此功能常用于图片美化等操作。</p>    <p>如下图所示，一张图片中，将指定的矩形区域像素数据读取出来，进行修改后，再写回原图片对应区域。</p>    <p><strong>图1</strong> 位图操作示意图</p>    <p><span><img originheight="877" originwidth="1081" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114447.55064926892153155215356235434814:50001231000000:2800:C8BEE1FC0EA86D35B5BB3946CE3DD9C425D44F61EF37956A9EE86FCE5BB05973.png" width="920" height="746.3829787234042"></span></p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>位图操作相关API的详细介绍请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">API参考</a>。</p>     <ol>      <li>       <p>完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-decoding">图片解码</a>，获取PixelMap位图对象。</p></li>      <li>       <p>从PixelMap位图对象中获取信息。</p>       <div _ngcontent-fuh-c106="" class="highlight-div"><div _ngcontent-fuh-c106="" class="highlight-div-header"><div _ngcontent-fuh-c106="" class="highlight-div-header-left"><div _ngcontent-fuh-c106="" class="handle-button expand-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuh-c106="" class="highlight-div-header-right"><div _ngcontent-fuh-c106="" class="handle-button ai-button"></div><div _ngcontent-fuh-c106="" class="handle-button line-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuh-c106="" class="handle-button theme-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuh-c106="" class="handle-button copy-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// 获取图像像素的总字节数。</span></li><li><span class="hljs-keyword">let</span> pixelBytesNumber : <span class="hljs-built_in">number</span> = pixelMap.<span class="hljs-title function_">getPixelBytesNumber</span>();</li><li><span class="hljs-comment">// 获取图像像素每行字节数。</span></li><li><span class="hljs-keyword">let</span> rowBytes : <span class="hljs-built_in">number</span> = pixelMap.<span class="hljs-title function_">getBytesNumberPerRow</span>();</li><li><span class="hljs-comment">// 获取当前图像像素密度。像素密度是指每英寸图片所拥有的像素数量。像素密度越大，图片越精细。</span></li><li><span class="hljs-keyword">let</span> density : <span class="hljs-built_in">number</span> = pixelMap.<span class="hljs-title function_">getDensity</span>();</li></ol></pre></div></div></li>      <li>       <p>读取并修改目标区域像素数据，写回原图。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>建议readPixelsToBuffer和writeBufferToPixels成对使用，readPixels和writePixels成对使用，避免因图像像素格式不一致，造成PixelMap图像出现异常。</p>        </div></div></div>       <div _ngcontent-fuh-c106="" class="highlight-div"><div _ngcontent-fuh-c106="" class="highlight-div-header"><div _ngcontent-fuh-c106="" class="highlight-div-header-left"><div _ngcontent-fuh-c106="" class="handle-button expand-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuh-c106="" class="highlight-div-header-right"><div _ngcontent-fuh-c106="" class="handle-button ai-button"></div><div _ngcontent-fuh-c106="" class="handle-button line-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuh-c106="" class="handle-button theme-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuh-c106="" class="handle-button copy-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// 场景一：读取并修改整张图片数据。</span></li><li><span class="hljs-comment">// 按照PixelMap的像素格式，读取PixelMap的图像像素数据，并写入缓冲区中。</span></li><li><span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(pixelBytesNumber);</li><li>pixelMap.<span class="hljs-title function_">readPixelsToBuffer</span>(buffer).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in reading image pixel data.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to read image pixel data. The error is: '</span> + error);</li><li>})</li><li><span class="hljs-comment">// 按照PixelMap的像素格式，读取缓冲区中的图像像素数据，并写入PixelMap。</span></li><li>pixelMap.<span class="hljs-title function_">writeBufferToPixels</span>(buffer).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in writing image pixel data.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to write image pixel data. The error is: '</span> + error);</li><li>})</li><li>
</li><li><span class="hljs-comment">// 场景二：读取并修改指定区域内的图片数据。</span></li><li><span class="hljs-comment">// 固定按照BGRA_8888格式，读取PixelMap指定区域内的图像像素数据，并写入PositionArea.pixels缓冲区中，该区域由PositionArea.region指定。</span></li><li><span class="hljs-keyword">const</span> area : image.<span class="hljs-property">PositionArea</span> = {</li><li>  <span class="hljs-attr">pixels</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>),</li><li>  <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,</li><li>  <span class="hljs-attr">stride</span>: <span class="hljs-number">8</span>,</li><li>  <span class="hljs-attr">region</span>: { <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">2</span> }, <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }</li><li>}</li><li>pixelMap.<span class="hljs-title function_">readPixels</span>(area).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in reading the image data in the area.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to read the image data in the area. The error is: '</span> + error);</li><li>})</li><li><span class="hljs-comment">// 固定按照BGRA_8888格式，读取PositionArea.pixels缓冲区中的图像像素数据，并写入PixelMap指定区域内，该区域由PositionArea.region指定。</span></li><li>pixelMap.<span class="hljs-title function_">writePixels</span>(area).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in writing the image data in the area.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to write the image data in the area. The error is: '</span> + error);</li><li>})</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发示例-复制深拷贝新的pixelmap">开发示例-复制（深拷贝）新的PixelMap<i class="anchor-icon anchor-icon-link" anchorid="开发示例-复制深拷贝新的pixelmap" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-decoding">图片解码</a>，获取PixelMap位图对象。</p></li>      <li>       <p>复制（深拷贝）一个新的PixelMap。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>创建新PixelMap时，必须将srcPixelFormat指定为原PixelMap的像素格式，否则新PixelMap的图像会出现异常。</p>        </div></div></div>       <div _ngcontent-fuh-c106="" class="highlight-div"><div _ngcontent-fuh-c106="" class="highlight-div-header"><div _ngcontent-fuh-c106="" class="highlight-div-header-left"><div _ngcontent-fuh-c106="" class="handle-button expand-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fuh-c106="" class="highlight-div-header-right"><div _ngcontent-fuh-c106="" class="handle-button ai-button"></div><div _ngcontent-fuh-c106="" class="handle-button line-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fuh-c106="" class="handle-button theme-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fuh-c106="" class="handle-button copy-button"><div _ngcontent-fuh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fuh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  复制（深拷贝）一个新的PixelMap</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">pixelMap</span> - 被复制的PixelMap。</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">desiredPixelFormat</span> - 新PixelMap的像素格式。如果不指定，则仍使用原PixelMap的像素格式。</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> 新PixelMap。</span></li><li><span class="hljs-comment"> **/</span></li><li><span class="hljs-title function_">clonePixelMap</span>(<span class="hljs-attr">pixelMap</span>: <span class="hljs-title class_">PixelMap</span>, desiredPixelFormat?: image.<span class="hljs-property">PixelMapFormat</span>): <span class="hljs-title class_">PixelMap</span> {</li><li>  <span class="hljs-comment">// 获取当前PixelMap的图片信息。</span></li><li>  <span class="hljs-keyword">const</span> imageInfo = pixelMap.<span class="hljs-title function_">getImageInfoSync</span>();</li><li>  <span class="hljs-comment">// 读取当前PixelMap的图像像素数据，并按照当前PixelMap的像素格式写入缓冲区数组。</span></li><li>  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(pixelMap.<span class="hljs-title function_">getPixelBytesNumber</span>());</li><li>  pixelMap.<span class="hljs-title function_">readPixelsToBufferSync</span>(buffer);</li><li>  <span class="hljs-comment">// 根据当前PixelMap的图片信息，生成初始化选项。</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: image.<span class="hljs-property">InitializationOptions</span> = {</li><li>    <span class="hljs-comment">// 当前PixelMap的像素格式。</span></li><li>    <span class="hljs-attr">srcPixelFormat</span>: imageInfo.<span class="hljs-property">pixelFormat</span>,</li><li>    <span class="hljs-comment">// 新PixelMap的像素格式。</span></li><li>    <span class="hljs-attr">pixelFormat</span>: desiredPixelFormat ?? imageInfo.<span class="hljs-property">pixelFormat</span>,</li><li>    <span class="hljs-comment">// 当前PixelMap的尺寸大小。</span></li><li>    <span class="hljs-attr">size</span>: imageInfo.<span class="hljs-property">size</span></li><li>  };</li><li>  <span class="hljs-comment">// 根据初始化选项和缓冲区数组，生成新PixelMap。</span></li><li>  <span class="hljs-keyword">return</span> image.<span class="hljs-title function_">createPixelMapSync</span>(buffer, options);</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/image-depth-copy" target="_blank">PixelMap深拷贝案例</a></li>     </ul>    </div>   </div>   <div></div></div>