<h1 _ngcontent-jcr-c119="" class="doc-title ng-star-inserted" title="使用RSA非对称密钥分段加解密(C/C++)"> 使用RSA非对称密钥分段加解密(C/C++) </h1>

<div _ngcontent-jcr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对应的算法规格请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-encrypt-decrypt-spec#rsa">非对称密钥加解密算法规格：RSA</a>。</p>    <p><strong>加密</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-key-h#oh_cryptoasymkeygenerator_create" target="_blank">OH_CryptoAsymKeyGenerator_Create</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-key-h#oh_cryptoasymkeygenerator_generate" target="_blank">OH_CryptoAsymKeyGenerator_Generate</a>，生成RSA密钥类型为RSA1024、素数个数为2的非对称密钥对（keyPair）。keyPair对象中包括公钥PubKey、私钥PriKey。</p>      <p>如何生成RSA非对称密钥对，开发者可参考下文示例，并结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-key-generation-conversion-spec#rsa">非对称密钥生成和转换规格：RSA</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-generate-asym-key-pair-randomly">随机生成非对称密钥对</a>理解。参考文档与当前示例可能存在入参差异，请在阅读时注意区分。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_create" target="_blank">OH_CryptoAsymCipher_Create</a>，指定字符串参数'RSA1024|PKCS1'，创建非对称密钥类型为RSA1024、填充模式为PKCS1的Cipher实例，用于完成加解密操作。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_init" target="_blank">OH_CryptoAsymCipher_Init</a>，设置模式为加密（CRYPTO_ENCRYPT_MODE），指定加密密钥（keyPair），初始化加密Cipher实例。</p></li>     <li>      <p>多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_final" target="_blank">OH_CryptoAsymCipher_Final</a>，传入明文，获取加密后的数据。</p>      <ul>       <li>        <p>OH_CryptoAsymCipher_Final输出结果可能为NULL，在访问具体数据前，需要先判断结果是否为NULL，避免产生异常。</p></li>       <li>        <p>此处将明文按64个字节一组拆分，多次加密。使用1024位密钥，每次将生成128字节密文。</p>        <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">          <p>非对称密钥的分段加解密是指当明文大于单次加解密支持的数据长度时，需要将待加解密数据分为合适长度的数据段，并对每个数据段执行加解密操作。详细介绍可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-encrypt-decrypt-by-segment#非对称加解密">非对称分段加解密介绍</a>。</p>         </div></div></div></li>      </ul></li>    </ol>    <p><strong>解密</strong></p>    <ol>     <li>      <p>由于RSA算法的Cipher实例不支持重复init操作，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_create" target="_blank">OH_CryptoAsymCipher_Create</a>，重新生成Cipher实例。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_init" target="_blank">OH_CryptoAsymCipher_Init</a>，设置模式为解密（CRYPTO_DECRYPT_MODE），指定解密密钥（keyPair）初始化解密Cipher实例。</p></li>     <li>      <p>多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptoasymcipher_final" target="_blank">OH_CryptoAsymCipher_Final</a>，传入密文，获取解密后的数据。</p></li>    </ol>    <ul>     <li>异步方法示例：</li>    </ul>    <div _ngcontent-jcr-c106="" class="highlight-div"><div _ngcontent-jcr-c106="" class="highlight-div-header"><div _ngcontent-jcr-c106="" class="highlight-div-header-left"><div _ngcontent-jcr-c106="" class="handle-button expand-button"><div _ngcontent-jcr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jcr-c106="" class="highlight-div-header-right"><div _ngcontent-jcr-c106="" class="handle-button ai-button"></div><div _ngcontent-jcr-c106="" class="handle-button line-button"><div _ngcontent-jcr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jcr-c106="" class="handle-button theme-button"><div _ngcontent-jcr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jcr-c106="" class="handle-button copy-button"><div _ngcontent-jcr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jcr-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">algorithm</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">vector</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">string</span>&gt;</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">doTestRsaEnc</span>(<span class="hljs-variable">OH_CryptoKeyPair</span> <span class="hljs-variable">*keyPair</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; &amp;<span class="hljs-title class_">plainText</span>)</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">cipherText</span>;</li><li>    <span class="hljs-variable">OH_CryptoAsymCipher</span> *<span class="hljs-variable">cipher</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_Crypto_ErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Create</span>(<span class="hljs-string">"RSA1024|PKCS1"</span>, &amp;<span class="hljs-title class_">cipher</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Init</span>(<span class="hljs-variable">cipher</span>, <span class="hljs-variable">CRYPTO_ENCRYPT_MODE</span>, <span class="hljs-variable">keyPair</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">plainTextSplitLen</span> = <span class="hljs-number">64</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">size_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">plainText</span>.<span class="hljs-title class_">size</span>(); <span class="hljs-title class_">i</span> += <span class="hljs-title class_">plainTextSplitLen</span>) {</li><li>        <span class="hljs-variable">Crypto_DataBlob</span> <span class="hljs-keyword">in</span> = {};</li><li>        <span class="hljs-keyword">in</span>.<span class="hljs-variable">data</span> = <span class="hljs-variable">plainText</span>.<span class="hljs-title function_">data</span>() + <span class="hljs-variable">i</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">i</span> + <span class="hljs-variable">plainTextSplitLen</span> &gt; <span class="hljs-variable">plainText</span>.<span class="hljs-title function_">size</span>()) {</li><li>            <span class="hljs-keyword">in</span>.<span class="hljs-variable">len</span> = <span class="hljs-variable">plainText</span>.<span class="hljs-title function_">size</span>() - <span class="hljs-variable">i</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">in</span>.<span class="hljs-variable">len</span> = <span class="hljs-variable">plainTextSplitLen</span>;</li><li>        }</li><li>        <span class="hljs-variable">Crypto_DataBlob</span> <span class="hljs-variable">out</span> = {};</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Final</span>(<span class="hljs-variable">cipher</span>, &amp;<span class="hljs-keyword">in</span>, &amp;<span class="hljs-title class_">out</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>            <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>        }</li><li>        <span class="hljs-variable">cipherText</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-variable">cipherText</span>.<span class="hljs-title function_">end</span>(), <span class="hljs-variable">out</span>.<span class="hljs-variable">data</span>, <span class="hljs-variable">out</span>.<span class="hljs-variable">data</span> + <span class="hljs-variable">out</span>.<span class="hljs-variable">len</span>);</li><li>        <span class="hljs-title function_">OH_Crypto_FreeDataBlob</span>(&amp;<span class="hljs-title class_">out</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">cipherText</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">doTestRsaDec</span>(<span class="hljs-variable">OH_CryptoKeyPair</span> <span class="hljs-variable">*keyPair</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; &amp;<span class="hljs-title class_">encryptText</span>)</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">decryptText</span>;</li><li>    <span class="hljs-variable">OH_CryptoAsymCipher</span> *<span class="hljs-variable">cipher</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_Crypto_ErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Create</span>(<span class="hljs-string">"RSA1024|PKCS1"</span>, &amp;<span class="hljs-title class_">cipher</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Init</span>(<span class="hljs-variable">cipher</span>, <span class="hljs-variable">CRYPTO_DECRYPT_MODE</span>, <span class="hljs-variable">keyPair</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">cipherTextSplitLen</span> = <span class="hljs-number">128</span>; <span class="hljs-comment">// RSA密钥每次加密生成的密文字节长度计算方式：密钥位数/8。</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">size_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">encryptText</span>.<span class="hljs-title class_">size</span>(); <span class="hljs-title class_">i</span> += <span class="hljs-title class_">cipherTextSplitLen</span>) {</li><li>        <span class="hljs-variable">Crypto_DataBlob</span> <span class="hljs-keyword">in</span> = {};</li><li>        <span class="hljs-keyword">in</span>.<span class="hljs-variable">data</span> = <span class="hljs-variable">encryptText</span>.<span class="hljs-title function_">data</span>() + <span class="hljs-variable">i</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">i</span> + <span class="hljs-variable">cipherTextSplitLen</span> &gt; <span class="hljs-variable">encryptText</span>.<span class="hljs-title function_">size</span>()) {</li><li>            <span class="hljs-keyword">in</span>.<span class="hljs-variable">len</span> = <span class="hljs-variable">encryptText</span>.<span class="hljs-title function_">size</span>() - <span class="hljs-variable">i</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">in</span>.<span class="hljs-variable">len</span> = <span class="hljs-variable">cipherTextSplitLen</span>;</li><li>        }</li><li>        <span class="hljs-variable">Crypto_DataBlob</span> <span class="hljs-variable">out</span> = {};</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymCipher_Final</span>(<span class="hljs-variable">cipher</span>, &amp;<span class="hljs-keyword">in</span>, &amp;<span class="hljs-title class_">out</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>            <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt;{};</li><li>        }</li><li>        <span class="hljs-variable">decryptText</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-variable">decryptText</span>.<span class="hljs-title function_">end</span>(), <span class="hljs-variable">out</span>.<span class="hljs-variable">data</span>, <span class="hljs-variable">out</span>.<span class="hljs-variable">data</span> + <span class="hljs-variable">out</span>.<span class="hljs-variable">len</span>);</li><li>        <span class="hljs-title function_">OH_Crypto_FreeDataBlob</span>(&amp;<span class="hljs-title class_">out</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">OH_CryptoAsymCipher_Destroy</span>(<span class="hljs-variable">cipher</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">decryptText</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Crypto_ErrCode</span> <span class="hljs-title function_">doTestRsaEncLongMessage</span>()</li><li>{</li><li>    <span class="hljs-variable">OH_CryptoAsymKeyGenerator</span> *<span class="hljs-variable">keyGen</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_Crypto_ErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymKeyGenerator_Create</span>(<span class="hljs-string">"RSA1024"</span>, &amp;<span class="hljs-title class_">keyGen</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">OH_CryptoKeyPair</span> *<span class="hljs-variable">keyPair</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_CryptoAsymKeyGenerator_Generate</span>(<span class="hljs-variable">keyGen</span>, &amp;<span class="hljs-title class_">keyPair</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">CRYPTO_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_CryptoAsymKeyGenerator_Destroy</span>(<span class="hljs-variable">keyGen</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">message</span> =</li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span></li><li>        <span class="hljs-string">"This is a long plainTest! This is a long plainTest! This is a long plainTest! This is a long plainTest!"</span>;</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">plainText</span>(<span class="hljs-title class_">message</span>.<span class="hljs-title class_">begin</span>(), <span class="hljs-title class_">message</span>.<span class="hljs-title class_">end</span>());</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">cipherText</span> = <span class="hljs-title function_">doTestRsaEnc</span>(<span class="hljs-variable">keyPair</span>, <span class="hljs-variable">plainText</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">uint8_t</span>&gt; <span class="hljs-title class_">decryptText</span> = <span class="hljs-title function_">doTestRsaDec</span>(<span class="hljs-variable">keyPair</span>, <span class="hljs-variable">cipherText</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">plainText</span>.<span class="hljs-title function_">size</span>() != <span class="hljs-variable">decryptText</span>.<span class="hljs-title function_">size</span>()) ||</li><li>        (!<span class="hljs-variable">std</span>::<span class="hljs-title class_">equal</span>(<span class="hljs-title class_">plainText</span>.<span class="hljs-title class_">begin</span>(), <span class="hljs-title class_">plainText</span>.<span class="hljs-title class_">end</span>(), <span class="hljs-title class_">decryptText</span>.<span class="hljs-title class_">begin</span>()))) {</li><li>        <span class="hljs-title function_">OH_CryptoKeyPair_Destroy</span>(<span class="hljs-variable">keyPair</span>);</li><li>        <span class="hljs-title function_">OH_CryptoAsymKeyGenerator_Destroy</span>(<span class="hljs-variable">keyGen</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">CRYPTO_OPERTION_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">OH_CryptoKeyPair_Destroy</span>(<span class="hljs-variable">keyPair</span>);</li><li>    <span class="hljs-title function_">OH_CryptoAsymKeyGenerator_Destroy</span>(<span class="hljs-variable">keyGen</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">CRYPTO_SUCCESS</span>;</li><li>}</li></ol></pre></div></div>   </div>   <div></div></div>