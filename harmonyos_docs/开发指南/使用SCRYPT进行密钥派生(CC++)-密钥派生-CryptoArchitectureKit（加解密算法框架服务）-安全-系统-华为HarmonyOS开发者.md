<h1 _ngcontent-hcp-c119="" class="doc-title ng-star-inserted" title="使用SCRYPT进行密钥派生(C/C++)"> 使用SCRYPT进行密钥派生(C/C++) </h1>

<div _ngcontent-hcp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对应的算法规格请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-key-derivation-overview#scrypt算法">密钥派生算法规格：SCRYPT</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_create" target="_blank">OH_CryptoKdfParams_Create</a>，指定字符串参数'SCRYPT'，创建密钥派生参数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdfparams_setparam" target="_blank">OH_CryptoKdfParams_SetParam</a>，设置Scrypt所需的参数。</p></li>     </ol>     <p>密钥派生失败原因：下列参数未设置。</p>     <ul>      <li>CRYPTO_KDF_KEY_DATABLOB：用于生成派生密钥的原始密码。</li>      <li>CRYPTO_KDF_SALT_DATABLOB：盐值。</li>      <li>CRYPTO_KDF_SCRYPT_N_UINT64：CPU/内存开销参数，必须是2的幂次方。</li>      <li>CRYPTO_KDF_SCRYPT_R_UINT64：块大小参数，影响并行度。</li>      <li>CRYPTO_KDF_SCRYPT_P_UINT64：并行化参数。</li>      <li>CRYPTO_KDF_SCRYPT_MAX_MEM_UINT64：最大内存限制（字节）。</li>     </ul>     <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_create" target="_blank">OH_CryptoKdf_Create</a>，指定字符串参数'SCRYPT'，创建密钥派生函数对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-kdf-h#oh_cryptokdf_derive" target="_blank">OH_CryptoKdf_Derive</a>，指定目标密钥的字节长度，进行密钥派生。</p></li>     </ol>     <div _ngcontent-hcp-c106="" class="highlight-div"><div _ngcontent-hcp-c106="" class="highlight-div-header"><div _ngcontent-hcp-c106="" class="highlight-div-header-left"><div _ngcontent-hcp-c106="" class="handle-button expand-button"><div _ngcontent-hcp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcp-c106="" class="highlight-div-header-right"><div _ngcontent-hcp-c106="" class="handle-button ai-button"></div><div _ngcontent-hcp-c106="" class="handle-button line-button"><div _ngcontent-hcp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcp-c106="" class="handle-button theme-button"><div _ngcontent-hcp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcp-c106="" class="handle-button copy-button"><div _ngcontent-hcp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_kdf.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestScrypt</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建Scrypt参数对象。</span></li><li>    OH_CryptoKdfParams *params = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoKdfParams_Create</span>(<span class="hljs-string">"SCRYPT"</span>, &amp;params);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置密码。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *password = <span class="hljs-string">"123456"</span>;</li><li>    Crypto_DataBlob passwordBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(password)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(password)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_KEY_DATABLOB, &amp;passwordBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置盐值。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *salt = <span class="hljs-string">"saltstring"</span>;</li><li>    Crypto_DataBlob saltBlob = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(salt)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(salt)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SALT_DATABLOB, &amp;saltBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置Scrypt参数。</span></li><li>    <span class="hljs-type">uint64_t</span> n = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// CPU/内存开销参数。</span></li><li>    <span class="hljs-type">uint64_t</span> r = <span class="hljs-number">8</span>;     <span class="hljs-comment">// 块大小参数。</span></li><li>    <span class="hljs-type">uint64_t</span> p = <span class="hljs-number">16</span>;    <span class="hljs-comment">// 并行化参数。</span></li><li>    <span class="hljs-type">uint64_t</span> maxMem = <span class="hljs-number">1067008</span>;  <span class="hljs-comment">// 最大内存限制（字节）。</span></li><li>
</li><li>    Crypto_DataBlob nData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(&amp;n),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)</li><li>    };</li><li>    Crypto_DataBlob rData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(&amp;r),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)</li><li>    };</li><li>    Crypto_DataBlob pData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(&amp;p),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)</li><li>    };</li><li>    Crypto_DataBlob maxMemData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(&amp;maxMem),</li><li>        .len = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)</li><li>    };</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SCRYPT_N_UINT64, &amp;nData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SCRYPT_R_UINT64, &amp;rData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SCRYPT_P_UINT64, &amp;pData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdfParams_SetParam</span>(params, CRYPTO_KDF_SCRYPT_MAX_MEM_UINT64, &amp;maxMemData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建密钥派生函数对象。</span></li><li>    OH_CryptoKdf *kdfCtx = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Create</span>(<span class="hljs-string">"SCRYPT"</span>, &amp;kdfCtx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 派生密钥。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">uint32_t</span> keyLength = <span class="hljs-number">32</span>; <span class="hljs-comment">// 生成32字节的密钥。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoKdf_Derive</span>(kdfCtx, params, keyLength, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>        <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Derived key length: %u\n"</span>, out.len);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoKdf_Destroy</span>(kdfCtx);</li><li>    <span class="hljs-built_in">OH_CryptoKdfParams_Destroy</span>(params);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>