<h1 _ngcontent-mby-c119="" class="doc-title ng-star-inserted" title="使用SM2密文格式转换(C/C++)"> 使用SM2密文格式转换(C/C++) </h1>

<div _ngcontent-mby-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当前支持的SM2密文格式为国密标准的ASN.1格式，其中各参数组合顺序为C1C3C2，具体参数含义请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-encrypt-decrypt-spec#转换sm2密文格式">转换SM2密文格式</a>。</p>    <p>开发者可指定SM2密文的参数，将其转换成符合国密标准的ASN.1格式密文。反之，也可以从国密标准的ASN.1格式密文中取出具体的SM2密文参数，便于开发者自行组合成其他格式的SM2密文。</p>    <p><strong>指定密文参数，生成标准ASN.1密文</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_create" target="_blank">OH_CryptoSm2CiphertextSpec_Create</a>，创建空的SM2密文规格对象。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_setitem" target="_blank">OH_CryptoSm2CiphertextSpec_SetItem</a>，设置密文的各个参数（C1.x、C1.y、C2、C3）。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_encode" target="_blank">OH_CryptoSm2CiphertextSpec_Encode</a>，生成ASN.1格式的密文（当前密文转换仅支持SM3，实现中只校验hash长度是否为32字节）。</p></li>     <li>      <p>使用完毕后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_destroy" target="_blank">OH_CryptoSm2CiphertextSpec_Destroy</a>销毁SM2密文规格对象。</p></li>    </ol>    <div _ngcontent-mby-c106="" class="highlight-div"><div _ngcontent-mby-c106="" class="highlight-div-header"><div _ngcontent-mby-c106="" class="highlight-div-header-left"><div _ngcontent-mby-c106="" class="handle-button expand-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mby-c106="" class="highlight-div-header-right"><div _ngcontent-mby-c106="" class="handle-button ai-button"></div><div _ngcontent-mby-c106="" class="handle-button line-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mby-c106="" class="handle-button theme-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mby-c106="" class="handle-button copy-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mby-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestGenCipherTextBySpec</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 准备SM2密文参数。</span></li><li>    <span class="hljs-type">uint8_t</span> c1x[] = {<span class="hljs-number">45</span>, <span class="hljs-number">153</span>, <span class="hljs-number">88</span>, <span class="hljs-number">82</span>, <span class="hljs-number">104</span>, <span class="hljs-number">221</span>, <span class="hljs-number">226</span>, <span class="hljs-number">43</span>, <span class="hljs-number">174</span>, <span class="hljs-number">21</span>, <span class="hljs-number">122</span>, <span class="hljs-number">248</span>, <span class="hljs-number">5</span>, <span class="hljs-number">232</span>, <span class="hljs-number">105</span>, <span class="hljs-number">41</span>, <span class="hljs-number">92</span>, <span class="hljs-number">95</span>, <span class="hljs-number">102</span>, <span class="hljs-number">224</span>,</li><li>                     <span class="hljs-number">216</span>, <span class="hljs-number">149</span>, <span class="hljs-number">85</span>, <span class="hljs-number">236</span>, <span class="hljs-number">110</span>, <span class="hljs-number">6</span>, <span class="hljs-number">64</span>, <span class="hljs-number">188</span>, <span class="hljs-number">149</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">183</span>};</li><li>    <span class="hljs-type">uint8_t</span> c1y[] = {<span class="hljs-number">107</span>, <span class="hljs-number">93</span>, <span class="hljs-number">198</span>, <span class="hljs-number">247</span>, <span class="hljs-number">119</span>, <span class="hljs-number">18</span>, <span class="hljs-number">40</span>, <span class="hljs-number">110</span>, <span class="hljs-number">90</span>, <span class="hljs-number">156</span>, <span class="hljs-number">193</span>, <span class="hljs-number">158</span>, <span class="hljs-number">205</span>, <span class="hljs-number">113</span>, <span class="hljs-number">170</span>, <span class="hljs-number">128</span>, <span class="hljs-number">146</span>, <span class="hljs-number">109</span>, <span class="hljs-number">75</span>,</li><li>                     <span class="hljs-number">17</span>, <span class="hljs-number">181</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">91</span>, <span class="hljs-number">149</span>, <span class="hljs-number">5</span>, <span class="hljs-number">110</span>, <span class="hljs-number">233</span>, <span class="hljs-number">209</span>, <span class="hljs-number">78</span>, <span class="hljs-number">229</span>, <span class="hljs-number">96</span>};</li><li>    <span class="hljs-type">uint8_t</span> c2[] = {<span class="hljs-number">100</span>, <span class="hljs-number">227</span>, <span class="hljs-number">78</span>, <span class="hljs-number">195</span>, <span class="hljs-number">249</span>, <span class="hljs-number">179</span>, <span class="hljs-number">43</span>, <span class="hljs-number">70</span>, <span class="hljs-number">242</span>, <span class="hljs-number">69</span>, <span class="hljs-number">169</span>, <span class="hljs-number">10</span>, <span class="hljs-number">65</span>, <span class="hljs-number">123</span>};</li><li>    <span class="hljs-type">uint8_t</span> c3[] = {<span class="hljs-number">87</span>, <span class="hljs-number">167</span>, <span class="hljs-number">167</span>, <span class="hljs-number">247</span>, <span class="hljs-number">88</span>, <span class="hljs-number">146</span>, <span class="hljs-number">203</span>, <span class="hljs-number">234</span>, <span class="hljs-number">83</span>, <span class="hljs-number">126</span>, <span class="hljs-number">117</span>, <span class="hljs-number">129</span>, <span class="hljs-number">52</span>, <span class="hljs-number">142</span>, <span class="hljs-number">82</span>, <span class="hljs-number">54</span>, <span class="hljs-number">152</span>, <span class="hljs-number">226</span>, <span class="hljs-number">201</span>, <span class="hljs-number">111</span>,</li><li>                    <span class="hljs-number">143</span>, <span class="hljs-number">115</span>, <span class="hljs-number">169</span>, <span class="hljs-number">125</span>, <span class="hljs-number">128</span>, <span class="hljs-number">42</span>, <span class="hljs-number">157</span>, <span class="hljs-number">31</span>, <span class="hljs-number">114</span>, <span class="hljs-number">198</span>, <span class="hljs-number">109</span>, <span class="hljs-number">244</span>};</li><li>
</li><li>    <span class="hljs-comment">// 创建空的SM2密文规格对象。</span></li><li>    OH_CryptoSm2CiphertextSpec *sm2CipherSpec = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Create</span>(<span class="hljs-literal">nullptr</span>, &amp;sm2CipherSpec);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置各个参数。</span></li><li>    Crypto_DataBlob c1xBlob = {c1x, <span class="hljs-built_in">sizeof</span>(c1x)};</li><li>    Crypto_DataBlob c1yBlob = {c1y, <span class="hljs-built_in">sizeof</span>(c1y)};</li><li>    Crypto_DataBlob c2Blob = {c2, <span class="hljs-built_in">sizeof</span>(c2)};</li><li>    Crypto_DataBlob c3Blob = {c3, <span class="hljs-built_in">sizeof</span>(c3)};</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_SetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C1_X, &amp;c1xBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_SetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C1_Y, &amp;c1yBlob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_SetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C2, &amp;c2Blob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_SetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C3, &amp;c3Blob);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 编码为ASN.1格式。</span></li><li>    Crypto_DataBlob encoded = { <span class="hljs-number">0</span> };</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Encode</span>(sm2CipherSpec, &amp;encoded);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;encoded);</li><li>    <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    <p><strong>从标准ASN.1密文中获取密文参数</strong></p>    <ol>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_create" target="_blank">OH_CryptoSm2CiphertextSpec_Create</a>，从ASN.1格式密文创建SM2密文规格对象。</p></li>     <li>      <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_getitem" target="_blank">OH_CryptoSm2CiphertextSpec_GetItem</a>，获取密文中的各个参数（C1.x、C1.y、C2、C3）。</p></li>     <li>      <p>使用完毕后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-asym-cipher-h#oh_cryptosm2ciphertextspec_destroy" target="_blank">OH_CryptoSm2CiphertextSpec_Destroy</a>销毁SM2密文规格对象。</p></li>    </ol>    <div _ngcontent-mby-c106="" class="highlight-div"><div _ngcontent-mby-c106="" class="highlight-div-header"><div _ngcontent-mby-c106="" class="highlight-div-header-left"><div _ngcontent-mby-c106="" class="handle-button expand-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mby-c106="" class="highlight-div-header-right"><div _ngcontent-mby-c106="" class="handle-button ai-button"></div><div _ngcontent-mby-c106="" class="handle-button line-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mby-c106="" class="handle-button theme-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mby-c106="" class="handle-button copy-button"><div _ngcontent-mby-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mby-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestGetCipherTextSpec</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 准备标准ASN.1格式密文。</span></li><li>    <span class="hljs-type">uint8_t</span> cipherTextArray[] = {<span class="hljs-number">48</span>, <span class="hljs-number">118</span>, <span class="hljs-number">2</span>, <span class="hljs-number">32</span>, <span class="hljs-number">45</span>, <span class="hljs-number">153</span>, <span class="hljs-number">88</span>, <span class="hljs-number">82</span>, <span class="hljs-number">104</span>, <span class="hljs-number">221</span>, <span class="hljs-number">226</span>, <span class="hljs-number">43</span>, <span class="hljs-number">174</span>, <span class="hljs-number">21</span>, <span class="hljs-number">122</span>, <span class="hljs-number">248</span>, <span class="hljs-number">5</span>, <span class="hljs-number">232</span>, <span class="hljs-number">105</span>,</li><li>                                <span class="hljs-number">41</span>, <span class="hljs-number">92</span>, <span class="hljs-number">95</span>, <span class="hljs-number">102</span>, <span class="hljs-number">224</span>, <span class="hljs-number">216</span>, <span class="hljs-number">149</span>, <span class="hljs-number">85</span>, <span class="hljs-number">236</span>, <span class="hljs-number">110</span>, <span class="hljs-number">6</span>, <span class="hljs-number">64</span>, <span class="hljs-number">188</span>, <span class="hljs-number">149</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">183</span>, <span class="hljs-number">2</span>, <span class="hljs-number">32</span>, <span class="hljs-number">107</span>,</li><li>                                <span class="hljs-number">93</span>, <span class="hljs-number">198</span>, <span class="hljs-number">247</span>, <span class="hljs-number">119</span>, <span class="hljs-number">18</span>, <span class="hljs-number">40</span>, <span class="hljs-number">110</span>, <span class="hljs-number">90</span>, <span class="hljs-number">156</span>, <span class="hljs-number">193</span>, <span class="hljs-number">158</span>, <span class="hljs-number">205</span>, <span class="hljs-number">113</span>, <span class="hljs-number">170</span>, <span class="hljs-number">128</span>, <span class="hljs-number">146</span>, <span class="hljs-number">109</span>, <span class="hljs-number">75</span>, <span class="hljs-number">17</span>,</li><li>                                <span class="hljs-number">181</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">91</span>, <span class="hljs-number">149</span>, <span class="hljs-number">5</span>, <span class="hljs-number">110</span>, <span class="hljs-number">233</span>, <span class="hljs-number">209</span>, <span class="hljs-number">78</span>, <span class="hljs-number">229</span>, <span class="hljs-number">96</span>, <span class="hljs-number">4</span>, <span class="hljs-number">32</span>, <span class="hljs-number">87</span>, <span class="hljs-number">167</span>, <span class="hljs-number">167</span>, <span class="hljs-number">247</span>, <span class="hljs-number">88</span>, <span class="hljs-number">146</span>,</li><li>                                <span class="hljs-number">203</span>, <span class="hljs-number">234</span>, <span class="hljs-number">83</span>, <span class="hljs-number">126</span>, <span class="hljs-number">117</span>, <span class="hljs-number">129</span>, <span class="hljs-number">52</span>, <span class="hljs-number">142</span>, <span class="hljs-number">82</span>, <span class="hljs-number">54</span>, <span class="hljs-number">152</span>, <span class="hljs-number">226</span>, <span class="hljs-number">201</span>, <span class="hljs-number">111</span>, <span class="hljs-number">143</span>, <span class="hljs-number">115</span>, <span class="hljs-number">169</span>, <span class="hljs-number">125</span>, <span class="hljs-number">128</span>,</li><li>                                <span class="hljs-number">42</span>, <span class="hljs-number">157</span>, <span class="hljs-number">31</span>, <span class="hljs-number">114</span>, <span class="hljs-number">198</span>, <span class="hljs-number">109</span>, <span class="hljs-number">244</span>, <span class="hljs-number">4</span>, <span class="hljs-number">14</span>, <span class="hljs-number">100</span>, <span class="hljs-number">227</span>, <span class="hljs-number">78</span>, <span class="hljs-number">195</span>, <span class="hljs-number">249</span>, <span class="hljs-number">179</span>, <span class="hljs-number">43</span>, <span class="hljs-number">70</span>, <span class="hljs-number">242</span>, <span class="hljs-number">69</span>, <span class="hljs-number">169</span>,</li><li>                                <span class="hljs-number">10</span>, <span class="hljs-number">65</span>, <span class="hljs-number">123</span>};</li><li>    Crypto_DataBlob cipherText = {cipherTextArray, <span class="hljs-built_in">sizeof</span>(cipherTextArray)};</li><li>
</li><li>    <span class="hljs-comment">// 从ASN.1格式密文创建SM2密文规格对象。</span></li><li>    OH_CryptoSm2CiphertextSpec *sm2CipherSpec = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Create</span>(&amp;cipherText, &amp;sm2CipherSpec);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取各个参数。</span></li><li>    Crypto_DataBlob c1x = { <span class="hljs-number">0</span> };</li><li>    Crypto_DataBlob c1y = { <span class="hljs-number">0</span> };</li><li>    Crypto_DataBlob c2 = { <span class="hljs-number">0</span> };</li><li>    Crypto_DataBlob c3 = { <span class="hljs-number">0</span> };</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_GetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C1_X, &amp;c1x);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">goto</span> EXIT;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_GetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C1_Y, &amp;c1y);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">goto</span> EXIT;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_GetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C2, &amp;c2);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">goto</span> EXIT;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_GetItem</span>(sm2CipherSpec, CRYPTO_SM2_CIPHERTEXT_C3, &amp;c3);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">goto</span> EXIT;</li><li>    }</li><li>
</li><li>EXIT:</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;c1x);</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;c1y);</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;c2);</li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;c3);</li><li>    <span class="hljs-built_in">OH_CryptoSm2CiphertextSpec_Destroy</span>(sm2CipherSpec);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>   </div>   <div></div></div>