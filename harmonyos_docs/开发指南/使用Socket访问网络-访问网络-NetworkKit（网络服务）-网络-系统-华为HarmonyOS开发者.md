<h1 _ngcontent-qee-c119="" class="doc-title ng-star-inserted" title="使用Socket访问网络"> 使用Socket访问网络 </h1>

<div _ngcontent-qee-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>Socket连接主要是通过Socket进行数据传输，支持TCP/UDP/Multicast/TLS协议。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>应用退后台后，Socket可能会断开，当应用重新回到前台，发生通信失败时，需匹配错误码并重新创建新的TCP/UDP Socket。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>Socket：套接字，就是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象。</li>      <li>TCP：传输控制协议(Transmission Control Protocol)，是一种面向连接的、可靠的、基于字节流的传输层通信协议。</li>      <li>UDP：用户数据报协议(User Datagram Protocol)，是一个简单的面向消息的传输层，不需要连接。</li>      <li>Multicast：多播，基于UDP的一种通信模式，用于实现组内所有设备之间广播形式的通信。</li>      <li>LocalSocket：本地套接字，IPC(Inter-Process Communication)进程间通信的一种，实现设备内进程之间相互通信，无需网络。</li>      <li>TLS：安全传输层协议(Transport Layer Security)，用于在两个通信应用程序之间提供保密性和数据完整性。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>应用通过Socket进行数据传输，支持TCP/UDP/Multicast/TLS协议。主要场景有：</p>     <ul>      <li>在TCP/UDP传输的客户端（UDP本身并没有客户端和服务器端的明确区分，此处描述UDP传输的客户端是指主动向服务器发送数据的一方），应用通过TCP/UDP Socket进行数据传输</li>      <li>在TCP传输的服务器端，应用通过TCP Socket Server进行数据传输</li>      <li>多播通信场景，应用通过Multicast Socket进行数据传输</li>      <li>同一台主机上不同进程之间传输的客户端，应用通过Local Socket进行数据传输</li>      <li>同一台主机上不同进程之间传输的服务器端，应用通过Local Socket Server进行数据传输</li>      <li>数据加密传输时，客户端侧通过TLS Socket进行加密数据传输</li>      <li>数据加密传输时，服务器侧通过TLS Socket Server进行加密数据传输</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>在本文档的示例中，通过this.context来获取UIAbilityContext，其中this代表继承自UIAbility的UIAbility实例。如需在页面中使用UIAbilityContext提供的能力，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="应用tcpudp协议进行通信">应用TCP/UDP协议进行通信<i class="anchor-icon anchor-icon-link" anchorid="应用tcpudp协议进行通信" tips="复制节点链接"></i></h2>          <p>UDP与TCP流程大体类似，下面以TCP为例：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建一个TCPSocket连接，返回一个TCPSocket对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个TCPSocket连接，返回一个TCPSocket对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tcp</span>: socket.<span class="hljs-property">TCPSocket</span> = socket.<span class="hljs-title function_">constructTCPSocketInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>（可选）订阅TCPSocket相关的订阅事件。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li>
</li><li>tcp.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on message"</span>);</li><li>  <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>  <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>  <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>    str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect received:"</span> + str);</li><li>});</li><li>tcp.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect"</span>);</li><li>});</li><li>tcp.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on close"</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>绑定IP地址和端口，端口可以指定或由系统随机分配，绑定成功后可以连接到指定的IP地址和端口，连接成功后可以发送数据。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 绑定本地IP地址和端口。</span></li><li><span class="hljs-keyword">let</span> ipAddress : socket.<span class="hljs-property">NetAddress</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">NetAddress</span>;</li><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">1234</span>;</li><li>tcp.<span class="hljs-title function_">bind</span>(ipAddress, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bind fail'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bind success'</span>);</li><li>
</li><li>  <span class="hljs-comment">// bind成功后，连接到指定的IP地址和端口。</span></li><li>  ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>  ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">5678</span>;</li><li>
</li><li>  <span class="hljs-keyword">let</span> tcpConnect : socket.<span class="hljs-property">TCPConnectOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TCPConnectOptions</span>;</li><li>  tcpConnect.<span class="hljs-property">address</span> = ipAddress;</li><li>  tcpConnect.<span class="hljs-property">timeout</span> = <span class="hljs-number">6000</span>;</li><li>
</li><li>  tcp.<span class="hljs-title function_">connect</span>(tcpConnect).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connect success'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tcpSendOptions</span>: socket.<span class="hljs-property">TCPSendOptions</span> = {</li><li>      <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello, server!'</span></li><li>    }</li><li>    <span class="hljs-comment">// 连接成功之后，发送数据。</span></li><li>    tcp.<span class="hljs-title function_">send</span>(tcpSendOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'send fail'</span>);</li><li>    });</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'connect fail'</span>);</li><li>  });</li><li>});</li></ol></pre></div></div></li>      <li>       <p>Socket连接使用完毕后，主动关闭。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 连接使用完毕后，主动关闭。取消相关事件的订阅。</span></li><li><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  tcp.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'close success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'close fail'</span>);</li><li>  });</li><li>  tcp.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>  tcp.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>  tcp.<span class="hljs-title function_">off</span>(<span class="hljs-string">'close'</span>);</li><li>}, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过tcp-socket-server进行数据传输">应用通过TCP Socket Server进行数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过tcp-socket-server进行数据传输" tips="复制节点链接"></i></h2>          <p>服务端TCP Socket流程：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建一个TCPSocketServer连接，返回一个TCPSocketServer对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个TCPSocketServer连接，返回一个TCPSocketServer对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tcpServer</span>: socket.<span class="hljs-property">TCPSocketServer</span> = socket.<span class="hljs-title function_">constructTCPSocketServerInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>绑定本地IP地址和端口，监听并接受与此套接字建立的客户端TCPSocket连接。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 绑定本地IP地址和端口，进行监听。</span></li><li><span class="hljs-keyword">let</span> ipAddress : socket.<span class="hljs-property">NetAddress</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">NetAddress</span>;</li><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">4651</span>;</li><li>tcpServer.<span class="hljs-title function_">listen</span>(ipAddress).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'listen success'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'listen fail'</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>订阅TCPSocketServer的connect事件，用于监听客户端的连接状态。客户端与服务端建立连接后，会返回一个TCPSocketConnection对象，用于与客户端通信，通过该对象可以订阅与客户端的连接关闭、客户端数据接收事件，也可以进行向客户端发送数据、关闭与客户端的连接、取消订阅TCPSocketConnection相关事件的动作。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li><span class="hljs-comment">// 订阅TCPSocketServer的connect事件，客户端与服务端建立连接后，返回一个TCPSocketConnection对象，用于与客户端通信。</span></li><li>tcpServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">"connect"</span>, <span class="hljs-function">(<span class="hljs-params">client: socket.TCPSocketConnection</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// client即为建立连接后获取到的连接对象，可以通过该对象订阅TCPSocketConnection相关的事件。</span></li><li>  client.<span class="hljs-title function_">on</span>(<span class="hljs-string">"close"</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on close success"</span>);</li><li>  });</li><li>  client.<span class="hljs-title function_">on</span>(<span class="hljs-string">"message"</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>    <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>    <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>      str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"received message--:"</span> + str);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"received address--:"</span> + value.<span class="hljs-property">remoteInfo</span>.<span class="hljs-property">address</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"received family--:"</span> + value.<span class="hljs-property">remoteInfo</span>.<span class="hljs-property">family</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"received port--:"</span> + value.<span class="hljs-property">remoteInfo</span>.<span class="hljs-property">port</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"received size--:"</span> + value.<span class="hljs-property">remoteInfo</span>.<span class="hljs-property">size</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 向客户端发送数据。</span></li><li>  <span class="hljs-keyword">let</span> tcpSendOptions : socket.<span class="hljs-property">TCPSendOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TCPSendOptions</span>;</li><li>  tcpSendOptions.<span class="hljs-property">data</span> = <span class="hljs-string">'Hello, client!'</span>;</li><li>  client.<span class="hljs-title function_">send</span>(tcpSendOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'send fail: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 关闭与客户端的连接。</span></li><li>  client.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'close success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'close fail'</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 取消TCPSocketConnection相关的事件订阅。</span></li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    client.<span class="hljs-title function_">off</span>(<span class="hljs-string">"message"</span>);</li><li>    client.<span class="hljs-title function_">off</span>(<span class="hljs-string">"close"</span>);</li><li>  }, <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>取消TCPSocketServer相关事件的订阅。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 取消TCPSocketServer相关的事件订阅。</span></li><li><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  tcpServer.<span class="hljs-title function_">off</span>(<span class="hljs-string">"connect"</span>);</li><li>}, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过multicast-socket进行数据传输">应用通过Multicast Socket进行数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过multicast-socket进行数据传输" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建multicastSocket多播对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建Multicast对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">multicast</span>: socket.<span class="hljs-property">MulticastSocket</span> = socket.<span class="hljs-title function_">constructMulticastSocketInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>指定多播IP与端口，加入多播组。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> addr : socket.<span class="hljs-property">NetAddress</span> = {</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-string">'239.255.0.1'</span>,</li><li>  <span class="hljs-attr">port</span>: <span class="hljs-number">32123</span>,</li><li>  <span class="hljs-attr">family</span>: <span class="hljs-number">1</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 加入多播组。</span></li><li>multicast.<span class="hljs-title function_">addMembership</span>(addr).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'addMembership success'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'addMembership fail'</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>开启消息message监听。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 开启监听消息数据，将接收到的ArrayBuffer类型数据转换为String。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li>multicast.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">data: SocketInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'接收的数据: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))</li><li>  <span class="hljs-keyword">const</span> uintArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data.<span class="hljs-property">message</span>)</li><li>  <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uintArray.<span class="hljs-property">length</span>; ++i) {</li><li>    str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(uintArray[i])</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(str)</li><li>})</li></ol></pre></div></div></li>      <li>       <p>发送数据，数据以广播的形式传输，同一多播组中已经开启消息message监听的多播对象都会接收到数据。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 发送数据。</span></li><li>multicast.<span class="hljs-title function_">send</span>({ <span class="hljs-attr">data</span>:<span class="hljs-string">'Hello12345'</span>, <span class="hljs-attr">address</span>: addr }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'send fail, '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>关闭message消息的监听。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 关闭消息的监听。</span></li><li>multicast.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>)</li></ol></pre></div></div></li>      <li>       <p>退出多播组。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 退出多播组。</span></li><li>multicast.<span class="hljs-title function_">dropMembership</span>(addr).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'drop membership success'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'drop membership fail'</span>);</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过localsocket进行数据传输">应用通过LocalSocket进行数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过localsocket进行数据传输" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>使用constructLocalSocketInstance接口，创建一个LocalSocket客户端对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个LocalSocket连接，返回一个LocalSocket对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">client</span>: socket.<span class="hljs-property">LocalSocket</span> = socket.<span class="hljs-title function_">constructLocalSocketInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>注册LocalSocket的消息(message)事件，以及一些其它事件(可选)。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>client.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: socket.LocalSocketMessageInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">const</span> uintArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(value.<span class="hljs-property">message</span>)</li><li>  <span class="hljs-keyword">let</span> messageView = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uintArray.<span class="hljs-property">length</span>; i++) {</li><li>    messageView += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(uintArray[i]);</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'total receive: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'message information: '</span> + messageView);</li><li>});</li><li>client.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect"</span>);</li><li>});</li><li>client.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on close"</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>连接到指定的本地套接字文件路径，连接成功之后可以发送数据。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 传入指定的本地套接字路径，连接服务端。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">sandboxPath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/testSocket'</span>;</li><li><span class="hljs-keyword">let</span> localAddress : socket.<span class="hljs-property">LocalAddress</span> = {</li><li>  <span class="hljs-attr">address</span>: sandboxPath</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">connectOpt</span>: socket.<span class="hljs-property">LocalConnectOptions</span> = {</li><li>  <span class="hljs-attr">address</span>: localAddress,</li><li>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">6000</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">sendOpt</span>: socket.<span class="hljs-property">LocalSendOptions</span> = {</li><li>  <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello world!'</span></li><li>}</li><li>client.<span class="hljs-title function_">connect</span>(connectOpt).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connect success'</span>)</li><li>  <span class="hljs-comment">// 发送数据。</span></li><li>  client.<span class="hljs-title function_">send</span>(sendOpt).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>)</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'send failed: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err))</li><li>  })</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'connect fail: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>Socket连接使用完毕后，取消事件的注册，并关闭套接字。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 当不需要再连接服务端，需要断开且取消事件的监听时。</span></li><li>client.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>client.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>client.<span class="hljs-title function_">off</span>(<span class="hljs-string">'close'</span>);</li><li>client.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'close client success'</span>)</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'close client err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err))</li><li>})</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过local-socket-server进行数据传输">应用通过Local Socket Server进行数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过local-socket-server进行数据传输" tips="复制节点链接"></i></h2>          <p>服务端LocalSocket Server的主要流程包括：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>使用constructLocalSocketServerInstance接口，创建一个 LocalSocketServer 服务端对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个LocalSocketServer连接，返回一个LocalSocketServer对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">server</span>: socket.<span class="hljs-property">LocalSocketServer</span> = socket.<span class="hljs-title function_">constructLocalSocketServerInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>启动服务，绑定本地套接字路径，创建出本地套接字文件，监听客户端的连接请求。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建并绑定本地套接字文件testSocket，进行监听。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">sandboxPath</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/testSocket'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">listenAddr</span>: socket.<span class="hljs-property">LocalAddress</span> = {</li><li>  <span class="hljs-attr">address</span>: sandboxPath</li><li>}</li><li>server.<span class="hljs-title function_">listen</span>(listenAddr).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"listen success"</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"listen fail: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>注册LocalSocket的客户端连接事件，以及一些其它事件(可选)，在客户端连接成功时，可以获取到客户端连接会话对象LocalSocketConnection，通过该会话对象可以订阅客户端收到消息(message)事件，以及一些其它事件(可选)，通过该会话对象也可发起主动向客户端发送数据，主动关闭与客户端的连接的动作，订阅事件不再需要时，可以取消LocalSocketConnection相关的事件订阅。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 订阅LocalSocketServer的connect事件。</span></li><li>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">(<span class="hljs-params">connection: socket.LocalSocketConnection</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 订阅LocalSocketConnection相关的事件。</span></li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"on error success"</span>);</li><li>  });</li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: socket.LocalSocketMessageInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> uintArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(value.<span class="hljs-property">message</span>);</li><li>    <span class="hljs-keyword">let</span> messageView = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uintArray.<span class="hljs-property">length</span>; i++) {</li><li>      messageView += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(uintArray[i]);</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'total: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'message information: '</span> + messageView);</li><li>  });</li><li>
</li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"err:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  })</li><li>
</li><li>  <span class="hljs-comment">// 向客户端发送数据。</span></li><li>  <span class="hljs-keyword">let</span> sendOpt : socket.<span class="hljs-property">LocalSendOptions</span> = {</li><li>    <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello world!'</span></li><li>  };</li><li>  connection.<span class="hljs-title function_">send</span>(sendOpt).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send failed: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  })</li><li>
</li><li>  <span class="hljs-comment">// 关闭与客户端的连接。</span></li><li>  connection.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'close success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'close failed: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 取消LocalSocketConnection相关的事件订阅。</span></li><li>  connection.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>  connection.<span class="hljs-title function_">off</span>(<span class="hljs-string">'error'</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>取消LocalSocketServer相关事件的订阅。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 取消LocalSocketServer相关的事件订阅。</span></li><li>server.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>server.<span class="hljs-title function_">off</span>(<span class="hljs-string">'error'</span>);</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过tls-socket进行加密数据传输">应用通过TLS Socket进行加密数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过tls-socket进行加密数据传输" tips="复制节点链接"></i></h2>          <p>客户端TLS Socket流程（双向认证）包括：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建一个双向认证TLSSocket连接，返回一个TLSSocket对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个（双向认证）TLS Socket连接，返回一个TLS Socket对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsTwoWay</span>: socket.<span class="hljs-property">TLSSocket</span> = socket.<span class="hljs-title function_">constructTLSSocketInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>绑定服务器IP地址和端口，确保bind成功后，再订阅TLS Socket相关的订阅事件。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li><span class="hljs-comment">// 绑定本地IP地址和端口。</span></li><li><span class="hljs-keyword">let</span> ipAddress : socket.<span class="hljs-property">NetAddress</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">NetAddress</span>;</li><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">4512</span>;</li><li>tlsTwoWay.<span class="hljs-title function_">bind</span>(ipAddress, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bind fail'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bind success'</span>);</li><li>  <span class="hljs-comment">// 确保bind成功后，再订阅TLS Socket相关的订阅事件</span></li><li>  tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on message"</span>);</li><li>    <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>    <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>    <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>      str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect received:"</span> + str);</li><li>  });</li><li>  tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect"</span>);</li><li>  });</li><li>  tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on close"</span>);</li><li>  });</li><li>});</li></ol></pre></div></div></li>      <li>       <p>双向认证上传客户端CA证书及数字证书，并建立连接，连接建立成功后可以发送数据。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">1234</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> tlsSecureOption : socket.<span class="hljs-property">TLSSecureOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSSecureOptions</span>;</li><li>tlsSecureOption.<span class="hljs-property">key</span> = <span class="hljs-string">"xxxx"</span>;</li><li>tlsSecureOption.<span class="hljs-property">cert</span> = <span class="hljs-string">"xxxx"</span>;</li><li>tlsSecureOption.<span class="hljs-property">ca</span> = [<span class="hljs-string">"xxxx"</span>];</li><li>tlsSecureOption.<span class="hljs-property">password</span> = <span class="hljs-string">"xxxx"</span>;</li><li>tlsSecureOption.<span class="hljs-property">protocols</span> = [socket.<span class="hljs-property">Protocol</span>.<span class="hljs-property">TLSv12</span>];</li><li>tlsSecureOption.<span class="hljs-property">useRemoteCipherPrefer</span> = <span class="hljs-literal">true</span>;</li><li>tlsSecureOption.<span class="hljs-property">signatureAlgorithms</span> = <span class="hljs-string">"rsa_pss_rsae_sha256:ECDSA+SHA256"</span>;</li><li>tlsSecureOption.<span class="hljs-property">cipherSuite</span> = <span class="hljs-string">"AES256-SHA256"</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> tlsTwoWayConnectOption : socket.<span class="hljs-property">TLSConnectOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSConnectOptions</span>;</li><li>tlsTwoWayConnectOption.<span class="hljs-property">address</span> = ipAddress;</li><li>tlsTwoWayConnectOption.<span class="hljs-property">secureOptions</span> = tlsSecureOption;</li><li>tlsTwoWayConnectOption.<span class="hljs-property">ALPNProtocols</span> = [<span class="hljs-string">"spdy/1"</span>, <span class="hljs-string">"http/1.1"</span>];</li><li>
</li><li><span class="hljs-comment">// 建立连接，连接建立成功后，可以发送数据。</span></li><li>tlsTwoWay.<span class="hljs-title function_">connect</span>(tlsTwoWayConnectOption).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"connect successfully"</span>);</li><li>  <span class="hljs-comment">// 发送数据。</span></li><li>  tlsTwoWay.<span class="hljs-title function_">send</span>(<span class="hljs-string">"xxxx"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"send successfully"</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"send failed "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  });</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"connect failed "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>TLSSocket连接使用完毕后，主动关闭。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 连接使用完毕后，主动关闭，并取消相关事件的订阅。</span></li><li>tlsTwoWay.<span class="hljs-title function_">close</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"close callback error = "</span> + err);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"close success"</span>);</li><li>  }</li><li>  tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>  tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>  tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'close'</span>);</li><li>});</li></ol></pre></div></div></li>     </ol>     <p>客户端TLS Socket流程（单向认证）包括：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建一个单向认证TLSSocket连接，返回一个TLSSocket对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个（单向认证）TLS Socket连接，返回一个TLS Socket对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsOneWay</span>: socket.<span class="hljs-property">TLSSocket</span> = socket.<span class="hljs-title function_">constructTLSSocketInstance</span>(); <span class="hljs-comment">// One way authentication</span></li></ol></pre></div></div></li>      <li>       <p>绑定服务器IP地址和端口，确保bind成功后，再订阅TLS Socket相关的订阅事件。。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li><span class="hljs-comment">// 绑定本地IP地址和端口。</span></li><li><span class="hljs-keyword">let</span> ipAddress : socket.<span class="hljs-property">NetAddress</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">NetAddress</span>;</li><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">5445</span>;</li><li>tlsOneWay.<span class="hljs-title function_">bind</span>(ipAddress, <span class="hljs-function">(<span class="hljs-params">err:BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bind fail'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bind success'</span>);</li><li>  <span class="hljs-comment">// 订阅TLS Socket相关的订阅事件</span></li><li>  tlsOneWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on message"</span>);</li><li>    <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>    <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>    <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>      str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect received:"</span> + str);</li><li>  });</li><li>  tlsOneWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect"</span>);</li><li>  });</li><li>  tlsOneWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on close"</span>);</li><li>  });</li><li>});</li></ol></pre></div></div></li>      <li>       <p>单向认证上传客户端CA证书，并建立连接。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">8789</span>;</li><li><span class="hljs-keyword">let</span> tlsOneWaySecureOption : socket.<span class="hljs-property">TLSSecureOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSSecureOptions</span>;</li><li>tlsOneWaySecureOption.<span class="hljs-property">ca</span> = [<span class="hljs-string">"xxxx"</span>, <span class="hljs-string">"xxxx"</span>];</li><li>tlsOneWaySecureOption.<span class="hljs-property">cipherSuite</span> = <span class="hljs-string">"AES256-SHA256"</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsOneWayConnectOptions</span>: socket.<span class="hljs-property">TLSConnectOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSConnectOptions</span>;</li><li>tlsOneWayConnectOptions.<span class="hljs-property">address</span> = ipAddress;</li><li>tlsOneWayConnectOptions.<span class="hljs-property">secureOptions</span> = tlsOneWaySecureOption;</li><li>
</li><li><span class="hljs-comment">// 建立连接，连接建立成功后，可以发送数据。</span></li><li>tlsOneWay.<span class="hljs-title function_">connect</span>(tlsOneWayConnectOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"connect successfully"</span>);</li><li>  <span class="hljs-comment">// 发送数据。</span></li><li>  tlsOneWay.<span class="hljs-title function_">send</span>(<span class="hljs-string">"xxxx"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"send successfully"</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"send failed "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  });</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"connect failed "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>TLSSocket连接使用完毕后，主动关闭。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 连接使用完毕后，主动关闭，并取消相关事件的订阅。</span></li><li>tlsOneWay.<span class="hljs-title function_">close</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"close callback error = "</span> + err);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"close success"</span>);</li><li>  }</li><li>  tlsOneWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>  tlsOneWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>  tlsOneWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'close'</span>);</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过将tcp-socket升级为tls-socket进行加密数据传输">应用通过将TCP Socket升级为TLS Socket进行加密数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过将tcp-socket升级为tls-socket进行加密数据传输" tips="复制节点链接"></i></h2>          <p>客户端TCP Socket升级为TLS Socket流程，以TLS Socket双向认证为例：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>参考<a href="/consumer/cn/doc/harmonyos-guides/socket-connection#应用tcpudp协议进行通信">应用 TCP/UDP 协议进行通信</a>，创建一个TCPSocket连接。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建一个TCPSocket连接，返回一个TCPSocket对象。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tcp</span>: socket.<span class="hljs-property">TCPSocket</span> = socket.<span class="hljs-title function_">constructTCPSocketInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>（可选）订阅TCPSocket相关的订阅事件。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li>
</li><li>tcp.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on message"</span>);</li><li>  <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>  <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>  <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>    str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect received:"</span> + str);</li><li>});</li><li>tcp.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on connect"</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>绑定本地IP地址和端口，绑定成功后，连接到服务器端IP地址和端口，连接成功后使用该TCPSocket对象创建TLSSocket，配置双向认证上传客户端 CA 证书及数字证书，可以建立TLSSocket连接，连接使用完毕后，主动关闭并取消相关事件的订阅。。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 绑定本地IP地址和端口。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">ipAddress</span>: socket.<span class="hljs-property">NetAddress</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">NetAddress</span>;</li><li>ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">1234</span>;</li><li>tcp.<span class="hljs-title function_">bind</span>(ipAddress, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bind fail'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bind success'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 连接到服务器端指定的IP地址和端口。</span></li><li>  ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>  ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">443</span>;</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">tcpConnect</span>: socket.<span class="hljs-property">TCPConnectOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TCPConnectOptions</span>;</li><li>  tcpConnect.<span class="hljs-property">address</span> = ipAddress;</li><li>  tcpConnect.<span class="hljs-property">timeout</span> = <span class="hljs-number">6000</span>;</li><li>
</li><li>  tcp.<span class="hljs-title function_">connect</span>(tcpConnect, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'connect fail'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connect success'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 确保TCPSocket已连接后，将其升级为TLSSocket连接。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tlsTwoWay</span>: socket.<span class="hljs-property">TLSSocket</span> = socket.<span class="hljs-title function_">constructTLSSocketInstance</span>(tcp);</li><li>    <span class="hljs-comment">// 订阅TLSSocket相关的订阅事件。</span></li><li>    tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">value: SocketInfo</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls on message"</span>);</li><li>      <span class="hljs-keyword">let</span> buffer = value.<span class="hljs-property">message</span>;</li><li>      <span class="hljs-keyword">let</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>      <span class="hljs-keyword">let</span> str = <span class="hljs-string">""</span>;</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataView.<span class="hljs-property">byteLength</span>; ++i) {</li><li>        str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(dataView.<span class="hljs-title function_">getUint8</span>(i));</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls on connect received:"</span> + str);</li><li>    });</li><li>    tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls on connect"</span>);</li><li>    });</li><li>    tlsTwoWay.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls on close"</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 配置TLSSocket目的地址、证书等信息。</span></li><li>    ipAddress.<span class="hljs-property">address</span> = <span class="hljs-string">"192.168.xxx.xxx"</span>;</li><li>    ipAddress.<span class="hljs-property">port</span> = <span class="hljs-number">1234</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tlsSecureOption</span>: socket.<span class="hljs-property">TLSSecureOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSSecureOptions</span>;</li><li>    tlsSecureOption.<span class="hljs-property">key</span> = <span class="hljs-string">"xxxx"</span>;</li><li>    tlsSecureOption.<span class="hljs-property">cert</span> = <span class="hljs-string">"xxxx"</span>;</li><li>    tlsSecureOption.<span class="hljs-property">ca</span> = [<span class="hljs-string">"xxxx"</span>];</li><li>    tlsSecureOption.<span class="hljs-property">password</span> = <span class="hljs-string">"xxxx"</span>;</li><li>    tlsSecureOption.<span class="hljs-property">protocols</span> = [socket.<span class="hljs-property">Protocol</span>.<span class="hljs-property">TLSv12</span>];</li><li>    tlsSecureOption.<span class="hljs-property">useRemoteCipherPrefer</span> = <span class="hljs-literal">true</span>;</li><li>    tlsSecureOption.<span class="hljs-property">signatureAlgorithms</span> = <span class="hljs-string">"rsa_pss_rsae_sha256:ECDSA+SHA256"</span>;</li><li>    tlsSecureOption.<span class="hljs-property">cipherSuite</span> = <span class="hljs-string">"AES256-SHA256"</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tlsTwoWayConnectOption</span>: socket.<span class="hljs-property">TLSConnectOptions</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">TLSConnectOptions</span>;</li><li>    tlsSecureOption.<span class="hljs-property">key</span> = <span class="hljs-string">"xxxx"</span>;</li><li>    tlsTwoWayConnectOption.<span class="hljs-property">address</span> = ipAddress;</li><li>    tlsTwoWayConnectOption.<span class="hljs-property">secureOptions</span> = tlsSecureOption;</li><li>    tlsTwoWayConnectOption.<span class="hljs-property">ALPNProtocols</span> = [<span class="hljs-string">"spdy/1"</span>, <span class="hljs-string">"http/1.1"</span>];</li><li>
</li><li>    <span class="hljs-comment">// 建立TLSSocket连接。</span></li><li>    tlsTwoWay.<span class="hljs-title function_">connect</span>(tlsTwoWayConnectOption, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls connect success"</span>);</li><li>
</li><li>      <span class="hljs-comment">// 连接使用完毕后，主动关闭。取消相关事件的订阅。</span></li><li>      tlsTwoWay.<span class="hljs-title function_">close</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"tls close callback error = "</span> + err);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"tls close success"</span>);</li><li>        }</li><li>        tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>        tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li><li>        tlsTwoWay.<span class="hljs-title function_">off</span>(<span class="hljs-string">'close'</span>);</li><li>      });</li><li>    });</li><li>  });</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="应用通过tls-socket-server进行加密数据传输">应用通过TLS Socket Server进行加密数据传输<i class="anchor-icon anchor-icon-link" anchorid="应用通过tls-socket-server进行加密数据传输" tips="复制节点链接"></i></h2>          <p>服务端TLS Socket Server流程：</p>     <ol>      <li>       <p>导入所需的socket模块。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建一个TLSSocketServer连接，返回一个TLSSocketServer对象。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsServer</span>: socket.<span class="hljs-property">TLSSocketServer</span> = socket.<span class="hljs-title function_">constructTLSSocketServerInstance</span>();</li></ol></pre></div></div></li>      <li>       <p>启动服务，绑定 IP 和端口号，监听客户端连接，创建并初始化TLS会话，加载证书密钥并验证。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">netAddress</span>: socket.<span class="hljs-property">NetAddress</span> = {</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-string">'192.168.xx.xxx'</span>,</li><li>  <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsSecureOptions</span>: socket.<span class="hljs-property">TLSSecureOptions</span> = {</li><li>  <span class="hljs-attr">key</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-attr">cert</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-attr">ca</span>: [<span class="hljs-string">"xxxx"</span>],</li><li>  <span class="hljs-attr">password</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-attr">protocols</span>: socket.<span class="hljs-property">Protocol</span>.<span class="hljs-property">TLSv12</span>,</li><li>  <span class="hljs-attr">useRemoteCipherPrefer</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">signatureAlgorithms</span>: <span class="hljs-string">"rsa_pss_rsae_sha256:ECDSA+SHA256"</span>,</li><li>  <span class="hljs-attr">cipherSuite</span>: <span class="hljs-string">"AES256-SHA256"</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">tlsConnectOptions</span>: socket.<span class="hljs-property">TLSConnectOptions</span> = {</li><li>  <span class="hljs-attr">address</span>: netAddress,</li><li>  <span class="hljs-attr">secureOptions</span>: tlsSecureOptions,</li><li>  <span class="hljs-title class_">ALPNProtocols</span>: [<span class="hljs-string">"spdy/1"</span>, <span class="hljs-string">"http/1.1"</span>]</li><li>}</li><li>
</li><li>tlsServer.<span class="hljs-title function_">listen</span>(tlsConnectOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"listen callback success"</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"failed"</span> + err);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>订阅TLSSocketServer的连接事件，收到客户端连接，通过回调得到TLSSocketConnection对象，通过该对象可以实现订阅TLSSocketConnection相关的事件、向客户端发送数的动作，TLSSocketConnection连接使用完毕后，需要主动断开连接，进行取消订阅回调的动作。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketInfo</span> {</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1</span>);</li><li>  <span class="hljs-attr">remoteInfo</span>: socket.<span class="hljs-property">SocketRemoteInfo</span> = {} <span class="hljs-keyword">as</span> socket.<span class="hljs-property">SocketRemoteInfo</span>;</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params">value: SocketInfo</span>) =&gt; {</li><li>  <span class="hljs-keyword">let</span> messageView = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; i &lt; value.<span class="hljs-property">message</span>.<span class="hljs-property">byteLength</span>; i++) {</li><li>    <span class="hljs-keyword">let</span> uint8Array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(value.<span class="hljs-property">message</span>)</li><li>    <span class="hljs-keyword">let</span> messages = uint8Array[i]</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(messages);</li><li>    messageView += message;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'on message message: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(messageView));</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'remoteInfo: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value.<span class="hljs-property">remoteInfo</span>));</li><li>}</li><li>tlsServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">(<span class="hljs-params">client: socket.TLSSocketConnection</span>) =&gt;</span> {</li><li>  client.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, callback);</li><li>
</li><li>  <span class="hljs-comment">// 发送数据。</span></li><li>  client.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello, client!'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'send success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'send fail'</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 断开连接。</span></li><li>  client.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'close success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'close fail'</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 可以指定传入on中的callback取消一个订阅，也可以不指定callback清空所有订阅。</span></li><li>  client.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>, callback);</li><li>  client.<span class="hljs-title function_">off</span>(<span class="hljs-string">'message'</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>取消订阅TLSSocketServer的相关事件。</p>       <div _ngcontent-qee-c106="" class="highlight-div"><div _ngcontent-qee-c106="" class="highlight-div-header"><div _ngcontent-qee-c106="" class="highlight-div-header-left"><div _ngcontent-qee-c106="" class="handle-button expand-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qee-c106="" class="highlight-div-header-right"><div _ngcontent-qee-c106="" class="handle-button ai-button"></div><div _ngcontent-qee-c106="" class="handle-button line-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qee-c106="" class="handle-button theme-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qee-c106="" class="handle-button copy-button"><div _ngcontent-qee-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qee-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 取消订阅tlsServer的相关事件</span></li><li>tlsServer.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connect'</span>);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>