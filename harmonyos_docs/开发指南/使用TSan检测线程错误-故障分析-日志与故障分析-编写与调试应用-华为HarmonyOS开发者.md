<h1 _ngcontent-xek-c119="" class="doc-title ng-star-inserted" title="使用TSan检测线程错误"> 使用TSan检测线程错误 </h1>

<div _ngcontent-xek-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001891219114"><p id="ZH-CN_TOPIC_0000002478334540__p1897975261813">TSan（ThreadSanitizer）是一个检测数据竞争的工具。它包含一个编译器插桩模块和一个运行时库。TSan开启后，会使性能降低5到15倍，同时使内存占用率提高5到10倍。关于TSan的检测原理和异常检测类型请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-tsan-detection" target="_blank">TSan</a>。</p> <div class="tiledSection"><h2 id="section2632174514396">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section2632174514396" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1271385917226" class="firsth2">应用场景<i class="anchor-icon anchor-icon-link" anchorid="section1271385917226" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002478334540__p4591116172314">TSan能够检测出如下问题：</p> <ul id="ZH-CN_TOPIC_0000002478334540__ul5591716102318"><li id="li75917161233">数据竞争检测<p id="ZH-CN_TOPIC_0000002478334540__p3591816102312">数据竞争（Data Race）是指两个或多个线程在没有适当的同步机制情况下同时访问相同的内存位置，其中至少有一个线程在写入。数据竞争是导致多线程程序行为不可预测的主要原因之一。</p> </li></ul> <ul id="ZH-CN_TOPIC_0000002478334540__ul259416162320"><li id="li459141610231">锁错误检测<p id="ZH-CN_TOPIC_0000002478334540__p1459616132315">TSan 不仅能检测数据竞争，还能检测与锁相关的错误：</p> <ul id="ZH-CN_TOPIC_0000002478334540__ul259121610235"><li id="li459101616235">死锁（Deadlock）：死锁是指两个或多个线程互相等待对方释放锁，导致程序无法继续执行。</li><li id="li105931662318">双重解锁（Double Unlock）：同一线程尝试解锁已经解锁的锁。</li><li id="li18591165231">未持有锁解锁：一个线程尝试解锁一个它未持有的锁。</li></ul> </li></ul> <ul id="ZH-CN_TOPIC_0000002478334540__ul4597162232"><li id="li13591816132312">条件变量错误检测<p id="ZH-CN_TOPIC_0000002478334540__p1359121615236">条件变量用于线程之间的通信和同步，常见错误包括：</p> <ul id="ZH-CN_TOPIC_0000002478334540__ul1359171642316"><li id="li05951616239">未持有锁等待：一个线程在未持有相关锁的情况下调用 wait。</li><li id="li45981632319">未持有锁唤醒：一个线程在未持有相关锁的情况下调用 signal 或 broadcast。</li></ul> </li></ul> </div> <div class="tiledSection"><h3 id="section1457192317234">错误报告<i class="anchor-icon anchor-icon-link" anchorid="section1457192317234" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002478334540__p12969193502319">当 TSan 检测到错误时，它会生成详细的报告，包括：</p> <ul id="ZH-CN_TOPIC_0000002478334540__ul597093517239"><li id="li897020357232">错误类型：例如数据竞争、死锁等。</li><li id="li12970193518238">内存地址：涉及的内存地址。</li><li id="li1997073518238">线程信息：涉及的线程ID和线程创建的堆栈跟踪。</li><li id="li189701235192319">源代码位置：每一个内存访问的源代码位置和堆栈跟踪。</li><li id="li89701735182315">上下文信息：访问类型（读/写）、访问大小等。</li></ul> </div> <div class="tiledSection"><h2 id="section1665820539148">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section1665820539148" tips="复制节点链接"></i></h2><ul id="ZH-CN_TOPIC_0000002478334540__ul106321789321"><li id="li5632158123217">TSan仅支持API 12及以上版本。</li><li id="li2065910471997">ASan、TSan、UBSan、HWASan不能同时开启，四个只能开启其中一个。</li><li id="li88821349174218">TSan开启后会申请大量虚拟内存，其他申请大虚拟内存的功能（如gpu图形渲染）可能会受影响。</li><li id="li2411111312586">TSan不支持静态链接libc或libc++库。</li></ul> </div> <div class="tiledSection"><h2 id="section111599216114">使能TSan<i class="anchor-icon anchor-icon-link" anchorid="section111599216114" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002478334540__p9236353113">可通过以下两种方式使能TSan。</p> </div> <div class="tiledSection"><h3 id="section1289183162016" class="firsth2">方式一<i class="anchor-icon anchor-icon-link" anchorid="section1289183162016" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002478334540__ol5749164611135"><li id="li16816161918189"><span>点击<strong>Run &gt; Edit Configurations &gt;</strong> <strong>Diagnostics</strong>，勾选<strong>Thread Sanitizer</strong>。</span><p></p><p id="ZH-CN_TOPIC_0000002478334540__p1717503551817"><span><img originheight="226" originwidth="694" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.23962366059284631870158365729113:50001231000000:2800:F8A08EF59BD621D6951096562C306F06A5A32F414DBBEDD56BE1E5E012724F7E.png" width="694" height="226"></span></p> <p></p></li><li id="li17749104615131"><span>如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_TSAN=ON”，表示以TSan模式编译so文件。</span><p></p><p id="ZH-CN_TOPIC_0000002478334540__p175054505139"><span><img originheight="519" originwidth="935" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.11560000588172474697440426835657:50001231000000:2800:2B817830D535EFF8CC50EE107E20552CA3CD17CA6003D0D90DE20E4F6FE791B0.png" width="920" height="510.67379679144386"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section8891931102015">方式二<i class="anchor-icon anchor-icon-link" anchorid="section8891931102015" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002478334540__ol8177953121311"><li id="li1217715391315"><span>修改工程目录下AppScope/app.json5，添加TSan配置开关。</span><p></p><div _ngcontent-xek-c106="" class="highlight-div"><div _ngcontent-xek-c106="" class="highlight-div-header"><div _ngcontent-xek-c106="" class="highlight-div-header-left"><div _ngcontent-xek-c106="" class="handle-button expand-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xek-c106="" class="highlight-div-header-right"><div _ngcontent-xek-c106="" class="handle-button ai-button"></div><div _ngcontent-xek-c106="" class="handle-button line-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xek-c106="" class="handle-button theme-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xek-c106="" class="handle-button copy-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xek-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478334540__screen141151345256" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-attr">"tsanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478334540__p177410483720"><span><img originheight="434" originwidth="1307" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.78158964037363444106315061721173:50001231000000:2800:5F7EE5DEECEFC0CDE3A4B933F2106F72A9DC21F7FC63A50B3BE7F785BB0955EE.png" width="920" height="305.49349655700075"></span></p> <p></p></li><li id="li19177185316137"><span>设置模块级构建TSan插桩。</span><p></p><p id="ZH-CN_TOPIC_0000002478334540__p128781759275">在需要使能TSan的模块中，通过添加构建参数开启TSan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数：</p> <div _ngcontent-xek-c106="" class="highlight-div"><div _ngcontent-xek-c106="" class="highlight-div-header"><div _ngcontent-xek-c106="" class="highlight-div-header-left"><div _ngcontent-xek-c106="" class="handle-button expand-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xek-c106="" class="highlight-div-header-right"><div _ngcontent-xek-c106="" class="handle-button ai-button"></div><div _ngcontent-xek-c106="" class="handle-button line-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xek-c106="" class="handle-button theme-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xek-c106="" class="handle-button copy-button"><div _ngcontent-xek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xek-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" id="ZH-CN_TOPIC_0000002478334540__screen28785598710" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_TSAN=ON"</span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478334540__p198782591071"><span><img originheight="448" originwidth="1290" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.60339013746375798642564647355466:50001231000000:2800:55AC2F3D64FE8577D8D845E285E9DC6B65B6EABAF86BBA38407E5DB31D97BDC1.png" width="920" height="319.50387596899225"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section989133116209">启用TSan<i class="anchor-icon anchor-icon-link" anchorid="section989133116209" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478334540__ol1327243717121"><li id="zh-cn_topic_0000001536844965_li493493716719"><span>运行或调试当前应用。</span></li><li id="li824420817265"><span>当程序出现线程错误时，弹出TSan log信息，点击信息中的链接即可跳转至引起线程错误的代码处。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002478334540__p98596289470">当前使用call_once接口会存在TSan误报的现象，开发者可以在调用该接口的函数前添加__attribute__((no_sanitize("thread")))来屏蔽该问题。</p> </div></div></div> <p id="ZH-CN_TOPIC_0000002478334540__p11206151114261"><span><img originheight="605" originwidth="1212" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.54930855227809149115708738232120:50001231000000:2800:03927489CCDB73304107DB56D19CE01C3E790F58317FAA7680E0E7F8B2B3A1A1.png" width="920" height="459.2409240924092"></span></p> <p></p></li><li id="li19755173517137"><span>如果是release应用，本地无工程代码，可以使用AnalyzeStackTrace功能，提供要解析堆栈的so，解析结果为源码地址。</span><p></p><p id="ZH-CN_TOPIC_0000002478334540__p1585711910460"><span><img height="300.2145613026341" originheight="598" originwidth="1875" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104843.60583254692811551884938984858199:50001231000000:2800:06AA3F3EE54DC413AAD4C9EB3CF10C7997A5F9B005AC9542CAF0F443897E6149.png" title="点击放大" width="920"></span></p> <p></p></li></ol> </div> </div> <div></div></div>