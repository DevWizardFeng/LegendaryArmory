<h1 _ngcontent-emd-c119="" class="doc-title ng-star-inserted" title="使用TaskPool执行多个耗时任务"> 使用TaskPool执行多个耗时任务 </h1>

<div _ngcontent-emd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>多个任务同时执行时，由于任务复杂度不同，执行时间和返回数据的时间也会不同。如果宿主线程需要所有任务执行完毕的数据，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskgroup10" target="_blank">TaskGroup</a>的方式实现。</p>    <p>除了以上情况，如果需要处理的数据量较大，例如一个列表中有10000条数据，将这些数据放在一个Task中处理会非常耗时。那么就可以将原始数据拆分成多个子列表，为每个子列表分配一个独立的Task执行，等待全部Task执行完成后合并结果形成完整的数据，这样可以节省处理时间，提升用户体验。</p>    <p>下面以多个任务进行图片加载为例进行说明。</p>    <ol>     <li>      <p>实现子线程中需要执行的任务。</p>      <div _ngcontent-emd-c106="" class="highlight-div"><div _ngcontent-emd-c106="" class="highlight-div-header"><div _ngcontent-emd-c106="" class="highlight-div-header-left"><div _ngcontent-emd-c106="" class="handle-button expand-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emd-c106="" class="highlight-div-header-right"><div _ngcontent-emd-c106="" class="handle-button ai-button"></div><div _ngcontent-emd-c106="" class="handle-button line-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emd-c106="" class="handle-button theme-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emd-c106="" class="handle-button copy-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// IconItemSource.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IconItemSource</span> {</li><li>  <span class="hljs-attr">image</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">image: <span class="hljs-built_in">string</span> | Resource = <span class="hljs-string">''</span>, text: <span class="hljs-built_in">string</span> | Resource = <span class="hljs-string">''</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">image</span> = image;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li></ol></pre></div></div>      <div _ngcontent-emd-c106="" class="highlight-div"><div _ngcontent-emd-c106="" class="highlight-div-header"><div _ngcontent-emd-c106="" class="highlight-div-header-left"><div _ngcontent-emd-c106="" class="handle-button expand-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emd-c106="" class="highlight-div-header-right"><div _ngcontent-emd-c106="" class="handle-button ai-button"></div><div _ngcontent-emd-c106="" class="handle-button line-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emd-c106="" class="handle-button theme-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emd-c106="" class="handle-button copy-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// IndependentTask.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IconItemSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IconItemSource'</span>;</li><li> </li><li><span class="hljs-comment">// 在TaskPool线程中执行的方法，需要添加@Concurrent注解，否则无法正常调用</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPicture</span>(<span class="hljs-params">count: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">IconItemSource</span>[] {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">iconItemSourceList</span>: <span class="hljs-title class_">IconItemSource</span>[] = [];</li><li>  <span class="hljs-comment">// 遍历添加6*count个IconItem的数据</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; count; index++) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">numStart</span>: <span class="hljs-built_in">number</span> = index * <span class="hljs-number">6</span>;</li><li>    <span class="hljs-comment">// 此处循环使用6张预定义的图片资源（例如：startIcon、background、foreground等）</span></li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:startIcon'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">1</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:background'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">2</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:foreground'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">3</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:startIcon'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">4</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:background'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">5</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:foreground'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">6</span>}</span>`</span>));</li><li>
</li><li>  }</li><li>  <span class="hljs-keyword">return</span> iconItemSourceList;</li><li>}</li></ol></pre></div></div></li>     <li>      <p>将需要执行的Task放到一个TaskGroup里面，当TaskGroup中的所有Task执行完毕后，会将所有Task的结果都放在一个数组中并返回给宿主线程，而不是每执行完一个Task就返回一次，这样宿主线程就可以在返回的数据里拿到所有Task的执行结果，便于后续使用。</p>      <div _ngcontent-emd-c106="" class="highlight-div"><div _ngcontent-emd-c106="" class="highlight-div-header"><div _ngcontent-emd-c106="" class="highlight-div-header-left"><div _ngcontent-emd-c106="" class="handle-button expand-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-emd-c106="" class="highlight-div-header-right"><div _ngcontent-emd-c106="" class="handle-button ai-button"></div><div _ngcontent-emd-c106="" class="handle-button line-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-emd-c106="" class="handle-button theme-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-emd-c106="" class="handle-button copy-button"><div _ngcontent-emd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-emd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IconItemSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IconItemSource'</span>;</li><li><span class="hljs-keyword">import</span> { loadPicture } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IndependentTask'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">iconItemSourceList</span>: <span class="hljs-title class_">IconItemSource</span>[][] = [];</li><li>
</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">taskGroup</span>: taskpool.<span class="hljs-property">TaskGroup</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">TaskGroup</span>();</li><li>            taskGroup.<span class="hljs-title function_">addTask</span>(<span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(loadPicture, <span class="hljs-number">30</span>));</li><li>            taskGroup.<span class="hljs-title function_">addTask</span>(<span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(loadPicture, <span class="hljs-number">20</span>));</li><li>            taskGroup.<span class="hljs-title function_">addTask</span>(<span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(loadPicture, <span class="hljs-number">10</span>));</li><li>            taskpool.<span class="hljs-title function_">execute</span>(taskGroup).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> tmpLength = (ret <span class="hljs-keyword">as</span> <span class="hljs-title class_">IconItemSource</span>[][]).<span class="hljs-property">length</span>;</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tmpLength; i++) {</li><li>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; ret[i].<span class="hljs-property">length</span>; j++) {</li><li>                  iconItemSourceList.<span class="hljs-title function_">push</span>(ret[i][j]);</li><li>                }</li><li>              }</li><li>              <span class="hljs-comment">// The length of iconItemSourceList is 360</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The length of iconItemSourceList is "</span> + iconItemSourceList.<span class="hljs-property">length</span>);</li><li>            })</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>