<h1 _ngcontent-sub-c119="" class="doc-title ng-star-inserted" title="使用TaskPool执行独立的耗时任务"> 使用TaskPool执行独立的耗时任务 </h1>

<div _ngcontent-sub-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>对于独立运行的耗时任务，任务完成后将结果返回给宿主线程。可采用以下方式实现。</p> <p>下面通过图片加载来说明。</p> <ol><li><p>实现子线程需要执行的任务。</p>  <div _ngcontent-sub-c106="" class="highlight-div"><div _ngcontent-sub-c106="" class="highlight-div-header"><div _ngcontent-sub-c106="" class="highlight-div-header-left"><div _ngcontent-sub-c106="" class="handle-button expand-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sub-c106="" class="highlight-div-header-right"><div _ngcontent-sub-c106="" class="handle-button ai-button"></div><div _ngcontent-sub-c106="" class="handle-button line-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sub-c106="" class="handle-button theme-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sub-c106="" class="handle-button copy-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sub-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// IconItemSource.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IconItemSource</span> {</li><li>  <span class="hljs-attr">image</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">image: <span class="hljs-built_in">string</span> | Resource = <span class="hljs-string">''</span>, text: <span class="hljs-built_in">string</span> | Resource = <span class="hljs-string">''</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">image</span> = image;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li></ol></pre></div></div>    <div _ngcontent-sub-c106="" class="highlight-div"><div _ngcontent-sub-c106="" class="highlight-div-header"><div _ngcontent-sub-c106="" class="highlight-div-header-left"><div _ngcontent-sub-c106="" class="handle-button expand-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sub-c106="" class="highlight-div-header-right"><div _ngcontent-sub-c106="" class="handle-button ai-button"></div><div _ngcontent-sub-c106="" class="handle-button line-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sub-c106="" class="handle-button theme-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sub-c106="" class="handle-button copy-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sub-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// IndependentTask.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IconItemSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IconItemSource'</span>;</li><li> </li><li><span class="hljs-comment">// 在TaskPool线程中执行的方法，需要添加@Concurrent注解，否则无法正常调用。</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPicture</span>(<span class="hljs-params">count: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">IconItemSource</span>[] {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">iconItemSourceList</span>: <span class="hljs-title class_">IconItemSource</span>[] = [];</li><li>  <span class="hljs-comment">// 遍历添加6*count个IconItem的数据</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; count; index++) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">numStart</span>: <span class="hljs-built_in">number</span> = index * <span class="hljs-number">6</span>;</li><li>    <span class="hljs-comment">// 此处循环使用6张图片资源</span></li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:startIcon'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">1</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:background'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">2</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:foreground'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">3</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:startIcon'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">4</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:background'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">5</span>}</span>`</span>));</li><li>    iconItemSourceList.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IconItemSource</span>(<span class="hljs-string">'$media:foreground'</span>, <span class="hljs-string">`item<span class="hljs-subst">${numStart + <span class="hljs-number">6</span>}</span>`</span>));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> iconItemSourceList;</li><li>}</li></ol></pre></div></div>   </li><li><p>使用TaskPool的execute方法执行任务，加载图片。</p>  <div _ngcontent-sub-c106="" class="highlight-div"><div _ngcontent-sub-c106="" class="highlight-div-header"><div _ngcontent-sub-c106="" class="highlight-div-header-left"><div _ngcontent-sub-c106="" class="handle-button expand-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sub-c106="" class="highlight-div-header-right"><div _ngcontent-sub-c106="" class="handle-button ai-button"></div><div _ngcontent-sub-c106="" class="handle-button line-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sub-c106="" class="handle-button theme-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sub-c106="" class="handle-button copy-button"><div _ngcontent-sub-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sub-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IconItemSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IconItemSource'</span>;</li><li><span class="hljs-keyword">import</span> { loadPicture } <span class="hljs-keyword">from</span> <span class="hljs-string">'./IndependentTask'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">iconItemSourceList</span>: <span class="hljs-title class_">IconItemSource</span>[] = [];</li><li>            <span class="hljs-comment">// 创建Task</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">loadPictureTask</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(loadPicture, <span class="hljs-number">30</span>);</li><li>            <span class="hljs-comment">// 执行Task，并返回结果</span></li><li>            taskpool.<span class="hljs-title function_">execute</span>(loadPictureTask).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// loadPicture方法的执行结果</span></li><li>              iconItemSourceList = res <span class="hljs-keyword">as</span> <span class="hljs-title class_">IconItemSource</span>[];</li><li>              <span class="hljs-comment">// 输出结果是：The length of iconItemSourceList is 180</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The length of iconItemSourceList is "</span> + iconItemSourceList.<span class="hljs-property">length</span>);</li><li>            })</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> <div></div></div>