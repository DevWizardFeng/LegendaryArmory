<h1 _ngcontent-huq-c119="" class="doc-title ng-star-inserted" title="使用UI上下文接口操作界面（UIContext）"> 使用UI上下文接口操作界面（UIContext） </h1>

<div _ngcontent-huq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本文主要介绍了多UI实例涉及的概念，以及使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext" target="_blank">UIContext</a>的方法替换全局接口的原因，并提供了相应的替换方案。</p>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p><strong>UI实例：</strong> UI实例是用于管理用户界面的对象，主要负责组件、布局、动画以及交互事件等UI功能的管理。每个窗口对象都会创建并管理一个UI实例。</p>     <p><strong>UI上下文：</strong> UI上下文是指UI实例运行环境的抽象概念，UI功能在UI上下文中运行，其效果最终反映在相应的UI实例中。</p>     <p><strong>全局接口：</strong> ArkUI提供的一系列全局接口，这些接口在调用时无需显式指定UI实例或组件。它们会根据调用发生时所在的UI上下文，自动作用于相应的UI实例。</p>    </div>    <div class="tiledSection">     <h2 id="ui上下文不明确">UI上下文不明确<i class="anchor-icon anchor-icon-link" anchorid="ui上下文不明确" tips="复制节点链接"></i></h2>          <p>UI上下文不明确是指调用ArkUI全局接口时，调用点无法明确指认UI实例的问题。</p>     <p>当前的系统支持两种<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-models">应用模型</a>——FA模型和Stage模型。在FA模型中，每个UI实例拥有独立的ArkTS引擎，全局接口可以通过ArkTS引擎跟踪到对应的UI实例上，因此不存在UI上下文不明确的问题。</p>     <p>在Stage模型中，一个ArkTS引擎中可运行多个ArkUI实例。全局接口通过分析调用链中的上下文信息来确定当前UI上下文，异步接口和非UI接口可能导致UI上下文跟踪失败。</p>     <p>为了保证全局接口的相关功能正常，开发者应当使用UIContext的接口替换全局接口。</p>     <p>下图展示了Stage模型下ArkTS引擎和UI上下文的对应关系，一个ArkTS引擎中存在两个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/abilitykit-overview">Ability</a>，这些Ability对应了三个窗口，三个窗口各自对应一个ArkUI实例。</p>     <p><strong>图1</strong> 多实例关系图</p>     <p><span><img originheight="264" originwidth="492" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114755.27873954436224963768981742932064:50001231000000:2800:7A3A04A98197C739DB64CE19D7C7063BA2CB258441644EE8BD1E36CBDFE9632C.png" width="492" height="264"></span></p>    </div>    <div class="tiledSection">     <h2 id="uicontext接口替换全局接口的关系">UIContext接口替换全局接口的关系<i class="anchor-icon anchor-icon-link" anchorid="uicontext接口替换全局接口的关系" tips="复制节点链接"></i></h2>          <p>部分多实例替代接口如下表所示，UIContext实例支持的全量接口以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext" target="_blank">UIContext</a>中描述为准。</p>     <p>示例代码使用的接口中，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#isavailable20" target="_blank">isAvailable</a>从API version 20开始生效，其余接口从API version 18开始生效。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.1" valign="top" width="33.33333333333333%">全局接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.2" valign="top" width="33.33333333333333%">替代接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.animator</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">createAnimator</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">自定义动画控制器</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.arkui.componentSnapshot</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getComponentSnapshot</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">组件截图</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.arkui.componentUtils</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getComponentUtils</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">组件工具类</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.arkui.dragController</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getDragController</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">拖拽控制器</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.arkui.inspector</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getUIInspector</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">组件布局回调</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.arkui.observer</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getUIObserver</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无感监听</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.font</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getFont</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">自定义字体</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.measure</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getMeasureUtil</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">文本计算</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.mediaquery</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getMediaQuery</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">媒体查询</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.promptAction</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getPromptAction</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">@ohos.router</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getRouter</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">页面路由</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">AlertDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">showAlertDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">警告弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ActionSheet</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">showActionSheet</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">列表选择弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">CalendarPickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">不支持</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">日历选择器弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">DatePickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">showDatePickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">日期滑动选择弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">TimePickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">showTimePickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">时间滑动选择器弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">TextPickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">showTextPickerDialog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">文本滑动选择器弹窗</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ContextMenu</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getContextMenuController</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">菜单控制</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">vp2px/px2vp/fp2px/px2fp/lpx2px/px2lpx</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">vp2px/px2vp/fp2px/px2fp/lpx2px/px2lpx</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">像素单位转换</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">focusControl</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getFocusControl</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">焦点控制</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">cursorControl</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getCursorControl</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">光标控制</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getContext</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getHostContext</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">获取当前的Ability的Context</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">LocalStorage.getShared</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">getSharedLocalStorage</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">获取Ability传递的Storage</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">animateTo</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">animateTo</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">显式动画</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">animateToImmediately</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">不支持</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">显式立即动画</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="常见uicontext接口替换全局接口的场景">常见UIContext接口替换全局接口的场景<i class="anchor-icon anchor-icon-link" anchorid="常见uicontext接口替换全局接口的场景" tips="复制节点链接"></i></h2>          <p>以下UIContext接口替换全局接口示例以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-pixel-units" target="_blank">像素单位</a>接口为例。</p>    </div>    <div class="tiledSection">     <h3 id="通过自定义组件获取uicontext" class="firsth2">通过自定义组件获取UIContext<i class="anchor-icon anchor-icon-link" anchorid="通过自定义组件获取uicontext" tips="复制节点链接"></i></h3>          <p>当全局接口在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ui-js-custom-components">自定义组件</a>的成员方法或组件生命周期方法等其他作用域中，且this指向自定义组件时，可以通过调用自定义组件的成员方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-api#getuicontext" target="_blank">getUIContext</a>来获取UIContext对象。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>在异步调用的回调方法中使用getUIContext，或者该接口的起始调用不在当前页面时，可能会在自定义组件销毁后调用接口，从而导致返回undefined。</li>        <li>该方法只能通过this调用，不能通过new关键字创建的自定义组件对象调用。</li>        <li>通过在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode">自定义声明式节点 (BuilderNode)</a>中创建的自定义节点获取的UIContext与创建BuilderNode的UIContext指向同一个UI实例。</li>       </ol>      </div></div></div>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/NewGlobal.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Calculate 20vp to px'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> pxValue = <span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Calculate 20vp to px'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>          <span class="hljs-keyword">let</span> pxValue = uiContext.<span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="通过窗口对象获取uicontext对象">通过窗口对象获取UIContext对象<i class="anchor-icon anchor-icon-link" anchorid="通过窗口对象获取uicontext对象" tips="复制节点链接"></i></h3>          <p>开发者可以通过窗口对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#getuicontext10" target="_blank">getUIContext</a>方法获取UIContext对象。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>必须在UI实例创建完成后，才可以通过窗口对象的getUIContext方法获取UIContext。建议在loadContent的成功回调中调用，以确保UI实例准备就绪。</li>        <li>vp2px/px2vp在UI实例未创建时会获取默认值进行计算，替换时可考虑获取当前默认的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#display" target="_blank">Display</a>对象的逻辑像素密度进行计算结果，可参考<a href="/consumer/cn/doc/harmonyos-guides/arkts-global-interface#像素单位转换接口替换为uicontext接口">像素单位转换接口替换为UIContext接口</a>。</li>       </ol>      </div></div></div>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">ConfigurationConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-comment">// 在loadContent前调用时，vp2px会根据屏幕默认像素密度返回计算结果。</span></li><li>    <span class="hljs-keyword">let</span> pxValue = <span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 需要在回调中调用。</span></li><li>      <span class="hljs-keyword">let</span> pxValue = <span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// loadContent是异步接口，在此处调用不能保证UI实例已经创建成功。</span></li><li>    pxValue = <span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">ConfigurationConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable language_">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    <span class="hljs-comment">// 在loadContent前调用getUIContext时，UI实例未创建，存在异常。</span></li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 需要在回调中调用。</span></li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>        <span class="hljs-keyword">if</span> (!uiContext) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">let</span> pxValue = uiContext.<span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>      } <span class="hljs-keyword">catch</span>(e) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext, <span class="hljs-subst">${e}</span>`</span>);</li><li>      }</li><li>    });</li><li>    <span class="hljs-comment">// loadContent是异步接口，在此处调用不能保证UI实例已经创建成功。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>    <span class="hljs-comment">// 在窗口销毁时需要移除失效的UIContext</span></li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-title function_">removeUIContext</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="在封装的接口中获取ui上下文">在封装的接口中获取UI上下文<i class="anchor-icon anchor-icon-link" anchorid="在封装的接口中获取ui上下文" tips="复制节点链接"></i></h3>          <p>开发者通常在封装的接口中使用全局接口。对于这类场景，应优先考虑增加UIContext类型的入参。如果应用只有一个窗口，可以使用全局存储对象来保存UIContext。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>创建UI实例是异步过程，需要在回调中调用窗口对象的getUIContext来获取UIContext对象。</li>        <li>建议增加可选的UIContext入参，方便调用者传入UIContext。</li>        <li>vp2px/px2vp在UI实例未创建时会获取默认值进行计算，替换时可考虑获取当前默认的Display对象的逻辑像素密度进行计算，可参考<a href="/consumer/cn/doc/harmonyos-guides/arkts-global-interface#像素单位转换接口替换为uicontext接口">像素单位转换接口替换为UIContext接口</a>。</li>       </ol>      </div></div></div>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// common/Utils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PixelUtils</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">vp2px</span>(<span class="hljs-attr">vpValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vp2px</span>(vpValue);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">fp2px</span>(<span class="hljs-attr">fpValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fp2px</span>(fpValue);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">lpx2px</span>(<span class="hljs-attr">lpxValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">lpx2px</span>(lpxValue);</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// common/Utils.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PixelUtils</span> {</li><li>  <span class="hljs-keyword">static</span> uiContext : <span class="hljs-title class_">UIContext</span> | <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setUIContext</span>(uiContext : <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span> = uiContext;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">removeUIContext</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">vp2px</span>(<span class="hljs-attr">vpValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">vp2px</span>(vpValue)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">fp2px</span>(<span class="hljs-attr">fpValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">fp2px</span>(fpValue)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">lpx2px</span>(<span class="hljs-attr">lpxValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">lpx2px</span>(lpxValue)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PixelUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/Utils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable language_">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 需要在回调中调用。</span></li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>        <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-title function_">setUIContext</span>(uiContext);</li><li>      } <span class="hljs-keyword">catch</span>(e) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext, <span class="hljs-subst">${e}</span>`</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>    <span class="hljs-comment">// 在窗口销毁时需要移除失效的UIContext。</span></li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-title function_">removeUIContext</span>();</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <p>使用替换的封装接口时，建议在能够获取UIContext的场景下传入UIContext参数。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PixelUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/Utils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Calculate 20vp to px'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> pxValue = <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>无法获取UIContext时，可考虑直接调用。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> pxValue = <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-title function_">vp2px</span>(<span class="hljs-number">20</span>);</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`20vp equals to <span class="hljs-subst">${pxValue}</span>px`</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="应用存在多窗时通过最近获焦窗口获取uicontext">应用存在多窗时，通过最近获焦窗口获取UIContext<i class="anchor-icon anchor-icon-link" anchorid="应用存在多窗时通过最近获焦窗口获取uicontext" tips="复制节点链接"></i></h3>          <p>当应用有多个窗口且无法直接获取UIContext时，可通过最近获得焦点的窗口获取其UIContext。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>该方案将跟踪最近一个获得焦点的窗口，在调用具体功能时，该窗口可能处于失焦状态。</li>        <li>创建窗口时需要调用registerWindowCallback注册回调。</li>       </ol>      </div></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// common/WindowUtils.ets</span></li><li><span class="hljs-keyword">import</span> { display, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowUIContextUtils</span> {</li><li>  <span class="hljs-keyword">static</span> activeUIContext : <span class="hljs-title class_">UIContext</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">registerWindowCallback</span>(<span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span>) : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      windowClass.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowEvent'</span>, <span class="hljs-function">(<span class="hljs-params">event: <span class="hljs-variable language_">window</span>.WindowEventType</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (event === <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowEventType</span>.<span class="hljs-property">WINDOW_ACTIVE</span>) {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> uiContext = windowClass.<span class="hljs-title function_">getUIContext</span>();</li><li>            <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-property">activeUIContext</span> = uiContext;</li><li>          } <span class="hljs-keyword">catch</span>(exception) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext, <span class="hljs-subst">${exception}</span>`</span>);</li><li>          }</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister callback. Cause: <span class="hljs-subst">${exception}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">unregisterWindowCallback</span>(<span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span>): <span class="hljs-built_in">void</span> {</li><li>    windowClass.<span class="hljs-title function_">off</span>(<span class="hljs-string">'windowEvent'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setActiveUIContext</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>) : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-property">activeUIContext</span> = uiContext;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">vp2px</span>(<span class="hljs-attr">vpValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-property">activeUIContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      <span class="hljs-keyword">let</span> displayClass = display.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>      <span class="hljs-keyword">let</span> density = displayClass.<span class="hljs-property">densityPixels</span>;</li><li>      <span class="hljs-keyword">return</span> vpValue * density;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">vp2px</span>(vpValue);</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUIContextUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/WindowUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable language_">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    <span class="hljs-comment">// 注册主窗的回调。</span></li><li>    <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-title function_">registerWindowCallback</span>(<span class="hljs-variable language_">window</span>);</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/WindowTestPage'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 需要在loadContent完成后获取UIContext。</span></li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>        <span class="hljs-comment">// 主窗获焦可能早于loadContent完成，需要在成功后设置保证有效。</span></li><li>        <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-title function_">setActiveUIContext</span>(uiContext)</li><li>      } <span class="hljs-keyword">catch</span>(exception) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to getUIContext in loadContent. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(exception));</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageWillDestroy</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable language_">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`The main window: <span class="hljs-subst">${<span class="hljs-variable language_">window</span>}</span>`</span>);</li><li>    <span class="hljs-comment">// 注销主窗的回调。</span></li><li>    <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-title function_">unregisterWindowCallback</span>(<span class="hljs-variable language_">window</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/WindowTestPage.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUIContextUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/WindowUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> subWindow : <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Create SubWindow'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Configuration</span> = {</li><li>            <span class="hljs-attr">name</span>: <span class="hljs-string">"test"</span>,</li><li>            <span class="hljs-attr">windowType</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowType</span>.<span class="hljs-property">TYPE_DIALOG</span>,</li><li>            <span class="hljs-attr">ctx</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()</li><li>          };</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">createWindow</span>(config, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, windowClass: <span class="hljs-variable language_">window</span>.Window</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;</li><li>              <span class="hljs-keyword">if</span> (errCode) {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to create the window. Cause: <span class="hljs-subst">${errCode}</span>`</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>              <span class="hljs-comment">// 在窗口创建后注册回调。</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">subWindow</span> = windowClass;</li><li>              <span class="hljs-keyword">try</span> {</li><li>                windowClass.<span class="hljs-title function_">setUIContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-title function_">registerWindowCallback</span>(windowClass);</li><li>                  windowClass.<span class="hljs-title function_">resize</span>(<span class="hljs-number">500</span>, <span class="hljs-number">1000</span>);</li><li>                  windowClass.<span class="hljs-title function_">showWindow</span>();</li><li>                });</li><li>              } <span class="hljs-keyword">catch</span>(exception) {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to setUIContent. Cause : <span class="hljs-subst">${exception}</span>`</span>);</li><li>              }</li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (exception) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to create the window. Cause : <span class="hljs-subst">${exception}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Destroy SubWindow'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subWindow</span>) {</li><li>            <span class="hljs-comment">// 在窗口销毁前注销回调。</span></li><li>            <span class="hljs-title class_">WindowUIContextUtils</span>.<span class="hljs-title function_">unregisterWindowCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">subWindow</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">subWindow</span>.<span class="hljs-title function_">destroyWindow</span>();</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="执行绑定ui实例的闭包">执行绑定UI实例的闭包<i class="anchor-icon anchor-icon-link" anchorid="执行绑定ui实例的闭包" tips="复制节点链接"></i></h3>          <p>对于UIContext中没有提供替代的接口（例如CalendarPickerDialog），或者开发者自定义实现的业务行为与多实例相关，需要和实例绑定时（例如，一个代码段），可以使用UIContext对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#runscopedtask" target="_blank">runScopedTask</a>方法执行闭包。</p>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CalendarPickerDialogPage</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">selectedDate</span>: <span class="hljs-title class_">Date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2025-10-01'</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Show CalendarPicker Dialog'</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>          uiContext.<span class="hljs-title function_">runScopedTask</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">CalendarPickerDialog</span>.<span class="hljs-title function_">show</span>({</li><li>              <span class="hljs-attr">selected</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>,</li><li>              <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,</li><li>              <span class="hljs-attr">backgroundBlurStyle</span>: <span class="hljs-title class_">BlurStyle</span>.<span class="hljs-property">NONE</span>,</li><li>              <span class="hljs-attr">shadow</span>: <span class="hljs-title class_">ShadowStyle</span>.<span class="hljs-property">OUTER_FLOATING_SM</span></li><li>            });</li><li>          });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="特殊全局接口替换示例">特殊全局接口替换示例<i class="anchor-icon anchor-icon-link" anchorid="特殊全局接口替换示例" tips="复制节点链接"></i></h2>          <p>部分全局接口在替换为UIContext接口时，需要考虑一些特殊的调用场景。</p>    </div>    <div class="tiledSection">     <h3 id="像素单位转换接口替换为uicontext接口" class="firsth2">像素单位转换接口替换为UIContext接口<i class="anchor-icon anchor-icon-link" anchorid="像素单位转换接口替换为uicontext接口" tips="复制节点链接"></i></h3>          <p>因为不同的UI实例可以有不同的转换系数，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-pixel-units" target="_blank">像素单位</a>接口计算结果依赖UI实例。其中fp2px/px2fp/lpx2px/px2lpx接口在无有效UI上下文时会返回undefined，而vp2px/px2vp接口在无有效UI上下文时，会获取默认屏幕像素密度进行计算。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.4.1.1" valign="top" width="33.33333333333333%">像素单位转换接口调用时机</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.4.1.2" valign="top" width="33.33333333333333%">接口行为</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.4.1.3" valign="top" width="33.33333333333333%">可能与预期不一致的场景</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">主窗口创建并调用loadContent或setUIContent前。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>没有合适的UI实例。</p>          <p>px2vp/vp2px使用默认屏幕的density进行换算，返回结果。</p>          <p>fp2px/px2fp/lpx2px/px2lpx返回undefined。</p></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">px2vp/vp2px在多屏场景下可能与预期不一致。如预期以主屏的逻辑像素密度计算结果，实际以扩展屏的像素密度计算结果。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">在loadContent或setUIContent后，且在UI的回调函数中。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">根据UI跟踪的调用域（Scope）找到具体的UI实例，使用该UI实例关联的信息进行计算。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">应用单Ability单窗口的场景，并在loadContent或setUIContent之后，但在非UI的其他异步回调中调用。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无法根据UI跟踪的调用域（Scope）找到具体的UI实例，但根据当前单例场景可以确定唯一UI实例，使用该UI实例关联的信息进行计算。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">多Ability或多窗口的多UI实例场景，在loadContent或setUIContent调用之后，但在其他异步回调中调用。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无法根据UI跟踪的调用域（Scope）找到具体的UI实例，也无法确定唯一实例。接口按照最近获焦、最近前台、最近创建的优先级依次查找匹配的UI实例，并根据UI实例关联的信息进行计算。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">多实例场景可能存在作用实例和预期不一致。如预期以主窗所处屏幕的逻辑像素密度计算结果，实际以子窗所处屏幕的像素密度计算结果。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">所有的窗口销毁，无UI实例后。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>没有合适的UI实例。</p>          <p>px2vp/vp2px使用默认屏幕的density进行换算，返回结果。</p>          <p>fp2px/px2fp/lpx2px/px2lpx返回undefined。</p></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">px2vp/vp2px在多屏场景下可能与预期不一致。如预期以扩展屏的逻辑像素密度计算结果，实际以主屏的像素密度计算结果。</td>        </tr>             </tbody></table></div>     </div>     <p>在实际的开发场景中，全局接口可能在UI实例创建前被调用。此时，在替换vp2px/px2vp时，开发者可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#displaygetdefaultdisplaysync9" target="_blank">display.getDefaultDisplaySync</a>获取当前默认屏幕的逻辑像素密度计算结果；替换fp2px/px2fp/lpx2px/px2lpx接口时，可以直接返回undefined，以保证行为的一致性。</p>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Common/UIContext.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PixelUtils</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">vp2px</span>(<span class="hljs-attr">vpValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vp2px</span>(vpValue);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">fp2px</span>(<span class="hljs-attr">fpValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fp2px</span>(fpValue);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">lpx2px</span>(<span class="hljs-attr">lpxValue</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">lpx2px</span>(lpxValue);</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PixelUtils</span> {</li><li>  <span class="hljs-keyword">static</span> uiContext : <span class="hljs-title class_">UIContext</span> | <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setUIContext</span>(uiContext : <span class="hljs-title class_">UIContext</span>) : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span> = uiContext;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">removeUIContext</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li> <span class="hljs-keyword">static</span> <span class="hljs-title function_">vp2px</span>(<span class="hljs-attr">vpValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>   <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      <span class="hljs-keyword">let</span> displayClass = display.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>      <span class="hljs-keyword">let</span> density = displayClass.<span class="hljs-property">densityPixels</span>;</li><li>      <span class="hljs-keyword">return</span> vpValue * density;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">vp2px</span>(vpValue)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">fp2px</span>(<span class="hljs-attr">fpValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">fp2px</span>(fpValue)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">lpx2px</span>(<span class="hljs-attr">lpxValue</span>: <span class="hljs-built_in">number</span>, uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> _uiContext = uiContext??<span class="hljs-title class_">PixelUtils</span>.<span class="hljs-property">uiContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!_uiContext || !_uiContext.<span class="hljs-title function_">isAvailable</span>()) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Can't get UIContext`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> _uiContext.<span class="hljs-title function_">lpx2px</span>(lpxValue)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="获取ability的context">获取Ability的Context<i class="anchor-icon anchor-icon-link" anchorid="获取ability的context" tips="复制节点链接"></i></h3>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-getcontext" target="_blank">getContext</a>接口用于在UI页面中获取对应UI实例所属Ability的Context，因此依赖于UI实例。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.1" valign="top" width="33.33333333333333%">getContext接口的调用时机</th>         <th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.2" valign="top" width="33.33333333333333%">接口行为</th>         <th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.3" valign="top" width="33.33333333333333%">可能与预期不一致的场景</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">主窗口创建并调用loadContent或setUIContent前。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">没有合适的UI实例，返回undefined。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">主窗口创建并调用loadContent或setUIContent后，且传入自定义组件对象。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">跟踪自定义组件所属的UI实例，返回该UI实例所属Ability的Context。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">在loadContent或setUIContent后，且在UI的回调函数中。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">根据UI跟踪的调用域（Scope）找到具体的UI实例，返回该UI实例所属Ability的Context。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">应用单Ability单窗口的场景，并在loadContent或setUIContent之后，但在非UI的其他异步回调中调用且未传入自定义组件对象。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无法根据UI跟踪的调用域（Scope）找到具体的UI实例，但根据当前单例场景可以确定唯一UI实例，返回该UI实例所属Ability的Context。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">多Ability或多窗口的多UI实例场景，在loadContent或setUIContent调用之后，但在其他异步回调中调用且未传入自定义组件对象。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无法根据UI跟踪的调用域(Scope)找到具体的UI实例，也无法确定唯一实例。接口按照最近获焦、最近前台、最近创建的优先级依次查找匹配的UI实例，返回该UI实例所属Ability的Context。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">多实例场景可能与预期不一致。如存在两个Ability时，预期返回第一个创建的Ability的Context，实际返回第二个创建的Ability的Context。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">所有的窗口销毁，无UI实例后。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">没有合适的UI实例，返回undefined。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>             </tbody></table></div>     </div>     <p>在单Ability场景中，建议直接获取Ability的context属性。</p>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Common/ContextUtils.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GetContextPage</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 需要确保传入的是自定义组件对象。</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>);</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`The context is <span class="hljs-subst">${context}</span>`</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// common/ContextUtils.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextUtils</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">setContext</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-property">context</span> = context;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">removeContext</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getContext</span>(uiContext?: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">if</span> (uiContext) {</li><li>      <span class="hljs-keyword">return</span> uiContext.<span class="hljs-title function_">getHostContext</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-property">context</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>接口的默认返回值设置为Ability的成员属性context。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entryAbility/EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContextUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/ContextUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>    <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-title function_">setContext</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>    <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-title function_">removeContext</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <p>在UI界面中，建议传入UIContext，以保证符合预期或直接调用getHostContext。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContextUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/ContextUtils'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ContextPage</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'getContext'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`The context is <span class="hljs-subst">${context}</span>`</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>无UI场景直接返回窗口创建时设置的默认返回值。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> context = <span class="hljs-title class_">ContextUtils</span>.<span class="hljs-title function_">getContext</span>();</li><li>hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`The context is <span class="hljs-subst">${context}</span>`</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="localstorage替换为uicontext的接口">LocalStorage替换为UIContext的接口<i class="anchor-icon anchor-icon-link" anchorid="localstorage替换为uicontext的接口" tips="复制节点链接"></i></h3>          <p>LocalStorage是页面级的UI状态存储，通过@Entry装饰器接收的参数可以在页面内共享同一个LocalStorage实例。使用全局接口时，开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-state-management#getshareddeprecated" target="_blank">getShared</a>向@Entry装饰器传递LocalStorage对象。使用UIContext接口后，无法直接获取UIContext对象，可以将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-entry#entryoptions10" target="_blank">EntryOptions</a>的useSharedStorage参数设置为true，以使用共享的LocalStorage实例对象。</p>     <p>使用全局接口：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/LocalStoragePage</span></li><li><span class="hljs-meta">@Entry</span>({<span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>()})</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">LocalStoragePage</span> {</li><li>  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'message'</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'LocalStoragePageHelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> storage = <span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>();</li><li>          <span class="hljs-keyword">if</span> (storage) {</li><li>            storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'message'</span>, <span class="hljs-string">'onClick is called.'</span>)</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用UIContext接口替换：</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/LocalStoragePage</span></li><li><span class="hljs-meta">@Entry</span>({<span class="hljs-attr">useSharedStorage</span>: <span class="hljs-literal">true</span>})</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">LocalStoragePage</span> {</li><li>  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'message'</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'LocalStoragePageHelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>          <span class="hljs-keyword">let</span> storage = uiContext.<span class="hljs-title function_">getSharedLocalStorage</span>();</li><li>          <span class="hljs-keyword">if</span> (storage) {</li><li>            storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'message'</span>, <span class="hljs-string">'onClick is called.'</span>)</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用共享的LocalStorage对象需要在loadContent时传入LocalStorage，详细可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage">LocalStorage：页面级UI状态存储</a>。</p>     <div _ngcontent-huq-c106="" class="highlight-div"><div _ngcontent-huq-c106="" class="highlight-div-header"><div _ngcontent-huq-c106="" class="highlight-div-header-left"><div _ngcontent-huq-c106="" class="handle-button expand-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-huq-c106="" class="highlight-div-header-right"><div _ngcontent-huq-c106="" class="handle-button ai-button"></div><div _ngcontent-huq-c106="" class="handle-button line-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-huq-c106="" class="handle-button theme-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-huq-c106="" class="handle-button copy-button"><div _ngcontent-huq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-huq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable language_">localStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'message'</span>, <span class="hljs-string">'Message from Storage'</span>)</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/LocalStoragePage'</span>, <span class="hljs-variable language_">localStorage</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`loadContent success.`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>