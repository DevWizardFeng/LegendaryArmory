<h1 _ngcontent-yql-c119="" class="doc-title ng-star-inserted" title="使用URPC进行远程程序调用"> 使用URPC进行远程程序调用 </h1>

<div _ngcontent-yql-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section123091617105820">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section123091617105820" tips="复制节点链接"></i></h2>          <p>发送一个URPC请求，可以设置优先级等参数，返回来自远程服务器的URPC响应。当发起请求后，可以选择取消指定或正在进行的URPC请求。当完成请求后，需要关闭请求来释放与此URPC关联的资源。</p>    </div>    <div class="tiledSection">     <h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2>          <p>使用URPC进行远程程序调用能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section24845415583">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section24845415583" tips="复制节点链接"></i></h2>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-urpcapi#section848492671817" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50.22%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="49.78%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50.22%">          <p>call: (funcName: string, request: object, returnValue: object, config?: CallingOption) =&gt; UrpcPromise</p></td>         <td class="cellrowborder" valign="top" width="49.78%">          <p>发送一个URPC请求，并返回来自服务器的URPC响应。使用Promise异步回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50.22%">          <p>cancel: (callingId?: number | number[]) =&gt; void</p></td>         <td class="cellrowborder" valign="top" width="49.78%">          <p>取消指定或所有正在进行的URPC请求，返回值为空。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50.22%">          <p>destroy: () =&gt; void</p></td>         <td class="cellrowborder" valign="top" width="49.78%">          <p>销毁UrpcStub实例</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section5714101911223">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section5714101911223" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section7948103662710" class="firsth2">创建urpcStub<i class="anchor-icon anchor-icon-link" anchorid="section7948103662710" tips="复制节点链接"></i></h3>          <ol>      <li><span>导入模块</span>       <p></p>       <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.PerformanceAnalysisKit"</span>;</li><li><span class="hljs-keyword">import</span> { urpc } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.RemoteCommunicationKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>定义远程调用的类，作为调用方法的入参和返回值，示例如下：</span>       <p></p>       <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义调用方法的入参类示例</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaTaskRequestMessage</span> {</li><li>  <span class="hljs-title class_">RequestMessage</span>: urpc.<span class="hljs-property">FlowbufElement</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">RequestMessage</span> = {<span class="hljs-attr">type</span>: <span class="hljs-string">'STRING'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">""</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>};</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setRequestMessage</span>(<span class="hljs-params">RequestMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">RequestMessage</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">RequestMessage</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getRequestMessage</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">RequestMessage</span>.<span class="hljs-property">value</span>;</li><li>  }</li><li>
</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义用于接收调用方法返回值的类示例</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaTaskResponseMessage</span> {</li><li>  <span class="hljs-title class_">ResponseMessage</span>: urpc.<span class="hljs-property">FlowbufElement</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ResponseMessage</span> = {<span class="hljs-attr">type</span>: <span class="hljs-string">'STRING'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">""</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>};</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setResponseMessage</span>(<span class="hljs-params">ResponseMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ResponseMessage</span>.<span class="hljs-property">value</span> = <span class="hljs-title class_">ResponseMessage</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getResponseMessage</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ResponseMessage</span>.<span class="hljs-property">value</span>;</li><li>  }</li><li>
</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>创建Request对象和Response接收对象。</span>       <p></p>       <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaTaskRequestMessage</span>();</li><li><span class="hljs-keyword">let</span> response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaTaskResponseMessage</span>();</li></ol></pre></div></div>       <p></p></li>      <li><span>配置连接信息，创建发起URPC调用的UrpcStub。</span>       <p></p>       <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">node</span>: urpc.<span class="hljs-property">IpAndPort</span> = {</li><li>  <span class="hljs-attr">ip</span>: <span class="hljs-string">'127.0.0.1'</span>,</li><li>  <span class="hljs-attr">port</span>: <span class="hljs-number">8000</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">connect</span>: urpc.<span class="hljs-property">UrpcConnectConfiguration</span> = {</li><li>  <span class="hljs-attr">node</span>: node,</li><li>  <span class="hljs-attr">protocol</span>: <span class="hljs-string">'eat'</span>,</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: urpc.<span class="hljs-property">UrpcInitConfiguration</span> = {</li><li>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,</li><li>  <span class="hljs-attr">mode</span>: <span class="hljs-string">'client'</span>,</li><li>  <span class="hljs-attr">connect</span>: connect</li><li>}</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">funcList</span>:<span class="hljs-built_in">string</span>[] = [<span class="hljs-string">"uploadFile"</span>];</li><li><span class="hljs-keyword">let</span> urpcStub = urpc.<span class="hljs-title function_">urpcStubCreate</span>(config, funcList);</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section116601452164118">使用call收发网络请求<i class="anchor-icon anchor-icon-link" anchorid="section116601452164118" tips="复制节点链接"></i></h3>          <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>urpcStub.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">stub</span>: urpc.<span class="hljs-property">UrpcStub</span>) =&gt;{</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">upload_config</span>: urpc.<span class="hljs-property">CallingOption</span> = {</li><li>    <span class="hljs-attr">priority</span>: <span class="hljs-number">0</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> urpcPromise = stub.<span class="hljs-title function_">call</span>(<span class="hljs-string">"uploadFile"</span>, request, response, upload_config);</li><li>  urpcPromise.<span class="hljs-property">promise</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resp: <span class="hljs-built_in">object</span></span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">"urpc"</span>, <span class="hljs-string">"resp: %{public}s"</span>, resp);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">"urpc"</span>, <span class="hljs-string">"the error code is %d"</span>, err.<span class="hljs-property">code</span>);</li><li>  })</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">"urpc"</span>, <span class="hljs-string">"urpc call failed, error code is %d"</span>, error.<span class="hljs-property">code</span>);</li><li>})</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section257771011429">（可选）使用cancel取消网络请求<i class="anchor-icon anchor-icon-link" anchorid="section257771011429" tips="复制节点链接"></i></h3>          <p>当调用call发起一次urpc收发请求后，根据业务需要，不用接收响应时，可调用cancel取消指定callingId的请求；若不指定callingId，则取消UrpcStub发起的全部请求。</p>     <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>urpcStub.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">stub</span>: urpc.<span class="hljs-property">UrpcStub</span>) =&gt;{</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">upload_config</span>: urpc.<span class="hljs-property">CallingOption</span> = {</li><li>    <span class="hljs-attr">priority</span>: <span class="hljs-number">0</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> urpcPromise = stub.<span class="hljs-title function_">call</span>(<span class="hljs-string">"uploadFile"</span>, request, response, upload_config);</li><li>  stub.<span class="hljs-title function_">cancel</span>(urpcPromise.<span class="hljs-property">callingId</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">"urpc"</span>, <span class="hljs-string">"urpc cancel failed, error code is %d"</span>, error.<span class="hljs-property">code</span>);</li><li>})</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section7984163517428">使用destroy关闭URPC<i class="anchor-icon anchor-icon-link" anchorid="section7984163517428" tips="复制节点链接"></i></h3>          <p>当完成所有urpc收发网络请求后，需调用destroy释放并销毁UrpcStub相关的资源。</p>     <div _ngcontent-yql-c106="" class="highlight-div"><div _ngcontent-yql-c106="" class="highlight-div-header"><div _ngcontent-yql-c106="" class="highlight-div-header-left"><div _ngcontent-yql-c106="" class="handle-button expand-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yql-c106="" class="highlight-div-header-right"><div _ngcontent-yql-c106="" class="handle-button ai-button"></div><div _ngcontent-yql-c106="" class="handle-button line-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yql-c106="" class="handle-button theme-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yql-c106="" class="handle-button copy-button"><div _ngcontent-yql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yql-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>urpcStub.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">stub</span>: urpc.<span class="hljs-property">UrpcStub</span>) =&gt;{</li><li>  stub.<span class="hljs-title function_">destroy</span>();</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">"urpc"</span>, <span class="hljs-string">"urpc destroy failed, error code is %d"</span>, error.<span class="hljs-property">code</span>);</li><li>})</li></ol></pre></div></div>    </div>   </div>   <div></div></div>