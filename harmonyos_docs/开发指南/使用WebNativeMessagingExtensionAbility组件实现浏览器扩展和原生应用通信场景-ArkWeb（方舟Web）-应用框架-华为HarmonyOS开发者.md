<h1 _ngcontent-wvu-c119="" class="doc-title ng-star-inserted" title="使用WebNativeMessagingExtensionAbility组件实现浏览器扩展和原生应用通信场景"> 使用WebNativeMessagingExtensionAbility组件实现浏览器扩展和原生应用通信场景 </h1>

<div _ngcontent-wvu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>浏览器的扩展程序（extension）支持与系统上安装的原生应用交换消息，原生应用向扩展提供服务，帮助扩展实现一些原生应用才具备的能力，常见的例子是密码管理器：原生应用负责存储和加密你的密码信息，以便浏览器扩展程序自动填充网页中的表单字段。</p>     <p>从API version 21开始，支持开发者在原生应用中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability" target="_blank">WebNativeMessagingExtensionAbility</a>组件，为浏览器扩展提供后台服务能力。</p>     <p>浏览器扩展通过<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions/API/runtime" target="_blank">WebExtensions runtime API</a>连接WebNativeMessagingExtensionAbility，双方通信是通过共享pipe文件描述符后调用IO接口实现。</p>     <p><span><img originheight="541" originwidth="661" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114719.42271508249355627059775112040975:50001231000000:2800:0D7E6AE9DD974915FA016FD424978116E93B838049450CCA66EBF55F24432A52.png" width="661" height="541"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>本文将浏览器扩展调用WebExtension接口runtime.connectNative建立的连接称为NativeMessaging连接。</p>       <p>NativeMessaging面向两类开发者：原生应用开发者和浏览器应用开发者。两者均需要了解WebNativeMessagingExtensionAbility运作机制，但关注的场景和接口不同。原生应用开发者关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability" target="_blank">WebNativeMessagingExtensionAbility</a>组件的使用，负责相关业务开发；浏览器应用开发者负责建立NativeMessaging连接，关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionmanager" target="_blank">WebNativeMessagingExtensionManager</a>相关接口。</p>       <p>本文会在具体的描述中，特意标注需要哪类开发者关注。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="设备限制" class="firsth2">设备限制<i class="anchor-icon anchor-icon-link" anchorid="设备限制" tips="复制节点链接"></i></h3>          <p>WebNativeMessagingExtensionAbility组件当前仅支持2in1设备。</p>    </div>    <div class="tiledSection">     <h3 id="规格限制">规格限制<i class="anchor-icon anchor-icon-link" anchorid="规格限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>WebNativeMessagingExtensionAbility组件无需额外权限，允许任意三方应用集成使用，但拉起方（浏览器）需申请ACL权限（ohos.permission.WEB_NATIVE_MESSAGING）。此权限仅对浏览器类应用开放。</p></li>      <li>       <p>WebNativeMessagingExtensionAbility组件内不支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window" target="_blank">Window</a>相关API。</p></li>      <li>       <p>WebNativeMessagingExtensionAbility仅支持拉起本应用的UIAbility，不支持拉起其他应用UIAbility或者其他类型ExtensionAbility。</p></li>      <li>       <p>WebNativeMessagingExtensionAbility仅用于浏览器扩展与原生应用通信场景，不支持如后台服务等其他场景使用。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="整体流程" class="firsth2">整体流程<i class="anchor-icon anchor-icon-link" anchorid="整体流程" tips="复制节点链接"></i></h3>          <p><span><img originheight="541" originwidth="761" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114719.70294928777774704539402607385694:50001231000000:2800:9DF271D094BB76489F761FA81FB16F4D24127E6A98A16032E0C35F7478EB4ACF.png" width="761" height="541"></span></p>     <ul>      <li><strong>流程：</strong></li>     </ul>     <ol>      <li><strong>浏览器扩展</strong>调用runtime.connectNative接口传入原生应用包名，来创建NativeMessaging连接。</li>      <li><strong>浏览器应用</strong>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-config">dataShare</a>获取原生应用配置信息，包括WebNativeMessagingExtension的名称，和限制访问规则（是否允许某个扩展访问该WebNativeMessagingExtension）。</li>      <li><strong>浏览器应用</strong>创建两组pipe作为收发双向通道，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionmanager#webnativemessagingextensionmanagerconnectnative" target="_blank">WebNativeMessagingExtensionManager.connectNative</a>接口，拉起WebNativeMessagingExtension并创建一条NativeMessaging连接，并将pipe的收发文件描述符作为参数传输过去。</li>      <li><strong>原生应用</strong>WebNativeMessagingExtensionAbility被拉起，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability#onconnectnative" target="_blank">WebNativeMessagingExtensionAbility.onConnectNative</a>生命周期回调触发，获取pipe的文件描述符。</li>      <li><strong>原生应用</strong>监听读端的文件描述符，获取浏览器扩展发过来的消息指令，并通过写端的文件描述符发送回去。</li>      <li><strong>原生应用</strong>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensioncontext#startability" target="_blank">WebNativeMessagingExtensionContext.startAbility</a>拉起本应用的UIAbility图形界面。</li>     </ol>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>WebNativeMessagingExtensionAbility为单实例独立进程，多次调用connectNative接口仅拉起一个实例，同时触发多次onConnectNative回调，需要<strong>原生应用</strong>管理多会话场景。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="datashare存放原生应用extension配置信息">dataShare存放原生应用extension配置信息<i class="anchor-icon anchor-icon-link" anchorid="datashare存放原生应用extension配置信息" tips="复制节点链接"></i></h3>          <p>原生应用集成WebNativeMessagingExtensionAbility时，需要通过dataShare能力向浏览器应用提供extension配置。该配置用于浏览器应用判断允许访问的扩展及指定要拉起的WebNativeMessagingExtensionAbility名称。</p>     <p>extension配置采用json字符串格式</p>     <ul>      <li>extensionAbility属性：字符串，WebNativeMessagingExtensionAbility名称，用于填充want中abilityName字段，一个原生应用仅有一个WebNativeMessagingExtensionAbility。</li>      <li>allowed_origins属性：数组，允许访问该WebNativeMessagingExtensionAbility的浏览器扩展url信息，可以配置多条，不同浏览器的扩展有不同的scheme协议，例如华为浏览器使用chrome-extension协议头。</li>     </ul>     <p>extension配置格式：</p>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-comment">// 原生应用包名</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-comment">// 具体描述</span></li><li>  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Send message to native app."</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">   * WebNativeMessagingExtensionAbility名称，用于元能力want填充abilityName，一个应用应只有一个</span></li><li><span class="hljs-comment">   * WebNativeMessagingExtensionAbility</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-attr">"abilityName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webExtensionAbility"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">   * 允许访问该WebNativeMessagingExtensionAbility的浏览器扩展url信息，不同的浏览器的扩展有不同的scheme协议，华为浏览器使用chrome-extension协议头</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-attr">"allowed_origins"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span></li><li>    <span class="hljs-string">"chrome-extension://knldjmfmopnpolahpmmgbagdohdnhkik/"</span></li><li>  <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>     <p>extension配置存放在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-config#modulejson5-配置">dataShare配置项</a>，uri为固定格式：datashardporxy://[包名]/browserNativeMessagingHosts。</p>    </div>    <div class="tiledSection">     <h3 id="webnativemessagingextensionability生命周期管理">WebNativeMessagingExtensionAbility生命周期管理<i class="anchor-icon anchor-icon-link" anchorid="webnativemessagingextensionability生命周期管理" tips="复制节点链接"></i></h3>          <ul>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability#onconnectnative" target="_blank">onConnectNative</a>：当浏览器扩展调用一次runtime.connectNative时触发，如果WebNativeMessagingExtensionAbility尚未运行，调用runtime.connectNative会拉起WebNativeMessagingExtensionAbility，并触发该回调。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability#ondisconnectnative" target="_blank">onDisconnectNative</a>：当浏览器扩展销毁runtime.port时，会触发一次该回调，每条nativeMessaging连接的断开，都会触发一次该回调，当全部连接都断开时，会触发onDestroy的回调后关闭WebNativeMessagingExtensionAbility。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability#ondestroy" target="_blank">onDestroy</a>：当WebNativeMessagingExtensionAbility销毁前触发该回调，全部NativeMessaging连接断开会触发WebNativeMessagingExtensionAbility的销毁。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensioncontext#stopnativeconnection" target="_blank">stopNativeConnection</a>：WebNativeMessagingExtensionAbility可以主动断开一条NativeMessaging连接，如果断开的是最后一条连接，则会触发WebNativeMessagingExtensionAbility的销毁。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensioncontext#terminateself" target="_blank">terminateSelf</a>：WebNativeMessagingExtensionAbility可以主动退出，触发后会销毁所有NativeMessaging连接。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="消息格式和限制">消息格式和限制<i class="anchor-icon anchor-icon-link" anchorid="消息格式和限制" tips="复制节点链接"></i></h3>          <p>NativeMessaging连接使用的具体格式，每个消息都使用 JSON 进行序列化，编码为 UTF-8，并在前面附加 32 位消息长度（采用原生字节顺序）。来自WebNativeMessagingExtensionAbility的单个消息的大小上限为 1 MB，这主要是为了保护浏览器免受行为异常的原生应用影响。发送到WebNativeMessagingExtensionAbility的消息大小上限为 64 MB。</p>    </div>    <div class="tiledSection">     <h3 id="实现一个connectnative的扩展原生应用开发者">实现一个connectNative的扩展（原生应用开发者）<i class="anchor-icon anchor-icon-link" anchorid="实现一个connectnative的扩展原生应用开发者" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>需按w3c标准配置manifest.json和background.js实现通信。</p>       <p>支持使用chrome.runtime.connectNative或chrome.runtime.sendNativeMessage进行连接。</p>      </div></div></div>     <p>配置插件内容，发送ping字符串并接收pong响应的插件代码，示例如下：</p>     <p><strong>实现配置manifest.json</strong></p>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.1"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch APP"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"nativeMessaging"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tabs"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"scripting"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//根据实际场景是否需要进行选择</span></li><li>  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"http://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ftp://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"file://*/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//根据实际场景选择</span></li><li>  <span class="hljs-attr">"background"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"service_worker"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"background.js"</span> <span class="hljs-comment">//用于运行插件runtime命令</span></li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"http://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ftp://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"file://*/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//根据实际场景选择</span></li><li>      <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"main.js"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">//用于运行插件js命令</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.html"</span> <span class="hljs-comment">//插件页面展示</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>     <p><strong>实现main.js</strong></p>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 从html中触发调用</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToNative</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">var</span> message = <span class="hljs-string">"ping"</span>; <span class="hljs-comment">// 发送ping</span></li><li>  chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-string">"sendMessage"</span>,</li><li>    <span class="hljs-attr">message</span>: message</li><li>  }, <span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) {});</li><li>}</li></ol></pre></div></div>     <p><strong>实现配置background.js</strong></p>     <ol>      <li>使用chrome.runtime.connectNative链接</li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">var</span> port = <span class="hljs-literal">null</span>;</li><li><span class="hljs-comment">//监听来自main.js的信息</span></li><li>chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(</li><li>  <span class="hljs-keyword">function</span> (<span class="hljs-params">request, sender, sendResponse</span>) {</li><li>    <span class="hljs-keyword">if</span> (request.<span class="hljs-property">type</span> == <span class="hljs-string">"sendMessage"</span>) {</li><li>      <span class="hljs-keyword">if</span> (port == <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-title function_">connectToNativeHost</span>();</li><li>      }</li><li>      port.<span class="hljs-title function_">postMessage</span>(request.<span class="hljs-property">message</span>); <span class="hljs-comment">//向应用程序发送信息</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//保持消息通道开放</span></li><li>});</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">connectToNativeHost</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">var</span> bundleName = <span class="hljs-string">"com.example.app"</span>; <span class="hljs-comment">//插件对应应用的bundleName</span></li><li>  port = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">connectNative</span>(bundleName); <span class="hljs-comment">//根据bundleName名得到通信端口port</span></li><li>  port.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(onNativeMessage); <span class="hljs-comment">//监听native应用程序是否发来消息</span></li><li>  port.<span class="hljs-property">onDisconnect</span>.<span class="hljs-title function_">addListener</span>(onDisconnected); <span class="hljs-comment">//监听是否断开连接</span></li><li>}</li><li><span class="hljs-comment">//接收到来自native程序的消息时触发</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onNativeMessage</span>(<span class="hljs-params">message</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'接收到从本地应用程序发送来的消息：'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(message)); <span class="hljs-comment">//示例中的pong</span></li><li>}</li><li><span class="hljs-comment">//断开连接时触发</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onDisconnected</span>(<span class="hljs-params"></span>) {</li><li>  port = <span class="hljs-literal">null</span>;</li><li>}</li></ol></pre></div></div>     <ol>      <li>使用chrome.runtime.sendNativeMessage链接</li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendNativeMessage</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">var</span> bundleName = <span class="hljs-string">"com.example.app"</span>; <span class="hljs-comment">//插件对应应用的bundleName</span></li><li>  <span class="hljs-keyword">var</span> nativeMessage = <span class="hljs-string">"ping"</span>; <span class="hljs-comment">//插件要发给应用的内容</span></li><li>  chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendNativeMessage</span>(</li><li>    bundleName,</li><li>    {<span class="hljs-attr">message</span>: nativeMessage},</li><li>    <span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {</li><li>      <span class="hljs-comment">// 收到一次应用回复的信息后断开链接</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"sendNativeMessage收到原生应用程序响应:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response));</li><li>    }</li><li>  )</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="实现一个webnativemessagingextensionability原生应用开发者">实现一个WebNativeMessagingExtensionAbility（原生应用开发者）<i class="anchor-icon anchor-icon-link" anchorid="实现一个webnativemessagingextensionability原生应用开发者" tips="复制节点链接"></i></h3>          <p>在DevEco Studio工程中手动新建一个WebNativeMessagingExtensionAbility组件，具体步骤如下：</p>     <ol>      <li>       <p>在工程Module对应的ets目录下，右键选择“New &gt; Directory”，新建一个目录并命名为MyWebNativeMessageExtAbility。</p></li>      <li>       <p>在MyWebNativeMessageExtAbility目录，右键选择“New &gt; ArkTS File”，新建一个文件并命名为MyWebNativeMessageExtAbility.ets。</p>       <p>其目录结构如下所示：</p>       <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>├── ets</li><li>│ ├── MyWebNativeMessageExtAbility</li><li>│ │   ├── MyWebNativeMessageExtAbility.ets</li><li>└</li></ol></pre></div></div></li>      <li>       <p>在MyWebNativeMessageExtAbility.ets文件中，增加导入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionability" target="_blank">WebNativeMessagingExtensionAbility</a>的依赖包，自定义类继承WebNativeMessagingExtensionAbility组件并实现生命周期回调。</p></li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">WebNativeMessagingExtensionAbility</span>, <span class="hljs-title class_">ConnectionInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>  <span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>  <span class="hljs-keyword">import</span> {buffer, util} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>  <span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MyWebNativeMessageExtAbility]'</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWebNativeMessageExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">WebNativeMessagingExtensionAbility</span> {</li><li>    <span class="hljs-comment">// 读取扩展发来的消息，并回复</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title class_">ReadAsync</span>(<span class="hljs-attr">fdRead</span>:<span class="hljs-built_in">number</span>, <span class="hljs-attr">fdWrite</span>:<span class="hljs-built_in">number</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// read</span></li><li>        <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</li><li>        <span class="hljs-keyword">let</span> readLen = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">read</span>(fdRead, arrayBuffer);</li><li>        <span class="hljs-keyword">if</span> (readLen &lt;= <span class="hljs-number">4</span>) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'read pipe length failed'</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'read pipe %{public}s'</span>, buffer.<span class="hljs-title function_">from</span>(arrayBuffer, <span class="hljs-number">4</span>, readLen - <span class="hljs-number">4</span>).<span class="hljs-title function_">toString</span>());</li><li>
</li><li>        <span class="hljs-comment">// write</span></li><li>        <span class="hljs-keyword">let</span> strResponse : <span class="hljs-built_in">string</span> = <span class="hljs-string">"pong"</span>;</li><li>        <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">TextEncoder</span>(<span class="hljs-string">"utf-8"</span>);</li><li>        <span class="hljs-keyword">const</span> strBytes = encoder.<span class="hljs-title function_">encodeInto</span>(strResponse);</li><li>        <span class="hljs-keyword">let</span> bufferLen = strBytes.<span class="hljs-property">length</span>;</li><li>        <span class="hljs-keyword">const</span> lenBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>        lenBytes[<span class="hljs-number">0</span>] = (bufferLen &gt;&gt; <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>        lenBytes[<span class="hljs-number">1</span>] = (bufferLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>        lenBytes[<span class="hljs-number">2</span>] = (bufferLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>        lenBytes[<span class="hljs-number">3</span>] = (bufferLen &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>        <span class="hljs-keyword">const</span> writeBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span> + bufferLen);</li><li>        writeBuffer.<span class="hljs-title function_">set</span>(lenBytes, <span class="hljs-number">4</span>);</li><li>        writeBuffer.<span class="hljs-title function_">set</span>(strBytes, <span class="hljs-number">4</span>);</li><li>        <span class="hljs-keyword">let</span> writeLen = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">write</span>(fdWrite, writeBuffer.<span class="hljs-property">buffer</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'write pipe length %{public}d'</span>, writeLen);</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'fs io failed, error code: '</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">" message: "</span> + err.<span class="hljs-property">code</span>);</li><li>      }</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onConnectNative</span>(<span class="hljs-attr">info</span>: <span class="hljs-title class_">ConnectionInfo</span>): <span class="hljs-built_in">void</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`onConnectNative, connectionId <span class="hljs-subst">${info.connectionId}</span> caller bundle: <span class="hljs-subst">${info.bundleName}</span>, extension origin: <span class="hljs-subst">${info.extensionOrigin}</span>, pipe Read: <span class="hljs-subst">${info.fdRead}</span>, pipe write <span class="hljs-subst">${info.fdWrite}</span>  `</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">ReadAsync</span>(info.<span class="hljs-property">fdRead</span>, info.<span class="hljs-property">fdWrite</span>)</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onDisconnectNative</span>(<span class="hljs-attr">info</span>: <span class="hljs-title class_">ConnectionInfo</span>): <span class="hljs-built_in">void</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDisconnectNative, connectionId: <span class="hljs-subst">${info.connectionId}</span>`</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onDestroy'</span>);</li><li>    }</li><li>  };</li></ol></pre></div></div>     <ol>      <li>       <p>在工程Module的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file">module.json5配置文件</a>中注册WebNativeMessagingExtensionAbility组件。设置type标签为“webNativeMessaging”，srcEntry标签指向组件代码路径。</p>       <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-attr">"extensionAbilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyWebNativeMessageExtAbility"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webNativeMessaging"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webNativeMessaging"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"exported"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/MyWebNativeMessageExtAbility/MyWebNativeMessageExtAbility.ets"</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>      <li>       <p>在工程Module对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file">module.json5配置文件</a>中配置crossAppSharedConfig，定义共享配置项，共享配置文件需放置在工程resources/base/profile目录下，并通过$资源访问方式引用。</p></li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"crossAppSharedConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$profile:shared_config"</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">}</span></li></ol></pre></div></div>     <p>6.在shared_config.json添加<a href="/consumer/cn/doc/harmonyos-guides/web-native-messaging#datashare存放原生应用extension配置信息">extension配置</a></p>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"crossAppSharedConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-comment">// uri固定格式，datashardporxy://[包名]/browserNativeMessagingHosts，浏览器应用通过该uri获取的value，即extension配置。</span></li><li>        <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"datashareproxy://com.example.app/browserNativeMessagingHosts"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-comment">// extension配置，格式参考extension配置章节的格式，注意转义字符</span></li><li>        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"name\": \"com.example.myapplication\",\"description\": \"Send message to native app.\",\"abilityName\": \"MyWebNativeMessageExtAbility\", \"allowed_origins\":[\"chrome-extension://knldjmfmopnpolahpmmgbagdohdnhkik/\"]}"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"allowList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>          <span class="hljs-comment">// 允许访问的应用appIdentifier, 这里加入具体浏览器的appIdentifier</span></li><li>          <span class="hljs-string">"1234567890123456789"</span></li><li>        <span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="实现拉起webnativemessagingextensionability浏览器开发者">实现拉起WebNativeMessagingExtensionAbility（浏览器开发者）<i class="anchor-icon anchor-icon-link" anchorid="实现拉起webnativemessagingextensionability浏览器开发者" tips="复制节点链接"></i></h3>          <p>浏览器负责实现扩展runtime接口，拉起WebNativeMessagingExtensionAbility，建立和管理NativeMessaging连接。需要申请权限：ohos.permission.WEB_NATIVE_MESSAGING</p>     <ol>      <li>当接收到创建NativeMessaging连接时，先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-datashare#get20" target="_blank">应用间配置共享接口</a>获取目标应用的extension配置。然后读取WebNativeMessagingExtensionAbility名称和允许访问的扩展列表。最后校验是否允许访问。</li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { dataShare } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li>
</li><li>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExtensionConfig</span> {</li><li>    <span class="hljs-attr">abilityName</span>:<span class="hljs-built_in">string</span>;</li><li>    <span class="hljs-attr">allowed_origins</span>:<span class="hljs-built_in">string</span>[];</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getManifestData</span>(<span class="hljs-params">bundleName:<span class="hljs-built_in">string</span>, connectExtensionOrigin:<span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 调用dataShare接口获取extension配置</span></li><li>      <span class="hljs-keyword">const</span> dsProxyHelper = <span class="hljs-keyword">await</span> dataShare.<span class="hljs-title function_">createDataProxyHandle</span>();</li><li>      <span class="hljs-keyword">const</span> urisToGet = [<span class="hljs-string">`datashareproxy://<span class="hljs-subst">${bundleName}</span>/browserNativeMessagingHosts`</span>];</li><li>      <span class="hljs-keyword">const</span> config : dataShare.<span class="hljs-property">DataProxyConfig</span> = {</li><li>        <span class="hljs-attr">type</span>: dataShare.<span class="hljs-property">DataProxyType</span>.<span class="hljs-property">SHARED_CONFIG</span>,</li><li>      };</li><li>      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> dsProxyHelper.<span class="hljs-title function_">get</span>(urisToGet, config);</li><li>      <span class="hljs-keyword">let</span> foundValid = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; results.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">const</span> result = results[i];</li><li>          <span class="hljs-keyword">const</span> json = result.<span class="hljs-property">value</span>;</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> json !== <span class="hljs-string">"string"</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">jsonStr</span>:<span class="hljs-built_in">string</span> = json <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">info</span>:<span class="hljs-title class_">ExtensionConfig</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonStr);</li><li>          <span class="hljs-keyword">if</span> (info.<span class="hljs-property">abilityName</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Native message json info is ok'</span>);</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(info.<span class="hljs-property">allowed_origins</span>)) {</li><li>              info.<span class="hljs-property">allowed_origins</span> = [info.<span class="hljs-property">allowed_origins</span>];</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (!info.<span class="hljs-property">allowed_origins</span>.<span class="hljs-title function_">includes</span>(connectExtensionOrigin)) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Origin not allowed, continue searching'</span>);</li><li>              <span class="hljs-keyword">continue</span>;</li><li>            }</li><li>            foundValid = <span class="hljs-literal">true</span>;</li><li>            <span class="hljs-keyword">break</span>;</li><li>          }</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'NativeMessage JSON parse error:'</span>, error);</li><li>        }</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (!foundValid) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'NativeMessage JSON no valid manifest found'</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMessage allowed_origins match ok'</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error getting config:'</span>, error);</li><li>    }</li><li>  }</li></ol></pre></div></div>     <ol>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionmanager#webnativemessagingextensionmanagerconnectnative" target="_blank">webNativeMessagingExtensionManager.connectNative</a>创建NativeMessage，如WebNativeMessagingExtensionAbility尚未运行，该接口则会拉起ExtensionAbility并触发。</li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>  <span class="hljs-keyword">import</span> { webNativeMessagingExtensionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span></li><li>
</li><li>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionCallback</span> <span class="hljs-keyword">implements</span> webNativeMessagingExtensionManager.<span class="hljs-property">WebExtensionConnectionCallback</span> {</li><li>    <span class="hljs-title function_">onConnect</span>(<span class="hljs-params">connection:webNativeMessagingExtensionManager.ConnectionNativeInfo</span>) {</li><li>      <span class="hljs-comment">// connected</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onConnect id <span class="hljs-subst">${connection.connectionId}</span> is connected`</span>);</li><li>    }</li><li>    <span class="hljs-title function_">onDisconnect</span>(<span class="hljs-params">connection:webNativeMessagingExtensionManager.ConnectionNativeInfo</span>) {</li><li>      <span class="hljs-comment">// disconnect</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onDisconnect id <span class="hljs-subst">${connection.connectionId}</span> is connected`</span>);</li><li>    }</li><li>    <span class="hljs-title function_">onFailed</span>(<span class="hljs-params">code:webNativeMessagingExtensionManager.NmErrorCode, errMsg:<span class="hljs-built_in">string</span></span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onFailed error code is <span class="hljs-subst">${code}</span>, errMsg is <span class="hljs-subst">${errMsg}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectNative</span>(<span class="hljs-params">abilityContext: common.UIAbilityContext, bundleName: <span class="hljs-built_in">string</span>, abilityName: <span class="hljs-built_in">string</span>,</span></li><li><span class="hljs-params">    connectExtensionOrigin: <span class="hljs-built_in">string</span>, readPipe: <span class="hljs-built_in">number</span>, writePipe: <span class="hljs-built_in">number</span></span>) : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">wantInfo</span>:<span class="hljs-title class_">Want</span> = {</li><li>        <span class="hljs-attr">bundleName</span>: bundleName,</li><li>        <span class="hljs-attr">abilityName</span>: abilityName,</li><li>        <span class="hljs-attr">parameters</span>: {</li><li>          <span class="hljs-string">'ohos.arkweb.messageReadPipe'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-string">'FD'</span>, <span class="hljs-string">'value'</span>: readPipe },</li><li>          <span class="hljs-string">'ohos.arkweb.messageWritePipe'</span>: { <span class="hljs-string">'type'</span>: <span class="hljs-string">'FD'</span>, <span class="hljs-string">'value'</span>: writePipe },</li><li>          <span class="hljs-string">'ohos.arkweb.extensionOrigin'</span>: connectExtensionOrigin</li><li>        },</li><li>      };</li><li>
</li><li>      <span class="hljs-keyword">let</span> options : <span class="hljs-title class_">ConnectionCallback</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionCallback</span>;</li><li>      <span class="hljs-keyword">let</span> connectId = webNativeMessagingExtensionManager.<span class="hljs-title function_">connectNative</span>(abilityContext, wantInfo, options);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`innerWebNativeMessageManager  connectionId : <span class="hljs-subst">${connectId}</span>`</span> );</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`inner callback error Message: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>  }</li></ol></pre></div></div>     <ol>      <li>需要销毁NativeMessaging连接时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-web-webnativemessagingextensionmanager#webnativemessagingextensionmanagerdisconnectnative" target="_blank">webNativeMessagingExtensionManager.disconnectNative</a>。</li>     </ol>     <div _ngcontent-wvu-c106="" class="highlight-div"><div _ngcontent-wvu-c106="" class="highlight-div-header"><div _ngcontent-wvu-c106="" class="highlight-div-header-left"><div _ngcontent-wvu-c106="" class="handle-button expand-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvu-c106="" class="highlight-div-header-right"><div _ngcontent-wvu-c106="" class="handle-button ai-button"></div><div _ngcontent-wvu-c106="" class="handle-button line-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvu-c106="" class="handle-button theme-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvu-c106="" class="handle-button copy-button"><div _ngcontent-wvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { webNativeMessagingExtensionManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span></li><li>
</li><li>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnencNative</span>(<span class="hljs-params">connectId: <span class="hljs-built_in">number</span></span>) : <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMessageDisconnect start connectionId is <span class="hljs-subst">${connectId}</span>`</span>);</li><li>    webNativeMessagingExtensionManager.<span class="hljs-title function_">disconnectNative</span>(connectId);</li><li>  }</li></ol></pre></div></div>    </div>   </div>   <div></div></div>