<h1 _ngcontent-ree-c119="" class="doc-title ng-star-inserted" title="使用WebSocket访问网络(C/C++)"> 使用WebSocket访问网络(C/C++) </h1>

<div _ngcontent-ree-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>通过WebSocket模块可以建立服务器与客户端的双向连接。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>WebSocket常用接口如下表所示，详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-net-websocket-h" target="_blank">net_websocket.h</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_Constructor(WebSocket_OnOpenCallback onOpen, WebSocket_OnMessageCallback onMessage, WebSocket_OnErrorCallback onError, WebSocket_OnCloseCallback onclose)</td>         <td class="cellrowborder" valign="top" width="50%">WebSocket客户端的构造函数。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_AddHeader(struct WebSocket *client, struct WebSocket_Header header)</td>         <td class="cellrowborder" valign="top" width="50%">将header头信息添加到client客户端request中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_Connect(struct WebSocket *client, const char *url, struct WebSocket_RequestOptions options)</td>         <td class="cellrowborder" valign="top" width="50%">客户端连接服务端。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_Send(struct WebSocket *client, char *data, size_t length)</td>         <td class="cellrowborder" valign="top" width="50%">客户端向服务端发送数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_Close(struct WebSocket *client, struct WebSocket_CloseOption options)</td>         <td class="cellrowborder" valign="top" width="50%">客户端主动关闭websocket连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_WebSocketClient_Destroy(struct WebSocket *client)</td>         <td class="cellrowborder" valign="top" width="50%">释放websocket连接上下文和资源。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="websocket接口开发示例">WebSocket接口开发示例<i class="anchor-icon anchor-icon-link" anchorid="websocket接口开发示例" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="开发步骤" class="firsth2">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>使用本文档涉及接口创建并连接到WebSocket服务器时，需先创建Native C++工程，在源文件中封装相关接口，然后在ArkTS层调用封装好的接口，使用hilog或console.info等方法将日志打印到控制台或生成设备日志。</p>     <p>本文以建立与WebSocket服务器的连接、向WebSocket服务器发送消息、关闭WebSocket连接为例，提供具体的开发指导。</p>    </div>    <div class="tiledSection">     <h3 id="添加开发依赖">添加开发依赖<i class="anchor-icon anchor-icon-link" anchorid="添加开发依赖" tips="复制节点链接"></i></h3>          <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib:</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libace_napi.z.so</li><li>libnet_websocket.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"network/netstack/net_websocket.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"network/netstack/net_websocket_type.h"</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="构建工程">构建工程<i class="anchor-icon anchor-icon-link" anchorid="构建工程" tips="复制节点链接"></i></h3>          <p>1、在源文件中编写调用该API的代码，接受ArkTS传递过来的url字符串参数，创建WebSocket对象指针后，检查连接到服务器是否成功。</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"network/netstack/net_websocket.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"network/netstack/net_websocket_type.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x3200  <span class="hljs-comment">// 全局domain宏，标识业务领域</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"WSDEMO"</span>   <span class="hljs-comment">// 全局tag宏，标识模块日志tag</span></span></li><li>
</li><li><span class="hljs-comment">// WebSocket客户端全局变量</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebSocket</span> *client = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">onOpen</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> WebSocket *client, WebSocket_OpenResult openResult)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)client;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"onOpen: code: %{public}u, reason: %{public}s"</span>,</li><li>        openResult.code, openResult.reason);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> WebSocket *client, <span class="hljs-type">char</span> *data, <span class="hljs-type">uint32_t</span> length)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)client;</li><li>    <span class="hljs-type">char</span> *tmp = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {</li><li>        tmp[i] = data[i];</li><li>    }</li><li>    tmp[length] = <span class="hljs-string">'\0'</span>;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"onMessage: len: %{public}u, data: %{public}s"</span>,</li><li>        length, tmp);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> WebSocket *client, WebSocket_ErrorResult errorResult)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)client;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"onError: code: %{public}u, message: %{public}s"</span>,</li><li>        errorResult.errorCode, errorResult.errorMessage);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">onClose</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> WebSocket *client, WebSocket_CloseResult closeResult)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)client;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"onClose: code: %{public}u, reason: %{public}s"</span>,</li><li>        closeResult.code, closeResult.reason);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ConnectWebsocket</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    napi_value result;</li><li>    </li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    </li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">false</span>, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    </li><li>    <span class="hljs-keyword">if</span> (client != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"there is already one websocket client running."</span>);</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">false</span>, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    <span class="hljs-type">char</span> *buf = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length + <span class="hljs-number">1</span>];</li><li>    std::<span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, length + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], buf, length + <span class="hljs-number">1</span>, &amp;length);</li><li>    <span class="hljs-comment">// 创建WebSocket Client对象指针</span></li><li>    client = <span class="hljs-built_in">OH_WebSocketClient_Constructor</span>(onOpen, onMessage, onError, onClose);</li><li>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">delete</span>[] buf;</li><li>        <span class="hljs-built_in">napi_get_boolean</span>(env, <span class="hljs-literal">false</span>, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    <span class="hljs-comment">// 连接buf存放的URL对应的WebSocket服务器</span></li><li>    <span class="hljs-type">int</span> connectRet = <span class="hljs-built_in">OH_WebSocketClient_Connect</span>(client, buf, {});</li><li>    </li><li>    <span class="hljs-keyword">delete</span>[] buf;</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, connectRet == <span class="hljs-number">0</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SendMessage</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    napi_value result;</li><li>    </li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    </li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">-1</span>, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    </li><li>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"websocket client not connected."</span>);</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, WebSocket_ErrCode::WEBSOCKET_CLIENT_NULL, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    <span class="hljs-type">char</span> *buf = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length + <span class="hljs-number">1</span>];</li><li>    std::<span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, length + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], buf, length + <span class="hljs-number">1</span>, &amp;length);</li><li>    <span class="hljs-comment">// 发送buf中的消息给服务器</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_WebSocketClient_Send</span>(client, buf, length);</li><li>    </li><li>    <span class="hljs-keyword">delete</span>[] buf;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CloseWebsocket</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value result;</li><li>    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"websocket client not connected."</span>);</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">-1</span>, &amp;result);</li><li>        <span class="hljs-keyword">return</span> result;</li><li>    }</li><li>    <span class="hljs-comment">// 关闭WebSocket连接</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_WebSocketClient_Close</span>(client, {</li><li>        .code = <span class="hljs-number">0</span>,</li><li>        .reason = <span class="hljs-string">"Actively Close"</span>,</li><li>    });</li><li>    <span class="hljs-comment">// 释放WebSocket资源并置空</span></li><li>    <span class="hljs-built_in">OH_WebSocketClient_Destroy</span>(client);</li><li>    client = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div>     <p>ConnectWebsocket函数接收一个WebSocket URL并尝试连接，连接成功返回true，否则返回false。在创建代表WebSocket客户端的WebSocket结构体指针前，需要定义以下回调函数：连接开启时的onOpen回调、接收普通消息的onMessage回调、接收错误消息的onError回调、接收关闭消息的onClose回调。在示例代码中，还调用了OH_WebSocketClient_Send、OH_WebSocketClient_Close等函数向服务器发送消息，主动关闭WebSocket连接。</p>     <p>2、将通过napi封装好的napi_value类型对象初始化导出，通过外部函数接口，将函数暴露给JavaScript使用。示例代码中，ConnectWebsocket函数就会作为外部函数Connect暴露出去；SendMessage函数作为外部函数Send暴露出去；CloseWebsocket函数作为外部函数Close暴露出去。</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li>EXTERN_C_START</li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> {</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"Connect"</span>, nullptr, ConnectWebsocket, nullptr, nullptr, nullptr, napi_default, nullptr },</li><li>        {<span class="hljs-string">"Send"</span>, nullptr, SendMessage, nullptr, nullptr, nullptr, napi_default, nullptr },</li><li>        {<span class="hljs-string">"Close"</span>, nullptr, CloseWebsocket, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>    };</li><li>    napi_define_properties(env, exports, <span class="hljs-keyword">sizeof</span>(desc) / <span class="hljs-keyword">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre></div></div>     <p>3、将上一步中初始化成功的对象通过RegisterEntryModule函数，使用napi_module_register函数将模块注册到 Node.js 中。</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = nullptr,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-type">void</span> <span class="hljs-title function_">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></li><li>{</li><li>    napi_module_register(&amp;demoModule);</li><li>}</li></ol></pre></div></div>     <p>4、在工程的index.d.ts文件中定义函数的类型。比如，Connect函数接受一个string参数作为入参，并返回boolean值指示WebSocket连接是否能成功建立。</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Connect</span>: <span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Send</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Close</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>     <p>5、在index.ets文件中对上述封装好的接口进行调用。</p>     <div _ngcontent-ree-c106="" class="highlight-div"><div _ngcontent-ree-c106="" class="highlight-div-header"><div _ngcontent-ree-c106="" class="highlight-div-header-left"><div _ngcontent-ree-c106="" class="handle-button expand-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ree-c106="" class="highlight-div-header-right"><div _ngcontent-ree-c106="" class="handle-button ai-button"></div><div _ngcontent-ree-c106="" class="handle-button line-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ree-c106="" class="handle-button theme-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ree-c106="" class="handle-button copy-button"><div _ngcontent-ree-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ree-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testWebsocket <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">wsUrl</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">connecting</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">"WebSocket address: "</span>)</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>            .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Start</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          <span class="hljs-title class_">TextInput</span>()</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsUrl</span> = value</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">bottom</span>: <span class="hljs-number">16</span></li><li>        })</li><li>        .<span class="hljs-title function_">padding</span>({</li><li>          <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>,</li><li>          <span class="hljs-attr">right</span>: <span class="hljs-number">16</span></li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Content: "</span>)</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>            .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Start</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          <span class="hljs-title class_">TextInput</span>()</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span>)</li><li>            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = value</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">bottom</span>: <span class="hljs-number">16</span></li><li>        })</li><li>        .<span class="hljs-title function_">padding</span>({</li><li>          <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>,</li><li>          <span class="hljs-attr">right</span>: <span class="hljs-number">16</span></li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Blank</span>()</li><li>
</li><li>        <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Connect'</span>)</li><li>            .<span class="hljs-title function_">enabled</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> connRet = testWebsocket.<span class="hljs-title class_">Connect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsUrl</span>)</li><li>              <span class="hljs-keyword">if</span> (connRet) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span> = <span class="hljs-literal">true</span>;</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Send'</span>)</li><li>            .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              testWebsocket.<span class="hljs-title class_">Send</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Close'</span>)</li><li>            .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> closeResult = testWebsocket.<span class="hljs-title class_">Close</span>()</li><li>              <span class="hljs-keyword">if</span> (closeResult != -<span class="hljs-number">1</span>) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">connecting</span> = <span class="hljs-literal">false</span></li><li>              }</li><li>            })</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>6、配置CMakeLists.txt，本模块需要用到的共享库是libnet_websocket.so，在工程自动生成的CMakeLists.txt中的target_link_libraries中添加此共享库。</p>     <p>注意：如图所示，在add_library中的entry是工程自动生成的modename，若要做修改，需和步骤3中.nm_modname保持一致。</p>     <p><span><img originheight="505" originwidth="1116" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115045.37387048686874936696014713599384:50001231000000:2800:333EEFEB60FEC16B634A4364D7B4B4003B8280C37B8B09E41C8A0E54C3153100.png" width="920" height="416.30824372759855"></span></p>     <p>7、调用WebSocket C API接口要求应用拥有ohos.permission.INTERNET权限，在module.json5中的requestPermissions项添加该权限。</p>     <p>经过以上步骤，整个工程的搭建已经完成，接下来就可以连接设备运行工程进行日志查看了。</p>    </div>    <div class="tiledSection">     <h2 id="测试步骤">测试步骤<i class="anchor-icon anchor-icon-link" anchorid="测试步骤" tips="复制节点链接"></i></h2>          <p>1、连接设备，使用DevEco Studio打开搭建好的工程。</p>     <p>2、运行工程，设备上会弹出以下图片所示界面：</p>     <p><span><img originheight="484" originwidth="630" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115045.67422961203190588632949817874053:50001231000000:2800:68BE15351D342D0666D7C8492318F5E6C96C0EEC86B3E63965928C1AE6BF39F0.jpg" width="630" height="484"></span></p>     <p>简要说明：</p>     <ul>      <li>       <p>在第一行的输入框中，输入ws://或wss://开头的WebSocket URL。</p></li>      <li>       <p>在输入完WebSocket URL，点击Connect按钮后，如果访问成功，会触发onOpen的回调，打印日志。</p></li>      <li>       <p>在Content输入框里输入要发送给服务器的内容，点击Send按钮发送。如果服务器返回消息，会触发onMessage回调，打印日志。</p></li>      <li>       <p>点击Close按钮，WebSocket连接释放，可以重新输入新的WebSocket URL。</p></li>     </ul>     <p><span><img originheight="489" originwidth="630" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115045.36893593034747348407042418066920:50001231000000:2800:447F8A03C90219CDD58EC975768A0C31F9BA73E4D711803FCEB4B609E471A47D.jpg" width="630" height="489"></span></p>     <p><span><img originheight="158" originwidth="1329" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115045.56469522076033482867481655500236:50001231000000:2800:77ED91156406165134B68C5B3B7A4ED84BCB8C37864AB4F1CB93FE822C2E0BF2.png" width="920" height="109.37547027840482"></span></p>    </div>   </div>   <div></div></div>