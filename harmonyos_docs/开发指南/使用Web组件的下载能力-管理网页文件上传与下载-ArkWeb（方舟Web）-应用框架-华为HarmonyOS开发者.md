<h1 _ngcontent-ieg-c119="" class="doc-title ng-star-inserted" title="使用Web组件的下载能力"> 使用Web组件的下载能力 </h1>

<div _ngcontent-ieg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当需要通过Web页面进行文件下载时，可以通过此方式调用Web接口。</p>    <div class="tiledSection">     <h2 id="监听页面触发的下载">监听页面触发的下载<i class="anchor-icon anchor-icon-link" anchorid="监听页面触发的下载" tips="复制节点链接"></i></h2>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#setdownloaddelegate11" target="_blank">setDownloadDelegate()</a>向Web组件注册一个DownloadDelegate来监听页面触发的下载任务。资源由Web组件来下载，Web组件会通过DownloadDelegate将下载的进度通知给应用。</p>     <p>下面的示例中，在应用的rawfile中创建index.html以及download.html。应用启动后会创建一个Web组件并加载index.html，点击setDownloadDelegate按钮向Web组件注册一个DownloadDelegate，点击页面里的下载按钮的时候会触发一个下载任务，在DownloadDelegate中可以监听到下载的进度。</p>     <p>默认路径在应用沙箱的web目录内，用户无法查看。如果希望用户能够查看，需要将下载路径修改到有访问权限的目录，比如Download目录，请参考<a href="/consumer/cn/doc/harmonyos-guides/web-download#使用web组件发起一个下载任务">使用Web组件发起一个下载任务</a>。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">delegate</span>: webview.<span class="hljs-property">WebDownloadDelegate</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebDownloadDelegate</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setDownloadDelegate'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onBeforeDownload</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"will start a download."</span>);</li><li>              <span class="hljs-comment">// 传入一个下载路径，并开始下载。</span></li><li>              <span class="hljs-comment">// 如果传入一个不存在的路径，则会下载到默认/data/storage/el2/base/cache/web/目录。</span></li><li>              webDownloadItem.<span class="hljs-title function_">start</span>(<span class="hljs-string">"/data/storage/el2/base/cache/web/"</span> + webDownloadItem.<span class="hljs-title function_">getSuggestedFileName</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadUpdated</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 下载任务的唯一标识。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>              <span class="hljs-comment">// 下载的进度。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update percent complete: "</span> + webDownloadItem.<span class="hljs-title function_">getPercentComplete</span>());</li><li>              <span class="hljs-comment">// 当前的下载速度。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update speed: "</span> + webDownloadItem.<span class="hljs-title function_">getCurrentSpeed</span>())</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFailed</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>              <span class="hljs-comment">// 下载任务失败的错误码。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed last error code: "</span> + webDownloadItem.<span class="hljs-title function_">getLastErrorCode</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFinish</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download finish guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setDownloadDelegate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>加载的html文件。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- index.html --&gt;</span></li><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li>// 点击视频右下方菜单的下载按钮会触发下载任务。</li><li><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">controls</span>=<span class="hljs-string">"controls"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"580px"</span></span></li><li><span class="hljs-tag">       <span class="hljs-attr">src</span>=<span class="hljs-string">"http://vjs.zencdn.net/v/oceans.mp4"</span></span></li><li><span class="hljs-tag">       <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'data:text/html,%3Ch1%3EHello%2C%20World%21%3C%2Fh1%3E'</span> <span class="hljs-attr">download</span>=<span class="hljs-string">'download.html'</span>&gt;</span>下载download.html<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div>     <p>待下载的html文件。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- download.html --&gt;</span></li><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>download test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="使用web组件发起一个下载任务">使用Web组件发起一个下载任务<i class="anchor-icon anchor-icon-link" anchorid="使用web组件发起一个下载任务" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#startdownload11" target="_blank">startDownload()</a>接口发起一个下载。</p>     <p>Web组件发起的下载会根据当前显示的url以及Web组件默认的Referrer Policy来计算referrer。</p>     <p>在下面的示例中，先点击setDownloadDelegate按钮向Web注册一个监听类，然后点击startDownload主动发起了一个下载，该下载任务也会通过设置的DownloadDelegate来通知app下载的进度。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">delegate</span>: webview.<span class="hljs-property">WebDownloadDelegate</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebDownloadDelegate</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setDownloadDelegate'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onBeforeDownload</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"will start a download."</span>);</li><li>              <span class="hljs-comment">// 传入一个下载路径，并开始下载。</span></li><li>              <span class="hljs-comment">// 如果传入一个不存在的路径，则会下载到默认/data/storage/el2/base/cache/web/目录。</span></li><li>              webDownloadItem.<span class="hljs-title function_">start</span>(<span class="hljs-string">"/data/storage/el2/base/cache/web/"</span> + webDownloadItem.<span class="hljs-title function_">getSuggestedFileName</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadUpdated</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFailed</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFinish</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download finish guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setDownloadDelegate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startDownload'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 这里指定下载地址为 https://www.example.com/，Web组件会发起一个下载任务将该页面下载下来。</span></li><li>            <span class="hljs-comment">// 开发者需要替换为自己想要下载的内容的地址。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">startDownload</span>(<span class="hljs-string">'https://www.example.com/'</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#documentviewpicker" target="_blank">DocumentViewPicker()</a>获取当前示例的默认下载目录，将该目录设置为下载目录。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { picker, fileUri } <span class="hljs-keyword">from</span>  <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">delegate</span>: webview.<span class="hljs-property">WebDownloadDelegate</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebDownloadDelegate</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setDownloadDelegate'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onBeforeDownload</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"will start a download."</span>);</li><li>              <span class="hljs-comment">// 使用DocumentViewPicker()获取当前示例的默认下载目录，将该目录设置为下载目录</span></li><li>              <span class="hljs-title function_">getDownloadPathFromPicker</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">downloadPath</span>) =&gt;</span> {</li><li>                webDownloadItem.<span class="hljs-title function_">start</span>(downloadPath + <span class="hljs-string">'/'</span> + webDownloadItem.<span class="hljs-title function_">getSuggestedFileName</span>());</li><li>              });</li><li>
</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadUpdated</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 下载任务的唯一标识。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>              <span class="hljs-comment">// 下载的进度。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update percent complete: "</span> + webDownloadItem.<span class="hljs-title function_">getPercentComplete</span>());</li><li>              <span class="hljs-comment">// 当前的下载速度。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update speed: "</span> + webDownloadItem.<span class="hljs-title function_">getCurrentSpeed</span>())</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFailed</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>              <span class="hljs-comment">// 下载任务失败的错误码。</span></li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed last error code: "</span> + webDownloadItem.<span class="hljs-title function_">getLastErrorCode</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFinish</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download finish guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setDownloadDelegate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>
</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getDownloadPathFromPicker</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> documentSaveOptions = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentSaveOptions</span>();</li><li>      documentSaveOptions.<span class="hljs-property">pickerMode</span> = picker.<span class="hljs-property">DocumentPickerMode</span>.<span class="hljs-property">DOWNLOAD</span></li><li>      <span class="hljs-keyword">const</span> documentPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentViewPicker</span>();</li><li>      documentPicker.<span class="hljs-title function_">save</span>(documentSaveOptions).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">documentSaveResult</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (documentSaveResult.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">''</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">const</span> uriString = documentSaveResult[<span class="hljs-number">0</span>];</li><li>        <span class="hljs-keyword">if</span> (!uriString) {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">''</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">const</span> uri = <span class="hljs-keyword">new</span> fileUri.<span class="hljs-title class_">FileUri</span>(uriString);</li><li>        <span class="hljs-title function_">resolve</span>(uri.<span class="hljs-property">path</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${err.code}</span>,  Message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">''</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">''</span>);</li><li>    }</li><li>  })</li><li>}</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>Web组件的下载功能要求应用通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webdownloaditem#start11" target="_blank">WebDownloadItem.start</a>来指定下载文件的保存路径。</p>       <p>值得注意的是，WebDownloadItem.start并非启动下载，下载过程实际上在用户点击页面链接时即已开始。WebDownloadItem.start的作用是将已经下载到临时文件的部分移动到指定目标路径，后续未完成的下载的内容将直接保存到指定目标路径，临时目录位于/data/storage/el2/base/cache/web/Temp/。如果决定取消当前下载，应调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webdownloaditem#cancel11" target="_blank">WebDownloadItem.cancel</a>，此时临时文件将被删除。</p>       <p>如果不希望在WebDownloadItem.start之前将文件下载到临时目录，可以通过WebDownloadItem.cancel中断下载，后续可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webdownloadmanager#resumedownload11" target="_blank">WebDownloadManager.resumeDownload</a>恢复中断的下载。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="使用web组件恢复进程退出时未下载完成的任务">使用Web组件恢复进程退出时未下载完成的任务<i class="anchor-icon anchor-icon-link" anchorid="使用web组件恢复进程退出时未下载完成的任务" tips="复制节点链接"></i></h2>          <p>在Web组件启动时，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webdownloadmanager#resumedownload11" target="_blank">resumeDownload()</a>接口恢复未完成的下载任务。</p>     <p>在以下示例中，通过“record”按钮将当前下载任务保存至持久化文件中，应用重启后，可借助“recovery”按钮恢复持久化的下载任务。示例代码实现了将当前下载任务持久化保存至文件的功能，若需保存多个下载任务，应用可根据需求调整持久化的时机与方式。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { downloadUtil, fileName, filePath } <span class="hljs-keyword">from</span> <span class="hljs-string">'./downloadUtil'</span>; <span class="hljs-comment">// downloadUtil.ets 见下文</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">delegate</span>: webview.<span class="hljs-property">WebDownloadDelegate</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebDownloadDelegate</span>();</li><li>  <span class="hljs-attr">download</span>: webview.<span class="hljs-property">WebDownloadItem</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebDownloadItem</span>();</li><li>  <span class="hljs-comment">// 用于记录失败的下载任务。</span></li><li>  <span class="hljs-attr">failedData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    downloadUtil.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setDownloadDelegate'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onBeforeDownload</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"will start a download."</span>);</li><li>              <span class="hljs-comment">// 传入一个下载路径，并开始下载。</span></li><li>              <span class="hljs-comment">// 如果传入一个不存在的路径，则会下载到默认/data/storage/el2/base/cache/web/目录。</span></li><li>              webDownloadItem.<span class="hljs-title function_">start</span>(<span class="hljs-string">"/data/storage/el2/base/cache/web/"</span> + webDownloadItem.<span class="hljs-title function_">getSuggestedFileName</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadUpdated</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download update percent complete: "</span> + webDownloadItem.<span class="hljs-title function_">getPercentComplete</span>());</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">download</span> = webDownloadItem;</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFailed</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"download failed guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>              <span class="hljs-comment">// 序列化失败的下载任务到一个字节数组。</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">failedData</span> = webDownloadItem.<span class="hljs-title function_">serialize</span>();</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>.<span class="hljs-title function_">onDownloadFinish</span>(<span class="hljs-function">(<span class="hljs-params">webDownloadItem: webview.WebDownloadItem</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"download finish guid: "</span> + webDownloadItem.<span class="hljs-title function_">getGuid</span>());</li><li>            })</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setDownloadDelegate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>);</li><li>            webview.<span class="hljs-property">WebDownloadManager</span>.<span class="hljs-title function_">setDownloadDelegate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">delegate</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startDownload'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 这里指定下载地址为 https://www.example.com/，Web组件会发起一个下载任务将该页面下载下来。</span></li><li>            <span class="hljs-comment">// 开发者需要替换为自己想要下载的内容的地址。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">startDownload</span>(<span class="hljs-string">'https://www.example.com/'</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-comment">// 将当前的下载任务信息序列化保存，用于后续恢复下载任务。</span></li><li>      <span class="hljs-comment">// 当前用例仅展示下载一个任务的场景，多任务场景请按需扩展。</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'record'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 保存当前下载数据到持久化文档中。</span></li><li>            downloadUtil.<span class="hljs-title function_">saveDownloadInfo</span>(downloadUtil.<span class="hljs-title function_">uint8ArrayToStr</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">download</span>.<span class="hljs-title function_">serialize</span>()));</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-comment">// 从序列化的下载任务信息中，恢复下载任务。</span></li><li>      <span class="hljs-comment">// 按钮触发时必须保证WebDownloadManager.setDownloadDelegate设置完成。</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'recovery'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 当前默认持久化文件存在，用户根据实际情况增加判断。</span></li><li>            <span class="hljs-keyword">let</span> webDownloadItem =</li><li>              webview.<span class="hljs-property">WebDownloadItem</span>.<span class="hljs-title function_">deserialize</span>(downloadUtil.<span class="hljs-title function_">strToUint8Array</span>(downloadUtil.<span class="hljs-title function_">readFileSync</span>(filePath, fileName)));</li><li>            webview.<span class="hljs-property">WebDownloadManager</span>.<span class="hljs-title function_">resumeDownload</span>(webDownloadItem);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>
</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>下载任务信息持久化工具类文件。</p>     <div _ngcontent-ieg-c106="" class="highlight-div"><div _ngcontent-ieg-c106="" class="highlight-div-header"><div _ngcontent-ieg-c106="" class="highlight-div-header-left"><div _ngcontent-ieg-c106="" class="handle-button expand-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ieg-c106="" class="highlight-div-header-right"><div _ngcontent-ieg-c106="" class="handle-button ai-button"></div><div _ngcontent-ieg-c106="" class="handle-button line-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ieg-c106="" class="handle-button theme-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ieg-c106="" class="handle-button copy-button"><div _ngcontent-ieg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ieg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// downloadUtil.ets</span></li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> fileStream <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> helper = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">Base64Helper</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> filePath : <span class="hljs-built_in">string</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fileName = <span class="hljs-string">'demoFile.txt'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span>  downloadUtil {</li><li>  </li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">context: UIContext</span>): <span class="hljs-built_in">void</span> {</li><li>    filePath = context.<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">filesDir</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uint8ArrayToStr</span>(<span class="hljs-params">uint8Array: <span class="hljs-built_in">Uint8Array</span></span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> helper.<span class="hljs-title function_">encodeToStringSync</span>(uint8Array);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">strToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>    <span class="hljs-keyword">return</span> helper.<span class="hljs-title function_">decodeSync</span>(str);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">saveDownloadInfo</span>(<span class="hljs-params">downloadInfo: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">fileExists</span>(filePath)) {</li><li>      <span class="hljs-title function_">mkDirectorySync</span>(filePath);</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">writeToFileSync</span>(filePath, fileName, downloadInfo);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fileExists</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">return</span> fileStream.<span class="hljs-title function_">accessSync</span>(filePath);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mkDirectorySync</span>(<span class="hljs-params">directoryPath: <span class="hljs-built_in">string</span>, recursion?: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      fileStream.<span class="hljs-title function_">mkdirSync</span>(directoryPath, recursion ?? <span class="hljs-literal">false</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`mk dir error. err message: <span class="hljs-subst">${error.message}</span>, err code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">writeToFileSync</span>(<span class="hljs-params">dir: <span class="hljs-built_in">string</span>, fileName: <span class="hljs-built_in">string</span>, msg: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> file = fileStream.<span class="hljs-title function_">openSync</span>(dir + <span class="hljs-string">'/'</span> + fileName, fileStream.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span> | fileStream.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>    fileStream.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, msg);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFileSync</span>(<span class="hljs-params">dir: <span class="hljs-built_in">string</span>, fileName: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> fileStream.<span class="hljs-title function_">readTextSync</span>(dir + <span class="hljs-string">'/'</span> + fileName);</li><li>  }</li><li>
</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>