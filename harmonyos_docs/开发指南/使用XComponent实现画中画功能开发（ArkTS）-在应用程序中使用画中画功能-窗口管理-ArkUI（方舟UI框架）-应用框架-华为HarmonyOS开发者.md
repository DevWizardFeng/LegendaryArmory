<h1 _ngcontent-vpo-c119="" class="doc-title ng-star-inserted" title="使用XComponent实现画中画功能开发（ArkTS）"> 使用XComponent实现画中画功能开发（ArkTS） </h1>

<div _ngcontent-vpo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文以视频播放为例，介绍通过XComponent实现画中画功能的基本开发步骤。</p> <div class="tiledSection"><h2 id="section417212014278">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section417212014278" tips="复制节点链接"></i></h2><ul><li>在API version 20之前，支持在Phone、Tablet设备使用XComponent实现画中画功能开发；从API version 20开始，支持在Phone、PC/2in1、Tablet设备使用Xcomponent实现画中画功能开发。</li><li>仅支持以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>作为媒体流播放组件的界面进入画中画模式，XComponent的type必须为XComponentType.SURFACE。</li><li>UIAbility使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation" target="_blank">Navigation</a>管理页面时，需要设置Navigation控件的id属性，并将该id传递给画中画控制器，确保还原时可以正常恢复原页面。</li><li>如果应用主窗口不在前台，不建议在画中画回调方法中执行UI操作，例如页面push/pop等，这些操作不会立即执行，可能产生预期之外的结果。</li></ul> </div> <div class="tiledSection"><h2 id="section452483111615">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section452483111615" tips="复制节点链接"></i></h2><ol><li><span>创建画中画控制器，注册生命周期事件以及控制事件回调。</span><p></p><ul><li>通过create(config: PiPConfiguration)接口创建画中画控制器实例。</li><li>通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画。</li><li>通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调。</li><li>通过画中画控制器实例的on('controlPanelActionEvent')接口注册控制事件回调。</li></ul> <p></p></li><li><span>启动画中画。</span><p></p><p>创建画中画控制器实例后，通过startPiP接口启动画中画。</p> <p></p></li><li><span>更新媒体源尺寸信息。</span><p></p><p>画中画媒体源更新后（如切换视频），通过画中画控制器实例的updateContentSize接口更新媒体源尺寸信息，以调整画中画窗口比例。</p> <p></p></li><li><span>关闭画中画。</span><p></p><p>当不再需要显示画中画时，可根据业务需要，通过画中画控制器实例的stopPiP接口关闭画中画。</p> <p></p></li></ol> </div> <div _ngcontent-vpo-c106="" class="highlight-div"><div _ngcontent-vpo-c106="" class="highlight-div-header"><div _ngcontent-vpo-c106="" class="highlight-div-header-left"><div _ngcontent-vpo-c106="" class="handle-button expand-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpo-c106="" class="highlight-div-header-right"><div _ngcontent-vpo-c106="" class="handle-button ai-button"></div><div _ngcontent-vpo-c106="" class="handle-button line-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpo-c106="" class="handle-button theme-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpo-c106="" class="handle-button copy-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpo-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-comment">// 该页面用于展示Navigation在画中画场景的使用。如果UIAbility是单页面，则无需使用Navigation</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">Page1</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Page1'</span></li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title function_">Provide</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-variable">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">NavPathStack</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">navId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'navId'</span>;</li><li>  @<span class="hljs-title function_">Builder</span></li><li>  <span class="hljs-title function_">PageMap</span>(<span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">name</span> === <span class="hljs-string">'pageOne'</span>) {</li><li>      <span class="hljs-title function_">Page1</span>({<span class="hljs-variable">navId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">navId</span>});</li><li>    }</li><li>  }</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Navigation</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">pageInfos</span>) {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'pushPath'</span>, { <span class="hljs-variable">stateEffect</span>: <span class="hljs-keyword">true</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-title class_">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-variable">name</span>: <span class="hljs-string">'pageOne'</span> }) <span class="hljs-comment">// 将name指定的NavDestination页面信息入栈</span></li><li>          })</li><li>          .<span class="hljs-title function_">stateStyles</span>({</li><li>            <span class="hljs-variable">pressed</span>: {</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>);</li><li>            },</li><li>            <span class="hljs-variable">normal</span>: {</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Blue</span>);</li><li>            }</li><li>          })</li><li>      }</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">'NavIndex'</span>).<span class="hljs-title function_">navDestination</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">PageMap</span>)</li><li>    .<span class="hljs-title function_">id</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">navId</span>) <span class="hljs-comment">// 设置Navigation组件的id属性</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p>示例中的视频播放需要使用AVPlayer，具体示例可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback" target="_blank">视频播放</a>。</p> <div _ngcontent-vpo-c106="" class="highlight-div"><div _ngcontent-vpo-c106="" class="highlight-div-header"><div _ngcontent-vpo-c106="" class="highlight-div-header-left"><div _ngcontent-vpo-c106="" class="handle-button expand-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpo-c106="" class="highlight-div-header-right"><div _ngcontent-vpo-c106="" class="handle-button ai-button"></div><div _ngcontent-vpo-c106="" class="handle-button line-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpo-c106="" class="handle-button theme-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpo-c106="" class="handle-button copy-button"><div _ngcontent-vpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpo-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Page1.ets</span></li><li><span class="hljs-comment">// 该页面用于展示画中画功能的基本使用</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">AVPlayerDemo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./AVPlayerDemo'</span>; <span class="hljs-comment">// 请自行实现视频播放的相关开发</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BuilderNode</span>, <span class="hljs-variable">FrameNode</span>, <span class="hljs-variable">NodeController</span>, <span class="hljs-variable">UIContext</span>, <span class="hljs-variable">PiPWindow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span> = <span class="hljs-string">'Page1'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-variable">text</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">text</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">text</span> = <span class="hljs-variable">text</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者可以通过@Builder装饰器实现布局构建</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">Column</span>() {</li><li>    <span class="hljs-title function_">Text</span>(<span class="hljs-variable">params</span>.<span class="hljs-variable">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>) <span class="hljs-comment">// 宽度方向充满画中画窗口</span></li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>) <span class="hljs-comment">// 高度方向充满画中画窗口</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者可通过继承NodeController实现自定义UI控制器</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">message</span> = <span class="hljs-variable">message</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 通过BuilderNode加载自定义布局</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">textNode</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">BuilderNode</span>(<span class="hljs-variable">context</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">textNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable">wrapBuilder</span>&lt;[<span class="hljs-title class_">Params</span>]&gt;(<span class="hljs-variable">buildText</span>), <span class="hljs-variable">new</span> <span class="hljs-title function_">Params</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">message</span>));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">textNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 开发者可自定义该方法实现布局更新</span></li><li>  <span class="hljs-title function_">update</span>(<span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">log</span>(`<span class="hljs-variable">update</span> <span class="hljs-variable">message</span>: ${<span class="hljs-variable">message</span>}`);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">textNode</span> !== <span class="hljs-variable">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">textNode</span>.<span class="hljs-title function_">update</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">Params</span>(<span class="hljs-variable">message</span>));</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Page1</span> {</li><li>  @<span class="hljs-title function_">Consume</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-variable">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// surfaceId，用于关联XComponent与视频播放器</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">player</span>?: <span class="hljs-title class_">AVPlayerDemo</span> = <span class="hljs-variable">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">pipController</span>?: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPController</span> = <span class="hljs-variable">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">nodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">TextNodeController</span>(<span class="hljs-string">'this is custom UI'</span>);</li><li>  <span class="hljs-variable">navId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">XComponentOptions</span> = {</li><li>    <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>, </li><li>    <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">mXComponentController</span></li><li>  }</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-comment">// XComponent控件，用于播放视频流</span></li><li>        <span class="hljs-title function_">XComponent</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">options</span>)</li><li>          .<span class="hljs-title function_">onLoad</span>(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>            <span class="hljs-comment">// 需要设置AVPlayer的surfaceId为XComponentController的surfaceId</span></li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">AVPlayerDemo</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>);</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">player</span>.<span class="hljs-title function_">avPlayerFdSrcDemo</span>();</li><li>          })</li><li>          .<span class="hljs-title function_">onDestroy</span>(() =&gt; {</li><li>            <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">XComponent</span> <span class="hljs-variable">onDestroy</span>`);</li><li>          })</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-string">'800px'</span> })</li><li>        <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">20</span> }) {</li><li>          <span class="hljs-title function_">Button</span>(<span class="hljs-string">'start'</span>) <span class="hljs-comment">// 启动画中画</span></li><li>            .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">startPip</span>();</li><li>            })</li><li>            .<span class="hljs-title function_">stateStyles</span>({</li><li>              <span class="hljs-variable">pressed</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>);</li><li>              },</li><li>              <span class="hljs-variable">normal</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Blue</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title function_">Button</span>(<span class="hljs-string">'stop'</span>) <span class="hljs-comment">// 停止画中画</span></li><li>            .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">stopPip</span>();</li><li>            })</li><li>            .<span class="hljs-title function_">stateStyles</span>({</li><li>              <span class="hljs-variable">pressed</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>);</li><li>              },</li><li>              <span class="hljs-variable">normal</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Blue</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title function_">Button</span>(<span class="hljs-string">'updateSize'</span>) <span class="hljs-comment">// 更新视频尺寸</span></li><li>            .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>              <span class="hljs-comment">// 此处设置的宽高应为媒体内容宽高，需要通过媒体相关接口或回调获取</span></li><li>              <span class="hljs-comment">// 例如使用AVPlayer播放视频时，可通过videoSizeChange回调获取媒体源更新后的尺寸</span></li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1600</span>);</li><li>            })</li><li>            .<span class="hljs-title function_">stateStyles</span>({</li><li>              <span class="hljs-variable">pressed</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>);</li><li>              },</li><li>              <span class="hljs-variable">normal</span>: {</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Blue</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-variable">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">height</span>: <span class="hljs-number">60</span> })</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">SpaceAround</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">startPip</span>() {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">PiPWindow</span>.<span class="hljs-title function_">isPiPEnabled</span>()) {</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">picture</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">picture</span> <span class="hljs-variable">disabled</span> <span class="hljs-keyword">for</span> <span class="hljs-variable">current</span> <span class="hljs-variable">OS</span>`);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPConfiguration</span> = {</li><li>      <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>,</li><li>      <span class="hljs-variable">componentController</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">mXComponentController</span>,</li><li>      <span class="hljs-comment">// 当前page导航id</span></li><li>      <span class="hljs-comment">// 1、UIAbility使用Navigation管理页面，需要设置Navigation控件的id属性，并将该id设置给画中画控制器，确保还原场景下能够从画中画窗口恢复到原页面</span></li><li>      <span class="hljs-comment">// 2、UIAbility使用Router管理页面时（画中画场景不推荐该导航方式），无需设置navigationId。注意：该场景下启动画中画后，不要进行页面切换，否则还原场景可能出现异常</span></li><li>      <span class="hljs-comment">// 3、UIAbility只有单页面时，无需设置navigationId，还原场景下也能够从画中画窗口恢复到原页面</span></li><li>      <span class="hljs-variable">navigationId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">navId</span>,</li><li>      <span class="hljs-variable">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPTemplateType</span>.<span class="hljs-title class_">VIDEO_PLAY</span>, <span class="hljs-comment">// 对于视频通话、视频会议等场景，需要设置相应的模板类型</span></li><li>      <span class="hljs-variable">contentWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 可选，创建画中画控制器时系统可通过XComponent组件大小设置画中画窗口比例</span></li><li>      <span class="hljs-variable">contentHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 可选，创建画中画控制器时系统可通过XComponent组件大小设置画中画窗口比例</span></li><li>      <span class="hljs-variable">controlGroups</span>:[<span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">VideoPlayControlGroup</span>.<span class="hljs-variable">VIDEO_PREVIOUS_NEXT</span>], <span class="hljs-comment">// 可选，对于视频通话、视频会议和视频直播场景，可通过该属性选择对应模板类型下需显示的的控件组</span></li><li>      <span class="hljs-variable">customUIController</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">nodeController</span>, <span class="hljs-comment">// 可选，如果需要在画中画显示内容上方展示自定义UI，可设置该参数。</span></li><li>    };</li><li>    <span class="hljs-comment">// 步骤1：创建画中画控制器，通过create接口创建画中画控制器实例</span></li><li>    <span class="hljs-variable">PiPWindow</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable">config</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">controller</span> : <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPController</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span> = <span class="hljs-variable">controller</span>;</li><li>      <span class="hljs-comment">// 步骤1：初始化画中画控制器</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initPipController</span>();</li><li>      <span class="hljs-comment">// 步骤2：通过startPiP接口启动画中画</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">startPiP</span>().<span class="hljs-title function_">then</span>(() =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">Succeeded</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">starting</span> <span class="hljs-variable">pip</span>.`);</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">start</span> <span class="hljs-variable">pip</span>. <span class="hljs-variable">Cause</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">create</span> <span class="hljs-variable">pip</span> <span class="hljs-variable">controller</span>. <span class="hljs-variable">Cause</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initPipController</span>() {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 步骤1：通过setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画，注册stateChange和controlPanelActionEvent回调</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-keyword">false</span> <span class="hljs-comment">/*or true if necessary*/</span>); <span class="hljs-comment">// 默认为false</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, (<span class="hljs-variable">state</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPState</span>, <span class="hljs-variable">reason</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">onStateChange</span>(<span class="hljs-variable">state</span>, <span class="hljs-variable">reason</span>);</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlPanelActionEvent'</span>, (<span class="hljs-variable">event</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPActionEventType</span>, <span class="hljs-variable">status</span>?: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">onActionEvent</span>(<span class="hljs-variable">event</span>, <span class="hljs-variable">status</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-variable">state</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPState</span>, <span class="hljs-variable">reason</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">curState</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-title function_">switch</span>(<span class="hljs-variable">state</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_START</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"ABOUT_TO_START"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">STARTED</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"STARTED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_STOP</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"ABOUT_TO_STOP"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">STOPPED</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"STOPPED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ABOUT_TO_RESTORE</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"ABOUT_TO_RESTORE"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-variable">PiPWindow</span>.<span class="hljs-variable">PiPState</span>.<span class="hljs-variable">ERROR</span>:</li><li>        <span class="hljs-variable">curState</span> = <span class="hljs-string">"ERROR"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-variable">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`[${<span class="hljs-variable">TAG</span>}] <span class="hljs-variable">onStateChange</span>: ${<span class="hljs-variable">curState</span>}, <span class="hljs-variable">reason</span>: ${<span class="hljs-variable">reason</span>}`);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onActionEvent</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title class_">PiPActionEventType</span>, <span class="hljs-variable">status</span>?: <span class="hljs-title class_">number</span>) {</li><li>    <span class="hljs-variable">switch</span> (<span class="hljs-variable">event</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'playbackStateChanged'</span>:</li><li>      <span class="hljs-comment">// 开始或停止视频</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-comment">// 停止视频</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> === <span class="hljs-number">1</span>) {</li><li>          <span class="hljs-comment">// 播放视频</span></li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'nextVideo'</span>:</li><li>      <span class="hljs-comment">// 播放下一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'previousVideo'</span>:</li><li>      <span class="hljs-comment">// 播放上一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-variable">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤3：视频内容变化时，向画中画控制器更新视频尺寸信息，用于调整画中画窗口比例</span></li><li>  <span class="hljs-title function_">updateContentSize</span>(<span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-variable">width</span>, <span class="hljs-variable">height</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤4：当不再需要显示画中画时，通过stopPiP接口关闭画中画</span></li><li>  <span class="hljs-title function_">stopPip</span>() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">promise</span> : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; = <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>.<span class="hljs-title function_">stopPiP</span>();</li><li>      <span class="hljs-variable">promise</span>.<span class="hljs-title function_">then</span>(() =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">Succeeded</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stopping</span> <span class="hljs-variable">pip</span>.`);</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>); <span class="hljs-comment">// 如果已注册stateChange回调，停止画中画时取消注册该回调</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'controlPanelActionEvent'</span>); <span class="hljs-comment">// 如果已注册controlPanelActionEvent回调，停止画中画时取消注册该回调</span></li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">stop</span> <span class="hljs-variable">pip</span>. <span class="hljs-variable">Cause</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="467.82750000000004" originheight="704" originwidth="592" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114823.06816956396634150594724072830222:50001231000000:2800:F40D97323F1AD2E78F044622D606FDD6C3D3FFADBF633CFA183047243545CFD5.gif" title="点击放大" width="393.40801500000003"></span></p> <div class="tiledSection"><h2 id="section272177265">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section272177265" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/guide-snippets/tree/master/ArkUIWindowPipSamples/WindowPip" target="_blank">实现画中画效果</a></li></ul> </div> </div> <div></div></div>