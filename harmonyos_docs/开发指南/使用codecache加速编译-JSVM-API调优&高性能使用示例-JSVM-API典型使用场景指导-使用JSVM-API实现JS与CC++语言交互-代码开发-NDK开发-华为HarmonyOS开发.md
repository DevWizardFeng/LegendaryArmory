<h1 _ngcontent-abf-c119="" class="doc-title ng-star-inserted" title="使用code cache加速编译"> 使用code cache加速编译 </h1>

<div _ngcontent-abf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>##code cache简介</p> <p>JSVM提供了生成并使用code cache加速编译过程的方法，其获取和使用分为下面几个部分：</p> <ul><li>首先使用compile系列接口编译得到JSVM_Script</li><li>使用OH_JSVM_CreateCodeCache接口，传递编译完成后生成的JSVM_Script</li><li>将OH_JSVM_CreateCodeCache生成的code cache保存，等待下一次编译时，作为参数传入compile系列接口</li></ul> <p>通过上述流程，将会在使用code cache的那次编译中，极大减少编译时间，其原理为将编译完成的script序列化，然后使用code cache编译时就不再需要重新解析/编译已经被序列化的函数，只需要进行一次反序列化即可，这样编译就简化为了一次数据读取。</p> <p>##code cache校验规格说明</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.1" valign="top" width="50%">规格</th> <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.2" valign="top" width="50%">规格说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">完整性校验</td> <td class="cellrowborder" valign="top" width="50%">校验cache实际长度，是否与生成时一致</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">兼容性校验</td> <td class="cellrowborder" valign="top" width="50%">校验生成cache的JSVM版本与编译选项是否与当前一致</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">一致性校验</td> <td class="cellrowborder" valign="top" width="50%">校验生成cache的js源码，是否与当前输入源码长度一致</td> </tr>  </tbody></table></div> </div>  <div class="tiledSection"><h2 id="场景示例">场景示例<i class="anchor-icon anchor-icon-link" anchorid="场景示例" tips="复制节点链接"></i></h2><p>下面的伪代码是一个典型的使用方法，其中第二次编译，如果cacheRejected为true，那么说明code cache被拒绝无法生效，运行时间会与无code cache时间相同；为false则这次运行将会极大加快。</p> <p>其中使用到的JSVM-API可以参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jsvm-data-types-interfaces">JSVM数据类型与接口说明</a>，这里仅展示调用的步骤。</p> <p>外层跨语言交互的部分可以参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-jsvm-process">使用JSVM-API实现JS与C/C++语言交互开发流程</a>。</p> <div _ngcontent-abf-c106="" class="highlight-div"><div _ngcontent-abf-c106="" class="highlight-div-header"><div _ngcontent-abf-c106="" class="highlight-div-header-left"><div _ngcontent-abf-c106="" class="handle-button expand-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-abf-c106="" class="highlight-div-header-right"><div _ngcontent-abf-c106="" class="handle-button ai-button"></div><div _ngcontent-abf-c106="" class="handle-button line-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-abf-c106="" class="handle-button theme-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-abf-c106="" class="handle-button copy-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-abf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ark_runtime/jsvm.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-function">JSVM_Value <span class="hljs-title">UseCodeCache</span><span class="hljs-params">(JSVM_Env env, JSVM_CallbackInfo info)</span> </span>{</li><li>    <span class="hljs-comment">// 编译参数准备</span></li><li>    JSVM_Value jsSrc;</li><li>    JSVM_Script script;</li><li>    JSVM_Value result;</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* dataPtr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">bool</span> cacheRejected = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-type">static</span> std::string src = <span class="hljs-string">R"JS(</span></li><li><span class="hljs-string">        a = 65536;</span></li><li><span class="hljs-string">        b = 32768;</span></li><li><span class="hljs-string">        c = a + b;</span></li><li><span class="hljs-string">    )JS"</span>;</li><li>
</li><li>    <span class="hljs-comment">// 生成code cache</span></li><li>    {</li><li>        JSVM_HandleScope handleScope;</li><li>        <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>        <span class="hljs-comment">// 源码字符串转换为js字符串</span></li><li>        <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, src.<span class="hljs-built_in">c_str</span>(), src.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>        <span class="hljs-comment">// 编译js代码</span></li><li>        <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">nullptr</span>, &amp;script);</li><li>
</li><li>        <span class="hljs-comment">// 执行js代码</span></li><li>        <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>        <span class="hljs-type">int</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, result, &amp;value);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"first run result: %{public}d\n"</span>, value);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (dataPtr == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-comment">// 将js源码编译出的脚本保存到cache, 可以避免重复编译, 带来性能提升</span></li><li>            <span class="hljs-built_in">OH_JSVM_CreateCodeCache</span>(env, script, &amp;dataPtr, &amp;length);</li><li>        }</li><li>
</li><li>        <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 使用code cache</span></li><li>    {</li><li>        JSVM_HandleScope handleScope;</li><li>        <span class="hljs-built_in">OH_JSVM_OpenHandleScope</span>(env, &amp;handleScope);</li><li>
</li><li>        <span class="hljs-comment">// 源码字符串转换为js字符串</span></li><li>        <span class="hljs-built_in">OH_JSVM_CreateStringUtf8</span>(env, src.<span class="hljs-built_in">c_str</span>(), src.<span class="hljs-built_in">size</span>(), &amp;jsSrc);</li><li>
</li><li>        <span class="hljs-comment">// 使用code cache编译js代码</span></li><li>        <span class="hljs-built_in">OH_JSVM_CompileScript</span>(env, jsSrc, dataPtr, length, <span class="hljs-literal">true</span>, &amp;cacheRejected, &amp;script);</li><li>
</li><li>        <span class="hljs-comment">// 执行js代码</span></li><li>        <span class="hljs-built_in">OH_JSVM_RunScript</span>(env, script, &amp;result);</li><li>        <span class="hljs-type">int</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">OH_JSVM_GetValueInt32</span>(env, result, &amp;value);</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"second run result: %{public}d\n"</span>, value);</li><li>
</li><li>        <span class="hljs-built_in">OH_JSVM_CloseHandleScope</span>(env, handleScope);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"cache rejected: %{public}d\n"</span>, cacheRejected);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Register a callback.</span></li><li><span class="hljs-type">static</span> JSVM_CallbackStruct param[] = {</li><li>    {.data = <span class="hljs-literal">nullptr</span>, .callback = UseCodeCache}</li><li>};</li><li><span class="hljs-type">static</span> JSVM_CallbackStruct *method = param;</li><li><span class="hljs-comment">// Register the C++ callback as a JSVM globalThis.UseCodeCache property for the JS to call.</span></li><li><span class="hljs-type">static</span> JSVM_PropertyDescriptor descriptor[] = {</li><li>    {<span class="hljs-string">"UseCodeCache"</span>, <span class="hljs-literal">nullptr</span>, method++, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, JSVM_DEFAULT},</li><li>};</li><li>
</li><li><span class="hljs-comment">// 样例测试js</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* srcCallNative = <span class="hljs-string">R"JS(globalThis.UseCodeCache())JS"</span>;</li></ol></pre></div></div> <p>预期的输出结果如下：</p> <div _ngcontent-abf-c106="" class="highlight-div"><div _ngcontent-abf-c106="" class="highlight-div-header"><div _ngcontent-abf-c106="" class="highlight-div-header-left"><div _ngcontent-abf-c106="" class="handle-button expand-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-abf-c106="" class="highlight-div-header-right"><div _ngcontent-abf-c106="" class="handle-button ai-button"></div><div _ngcontent-abf-c106="" class="handle-button line-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-abf-c106="" class="handle-button theme-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-abf-c106="" class="handle-button copy-button"><div _ngcontent-abf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-abf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-sql" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">first</span> run <span class="hljs-keyword">result</span>: <span class="hljs-number">98304</span></li><li><span class="hljs-keyword">second</span> run <span class="hljs-keyword">result</span>: <span class="hljs-number">98304</span></li><li>cache rejected: <span class="hljs-number">0</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="注意事项">注意事项<i class="anchor-icon anchor-icon-link" anchorid="注意事项" tips="复制节点链接"></i></h2><p>上述代码中使用了code cache进行编译：OH_JSVM_CompileScript(env, jsSrc, dataPtr, length, true, &amp;cacheRejected, &amp;script);</p> <p>这个接口的传入参数中包含cacheRejected，用于接收实际编译过程中code cache是否被拒绝的状态，具体包括多种情况：</p> <p>-code cache校验失败</p> <p>-code cache校验成功</p> <ul><li>内存中存在编译缓存，code cache没有被校验</li></ul> <p>对于第一种情况，这个参数会被设置为true，而后两种情况都是false，因此需要注意即使reject为false，也不能说明code cache被接收了。</p> </div> </div> <div></div></div>