<h1 _ngcontent-adn-c119="" class="doc-title ng-star-inserted" title="使用typeNode实现画中画功能开发（ArkTS）"> 使用typeNode实现画中画功能开发（ArkTS） </h1>

<div _ngcontent-adn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>从API version 12开始，支持使用typeNode实现画中画功能开发。</li><li>在API version 20之前，支持在Phone、Tablet设备使用typeNode实现画中画功能开发；从API version 20开始，支持在Phone、PC/2in1、Tablet设备使用typeNode实现画中画功能开发。</li></ul> </div></div></div> <p>该方式适用于任意场景下应用接入画中画功能，以下根据实际开发场景提供四个示例，分别介绍对应场景下画中画功能的实现步骤：</p> <ul><li><a href="/consumer/cn/doc/harmonyos-guides/pipwindow-typenode#section7627141117162">应用使用typeNode自由节点（不添加到布局）实现画中画功能</a>。</li><li><a href="/consumer/cn/doc/harmonyos-guides/pipwindow-typenode#section1236517470234">应用使用router导航时通过typeNode实现画中画功能</a>。</li><li><a href="/consumer/cn/doc/harmonyos-guides/pipwindow-typenode#section173761626124613">应用使用Navigation导航时通过typeNode实现画中画功能</a>。</li><li><a href="/consumer/cn/doc/harmonyos-guides/pipwindow-typenode#section8907336134011">应用使用单界面Ability时通过typeNode实现画中画功能</a>。</li></ul> <p>本文以视频播放为例，介绍通过typeNode实现画中画功能的基本开发步骤。</p> <p>示例中的视频播放器简易实现参考：</p> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/AVPlayer.ets</span></li><li><span class="hljs-comment">// 简易播放器实现</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayer</span> {</li><li>  <span class="hljs-keyword">private</span> avPlayer?: media.<span class="hljs-property">AVPlayer</span>;</li><li>  <span class="hljs-attr">surfaceID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  </li><li>  <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seekDone'</span>, <span class="hljs-function">(<span class="hljs-params">seekDoneTime: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer seek succeeded, seek time is <span class="hljs-subst">${seekDoneTime}</span>`</span>);</li><li>    })</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (state, reason) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">switch</span> (state) {</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'idle'</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">release</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceID</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">prepare</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer prepare succeeded.'</span>);</li><li>          }, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke prepare failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">play</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'stopped'</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">reset</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">avPlayerFdSrc</span>(<span class="hljs-params"></span>) {</li><li>    </li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    } <span class="hljs-keyword">catch</span>(err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`create AVPlayer failed`</span>);</li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    <span class="hljs-keyword">let</span> uiContext = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'UIContext'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIContext</span>;</li><li>    <span class="hljs-keyword">let</span> context = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'xxx.mp4'</span>);</li><li>    </li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">fdSrc</span> = fileDescriptor;</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section2012665982815">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2012665982815" tips="复制节点链接"></i></h2><ul><li>构造PiPConfiguration参数时，建议传入contentWidth和contentHeight参数用以计算画中画初始比例，否则系统将以16:9的比例呈现画中画窗口。</li><li>contentNode支持XComponentType.SURFACE类型，且创建typeNode时必须指定为"XComponent"类型。</li></ul> </div> <div class="tiledSection"><h2 id="section7627141117162">应用使用typeNode自由节点（不添加到布局）实现画中画功能<i class="anchor-icon anchor-icon-link" anchorid="section7627141117162" tips="复制节点链接"></i></h2><ol><li><span>创建画中画控制器，注册生命周期事件以及控制事件回调。</span><p></p><ul><li>通过主窗口UIContext创建typeNode节点。</li><li>通过create(config: PiPConfiguration, contentNode: typeNode.XComponent)接口创建画中画控制器实例。</li><li>通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画。</li><li>通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调。</li><li>通过画中画控制器实例的on('controlEvent')接口注册控制事件回调。</li></ul> <p></p></li><li><span>启动画中画。</span><p></p><p>创建画中画控制器实例后，通过startPiP接口启动画中画。</p> <p></p></li><li><span>更新媒体源尺寸信息。</span><p></p><p>画中画媒体源更新后（如切换视频），通过画中画控制器实例的updateContentSize接口更新媒体源尺寸信息，以调整画中画窗口比例。</p> <p></p></li><li><span>关闭画中画。</span><p></p><p>当不再需要显示画中画时，可根据业务需要，通过画中画控制器实例的stopPiP接口关闭画中画。</p> <p></p></li></ol> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-keyword">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>    windowStage.<span class="hljs-title function_">getMainWindow</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> ctx = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'UIContext'</span>, ctx);</li><li>      <span class="hljs-comment">// 通过主窗口UIContext创建typeNode节点</span></li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">makeTypeNode</span>(ctx);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-comment">// 该页面用于展示应用布局文件，创建的typeNode节点不会添加到该布局中</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Index'</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'This is MainPage'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'This is not typeNode'</span>)</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'800px'</span> })</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#4d5b5858'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startPip'</span>) <span class="hljs-comment">// 启动画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">startPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'stopPip'</span>) <span class="hljs-comment">// 停止画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">stopPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'updateSize'</span>) <span class="hljs-comment">// 更新视频尺寸</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1600</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#4da99797'</span>)</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unregisterPipStateChangeListener</span>(); <span class="hljs-comment">// 解注册画中画生命周期及状态回调</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageShow'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>); <span class="hljs-comment">// 创建画中画控制器</span></li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 设置应用退后台时自动启动画中画</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageHide'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">false</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/PipManager.ets</span></li><li><span class="hljs-comment">// 画中画控制器单例</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span>, typeNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; <span class="hljs-comment">// 引入PiPWindow模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVPlayer</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/AVPlayer'</span></li><li>
</li><li><span class="hljs-comment">// 自定义XComponentController</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomXComponentController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">XComponentController</span> {</li><li>  <span class="hljs-comment">// 监听onSurfaceCreated，并将surfaceId设置给播放器</span></li><li>  <span class="hljs-title function_">onSurfaceCreated</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceCreated surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> === surfaceId) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> = surfaceId;</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-title function_">avPlayerFdSrc</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onSurfaceDestroyed</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceDestroyed surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipManager</span> {</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">AVPlayer</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PipManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipManager</span>();</li><li>  <span class="hljs-keyword">private</span> pipController?: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPController</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponent</span>: typeNode.<span class="hljs-property">XComponent</span>| <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// typeNode节点</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PipManager</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PipManager</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayer</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomXComponentController</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onActionEvent</span>(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) {</li><li>    <span class="hljs-keyword">switch</span> (control.<span class="hljs-property">controlType</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PLAY_PAUSE</span>:</li><li>        <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PAUSE</span>) {</li><li>          <span class="hljs-comment">//停止视频</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PLAY</span>) {</li><li>          <span class="hljs-comment">//播放视频</span></li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_NEXT</span>:</li><li>        <span class="hljs-comment">// 切换到下一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PREVIOUS</span>:</li><li>        <span class="hljs-comment">// 切换到上一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_FORWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度快进</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_BACKWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度后退</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onActionEvent, controlType:'</span> + control.<span class="hljs-property">controlType</span> + <span class="hljs-string">', status'</span> + control.<span class="hljs-property">status</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听画中画生命周期</span></li><li>  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">curState</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_START"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STARTED</span>:</li><li>        curState = <span class="hljs-string">"STARTED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_STOP"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>:</li><li>        curState = <span class="hljs-string">"STOPPED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_RESTORE"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ERROR</span>:</li><li>        curState = <span class="hljs-string">"ERROR"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[<span class="hljs-subst">${TAG}</span>] onStateChange: <span class="hljs-subst">${curState}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 解注册监听</span></li><li>  <span class="hljs-title function_">unregisterPipStateChangeListener</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'aboutToDisappear'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'controlEvent'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getXComponentController</span>(): <span class="hljs-title class_">CustomXComponentController</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤1：创建画中画控制器，注册生命周期事件以及控制事件回调</span></li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">ctx: Context</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageShow'</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">isPiPEnabled</span>()) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`picture in picture disabled for current OS`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPConfiguration</span> = {</li><li>      <span class="hljs-attr">context</span>: ctx,</li><li>      <span class="hljs-attr">componentController</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getXComponentController</span>(),</li><li>      <span class="hljs-attr">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPTemplateType</span>.<span class="hljs-property">VIDEO_PLAY</span>,</li><li>      <span class="hljs-attr">contentWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentWidth需设置为大于0的值，否则将设置为16:9默认比例</span></li><li>      <span class="hljs-attr">contentHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentHeight需设置为大于0的值，否则将设置为16:9默认比例</span></li><li>    };</li><li>    <span class="hljs-comment">// 通过create接口创建画中画控制器实例</span></li><li>    </li><li>    <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">create</span>(config, <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponent</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">controller: PiPWindow.PiPController</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> = controller;</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-literal">true</span>);</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStateChange</span>(state, reason);</li><li>      });</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('controlEvent')接口注册控制事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlEvent'</span>, <span class="hljs-function">(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onActionEvent</span>(control);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create pip controller. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤2：创建画中画控制器实例后，通过startPiP接口启动画中画</span></li><li>  <span class="hljs-title function_">startPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">startPiP</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in starting pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤3：更新媒体源尺寸信息</span></li><li>  <span class="hljs-title function_">updateContentSize</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">updateContentSize</span>(width, height);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤4：关闭画中画</span></li><li>  <span class="hljs-title function_">stopPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">null</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">stopPiP</span>();</li><li>    promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in stopping pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setAutoStart</span>(<span class="hljs-attr">autoStart</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(autoStart);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建typeNode节点</span></li><li>  <span class="hljs-title function_">makeTypeNode</span>(<span class="hljs-params">ctx: UIContext</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponent</span> === <span class="hljs-literal">null</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponent</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 创建typeNode</span></li><li>      <span class="hljs-comment">// let xc_options: XComponentOptions = {</span></li><li>      <span class="hljs-comment">//   type: XComponentType.TEXTURE, // 类型设置为TEXTURE</span></li><li>      <span class="hljs-comment">//   controller: PipManager.getInstance().getXComponentController(), // 设置XComponentController</span></li><li>      <span class="hljs-comment">// }</span></li><li>      <span class="hljs-comment">// this.xComponent = typeNode.createNode(ctx, "XComponent", xc_options);</span></li><li>
</li><li>      <span class="hljs-comment">// 创建XComponent类型的typeNode</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponent</span> = typeNode.<span class="hljs-title function_">createNode</span>(ctx, <span class="hljs-string">"XComponent"</span>, {</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>, <span class="hljs-comment">// 类型设置为SURFACE</span></li><li>        <span class="hljs-attr">controller</span>: <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getXComponentController</span>(), <span class="hljs-comment">// 设置XComponentController</span></li><li>      });</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="359.1" originheight="852" originwidth="568" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114834.20344637744062427766422629130680:50001231000000:2800:5DAB4D4EB471F2C28D635F71F85ACE55DE10FC69ABCB0AC98AA9A1C25C11A19B.gif" title="点击放大" width="239.4"></span></p> <div class="tiledSection"><h2 id="section1236517470234">应用使用router导航时通过typeNode实现画中画功能<i class="anchor-icon anchor-icon-link" anchorid="section1236517470234" tips="复制节点链接"></i></h2></div> <ol><li><span>创建画中画控制器，注册生命周期事件以及控制事件回调。</span><p></p><ul><li>创建自定义NodeController，实现makeNode方法，在该方法中创建typeNode。</li><li>通过create(config: PiPConfiguration, contentNode: typeNode.XComponent)接口创建画中画控制器实例。</li><li>通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画。</li><li>通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调。</li><li>通过画中画控制器实例的on('controlEvent')接口注册控制事件回调。</li></ul> <p></p></li><li><span>启动画中画。</span><p></p><p>创建画中画控制器实例后，通过startPiP接口启动画中画，在画中画ABOUT_TO_START生命周期将typeNode节点从布局移除，并返回上级界面（可选）。如果启动画中画时返回了上级界面，需要在画中画ABOUT_TO_RESTORE（还原）时重新跳转到原界面。</p> <p></p></li><li><span>更新媒体源尺寸信息。</span><p></p><p>画中画媒体源更新后（如切换视频），通过画中画控制器实例的updateContentSize接口更新媒体源尺寸信息，以调整画中画窗口比例。</p> <p></p></li><li><span>关闭画中画。</span><p></p><p>当不再需要显示画中画时，可根据业务需要，通过画中画控制器实例的stopPiP接口关闭画中画，在画中画ABOUT_TO_STOP生命周期将typeNode节点重新添加到布局中。</p> <p></p></li></ol> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-keyword">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>     <span class="hljs-comment">// ...</span></li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span>, router, <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; <span class="hljs-comment">// 引入PiPWindow模块</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Index'</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">page1</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'pages/Page1'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageRouter</span>: <span class="hljs-title class_">Router</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-comment">// 画中画生命周期事件监听，用于页面及节点操作</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`pipStateChange: state <span class="hljs-subst">${state}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>) {</li><li>      <span class="hljs-comment">// 返回到上级页面（可选）</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageRouter</span>?.<span class="hljs-title function_">back</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>) {</li><li>      <span class="hljs-comment">// 重新将typeNode节点添加到布局中，例如还原场景</span></li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addNode</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>) {</li><li>      <span class="hljs-comment">// 如果在ABOUT_TO_START时返回了上级界面，需要还原时push到原界面</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpNext</span>();</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageRouter</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>();</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unregisterPipStateChangeListener</span>();</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">jumpNext</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> topPage = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageRouter</span>?.<span class="hljs-title function_">getState</span>();</li><li>    <span class="hljs-keyword">if</span> (topPage !== <span class="hljs-literal">undefined</span> &amp;&amp; (<span class="hljs-variable language_">this</span>.<span class="hljs-property">page1</span>.<span class="hljs-title function_">toString</span>() === topPage.<span class="hljs-property">path</span> + topPage.<span class="hljs-property">name</span>)) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`page1 aready at top`</span>)</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageRouter</span>?.<span class="hljs-title function_">pushUrl</span>({</li><li>      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">page1</span> <span class="hljs-comment">// 目标url</span></li><li>    }, router.<span class="hljs-property">RouterMode</span>.<span class="hljs-property">Standard</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Invoke pushUrl failed, code is <span class="hljs-subst">${err.code}</span>: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Invoke pushUrl succeeded.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Main Page'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Jump Next'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpNext</span>();</li><li>          })</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">16</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/Page1.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Page1'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'This is Page1'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">margin</span>({<span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span>})</li><li>
</li><li>      <span class="hljs-comment">// 将typeNode添加到页面布局中</span></li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getNodeController</span>())</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'800px'</span> })</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startPip'</span>)<span class="hljs-comment">// 启动画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">startPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'stopPip'</span>)<span class="hljs-comment">// 停止画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">stopPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'updateSize'</span>)<span class="hljs-comment">// 更新视频尺寸</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 此处设置的宽高应为媒体内容宽高，需要通过媒体相关接口或回调获取</span></li><li>            <span class="hljs-comment">// 例如使用AVPlayer播放视频时，可通过videoSizeChange回调获取媒体源更新后的尺寸</span></li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1600</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#4da99797'</span>)</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageShow'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">initPipController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>);</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">true</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageHide'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">false</span>);</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">removeNode</span>();</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/PipManager.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span>, typeNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; <span class="hljs-comment">// 引入PiPWindow模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">XCNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./XCNodeController'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./AVPlayer'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomXComponentController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">XComponentController</span> {</li><li>  <span class="hljs-title function_">onSurfaceCreated</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceCreated surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> === surfaceId) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 将surfaceId设置给媒体源</span></li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> = surfaceId;</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-title function_">avPlayerFdSrc</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onSurfaceDestroyed</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceDestroyed surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipManager</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PipManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipManager</span>();</li><li>  <span class="hljs-keyword">private</span> pipController?: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPController</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xcNodeController</span>: <span class="hljs-title class_">XCNodeController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lifeCycleCallback</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Function</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">AVPlayer</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PipManager</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PipManager</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XCNodeController</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayer</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomXComponentController</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-params">callBack: <span class="hljs-built_in">Function</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">add</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-attr">callBack</span>: <span class="hljs-title class_">Function</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">delete</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNode</span>(): typeNode.<span class="hljs-property">XComponent</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">getNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onActionEvent</span>(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) {</li><li>    <span class="hljs-keyword">switch</span> (control.<span class="hljs-property">controlType</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PLAY_PAUSE</span>:</li><li>        <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PAUSE</span>) {</li><li>          <span class="hljs-comment">//停止视频</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PLAY</span>) {</li><li>          <span class="hljs-comment">//播放视频</span></li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_NEXT</span>:</li><li>        <span class="hljs-comment">// 切换到下一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PREVIOUS</span>:</li><li>        <span class="hljs-comment">// 切换到上一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_FORWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度快进</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_BACKWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度后退</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onActionEvent, controlType:'</span> + control.<span class="hljs-property">controlType</span> + <span class="hljs-string">', status'</span> + control.<span class="hljs-property">status</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">curState</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">setCanAddNode</span>(</li><li>      state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span> || state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>)</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fun</span>) =&gt;</span> {</li><li>        <span class="hljs-title function_">fun</span>(state)</li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_START"</span>;</li><li>        <span class="hljs-comment">// 将typeNode节点从布局移除</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">removeNode</span>();</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STARTED</span>:</li><li>        curState = <span class="hljs-string">"STARTED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_STOP"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>:</li><li>        curState = <span class="hljs-string">"STOPPED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_RESTORE"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ERROR</span>:</li><li>        curState = <span class="hljs-string">"ERROR"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[<span class="hljs-subst">${TAG}</span>] onStateChange: <span class="hljs-subst">${curState}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unregisterPipStateChangeListener</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> aboutToDisappear`</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'controlEvent'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getXComponentController</span>(): <span class="hljs-title class_">CustomXComponentController</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤1：创建画中画控制器，注册生命周期事件以及控制事件回调</span></li><li>  <span class="hljs-title function_">initPipController</span>(<span class="hljs-params">ctx: Context</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> onPageShow`</span>)</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">isPiPEnabled</span>()) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`picture in picture disabled for current OS`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPConfiguration</span> = {</li><li>      <span class="hljs-attr">context</span>: ctx,</li><li>      <span class="hljs-attr">componentController</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getXComponentController</span>(),</li><li>      <span class="hljs-attr">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPTemplateType</span>.<span class="hljs-property">VIDEO_PLAY</span>,</li><li>      <span class="hljs-attr">contentWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentWidth需设置为大于0的值，否则创建画中画失败</span></li><li>      <span class="hljs-attr">contentHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentHeight需设置为大于0的值，否则创建画中画失败</span></li><li>    };</li><li>    <span class="hljs-comment">// 通过create接口创建画中画控制器实例</span></li><li>    </li><li>    <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">create</span>(config, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNode</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">controller: PiPWindow.PiPController</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> = controller;</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-literal">true</span>)</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStateChange</span>(state, reason);</li><li>      });</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('controlEvent')接口注册控制事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlEvent'</span>, <span class="hljs-function">(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onActionEvent</span>(control);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create pip controller. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤2：启动画中画</span></li><li>  <span class="hljs-title function_">startPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">startPiP</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in starting pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤3：更新媒体源尺寸信息</span></li><li>  <span class="hljs-title function_">updateContentSize</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">updateContentSize</span>(width, height);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤4：关闭画中画</span></li><li>  <span class="hljs-title function_">stopPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">stopPiP</span>();</li><li>      promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in stopping pip.`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNodeController</span>(): <span class="hljs-title class_">XCNodeController</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getNodeController.`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setAutoStart</span>(<span class="hljs-attr">autoStart</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(autoStart);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">removeNode</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">removeNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">addNode</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">addNode</span>();</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/XCNodeController.ets</span></li><li><span class="hljs-keyword">import</span> { FrameNode, NodeController, typeNode } from <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { PipManager } from <span class="hljs-string">'./PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> TAG = <span class="hljs-string">'XCNodeController'</span>;</li><li><span class="hljs-comment">// 创建自定义NodeController</span></li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">XCNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  xComponent: typeNode.XComponent | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> node: FrameNode | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> canAddNode: boolean = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-comment">// 设置是否可以添加节点</span></li><li>  setCanAddNode(canAddNode: boolean) {</li><li>    <span class="hljs-keyword">this</span>.canAddNode = canAddNode;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 实现makeNode方法，当自定义NodeController被添加到布局时，该方法会被调用</span></li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">this</span>.node = new FrameNode(context);</li><li>    <span class="hljs-keyword">this</span>.node.commonAttribute</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined) {</li><li>      <span class="hljs-comment">// 创建typeNode</span></li><li>      <span class="hljs-comment">// let xc_options: XComponentOptions = {</span></li><li>      <span class="hljs-comment">//   type: XComponentType.TEXTURE, // 类型设置为TEXTURE</span></li><li>      <span class="hljs-comment">//   controller: PipManager.getInstance().getXComponentController(), // 设置XComponentController</span></li><li>      <span class="hljs-comment">// }</span></li><li>      <span class="hljs-comment">// this.xComponent = typeNode.createNode(context, "XComponent", xc_options);</span></li><li>
</li><li>      <span class="hljs-comment">// 创建XComponent类型的typeNode</span></li><li>      <span class="hljs-keyword">this</span>.xComponent = typeNode.createNode(context, <span class="hljs-string">"XComponent"</span>, {</li><li>        type: XComponentType.SURFACE, <span class="hljs-comment">// 类型设置为SURFACE</span></li><li>        controller: PipManager.getInstance().getXComponentController(), <span class="hljs-comment">// 设置XComponentController</span></li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canAddNode) {</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.xComponent.getParent()?.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.node;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 重新添加typeNode节点</span></li><li>  addNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"addNode"</span>);</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 移除typeNode节点</span></li><li>  removeNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"removeNode"</span>);</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  getNode(): typeNode.XComponent | <span class="hljs-literal">null</span> {</li><li>    console.info(TAG, <span class="hljs-string">"getNode is null:"</span>+ (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined))</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.xComponent;</li><li>  }</li><li>}</li></ol></pre></div></div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="342.68780000000004" originheight="584" originwidth="408" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114834.67735914558284307326214466200479:50001231000000:2800:D591D1CCCFEB83F29FFE0FA5D779F7E2DCAFDF18A9991AC938C91F267A35EC96.gif" title="点击放大" width="239.4"></span></p> <div class="tiledSection"><h2 id="section173761626124613">应用使用Navigation导航时通过typeNode实现画中画功能<i class="anchor-icon anchor-icon-link" anchorid="section173761626124613" tips="复制节点链接"></i></h2><ol><li><span>创建画中画控制器，注册生命周期事件以及控制事件回调。</span><p></p><ul><li>创建自定义NodeController，实现makeNode方法，在该方法中创建typeNode。</li><li>通过create(config: PiPConfiguration, contentNode: typeNode.XComponent)接口创建画中画控制器实例。</li><li>通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画。</li><li>通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调。</li><li>通过画中画控制器实例的on('controlEvent')接口注册控制事件回调。</li></ul> <p></p></li><li><span>启动画中画。</span><p></p><p>创建画中画控制器实例后，通过startPiP接口启动画中画，在画中画ABOUT_TO_START生命周期将typeNode节点从布局移除，并返回上级界面（可选）。如果启动画中画时返回了上级界面，需要在画中画ABOUT_TO_RESTORE（还原）时重新跳转到原界面。</p> <p></p></li><li><span>更新媒体源尺寸信息。</span><p></p><p>画中画媒体源更新后（如切换视频），通过画中画控制器实例的updateContentSize接口更新媒体源尺寸信息，以调整画中画窗口比例。</p> <p></p></li><li><span>关闭画中画。</span><p></p><p>当不再需要显示画中画时，可根据业务需要，通过画中画控制器实例的stopPiP接口关闭画中画，在画中画ABOUT_TO_STOP生命周期将typeNode节点重新添加到布局中。</p> <p></p></li></ol> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-keyword">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Page1</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../pages/Page1"</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Index1'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@Provide</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-comment">// 画中画生命周期事件监听，用于页面及节点操作</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`pipStateChange: state <span class="hljs-subst">${state}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>) {</li><li>      <span class="hljs-comment">// 返回到上级页面（可选）</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>) {</li><li>      <span class="hljs-comment">// 重新将typeNode节点添加到布局中，例如还原场景</span></li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addNode</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>) {</li><li>      <span class="hljs-comment">// 如果在ABOUT_TO_START时返回了上级界面，需要还原时push到原界面</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpNext</span>();</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">jumpNext</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">getAllPathName</span>()[<span class="hljs-number">0</span>] === <span class="hljs-string">'Page1'</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Page1 already at top'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Page1'</span> });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unregisterPipStateChangeListener</span>();</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">PageMap</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>) {</li><li>    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'Page1'</span>) {</li><li>      <span class="hljs-title class_">Page1</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"This is Main Page"</span>)</li><li>        <span class="hljs-title class_">Column</span>()</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'200px'</span>)</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Jump Page1"</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpNext</span>();</li><li>            })</li><li>        }</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#DCDCDC"</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">'MainTitle'</span>)</li><li>    .<span class="hljs-title function_">navDestination</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">PageMap</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/Page1.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Page1'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'This is Page1'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({<span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span>})</li><li>
</li><li>        <span class="hljs-comment">// 将typeNode添加到页面布局中</span></li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getNodeController</span>())</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'800px'</span> })</li><li>
</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startPip'</span>) <span class="hljs-comment">// 启动画中画</span></li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">startPip</span>();</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'stopPip'</span>) <span class="hljs-comment">// 停止画中画</span></li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">stopPip</span>();</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'updateSize'</span>) <span class="hljs-comment">// 更新视频尺寸</span></li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-comment">// 此处设置的宽高应为媒体内容宽高，需要通过媒体相关接口或回调获取</span></li><li>              <span class="hljs-comment">// 例如使用AVPlayer播放视频时，可通过videoSizeChange回调获取媒体源更新后的尺寸</span></li><li>              <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1600</span>);</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#4da99797'</span>)</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> })</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">title</span>(<span class="hljs-string">'page1'</span>)</li><li>    .<span class="hljs-title function_">onShown</span>(<span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onShown'</span>)</li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>);</li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">true</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(<span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onHidden'</span>)</li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">false</span>);</li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">removeNode</span>();</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/XCNodeController.ets</span></li><li><span class="hljs-keyword">import</span> { FrameNode, NodeController, typeNode } from <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { PipManager } from <span class="hljs-string">'./PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> TAG = <span class="hljs-string">'XCNodeController'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建自定义NodeController</span></li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">XCNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  xComponent: typeNode.XComponent| <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> node: FrameNode | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> canAddNode: boolean = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-comment">// 设置是否可以添加节点</span></li><li>  setCanAddNode(canAddNode: boolean) {</li><li>    <span class="hljs-keyword">this</span>.canAddNode = canAddNode;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 实现makeNode方法，当自定义NodeController被添加到布局时，该方法会被调用</span></li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    console.info(TAG, <span class="hljs-string">"makeNode"</span>);</li><li>    <span class="hljs-keyword">this</span>.node = new FrameNode(context);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined) {</li><li>      <span class="hljs-comment">// 创建typeNode</span></li><li>      <span class="hljs-comment">// let xc_options: XComponentOptions = {</span></li><li>      <span class="hljs-comment">//   type: XComponentType.TEXTURE, // 类型设置为TEXTURE</span></li><li>      <span class="hljs-comment">//   controller: PipManager.getInstance().getXComponentController(), // 设置XComponentController</span></li><li>      <span class="hljs-comment">// }</span></li><li>      <span class="hljs-comment">// this.xComponent = typeNode.createNode(context, "XComponent", xc_options);</span></li><li>
</li><li>      <span class="hljs-comment">// 创建XComponent类型的typeNode</span></li><li>      <span class="hljs-keyword">this</span>.xComponent = typeNode.createNode(context, <span class="hljs-string">"XComponent"</span>, {</li><li>        type: XComponentType.SURFACE, <span class="hljs-comment">// 类型设置为SURFACE</span></li><li>        controller: PipManager.getInstance().getXComponentController(), <span class="hljs-comment">// 设置XComponentController</span></li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canAddNode) {</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.xComponent.getParent()?.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.node;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 重新添加typeNode节点</span></li><li>  addNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"addNode id:"</span>+(<span class="hljs-keyword">this</span>.node?.getUniqueId())+<span class="hljs-string">" "</span>+<span class="hljs-keyword">this</span>.xComponent?.getUniqueId());</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 移除typeNode节点</span></li><li>  removeNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"removeNode"</span>);</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  getNode(): typeNode.XComponent | <span class="hljs-literal">null</span> {</li><li>    console.info(TAG, <span class="hljs-string">"getNode is null:"</span>+ (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined))</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.xComponent;</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/PipManager.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span>, typeNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">XCNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./XCNodeController'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./AVPlayer'</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomXComponentController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">XComponentController</span> {</li><li>  <span class="hljs-title function_">onSurfaceCreated</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceCreated surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> === surfaceId) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 将surfaceId设置给媒体源</span></li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> = surfaceId;</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-title function_">avPlayerFdSrc</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onSurfaceDestroyed</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceDestroyed surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipManager</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PipManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipManager</span>();</li><li>  <span class="hljs-keyword">private</span> pipController?: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPController</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xcNodeController</span>: <span class="hljs-title class_">XCNodeController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lifeCycleCallback</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Function</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">AVPlayer</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PipManager</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PipManager</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XCNodeController</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayer</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomXComponentController</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-params">callBack: <span class="hljs-built_in">Function</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">add</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-attr">callBack</span>: <span class="hljs-title class_">Function</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">delete</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNode</span>(): typeNode.<span class="hljs-property">XComponent</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">getNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onActionEvent</span>(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) {</li><li>    <span class="hljs-keyword">switch</span> (control.<span class="hljs-property">controlType</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PLAY_PAUSE</span>:</li><li>        <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PAUSE</span>) {</li><li>          <span class="hljs-comment">//停止视频</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PLAY</span>) {</li><li>          <span class="hljs-comment">//播放视频</span></li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_NEXT</span>:</li><li>        <span class="hljs-comment">// 切换到下一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PREVIOUS</span>:</li><li>        <span class="hljs-comment">// 切换到上一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_FORWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度快进</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_BACKWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度后退</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onActionEvent, controlType:'</span> + control.<span class="hljs-property">controlType</span> + <span class="hljs-string">', status'</span> + control.<span class="hljs-property">status</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">curState</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">setCanAddNode</span>(</li><li>      state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span> || state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>)</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fun</span>) =&gt;</span> {</li><li>        <span class="hljs-title function_">fun</span>(state);</li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_START"</span>;</li><li>        <span class="hljs-comment">// 将typeNode节点从布局移除</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">removeNode</span>();</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STARTED</span>:</li><li>        curState = <span class="hljs-string">"STARTED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_STOP"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>:</li><li>        curState = <span class="hljs-string">"STOPPED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_RESTORE"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ERROR</span>:</li><li>        curState = <span class="hljs-string">"ERROR"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[<span class="hljs-subst">${TAG}</span>] onStateChange: <span class="hljs-subst">${curState}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unregisterPipStateChangeListener</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> aboutToDisappear`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'controlEvent'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getXComponentController</span>(): <span class="hljs-title class_">CustomXComponentController</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤1：创建画中画控制器，注册生命周期事件以及控制事件回调</span></li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">ctx: Context</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> onPageShow`</span>)</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">isPiPEnabled</span>()) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`picture in picture disabled for current OS`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPConfiguration</span> = {</li><li>      <span class="hljs-attr">context</span>: ctx,</li><li>      <span class="hljs-attr">componentController</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getXComponentController</span>(),</li><li>      <span class="hljs-attr">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPTemplateType</span>.<span class="hljs-property">VIDEO_PLAY</span>,</li><li>      <span class="hljs-attr">contentWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentWidth需设置为大于0的值，否则创建画中画失败</span></li><li>      <span class="hljs-attr">contentHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentHeight需设置为大于0的值，否则创建画中画失败</span></li><li>    };</li><li>    <span class="hljs-comment">// 通过create接口创建画中画控制器实例</span></li><li>    </li><li>    <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">create</span>(config, <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">getNode</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">controller: PiPWindow.PiPController</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> = controller;</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-literal">true</span>);</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStateChange</span>(state, reason);</li><li>      });</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('controlEvent')接口注册控制事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlEvent'</span>, <span class="hljs-function">(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onActionEvent</span>(control);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create pip controller. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤2：启动画中画</span></li><li>  <span class="hljs-title function_">startPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">startPiP</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in starting pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤3：更新媒体源尺寸信息</span></li><li>  <span class="hljs-title function_">updateContentSize</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">updateContentSize</span>(width, height);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤4：关闭画中画</span></li><li>  <span class="hljs-title function_">stopPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">null</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">stopPiP</span>();</li><li>    promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in stopping pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNodeController</span>(): <span class="hljs-title class_">XCNodeController</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getNodeController.`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setAutoStart</span>(<span class="hljs-attr">autoStart</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(autoStart);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">removeNode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">removeNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">addNode</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">addNode</span>();</li><li>  }</li><li>}</li></ol></pre></div></div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="342.67449999999997" originheight="584" originwidth="408" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114835.58614223930950679547379653356500:50001231000000:2800:29EB47BE113EA3EF46473E847063E5D8B46016340ACDDA66DCDE6AF103585002.gif" title="点击放大" width="239.4"></span></p> </div> <div class="tiledSection"><h2 id="section8907336134011">应用使用单界面Ability时通过typeNode实现画中画功能<i class="anchor-icon anchor-icon-link" anchorid="section8907336134011" tips="复制节点链接"></i></h2><ol><li><span>创建画中画控制器，注册生命周期事件以及控制事件回调。</span><p></p><ul><li>创建自定义NodeController，实现makeNode方法，在该方法中创建typeNode。</li><li>通过create(config: PiPConfiguration, contentNode: typeNode.XComponent)接口创建画中画控制器实例。</li><li>通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画。</li><li>通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调。</li><li>通过画中画控制器实例的on('controlEvent')接口注册控制事件回调。</li></ul> <p></p></li><li><span>启动画中画。</span><p></p><p>创建画中画控制器实例后，通过startPiP接口启动画中画，在画中画ABOUT_TO_START生命周期将typeNode节点从布局移除。</p> <p></p></li><li><span>更新媒体源尺寸信息。</span><p></p><p>画中画媒体源更新后（如切换视频），通过画中画控制器实例的updateContentSize接口更新媒体源尺寸信息，以调整画中画窗口比例。</p> <p></p></li><li><span>关闭画中画。</span><p></p><p>当不再需要显示画中画时，可根据业务需要，通过画中画控制器实例的stopPiP接口关闭画中画，在画中画ABOUT_TO_STOP生命周期将typeNode节点重新添加到布局中。</p> <p></p></li></ol> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-keyword">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/PipManager'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; <span class="hljs-comment">// 引入PiPWindow模块</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Index'</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>) {</li><li>      <span class="hljs-comment">// 画中画关闭或还原时触发ABOUT_TO_STOP生命周期，此时需要重新添加节点</span></li><li>      <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addNode</span>();</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'This is MainPage'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-comment">// 将typeNode添加到页面布局中</span></li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getNodeController</span>())</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'800px'</span> })</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'startPip'</span>) <span class="hljs-comment">// 启动画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">startPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'stopPip'</span>) <span class="hljs-comment">// 停止画中画</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">stopPip</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'updateSize'</span>) <span class="hljs-comment">// 更新视频尺寸</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 此处设置的宽高应为媒体内容宽高，需要通过媒体相关接口或回调获取</span></li><li>            <span class="hljs-comment">// 例如使用AVPlayer播放视频时，可通过videoSizeChange回调获取媒体源更新后的尺寸</span></li><li>            <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updateContentSize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1600</span>);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#4da99797'</span>)</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> })</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unregisterPipStateChangeListener</span>();</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageShow'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>);</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">true</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onPageHide'</span>)</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setAutoStart</span>(<span class="hljs-literal">false</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/XCNodeController.ets</span></li><li><span class="hljs-keyword">import</span> { FrameNode, NodeController, typeNode } from <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { PipManager } from <span class="hljs-string">'./PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> TAG = <span class="hljs-string">'XCNodeController'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建自定义NodeController</span></li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">XCNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  xComponent: typeNode.XComponent | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> node: FrameNode | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> canAddNode: boolean = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-comment">// 设置是否可以添加节点</span></li><li>  setCanAddNode(canAddNode: boolean) {</li><li>    <span class="hljs-keyword">this</span>.canAddNode = canAddNode;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 实现makeNode方法，当自定义NodeController被添加到布局时，该方法会被调用</span></li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">this</span>.node = new FrameNode(context);</li><li>    <span class="hljs-keyword">this</span>.node.commonAttribute</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined) {</li><li>      <span class="hljs-comment">// 创建typeNode</span></li><li>      <span class="hljs-comment">// let xc_options: XComponentOptions = {</span></li><li>      <span class="hljs-comment">//   type: XComponentType.TEXTURE, // 类型设置为TEXTURE</span></li><li>      <span class="hljs-comment">//   controller: PipManager.getInstance().getXComponentController(), // 设置XComponentController</span></li><li>      <span class="hljs-comment">// }</span></li><li>      <span class="hljs-comment">// this.xComponent = typeNode.createNode(context, "XComponent", xc_options);</span></li><li>
</li><li>      <span class="hljs-comment">// 创建XComponent类型的typeNode</span></li><li>      <span class="hljs-keyword">this</span>.xComponent = typeNode.createNode(context, <span class="hljs-string">"XComponent"</span>, {</li><li>        type: XComponentType.SURFACE, <span class="hljs-comment">// 类型设置为SURFACE</span></li><li>        controller: PipManager.getInstance().getXComponentController(), <span class="hljs-comment">// 设置XComponentController</span></li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canAddNode) {</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.xComponent.getParent()?.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.node;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 重新添加typeNode节点</span></li><li>  addNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"addNode"</span>);</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.appendChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to appendChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 移除typeNode节点</span></li><li>  removeNode() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.node !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.node !== undefined) {</li><li>      console.info(TAG, <span class="hljs-string">"removeNode"</span>);</li><li>      </li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">this</span>.node.removeChild(<span class="hljs-keyword">this</span>.xComponent);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        console.error(TAG, <span class="hljs-string">'Failed to removeChild'</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  getNode(): typeNode.XComponent | <span class="hljs-literal">null</span> {</li><li>    console.info(TAG, <span class="hljs-string">"getNode is null: "</span>+ (<span class="hljs-keyword">this</span>.xComponent === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.xComponent === undefined));</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.xComponent;</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-adn-c106="" class="highlight-div"><div _ngcontent-adn-c106="" class="highlight-div-header"><div _ngcontent-adn-c106="" class="highlight-div-header-left"><div _ngcontent-adn-c106="" class="handle-button expand-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adn-c106="" class="highlight-div-header-right"><div _ngcontent-adn-c106="" class="handle-button ai-button"></div><div _ngcontent-adn-c106="" class="handle-button line-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adn-c106="" class="handle-button theme-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adn-c106="" class="handle-button copy-button"><div _ngcontent-adn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// model/PipManager.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PiPWindow</span>, typeNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; <span class="hljs-comment">// 引入PiPWindow模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">XCNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./XCNodeController'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVPlayer</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/AVPlayer'</span></li><li>
</li><li><span class="hljs-comment">// 自定义XComponentController</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomXComponentController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">XComponentController</span> {</li><li>  <span class="hljs-title function_">onSurfaceCreated</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceCreated surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> === surfaceId) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-property">surfaceID</span> = surfaceId;</li><li>    <span class="hljs-title class_">PipManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">player</span>.<span class="hljs-title function_">avPlayerFdSrc</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onSurfaceDestroyed</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onSurfaceDestroyed surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PipManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipManager</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PipManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PipManager</span>();</li><li>  <span class="hljs-keyword">private</span> pipController?: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPController</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xcNodeController</span>: <span class="hljs-title class_">XCNodeController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lifeCycleCallback</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Function</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">AVPlayer</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PipManager</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PipManager</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XCNodeController</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayer</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomXComponentController</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerLifecycleCallback</span>(<span class="hljs-params">callBack: <span class="hljs-built_in">Function</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">add</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterLifecycleCallback</span>(<span class="hljs-attr">callBack</span>: <span class="hljs-title class_">Function</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">delete</span>(callBack);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNode</span>(): typeNode.<span class="hljs-property">XComponent</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">getNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onActionEvent</span>(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) {</li><li>    <span class="hljs-keyword">switch</span> (control.<span class="hljs-property">controlType</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PLAY_PAUSE</span>:</li><li>        <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PAUSE</span>) {</li><li>          <span class="hljs-comment">//停止视频</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (control.<span class="hljs-property">status</span> === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlStatus</span>.<span class="hljs-property">PLAY</span>) {</li><li>          <span class="hljs-comment">//播放视频</span></li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_NEXT</span>:</li><li>        <span class="hljs-comment">// 切换到下一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">VIDEO_PREVIOUS</span>:</li><li>        <span class="hljs-comment">// 切换到上一个视频</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_FORWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度快进</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPControlType</span>.<span class="hljs-property">FAST_BACKWARD</span>:</li><li>        <span class="hljs-comment">// 视频进度后退</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onActionEvent, controlType:'</span> + control.<span class="hljs-property">controlType</span> + <span class="hljs-string">', status'</span> + control.<span class="hljs-property">status</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">curState</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">setCanAddNode</span>(</li><li>      state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span> || state === <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lifeCycleCallback</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fun</span>) =&gt;</span> {</li><li>        <span class="hljs-title function_">fun</span>(state);</li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_START</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_START"</span>;</li><li>        <span class="hljs-comment">// 将typeNode节点从布局移除</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">removeNode</span>();</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STARTED</span>:</li><li>        curState = <span class="hljs-string">"STARTED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_STOP</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_STOP"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">STOPPED</span>:</li><li>        curState = <span class="hljs-string">"STOPPED"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ABOUT_TO_RESTORE</span>:</li><li>        curState = <span class="hljs-string">"ABOUT_TO_RESTORE"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPState</span>.<span class="hljs-property">ERROR</span>:</li><li>        curState = <span class="hljs-string">"ERROR"</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[<span class="hljs-subst">${TAG}</span>] onStateChange: <span class="hljs-subst">${curState}</span>, reason: <span class="hljs-subst">${reason}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unregisterPipStateChangeListener</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> aboutToDisappear`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'controlEvent'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getXComponentController</span>(): <span class="hljs-title class_">CustomXComponentController</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤1：创建画中画控制器，注册生命周期事件以及控制事件回调</span></li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">ctx: Context</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> onPageShow`</span>)</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">isPiPEnabled</span>()) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`picture in picture disabled for current OS`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPConfiguration</span> = {</li><li>      <span class="hljs-attr">context</span>: ctx,</li><li>      <span class="hljs-attr">componentController</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getXComponentController</span>(),</li><li>      <span class="hljs-attr">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPTemplateType</span>.<span class="hljs-property">VIDEO_PLAY</span>,</li><li>      <span class="hljs-attr">contentWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentWidth需设置为大于0的值，否则创建画中画失败</span></li><li>      <span class="hljs-attr">contentHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 使用typeNode启动画中画时，contentHeight需设置为大于0的值，否则创建画中画失败</span></li><li>    };</li><li>    <span class="hljs-comment">// 通过create接口创建画中画控制器实例</span></li><li>    </li><li>    <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">create</span>(config, <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">getNode</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">controller: PiPWindow.PiPController</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> = controller;</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的setAutoStartEnabled接口设置是否需要在应用返回桌面时自动启动画中画</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-literal">true</span>);</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('stateChange')接口注册生命周期事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStateChange</span>(state, reason);</li><li>      });</li><li>      <span class="hljs-comment">// 通过画中画控制器实例的on('controlEvent')接口注册控制事件回调</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlEvent'</span>, <span class="hljs-function">(<span class="hljs-params">control: PiPWindow.ControlEventParam</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onActionEvent</span>(control);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create pip controller. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤2：启动画中画</span></li><li>  <span class="hljs-title function_">startPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">startPiP</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in starting pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤3：更新媒体源尺寸信息</span></li><li>  <span class="hljs-title function_">updateContentSize</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">updateContentSize</span>(width, height);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 步骤4：关闭画中画</span></li><li>  <span class="hljs-title function_">stopPip</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">null</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>.<span class="hljs-title function_">stopPiP</span>();</li><li>    promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in stopping pip.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop pip. Cause:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNodeController</span>(): <span class="hljs-title class_">XCNodeController</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getNodeController.`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setAutoStart</span>(<span class="hljs-attr">autoStart</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(autoStart);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 将typeNode节点添加到原父节点</span></li><li>  <span class="hljs-title function_">addNode</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">xcNodeController</span>.<span class="hljs-title function_">addNode</span>();</li><li>  }</li><li>}</li></ol></pre></div></div> <p>以上示例代码对应的示意图如下所示：</p> <p><span><img height="342.6612" originheight="584" originwidth="408" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114835.54229058570084100772681033061102:50001231000000:2800:67DFDB7E65751212AAB8B84F78BFBF5549E48C8D90F66161E94AFF9A96A6D51C.gif" title="点击放大" width="239.4"></span></p> </div> <div class="tiledSection"><h2 id="section272177265">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section272177265" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/guide-snippets/tree/master/ArkUIWindowPipSamples/WindowPip" target="_blank">实现画中画效果</a></li></ul> </div> </div> <div></div></div>