<h1 _ngcontent-jyv-c119="" class="doc-title ng-star-inserted" title="使用保存控件"> 使用保存控件 </h1>

<div _ngcontent-jyv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>保存控件允许用户通过点击按钮临时获取存储权限，无需权限弹框确认。</p>    <p>集成保存控件后，当用户点击该控件时，应用会获得一分钟内访问媒体库特权接口的授权。这适用于任何需要将文件保存到媒体库的应用场景，例如保存图片或视频等。</p>    <p>与需要触发系统应用并由用户选择具体保存路径的Picker不同，保存控件可以直接保存到指定的媒体库路径，使得操作更为便捷。</p>    <p>保存控件效果如图所示。</p>    <p><span><img originheight="700" originwidth="721" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115042.59594356975634535769307547915351:50001231000000:2800:FFB597A6D4F2FBE6CC5247BC0DBC1D07074065E187980CCD80FF0E3CEF764FDF.png" width="721" height="700"></span></p>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>当用户首次点击应用中的保存控件，系统将弹窗请求用户授权。如果用户点击“取消”，弹窗消失，应用无授权，用户再次点击保存控件时，将会重新弹窗；如果用户点击“允许”，弹窗消失，应用将被授予临时保存权限，此后点击该应用的保存控件将不会弹窗。</p></li>      <li>       <p>应用在点击控件触发onClick()回调到调用媒体库特权接口的时间间隔不能大于一分钟。</p></li>      <li>       <p>保存控件仅支持在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-e#windowtype7" target="_blank">应用主窗口和子窗口</a>中使用，且不支持在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-uiextension" target="_blank">UIExtension</a>中使用。</p></li>      <li>       <p>用户点击一次控件，仅获取一次授权调用。</p></li>      <li>       <p>为了保障用户的隐私不被恶意应用获取，应用需确保安全控件是可见的且用户能够识别的。开发者需要合理的配置控件的尺寸、颜色等属性，避免视觉混淆的情况，如果发生因控件的样式不合法导致授权失败的情况，请检查设备错误日志。</p></li>      <li>       <p>当开发者需要自定义保存控件的图标和文本时，需要向应用市场申请ohos.permission.CUSTOMIZE_SAVE_BUTTON权限。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>ohos.permission.CUSTOMIZE_SAVE_BUTTON受限开放，仅默认样式无法满足业务场景时可申请，申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请使用受限权限</a>。</p>        </div></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以保存对话中图片为例，应用仅需在前台期间短暂使用保存图片的特性，而不需要长时间使用。此时，可以直接使用安全控件中的保存控件，免去权限申请和请求等环节，获得临时授权，保存对应图片。</p>     <ol>      <li>       <p>导入文件和媒体库依赖。</p>       <div _ngcontent-jyv-c106="" class="highlight-div"><div _ngcontent-jyv-c106="" class="highlight-div-header"><div _ngcontent-jyv-c106="" class="highlight-div-header-left"><div _ngcontent-jyv-c106="" class="handle-button expand-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jyv-c106="" class="highlight-div-header-right"><div _ngcontent-jyv-c106="" class="handle-button ai-button"></div><div _ngcontent-jyv-c106="" class="handle-button line-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jyv-c106="" class="handle-button theme-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jyv-c106="" class="handle-button copy-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jyv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>设置图片资源并添加保存控件。</p>       <p>保存控件是由图标、文本和背景组成的类似按钮的安全控件。其中，背景是必选的，图标和文本至少选择一个。图标和文本可以从已有的选项中选择，也可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-security-components-savebutton#seticon20" target="_blank">setIcon</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-security-components-savebutton#settext20" target="_blank">setText</a>自定义。在声明安全控件的接口时，有传参和不传参两种方式。不传参将默认创建一个包含图标、文字和背景的按钮；传参则根据参数创建，不包含未配置的元素。</p>       <p>当前示例使用默认参数。具体请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-security-components-savebutton" target="_blank">SaveButton控件</a>。此外，所有安全控件都继承了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-securitycomponent-attributes" target="_blank">安全控件通用属性</a>，可用于定制样式。</p>       <p>有关将图片保存到媒体库的详细信息，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">保存媒体库资源</a>。</p>       <div _ngcontent-jyv-c106="" class="highlight-div"><div _ngcontent-jyv-c106="" class="highlight-div-header"><div _ngcontent-jyv-c106="" class="highlight-div-header-left"><div _ngcontent-jyv-c106="" class="handle-button expand-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jyv-c106="" class="highlight-div-header-right"><div _ngcontent-jyv-c106="" class="handle-button ai-button"></div><div _ngcontent-jyv-c106="" class="handle-button line-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jyv-c106="" class="handle-button theme-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jyv-c106="" class="handle-button copy-button"><div _ngcontent-jyv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jyv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { promptAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">savePhotoToGallery</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>  <span class="hljs-keyword">let</span> helper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// onClick触发后一分钟内通过createAsset接口创建图片文件，一分钟后createAsset权限收回。</span></li><li>    <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> helper.<span class="hljs-title function_">createAsset</span>(photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>, <span class="hljs-string">'jpg'</span>);</li><li>    <span class="hljs-comment">// 使用uri打开文件，可以持续写入内容，写入过程不受时间限制。</span></li><li>    <span class="hljs-keyword">let</span> file = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>    <span class="hljs-comment">// $r('app.media.startIcon')需要替换为开发者所需的图像资源文件。</span></li><li>    context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getMediaContent</span>($r(<span class="hljs-string">'app.media.startIcon'</span>).<span class="hljs-property">id</span>, <span class="hljs-number">0</span>)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> value =&gt; {</li><li>        <span class="hljs-keyword">let</span> media = value.<span class="hljs-property">buffer</span>;</li><li>        <span class="hljs-comment">// 写到媒体库文件中。</span></li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">write</span>(file.<span class="hljs-property">fd</span>, media);</li><li>        <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">close</span>(file.<span class="hljs-property">fd</span>);</li><li>        promptAction.<span class="hljs-title function_">openToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'已保存至相册！'</span> });</li><li>      });</li><li>  }</li><li>  <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to save photo. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>        <span class="hljs-comment">// $r('app.media.startIcon')需要替换为开发者所需的图像资源文件。</span></li><li>        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.startIcon'</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>        <span class="hljs-title class_">SaveButton</span>()</li><li>          .<span class="hljs-title function_">padding</span>({<span class="hljs-attr">top</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">24</span>})</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent, result: SaveButtonOnClickResult</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (result === <span class="hljs-title class_">SaveButtonOnClickResult</span>.<span class="hljs-property">SUCCESS</span>) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>              <span class="hljs-comment">// 免去权限申请和权限请求等环节，获得临时授权，保存对应图片。</span></li><li>              <span class="hljs-title function_">savePhotoToGallery</span>(context);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              promptAction.<span class="hljs-title function_">openToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'设置权限失败！'</span> });</li><li>            }</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xf1f3f5</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>