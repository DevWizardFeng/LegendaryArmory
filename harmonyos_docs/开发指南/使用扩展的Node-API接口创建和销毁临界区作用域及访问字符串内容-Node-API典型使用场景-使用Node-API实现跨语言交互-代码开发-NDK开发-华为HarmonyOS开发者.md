<h1 _ngcontent-wvy-c119="" class="doc-title ng-star-inserted" title="使用扩展的Node-API接口创建和销毁临界区作用域及访问字符串内容"> 使用扩展的Node-API接口创建和销毁临界区作用域及访问字符串内容 </h1>

<div _ngcontent-wvy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Node-API扩展接口napi_open_critical_scope用于打开临界区作用域，napi_close_critical_scope用于关闭临界区作用域。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>非临界接口不能在临界区作用域使用，且同一执行环境中只能打开一个临界区作用域。建议仅在需要临界接口时打开临界区作用域，使用后应及时关闭。</p>  </div></div></div>  <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>调用临界接口前，必须通过napi_open_critical_scope打开临界区作用域，并在临界区作用域内进行调用。</p> <p>关闭临界区作用域后，请勿使用临界接口及其返回结果，否则可能导致程序崩溃或数据损坏。</p> </div>  <div class="tiledSection"><h2 id="临界区作用域的打开关闭及临界接口的使用">临界区作用域的打开、关闭及临界接口的使用<i class="anchor-icon anchor-icon-link" anchorid="临界区作用域的打开关闭及临界接口的使用" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.4.1.1" valign="top" width="33.33333333333333%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.4.1.2" valign="top" width="33.33333333333333%">描述</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.4.1.3" valign="top" width="33.33333333333333%">临界区作用域外执行的状态码</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">napi_open_critical_scope</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">打开临界区作用域</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">NA</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">napi_close_critical_scope</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">关闭临界区作用域</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">napi_generic_failure</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">napi_get_buffer_string_utf16_in_critical_scope</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">获取ArkTS String的UTF-16编码内存缓冲区数据</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">napi_generic_failure</td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>1.当ArkTS String以UTF-16编码存储时，napi_get_buffer_string_utf16_in_critical_scope才能正确获取其内存缓冲区，否则该函数返回错误。</p>  <p>2.napi_create_string_utf16和napi_create_string_utf8的功能是将输入数据以指定编码传递给虚拟机。这些函数不控制字符串在虚拟机的内部存储编码方式。</p>  </div></div></div> </div>  <div class="tiledSection"><h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2><ul><li><p>模块注册</p>  <div _ngcontent-wvy-c106="" class="highlight-div"><div _ngcontent-wvy-c106="" class="highlight-div-header"><div _ngcontent-wvy-c106="" class="highlight-div-header-left"><div _ngcontent-wvy-c106="" class="handle-button expand-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvy-c106="" class="highlight-div-header-right"><div _ngcontent-wvy-c106="" class="handle-button ai-button"></div><div _ngcontent-wvy-c106="" class="handle-button line-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvy-c106="" class="handle-button theme-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvy-c106="" class="handle-button copy-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvy-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string_view&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li>
</li><li>   <span class="hljs-comment">// 使用C++的RAII机制管理临界区作用域，避免遗漏关闭</span></li><li>   <span class="hljs-comment">// 仅用作示例，也可以通过其他方式进行封装，或直接使用原始接口</span></li><li>   <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCriticalScope</span></li><li>{</li><li>   napi_env env_{};</li><li>   napi_critical_scope scope_{};</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>   <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">MyCriticalScope</span><span class="hljs-params">(napi_env env)</span> : env_(env)</span></li><li><span class="hljs-function">   {</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_open_critical_scope</span>(env, &amp;scope_) != napi_ok)</li><li>      {</li><li>            <span class="hljs-comment">// 失败时，进行一些必要的错误处理，或维护信息补充，此处省略。</span></li><li>            <span class="hljs-comment">// 常见失败原因：env不是有效的Node-API执行上下文（如：env参数为nullptr）</span></li><li>      }</li><li>   }</li><li>   ~<span class="hljs-built_in">MyCriticalScope</span>()</li><li>   {</li><li>      <span class="hljs-built_in">Close</span>();</li><li>   }</li><li>   <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">   </span>{</li><li>      <span class="hljs-keyword">if</span> (scope_ == <span class="hljs-literal">nullptr</span>)</li><li>      {</li><li>            <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 在析构函数中，关闭临界区作用域</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_close_critical_scope</span>(env_, scope_) != napi_ok)</li><li>      {</li><li>            <span class="hljs-comment">// 失败时，进行一些必要的错误处理，或维护信息补充，此处省略。</span></li><li>            <span class="hljs-comment">// 常见失败原因：</span></li><li>            <span class="hljs-comment">// 1. 重复关闭临界区作用域。</span></li><li>            <span class="hljs-comment">// 2. env不是有效的Node-API执行上下文（如：空指针）。</span></li><li>            <span class="hljs-comment">// 3. scope不是有效的临界区作用域句柄（如：空指针）。</span></li><li>      }</li><li>      scope_ = <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>};</li><li>
</li><li><span class="hljs-comment">// 二次封装的方法，用于在获取ArkTS字符串底层缓冲区失败时，回落到拷贝</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> std::vector&lt;<span class="hljs-type">char16_t</span>&gt; <span class="hljs-title">GetValueStringUtf16</span><span class="hljs-params">(napi_env env, napi_value value)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-type">size_t</span> strLength{};</li><li>   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf16</span>(env, value, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;strLength) != napi_ok) {</li><li>      <span class="hljs-keyword">return</span> {};</li><li>   }</li><li>   <span class="hljs-comment">/* Node-API接口要求缓冲区长度大于字符串内容长度，用于写入c字符串结束标记。</span></li><li><span class="hljs-comment">      因此，需要获取完整字符串内容时，缓冲区大小应为字符串长度 + 1。 */</span></li><li>   <span class="hljs-function">std::vector&lt;<span class="hljs-type">char16_t</span>&gt; <span class="hljs-title">result</span><span class="hljs-params">(strLength + <span class="hljs-number">1</span>)</span></span>;</li><li>   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf16</span>(env, value, result.<span class="hljs-built_in">data</span>(), result.<span class="hljs-built_in">size</span>(), &amp;strLength) != napi_ok) {</li><li>      <span class="hljs-keyword">return</span> {};</li><li>   }</li><li>   <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_getBufferStringUtf16</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   napi_value args[<span class="hljs-number">1</span>]{};</li><li>   <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>   <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-comment">/* thisVar */</span> <span class="hljs-literal">nullptr</span>, <span class="hljs-comment">/* data */</span> <span class="hljs-literal">nullptr</span>);</li><li>   <span class="hljs-comment">// 传入参数小于要求的最低参数数量</span></li><li>   <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>   napi_valuetype argType;</li><li>
</li><li>   <span class="hljs-comment">// 传入参数类型不是字符串</span></li><li>   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;argType) != napi_ok || argType != napi_string) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>
</li><li>   <span class="hljs-type">uint32_t</span> returnCode = <span class="hljs-number">0</span>;</li><li>   {</li><li>      [[maybe_unused]] <span class="hljs-function">MyCriticalScope <span class="hljs-title">scope</span><span class="hljs-params">(env)</span></span>;</li><li>      <span class="hljs-type">size_t</span> bufSize{};</li><li>      <span class="hljs-type">const</span> <span class="hljs-type">char16_t</span> *buf{};</li><li>      std::vector&lt;<span class="hljs-type">char16_t</span>&gt; copied{}; <span class="hljs-comment">// 预留，用以获取缓冲区失败时回落</span></li><li>      std::u16string_view str;</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_buffer_string_utf16_in_critical_scope</span>(env, args[<span class="hljs-number">0</span>], &amp;buf, &amp;bufSize) == napi_ok)</li><li>      {</li><li>            str = std::<span class="hljs-built_in">u16string_view</span>(buf, bufSize);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>            scope.<span class="hljs-built_in">Close</span>();</li><li>            copied = <span class="hljs-built_in">GetValueStringUtf16</span>(env, args[<span class="hljs-number">0</span>]);</li><li>            str = std::<span class="hljs-built_in">u16string_view</span>(copied.<span class="hljs-built_in">data</span>(), copied.<span class="hljs-built_in">size</span>());</li><li>            returnCode |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>);</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// do something with str</span></li><li>      <span class="hljs-keyword">if</span> (str == <span class="hljs-string">u"测试字符串"</span>) {</li><li>            returnCode |= <span class="hljs-number">1</span>;</li><li>      }</li><li>   }</li><li>
</li><li>   napi_value returnResult{};</li><li>   <span class="hljs-built_in">napi_create_int32</span>(env, returnCode, &amp;returnResult);</li><li>   <span class="hljs-keyword">return</span> returnResult;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 模块注册</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>   std::vector&lt;napi_property_descriptor&gt; desc{{<span class="hljs-string">"getBufferStringUtf16"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_getBufferStringUtf16,</li><li>                                                <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>   <span class="hljs-built_in">napi_define_properties</span>(env, exports, desc.<span class="hljs-built_in">size</span>(), desc.<span class="hljs-built_in">data</span>());</li><li>   <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>   .nm_version = <span class="hljs-number">1</span>,</li><li>   .nm_flags = <span class="hljs-number">0</span>,</li><li>   .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>   .nm_register_func = Init,</li><li>   .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>   .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>   .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>  </li><li><p>接口声明</p>  <div _ngcontent-wvy-c106="" class="highlight-div"><div _ngcontent-wvy-c106="" class="highlight-div-header"><div _ngcontent-wvy-c106="" class="highlight-div-header-left"><div _ngcontent-wvy-c106="" class="handle-button expand-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvy-c106="" class="highlight-div-header-right"><div _ngcontent-wvy-c106="" class="handle-button ai-button"></div><div _ngcontent-wvy-c106="" class="handle-button line-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvy-c106="" class="handle-button theme-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvy-c106="" class="handle-button copy-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getBufferStringUtf16</span>: <span class="hljs-function">(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>  </li><li><p>ArkTS代码示例</p>  <div _ngcontent-wvy-c106="" class="highlight-div"><div _ngcontent-wvy-c106="" class="highlight-div-header"><div _ngcontent-wvy-c106="" class="highlight-div-header-left"><div _ngcontent-wvy-c106="" class="handle-button expand-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wvy-c106="" class="highlight-div-header-right"><div _ngcontent-wvy-c106="" class="handle-button ai-button"></div><div _ngcontent-wvy-c106="" class="handle-button line-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wvy-c106="" class="handle-button theme-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wvy-c106="" class="handle-button copy-button"><div _ngcontent-wvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wvy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">"libentry.so"</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-title function_">makeTest</span> = (<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) =&gt; {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`status code of get buffer on "<span class="hljs-subst">${str}</span>": <span class="hljs-subst">${testNapi.getBufferStringUtf16(str)}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-string">"hello world"</span>); <span class="hljs-comment">// 预期结果: 2或0</span></li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-string">"你好"</span>);        <span class="hljs-comment">// 预期结果: 0或2</span></li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-string">"测试字符串"</span>);   <span class="hljs-comment">// 预期结果: 1或3</span></li></ol></pre></div></div>  </li></ul> </div> </div> <div></div></div>