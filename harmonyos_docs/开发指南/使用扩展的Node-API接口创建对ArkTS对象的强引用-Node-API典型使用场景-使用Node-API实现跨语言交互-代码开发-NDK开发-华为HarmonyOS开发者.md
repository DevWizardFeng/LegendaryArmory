<h1 _ngcontent-fow-c119="" class="doc-title ng-star-inserted" title="使用扩展的Node-API接口创建对ArkTS对象的强引用"> 使用扩展的Node-API接口创建对ArkTS对象的强引用 </h1>

<div _ngcontent-fow-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HarmonyOS提供的API优化了强引用的创建效率，保留了Node-API的强引用特性，相较于napi_ref，napi_strong_ref具有更快的创建效率。</p>  <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>开发者可以通过napi_create_strong_reference接口创建指向ArkTS对象的强引用，并通过napi_get_strong_reference_value获取引用的ArkTS对象。</p> </div>  <div class="tiledSection"><h2 id="强引用对象关联接口">强引用对象关联接口<i class="anchor-icon anchor-icon-link" anchorid="强引用对象关联接口" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口</th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">napi_create_strong_reference</td> <td class="cellrowborder" valign="top" width="50%">创建指向ArkTS对象的强引用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_delete_strong_reference</td> <td class="cellrowborder" valign="top" width="50%">删除强引用</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">napi_get_strong_reference_value</td> <td class="cellrowborder" valign="top" width="50%">根据强引用对象获取其关联的ArkTS对象值</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2><ul><li><p>模块注册</p>  <div _ngcontent-fow-c106="" class="highlight-div"><div _ngcontent-fow-c106="" class="highlight-div-header"><div _ngcontent-fow-c106="" class="highlight-div-header-left"><div _ngcontent-fow-c106="" class="handle-button expand-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fow-c106="" class="highlight-div-header-right"><div _ngcontent-fow-c106="" class="handle-button ai-button"></div><div _ngcontent-fow-c106="" class="handle-button line-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fow-c106="" class="handle-button theme-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fow-c106="" class="handle-button copy-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fow-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// napi_strong_ref 不支持跨线程使用。示例为单线程场景。请勿在业务代码中使用此方式声明。</span></li><li><span class="hljs-type">static</span> napi_strong_ref g_strongRef {};</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_saveOrReplaceObject</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   napi_value args[<span class="hljs-number">1</span>]{};</li><li>   <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>   <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-comment">/* thisVar */</span> <span class="hljs-literal">nullptr</span>, <span class="hljs-comment">/* data */</span> <span class="hljs-literal">nullptr</span>);</li><li>   <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>
</li><li>   <span class="hljs-keyword">if</span> (g_strongRef != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">napi_delete_strong_reference</span>(env, g_strongRef);</li><li>      g_strongRef = <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>   <span class="hljs-built_in">napi_create_strong_reference</span>(env, args[<span class="hljs-number">0</span>], &amp;g_strongRef);</li><li>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_releaseObject</span><span class="hljs-params">(napi_env env, [[maybe_unused]] napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-keyword">if</span> (g_strongRef != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">napi_delete_strong_reference</span>(env, g_strongRef);</li><li>      g_strongRef = <span class="hljs-literal">nullptr</span>;</li><li>   }</li><li>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_queryObject</span><span class="hljs-params">(napi_env env, [[maybe_unused]] napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   napi_value result {};</li><li>   <span class="hljs-built_in">napi_get_strong_reference_value</span>(env, g_strongRef, &amp;result);</li><li>   <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 模块注册</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>   std::vector&lt;napi_property_descriptor&gt; desc{</li><li>      {<span class="hljs-string">"saveOrReplaceObject"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_saveOrReplaceObject, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>      {<span class="hljs-string">"releaseObject"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_releaseObject, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>      {<span class="hljs-string">"queryObject"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_queryObject, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>   };</li><li>   <span class="hljs-built_in">napi_define_properties</span>(env, exports, desc.<span class="hljs-built_in">size</span>(), desc.<span class="hljs-built_in">data</span>());</li><li>   <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>   .nm_version = <span class="hljs-number">1</span>,</li><li>   .nm_flags = <span class="hljs-number">0</span>,</li><li>   .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>   .nm_register_func = Init,</li><li>   .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>   .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>   .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>  </li><li><p>接口声明</p>  <div _ngcontent-fow-c106="" class="highlight-div"><div _ngcontent-fow-c106="" class="highlight-div-header"><div _ngcontent-fow-c106="" class="highlight-div-header-left"><div _ngcontent-fow-c106="" class="handle-button expand-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fow-c106="" class="highlight-div-header-right"><div _ngcontent-fow-c106="" class="handle-button ai-button"></div><div _ngcontent-fow-c106="" class="handle-button line-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fow-c106="" class="handle-button theme-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fow-c106="" class="handle-button copy-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fow-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">saveOrReplaceObject</span>: &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">val: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">queryObject</span>: &lt;T&gt;<span class="hljs-function">() =&gt;</span> T;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">releaseObject</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div>  </li><li><p>ArkTS代码示例</p>  <div _ngcontent-fow-c106="" class="highlight-div"><div _ngcontent-fow-c106="" class="highlight-div-header"><div _ngcontent-fow-c106="" class="highlight-div-header-left"><div _ngcontent-fow-c106="" class="handle-button expand-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fow-c106="" class="highlight-div-header-right"><div _ngcontent-fow-c106="" class="handle-button ai-button"></div><div _ngcontent-fow-c106="" class="handle-button line-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fow-c106="" class="handle-button theme-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fow-c106="" class="handle-button copy-button"><div _ngcontent-fow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fow-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">"libentry.so"</span></li><li>
</li><li><span class="hljs-keyword">const</span> makeTest = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">val: T</span>) =&gt;</span> {</li><li>   testNapi.<span class="hljs-title function_">saveOrReplaceObject</span>(val);</li><li>   <span class="hljs-keyword">const</span> result = testNapi.<span class="hljs-property">queryObject</span>&lt;T&gt;();</li><li>   testNapi.<span class="hljs-title function_">releaseObject</span>();</li><li>   <span class="hljs-keyword">if</span> (val !== result) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"result not equals to input"</span>);</li><li>   }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 预期以下调用无异常</span></li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-number">0</span>);</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-string">"0"</span>);</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-literal">true</span>);</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-title class_">BigInt</span>(<span class="hljs-string">"0"</span>));</li><li><span class="hljs-title function_">makeTest</span>([]);</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>());</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-literal">undefined</span>);</li><li><span class="hljs-title function_">makeTest</span>(<span class="hljs-literal">null</span>);</li></ol></pre></div></div>  </li></ul> </div> </div> <div></div></div>