<h1 _ngcontent-ais-c119="" class="doc-title ng-star-inserted" title="使用瀑布流"> 使用瀑布流 </h1>

<div _ngcontent-ais-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ArkUI开发框架在NDK接口提供了瀑布流容器组件，通过瀑布流自身的排列规则，将不同大小的"项目"自上而下如瀑布般紧密布局。</p>  <div class="tiledSection"><h2 id="接入arkts页面">接入ArkTS页面<i class="anchor-icon anchor-icon-link" anchorid="接入arkts页面" tips="复制节点链接"></i></h2><p>为了使用NDK接口构建UI界面，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-access-the-arkts-page">接入ArkTS页面章节</a>，在ArkTS页面上创建用于Native页面挂载的占位组件，并实现ArkTS侧的NativeNode模块接口。</p> </div>  <div class="tiledSection"><h2 id="使用懒加载">使用懒加载<i class="anchor-icon anchor-icon-link" anchorid="使用懒加载" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="nodeadapter介绍" class="firsth2">NodeAdapter介绍<i class="anchor-icon anchor-icon-link" anchorid="nodeadapter介绍" tips="复制节点链接"></i></h3><p>NDK中提供了NodeAdapter对象替代ArkTS侧的LazyForeach功能，用于按需生成子组件。详情请参阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-loading-long-list#nodeadapter介绍">NodeAdapter介绍</a>。</p> </div>  <div class="tiledSection"><h3 id="实现懒加载适配器">实现懒加载适配器<i class="anchor-icon anchor-icon-link" anchorid="实现懒加载适配器" tips="复制节点链接"></i></h3><p>使用FlowItemAdapter类管理懒加载适配器。在类的构造函数中创建NodeAdapter对象，并给NodeAdapter对象设置事件监听器，在类的析构函数中，销毁NodeAdapter对象。</p> <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// FlowItemAdapter.h</span></li><li><span class="hljs-comment">// 懒加载功能代码。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_FLOWITEMADAPTER_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_FLOWITEMADAPTER_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stack&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_interface.h&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> NativeModule {</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowItemAdapter</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">FlowItemAdapter</span>(){</li><li>        </li><li>        <span class="hljs-comment">// 初始化函数指针结构体</span></li><li>        <span class="hljs-built_in">OH_ArkUI_GetModuleInterface</span>(ARKUI_NATIVE_NODE, ArkUI_NativeNodeAPI_1, nodeApi_);</li><li>        <span class="hljs-comment">// 创建Adapter对象</span></li><li>        adapter_ = <span class="hljs-built_in">OH_ArkUI_NodeAdapter_Create</span>();</li><li>        </li><li>        <span class="hljs-comment">// 初始化懒加载数据。</span></li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>            data_.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">to_string</span>(i));</li><li>        }</li><li>        <span class="hljs-comment">// 设置懒加载数据。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_SetTotalNodeCount</span>(adapter_, data_.<span class="hljs-built_in">size</span>());</li><li>        <span class="hljs-comment">// 设置事件监听器。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_RegisterEventReceiver</span>(adapter_, <span class="hljs-keyword">this</span>, OnStaticAdapterEvent);</li><li>    }</li><li>
</li><li>    ~<span class="hljs-built_in">FlowItemAdapter</span>() {</li><li>        <span class="hljs-comment">// 释放创建的组件。</span></li><li>        <span class="hljs-keyword">while</span> (!cachedItems_.<span class="hljs-built_in">empty</span>()) {</li><li>            cachedItems_.<span class="hljs-built_in">pop</span>();</li><li>        }</li><li>        <span class="hljs-comment">// 释放Adapter相关资源。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_UnregisterEventReceiver</span>(adapter_);</li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_Dispose</span>(adapter_);</li><li>    }</li><li>
</li><li>    <span class="hljs-function">ArkUI_NodeAdapterHandle <span class="hljs-title">GetAdapter</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> adapter_; }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RemoveItem</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> index)</span> </span>{</li><li>        <span class="hljs-comment">// 删除第index个数据。</span></li><li>        data_.<span class="hljs-built_in">erase</span>(data_.<span class="hljs-built_in">begin</span>() + index);</li><li>        <span class="hljs-comment">// 如果index会导致可视区域元素发生可见性变化，则会回调NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER事件删除元素，</span></li><li>        <span class="hljs-comment">// 根据是否有新增元素回调NODE_ADAPTER_EVENT_ON_GET_NODE_ID和NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER事件。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_RemoveItem</span>(adapter_, index, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-comment">// 更新新的数量。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_SetTotalNodeCount</span>(adapter_, data_.<span class="hljs-built_in">size</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InsertItem</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> index, <span class="hljs-type">const</span> std::string &amp;value)</span> </span>{</li><li>        data_.<span class="hljs-built_in">insert</span>(data_.<span class="hljs-built_in">begin</span>() + index, value);</li><li>        <span class="hljs-comment">// 如果index会导致可视区域元素发生可见性变化，则会回调NODE_ADAPTER_EVENT_ON_GET_NODE_ID和NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER事件，</span></li><li>        <span class="hljs-comment">// 根据是否有删除元素回调NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER事件。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_InsertItem</span>(adapter_, index, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-comment">// 更新新的数量。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_SetTotalNodeCount</span>(adapter_, data_.<span class="hljs-built_in">size</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MoveItem</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> oldIndex, <span class="hljs-type">int32_t</span> newIndex)</span> </span>{</li><li>        <span class="hljs-keyword">auto</span> temp = data_[oldIndex];</li><li>        data_.<span class="hljs-built_in">insert</span>(data_.<span class="hljs-built_in">begin</span>() + newIndex, temp);</li><li>        data_.<span class="hljs-built_in">erase</span>(data_.<span class="hljs-built_in">begin</span>() + oldIndex);</li><li>        <span class="hljs-comment">// 移到位置如果未发生可视区域内元素的可见性变化，则不回调事件，反之根据新增和删除场景回调对应的事件。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_MoveItem</span>(adapter_, oldIndex, newIndex);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReloadItem</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> index, <span class="hljs-type">const</span> std::string &amp;value)</span> </span>{</li><li>        data_[index] = value;</li><li>        <span class="hljs-comment">// 如果index位于可视区域内，先回调NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER删除老元素，</span></li><li>        <span class="hljs-comment">// 再回调NODE_ADAPTER_EVENT_ON_GET_NODE_ID和NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER事件。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_ReloadItem</span>(adapter_, index, <span class="hljs-number">1</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReloadAllItem</span><span class="hljs-params">()</span> </span>{</li><li>        std::<span class="hljs-built_in">reverse</span>(data_.<span class="hljs-built_in">begin</span>(), data_.<span class="hljs-built_in">end</span>());</li><li>        <span class="hljs-comment">// 全部重新加载场景下，会回调NODE_ADAPTER_EVENT_ON_GET_NODE_ID接口获取新的组件ID，</span></li><li>        <span class="hljs-comment">// 根据新的组件ID进行对比，ID不发生变化的进行复用，</span></li><li>        <span class="hljs-comment">// 针对新增ID的元素，调用NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER事件创建新的组件，</span></li><li>        <span class="hljs-comment">// 然后判断老数据中遗留的未使用ID，调用NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER删除老元素。</span></li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapter_ReloadAllItems</span>(adapter_);</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnStaticAdapterEvent</span><span class="hljs-params">(ArkUI_NodeAdapterEvent *event)</span> </span>{</li><li>        <span class="hljs-comment">// 获取实例对象，回调实例事件。</span></li><li>        <span class="hljs-keyword">auto</span> itemAdapter = <span class="hljs-built_in">reinterpret_cast</span>&lt;FlowItemAdapter *&gt;(<span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_GetUserData</span>(event));</li><li>        itemAdapter-&gt;<span class="hljs-built_in">OnAdapterEvent</span>(event);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnAdapterEvent</span><span class="hljs-params">(ArkUI_NodeAdapterEvent *event)</span> </span>{</li><li>        <span class="hljs-keyword">auto</span> type = <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_GetType</span>(event);</li><li>        <span class="hljs-keyword">switch</span> (type) {</li><li>        <span class="hljs-keyword">case</span> NODE_ADAPTER_EVENT_ON_GET_NODE_ID:</li><li>            <span class="hljs-built_in">OnGetChildId</span>(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER:</li><li>            <span class="hljs-built_in">OnCreateNewChild</span>(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER:</li><li>            <span class="hljs-built_in">OnDisposeChild</span>(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">default</span>:</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>    </li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnGetChildId</span><span class="hljs-params">(ArkUI_NodeAdapterEvent *event)</span> </span>{</li><li>        <span class="hljs-keyword">auto</span> index = <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span>(event);</li><li>        <span class="hljs-comment">// 设置生成组件的唯一标识符。</span></li><li>        <span class="hljs-keyword">auto</span> hash = std::<span class="hljs-built_in">hash</span>&lt;std::string&gt;();</li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_SetNodeId</span>(event, <span class="hljs-built_in">hash</span>(data_[index]));</li><li>    }</li><li>    </li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnCreateNewChild</span><span class="hljs-params">(ArkUI_NodeAdapterEvent *event)</span> </span>{</li><li>        <span class="hljs-keyword">auto</span> index = <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span>(event);</li><li>        ArkUI_NodeHandle flowItem = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-keyword">if</span> (!cachedItems_.<span class="hljs-built_in">empty</span>()) {</li><li>            <span class="hljs-comment">// 复用缓存</span></li><li>            flowItem = cachedItems_.<span class="hljs-built_in">top</span>();</li><li>            cachedItems_.<span class="hljs-built_in">pop</span>();</li><li>            <span class="hljs-comment">// 更新数据</span></li><li>            <span class="hljs-keyword">auto</span> *text = nodeApi_-&gt;<span class="hljs-built_in">getFirstChild</span>(flowItem);</li><li>            ArkUI_AttributeItem item{<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, data_[index].<span class="hljs-built_in">c_str</span>()};</li><li>            nodeApi_-&gt;<span class="hljs-built_in">setAttribute</span>(text, NODE_TEXT_CONTENT, &amp;item);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// 重新创建。</span></li><li>            <span class="hljs-keyword">auto</span> *text = nodeApi_-&gt;<span class="hljs-built_in">createNode</span>(ARKUI_NODE_TEXT);</li><li>            ArkUI_AttributeItem item{<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, data_[index].<span class="hljs-built_in">c_str</span>()};</li><li>            nodeApi_-&gt;<span class="hljs-built_in">setAttribute</span>(text, NODE_TEXT_CONTENT, &amp;item);</li><li>            flowItem = nodeApi_-&gt;<span class="hljs-built_in">createNode</span>(ARKUI_NODE_FLOW_ITEM);</li><li>            ArkUI_NumberValue value[] = {<span class="hljs-number">100</span>};</li><li>            ArkUI_AttributeItem height{value, <span class="hljs-number">1</span>};</li><li>            nodeApi_-&gt;<span class="hljs-built_in">setAttribute</span>(flowItem, NODE_HEIGHT, &amp;height);</li><li>            value[<span class="hljs-number">0</span>] = {<span class="hljs-number">1</span>};</li><li>            ArkUI_AttributeItem width{value, <span class="hljs-number">1</span>};</li><li>            nodeApi_-&gt;<span class="hljs-built_in">setAttribute</span>(flowItem, NODE_WIDTH_PERCENT, &amp;width);</li><li>            value[<span class="hljs-number">0</span>] = {.u32 = <span class="hljs-number">0xFFFF0000</span>};</li><li>            ArkUI_AttributeItem backgroundColor{value, <span class="hljs-number">1</span>};</li><li>
</li><li>            nodeApi_-&gt;<span class="hljs-built_in">setAttribute</span>(flowItem, NODE_BACKGROUND_COLOR, &amp;backgroundColor);</li><li>            nodeApi_-&gt;<span class="hljs-built_in">addChild</span>(flowItem, text);</li><li>        }</li><li>        <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_SetItem</span>(event, flowItem);</li><li>    }</li><li>    </li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnDisposeChild</span><span class="hljs-params">(ArkUI_NodeAdapterEvent *event)</span> </span>{</li><li>        <span class="hljs-keyword">auto</span> *node = <span class="hljs-built_in">OH_ArkUI_NodeAdapterEvent_GetRemovedNode</span>(event);</li><li>        <span class="hljs-comment">// 缓存节点</span></li><li>        cachedItems_.<span class="hljs-built_in">emplace</span>(node);</li><li>    }</li><li>
</li><li>    std::vector&lt;std::string&gt; data_;</li><li>    ArkUI_NativeNodeAPI_1 *nodeApi_ = <span class="hljs-literal">nullptr</span>;</li><li>    ArkUI_NodeAdapterHandle adapter_ = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// 管理回收复用组件池。</span></li><li>    std::stack&lt;ArkUI_NodeHandle&gt; cachedItems_;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">//MYAPPLICATION_FLOWITEMADAPTER_H</span></span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="创建分组">创建分组<i class="anchor-icon anchor-icon-link" anchorid="创建分组" tips="复制节点链接"></i></h2><p>使用WaterflowSection类管理waterflow中的分组，其中SectionOption用于描述一个分段的各项配置信息。在类的构造函数中创建ArkUI_WaterFlowSectionOption对象，在析构函数中将其销毁。</p> <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//WaterflowSection.h</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_WATERFLOWSECTION_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_WATERFLOWSECTION_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> NativeModule {</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SectionOption</span> {</li><li>    <span class="hljs-type">int32_t</span> itemsCount = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> crossCount;</li><li>    <span class="hljs-type">float</span> columnsGap;</li><li>    <span class="hljs-type">float</span> rowsGap;</li><li>    <span class="hljs-comment">// {上外边距，右外边距，下外边距，左外边距}</span></li><li>    ArkUI_Margin margin{<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};</li><li>    <span class="hljs-built_in">float</span> (*onGetItemMainSizeByIndex)(<span class="hljs-type">int32_t</span> itemIndex);</li><li>    <span class="hljs-type">void</span> *userData;</li><li>};</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">WaterflowSection</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">WaterflowSection</span>() : <span class="hljs-built_in">sectionOptions_</span>(<span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_Create</span>()){};</li><li>    </li><li>    ~<span class="hljs-built_in">WaterflowSection</span>(){</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_Dispose</span>(sectionOptions_);</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetSection</span><span class="hljs-params">(ArkUI_WaterFlowSectionOption *sectionOptions, <span class="hljs-type">int32_t</span> index, SectionOption section)</span> </span>{</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_SetItemCount</span>(sectionOptions, index, section.itemsCount);</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_SetCrossCount</span>(sectionOptions, index, section.crossCount);</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_SetColumnGap</span>(sectionOptions, index, section.columnsGap);</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_SetRowGap</span>(sectionOptions, index, section.rowsGap);</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_SetMargin</span>(sectionOptions, index, section.margin.top, section.margin.right,</li><li>                                                  section.margin.bottom, section.margin.left);</li><li>        <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_RegisterGetItemMainSizeCallbackByIndex</span>(sectionOptions, index,</li><li>                                                                               section.onGetItemMainSizeByIndex);</li><li>    }</li><li>    </li><li>    <span class="hljs-function">ArkUI_WaterFlowSectionOption *<span class="hljs-title">GetSectionOptions</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{</li><li>        <span class="hljs-keyword">return</span> sectionOptions_;</li><li>    }</li><li>    </li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PrintSectionOptions</span><span class="hljs-params">()</span> </span>{</li><li>        <span class="hljs-type">int32_t</span> sectionCnt = <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_GetSize</span>(sectionOptions_);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; sectionCnt; i++) {</li><li>            ArkUI_Margin margin = <span class="hljs-built_in">OH_ArkUI_WaterFlowSectionOption_GetMargin</span>(sectionOptions_, i);</li><li>            <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_DOMAIN, <span class="hljs-string">"CreateWaterflowExample"</span>,</li><li>                        <span class="hljs-string">"Section[%{public}d].margin:{%{public}f, %{public}f, %{public}f, %{public}f}"</span>, i, margin.top,</li><li>                        margin.right, margin.bottom, margin.left);</li><li>        }</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    ArkUI_WaterFlowSectionOption *sectionOptions_ = <span class="hljs-literal">nullptr</span>;</li><li>};</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_WATERFLOWSECTION_H</span></span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="创建瀑布流">创建瀑布流<i class="anchor-icon anchor-icon-link" anchorid="创建瀑布流" tips="复制节点链接"></i></h2><p>使用ArkUIWaterflowNode类管理Waterflow。支持通过SetLazyAdapter为其设置一个FlowItemAdapter，通过SetSection为其设置分段。</p> <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//waterflow.h</span></li><li>
</li><li>#<span class="hljs-variable">ifndef</span> <span class="hljs-variable">MYAPPLICATION_WATERFLOW_H</span></li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">MYAPPLICATION_WATERFLOW_H</span></li><li>
</li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"FlowItemAdapter.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"WaterflowSection.h"</span></li><li>
</li><li><span class="hljs-variable">namespace</span> <span class="hljs-variable">NativeModule</span> {</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ArkUIWaterflowNode</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>     </li><li>    <span class="hljs-title function_">ArkUIWaterflowNode</span>() {</li><li>        </li><li>        <span class="hljs-title function_">OH_ArkUI_GetModuleInterface</span>(<span class="hljs-variable">ARKUI_NATIVE_NODE</span>, <span class="hljs-variable">ArkUI_NativeNodeAPI_1</span>, <span class="hljs-variable">nodeApi_</span>);</li><li>        <span class="hljs-comment">// 创建Waterflow</span></li><li>        <span class="hljs-variable">waterflow_</span> = <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">createNode</span>(<span class="hljs-title class_">ARKUI_NODE_WATER_FLOW</span>);</li><li>        </li><li>    }</li><li>
</li><li>    ~<span class="hljs-title function_">ArkUIWaterflowNode</span>() {</li><li>        <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">disposeNode</span>(<span class="hljs-title class_">waterflow_</span>);</li><li>
</li><li>        <span class="hljs-comment">// 销毁adapter</span></li><li>        <span class="hljs-variable">adapter_</span>.<span class="hljs-title function_">reset</span>();</li><li>        </li><li>        <span class="hljs-comment">// 销毁分段</span></li><li>        <span class="hljs-variable">section_</span>.<span class="hljs-title function_">reset</span>();</li><li>    }</li><li>    </li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">SetWidth</span>(<span class="hljs-variable">float</span> <span class="hljs-variable">width</span>) {</li><li>        <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">value</span>[] = {{.<span class="hljs-variable">f32</span> = <span class="hljs-variable">width</span>}};</li><li>        <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item</span> = {<span class="hljs-variable">value</span>, <span class="hljs-number">1</span>};</li><li>        <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">waterflow_</span>, <span class="hljs-title class_">NODE_WIDTH</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    }</li><li>    </li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">SetHeight</span>(<span class="hljs-variable">float</span> <span class="hljs-variable">height</span>) {</li><li>        <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">value</span>[] = {{.<span class="hljs-variable">f32</span> = <span class="hljs-variable">height</span>}};</li><li>        <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item</span> = {<span class="hljs-variable">value</span>, <span class="hljs-number">1</span>};</li><li>        <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">waterflow_</span>, <span class="hljs-title class_">NODE_HEIGHT</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    }</li><li>    </li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">SetLazyAdapter</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">FlowItemAdapter</span>&gt; &amp;<span class="hljs-title class_">adapter</span>) {</li><li>        <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item</span>{<span class="hljs-variable">nullptr</span>,<span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">adapter</span>-&gt;<span class="hljs-title class_">GetAdapter</span>()};</li><li>        <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">waterflow_</span>, <span class="hljs-title class_">NODE_WATER_FLOW_NODE_ADAPTER</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>        <span class="hljs-variable">adapter_</span> = <span class="hljs-variable">adapter</span>;</li><li>    }</li><li>    </li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">SetSection</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">WaterflowSection</span>&gt; &amp;<span class="hljs-title class_">section</span>) {</li><li>        <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">start</span>[] = {{.<span class="hljs-variable">i32</span> = <span class="hljs-number">0</span>}};</li><li>        <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">optionsItem</span> = {<span class="hljs-variable">start</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">section</span>-&gt;<span class="hljs-title class_">GetSectionOptions</span>()};</li><li>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">section</span>-&gt;<span class="hljs-title class_">GetSectionOptions</span>()){</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable">nodeApi_</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">waterflow_</span>, <span class="hljs-title class_">NODE_WATER_FLOW_SECTION_OPTION</span>, &amp;<span class="hljs-title class_">optionsItem</span>);</li><li>        <span class="hljs-variable">section_</span> = <span class="hljs-variable">section</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-title function_">GetWaterflow</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable">waterflow_</span>; }</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">WaterflowSection</span>&gt; <span class="hljs-title class_">GetWaterflowSection</span>() { <span class="hljs-keyword">return</span> <span class="hljs-variable">section_</span>; }</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">ArkUI_NativeNodeAPI_1</span> *<span class="hljs-variable">nodeApi_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">waterflow_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    </li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">WaterflowSection</span>&gt; <span class="hljs-title class_">section_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    </li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">FlowItemAdapter</span>&gt; <span class="hljs-title class_">adapter_</span>;</li><li>};</li><li>}<span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li>#<span class="hljs-variable">endif</span> <span class="hljs-comment">// MYAPPLICATION_WATERFLOW_H</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="使用瀑布流-1">使用瀑布流<i class="anchor-icon anchor-icon-link" anchorid="使用瀑布流-1" tips="复制节点链接"></i></h2><p>创建一个ArkUIWaterflowNode类的实例，设置其宽高，并绑定NodeAdapter和分段。</p> <div _ngcontent-ais-c106="" class="highlight-div"><div _ngcontent-ais-c106="" class="highlight-div-header"><div _ngcontent-ais-c106="" class="highlight-div-header-left"><div _ngcontent-ais-c106="" class="handle-button expand-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ais-c106="" class="highlight-div-header-right"><div _ngcontent-ais-c106="" class="handle-button ai-button"></div><div _ngcontent-ais-c106="" class="handle-button line-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ais-c106="" class="handle-button theme-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ais-c106="" class="handle-button copy-button"><div _ngcontent-ais-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ais-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// CreateWaterflowExample.h</span></li><li>
</li><li>#<span class="hljs-variable">ifndef</span> <span class="hljs-variable">MYAPPLICATION_CREATEWATERFLOWEXAMPLE_H</span></li><li>#<span class="hljs-variable">define</span> <span class="hljs-variable">MYAPPLICATION_CREATEWATERFLOWEXAMPLE_H</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"waterflow.h"</span></li><li>
</li><li><span class="hljs-variable">namespace</span> <span class="hljs-variable">NativeModule</span> {</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">ArkUIWaterflowNode</span>&gt; <span class="hljs-title class_">CreateWaterflowExample</span>() {</li><li>    <span class="hljs-comment">// 创建Waterflow组件。</span></li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">waterflow</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">ArkUIWaterflowNode</span>&gt;();</li><li>    <span class="hljs-variable">waterflow</span>-&gt;<span class="hljs-title class_">SetHeight</span>(<span class="hljs-number">600</span>);</li><li>    <span class="hljs-variable">waterflow</span>-&gt;<span class="hljs-title class_">SetWidth</span>(<span class="hljs-number">400</span>);</li><li>    </li><li>    <span class="hljs-comment">// 绑定Adapter</span></li><li>    <span class="hljs-variable">waterflow</span>-&gt;<span class="hljs-title class_">SetLazyAdapter</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">FlowItemAdapter</span>&gt;());</li><li>    </li><li>    <span class="hljs-comment">// 设置分段</span></li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">sections</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">WaterflowSection</span>&gt;();</li><li>    <span class="hljs-variable">SectionOption</span> <span class="hljs-variable">MARGIN_GAP_SECTION_1</span> = {<span class="hljs-number">10</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, {<span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>}, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">SectionOption</span> <span class="hljs-variable">MARGIN_GAP_SECTION_2</span> = {<span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, {<span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>}, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-variable">sections</span>-&gt;<span class="hljs-title class_">SetSection</span>(<span class="hljs-variable">sections</span>-&gt;<span class="hljs-title class_">GetSectionOptions</span>(), <span class="hljs-title class_">i</span>, <span class="hljs-variable">i</span> % <span class="hljs-number">2</span> ? <span class="hljs-variable">MARGIN_GAP_SECTION_1</span> : <span class="hljs-title class_">MARGIN_GAP_SECTION_2</span>);</li><li>    }</li><li>    <span class="hljs-variable">waterflow</span>-&gt;<span class="hljs-title class_">SetSection</span>(<span class="hljs-title class_">sections</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">waterflow</span>;</li><li>}</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li>#<span class="hljs-variable">endif</span> <span class="hljs-comment">// MYAPPLICATION_CREATEWATERFLOWEXAMPLE_H</span></li></ol></pre></div></div> </div> </div> <div></div></div>