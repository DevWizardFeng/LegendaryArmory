<h1 _ngcontent-ivn-c119="" class="doc-title ng-star-inserted" title="使用硬件熵源生成安全随机数(C/C++)"> 使用硬件熵源生成安全随机数(C/C++) </h1>

<div _ngcontent-ivn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 21开始，可以选择使用硬件熵源生成安全随机数。</p>    <p>随机数主要用于临时会话密钥生成和非对称加密算法密钥生成等场景。在加解密场景中，安全随机数生成器需要具备随机性、不可预测性和不可重现性。</p>    <p>使用更安全的熵源，对随机数而言，就意味着 “结果难以被猜测或复现”，是 “真随机性” 的量化体现。</p>    <p>当前硬件熵源的实现是通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-overview">HUKS</a>的相关接口完成的。</p>    <p>开发者可以调用接口，完成以下具体功能：</p>    <ul>     <li>      <p>生成指定长度的安全随机数，并将其用于生成对应的密钥。</p></li>     <li>      <p>开启硬件熵源。</p></li>     <li>      <p>指定随机种子，生成一系列的随机序列。</p></li>    </ul>    <p>在开发前，开发者应该先对加解密基础知识有一定了解，并熟知以下随机数相关的基本概念：</p>    <ul>     <li>      <p><strong>内部状态</strong></p>      <p>代表随机数生成器内存中的数值，当内部状态相同时，随机数生成器会生成固定的随机数序列。</p></li>     <li>      <p><strong>随机种子</strong></p>      <p>一个用来对伪随机数的内部状态进行初始化的数据，随机数生成器通过种子来生成一系列的随机序列。</p>      <p>当前OpenSSL实现方式，随机数生成器内部状态是不断变化的，即使设置相同的种子，生成的随机数序列也不会相同。</p></li>    </ul>    <div class="tiledSection">     <h2 id="支持的算法与规格">支持的算法与规格<i class="anchor-icon anchor-icon-link" anchorid="支持的算法与规格" tips="复制节点链接"></i></h2>          <p>安全随机数生成，设置硬件熵源之后，使用OpenSSL的RAND_priv_bytes接口生成。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.3.1.1" valign="top" width="50%">算法</th>         <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.3.1.2" valign="top" width="50%">长度（Byte）</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">CTR_DRBG</td>         <td class="cellrowborder" valign="top" width="50%">[1, INT_MAX]</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-rand-h#oh_cryptorand_create" target="_blank">OH_CryptoRand_Create</a>，创建随机数生成器。</p></li>      <li>       <p>调用OH_CryptoRand_EnableHardwareEntropy，开启硬件熵源。</p></li>      <li>       <p>（可选）调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-rand-h#oh_cryptorand_setseed" target="_blank">OH_CryptoRand_SetSeed</a>，为随机数生成器设置种子。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-rand-h#oh_cryptorand_generaterandom" target="_blank">OH_CryptoRand_GenerateRandom</a>，生成指定长度的安全随机数。指定字节长度范围为1~INT_MAX。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-rand-h#oh_cryptorand_getalgoname" target="_blank">OH_CryptoRand_GetAlgoName</a>，获取随机数生成器使用的算法名称。</p></li>     </ol>     <div _ngcontent-ivn-c106="" class="highlight-div"><div _ngcontent-ivn-c106="" class="highlight-div-header"><div _ngcontent-ivn-c106="" class="highlight-div-header-left"><div _ngcontent-ivn-c106="" class="handle-button expand-button"><div _ngcontent-ivn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ivn-c106="" class="highlight-div-header-right"><div _ngcontent-ivn-c106="" class="handle-button ai-button"></div><div _ngcontent-ivn-c106="" class="handle-button line-button"><div _ngcontent-ivn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ivn-c106="" class="handle-button theme-button"><div _ngcontent-ivn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ivn-c106="" class="handle-button copy-button"><div _ngcontent-ivn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ivn-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestRandomNumber</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建随机数生成器。</span></li><li>    OH_CryptoRand *rand = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoRand_Create</span>(&amp;rand);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 开启硬件熵源。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoRand_EnableHardwareEntropy</span>(rand);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoRand_Destroy</span>(rand);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置随机种子（可选）。</span></li><li>    <span class="hljs-type">uint8_t</span> seedData[<span class="hljs-number">12</span>] = {<span class="hljs-number">0x25</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x22</span>};</li><li>    Crypto_DataBlob seed = {</li><li>        .data = seedData,</li><li>        .len = <span class="hljs-built_in">sizeof</span>(seedData)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoRand_SetSeed</span>(rand, &amp;seed);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoRand_Destroy</span>(rand);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 生成指定长度的随机数。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-type">uint32_t</span> randomLength = <span class="hljs-number">24</span>; <span class="hljs-comment">// 生成24字节的随机数。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoRand_GenerateRandom</span>(rand, randomLength, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoRand_Destroy</span>(rand);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取并打印随机数生成器的算法名称。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *algoName = <span class="hljs-built_in">OH_CryptoRand_GetAlgoName</span>(rand);</li><li>    <span class="hljs-keyword">if</span> (algoName != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Random number generator algorithm: %s\n"</span>, algoName);</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Generated random number length: %u\n"</span>, out.len);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoRand_Destroy</span>(rand);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>