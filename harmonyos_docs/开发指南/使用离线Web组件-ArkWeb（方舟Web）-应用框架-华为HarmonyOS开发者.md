<h1 _ngcontent-chc-c119="" class="doc-title ng-star-inserted" title="使用离线Web组件"> 使用离线Web组件 </h1>

<div _ngcontent-chc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Web组件能够实现在不同窗口的组件树上进行挂载或移除操作，这一能力使得开发者可以预先创建Web组件，从而实现性能优化。例如，Tab页为Web组件时，页面预先渲染，便于即时显示。</p>    <p>离线Web组件基于自定义占位组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>实现。基本原理是构建支持命令式创建的Web组件，此类组件创建后不会立即挂载到组件树中，状态为Hidden和Inactive，因此不会立即对用户呈现。开发者可以在后续使用中按需动态挂载这些组件，以实现更灵活的使用方式。</p>    <p>使用离线Web组件可以预启动渲染进程和预渲染Web页面。</p>    <ul>     <li>预启动渲染进程：在未进入Web页面时，提前创建空Web组件，启动Web的渲染进程，为后续使用做好准备。</li>     <li>预渲染Web页面：在Web页面启动或跳转的场景下，预先在后台创建Web组件，加载数据并完成渲染，从而在Web页面启动或跳转时实现快速显示。</li>    </ul>    <div class="tiledSection">     <h2 id="整体架构">整体架构<i class="anchor-icon anchor-icon-link" anchorid="整体架构" tips="复制节点链接"></i></h2>          <p>如下图所示，在需要离屏创建Web组件时，定义一个自定义组件以封装Web组件，此Web组件在离线状态下被创建，封装于无状态的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>节点中，并与相应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>组件绑定。Web组件在后台预渲染完毕后，当需要展示时，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>将其挂载到ViewTree的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>中，即与对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>组件绑定，即可挂载上树并显示。</p>     <p><span><img originheight="501" originwidth="775" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114718.77105268724039305877782512232292:50001231000000:2800:C702B8A6A22A274753CDF54595EB42E35151669E839E4E102DE26FED1099CD20.png" width="775" height="501"></span></p>    </div>    <div class="tiledSection">     <h2 id="创建离线web组件">创建离线Web组件<i class="anchor-icon anchor-icon-link" anchorid="创建离线web组件" tips="复制节点链接"></i></h2>          <p>本示例展示了如何预先创建离线Web组件，并在需要的时候进行挂载和显示。在后续内容中，预启动渲染进程和预渲染Web页面作为性能优化措施，均利用离线Web组件实现。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>创建Web组件将占用内存（每个Web组件大约200MB）和计算资源，建议避免一次性创建大量离线Web组件，以减少资源消耗。</p>      </div></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 载体Ability</span></li><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { createNWeb } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/common'</span></li><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>(); <span class="hljs-comment">// Obtain the main window of the application.</span></li><li>    <span class="hljs-keyword">if</span> (!windowClass) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'windowClass is null'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建Web动态组件（需传入UIContext），loadContent之后的任意时机均可创建</span></li><li>    <span class="hljs-title function_">createNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>, windowClass.<span class="hljs-title function_">getUIContext</span>());</li><li>    <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建NodeController</span></li><li><span class="hljs-comment">// common.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">Size</span>, <span class="hljs-title class_">FrameNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-comment">// @Builder中为动态组件的具体组件内容</span></li><li><span class="hljs-comment">// Data为入参封装类</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>{</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-title class_">ResourceStr</span> = <span class="hljs-string">"https://www.example.com"</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> wrap = wrapBuilder&lt;<span class="hljs-title class_">Data</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li>
</li><li><span class="hljs-comment">// myNodeController需要与NodeContainer一起使用，用于控制和反馈对应的NodeContainer上的节点的行为</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">myNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Data</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-comment">// 必须要重写的方法，用于构建节点树、返回节点挂载在对应NodeContainer中</span></li><li>  <span class="hljs-comment">// 在对应NodeContainer创建的时候调用、或者通过rebuild方法调用刷新</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">" uiContext is undefined : "</span>+ (uiContext === <span class="hljs-literal">undefined</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 返回FrameNode节点</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 返回null控制动态组件脱离绑定节点</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当布局大小发生变化时进行回调</span></li><li>  <span class="hljs-title function_">aboutToResize</span>(<span class="hljs-params">size: Size</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToResize width : "</span> + size.<span class="hljs-property">width</span>  +  <span class="hljs-string">" height : "</span> + size.<span class="hljs-property">height</span> );</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Appear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Disappear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToDisappear"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 此函数为自定义函数，可作为初始化函数使用</span></li><li>  <span class="hljs-comment">// 通过UIContext初始化BuilderNode，再通过BuilderNode中的build接口初始化@Builder中的内容</span></li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url:ResourceStr, uiContext:UIContext, control:webview.WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>)</li><li>    {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建节点，需要uiContext</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-comment">// 创建动态Web组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(wrap, { <span class="hljs-attr">url</span>:url, <span class="hljs-attr">controller</span>:control });</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 创建Map保存所需要的NodeController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">NodeMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">ResourceStr</span>, myNodeController | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 创建Map保存所需要的WebViewController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">controllerMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">ResourceStr</span>, webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li><span class="hljs-comment">// 初始化需要UIContext，需在Ability获取</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNWeb</span> = (<span class="hljs-params">url: ResourceStr, uiContext: UIContext</span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建NodeController</span></li><li>  <span class="hljs-keyword">let</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title function_">myNodeController</span>();</li><li>  <span class="hljs-keyword">let</span> controller = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>() ;</li><li>  <span class="hljs-comment">// 初始化自定义Web组件</span></li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(url, uiContext, controller);</li><li>  controllerMap.<span class="hljs-title function_">set</span>(url, controller)</li><li>  <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">set</span>(url, baseNode);</li><li>}</li><li><span class="hljs-comment">// 自定义获取NodeController接口</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getNWeb = (<span class="hljs-attr">url</span>: <span class="hljs-title class_">ResourceStr</span>) : myNodeController | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">get</span>(url);</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用NodeController的Page页</span></li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { getNWeb } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">// NodeContainer用于与NodeController节点绑定，rebuild会触发makeNode</span></li><li>        <span class="hljs-comment">// Page页通过NodeContainer接口绑定NodeController，实现动态组件页面显示</span></li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title function_">getNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">"90%"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="预启动渲染进程">预启动渲染进程<i class="anchor-icon anchor-icon-link" anchorid="预启动渲染进程" tips="复制节点链接"></i></h2>          <p>在后台预先创建一个Web组件，以启动用于渲染的Web渲染进程，这样可以节省后续Web组件加载时启动Web渲染进程所需的时间。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>仅在采用单渲染进程模式的应用中，即全局共享一个Web渲染进程时，优化效果显著。Web渲染进程仅在所有Web组件都被销毁后才会终止。因此，建议应用至少保持一个Web组件处于活动状态。</p>       <p>创建额外的Web组件会产生内存开销。</p>      </div></div></div>     <p>示例在onWindowStageCreate时预创建Web组件加载blank页面，提前启动Render进程，从index跳转到index2时，优化了Web渲染进程启动和初始化的耗时。</p>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 载体Ability</span></li><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { createNWeb } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/common'</span></li><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>(); <span class="hljs-comment">// Obtain the main window of the application.</span></li><li>    <span class="hljs-keyword">if</span> (!windowClass) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'windowClass is null'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建空的Web动态组件（需传入UIContext），loadContent之后的任意时机均可创建</span></li><li>    <span class="hljs-title function_">createNWeb</span>(<span class="hljs-string">"about:blank"</span>, windowClass.<span class="hljs-title function_">getUIContext</span>());</li><li>    <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建NodeController</span></li><li><span class="hljs-comment">// common.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">Size</span>, <span class="hljs-title class_">FrameNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-comment">// @Builder中为动态组件的具体组件内容</span></li><li><span class="hljs-comment">// Data为入参封装类</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>{</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-title class_">ResourceStr</span> = <span class="hljs-string">"https://www.example.com"</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> wrap = wrapBuilder&lt;<span class="hljs-title class_">Data</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li>
</li><li><span class="hljs-comment">// myNodeController需要与NodeContainer一起使用，用于控制和反馈对应的NodeContainer上的节点的行为</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">myNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Data</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-comment">// 必须要重写的方法，用于构建节点树、返回节点挂载在对应NodeContainer中</span></li><li>  <span class="hljs-comment">// 在对应NodeContainer创建的时候调用、或者通过rebuild方法调用刷新</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">" uiContext is undefined : "</span>+ (uiContext === <span class="hljs-literal">undefined</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 返回FrameNode节点</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 返回null控制动态组件脱离绑定节点</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当布局大小发生变化时进行回调</span></li><li>  <span class="hljs-title function_">aboutToResize</span>(<span class="hljs-params">size: Size</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToResize width : "</span> + size.<span class="hljs-property">width</span>  +  <span class="hljs-string">" height : "</span> + size.<span class="hljs-property">height</span> );</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Appear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Disappear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToDisappear"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 此函数为自定义函数，可作为初始化函数使用</span></li><li>  <span class="hljs-comment">// 通过UIContext初始化BuilderNode，再通过BuilderNode中的build接口初始化@Builder中的内容</span></li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url:ResourceStr, uiContext:UIContext, control:webview.WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>)</li><li>    {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建节点，需要uiContext</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-comment">// 创建动态Web组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(wrap, { <span class="hljs-attr">url</span>:url, <span class="hljs-attr">controller</span>:control });</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 创建Map保存所需要的NodeController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">NodeMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">ResourceStr</span>, myNodeController | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 创建Map保存所需要的WebViewController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">controllerMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">ResourceStr</span>, webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li><span class="hljs-comment">// 初始化需要UIContext 需在Ability获取</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNWeb</span> = (<span class="hljs-params">url: ResourceStr, uiContext: UIContext</span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建NodeController</span></li><li>  <span class="hljs-keyword">let</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title function_">myNodeController</span>();</li><li>  <span class="hljs-keyword">let</span> controller = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-comment">// 初始化自定义Web组件</span></li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(url, uiContext, controller);</li><li>  controllerMap.<span class="hljs-title function_">set</span>(url, controller)</li><li>  <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">set</span>(url, baseNode);</li><li>}</li><li><span class="hljs-comment">// 自定义获取NodeController接口</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getNWeb = (<span class="hljs-attr">url</span>: <span class="hljs-title class_">ResourceStr</span>) : myNodeController | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">get</span>(url);</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index1</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  </li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//已经预启动Render进程</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"跳转到Web页面"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">pushUrl</span>({<span class="hljs-attr">url</span>: <span class="hljs-string">"pages/index2"</span>});</li><li>      })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index2.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct index2 {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  </li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Web</span>({<span class="hljs-attr">src</span>: <span class="hljs-string">'https://www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>})</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="预渲染web页面">预渲染Web页面<i class="anchor-icon anchor-icon-link" anchorid="预渲染web页面" tips="复制节点链接"></i></h2>          <p>预渲染Web页面优化方案适用于Web页面启动和跳转场景，例如，进入首页后，跳转到其他子页。建议在高命中率的页面使用该方案。</p>     <p>预渲染Web页面的实现是提前创建离线Web组件，设置Web为Active状态来开启渲染引擎，进行后台渲染。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>预渲染Web页面时，需要明确加载的资源。</li>        <li>由于该方案会将不可见的后台Web设置为Active状态，建议不要预渲染包含自动播放音视频的页面。应用开发者请自行检查和管理页面行为。</li>        <li>预渲染的网页会在后台不断进行渲染，建议在预渲染完成后立即停止渲染，以防止发热和功耗问题。可以参考以下示例，使用 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onfirstmeaningfulpaint12" target="_blank">onFirstMeaningfulPaint</a> 来确定停止时机，该接口适用于http和https网页。</li>       </ol>      </div></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 载体Ability</span></li><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> {createNWeb} <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/common'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>(); <span class="hljs-comment">// Obtain the main window of the application.</span></li><li>      <span class="hljs-keyword">if</span> (!windowClass) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'windowClass is null'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 创建ArkWeb动态组件（需传入UIContext），loadContent之后的任意时机均可创建</span></li><li>      <span class="hljs-title function_">createNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>, windowClass.<span class="hljs-title function_">getUIContext</span>());</li><li>      <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建NodeController</span></li><li><span class="hljs-comment">// common.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">Size</span>, <span class="hljs-title class_">FrameNode</span> }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// @Builder中为动态组件的具体组件内容</span></li><li><span class="hljs-comment">// Data为入参封装类</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>{</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'https://www.example.com'</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>}</li><li><span class="hljs-comment">// 通过布尔变量shouldInactive控制网页在后台完成预渲染后停止渲染</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">shouldInactive</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>      .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 调用onActive，开启渲染</span></li><li>        data.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onActive</span>();</li><li>      })</li><li>      .<span class="hljs-title function_">onFirstMeaningfulPaint</span>(<span class="hljs-function">() =&gt;</span>{</li><li>        <span class="hljs-keyword">if</span> (!shouldInactive) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 在预渲染完成时触发，停止渲染</span></li><li>        data.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onInactive</span>();</li><li>        shouldInactive = <span class="hljs-literal">false</span>;</li><li>      })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>  }</li><li>}</li><li><span class="hljs-keyword">let</span> wrap = wrapBuilder&lt;<span class="hljs-title class_">Data</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li><span class="hljs-comment">// myNodeController需要与NodeContainer一起使用，用于控制和反馈对应的NodeContainer上的节点的行为</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">myNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Data</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-comment">// 必须要重写的方法，用于构建节点树、返回节点挂载在对应NodeContainer中</span></li><li>  <span class="hljs-comment">// 在对应NodeContainer创建的时候调用、或者通过rebuild方法调用刷新</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">" uiContext is undefined : "</span>+ (uiContext === <span class="hljs-literal">undefined</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 返回FrameNode节点</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 返回null控制动态组件脱离绑定节点</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当布局大小发生变化时进行回调</span></li><li>  <span class="hljs-title function_">aboutToResize</span>(<span class="hljs-params">size: Size</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToResize width : "</span> + size.<span class="hljs-property">width</span>  +  <span class="hljs-string">" height : "</span> + size.<span class="hljs-property">height</span> )</li><li>  }</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Appear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-comment">// 切换到前台后，不需要停止渲染</span></li><li>    shouldInactive = <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Disappear的时候进行回调</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToDisappear"</span>)</li><li>  }</li><li>  <span class="hljs-comment">// 此函数为自定义函数，可作为初始化函数使用</span></li><li>  <span class="hljs-comment">// 通过UIContext初始化BuilderNode，再通过BuilderNode中的build接口初始化@Builder中的内容</span></li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url:<span class="hljs-built_in">string</span>, uiContext:UIContext, control:webview.WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>)</li><li>    {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建节点，需要uiContext</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext)</li><li>    <span class="hljs-comment">// 创建动态Web组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(wrap, { <span class="hljs-attr">url</span>:url, <span class="hljs-attr">controller</span>:control })</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 创建Map保存所需要的NodeController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">NodeMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, myNodeController | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 创建Map保存所需要的WebViewController</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">controllerMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, webview.<span class="hljs-property">WebviewController</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 初始化需要UIContext 需在Ability获取</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNWeb</span> = (<span class="hljs-params">url: <span class="hljs-built_in">string</span>, uiContext: UIContext</span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建NodeController</span></li><li>  <span class="hljs-keyword">let</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title function_">myNodeController</span>();</li><li>  <span class="hljs-keyword">let</span> controller = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>() ;</li><li>  <span class="hljs-comment">// 初始化自定义Web组件</span></li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(url, uiContext, controller);</li><li>  controllerMap.<span class="hljs-title function_">set</span>(url, controller)</li><li>  <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">set</span>(url, baseNode);</li><li>}</li><li><span class="hljs-comment">// 自定义获取NodeController接口</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getNWeb = (url : <span class="hljs-built_in">string</span>) : myNodeController | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">get</span>(url);</li><li>}</li></ol></pre></div></div>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用NodeController的Page页</span></li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> {createNWeb, getNWeb} <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">// NodeContainer用于与NodeController节点绑定，rebuild会触发makeNode</span></li><li>        <span class="hljs-comment">// Page页通过NodeContainer接口绑定NodeController，实现动态组件页面显示</span></li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title function_">getNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">"90%"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="常见白屏问题排查">常见白屏问题排查<i class="anchor-icon anchor-icon-link" anchorid="常见白屏问题排查" tips="复制节点链接"></i></h2>          <p>1.排查应用上网权限配置。</p>     <p>检查是否已在module.json5中添加网络权限，添加方法请参考在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions#在配置文件中声明权限">在配置文件中声明权限</a>。</p>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>:[</li><li>    {</li><li>      <span class="hljs-string">"name"</span> : <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>    }</li><li>  ]</li></ol></pre></div></div>     <p>2.排查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>与节点绑定的逻辑。</p>     <p>检查节点是否已上组件树，建议在已有的Web组件上方加上Text（请参考以下例子），如果白屏的时候没有出现Text，建议检查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>与节点绑定的情况。</p>     <div _ngcontent-chc-c106="" class="highlight-div"><div _ngcontent-chc-c106="" class="highlight-div-header"><div _ngcontent-chc-c106="" class="highlight-div-header-left"><div _ngcontent-chc-c106="" class="handle-button expand-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-chc-c106="" class="highlight-div-header-right"><div _ngcontent-chc-c106="" class="handle-button ai-button"></div><div _ngcontent-chc-c106="" class="handle-button line-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-chc-c106="" class="handle-button theme-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-chc-c106="" class="handle-button copy-button"><div _ngcontent-chc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-chc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'test'</span>)</li><li>    <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>3.排查Web可见性状态。</p>     <p>如果整个节点已上树，可通过日志<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-component-visible-area-change-event#onvisibleareachange" target="_blank">WebPattern::OnVisibleAreaChange</a>查看Web组件可见性状态是否正确，不可见的Web组件可能会造成白屏。</p>    </div>   </div>   <div></div></div>