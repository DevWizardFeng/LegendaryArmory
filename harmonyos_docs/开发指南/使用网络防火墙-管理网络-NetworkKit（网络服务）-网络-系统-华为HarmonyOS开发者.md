<h1 _ngcontent-ycy-c119="" class="doc-title ng-star-inserted" title="使用网络防火墙"> 使用网络防火墙 </h1>

<div _ngcontent-ycy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>网络防火墙提供如下功能：</p>     <ul>      <li>防火墙的基础能力，包括防火墙的使能、规则的启用与禁用、审计能力。</li>      <li>防火墙规则的配置能力，包括规则的名称、描述、操作、生效应用、协议类型、地址、端口、出站/入站方向等。</li>      <li>DNS策略的配置能力，包括配置禁止/允许解析的域名、解析使用的DNS服务器（主选/备选）（应用级）。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>为了保证应用的运行效率，所有API调用都是异步的，对于异步调用的API均提供了Promise的方式，以下示例均采用Promise方式，更多方式可以查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-netfirewall" target="_blank">API参考</a>。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>防火墙的典型场景有：</p>     <ul>      <li>针对特定IP联网访问控制</li>     </ul>     <ol>      <li>支持限制特定应用访问网络。</li>      <li>支持限制对特定IP、特定协议、特定端口的网络通信。</li>      <li>支持限制特定应用对特定IP、特定协议、特定端口的网络通信。</li>      <li>支持拦截规则下发后立即生效（此点针对TCP协议：需断开已有被拦截的TCP连接）。</li>     </ol>     <ul>      <li>针对域名联网访问控制支持拦截</li>     </ul>     <ol>      <li>支持限制应用对特定域名的DNS解析能力（仅限制非加密标准DNS协议，不限制加密、私有DNS协议）。</li>      <li>支持限制特定应用对特定域名的DNS解析能力（仅限制非加密标准DNS协议，不限制加密、私有DNS协议）。</li>      <li>支持拦截规则下发后立即生效（此点针对TCP协议：需断开已有被拦截的TCP连接）。</li>     </ol>     <p>以下分别介绍具体开发方式。</p>    </div>    <div class="tiledSection">     <h2 id="针对特定ip联网访问控制">针对特定IP联网访问控制<i class="anchor-icon anchor-icon-link" anchorid="针对特定ip联网访问控制" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>设备通过硬件接口，插入网线。</p></li>      <li>       <p>从@kit.NetworkKit中导入netfirewall命名空间。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 从@kit.NetworkKit中导入netFirewall命名空间。</span></li><li><span class="hljs-keyword">import</span> { netFirewall } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>用户调用setNetFirewallPolicy方法，打开防火墙。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IpType</span>{</li><li>      <span class="hljs-attr">family</span>:<span class="hljs-built_in">number</span>;</li><li>      <span class="hljs-attr">type</span>:<span class="hljs-built_in">number</span>;</li><li>      address?:<span class="hljs-built_in">string</span>;</li><li>      mask?:<span class="hljs-built_in">number</span>;</li><li>      startIp?:<span class="hljs-built_in">string</span>;</li><li>      endIp?:<span class="hljs-built_in">string</span>;</li><li>}</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IpPort</span>{</li><li>    <span class="hljs-attr">startPort</span>:<span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-attr">endPort</span>:<span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义防火墙策略：打开，入站阻止，出站允许。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">policy</span>: netFirewall.<span class="hljs-property">NetFirewallPolicy</span> = {</li><li>  <span class="hljs-attr">isOpen</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">inAction</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_DENY</span>,</li><li>  <span class="hljs-attr">outAction</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_ALLOW</span></li><li>};</li><li><span class="hljs-comment">// 给用户100设置防火墙策略。</span></li><li>netFirewall.<span class="hljs-title function_">setNetFirewallPolicy</span>(<span class="hljs-number">100</span>, policy).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set firewall policy success."</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"set firewall policy failed: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>用户通过addNetFirewallRule方法，添加防火墙规则。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化具体的防火墙ip类型规则。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">ipRule</span>: netFirewall.<span class="hljs-property">NetFirewallRule</span> = {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">"rule1"</span>,</li><li>  <span class="hljs-attr">description</span>: <span class="hljs-string">"rule1 description"</span>,</li><li>  <span class="hljs-attr">direction</span>: netFirewall.<span class="hljs-property">NetFirewallRuleDirection</span>.<span class="hljs-property">RULE_IN</span>,</li><li>  <span class="hljs-attr">action</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_DENY</span>,</li><li>  <span class="hljs-attr">type</span>: netFirewall.<span class="hljs-property">NetFirewallRuleType</span>.<span class="hljs-property">RULE_IP</span>,</li><li>  <span class="hljs-attr">isEnabled</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">appUid</span>: <span class="hljs-number">20001</span>,</li><li>  <span class="hljs-attr">localIps</span>: [</li><li>    {</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">address</span>: <span class="hljs-string">"10.10.1.1"</span>,</li><li>      <span class="hljs-attr">mask</span>: <span class="hljs-number">24</span></li><li>    },{</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-number">2</span>,</li><li>      <span class="hljs-attr">startIp</span>: <span class="hljs-string">"10.20.1.1"</span>,</li><li>      <span class="hljs-attr">endIp</span>: <span class="hljs-string">"10.20.1.10"</span></li><li>    }] <span class="hljs-keyword">as</span> <span class="hljs-title class_">IpType</span>[],</li><li>  <span class="hljs-attr">remoteIps</span>:[</li><li>    {</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">address</span>: <span class="hljs-string">"20.10.1.1"</span>,</li><li>      <span class="hljs-attr">mask</span>: <span class="hljs-number">24</span></li><li>    },{</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-number">2</span>,</li><li>      <span class="hljs-attr">startIp</span>: <span class="hljs-string">"20.20.1.1"</span>,</li><li>      <span class="hljs-attr">endIp</span>: <span class="hljs-string">"20.20.1.10"</span></li><li>    }] <span class="hljs-keyword">as</span> <span class="hljs-title class_">IpType</span>[],</li><li>  <span class="hljs-attr">protocol</span>: <span class="hljs-number">6</span>,</li><li>  <span class="hljs-attr">localPorts</span>: [</li><li>    {</li><li>      <span class="hljs-attr">startPort</span>: <span class="hljs-number">1000</span>,</li><li>      <span class="hljs-attr">endPort</span>: <span class="hljs-number">1000</span></li><li>    },{</li><li>      <span class="hljs-attr">startPort</span>: <span class="hljs-number">2000</span>,</li><li>      <span class="hljs-attr">endPort</span>: <span class="hljs-number">2001</span></li><li>    }] <span class="hljs-keyword">as</span> <span class="hljs-title class_">IpPort</span>[],</li><li>  <span class="hljs-attr">remotePorts</span>: [</li><li>    {</li><li>      <span class="hljs-attr">startPort</span>: <span class="hljs-number">443</span>,</li><li>      <span class="hljs-attr">endPort</span>: <span class="hljs-number">443</span></li><li>    }] <span class="hljs-keyword">as</span> <span class="hljs-title class_">IpPort</span>[],</li><li>  <span class="hljs-attr">userId</span>: <span class="hljs-number">100</span></li><li>};</li><li><span class="hljs-comment">// 添加防火墙规则。</span></li><li>netFirewall.<span class="hljs-title function_">addNetFirewallRule</span>(ipRule).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rule Id: '</span>, result);</li><li>}, <span class="hljs-function">(<span class="hljs-params">reason: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'add firewall rule failed: '</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(reason));</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="针对域名联网访问控制支持拦截">针对域名联网访问控制支持拦截<i class="anchor-icon anchor-icon-link" anchorid="针对域名联网访问控制支持拦截" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>设备通过硬件接口，插入网线。</p></li>      <li>       <p>从@kit.NetworkKit中导入netFirewall命名空间。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 从@kit.NetworkKit中导入netFirewall命名空间。</span></li><li><span class="hljs-keyword">import</span> { netFirewall } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>调用setNetFirewallPolicy方法，打开防火墙。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">interface</span> domain{</li><li>    <span class="hljs-attr">isWildcard</span>: <span class="hljs-built_in">boolean</span>;</li><li>    <span class="hljs-attr">domain</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义防火墙策略：打开，入站阻止，出站允许。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">policy</span>: netFirewall.<span class="hljs-property">NetFirewallPolicy</span> = {</li><li>  <span class="hljs-attr">isOpen</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">inAction</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_DENY</span>,</li><li>  <span class="hljs-attr">outAction</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_ALLOW</span></li><li>};</li><li><span class="hljs-comment">// 给用户100设置防火墙策略</span></li><li>netFirewall.<span class="hljs-title function_">setNetFirewallPolicy</span>(<span class="hljs-number">100</span>, policy).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set firewall policy success."</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error : BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"set firewall policy failed: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>});</li></ol></pre></div></div></li>      <li>       <p>通过addNetFirewallRule方法，添加防火墙规则。</p>       <div _ngcontent-ycy-c106="" class="highlight-div"><div _ngcontent-ycy-c106="" class="highlight-div-header"><div _ngcontent-ycy-c106="" class="highlight-div-header-left"><div _ngcontent-ycy-c106="" class="handle-button expand-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ycy-c106="" class="highlight-div-header-right"><div _ngcontent-ycy-c106="" class="handle-button ai-button"></div><div _ngcontent-ycy-c106="" class="handle-button line-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ycy-c106="" class="handle-button theme-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ycy-c106="" class="handle-button copy-button"><div _ngcontent-ycy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ycy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化具体的防火墙域名类型规则。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">domainRule</span>: netFirewall.<span class="hljs-property">NetFirewallRule</span> = {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">"rule2"</span>,</li><li>  <span class="hljs-attr">description</span>: <span class="hljs-string">"rule2 description"</span>,</li><li>  <span class="hljs-attr">direction</span>: netFirewall.<span class="hljs-property">NetFirewallRuleDirection</span>.<span class="hljs-property">RULE_IN</span>,</li><li>  <span class="hljs-attr">action</span>: netFirewall.<span class="hljs-property">FirewallRuleAction</span>.<span class="hljs-property">RULE_DENY</span>,</li><li>  <span class="hljs-attr">type</span>: netFirewall.<span class="hljs-property">NetFirewallRuleType</span>.<span class="hljs-property">RULE_DOMAIN</span>,</li><li>  <span class="hljs-attr">isEnabled</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">appUid</span>: <span class="hljs-number">20002</span>,</li><li>  <span class="hljs-attr">domains</span>: [</li><li>    {</li><li>      <span class="hljs-attr">isWildcard</span>: <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-attr">domain</span>: <span class="hljs-string">"www.HarmonyOS.cn"</span></li><li>    },{</li><li>      <span class="hljs-attr">isWildcard</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-attr">domain</span>: <span class="hljs-string">"*.HarmonyOS.cn"</span></li><li>    }] <span class="hljs-keyword">as</span> domain[],</li><li>  <span class="hljs-attr">userId</span>: <span class="hljs-number">100</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 添加防火墙规则。</span></li><li>netFirewall.<span class="hljs-title function_">addNetFirewallRule</span>(domainRule).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rule Id: '</span>, result);</li><li>}, <span class="hljs-function">(<span class="hljs-params">reason: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'add firewall rule failed: '</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(reason));</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>