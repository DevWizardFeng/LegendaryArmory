<h1 _ngcontent-dom-c119="" class="doc-title ng-star-inserted" title="使用说明"> 使用说明 </h1>

<div _ngcontent-dom-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>AscendC提供一组Matmul高阶API，方便开发者快速实现Matmul矩阵乘法的运算操作。</p> <p>Matmul的计算公式为：C = A * B，其示意图如下。</p> <ul><li>A、B为源操作数，A为左矩阵，形状为[M, K]；B为右矩阵，形状为[K, N]。</li><li>C为目的操作数，存放矩阵乘结果的矩阵，形状为[M, N]。</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>Matmul矩阵乘示意图（当前不支持bias计算）</span><br><span><img height="136.6575" originheight="153" originwidth="585" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114327.06729881608539752706163264532280:50001231000000:2800:E96CC34C89A0C086B28E88F111730D3F00A269AA89941096B67D2FCC9E76CDB2.png" title="点击放大" width="523.6875"></span></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>下文中提及的M轴方向，即为A矩阵纵向；K轴方向，即为A矩阵横向或B矩阵纵向；N轴方向，即为B矩阵横向。</p> </div></div></div> <p>实现Matmul矩阵乘运算的具体步骤如下。</p> <ol><li><span>创建Matmul对象。示例如下。</span><p></p><ul><li>CUBE_ONLY（只有矩阵计算）场景下，需要设置ASCENDC_CUBE_ONLY代码宏。</li><li>默认为MIX模式（包含矩阵计算和矢量计算），该场景下，不能设置ASCENDC_CUBE_ONLY代码宏。</li></ul> <div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 纯cube模式（只有矩阵计算）场景下，需要设置该代码宏，并且必须在#include "lib/matmul_intf.h"之前设置 </span></li><li><span class="hljs-comment">// #define ASCENDC_CUBE_ONLY  </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib/matmul_intf.h"</span> </span></li><li> </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; aType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; bType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; cType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; biasType;  </li><li>matmul::Matmul&lt;aType, bType, cType, biasType&gt; mm; </li></ol></pre></div></div> <p>创建对象时需要传入A、B、C、Bias的参数类型信息， 类型信息通过MatmulType来定义，包括：内存逻辑位置、数据格式、数据类型。</p> <div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;AscendC::TPosition POSITION, CubeFormat FORMAT, <span class="hljs-keyword">typename</span> TYPE, <span class="hljs-type">bool</span> ISTRANS = <span class="hljs-literal">false</span>, LayoutMode LAYOUT = LayoutMode::NONE, <span class="hljs-type">bool</span> IBSHARE = <span class="hljs-literal">false</span>&gt; <span class="hljs-keyword">struct</span> MatmulType { </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> AscendC::TPosition pos = POSITION; </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> CubeFormat format = FORMAT; </li><li>    <span class="hljs-keyword">using</span> T = TYPE; </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> <span class="hljs-type">bool</span> isTrans = ISTRANS; </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> LayoutMode layout = LAYOUT; </li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> <span class="hljs-type">bool</span> ibShare = IBSHARE; </li><li>};</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>MatmulType参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.1.2.5.2.3.1.1" valign="top" width="17%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.1.2.5.2.3.1.2" valign="top" width="83%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17%"><p>POSITION</p> </td> <td class="cellrowborder" valign="top" width="83%"><p>内存逻辑位置</p> <p>Kirin9020系列处理器：</p> <ul><li>A矩阵可设置为TPosition::GM，TPosition::TSCM</li><li>B矩阵可设置为TPosition::GM，TPosition::TSCM</li><li>C矩阵可设置为TPosition::GM</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17%"><p>CubeFormat</p> </td> <td class="cellrowborder" valign="top" width="83%"><p>Kirin9020系列处理器：</p> <ul><li>A矩阵在GM时，支持CubeFormat::ND。</li><li>A矩阵在TSCM时，支持CubeFormat::NZ/CubeFormat::VECTOR。</li><li>B矩阵在GM时，支持CubeFormat::ND/CubeFormat::NZ。</li><li>B矩阵在TSCM时支持CubeFormat::NZ。</li><li>C矩阵在GM时，支持CubeFormat::ND。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17%"><p>TYPE</p> </td> <td class="cellrowborder" valign="top" width="83%"><p>Kirin9020系列处理器：</p> <ul><li>A矩阵可设置为half。</li><li>B矩阵可设置为half。</li><li>C矩阵可设置为half。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17%"><p>ISTRANS</p> </td> <td class="cellrowborder" valign="top" width="83%"><p>是否开启使能矩阵转置的功能。当前不支持转置，只支持设为false。</p> <p>false为不开启使能矩阵转置的功能，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-settensora">SetTensorA</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-settensorb">SetTensorB</a>不能设置A、B矩阵是否转置。Matmul会认为A矩阵形状为[M, K]，B矩阵形状为[K, N]。</p> <p>默认为false不使能转置。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17%"><p>LAYOUT</p> </td> <td class="cellrowborder" valign="top" width="83%"><p>表征数据的排布</p> <p>NONE：默认值，表示不使用BatchMatmul，其他选项表示使用BatchMatmul。</p> </td> </tr>  </tbody></table></div> </div> <p></p></li><li><span>初始化操作。</span><p></p><div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">REGIST_MATMUL_OBJ</span>(&amp;pipe, <span class="hljs-built_in">GetSysWorkSpacePtr</span>(), mm, &amp;tiling);</li></ol></pre></div></div> <p></p></li><li><span>设置左矩阵A、右矩阵B、Bias。</span><p></p><div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">SetTensorA</span>(gm_a);    <span class="hljs-comment">// 设置左矩阵A </span></li><li>mm.<span class="hljs-built_in">SetTensorB</span>(gm_b);    <span class="hljs-comment">// 设置右矩阵B </span></li><li>mm.<span class="hljs-built_in">SetBias</span>(gm_bias);    <span class="hljs-comment">// 设置Bias </span></li><li> </li><li>mm.<span class="hljs-built_in">SetLocalWorkspace</span>(ubBuf);</li></ol></pre></div></div> <p></p></li><li><span>完成矩阵乘操作。</span><p></p><ul><li>调用Iterate完成单次迭代计算，叠加while循环完成单核全量数据的计算。Iterate方式，可以自行控制迭代次数，完成所需数据量的计算，方式比较灵活。<div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">while</span> (mm.<span class="hljs-built_in">Iterate</span>()) {    </li><li>     mm.<span class="hljs-built_in">GetTensorC</span>(gm_c);  </li><li> }</li></ol></pre></div></div> </li><li>调用IterateAll完成单核上所有数据的计算。IterateAll方式，无需循环迭代，使用比较简单。<div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">IterateAll</span>(gm_c);</li></ol></pre></div></div> </li></ul> <p></p></li><li><span>结束矩阵乘操作。</span><p></p><div _ngcontent-dom-c106="" class="highlight-div"><div _ngcontent-dom-c106="" class="highlight-div-header"><div _ngcontent-dom-c106="" class="highlight-div-header-left"><div _ngcontent-dom-c106="" class="handle-button expand-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dom-c106="" class="highlight-div-header-right"><div _ngcontent-dom-c106="" class="handle-button ai-button"></div><div _ngcontent-dom-c106="" class="handle-button line-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dom-c106="" class="handle-button theme-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dom-c106="" class="handle-button copy-button"><div _ngcontent-dom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dom-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">End</span>();</li></ol></pre></div></div> <p></p></li></ol> </div> <div></div></div>