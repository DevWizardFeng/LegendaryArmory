<h1 _ngcontent-upe-c119="" class="doc-title ng-star-inserted" title="使用说明"> 使用说明 </h1>

<div _ngcontent-upe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>AscendC提供一组Matmul Tiling API，方便开发者获取Matmul kernel计算时所需的Tiling参数。开发者只需要传入A/B/C矩阵等信息，调用API接口，即可获取到Init中TCubeTiling结构体中的相关参数。</p> <p>Matmul Tiling API分为Matmul单核Tiling接口、多核Tiling接口和BatchMatmul Tiling接口。获取Tiling参数的流程如下。</p> <ol><li>创建一个单核Tiling对象，或多核Tiling对象，或BatchMatmul Tiling对象。</li><li>设置A、B、C、Bias的参数类型信息，M、N、Ka、Kb形状信息等。</li><li>调用GetTiling接口，获取Tiling信息。</li></ol> <p>使用Matmul单核Tiling接口、多核Tiling接口和BatchMatmul Tiling接口获取Tiling参数的样例如下。</p> <ul><li>Matmul单核Tiling<div _ngcontent-upe-c106="" class="highlight-div"><div _ngcontent-upe-c106="" class="highlight-div-header"><div _ngcontent-upe-c106="" class="highlight-div-header-left"><div _ngcontent-upe-c106="" class="handle-button expand-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-upe-c106="" class="highlight-div-header-right"><div _ngcontent-upe-c106="" class="handle-button ai-button"></div><div _ngcontent-upe-c106="" class="handle-button line-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-upe-c106="" class="handle-button theme-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-upe-c106="" class="handle-button copy-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-upe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> ascendcPlatform = platform_ascendc::<span class="hljs-built_in">PlatformAscendC</span>(context-&gt;<span class="hljs-built_in">GetPlatformInfo</span>());</li><li><span class="hljs-function">matmul_tiling::MatmulApiTiling <span class="hljs-title">tiling</span><span class="hljs-params">(ascendcPlatform)</span></span>;</li><li>tiling.<span class="hljs-built_in">SetAType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>tiling.<span class="hljs-built_in">SetBType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>tiling.<span class="hljs-built_in">SetCType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>tiling.<span class="hljs-built_in">SetBiasType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>tiling.<span class="hljs-built_in">SetShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>tiling.<span class="hljs-built_in">SetOrgShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 或Ka,Kb不等长，如tiling.SetOrgShape(1024, 1024, 1024, 1280)</span></li><li>tiling.<span class="hljs-built_in">SetBias</span>(<span class="hljs-literal">true</span>);</li><li>tiling.<span class="hljs-built_in">SetBufferSpace</span>(<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>);  <span class="hljs-comment">// 设定允许使用的空间，缺省使用该AI处理器所有空间</span></li><li>optiling::TCubeTiling tilingData;</li><li><span class="hljs-type">int</span> ret = tiling.<span class="hljs-built_in">GetTiling</span>(tilingData);    <span class="hljs-comment">// if ret = -1, get tiling failed</span></li></ol></pre></div></div> </li><li>多核Tiling<div _ngcontent-upe-c106="" class="highlight-div"><div _ngcontent-upe-c106="" class="highlight-div-header"><div _ngcontent-upe-c106="" class="highlight-div-header-left"><div _ngcontent-upe-c106="" class="handle-button expand-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-upe-c106="" class="highlight-div-header-right"><div _ngcontent-upe-c106="" class="handle-button ai-button"></div><div _ngcontent-upe-c106="" class="handle-button line-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-upe-c106="" class="handle-button theme-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-upe-c106="" class="handle-button copy-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-upe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> ascendcPlatform = platform_ascendc::<span class="hljs-built_in">PlatformAscendC</span>(context-&gt;<span class="hljs-built_in">GetPlatformInfo</span>());</li><li><span class="hljs-function">matmul_tiling::MultiCoreMatmulTiling <span class="hljs-title">tiling</span><span class="hljs-params">(ascendcPlatform)</span></span>;</li><li>tiling.<span class="hljs-built_in">SetDim</span>(<span class="hljs-number">1</span>);</li><li>tiling.<span class="hljs-built_in">SetAType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>tiling.<span class="hljs-built_in">SetBType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>tiling.<span class="hljs-built_in">SetCType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>tiling.<span class="hljs-built_in">SetBiasType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>tiling.<span class="hljs-built_in">SetShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>tiling.<span class="hljs-built_in">SetSingleShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>tiling.<span class="hljs-built_in">SetOrgShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>tiling.<span class="hljs-built_in">SetBias</span>(<span class="hljs-literal">true</span>);</li><li>tiling.<span class="hljs-built_in">SetBufferSpace</span>(<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>);  <span class="hljs-comment">// 设定允许使用的空间，缺省使用该AI处理器所有空间</span></li><li>optiling::TCubeTiling tilingData;</li><li><span class="hljs-type">int</span> ret = tiling.<span class="hljs-built_in">GetTiling</span>(tilingData);    <span class="hljs-comment">// if ret = -1, get tiling failed</span></li></ol></pre></div></div> </li><li>BatchMatmul Tiling<div _ngcontent-upe-c106="" class="highlight-div"><div _ngcontent-upe-c106="" class="highlight-div-header"><div _ngcontent-upe-c106="" class="highlight-div-header-left"><div _ngcontent-upe-c106="" class="handle-button expand-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-upe-c106="" class="highlight-div-header-right"><div _ngcontent-upe-c106="" class="handle-button ai-button"></div><div _ngcontent-upe-c106="" class="handle-button line-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-upe-c106="" class="handle-button theme-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-upe-c106="" class="handle-button copy-button"><div _ngcontent-upe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-upe-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> ascendcPlatform = platform_ascendc::<span class="hljs-built_in">PlatformAscendC</span>(context-&gt;<span class="hljs-built_in">GetPlatformInfo</span>());</li><li><span class="hljs-function">matmul_tiling::BatchMatmulTiling <span class="hljs-title">bmmTiling</span><span class="hljs-params">(ascendcPlatform)</span></span>;</li><li>bmmTiling.<span class="hljs-built_in">SetDim</span>(<span class="hljs-number">1</span>);</li><li>bmmTiling.<span class="hljs-built_in">SetAType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>bmmTiling.<span class="hljs-built_in">SetBType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16);</li><li>bmmTiling.<span class="hljs-built_in">SetCType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>bmmTiling.<span class="hljs-built_in">SetBiasType</span>(matmul_tiling::TPosition::GM, matmul_tiling::CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li><li>bmmTiling.<span class="hljs-built_in">SetBias</span>(<span class="hljs-literal">true</span>);</li><li>bmmTiling.<span class="hljs-built_in">SetShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>bmmTiling.<span class="hljs-built_in">SetSingleShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>bmmTiling.<span class="hljs-built_in">SetOrgShape</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);</li><li>bmmTiling.<span class="hljs-built_in">SetBufferSpace</span>(<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>);  <span class="hljs-comment">// 设定允许使用的空间，缺省使用该AI处理器所有空间</span></li><li>optiling::TCubeTiling tilingData;</li><li><span class="hljs-type">int</span> ret = bmmTiling.<span class="hljs-built_in">GetTiling</span>(tilingData);    <span class="hljs-comment">// if ret = -1, get tiling failed</span></li></ol></pre></div></div> </li></ul> <p>接口列表如下。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>MatmulApiTiling/MultiCoreMatmulTiling/BatchMatmulTiling共有接口列表</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.2.3.1.1" valign="top" width="30.3%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.2.3.1.2" valign="top" width="69.69999999999999%"><p>功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetAType</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置A矩阵的位置，数据格式，数据类型，是否转置等信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetBType</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置B矩阵的位置，数据格式，数据类型，是否转置等信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetCType</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置C矩阵的位置，数据格式，数据类型等信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetBiasType</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置Bias的位置，数据格式，数据类型等信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetShape</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置Matmul单次计算的形状singleM、singleN、singleK，单位为元素个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetOrgShape</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置Matmul计算时的原始完整的形状M、N、Ka、Kb，单位为元素个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetBias</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置Bias是否参与运算。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetFixSplit</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置固定的baseM、baseN、baseK，单位为元素个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetBufferSpace</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置Matmul计算时可用的L1/L0C/UB空间大小，单位为字节。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetTraverse</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置遍历方式，M轴优先还是N轴优先。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetMadType</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置是否使能HF32模式。<strong>当前版本暂不支持。</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetSplitRange</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置baseM/baseN/baseK的最大值和最小值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>SetDoubleBuffer</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>设置A/B/C/Bias是否使能double buffer功能，以及是否需要做ND2NZ或者NZ2ND的转换。<strong>该接口为预留接口，当前版本暂不支持。</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>GetBaseM</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>获取baseM值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>GetBaseN</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>获取baseN值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>GetBaseK</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>获取baseK值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.3%"><p>GetTiling</p> </td> <td class="cellrowborder" valign="top" width="69.69999999999999%"><p>获取Tiling参数。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>MultiCoreMatmulTiling其他接口</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.2.3.1.1" valign="top" width="18.18%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.2.3.1.2" valign="top" width="81.82000000000001%"><p>功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18.18%"><p>SetDim</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>设置多核Matmul时，可以参与运算的核数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>SetSingleRange</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>设置singleCoreM/singleCoreN/singleCoreK的最大值与最小值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>SetSingleShape</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>设置Matmul单核计算的形状singleCoreM、singleCoreN、singleCoreK，单位为元素个数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>GetSingleShape</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>获取计算后的singleCoreM/singleCoreN/singleCoreK。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>SetAlignSplit</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>设置多核切分时singleCoreM/singleCoreN/singleCoreK的对齐值</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>GetCoreNum</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>获得多核切分后，使用的blockDim。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.18%"><p>SetSplitK</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>多核场景，使能切K轴。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>BatchMatmulTiling其他接口</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.3.1.1" valign="top" width="18.18%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.3.1.2" valign="top" width="81.82000000000001%"><p>功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18.18%"><p>GetCoreNum</p> </td> <td class="cellrowborder" valign="top" width="81.82000000000001%"><p>获得多核切分后，使用的blockDim。</p> </td> </tr>  </tbody></table></div> </div> </div> <div></div></div>