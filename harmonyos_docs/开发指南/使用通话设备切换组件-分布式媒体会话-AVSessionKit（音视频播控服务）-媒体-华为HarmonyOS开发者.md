<h1 _ngcontent-dup-c119="" class="doc-title ng-star-inserted" title="使用通话设备切换组件"> 使用通话设备切换组件 </h1>

<div _ngcontent-dup-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="切换通话输出设备">切换通话输出设备<i class="anchor-icon anchor-icon-link" anchorid="切换通话输出设备" tips="复制节点链接"></i></h2>          <p>系统不再提供音频输出设备切换的API，如果需要应用内切换音频输出设备，请实现AVCastPicker组件，相关参数可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avcastpicker" target="_blank">@ohos.multimedia.avCastPicker</a> 和 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-avcastpickerparam" target="_blank">@ohos.multimedia.avCastPickerParam</a>。</p>     <p>本文将主要介绍AVCastPicker组件接入，实现通话输出设备切换功能。</p>     <p>当前系统支持两种组件样式的显示方式：默认样式显示和自定义样式显示。</p>     <ul>      <li>如果应用选择显示默认样式，当设备切换时，系统将根据当前选择的设备显示系统默认的组件样式。</li>      <li>如果应用选择显示自定义样式，那么需要应用根据设备的变化刷新自己定义的样式。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="默认样式实现" class="firsth2">默认样式实现<i class="anchor-icon anchor-icon-link" anchorid="默认样式实现" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>创建voice_call类型的AVSession，AVSession在构造方法中支持不同的类型参数，由AVSessionType定义，voice_call表示通话类型，如果不创建，将显示空列表。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { avSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li> <span class="hljs-meta">@Entry</span></li><li> <span class="hljs-meta">@Component</span></li><li> struct <span class="hljs-title class_">Index</span> {</li><li>   <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li> </li><li>   <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>     <span class="hljs-title class_">Column</span>() {</li><li>         <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>           .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> ()=&gt; {</li><li>             <span class="hljs-keyword">try</span> {</li><li>               <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>             <span class="hljs-comment">// 通话开始时创建voice_call类型的avsession。</span></li><li>             <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: avSession.<span class="hljs-property">AVSession</span> = <span class="hljs-keyword">await</span> avSession.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'voiptest'</span>, <span class="hljs-string">'voice_call'</span>);</li><li>             } <span class="hljs-keyword">catch</span> (err) {</li><li>               <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVSession create :  Error: Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>             }</li><li>           })</li><li>       }</li><li>     .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>     .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>   }</li><li> }</li></ol></pre></div></div></li>      <li>       <p>在需要切换设备的通话界面创建AVCastPicker组件。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVCastPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建组件，并设置大小。</span></li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">AVCastPicker</span>()</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">height</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">45</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建VOICE_COMMUNICATION类型的AudioRenderer，并开始播放。具体通话音频播放等实现，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-call-development">AudioKit开发音频通话功能</a>。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioRenderer</span> {</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">audioRenderer</span>: audio.<span class="hljs-property">AudioRenderer</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">audioStreamInfo</span>: audio.<span class="hljs-property">AudioStreamInfo</span> = {</li><li>   <span class="hljs-comment">// 请按照实际场景设置，当前参数仅参考。</span></li><li>   <span class="hljs-attr">samplingRate</span>: audio.<span class="hljs-property">AudioSamplingRate</span>.<span class="hljs-property">SAMPLE_RATE_48000</span>, <span class="hljs-comment">// 采样率。</span></li><li>   <span class="hljs-attr">channels</span>: audio.<span class="hljs-property">AudioChannel</span>.<span class="hljs-property">CHANNEL_2</span>, <span class="hljs-comment">// 通道。</span></li><li>   <span class="hljs-attr">sampleFormat</span>: audio.<span class="hljs-property">AudioSampleFormat</span>.<span class="hljs-property">SAMPLE_FORMAT_S16LE</span>, <span class="hljs-comment">// 采样格式。</span></li><li>   <span class="hljs-attr">encodingType</span>: audio.<span class="hljs-property">AudioEncodingType</span>.<span class="hljs-property">ENCODING_TYPE_RAW</span> <span class="hljs-comment">// 编码格式。</span></li><li> }</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">audioRendererInfo</span>: audio.<span class="hljs-property">AudioRendererInfo</span> = {</li><li>   <span class="hljs-comment">// 需使用通话场景相应的参数。</span></li><li>   <span class="hljs-attr">usage</span>: audio.<span class="hljs-property">StreamUsage</span>.<span class="hljs-property">STREAM_USAGE_VIDEO_COMMUNICATION</span>, <span class="hljs-comment">// 音频流使用类型：VOIP视频通话，默认为扬声器。</span></li><li>   <span class="hljs-attr">rendererFlags</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 音频渲染器标志：默认为0即可。</span></li><li> }</li><li> <span class="hljs-keyword">private</span> <span class="hljs-attr">audioRendererOptions</span>: audio.<span class="hljs-property">AudioRendererOptions</span> = {</li><li>   <span class="hljs-attr">streamInfo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioStreamInfo</span>,</li><li>   <span class="hljs-attr">rendererInfo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererInfo</span></li><li> }</li><li>
</li><li> <span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-comment">// 初始化，创建通话audiorenderer实例，设置监听事件。</span></li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span> = <span class="hljs-keyword">await</span> audio.<span class="hljs-title function_">createAudioRenderer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererOptions</span>);</li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`audioRender create :  Error: Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   }</li><li>
</li><li>   <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>?.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>     <span class="hljs-keyword">if</span> (err) {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`audioRenderer start failed -Code : <span class="hljs-subst">${err.code}</span>, Message <span class="hljs-subst">${err.message}</span>`</span>);</li><li>     } <span class="hljs-keyword">else</span> {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'audioRender start success'</span>);</li><li>     }</li><li>   });</li><li> }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）如果应用想知道设备切换情况，可以监听当前发声设备切换回调。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> audioManager = audio.<span class="hljs-title function_">getAudioManager</span>(); <span class="hljs-comment">// 先创建audiomanager。</span></li><li><span class="hljs-keyword">let</span> audioRoutingManager = audioManager.<span class="hljs-title function_">getRoutingManager</span>(); <span class="hljs-comment">// 再调用AudioManager的方法创建AudioRoutingManager实例。</span></li><li>
</li><li><span class="hljs-comment">// 可选监听当前发声设备切换回调。</span></li><li>audioRoutingManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'preferOutputDeviceChangeForRendererInfo'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererInfo</span>, <span class="hljs-function">(<span class="hljs-params">desc: audio.AudioDeviceDescriptors</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`device change To : <span class="hljs-subst">${desc[<span class="hljs-number">0</span>].deviceType}</span>`</span>); <span class="hljs-comment">// 设备类型。</span></li><li>});</li></ol></pre></div></div></li>      <li>       <p>通话结束后，销毁会话。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通话结束销毁第一步创建的session。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">destroy</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to destroy session. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Destroy : SUCCESS `</span>);</li><li>  }</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="自定义样式实现">自定义样式实现<i class="anchor-icon anchor-icon-link" anchorid="自定义样式实现" tips="复制节点链接"></i></h3>          <p>自定义样式通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-types#custombuilder8" target="_blank">CustomBuilder</a>类型的参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avcastpicker#avcastpicker" target="_blank">customPicker</a>实现。</p>     <p>实现自定义样式的步骤与实现默认样式基本相同，开发者可参考<a href="/consumer/cn/doc/harmonyos-guides/using-switch-call-devices#默认样式实现">默认样式实现</a>，完成创建AVSession、实现音频播放等步骤。</p>     <p>存在差异的步骤如下所示。</p>     <ol>      <li>       <p>创建自定义AVCastPicker，需要新增自定义参数。（对应默认样式实现步骤2）</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVCastPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">pickerImage</span>:<span class="hljs-title class_">ResourceStr</span> = $r(<span class="hljs-string">'app.media.earpiece'</span>); <span class="hljs-comment">// 自定义资源。</span></li><li>
</li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">AVCastPicker</span>(</li><li>        {</li><li>          <span class="hljs-attr">customPicker</span>: (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">ImageBuilder</span>() <span class="hljs-comment">// 新增自定义参数。</span></li><li>        }</li><li>      ).<span class="hljs-title function_">size</span>({ <span class="hljs-attr">height</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">45</span> })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义内容。</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-title class_">ImageBuilder</span>() {</li><li>  <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pickerImage</span>)</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00000000'</span>)</li><li>    .<span class="hljs-title function_">fillColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>}</li></ol></pre></div></div></li>      <li>       <p>如果应用要根据出声设备变化而改变自定义样式，必须监听设备切换，然后实时刷新自定义样式。（对应默认样式实现步骤4）</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">observerDevices</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> audioManager = audio.<span class="hljs-title function_">getAudioManager</span>();</li><li>  <span class="hljs-keyword">let</span> audioRoutingManager = audioManager.<span class="hljs-title function_">getRoutingManager</span>();</li><li>
</li><li>  <span class="hljs-comment">// 初次拉起AVCastPicker时需获取当前设备,刷新显示。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changePickerShow</span>(audioRoutingManager.<span class="hljs-title function_">getPreferredOutputDeviceForRendererInfoSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererInfo</span>));</li><li>
</li><li>  <span class="hljs-comment">// 监听当前发声设备切换，及时根据不同设备类型显示不同的样式。</span></li><li>  audioRoutingManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'preferOutputDeviceChangeForRendererInfo'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererInfo</span>, <span class="hljs-function">(<span class="hljs-params">desc: audio.AudioDeviceDescriptors</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changePickerShow</span>(audioRoutingManager.<span class="hljs-title function_">getPreferredOutputDeviceForRendererInfoSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererInfo</span>));</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设备更新后刷新自定义资源pickerImage。</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">changePickerShow</span>(<span class="hljs-params">desc: audio.AudioDeviceDescriptors</span>) {</li><li>  <span class="hljs-keyword">if</span>(!desc || !desc.<span class="hljs-property">length</span> || !desc[<span class="hljs-number">0</span>]) {</li><li>   <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (desc[<span class="hljs-number">0</span>].<span class="hljs-property">deviceType</span> === <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pickerImage</span> = $r(<span class="hljs-string">'app.media.sound'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (desc[<span class="hljs-number">0</span>].<span class="hljs-property">deviceType</span> === <span class="hljs-number">7</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pickerImage</span> = $r(<span class="hljs-string">'app.media.bluetooth'</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pickerImage</span> = $r(<span class="hljs-string">'app.media.earpiece'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="切换通话输入设备仅在pc2in1设备可用">切换通话输入设备（仅在PC/2in1设备可用）<i class="anchor-icon anchor-icon-link" anchorid="切换通话输入设备仅在pc2in1设备可用" tips="复制节点链接"></i></h2>          <p>系统不再提供音频输入设备切换的API，如果需要在应用内切换音频输入设备，并实现AVInputCastPicker组件，相关参数可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avinputcastpicker" target="_blank">@ohos.multimedia.avInputCastPicker</a> 和 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-avcastpickerparam" target="_blank">@ohos.multimedia.avCastPickerParam</a>。</p>     <p>本文将主要介绍AVInputCastPicker组件接入，实现通话输入设备切换功能。</p>     <p>当前系统支持两种组件样式的显示方式：默认样式显示和自定义样式显示。</p>     <ul>      <li>如果应用选择显示默认样式，当设备切换时，系统将根据当前选择的设备显示系统默认的组件样式。</li>      <li>如果应用选择显示自定义样式，那么需要应用根据设备的变化刷新自己定义的样式。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="默认实现方式" class="firsth2">默认实现方式<i class="anchor-icon anchor-icon-link" anchorid="默认实现方式" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>在需要切换设备的通话界面创建AVInputCastPicker组件。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVCastPickerState</span>, <span class="hljs-title class_">AVInputCastPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 设备列表显示状态变化回调（可选）。</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: AVCastPickerState</span>) {</li><li>  <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_APPEARING</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The picker starts showing.'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_DISAPPEARING</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The picker finishes presenting.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建组件，并设置大小。</span></li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">AVInputCastPicker</span>(</li><li>      {</li><li>        <span class="hljs-attr">onStateChange</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">onStateChange</span></li><li>      }</li><li>      ).<span class="hljs-title function_">size</span>({ <span class="hljs-attr">height</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">45</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>实现通话功能，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-call-development">AudioKit开发音频通话功能</a>。</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="自定义实现方式">自定义实现方式<i class="anchor-icon anchor-icon-link" anchorid="自定义实现方式" tips="复制节点链接"></i></h3>          <p>自定义样式通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avinputcastpicker#avinputcastpicker" target="_blank">AVInputCastPicker</a>中的参数customPicker实现。</p>     <ol>      <li>       <p>创建自定义AVInputCastPicker，需要新增自定义参数。</p>       <div _ngcontent-dup-c106="" class="highlight-div"><div _ngcontent-dup-c106="" class="highlight-div-header"><div _ngcontent-dup-c106="" class="highlight-div-header-left"><div _ngcontent-dup-c106="" class="handle-button expand-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dup-c106="" class="highlight-div-header-right"><div _ngcontent-dup-c106="" class="handle-button ai-button"></div><div _ngcontent-dup-c106="" class="handle-button line-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dup-c106="" class="handle-button theme-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dup-c106="" class="handle-button copy-button"><div _ngcontent-dup-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dup-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVCastPickerState</span>, <span class="hljs-title class_">AVInputCastPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CastPicker</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">pickerImage</span>: <span class="hljs-title class_">ResourceStr</span> = $r(<span class="hljs-string">'app.media.startIcon'</span>); <span class="hljs-comment">// 自定义资源。</span></li><li>
</li><li>  <span class="hljs-comment">// 设备列表显示状态变化回调（可选）。</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: AVCastPickerState</span>) {</li><li>     <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_APPEARING</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The picker starts showing.'</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_DISAPPEARING</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The picker finishes presenting.'</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">AVInputCastPicker</span>(</li><li>          {</li><li>            <span class="hljs-attr">customPicker</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">ImageBuilder</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-comment">// 新增自定义参数。</span></li><li>            <span class="hljs-attr">onStateChange</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">onStateChange</span></li><li>          }</li><li>        ).<span class="hljs-title function_">size</span>({ <span class="hljs-attr">height</span>: <span class="hljs-number">45</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">45</span> })</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 自定义内容。</span></li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">ImageBuilder</span>() {</li><li>    <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pickerImage</span>)</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00000000'</span>)</li><li>      .<span class="hljs-title function_">fillColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>实现通话功能，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-call-development">AudioKit开发音频通话功能</a>。</p></li>     </ol>    </div>   </div>   <div></div></div>