<h1 _ngcontent-qjr-c119="" class="doc-title ng-star-inserted" title="保存媒体库资源"> 保存媒体库资源 </h1>

<div _ngcontent-qjr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>保存图片、视频等用户文件到图库时，无需申请相册管理模块权限'ohos.permission.WRITE_IMAGEVIDEO'，应用可以通过<a href="/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton#使用安全控件保存媒体库资源">安全控件</a>或<a href="/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton#使用弹窗授权保存媒体库资源">授权弹窗</a>的方式，将用户指定的媒体资源保存到图库中。</p>    <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">      <p>Media Library Kit提供图片和视频的管理能力，当需要读取和保存音频文件时，请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#audioviewpicker" target="_blank">AudioViewPicker（音频选择器对象）</a>。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="获取支持保存的资源格式">获取支持保存的资源格式<i class="anchor-icon anchor-icon-link" anchorid="获取支持保存的资源格式" tips="复制节点链接"></i></h2>          <p>下面以获取支持保存的图片类型资源格式为例。</p>     <p><strong>开发步骤</strong></p>     <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoaccesshelper#getsupportedphotoformats18" target="_blank">phAccessHelper.getSupportedPhotoFormats</a>接口获取支持保存的图片类型资源格式。</p>     <div _ngcontent-qjr-c106="" class="highlight-div"><div _ngcontent-qjr-c106="" class="highlight-div-header"><div _ngcontent-qjr-c106="" class="highlight-div-header-left"><div _ngcontent-qjr-c106="" class="handle-button expand-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjr-c106="" class="highlight-div-header-right"><div _ngcontent-qjr-c106="" class="handle-button ai-button"></div><div _ngcontent-qjr-c106="" class="handle-button line-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjr-c106="" class="handle-button theme-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjr-c106="" class="handle-button copy-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">outputText</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'支持的类型为：\n'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"example"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>        <span class="hljs-keyword">let</span> phAccessHelper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>        <span class="hljs-title function_">example</span>(phAccessHelper);</li><li>      }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">phAccessHelper: photoAccessHelper.PhotoAccessHelper</span>){</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> outputText = <span class="hljs-string">'支持的类型为：\n'</span>;</li><li>    <span class="hljs-comment">// 参数为1表示获取支持的图片类型格式，参数为2表示获取支持的视频类型格式。</span></li><li>    <span class="hljs-keyword">let</span> imageFormat  = <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">getSupportedPhotoFormats</span>(<span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">let</span> result = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; imageFormat.<span class="hljs-property">length</span>; i++) {</li><li>      result += imageFormat[i];</li><li>      <span class="hljs-keyword">if</span> (i !== imageFormat.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {</li><li>        result += <span class="hljs-string">', '</span>;</li><li>      }</li><li>    }</li><li>    outputText += result;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'getSupportedPhotoFormats success, data is '</span> + outputText);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getSupportedPhotoFormats failed, errCode is'</span>, error);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="使用安全控件保存媒体库资源">使用安全控件保存媒体库资源<i class="anchor-icon anchor-icon-link" anchorid="使用安全控件保存媒体库资源" tips="复制节点链接"></i></h2>          <p>安全控件的介绍可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-security-components-savebutton" target="_blank">安全控件的保存控件</a>。</p>     <p>下面以使用安全控件创建一张图片资源为例。</p>     <p><strong>开发步骤</strong></p>     <ol>      <li>设置安全控件按钮属性。</li>      <li>创建安全控件按钮。</li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/kts-apis-photoaccesshelper-mediaassetchangerequest#createimageassetrequest11" target="_blank">MediaAssetChangeRequest.createImageAssetRequest</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoaccesshelper#applychanges11" target="_blank">PhotoAccessHelper.applyChanges</a>接口创建图片资源。</li>     </ol>     <div _ngcontent-qjr-c106="" class="highlight-div"><div _ngcontent-qjr-c106="" class="highlight-div-header"><div _ngcontent-qjr-c106="" class="highlight-div-header-left"><div _ngcontent-qjr-c106="" class="handle-button expand-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjr-c106="" class="highlight-div-header-right"><div _ngcontent-qjr-c106="" class="handle-button ai-button"></div><div _ngcontent-qjr-c106="" class="handle-button line-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjr-c106="" class="handle-button theme-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjr-c106="" class="handle-button copy-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-attr">saveButtonOptions</span>: <span class="hljs-title class_">SaveButtonOptions</span> = {</li><li>    <span class="hljs-attr">icon</span>: <span class="hljs-title class_">SaveIconStyle</span>.<span class="hljs-property">FULL_FILLED</span>,</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-title class_">SaveDescription</span>.<span class="hljs-property">SAVE_IMAGE</span>,</li><li>    <span class="hljs-attr">buttonType</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span></li><li>  } <span class="hljs-comment">// 设置安全控件按钮属性。</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">SaveButton</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButtonOptions</span>) <span class="hljs-comment">// 创建安全控件按钮。</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (event, <span class="hljs-attr">result</span>: <span class="hljs-title class_">SaveButtonOnClickResult</span>) =&gt; {</li><li>             <span class="hljs-keyword">if</span> (result == <span class="hljs-title class_">SaveButtonOnClickResult</span>.<span class="hljs-property">SUCCESS</span>) {</li><li>               <span class="hljs-keyword">try</span> {</li><li>                 <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>                 <span class="hljs-keyword">let</span> phAccessHelper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>                 <span class="hljs-comment">// 需要确保fileUri对应的资源存在。</span></li><li>                 <span class="hljs-keyword">let</span> fileUri = <span class="hljs-string">'file://com.example.temptest/data/storage/el2/base/haps/entry/files/test.jpg'</span>;</li><li>                 <span class="hljs-keyword">let</span> <span class="hljs-attr">assetChangeRequest</span>: photoAccessHelper.<span class="hljs-property">MediaAssetChangeRequest</span> = photoAccessHelper.<span class="hljs-property">MediaAssetChangeRequest</span>.<span class="hljs-title function_">createImageAssetRequest</span>(context, fileUri);</li><li>                 <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">applyChanges</span>(assetChangeRequest);</li><li>                 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'createAsset successfully, uri: '</span> + assetChangeRequest.<span class="hljs-title function_">getAsset</span>().<span class="hljs-property">uri</span>);</li><li>               } <span class="hljs-keyword">catch</span> (err) {</li><li>                 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`create asset failed with error: <span class="hljs-subst">${err.code}</span>, <span class="hljs-subst">${err.message}</span>`</span>);</li><li>               }</li><li>             } <span class="hljs-keyword">else</span> {</li><li>               <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'SaveButtonOnClickResult create asset failed'</span>);</li><li>             }</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>除了上述通过fileUri从应用沙箱指定资源内容的方式，开发者还可以通过ArrayBuffer的方式添加资源内容，详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/kts-apis-photoaccesshelper-mediaassetchangerequest#addresource11-1" target="_blank">addResource</a>接口。</p>    </div>    <div class="tiledSection">     <h2 id="使用弹窗授权保存媒体库资源">使用弹窗授权保存媒体库资源<i class="anchor-icon anchor-icon-link" anchorid="使用弹窗授权保存媒体库资源" tips="复制节点链接"></i></h2>          <p>下面以弹窗授权的方式保存一张图片资源为例。</p>     <p><strong>开发步骤</strong></p>     <ol>      <li>       <p>指定待保存到媒体库的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件</a>uri（需为应用沙箱路径）。</p></li>      <li>       <p>指定待保存照片的创建选项，包括文件后缀和照片类型，标题和照片子类型可选。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoaccesshelper#showassetscreationdialog12" target="_blank">showAssetsCreationDialog</a>，基于弹窗授权的方式获取的目标<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/user-file-uri-intro#媒体文件uri">媒体文件</a>uri。</p>       <p>弹框需要显示应用名称，无法直接获取应用名称，依赖于配置项的label和icon，因此调用此接口时请确保module.json5文件中的abilities标签中配置了label和icon项。当传入uri为沙箱路径时，可正常保存图片/视频，但无界面预览。</p></li>      <li>       <p>将应用沙箱的照片内容写入媒体库的目标uri。</p></li>     </ol>     <div _ngcontent-qjr-c106="" class="highlight-div"><div _ngcontent-qjr-c106="" class="highlight-div-header"><div _ngcontent-qjr-c106="" class="highlight-div-header-left"><div _ngcontent-qjr-c106="" class="handle-button expand-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qjr-c106="" class="highlight-div-header-right"><div _ngcontent-qjr-c106="" class="handle-button ai-button"></div><div _ngcontent-qjr-c106="" class="handle-button line-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qjr-c106="" class="handle-button theme-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qjr-c106="" class="handle-button copy-button"><div _ngcontent-qjr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qjr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">phAccessHelper: photoAccessHelper.PhotoAccessHelper</span>){</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 指定待保存到媒体库的位于应用沙箱的图片uri。</span></li><li>    <span class="hljs-keyword">let</span> srcFileUri = <span class="hljs-string">'file://com.example.temptest/data/storage/el2/base/haps/entry/files/test.jpg'</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">srcFileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [</li><li>      srcFileUri</li><li>    ];</li><li>    <span class="hljs-comment">// 指定待保存照片的创建选项，包括文件后缀和照片类型，标题和照片子类型可选。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">photoCreationConfigs</span>: <span class="hljs-title class_">Array</span>&lt;photoAccessHelper.<span class="hljs-property">PhotoCreationConfig</span>&gt; = [</li><li>      {</li><li>        <span class="hljs-attr">title</span>: <span class="hljs-string">'test'</span>, <span class="hljs-comment">// 可选。</span></li><li>        <span class="hljs-attr">fileNameExtension</span>: <span class="hljs-string">'jpg'</span>,</li><li>        <span class="hljs-attr">photoType</span>: photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>,</li><li>        <span class="hljs-attr">subtype</span>: photoAccessHelper.<span class="hljs-property">PhotoSubtype</span>.<span class="hljs-property">DEFAULT</span>, <span class="hljs-comment">// 可选。</span></li><li>      }</li><li>    ];</li><li>    <span class="hljs-comment">// 基于弹窗授权的方式获取媒体库的目标uri。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">desFileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">showAssetsCreationDialog</span>(srcFileUris, photoCreationConfigs);</li><li>    <span class="hljs-comment">// 将来源于应用沙箱的照片内容写入媒体库的目标uri。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">desFile</span>: fileIo.<span class="hljs-property">File</span> = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(desFileUris[<span class="hljs-number">0</span>], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">srcFile</span>: fileIo.<span class="hljs-property">File</span> = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(srcFileUri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">copyFile</span>(srcFile.<span class="hljs-property">fd</span>, desFile.<span class="hljs-property">fd</span>);</li><li>    fileIo.<span class="hljs-title function_">closeSync</span>(srcFile);</li><li>    fileIo.<span class="hljs-title function_">closeSync</span>(desFile);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'create asset by dialog successfully'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`failed to create asset by dialog successfully errCode is: <span class="hljs-subst">${err.code}</span>, <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>