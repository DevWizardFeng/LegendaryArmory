<h1 _ngcontent-eio-c119="" class="doc-title ng-star-inserted" title="光线追踪全局光照"> 光线追踪全局光照 </h1>

<div _ngcontent-eio-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>XEngine Kit提供端侧光线追踪全局光照（Ray-Traced Global Illumination，RTGI）能力，包含动态漫反射全局光照（DDGI）算法和神经网络全局光照（NNGI）算法。</p> <div class="tiledSection"><h2 id="section624112515458">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section624112515458" tips="复制节点链接"></i></h2><ul><li>支持的设备类型：此特性依赖设备支持Vulkan光线追踪扩展<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_acceleration_structure.html" target="_blank">VK_KHR_acceleration_structure</a>、<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_ray_query.html" target="_blank">VK_KHR_ray_query</a></li><li>可通过以下方式查询相关扩展特性是否支持：<p>对于Vulkan，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>扩展特性查询接口进行查询，如查询结果包含XEG_RTGI_EXTENSION_NAME，则表示支持该特性，若查询结果未包含，则表示不支持该特性。</p> </li></ul> </div> <div class="tiledSection"><h2 id="section10437114114110">应用场景<i class="anchor-icon anchor-icon-link" anchorid="section10437114114110" tips="复制节点链接"></i></h2><p>DDGI算法：根据视角中的探针信息，分帧更新探针光照，实现使用光线追踪实时渲染动态全局光照的效果。同时可与端云渲染相结合，利用端侧光追算力，计算动态全局光照，结合云侧下发的静态全局光照信息，实时生成高质量全场景光线追踪全局光照。</p> <p>NNGI算法：结合了AI和光线追踪技术，通过非常小分辨率（例如64×32）对场景进行光线追踪渲染，然后将延迟渲染的几何数据和光追结果输入给NPU推理出整个场景的全局光照结果，从而实现少量光线即可实现全局光照效果。同时基于马良GPU的异构协同技术，NPU和GPU可以同时工作，降低整体时延。</p> </div> <div class="tiledSection"><h2 id="section297614137247">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section297614137247" tips="复制节点链接"></i></h2><p>以下接口为RTGI设置接口，如需使用更丰富的设置和查询接口，具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine" target="_blank">接口文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_EnumerateDeviceExtensionProperties (VkPhysicalDevice physicalDevice, uint32_t *pPropertyCount, XEG_ExtensionProperties *pProperties)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>XEngine Vulkan扩展特性查询接口。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CreateRTGI (VkDevice device, const void *pCreateInfo, XEG_RTGI *pRtGI)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建XEG_RTGI对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CmdRenderRTGI (VkCommandBuffer commandBuffer, XEG_RTGI rtGI, const void *pDescription)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>执行渲染命令。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CmdSetSynchronization (VkCommandBuffer commandBuffer, const void *xegHandle)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置同步信号，等待渲染结果写入指定图像。使用RTGI特性时，为等待GI渲染结果写入指定图像。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_DestroyRTGI (XEG_RTGI rtGI)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁XEG_RTGI对象。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1171182142612">DDGI开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1171182142612" tips="复制节点链接"></i></h2><p>本章以Vulkan图像API集成为例，说明XEngine集成操作过程。</p> </div> <div class="tiledSection"><h3 id="section79201052326" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section79201052326" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so编译需要依赖NDK中的libxengine.so。</p> <ul><li>头文件引用<div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_rtgi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_extension.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_extension_defs.h&gt;</span></span></li></ol></pre></div></div> </li><li>编写CMakeLists.txt<p>CMakeLists.txt部分示例代码如下。</p> <div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set core code path.</span></li><li><span class="hljs-built_in">set</span>(CORE_DIR ./core)</li><li><span class="hljs-built_in">include_directories</span>(${CORE_DIR})</li><li><span class="hljs-built_in">include_directories</span>(${CORE_DIR}/common)</li><li>
</li><li><span class="hljs-comment">// Set render code path.</span></li><li><span class="hljs-built_in">set</span>(BEHAVIOR_DIR ${CORE_DIR}/render)</li><li><span class="hljs-built_in">add_subdirectory</span>(${BEHAVIOR_DIR})</li><li>
</li><li><span class="hljs-comment">// Set scene loader code path.</span></li><li><span class="hljs-built_in">set</span>(SCENE_DIR ${CORE_DIR}/scene)</li><li><span class="hljs-built_in">add_subdirectory</span>(${SCENE_DIR})</li><li>
</li><li><span class="hljs-comment">// Set vulkan code path.</span></li><li><span class="hljs-built_in">set</span>(VULKANBASE_DIR ${CORE_DIR}/vulkanbase)</li><li><span class="hljs-built_in">add_subdirectory</span>(${VULKANBASE_DIR})</li><li>
</li><li><span class="hljs-built_in">set</span>(UTILS_DIR ${CORE_DIR}/utils)</li><li><span class="hljs-built_in">include_directories</span>(${UTILS_DIR})</li><li><span class="hljs-built_in">add_library</span>(RawFileImporter STATIC ${UTILS_DIR}/rawFileImporter.cpp ${UTILS_DIR}/core.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(RawFileImporter PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/../../../libs/${OHOS_ARCH}/libsecurec.so)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li># Sets the name of the path variable.</li><li>xengine-lib</li><li># Specifies the name of the NDK library that</li><li><span class="hljs-meta"># you want CMake to locate.</span></li><li>xengine</li><li>)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(ohosmain SHARED main.cpp ${SPIRV_BINARY_FILES})</li><li><span class="hljs-built_in">target_link_libraries</span>(ohosmain PUBLIC libace_napi.z.so libace_ndk.z.so librawfile.z.so libhilog_ndk.z.so RawFileImporter libvulkan.so ${xengine-lib} RenderBehavior SceneLoader VulkanBase)</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section114231231174114">集成XEngine RT DDGI（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section114231231174114" tips="复制节点链接"></i></h3><p>使用Vulkan图形API搭建图像渲染管线，并集成RT DDGI在Native层实现，渲染结果通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件显示到屏幕。</p> <p>本节阐述Vulkan图形API的RT DDGI使用。</p> <p>在调用XEngine Kit能力前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_enumeratedeviceextensionproperties" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持XEG_RTGI_EXTENSION_NAME扩展时才可以使用RT DDGI的相关接口。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// physicalDevice为Vulkan物理设备，用户需进行初始化</span></li><li>VkPhysicalDevice physicalDevice;</li><li><span class="hljs-comment">// 查询XEngine支持的Vulkan扩展列表</span></li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> propertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (propertyCount&gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">properties</span><span class="hljs-params">(propertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount,</li><li>        &amp;properties.<span class="hljs-built_in">front</span>()) == VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : properties) {</li><li>            supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 查询是否支持RT DDGI</span></li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_RTGI_EXTENSION_NAME) ==</li><li>    supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_RTGI xegRTGI;</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_creatertgi" target="_blank">HMS_XEG_CreateRTGI</a>接口，创建RT DDGI实例。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 渲染宽高以及缩放倍率可以由用户设定，这里用1280*720为例，缩放倍率为1</span></li><li>VkExtent2D outputSize;</li><li>outputSize.width = <span class="hljs-number">1280</span>;</li><li>outputSize.height = <span class="hljs-number">720</span>;</li><li>VkExtent2D scaled;</li><li>scaled.width = <span class="hljs-number">1</span>;</li><li>scaled.height = <span class="hljs-number">1</span>;</li><li><span class="hljs-comment">// Vulkan逻辑设备，用户需进行初始化</span></li><li>VkDevice device;</li><li><span class="hljs-comment">// XEG_DDGICreateInfo为创建XEG_RTGI对象所需信息</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">XEG_DDGICreateInfo</span> DDGICreateInfo;</li><li><span class="hljs-comment">// 指定当前结构体类型为create info</span></li><li>DDGICreateInfo.sType = XEG_STRUCTURE_TYPE_DDGI_CREATE_INFO;</li><li><span class="hljs-comment">// 指定扩展为空</span></li><li>DDGICreateInfo.pNext = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 指定质量模式为平衡</span></li><li>DDGICreateInfo.qualityMode = XEG_RTGI_QUALITY_MODE_BALANCED;</li><li><span class="hljs-comment">// 指定当前场景中需要同时渲染的最大体积数量，范围为[1, 9]</span></li><li>DDGICreateInfo.numberVolume = <span class="hljs-number">4</span>;</li><li><span class="hljs-comment">// 指定渲染宽高缩小倍率，建议范围为[1, 4]，必须不小于1</span></li><li>DDGICreateInfo.scaledView = scaled;</li><li><span class="hljs-comment">// 指定输出GI图像的渲染宽高</span></li><li>DDGICreateInfo.viewSize = outputSize;</li><li><span class="hljs-comment">// 指定是否开启端云模式，true为开启，false为关闭</span></li><li>DDGICreateInfo.enableCloud = <span class="hljs-literal">false</span>;</li><li>VkResult res = <span class="hljs-built_in">HMS_XEG_CreateRTGI</span>(device, &amp;DDGICreateInfo, &amp;xegRTGI);</li><li><span class="hljs-keyword">if</span> (res != VK_SUCCESS) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtgi" target="_blank">HMS_XEG_CmdRenderRTGI</a>接口执行渲染命令，每帧都需要调用。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// probeIrradianceSH为用户创建的存储探针光照二阶球谐系数的3D图像vkImageView</span></li><li><span class="hljs-comment">// 存储当前接口渲染结果，通过对该图像进行三线性插值采样，可以计算GI光照值</span></li><li>VkImageView probeIrradianceSH = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// 定义XEG_DDGIVolumeEntryParameters对象DDGIVolumeEntryParameters</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">XEG_DDGIVolumeEntryParameters</span> DDGIVolumeEntryParameters;</li><li><span class="hljs-comment">// 体积索引，范围为[0, 65535]，且唯一</span></li><li>DDGIVolumeEntryParameters.volumeIndex = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 探针发射光线数量，范围为[1, 1024]</span></li><li>DDGIVolumeEntryParameters.raysPerProbe = <span class="hljs-number">128</span>;</li><li><span class="hljs-comment">// 光线求交最远距离</span></li><li>DDGIVolumeEntryParameters.probeMaxRayDistance = <span class="hljs-number">1000.0f</span>;</li><li><span class="hljs-comment">// 体积中心点坐标</span></li><li>DDGIVolumeEntryParameters.volumePosition[<span class="hljs-number">0</span>] = <span class="hljs-number">0.0f</span>;</li><li>DDGIVolumeEntryParameters.volumePosition[<span class="hljs-number">1</span>] = <span class="hljs-number">0.0f</span>;</li><li>DDGIVolumeEntryParameters.volumePosition[<span class="hljs-number">2</span>] = <span class="hljs-number">0.0f</span>;</li><li><span class="hljs-comment">// 探针放置间距，必须大于0</span></li><li>DDGIVolumeEntryParameters.probeSpacing[<span class="hljs-number">0</span>] = <span class="hljs-number">10.0f</span>;</li><li>DDGIVolumeEntryParameters.probeSpacing[<span class="hljs-number">1</span>] = <span class="hljs-number">10.0f</span>;</li><li>DDGIVolumeEntryParameters.probeSpacing[<span class="hljs-number">2</span>] = <span class="hljs-number">10.0f</span>;</li><li><span class="hljs-comment">// 体积光照通道标记</span></li><li>DDGIVolumeEntryParameters.volumeLightingChannelMask = <span class="hljs-number">0xFFFFFFFF</span>;</li><li><span class="hljs-comment">// 探针放置数量，必须大于0，范围为[1, 32]</span></li><li>DDGIVolumeEntryParameters.volumeProbeGridCounts[<span class="hljs-number">0</span>] = <span class="hljs-number">6</span>;</li><li>DDGIVolumeEntryParameters.volumeProbeGridCounts[<span class="hljs-number">1</span>] = <span class="hljs-number">6</span>;</li><li>DDGIVolumeEntryParameters.volumeProbeGridCounts[<span class="hljs-number">2</span>] = <span class="hljs-number">6</span>;</li><li><span class="hljs-comment">// 光照的伽马校正系数，必须不为0</span></li><li>DDGIVolumeEntryParameters.volumeProbeIrradianceEncodingGamma = <span class="hljs-number">5.0f</span>;</li><li><span class="hljs-comment">// 探针光照历史权重，范围为[0, 1]</span></li><li>DDGIVolumeEntryParameters.probeHysteresis = <span class="hljs-number">0.95f</span>;</li><li><span class="hljs-comment">// 探针变化阈值</span></li><li>DDGIVolumeEntryParameters.probeChangeThreshold = <span class="hljs-number">1.0f</span>;</li><li><span class="hljs-comment">// 探针亮度阈值</span></li><li>DDGIVolumeEntryParameters.probeBrightnessThreshold = <span class="hljs-number">1.0f</span>;</li><li><span class="hljs-comment">// 探针法向偏移量</span></li><li>DDGIVolumeEntryParameters.volumeNormalBias = <span class="hljs-number">0.12f</span>;</li><li><span class="hljs-comment">// 探针视角偏移量</span></li><li>DDGIVolumeEntryParameters.volumeViewBias = <span class="hljs-number">0.48f</span>;</li><li><span class="hljs-comment">// 体积光照混合距离</span></li><li>DDGIVolumeEntryParameters.volumeBlendDistance = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 体积边缘光照渐暗范围</span></li><li>DDGIVolumeEntryParameters.volumeBlendDistanceBlack = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 探针反向判断阈值</span></li><li>DDGIVolumeEntryParameters.probeBackfaceThreshold = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 探针正向最小距离</span></li><li>DDGIVolumeEntryParameters.probeMinFrontfaceDistance = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 体积光照缩放倍率，必须非负</span></li><li>DDGIVolumeEntryParameters.volumeIrradianceScalar = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 发射光线强度倍率，必须非负</span></li><li>DDGIVolumeEntryParameters.emissiveMultiplier = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 光照倍率，必须非负</span></li><li>DDGIVolumeEntryParameters.lightingMultiplier = <span class="hljs-number">1.0</span>;</li><li><span class="hljs-comment">// 是否强制更新所有探针，true为强制全部更新，false为选择部分更新</span></li><li>DDGIVolumeEntryParameters.bForceUpdate = <span class="hljs-literal">false</span>;</li><li>DDGIVolumeEntryParameters.probeIrradianceSH = probeIrradianceSH;</li><li>
</li><li><span class="hljs-comment">// 定义XEG_DDGIDescription对象DDGIDescription</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">XEG_DDGIDescription</span> DDGIDescription;</li><li><span class="hljs-comment">// inputNormalImage为用户创建的法线图像vkImageView</span></li><li>VkImageView inputNormalImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputDepthImage为用户创建的深度图像vkImageView</span></li><li>VkImageView inputDepthImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputBasecolorMetallicImage为用户创建的颜色及金属度图像vkImageView</span></li><li>VkImageView inputBasecolorMetallicImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputDirectionImage为用户创建的发射光线方向图像vkImageView</span></li><li>VkImageView inputDirectionImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputRayRadianceDistanceImage为用户创建的发射光线交点光照及距离图像vkImageView</span></li><li>VkImageView inputRayRadianceDistanceImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputRayHitNormalAndMetallicImage为用户创建的发射光线交点法线及金属度图像vkImageView</span></li><li>VkImageView inputRayHitNormalAndMetallicImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputVolumeIndexAndProbeIndex为用户创建的输入probe索引缓冲区vkBuffer</span></li><li>VkBuffer inputVolumeIndexAndProbeIndex = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// outputVolumeIndexAndProbeIndex为用户创建的输出probe索引缓冲区vkBuffer</span></li><li>VkBuffer outputVolumeIndexAndProbeIndex = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// outputProbeCount为用户创建的输出probe数量缓冲区vkBuffer</span></li><li>VkBuffer outputProbeCount = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// outputGIImage为用户创建的全局光照图像vkImageView</span></li><li>VkImageView outputGIImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// commandBuffer为命令缓冲区，用户需进行初始化</span></li><li>VkCommandBuffer commandBuffer = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// 指定当前结构体类型为DDGI description</span></li><li>DDGIDescription.sType = XEG_STRUCTURE_TYPE_DDGI_DESCRIPTION;</li><li><span class="hljs-comment">// 指定扩展为空</span></li><li>DDGIDescription.pNext = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 设置相机相关矩阵</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; ++i) {</li><li>    DDGIDescription.viewMatrix[i] = <span class="hljs-number">1.0f</span>;</li><li>    DDGIDescription.projectionMatrix[i] = <span class="hljs-number">1.0f</span>;</li><li>}</li><li>DDGIDescription.inputNormalImage = inputNormalImage;</li><li>DDGIDescription.inputDepthImage = inputDepthImage;</li><li>DDGIDescription.inputBasecolorMetallicImage = inputBasecolorMetallicImage;</li><li>DDGIDescription.inputDirectionImage = inputDirectionImage;</li><li>DDGIDescription.inputRayRadianceDistanceImage = inputRayRadianceDistanceImage;</li><li>DDGIDescription.inputRayHitNormalAndMetallicImage = inputRayHitNormalAndMetallicImage;</li><li>DDGIDescription.inputVolumeIndexAndProbeIndex = inputVolumeIndexAndProbeIndex;</li><li><span class="hljs-comment">// 输入probe信息数量</span></li><li>DDGIDescription.inputProbeCount = <span class="hljs-number">10</span>;</li><li>DDGIDescription.outputVolumeIndexAndProbeIndex = outputVolumeIndexAndProbeIndex;</li><li>DDGIDescription.outputProbeCount = outputProbeCount;</li><li>DDGIDescription.outputGIImage = outputGIImage;</li><li><span class="hljs-comment">// 使用的volume数量</span></li><li>DDGIDescription.enableVolumeNumber = <span class="hljs-number">1</span>;</li><li>DDGIDescription.pVolumeEntryParameters = &amp;DDGIVolumeEntryParameters;</li><li><span class="hljs-built_in">HMS_XEG_CmdRenderRTGI</span>(commandBuffer, xegRTGI, &amp;DDGIDescription);</li></ol></pre></div></div> <p></p></li><li><span>若使用延迟渲染管线，则可以在调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtgi" target="_blank">HMS_XEG_CmdRenderRTGI</a>接口之后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdsetsynchronization" target="_blank">HMS_XEG_CmdSetSynchronization</a>接口，设置同步信号，等待GI渲染结果写入指定图像，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdsetsynchronization" target="_blank">HMS_XEG_CmdSetSynchronization</a>接口需要每帧调用。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// GI渲染结果会写入到XEG_DDGIDescription中的outputGIImage图像中</span></li><li><span class="hljs-built_in">HMS_XEG_CmdSetSynchronization</span>(commandBuffer, &amp;xegRTGI);</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_destroyrtgi" target="_blank">HMS_XEG_DestroyRTGI</a>接口销毁实例。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (xegRTGI) {</li><li>    <span class="hljs-built_in">HMS_XEG_DestroyRTGI</span>(xegRTGI);</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section131234793419">NNGI开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section131234793419" tips="复制节点链接"></i></h2><p>本章以Vulkan图像API集成为例，说明XEngine集成操作过程。</p> </div> <div class="tiledSection"><h3 id="section9123779346" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section9123779346" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so编译需要依赖NDK中的libxengine.so。</p> <ul><li>头文件引用<div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xengine/xeg_vulkan_rtgi.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xengine/xeg_vulkan_extension.h"</span></span></li></ol></pre></div></div> </li><li>编写CMakeLists.txt<p>CMakeLists.txt部分示例代码如下。</p> <div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    Vulkan-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    vulkan</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC ${Vulkan-lib} ${xengine-lib})</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section1412487153418">集成XEngine RT NNGI（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section1412487153418" tips="复制节点链接"></i></h3><p>使用Vulkan图形API搭建图像渲染管线，并集成RT NNGI在Native层实现，渲染结果通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件显示到屏幕。</p> <p>本节阐述Vulkan图形API的RT NNGI使用。</p> <p>在调用XEngine Kit能力前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_enumeratedeviceextensionproperties" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持XEG_RTGI_EXTENSION_NAME扩展时才可以使用RT NNGI的相关接口。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// physicalDevice为Vulkan物理设备，用户需进行初始化</span></li><li>VkPhysicalDevice physicalDevice;</li><li><span class="hljs-comment">// 查询XEngine支持的Vulkan扩展列表</span></li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> propertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (propertyCount&gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">properties</span><span class="hljs-params">(propertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount,</li><li>        &amp;properties.<span class="hljs-built_in">front</span>()) == VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : properties) {</li><li>            supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 查询是否支持RT NNGI</span></li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_RTGI_EXTENSION_NAME) ==</li><li>    supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_RTGI xegRTGI;</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_creatertgi" target="_blank">HMS_XEG_CreateRTGI</a>接口，创建RT NNGI实例。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Vulkan逻辑设备，用户需进行初始化</span></li><li>VkDevice device;</li><li><span class="hljs-comment">// XEG_DDGICreateInfo为创建XEG_RTGI对象所需信息</span></li><li>XEG_NNGICreateInfo NNGICreateInfo;</li><li><span class="hljs-comment">// 指定当前结构体类型为create info</span></li><li>NNGICreateInfo.sType = XEG_STRUCTURE_TYPE_NNGI_CREATE_INFO;</li><li><span class="hljs-comment">// 指定扩展为空</span></li><li>NNGICreateInfo.pNext = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 指定质量模式为平衡</span></li><li>NNGICreateInfo.qualityMode = XEG_RTGI_QUALITY_MODE_BALANCED;</li><li><span class="hljs-comment">// 指定推理输入图像的分辨率</span></li><li>NNGICreateInfo.inferenceInputSize = {<span class="hljs-number">1280</span>,<span class="hljs-number">720</span>};</li><li><span class="hljs-comment">// 指定推理输出图像的分辨率，当前仅支持（640，328）</span></li><li>NNGICreateInfo.inferenceOutputSize = {<span class="hljs-number">640</span>, <span class="hljs-number">368</span>};</li><li><span class="hljs-comment">// 指定训练图像的分辨率</span></li><li>NNGICreateInfo.trainingSize = {<span class="hljs-number">64</span>, <span class="hljs-number">32</span>};</li><li>VkResult res = <span class="hljs-built_in">HMS_XEG_CreateRTGI</span>(device, &amp;NNGICreateInfo, &amp;xegRTGI);</li><li><span class="hljs-keyword">if</span> (res != VK_SUCCESS) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtgi" target="_blank">HMS_XEG_CmdRenderRTGI</a>接口执行渲染命令，每帧都需要调用。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义XEG_NNGIDescription对象NNGIDescription</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">XEG_NNGIDescription</span> NNGIDescription;</li><li><span class="hljs-comment">// inferenceInputDepthImage为用户创建的推理输入深度图像vkImageView</span></li><li>VkImageView inferenceInputDepthImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inferenceInputNormalImage为用户创建的推理输入法向量图像vkImageView</span></li><li>VkImageView inferenceInputNormalImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inferenceInputBaseColorMetallicImage为用户创建的推理输入基础颜色和金属度图像vkImageView</span></li><li>VkImageView inferenceInputBaseColorMetallicImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inferenceOutputGIImage为用户创建的推理输出全局光照图像vkImageView</span></li><li>VkImageView inferenceOutputGIImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// trainingInputPositionImage为用户创建的训练输入位置图像vkImageView</span></li><li>VkImageView trainingInputPositionImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// trainingInputNormalImage为用户创建的训练输入法向量图像vkImageView</span></li><li>VkImageView trainingInputNormalImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// trainingInputBaseColorMetallicImage为用户创建的训练输入基础颜色和金属度图像vkImageView</span></li><li>VkImageView trainingInputBaseColorMetallicImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// trainingInputGIImage为用户创建的训练输入全局光照图像vkImageView</span></li><li>VkImageView trainingInputGIImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// sceneAabb为用户创建的渲染包围盒范围VkAabbPositionsKHR</span></li><li>VkAabbPositionsKHR sceneAabb = {<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>};</li><li><span class="hljs-comment">// isSceneUnbounded指定渲染场景是否无界，当前只支持false</span></li><li><span class="hljs-type">bool</span> isSceneUnbounded = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// spatialScaleFactor为场景缩放因子，对于有界场景，无需设置，XEngine根据sceneAabb计算该值</span></li><li><span class="hljs-type">float</span> spatialScaleFactor = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// commandBuffer为命令缓冲区，用户需进行初始化</span></li><li>VkCommandBuffer commandBuffer = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// 指定当前结构体类型为DDGI description</span></li><li>NNGIDescription.sType = XEG_STRUCTURE_TYPE_NNGI_DESCRIPTION;</li><li><span class="hljs-comment">// 指定扩展为空</span></li><li>NNGIDescription.pNext = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 设置推理图像的相机相关矩阵，此处仅为示例，使用时需要用户进行初始化</span></li><li><span class="hljs-type">float</span> inferenceCameraViewMatrix[<span class="hljs-number">16</span>];</li><li><span class="hljs-type">float</span> inferenceCameraProjectionMatrix[<span class="hljs-number">16</span>];</li><li><span class="hljs-built_in">memcpy</span>(NNGIDescription.inferenceCameraViewMatrix, &amp;inferenceCameraViewMatrix, <span class="hljs-built_in">sizeof</span>(NNGIDescription.inferenceCameraViewMatrix));</li><li><span class="hljs-built_in">memcpy</span>(NNGIDescription.inferenceCameraProjectionMatrix, &amp;inferenceCameraProjectionMatrix, <span class="hljs-built_in">sizeof</span>(NNGIDescription.inferenceCameraProjectionMatrix));</li><li><span class="hljs-comment">// 设置训练图像的相机相关矩阵，此处仅为示例，使用时需要用户进行初始化</span></li><li><span class="hljs-type">float</span> trainingCameraViewMatrix[<span class="hljs-number">16</span>];</li><li><span class="hljs-type">float</span> trainingCameraProjectionMatrix[<span class="hljs-number">16</span>];</li><li><span class="hljs-built_in">memcpy</span>(NNGIDescription.trainingCameraViewMatrix, &amp;trainingCameraViewMatrix, <span class="hljs-built_in">sizeof</span>(NNGIDescription.trainingCameraViewMatrix));</li><li><span class="hljs-built_in">memcpy</span>(NNGIDescription.trainingCameraProjectionMatrix, &amp;trainingCameraProjectionMatrix, <span class="hljs-built_in">sizeof</span>(NNGIDescription.trainingCameraProjectionMatrix)); </li><li>NNGIDescription.inferenceInputDepthImage = inferenceInputDepthImage;</li><li>NNGIDescription.inferenceInputNormalImage = inferenceInputNormalImage;</li><li>NNGIDescription.inferenceInputBaseColorMetallicImage = inferenceInputBaseColorMetallicImage;</li><li>NNGIDescription.inferenceOutputGIImage = inferenceOutputGIImage;</li><li>NNGIDescription.trainingInputPositionImage = trainingInputPositionImage;</li><li>NNGIDescription.trainingInputNormalImage = trainingInputNormalImage;</li><li>NNGIDescription.trainingInputBaseColorMetallicImage = trainingInputBaseColorMetallicImage;</li><li>NNGIDescription.trainingInputGIImage = trainingInputGIImage;</li><li>NNGIDescription.sceneAabb = sceneAabb;</li><li>NNGIDescription.isSceneUnbounded = isSceneUnbounded;</li><li>NNGIDescription.spatialScaleFactor = spatialScaleFactor;</li><li><span class="hljs-built_in">HMS_XEG_CmdRenderRTGI</span>(commandBuffer, xegRTGI, &amp;NNGIDescription);</li></ol></pre></div></div> <p></p></li><li><span>在调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtgi" target="_blank">HMS_XEG_CmdRenderRTGI</a>接口之后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdsetsynchronization" target="_blank">HMS_XEG_CmdSetSynchronization</a>接口，执行训练步骤，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdsetsynchronization" target="_blank">HMS_XEG_CmdSetSynchronization</a>接口需要每帧调用。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// GI渲染结果会写入到XEG_NNGIDescription中的inferenceOutputGIImage图像中</span></li><li><span class="hljs-built_in">HMS_XEG_CmdSetSynchronization</span>(commandBuffer, &amp;xegRTGI);</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_destroyrtgi" target="_blank">HMS_XEG_DestroyRTGI</a>接口销毁实例。</span><p></p><div _ngcontent-eio-c106="" class="highlight-div"><div _ngcontent-eio-c106="" class="highlight-div-header"><div _ngcontent-eio-c106="" class="highlight-div-header-left"><div _ngcontent-eio-c106="" class="handle-button expand-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eio-c106="" class="highlight-div-header-right"><div _ngcontent-eio-c106="" class="handle-button ai-button"></div><div _ngcontent-eio-c106="" class="handle-button line-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eio-c106="" class="handle-button theme-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eio-c106="" class="handle-button copy-button"><div _ngcontent-eio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eio-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (xegRTGI) {</li><li>    <span class="hljs-built_in">HMS_XEG_DestroyRTGI</span>(xegRTGI);</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>