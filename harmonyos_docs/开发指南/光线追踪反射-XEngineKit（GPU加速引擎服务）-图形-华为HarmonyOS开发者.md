<h1 _ngcontent-ewi-c119="" class="doc-title ng-star-inserted" title="光线追踪反射"> 光线追踪反射 </h1>

<div _ngcontent-ewi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>XEngine Kit提供光线追踪反射（Ray-Traced Reflections）渲染能力。相比于该效果的传统光线追踪实现方式，依托于华为马良GPU的软硬结合优化，XEngine支持FERT(Flexible Entry Raytracing)求交加速技术，可以减少光线与场景几何的求交计算次数，从而降低实现高画质光追效果时的GPU负载。</p> <div class="tiledSection"><h2 id="section624112515458">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section624112515458" tips="复制节点链接"></i></h2><ul><li>支持的设备类型：此特性依赖设备支持Vulkan光线追踪扩展<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_acceleration_structure.html" target="_blank">VK_KHR_acceleration_structure</a>、<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_ray_query.html" target="_blank">VK_KHR_ray_query</a></li><li>可通过以下方式查询相关扩展特性是否支持：<p>对于Vulkan，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>扩展特性查询接口进行查询，如查询结果包含XEG_RT_REFLECTION_EXTENSION_NAME，则表示支持该特性，若查询结果未包含，则表示不支持该特性。</p> </li></ul> </div> <div class="tiledSection"><h2 id="section297614137247">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section297614137247" tips="复制节点链接"></i></h2><p>以下接口为使用光线追踪反射特性需要使用的接口，关于这些接口的详细说明见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine" target="_blank">接口文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_EnumerateDeviceExtensionProperties (VkPhysicalDevice physicalDevice, uint32_t * pPropertyCount, XEG_ExtensionProperties * pProperties)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>XEngine Vulkan扩展特性查询接口。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CreateRTReflection(VkDevice device, const void* pCreateInfo, XEG_RTReflection* pRtReflection)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建XEG_RTReflection对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CmdRenderRTReflection(VkCommandBuffer  commandBuffer, XEG_RTReflection rtReflection, const void* pDescription)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>录制计算RT反射命中信息命令。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_DestroyRTReflection(XEG_RTReflection rtReflection);</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁XEG_RTReflection对象。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1171182142612">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1171182142612" tips="复制节点链接"></i></h2></div> <p>本章以在Vulkan应用程序中集成为例，说明XEngine集成操作过程。</p> <div class="tiledSection"><h3 id="section79201052326" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section79201052326" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so编译需要依赖NDK中的libxengine.so。</p> <ul><li>头文件引用<div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xengine/xeg_vulkan_extension.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_rt_reflection.h&gt;</span></span></li></ol></pre></div></div> </li><li>编写CMakeLists.txt<p>CMakeLists.txt部分示例代码如下</p> <div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>    ...... <span class="hljs-comment">// 其他库文件</span></li><li>    ${xengine-lib})</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section1142314818519">集成XEngine光线追踪反射（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section1142314818519" tips="复制节点链接"></i></h3><p>使用Vulkan图形API搭建图像渲染管线，并集成光线追踪反射效果的代码需要在Native层实现，渲染结果通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件显示到屏幕。</p> <p>在调用XEngine Kit能力前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持XEG_RT_REFLECTION_EXTENSION_NAME扩展时才可以使用光线追踪反射的相关接口。</span><p></p><div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// physicalDevice为Vulkan物理设备，用户需进行初始化</span></li><li>VkPhysicalDevice physicalDevice;</li><li><span class="hljs-comment">// 查询XEngine支持的Vulkan扩展列表</span></li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> propertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (propertyCount &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">properties</span><span class="hljs-params">(propertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, &amp;properties.<span class="hljs-built_in">front</span>()) == VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : properties) {</li><li>            supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 查询是否支持光线追踪反射特性</span></li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_RT_REFLECTION_EXTENSION_NAME) ==</li><li>    supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 错误;</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_RTReflection xegRTReflection;</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_creatertreflection" target="_blank">HMS_XEG_CreateRTReflection</a>接口，创建光线追踪反射实例。</span><p></p><div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建光线追踪反射实例所需的宽高信息为用户自定义参数，这里将以800*600的分辨率为例</span></li><li><span class="hljs-type">uint32_t</span> reflectWidth = <span class="hljs-number">800</span>;</li><li><span class="hljs-type">uint32_t</span> reflectHeight = <span class="hljs-number">600</span>;</li><li><span class="hljs-comment">// XEG_RTReflectionCreateInfo为创建xegRTReflection对象信息</span></li><li>XEG_RTReflectionCreateInfo xegRTReflectionCreateInfo;</li><li><span class="hljs-comment">// 指定是否开启快速求交模式。默认为0，表示不开启快速求交模式</span></li><li>xegRTReflectionCreateInfo.enableFastTrace = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 指定XEG_StructureType值，必须是XEG_STRUCTURE_TYPE_RT_REFLECTION_CREATE_INFO</span></li><li>xegRTReflectionCreateInfo.sType = XEG_STRUCTURE_TYPE_RT_REFLECTION_CREATE_INFO;</li><li><span class="hljs-comment">// 指定输入图像尺寸</span></li><li>pXegRTReflectionCreateInfo.renderSize = VkExtent2D{ reflectWidth, reflectHeight };</li><li>VkResult res = <span class="hljs-built_in">HMS_XEG_CreateRTReflection</span>(device, &amp;xegRTReflectionCreateInfo, &amp;xegRTReflection);</li><li><span class="hljs-keyword">if</span> (ret != VK_SUCCESS) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 错误</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtreflection" target="_blank">HMS_XEG_HMS_XEG_CmdRenderRTReflection</a>接口下发渲染命令，每帧都需要调用。</span><p></p><div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 反射渲染输入信息</span></li><li>XEG_RTReflectionDescription xegRTReflectionDescription;</li><li><span class="hljs-comment">// inputRayOriginImage为用户创建的光线原点图像的vkImageView</span></li><li>VkImageView inputRayOriginImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputRayDirectionImage为用户创建的光线方向图像的vkImageView</span></li><li>VkImageView inputRayDirectionImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// outputReflectionInfoImage为用户创建的用于记录光线追踪求交结果的vkImageView</span></li><li>VkImageView outputReflectionInfoImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// sceneTlas是场景的Top Level光线追踪加速结构</span></li><li>VkAccelerationStructureKHR sceneTlas = VK_NULL_HANDLE;</li><li>xegRTReflectionDescription.inputRayOriginImage = inputRayOriginImage;</li><li>xegRTReflectionDescription.inputRayDirectionImage = inputRayDirectionImage;</li><li>xegRTReflectionDescription.outputReflectionInfoImage = outputReflectionInfoImage;</li><li>xegRTReflectionDescription.accelerationStructure = sceneTlas;</li><li>xegRTReflectionDescription.rayMin = <span class="hljs-number">0.01</span>;</li><li>xegRTReflectionDescription.rayMax = <span class="hljs-number">1e10</span>;</li><li>xegRTReflectionDescription.sType = XEG_STRUCTURE_TYPE_RT_REFLECTION_DESCRIPTION;</li><li>xegRTReflectionDescription.reflectionCullMask = <span class="hljs-number">0xff</span>;</li><li><span class="hljs-comment">// commandBuffer为命令缓冲区，用户需进行初始化</span></li><li>VkCommandBuffer commandBuffer = VK_NULL_HANDLE;</li><li>VkResult res = <span class="hljs-built_in">HMS_XEG_CmdRenderRTReflection</span>(commandBuffer, xegRTReflection, &amp;xegRTReflectionDescription);</li><li><span class="hljs-keyword">if</span> (ret != VK_SUCCESS) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 错误</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_destroyrtreflection" target="_blank">HMS_XEG_HMS_XEG_DestroyRTReflection</a>接口销毁实例，释放资源，当特性不再使用或应用退出时需要调用。</span><p></p><div _ngcontent-ewi-c106="" class="highlight-div"><div _ngcontent-ewi-c106="" class="highlight-div-header"><div _ngcontent-ewi-c106="" class="highlight-div-header-left"><div _ngcontent-ewi-c106="" class="handle-button expand-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewi-c106="" class="highlight-div-header-right"><div _ngcontent-ewi-c106="" class="handle-button ai-button"></div><div _ngcontent-ewi-c106="" class="handle-button line-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewi-c106="" class="handle-button theme-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewi-c106="" class="handle-button copy-button"><div _ngcontent-ewi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewi-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (xegRTReflection) {</li><li>    <span class="hljs-built_in">HMS_XEG_DestroyRTReflection</span>(xegRTReflection);</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>