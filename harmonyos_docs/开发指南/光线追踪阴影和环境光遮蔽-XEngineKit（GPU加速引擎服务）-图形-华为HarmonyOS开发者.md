<h1 _ngcontent-xjp-c119="" class="doc-title ng-star-inserted" title="光线追踪阴影和环境光遮蔽"> 光线追踪阴影和环境光遮蔽 </h1>

<div _ngcontent-xjp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>XEngine VisibleMask特性提供开箱即用的光线追踪阴影和环境光遮蔽（Ray-Traced Shadow and AO）渲染能力。相比于这些效果的传统光线追踪实现方式，依托于华为马良GPU的软硬结合优化，XEngine支持FERT(Flexible Entry Raytracing)求交加速技术，可以减少光线与场景几何的求交计算次数，从而降低实现高画质光追效果时的GPU负载。此外，XEngine通过高度优化的时空域降噪技术，解决光线追踪渲染时因为光线数量不足而引入的噪声问题，可以在发射较少光线数的情况下达成高画质表现，实现同等画质GPU负载更轻，同等负载下画质更好的效果。</p> <div class="tiledSection"><h2 id="section624112515458">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section624112515458" tips="复制节点链接"></i></h2><ul><li>支持的设备类型：此特性依赖设备支持Vulkan光线追踪扩展<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_acceleration_structure.html" target="_blank">VK_KHR_acceleration_structure</a>、<a href="https://docs.vulkan.org/refpages/latest/refpages/source/VK_KHR_ray_query.html" target="_blank">VK_KHR_ray_query</a></li><li>可通过以下方式查询相关扩展特性是否支持：<p>对于Vulkan，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>扩展特性查询接口进行查询，如查询结果包含XEG_RT_SHADOW_AO_EXTENSION_NAME，则表示支持该特性，若查询结果未包含，则表示不支持该特性。</p> </li></ul> </div> <div class="tiledSection"><h2 id="section297614137247">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section297614137247" tips="复制节点链接"></i></h2><p>以下接口为使用光线追踪阴影和环境光遮蔽特性需要使用的接口，关于这些接口的详细说明见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine" target="_blank">接口文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_EnumerateDeviceExtensionProperties (VkPhysicalDevice physicalDevice, uint32_t * pPropertyCount, XEG_ExtensionProperties * pProperties)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>XEngine Vulkan扩展特性查询接口。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CreateRTVisibleMask (VkDevice device, const void *pCreateInfo, XEG_RTVisibleMask *pRTVisibleMask)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建XEG_RTVisibleMask对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CmdRenderRTVisibleMask (VkCommandBuffer commandBuffer, XEG_RTVisibleMask rtVisibleMask, const void *pDescription)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>录制光线追踪VisibleMask渲染命令。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_DestroyRTVisibleMask (XEG_RTVisibleMask rtVisibleMask)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁XEG_RTVisibleMask对象。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1171182142612">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1171182142612" tips="复制节点链接"></i></h2><p>本章以在Vulkan应用程序延迟渲染管线中集成为例，说明使用XEngine光线追踪阴影和环境光遮蔽特性的开发步骤。</p> </div> <div class="tiledSection"><h3 id="section79201052326" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section79201052326" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so需要依赖NDK中的XEngine相关库和头文件。</p> </div> <ul><li>头文件引用<div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_extension.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_rt_visible_mask.h&gt;</span></span></li></ol></pre></div></div> </li><li>CMakeLists.txt添加库依赖<p>CMakeLists.txt中添加对XEngine动态链接库依赖的代码如下。</p> <div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>    ...... <span class="hljs-comment">// 其他库文件</span></li><li>    ${xengine-lib})</li></ol></pre></div></div> </li></ul> <div class="tiledSection"><h3 id="section114231231174114">集成XEngine光线追踪阴影和环境光遮蔽（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section114231231174114" tips="复制节点链接"></i></h3><p>XEngine VisibleMask特性的光线追踪阴影（Ray-Traced Shadow，简称RTShadow）和环境光遮蔽（Ray-Traced AO，简称RTAO）效果API需要与Vulkan API延迟渲染管线配合使用。相关代码在Native层实现，渲染结果通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件显示到屏幕。</p> <p>在调用XEngine Kit特性接口前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询确认您的目标设备支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_enumeratedeviceextensionproperties" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持XEG_RT_SHADOW_AO_EXTENSION_NAME扩展时才可以使用光线追踪阴影和环境光遮蔽特性的接口。</span><p></p><div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// physicalDevice为当前应用程序的Vulkan物理设备，需用户进行初始化</span></li><li>VkPhysicalDevice physicalDevice;</li><li><span class="hljs-comment">// 查询XEngine支持的Vulkan扩展列表</span></li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> propertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (propertyCount &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">properties</span><span class="hljs-params">(propertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, &amp;properties.<span class="hljs-built_in">front</span>())</li><li>        == VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : properties) {</li><li>            supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 查询是否支持XEngine光线追踪阴影和环境光遮蔽特性</span></li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_RT_SHADOW_AO_EXTENSION_NAME)</li><li>    == supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 不支持时处理错误</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_RTVisibleMask rtVisibleMask;</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_creatertvisibleMask" target="_blank">HMS_XEG_CreateRTVisibleMask</a>接口，初始化实例句柄。</span><p></p><div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// RTShadow和RTAO初始化信息</span></li><li>XEG_RTShadowAOCreateInfo createInfo;</li><li>createInfo.sType = XEG_STRUCTURE_TYPE_RT_SHADOWAO_CREATE_INFO;</li><li>createInfo.pNext = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// GBuffer图像大小</span></li><li>createInfo.rtInputGbufferSize = {<span class="hljs-number">1280</span>, <span class="hljs-number">720</span>};</li><li><span class="hljs-comment">// 输出的RTShadow和RTAO图像大小，需要与GBuffer等比例</span></li><li>createInfo.rtShadowAOSize = {<span class="hljs-number">640</span>, <span class="hljs-number">360</span>};</li><li>createInfo.enableRTShadow = <span class="hljs-literal">true</span>;</li><li>createInfo.enableRTAO = <span class="hljs-literal">true</span>;</li><li><span class="hljs-comment">// 去噪器质量模式设置为平衡模式</span></li><li>createInfo.denoiseMode = XEG_DENOISE_QUALITY_MODE_BALANCED;</li><li><span class="hljs-comment">// 场景遍历模式设置为性能模式</span></li><li>createInfo.traversalMode = XEG_TRAVERSAL_MODE_PERFORMANCES;</li><li>createInfo.aoOnlyInShadow = <span class="hljs-literal">false</span>;</li><li>createInfo.reverseZ = <span class="hljs-literal">false</span>;</li><li>VkResult ret = <span class="hljs-built_in">HMS_XEG_CreateRTVisibleMask</span>(device, &amp;createInfo, &amp;rtVisibleMask);</li><li><span class="hljs-keyword">if</span> (ret != VK_SUCCESS) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 错误</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdrenderrtvisibleMask" target="_blank">HMS_XEG_CmdRenderRTVisibleMask</a>接口执行渲染命令，每帧都需要调用。</span><p></p><div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// RTShadow算法参数设置</span></li><li>XEG_RTShadowParameters shadowParameters;</li><li><span class="hljs-comment">// RTAO算法参数设置</span></li><li>XEG_RTAOParameters aoParameters;</li><li><span class="hljs-comment">// 去噪器参数设置</span></li><li>XEG_RTShadowAODenoiserParameters denoiserParameters;</li><li><span class="hljs-comment">// RTShadow和RTAO渲染输入信息</span></li><li>XEG_RTShadowAODescription description;</li><li><span class="hljs-comment">// 光线求交只考虑不透明物体</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> gl_RayFlagsOpaqueEXT = <span class="hljs-number">1U</span>;</li><li><span class="hljs-comment">// 在找到第一个相交点时即停止光线求交查询</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> gl_RayFlagsTerminateOnFirstHitEXT = <span class="hljs-number">4U</span>;</li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> rayFlags = (gl_RayFlagsOpaqueEXT | gl_RayFlagsTerminateOnFirstHitEXT) &lt;&lt; <span class="hljs-number">8</span>;</li><li>
</li><li>shadowParameters.rayTMax = <span class="hljs-number">200.0f</span>;</li><li>shadowParameters.rayTMin = <span class="hljs-number">1.0f</span>;</li><li>shadowParameters.sunDirection[<span class="hljs-number">0</span>] = <span class="hljs-number">0.1</span>;</li><li>shadowParameters.sunDirection[<span class="hljs-number">1</span>] = <span class="hljs-number">0.1</span>;</li><li>shadowParameters.sunDirection[<span class="hljs-number">2</span>] = <span class="hljs-number">0.1</span>;</li><li>shadowParameters.raySourceAngleInDegree = <span class="hljs-number">0.35f</span>;</li><li>shadowParameters.shadowCullMask = rayFlags | <span class="hljs-number">0xFF</span>;</li><li>shadowParameters.shadowCullDistance = <span class="hljs-number">2000.0f</span>;</li><li>
</li><li>aoParameters.rayTMax = <span class="hljs-number">30.0f</span>;</li><li>aoParameters.rayTMin = <span class="hljs-number">0.1f</span>;</li><li>aoParameters.aoIntensity = <span class="hljs-number">0.8f</span>;</li><li>aoParameters.aoNormalBias = <span class="hljs-number">0.5f</span>;</li><li>aoParameters.aoCullMask = rayFlags | <span class="hljs-number">0xFF</span>;</li><li>aoParameters.aoCullDistance = <span class="hljs-number">2000.0f</span>;</li><li>
</li><li>denoiserParameters.temporalBlendFactor = <span class="hljs-number">0.75f</span>;</li><li>denoiserParameters.positionConstantDistance = <span class="hljs-number">5.0f</span>;</li><li>denoiserParameters.spatialDenoiseTimes = <span class="hljs-number">2</span>;</li><li>denoiserParameters.ghostingAlpha = <span class="hljs-number">0.5</span>;</li><li>denoiserParameters.spatialNormalWeight = <span class="hljs-number">0.0f</span>;</li><li>denoiserParameters.spatialMaxKernelStep = <span class="hljs-number">1</span>;</li><li>
</li><li>description.sType = XEG_STRUCTURE_TYPE_RT_SHADOWAO_DESCRIPTION;</li><li>description.pNext = <span class="hljs-literal">nullptr</span>;</li><li>description.worldCameraOrigin[<span class="hljs-number">0</span>] = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 以相机实际位置的x坐标为准</span></li><li>description.worldCameraOrigin[<span class="hljs-number">1</span>] = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 以相机实际位置的y坐标为准</span></li><li>description.worldCameraOrigin[<span class="hljs-number">2</span>] = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 以相机实际位置的z坐标为准</span></li><li><span class="hljs-comment">// gBufferDepth是GBuffer深度图像的VkImageView，需要用户进行初始化</span></li><li>VkImageView gBufferDepth;</li><li>description.inputDepthImage = gBufferDepth;</li><li><span class="hljs-comment">// gBufferNormal是GBuffer法线图像的VkImageView，需要用户进行初始化，关于法线的格式和编码详见API参考</span></li><li>VkImageView gBufferNormal;</li><li>description.inputNormalImage = gBufferNormal;</li><li><span class="hljs-comment">// outputShadowAOView是保存XEngine RTShadow和RTAO渲染输出的VkImageView，需要用户进行初始化</span></li><li>VkImageView outputShadowAOView;</li><li>description.outputShadowAOImage = outputShadowAOView;</li><li><span class="hljs-comment">// sceneTlas是场景的Top Level光线追踪加速结构，需要用户进行初始化</span></li><li>VkAccelerationStructureKHR sceneTlas;</li><li>description.accelerationStructure = sceneTlas;</li><li><span class="hljs-type">float</span> viewMatrix[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 相机观察矩阵，需要用户进行初始化</span></li><li><span class="hljs-type">float</span> projectionMatrix[<span class="hljs-number">16</span>]; <span class="hljs-comment">//相机观察矩阵，需要用户进行初始化</span></li><li><span class="hljs-built_in">memcpy</span>(description.viewMatrix, viewMatrix, <span class="hljs-built_in">sizeof</span>(viewMatrix));</li><li><span class="hljs-built_in">memcpy</span>(description.projectionMatrix, projectionMatrix, <span class="hljs-built_in">sizeof</span>(projectionMatrix));</li><li>VkCommandBuffer vkCommandBuffer; <span class="hljs-comment">// Vulkan命令缓冲区，需要用户进行初始化</span></li><li>VkResult ret = <span class="hljs-built_in">HMS_XEG_CmdRenderRTVisibleMask</span>(vkCommandBuffer, rtVisibleMask, &amp;description);</li><li><span class="hljs-keyword">if</span> (ret != VK_SUCCESS) {</li><li>    <span class="hljs-comment">// 渲染命令执行错误</span></li><li>}</li><li><span class="hljs-comment">// 设置pipeline barrier以同步对RTShadow和RTAO渲染输出的写和读</span></li><li>VkImageMemoryBarrier imageMemoryBarrier;</li><li>imageMemoryBarrier.sType = VK_STRUCTURE_TYPE_IMAGE_MEMORY_BARRIER;</li><li>imageMemoryBarrier.pNext = <span class="hljs-literal">nullptr</span>;</li><li>imageMemoryBarrier.srcAccessMask = VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT;</li><li>imageMemoryBarrier.dstAccessMask = VK_ACCESS_COLOR_ATTACHMENT_READ_BIT; <span class="hljs-comment">// 根据实际访问方式设置</span></li><li>imageMemoryBarrier.oldLayout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;</li><li>imageMemoryBarrier.newLayout = VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL;</li><li>imageMemoryBarrier.srcQueueFamilyIndex = VK_QUEUE_FAMILY_IGNORED;</li><li>imageMemoryBarrier.dstQueueFamilyIndex = VK_QUEUE_FAMILY_IGNORED;</li><li>VkImage outputShadowAOImage; <span class="hljs-comment">// outputShadowAO是保存RTShadow和RTAO渲染输出的VkImage，需要用户进行初始化</span></li><li>imageMemoryBarrier.image = outputShadowAOImage; </li><li>imageMemoryBarrier.subresourceRange = { VK_IMAGE_ASPECT_COLOR_BIT, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> };</li><li><span class="hljs-built_in">vkCmdPipelineBarrier</span>(commandBuffer, </li><li>    VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT, </li><li>    VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT, <span class="hljs-comment">// 根据实际访问stage设置</span></li><li>    <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, &amp;imageMemoryBarrier);</li><li>
</li></ol></pre></div></div> <p>应用RTShadow和RTAO输出的outputShadowAOImage贴图到光照计算过程中，计算着色点颜色时的Shader示例：</p> <div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// lighting_pass.frag code</span></li><li><span class="hljs-built_in">layout</span> (binding = <span class="hljs-number">0</span>) uniform sampler2D textureRayTracingOutputShadowAO;</li><li>
</li><li><span class="hljs-comment">// color为当前着色点不考虑阴影和环境光遮蔽时的颜色值</span></li><li>vec3 color;</li><li><span class="hljs-comment">// 用户的着色点颜色计算过程...</span></li><li><span class="hljs-comment">// 应用RTShadow和RTAO至最终光照结果</span></li><li>vec2 shadowAO = <span class="hljs-built_in">texture</span>(textureRayTracingOutputShadowAO, TexCoords).xy;</li><li><span class="hljs-type">float</span> shadow = shadowAO.x;</li><li><span class="hljs-type">float</span> ao = shadowAO.y;</li><li>vec3 finalColor = color * <span class="hljs-built_in">pow</span>(ao, <span class="hljs-number">2.0</span>) * shadow; <span class="hljs-comment">// finalColor为最终颜色值</span></li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_destroyrtvisibleMask" target="_blank">HMS_XEG_DestroyRTVisibleMask</a>接口销毁特性实例句柄以释放资源，在不需要再使用特性或应用退出时需要调用。</span><p></p><div _ngcontent-xjp-c106="" class="highlight-div"><div _ngcontent-xjp-c106="" class="highlight-div-header"><div _ngcontent-xjp-c106="" class="highlight-div-header-left"><div _ngcontent-xjp-c106="" class="handle-button expand-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xjp-c106="" class="highlight-div-header-right"><div _ngcontent-xjp-c106="" class="handle-button ai-button"></div><div _ngcontent-xjp-c106="" class="handle-button line-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xjp-c106="" class="handle-button theme-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xjp-c106="" class="handle-button copy-button"><div _ngcontent-xjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xjp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">HMS_XEG_DestroyRTVisibleMask</span>(rtVisibleMask);</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>