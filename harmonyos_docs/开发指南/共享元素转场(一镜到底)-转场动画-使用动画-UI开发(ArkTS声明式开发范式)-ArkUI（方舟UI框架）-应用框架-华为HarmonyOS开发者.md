<h1 _ngcontent-djy-c119="" class="doc-title ng-star-inserted" title="共享元素转场 (一镜到底)"> 共享元素转场 (一镜到底) </h1>

<div _ngcontent-djy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>共享元素转场是一种界面切换时对相同或者相似的两个元素做的一种位置和大小匹配的过渡动画效果，也称一镜到底动效。</p>    <p>如下例所示，在点击图片后，该图片消失，同时在另一个位置出现新的图片，二者之间内容相同，可以对它们添加一镜到底动效。左图为不添加一镜到底动效的效果，右图为添加一镜到底动效的效果，一镜到底的效果能够让二者的出现消失产生联动，使得内容切换过程显得灵动自然而不生硬。</p>    <div class="tbBox"><table class="simpletableborder">           <tbody><tr>       <td valign="top"><span><img originheight="202" originwidth="238" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.54023075453133415382604990839312:50001231000000:2800:0946342056FE7AE8BABC81E3287BBACADB65B0BA5C47A20216BE1F840BAA6DFB.gif" class="notEnlarge" width="238" height="202"></span></td>       <td valign="top"><span><img originheight="202" originwidth="238" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.59652697328675262857640116801717:50001231000000:2800:CC99C9CAE017D846624B8684DABDB3B6D2BD4E1F030D4EA8BB222745B19FC9C0.gif" class="notEnlarge" width="238" height="202"></span></td>      </tr>         </tbody></table></div>    <p>一镜到底的动效有多种实现方式，在实际开发过程中，应根据具体场景选择合适的方法进行实现。</p>    <p>以下是不同实现方式的对比：</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.4.1.1" valign="top" width="33.33333333333333%">一镜到底实现方式</th>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.4.1.2" valign="top" width="33.33333333333333%">特点</th>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.4.1.3" valign="top" width="33.33333333333333%">适用场景</th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="33.33333333333333%">不新建容器直接变化原容器</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">不发生路由跳转，需要在一个组件中实现展开及关闭两种状态的布局，展开后组件层级不变。</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">适用于转场开销小的简单场景，如点开页面无需加载大量数据及组件。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="33.33333333333333%">新建容器并跨容器迁移组件</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">通过使用NodeController，将组件从一个容器迁移到另一个容器，在开始迁移时，需要根据前后两个布局的位置大小等信息对组件添加位移及缩放，确保迁移开始时组件能够对齐初始布局，避免出现视觉上的跳变现象。之后再添加动画将位移及缩放等属性复位，实现组件从初始布局到目标布局的一镜到底过渡效果。</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">适用于新建对象开销大的场景，如视频直播组件点击转为全屏等。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="33.33333333333333%">使用geometryTransition共享元素转场</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">利用系统能力，转场前后两个组件调用geometryTransition接口绑定同一id，同时将转场逻辑置于animateTo动画闭包内，这样系统侧会自动为二者添加一镜到底的过渡效果。</td>        <td class="cellrowborder" valign="top" width="33.33333333333333%">系统将调整绑定的两个组件的宽高及位置至相同值，并切换二者的透明度，以实现一镜到底过渡效果。因此，为了实现流畅的动画效果，需要确保对绑定geometryTransition的节点添加宽高动画不会有跳变。此方式适用于创建新节点开销小的场景。</td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="不新建容器并直接变化原容器">不新建容器并直接变化原容器<i class="anchor-icon anchor-icon-link" anchorid="不新建容器并直接变化原容器" tips="复制节点链接"></i></h2>          <p>该方法不新建容器，通过在已有容器上增删组件触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-transition-animation-component" target="_blank">transition</a>，搭配组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-attribute-animation-apis">属性动画</a>实现一镜到底效果。</p>     <p>对于同一个容器展开，容器内兄弟组件消失或者出现的场景，可通过对同一个容器展开前后进行宽高位置变化并配置属性动画，对兄弟组件配置出现消失转场动画实现一镜到底效果。基本步骤为：</p>     <ol>      <li>       <p>构建需要展开的页面，并通过状态变量构建好普通状态和展开状态的界面。</p></li>      <li>       <p>将需要展开的页面展开，通过状态变量控制兄弟组件消失或出现，并通过绑定出现消失转场实现兄弟组件转场效果。</p></li>     </ol>     <p>以点击卡片后显示卡片内容详情场景为例：</p>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PostData</span> {</li><li>  <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-attr">avatar</span>: <span class="hljs-title class_">Resource</span> = $r(<span class="hljs-string">'app.media.flower'</span>);</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">images</span>: <span class="hljs-title class_">Resource</span>[] = [];</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isExpand</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onItemClicked'</span>) <span class="hljs-attr">selectedIndex</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// 数组中图片均使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">allPostData</span>: <span class="hljs-title class_">PostData</span>[] = [</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.flower'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'天气晴朗'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.spring'</span>), $r(<span class="hljs-string">'app.media.tree'</span>)] },</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.sky'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'你好世界'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.island'</span>)] },</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.tree'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Carl'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'万物生长'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.flower'</span>), $r(<span class="hljs-string">'app.media.sky'</span>), $r(<span class="hljs-string">'app.media.spring'</span>)] }];</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onItemClicked</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> &lt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span></li><li>    }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span>;</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">allPostData</span>, <span class="hljs-function">(<span class="hljs-params">postData: PostData, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 当点击了某个post后，会使其余的post消失下树</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> === index) {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Post</span>({ <span class="hljs-attr">data</span>: postData, <span class="hljs-attr">selectedIndex</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span>, <span class="hljs-attr">index</span>: index })</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          <span class="hljs-comment">// 对出现消失的post添加透明度转场和位移转场效果</span></li><li>          .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">y</span>: index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> ? -<span class="hljs-number">250</span> : <span class="hljs-number">250</span> }))</li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span>}))</li><li>        }</li><li>      }, <span class="hljs-function">(<span class="hljs-params">postData: PostData, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#40808080'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct  <span class="hljs-title class_">Post</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">selectedIndex</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">PostData</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">itemHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">250</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isExpand</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">expandImageSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">avatarSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">avatar</span>)</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span> })</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span> / <span class="hljs-number">2</span>)</li><li>          .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">name</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">15</span> }) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">images</span>, <span class="hljs-function">(<span class="hljs-params">imageResource: Resource, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Image</span>(imageResource)</li><li>            .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">expandImageSize</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">expandImageSize</span> })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">imageResource: Resource, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 展开态下组件增加的内容</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'评论区'</span>)</li><li>            <span class="hljs-comment">// 对评论区文本添加出现消失转场效果</span></li><li>            .<span class="hljs-title function_">transition</span>( <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>              .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span> }))</li><li>            .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">asymmetric</span>(</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.99</span>)</li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span> }),</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> })</li><li>        ))</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>})</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span> })</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> = -<span class="hljs-number">1</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>,</li><li>        <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span></li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 对展开的post做宽高动画，并对头像尺寸和图片尺寸加动画</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> ? <span class="hljs-number">780</span> : <span class="hljs-number">250</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> ? <span class="hljs-number">75</span>: <span class="hljs-number">50</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">expandImageSize</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpand</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">images</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)</li><li>          ? (<span class="hljs-number">360</span> - (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">images</span>.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>) * <span class="hljs-number">15</span>) / <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">images</span>.<span class="hljs-property">length</span> : <span class="hljs-number">100</span>;</li><li>      })</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="630" originwidth="290" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.46014245679821834336805890099981:50001231000000:2800:16890DFC63E1F9D119D02C3BF4160B164248A552F1717289B81D99264DFE8F27.gif" class="notEnlarge" width="290" height="630"></span></p>    </div>    <div class="tiledSection">     <h2 id="新建容器并跨容器迁移组件">新建容器并跨容器迁移组件<i class="anchor-icon anchor-icon-link" anchorid="新建容器并跨容器迁移组件" tips="复制节点链接"></i></h2>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-place-holder">自定义占位节点</a>，利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>实现组件的跨节点迁移，配合属性动画给组件的迁移过程赋予一镜到底效果。这种一镜到底的实现方式可以结合多种转场方式使用，如导航转场（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation" target="_blank">Navigation</a>）、半模态转场（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#bindsheet" target="_blank">bindSheet</a>）等。</p>    </div>    <div class="tiledSection">     <h3 id="结合stack使用" class="firsth2">结合Stack使用<i class="anchor-icon anchor-icon-link" anchorid="结合stack使用" tips="复制节点链接"></i></h3>          <p>可以利用Stack内后定义组件在最上方的特性控制组件在跨节点迁移后位z序最高，以展开收起卡片的场景为例，实现步骤为：</p>     <ul>      <li>       <p>展开卡片时，获取节点A的位置信息，将其中的组件迁移到与节点A位置一致的节点B处，节点B的层级高于节点A。</p></li>      <li>       <p>对节点B添加属性动画，使之展开并运动到展开后的位置，完成一镜到底的动画效果。</p></li>      <li>       <p>收起卡片时，对节点B添加属性动画，使之收起并运动到收起时的位置，即节点A的位置，实现一镜到底的动画效果。</p></li>      <li>       <p>在动画结束时利用回调将节点B中的组件迁移回节点A处。</p></li>     </ul>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { createPostNode, getPostNode, <span class="hljs-title class_">PostNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./PostNode"</span>;</li><li><span class="hljs-keyword">import</span> { componentUtils, curves, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// 新建一镜到底动画类</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">animationProperties</span>: <span class="hljs-title class_">AnimationProperties</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationProperties</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listArray</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 卡片折叠态，展开态的共同父组件</span></li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listArray</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-comment">// 卡片折叠态</span></li><li>            <span class="hljs-title class_">PostItem</span>({ <span class="hljs-attr">index</span>: item, <span class="hljs-attr">animationProperties</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span> })</li><li>          }</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">false</span>)</li><li>      .<span class="hljs-title function_">alignListItem</span>(<span class="hljs-title class_">ListItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">isExpandPageShow</span>) {</li><li>        <span class="hljs-comment">// 卡片展开态</span></li><li>        <span class="hljs-title class_">ExpandPage</span>({ <span class="hljs-attr">animationProperties</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span> })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">key</span>(<span class="hljs-string">'rootStack'</span>)</li><li>    .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">isEnabled</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PostItem</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span></li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">animationProperties</span>: <span class="hljs-title class_">AnimationProperties</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">nodeController</span>: <span class="hljs-title class_">PostNode</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-comment">// 折叠时详细内容隐藏</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">showDetailContent</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> = <span class="hljs-title function_">createPostNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>(), <span class="hljs-variable language_">this</span>.<span class="hljs-property">showDetailContent</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 设置回调，当卡片从展开态回到折叠态时触发</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">setCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetNode</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">resetNode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> = <span class="hljs-title function_">getPostNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>());</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>    .<span class="hljs-title function_">key</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>())</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-comment">// 卡片从折叠态节点下树</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">onRemove</span>();</li><li>      }</li><li>      <span class="hljs-comment">// 触发卡片从折叠到展开态的动画</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-title function_">expandAnimation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>);</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ExpandPage</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">animationProperties</span>: <span class="hljs-title class_">AnimationProperties</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">nodeController</span>: <span class="hljs-title class_">PostNode</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-comment">// 展开时详细内容出现</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">showDetailContent</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 获取对应序号的卡片组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> = <span class="hljs-title function_">getPostNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">curIndex</span>.<span class="hljs-title function_">toString</span>())</li><li>    <span class="hljs-comment">// 更新为详细内容出现</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>?.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">curIndex</span>.<span class="hljs-title function_">toString</span>(), <span class="hljs-variable language_">this</span>.<span class="hljs-property">showDetailContent</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">changedHeight</span> ? <span class="hljs-string">'100%'</span> : <span class="hljs-number">100</span>)</li><li>    .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateY</span> })</li><li>    .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">positionX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">positionY</span> })</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">springMotion</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.9</span>),</li><li>        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-comment">// 执行回调，折叠态节点获取卡片组件</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">callCallback</span>();</li><li>            <span class="hljs-comment">// 当前展开态节点的卡片组件下树</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">onRemove</span>();</li><li>          }</li><li>          <span class="hljs-comment">// 卡片展开态节点下树</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">isExpandPageShow</span> = <span class="hljs-literal">false</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>;</li><li>        }</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 卡片从展开态回到折叠态</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateX</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateY</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">changedHeight</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-comment">// 更新为详细内容消失</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>?.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">curIndex</span>.<span class="hljs-title function_">toString</span>(), <span class="hljs-literal">false</span>);</li><li>      })</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">RectInfo</span> {</li><li>  <span class="hljs-attr">left</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">right</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 封装的一镜到底动画类</span></li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationProperties</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">isExpandPageShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// 控制组件是否响应点击事件</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">isEnabled</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-comment">// 展开卡片的序号</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">curIndex</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">positionX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">positionY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">changedHeight</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">calculatedTranslateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">calculatedTranslateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 设置卡片展开后相对父组件的位置</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">expandTranslateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">expandTranslateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span> = uiContext</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">expandAnimation</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 记录展开态卡片的序号</span></li><li>    <span class="hljs-keyword">if</span> (index != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">curIndex</span> = index;</li><li>    }</li><li>    <span class="hljs-comment">// 计算折叠态卡片相对父组件的位置</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateData</span>(index.<span class="hljs-title function_">toString</span>());</li><li>    <span class="hljs-comment">// 展开态卡片上树</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpandPageShow</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-comment">// 卡片展开的属性动画</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>?.<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">springMotion</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.9</span>)</li><li>    }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculatedTranslateX</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculatedTranslateY</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">changedHeight</span> = <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取需要跨节点迁移的组件的位置，及迁移前后节点的公共父节点的位置，用以计算做动画组件的动画参数</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">calculateData</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> clickedImageInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, key);</li><li>    <span class="hljs-keyword">let</span> rootStackInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, <span class="hljs-string">'rootStack'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positionX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(clickedImageInfo.<span class="hljs-property">left</span> - rootStackInfo.<span class="hljs-property">left</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positionY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(clickedImageInfo.<span class="hljs-property">top</span> - rootStackInfo.<span class="hljs-property">top</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculatedTranslateX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(rootStackInfo.<span class="hljs-property">left</span> - clickedImageInfo.<span class="hljs-property">left</span>) + <span class="hljs-variable language_">this</span>.<span class="hljs-property">expandTranslateX</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculatedTranslateY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(rootStackInfo.<span class="hljs-property">top</span> - clickedImageInfo.<span class="hljs-property">top</span>) + <span class="hljs-variable language_">this</span>.<span class="hljs-property">expandTranslateY</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 根据组件的id获取组件的位置信息</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">RectInfo</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">componentInfo</span>: componentUtils.<span class="hljs-property">ComponentInfo</span> = context.<span class="hljs-title function_">getComponentUtils</span>().<span class="hljs-title function_">getRectangleById</span>(id);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!componentInfo) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'object is empty'</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">rstRect</span>: <span class="hljs-title class_">RectInfo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectInfo</span>();</li><li>    <span class="hljs-keyword">const</span> widthScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span>) / <span class="hljs-number">2</span>;</li><li>    <span class="hljs-keyword">const</span> heightScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span>) / <span class="hljs-number">2</span>;</li><li>    rstRect.<span class="hljs-property">left</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + widthScaleGap;</li><li>    rstRect.<span class="hljs-property">top</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + heightScaleGap;</li><li>    rstRect.<span class="hljs-property">right</span> =</li><li>    componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - widthScaleGap;</li><li>    rstRect.<span class="hljs-property">bottom</span> =</li><li>    componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> - heightScaleGap;</li><li>    rstRect.<span class="hljs-property">width</span> = rstRect.<span class="hljs-property">right</span> - rstRect.<span class="hljs-property">left</span>;</li><li>    rstRect.<span class="hljs-property">height</span> = rstRect.<span class="hljs-property">bottom</span> - rstRect.<span class="hljs-property">top</span>;</li><li>
</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">left</span>: rstRect.<span class="hljs-property">left</span>,</li><li>      <span class="hljs-attr">right</span>: rstRect.<span class="hljs-property">right</span>,</li><li>      <span class="hljs-attr">top</span>: rstRect.<span class="hljs-property">top</span>,</li><li>      <span class="hljs-attr">bottom</span>: rstRect.<span class="hljs-property">bottom</span>,</li><li>      <span class="hljs-attr">width</span>: rstRect.<span class="hljs-property">width</span>,</li><li>      <span class="hljs-attr">height</span>: rstRect.<span class="hljs-property">height</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PostNode.ets</span></li><li><span class="hljs-comment">// 跨容器迁移能力</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span>, curves, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> {</li><li>  <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span></li><li>  <span class="hljs-attr">isExpand</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">PostBuilder</span>(<span class="hljs-params">data: Data</span>) {</li><li>  <span class="hljs-comment">// 跨容器迁移组件置于@Builder内</span></li><li>  <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Row</span>()</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'点击展开 Item '</span> + data.<span class="hljs-property">item</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'共享元素转场'</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-number">0x909399</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceAround</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span> })</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>      <span class="hljs-comment">// 展开后显示细节内容</span></li><li>      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">isExpand</span>) {</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'展开态'</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">28</span>)</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-number">0x909399</span>)</li><li>            .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>            .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">springMotion</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.9</span>) }))</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">15</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>    .<span class="hljs-title function_">shadow</span>({</li><li>      <span class="hljs-attr">radius</span>: <span class="hljs-number">20</span>,</li><li>      <span class="hljs-attr">color</span>: <span class="hljs-number">0x909399</span>,</li><li>      <span class="hljs-attr">offsetX</span>: <span class="hljs-number">20</span>,</li><li>      <span class="hljs-attr">offsetY</span>: <span class="hljs-number">10</span></li><li>    })</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">__InternalValue__</span> {</li><li>  <span class="hljs-attr">flag</span>:<span class="hljs-built_in">boolean</span> =<span class="hljs-literal">false</span>;</li><li>};</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">node</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Data</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isRemove</span>: __InternalValue__ = <span class="hljs-keyword">new</span> <span class="hljs-title function_">__InternalValue__</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Function</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Data</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span></li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span>.<span class="hljs-property">flag</span> == <span class="hljs-literal">true</span>){</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">uiContext: UIContext, id: <span class="hljs-built_in">string</span>, isExpand: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建节点，需要uiContext</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext)</li><li>    <span class="hljs-comment">// 创建离线组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = { <span class="hljs-attr">item</span>: id, <span class="hljs-attr">isExpand</span>: isExpand }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;<span class="hljs-title class_">Data</span>[]&gt;(<span class="hljs-title class_">PostBuilder</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">update</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, isExpand: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 调用update进行更新。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = { <span class="hljs-attr">item</span>: id, <span class="hljs-attr">isExpand</span>: isExpand }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setCallback</span>(<span class="hljs-params">callback: <span class="hljs-built_in">Function</span> | <span class="hljs-literal">undefined</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = callback</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">callCallback</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRemove</span>(<span class="hljs-params"></span>){</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span>.<span class="hljs-property">flag</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-comment">// 组件迁移出节点时触发重建</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuild</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span>.<span class="hljs-property">flag</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gNodeMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">PostNode</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createPostNode =</li><li>  (<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">isExpand</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-title class_">PostNode</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostNode</span>();</li><li>    node.<span class="hljs-title function_">init</span>(uiContext, id, isExpand);</li><li>    gNodeMap.<span class="hljs-title function_">set</span>(id, node);</li><li>    <span class="hljs-keyword">return</span> node;</li><li>  }</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getPostNode = (<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">PostNode</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!gNodeMap.<span class="hljs-title function_">has</span>(id)) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> gNodeMap.<span class="hljs-title function_">get</span>(id);</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteNode</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt; {</li><li>  gNodeMap.<span class="hljs-title function_">delete</span>(id)</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="699" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.56659623156640653772694632056208:50001231000000:2800:E91252B7F3DF85CE9CD14D0CD3CD25A819D9778771F7B0FE83D32E667EAEEDFA.gif" width="337" height="699"></span></p>    </div>    <div class="tiledSection">     <h3 id="结合navigation使用">结合Navigation使用<i class="anchor-icon anchor-icon-link" anchorid="结合navigation使用" tips="复制节点链接"></i></h3>          <p>可以利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation" target="_blank">Navigation</a>的自定义导航转场动画能力（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#customnavcontenttransition11" target="_blank">customNavContentTransition</a>，可参考Navigation<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#示例3设置可交互转场动画" target="_blank">示例3</a>）实现一镜到底动效。共享元素转场期间，组件由消失页面迁移至出现页面。</p>     <p>以展开收起缩略图的场景为例，实现步骤为：</p>     <ul>      <li>       <p>通过customNavContentTransition配置PageOne与PageTwo的自定义导航转场动画。</p></li>      <li>       <p>自定义的共享元素转场效果由属性动画实现，具体实现方式为抓取页面内组件相对窗口的位置信息从而正确匹配组件在PageOne与PageTwo的位置、缩放等，即动画开始和结束的属性信息。</p></li>      <li>       <p>点击缩略图后共享元素组件从PageOne被迁移至PageTwo，随后触发由PageOne至PageTwo的自定义转场动画，即PageTwo的共享元素组件从原来的缩略图状态做动画到全屏状态。</p></li>      <li>       <p>由全屏状态返回到缩略图时，触发由PageTwo至PageOne的自定义转场动画，即PageTwo的共享元素组件从全屏状态做动画到原PageOne的缩略图状态，转场结束后共享元素组件从PageTwo被迁移回PageOne。</p></li>     </ul>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li>├──<span class="hljs-selector-tag">entry</span>/<span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">ets</span>                 <span class="hljs-comment">// 代码区</span></li><li>│  ├──<span class="hljs-selector-tag">CustomTransition</span></li><li>│  │  ├──<span class="hljs-selector-tag">AnimationProperties</span><span class="hljs-selector-class">.ets</span>      <span class="hljs-comment">// 一镜到底转场动画封装</span></li><li>│  │  └──<span class="hljs-selector-tag">CustomNavigationUtils</span><span class="hljs-selector-class">.ets</span>    <span class="hljs-comment">// Navigation自定义转场动画配置</span></li><li>│  ├──<span class="hljs-selector-tag">entryability</span></li><li>│  │  └──<span class="hljs-selector-tag">EntryAbility</span><span class="hljs-selector-class">.ets</span>             <span class="hljs-comment">// 程序入口类</span></li><li>│  ├──<span class="hljs-selector-tag">NodeContainer</span></li><li>│  │  └──<span class="hljs-selector-tag">CustomComponent</span><span class="hljs-selector-class">.ets</span>          <span class="hljs-comment">// 自定义占位节点</span></li><li>│  ├──<span class="hljs-selector-tag">pages</span></li><li>│  │  ├──<span class="hljs-selector-tag">Index</span><span class="hljs-selector-class">.ets</span>                    <span class="hljs-comment">// 导航页面</span></li><li>│  │  ├──<span class="hljs-selector-tag">PageOne</span><span class="hljs-selector-class">.ets</span>                  <span class="hljs-comment">// 缩略图页面</span></li><li>│  │  └──<span class="hljs-selector-tag">PageTwo</span><span class="hljs-selector-class">.ets</span>                  <span class="hljs-comment">// 全屏展开页面</span></li><li>│  └──<span class="hljs-selector-tag">utils</span></li><li>│     ├──<span class="hljs-selector-tag">ComponentAttrUtils</span><span class="hljs-selector-class">.ets</span>       <span class="hljs-comment">// 组件位置获取</span></li><li>│     └──<span class="hljs-selector-tag">WindowUtils</span><span class="hljs-selector-class">.ets</span>              <span class="hljs-comment">// 窗口信息</span></li><li>└──<span class="hljs-selector-tag">entry</span>/<span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">resources</span>           <span class="hljs-comment">// 资源文件</span></li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AnimateCallback</span>, <span class="hljs-title class_">CustomTransition</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../CustomTransition/CustomNavigationUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Index'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-comment">// 允许进行自定义转场的页面名称</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">allowedCustomTransitionFromPageName</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'PageOne'</span>];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">allowedCustomTransitionToPageName</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'PageTwo'</span>];</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'PageOne'</span> });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isCustomTransitionEnabled</span>(<span class="hljs-attr">fromName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">toName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-comment">// 点击和返回均需要进行自定义转场，因此需要分别判断</span></li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">allowedCustomTransitionFromPageName</span>.<span class="hljs-title function_">includes</span>(fromName)</li><li>      &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">allowedCustomTransitionToPageName</span>.<span class="hljs-title function_">includes</span>(toName))</li><li>      || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">allowedCustomTransitionFromPageName</span>.<span class="hljs-title function_">includes</span>(toName)</li><li>        &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">allowedCustomTransitionToPageName</span>.<span class="hljs-title function_">includes</span>(fromName))) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>)</li><li>      .<span class="hljs-title function_">hideNavBar</span>(<span class="hljs-literal">true</span>)</li><li>      .<span class="hljs-title function_">customNavContentTransition</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">from</span>: NavContentInfo, to: NavContentInfo, operation: NavigationOperation</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> ((!<span class="hljs-keyword">from</span> || !to) || (!<span class="hljs-keyword">from</span>.<span class="hljs-property">name</span> || !to.<span class="hljs-property">name</span>)) {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 通过from和to的name对自定义转场路由进行管控</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isCustomTransitionEnabled</span>(<span class="hljs-keyword">from</span>.<span class="hljs-property">name</span>, to.<span class="hljs-property">name</span>)) {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 需要对转场页面是否注册了animation进行判断，来决定是否进行自定义转场</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">fromParam</span>: <span class="hljs-title class_">AnimateCallback</span> = <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getAnimateParam</span>(<span class="hljs-keyword">from</span>.<span class="hljs-property">index</span>);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">toParam</span>: <span class="hljs-title class_">AnimateCallback</span> = <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getAnimateParam</span>(to.<span class="hljs-property">index</span>);</li><li>        <span class="hljs-keyword">if</span> (!fromParam.<span class="hljs-property">animation</span> || !toParam.<span class="hljs-property">animation</span>) {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 一切判断完成后，构造customAnimation给系统侧调用，执行自定义转场动画</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">customAnimation</span>: <span class="hljs-title class_">NavigationAnimatedTransition</span> = {</li><li>          <span class="hljs-attr">onTransitionEnd</span>: <span class="hljs-function">(<span class="hljs-params">isSuccess: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`current transition result is <span class="hljs-subst">${isSuccess}</span>`</span>);</li><li>          },</li><li>          <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,</li><li>          <span class="hljs-attr">transition</span>: <span class="hljs-function">(<span class="hljs-params">transitionProxy: NavigationTransitionProxy</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'trigger transition callback'</span>);</li><li>            <span class="hljs-keyword">if</span> (fromParam.<span class="hljs-property">animation</span>) {</li><li>              fromParam.<span class="hljs-title function_">animation</span>(operation == <span class="hljs-title class_">NavigationOperation</span>.<span class="hljs-property">PUSH</span>, <span class="hljs-literal">true</span>, transitionProxy);</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (toParam.<span class="hljs-property">animation</span>) {</li><li>              toParam.<span class="hljs-title function_">animation</span>(operation == <span class="hljs-title class_">NavigationOperation</span>.<span class="hljs-property">PUSH</span>, <span class="hljs-literal">false</span>, transitionProxy);</li><li>            }</li><li>          }</li><li>        };</li><li>        <span class="hljs-keyword">return</span> customAnimation;</li><li>      })</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PageOne.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomTransition</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../CustomTransition/CustomNavigationUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyNodeController</span>, createMyNode, getMyNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'../NodeContainer/CustomComponent'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ComponentAttrUtils</span>, <span class="hljs-title class_">RectInfoInPx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ComponentAttrUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/WindowUtils'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PageOneBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">PageOne</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">PageOne</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageId</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">myNodeController</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-literal">false</span>);</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> node = <span class="hljs-title function_">getMyNode</span>();</li><li>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 新建自定义节点</span></li><li>      <span class="hljs-title function_">createMyNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> = <span class="hljs-title function_">getMyNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">doFinishTransition</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// PageTwo结束转场时将节点从PageTwo迁移回PageOne</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> = <span class="hljs-title function_">getMyNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">registerCustomTransition</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 注册自定义动画协议</span></li><li>    <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">registerNavParam</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span>,</li><li>      <span class="hljs-function">(<span class="hljs-params">isPush: <span class="hljs-built_in">boolean</span>, isExit: <span class="hljs-built_in">boolean</span>, transitionProxy: NavigationTransitionProxy</span>) =&gt;</span> {}, <span class="hljs-number">500</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onCardClicked</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">cardItemInfo</span>: <span class="hljs-title class_">RectInfoInPx</span> =</li><li>      <span class="hljs-title class_">ComponentAttrUtils</span>.<span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-string">'card'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">param</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = {};</li><li>    param[<span class="hljs-string">'cardItemInfo'</span>] = cardItemInfo;</li><li>    param[<span class="hljs-string">'doDefaultTransition'</span>] = <span class="hljs-function">(<span class="hljs-params">myController: MyNodeController</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">doFinishTransition</span>()</li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'PageTwo'</span>, <span class="hljs-attr">param</span>: param });</li><li>    <span class="hljs-comment">// 自定义节点从PageOne下树</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      (<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">MyNodeController</span>).<span class="hljs-title function_">onRemove</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Stack</span>() {</li><li>        <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>          <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>            <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>            <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">"app.media.avatar"</span>))</li><li>              .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">50</span> })</li><li>              .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">25</span>)</li><li>              .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>
</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Alice'</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'你好世界'</span>)</li><li>
</li><li>          <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>)</li><li>            .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">320</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">250</span> })</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onCardClicked</span>()</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">30</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span> = context.<span class="hljs-property">pathStack</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">getAllPathName</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerCustomTransition</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onDisAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterNavParam</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span>);</li><li>      <span class="hljs-comment">// 自定义节点从PageOne下树</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>        (<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">MyNodeController</span>).<span class="hljs-title function_">onRemove</span>();</li><li>      }</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PageTwo.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomTransition</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../CustomTransition/CustomNavigationUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AnimationProperties</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../CustomTransition/AnimationProperties'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RectInfoInPx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ComponentAttrUtils'</span>;</li><li><span class="hljs-keyword">import</span> { getMyNode, <span class="hljs-title class_">MyNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../NodeContainer/CustomComponent'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PageTwoBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">PageTwo</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">PageTwo</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">animationProperties</span>: <span class="hljs-title class_">AnimationProperties</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationProperties</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">myNodeController</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-literal">false</span>);</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageId</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">shouldDoDefaultTransition</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">prePageDoFinishTransition</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {};</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cardItemInfo</span>: <span class="hljs-title class_">RectInfoInPx</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectInfoInPx</span>();</li><li>
</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'windowSizeChanged'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'unRegisterNavParam'</span>) <span class="hljs-attr">windowSizeChangedTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-string">'onConfigurationUpdate'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'unRegisterNavParam'</span>) <span class="hljs-attr">onConfigurationUpdateTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 迁移自定义节点至当前页面</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> = <span class="hljs-title function_">getMyNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">unRegisterNavParam</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldDoDefaultTransition</span> = <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onBackPressed</span>(): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldDoDefaultTransition</span>) {</li><li>      <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterNavParam</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">prePageDoFinishTransition</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldDoDefaultTransition</span> = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-comment">// Stack需要设置alignContent为TopStart，否则在高度变化过程中，截图和内容都会随高度重新布局位置</span></li><li>      <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span> }) {</li><li>        <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span> }) {</li><li>          <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">20</span>}) {</li><li>            <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>)</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">showDetailContent</span>)</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">'展开态内容'</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>                .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>)</li><li>                .<span class="hljs-title function_">margin</span>(<span class="hljs-number">30</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">positionValue</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">scaleValue</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">scaleValue</span> })</li><li>      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">translateY</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">clipWidth</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">clipHeight</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">radius</span>)</li><li>      <span class="hljs-comment">// expandSafeArea使得Stack做沉浸式效果，向上扩到状态栏，向下扩到导航条</span></li><li>      .<span class="hljs-title function_">expandSafeArea</span>([<span class="hljs-title class_">SafeAreaType</span>.<span class="hljs-property">SYSTEM</span>])</li><li>      <span class="hljs-comment">// 对高度进行裁切</span></li><li>      .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-property">navDestinationBgColor</span>)</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span> = context.<span class="hljs-property">pathStack</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">getAllPathName</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;</li><li>      <span class="hljs-keyword">let</span> param = context.<span class="hljs-property">pathInfo</span>?.<span class="hljs-property">param</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">prePageDoFinishTransition</span> = param[<span class="hljs-string">'doDefaultTransition'</span>] <span class="hljs-keyword">as</span> () =&gt; <span class="hljs-built_in">void</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cardItemInfo</span> = param[<span class="hljs-string">'cardItemInfo'</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">RectInfoInPx</span>;</li><li>      <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">registerNavParam</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span>,</li><li>        <span class="hljs-function">(<span class="hljs-params">isPush: <span class="hljs-built_in">boolean</span>, isExit: <span class="hljs-built_in">boolean</span>, transitionProxy: NavigationTransitionProxy</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationProperties</span>.<span class="hljs-title function_">doAnimation</span>(</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">cardItemInfo</span>, isPush, isExit, transitionProxy, <span class="hljs-number">0</span>,</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prePageDoFinishTransition</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>);</li><li>        }, <span class="hljs-number">500</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onBackPressed</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onDisAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unRegisterNavParam</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageId</span>);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// CustomNavigationUtils.ets</span></li><li><span class="hljs-comment">// 配置Navigation自定义转场动画</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimateCallback</span> {</li><li>  <span class="hljs-attr">animation</span>: (<span class="hljs-function">(<span class="hljs-params">isPush: <span class="hljs-built_in">boolean</span>, isExit: <span class="hljs-built_in">boolean</span>, transitionProxy: NavigationTransitionProxy</span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-literal">undefined</span>)</li><li>    | <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">timeout</span>: (<span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>) | <span class="hljs-literal">undefined</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">customTransitionMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">AnimateCallback</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTransition</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {};</li><li>
</li><li>  <span class="hljs-keyword">static</span> delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomTransition</span>();</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomTransition</span>.<span class="hljs-property">delegate</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注册页面的动画回调，name是注册页面的动画的回调</span></li><li>  <span class="hljs-comment">// animationCallback是需要执行的动画内容，timeout是转场结束的超时时间</span></li><li>  <span class="hljs-title function_">registerNavParam</span>(</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-built_in">number</span>,</li><li>    <span class="hljs-attr">animationCallback</span>: <span class="hljs-function">(<span class="hljs-params">operation: <span class="hljs-built_in">boolean</span>, isExit: <span class="hljs-built_in">boolean</span>, transitionProxy: NavigationTransitionProxy</span>) =&gt;</span> <span class="hljs-built_in">void</span>,</li><li>    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (customTransitionMap.<span class="hljs-title function_">has</span>(name)) {</li><li>      <span class="hljs-keyword">let</span> param = customTransitionMap.<span class="hljs-title function_">get</span>(name);</li><li>      <span class="hljs-keyword">if</span> (param != <span class="hljs-literal">undefined</span>) {</li><li>        param.<span class="hljs-property">animation</span> = animationCallback;</li><li>        param.<span class="hljs-property">timeout</span> = timeout;</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">AnimateCallback</span> = { <span class="hljs-attr">timeout</span>: timeout, <span class="hljs-attr">animation</span>: animationCallback };</li><li>    customTransitionMap.<span class="hljs-title function_">set</span>(name, params);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unRegisterNavParam</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    customTransitionMap.<span class="hljs-title function_">delete</span>(name);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getAnimateParam</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">AnimateCallback</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">AnimateCallback</span> = {</li><li>      <span class="hljs-attr">animation</span>: customTransitionMap.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">animation</span>,</li><li>      <span class="hljs-attr">timeout</span>: customTransitionMap.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">timeout</span>,</li><li>    };</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 工程配置文件module.json5中配置 {"routerMap": "$profile:route_map"}</span></li><li><span class="hljs-comment">// route_map.json</span></li><li>{</li><li>  <span class="hljs-string">"routerMap"</span>: [</li><li>    {</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"PageOne"</span>,</li><li>      <span class="hljs-string">"pageSourceFile"</span>: <span class="hljs-string">"src/main/ets/pages/PageOne.ets"</span>,</li><li>      <span class="hljs-string">"buildFunction"</span>: <span class="hljs-string">"PageOneBuilder"</span></li><li>    },</li><li>    {</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"PageTwo"</span>,</li><li>      <span class="hljs-string">"pageSourceFile"</span>: <span class="hljs-string">"src/main/ets/pages/PageTwo.ets"</span>,</li><li>      <span class="hljs-string">"buildFunction"</span>: <span class="hljs-string">"PageTwoBuilder"</span></li><li>    }</li><li>  ]</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// AnimationProperties.ets</span></li><li><span class="hljs-comment">// 一镜到底转场动画封装</span></li><li><span class="hljs-keyword">import</span> { curves, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RectInfoInPx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ComponentAttrUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/WindowUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../NodeContainer/CustomComponent'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'AnimationProperties'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DEVICE_BORDER_RADIUS</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">34</span>;</li><li>
</li><li><span class="hljs-comment">// 将自定义一镜到底转场动画进行封装，其他界面也需要做自定义一镜到底转场的话，可以直接复用，减少工作量</span></li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationProperties</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">navDestinationBgColor</span>: <span class="hljs-title class_">ResourceColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">scaleValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">clipWidth</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">clipHeight</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">positionValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">showDetailContent</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span> = uiContext</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">doAnimation</span>(<span class="hljs-attr">cardItemInfo_px</span>: <span class="hljs-title class_">RectInfoInPx</span>, <span class="hljs-attr">isPush</span>: <span class="hljs-built_in">boolean</span>, <span class="hljs-attr">isExit</span>: <span class="hljs-built_in">boolean</span>,</li><li>                     <span class="hljs-attr">transitionProxy</span>: <span class="hljs-title class_">NavigationTransitionProxy</span>, <span class="hljs-attr">extraTranslateValue</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">prePageOnFinish</span>: <span class="hljs-function">(<span class="hljs-params">index: MyNodeController</span>) =&gt;</span> <span class="hljs-built_in">void</span>, <span class="hljs-attr">myNodeController</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 首先计算卡片的宽高与窗口宽高的比例</span></li><li>    <span class="hljs-keyword">let</span> widthScaleRatio = cardItemInfo_px.<span class="hljs-property">width</span> / <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span>;</li><li>    <span class="hljs-keyword">let</span> heightScaleRatio = cardItemInfo_px.<span class="hljs-property">height</span> / <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span>;</li><li>    <span class="hljs-keyword">let</span> isUseWidthScale = widthScaleRatio &gt; heightScaleRatio;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initScale</span>: <span class="hljs-built_in">number</span> = isUseWidthScale ? widthScaleRatio : heightScaleRatio;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initTranslateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initTranslateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initClipWidth</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initClipHeight</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 使得PageTwo卡片向上扩到状态栏</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initPositionValue</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> + extraTranslateValue);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (isUseWidthScale) {</li><li>      initTranslateX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(cardItemInfo_px.<span class="hljs-property">left</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> - cardItemInfo_px.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span>);</li><li>      initClipWidth = <span class="hljs-string">'100%'</span>;</li><li>      initClipHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>((cardItemInfo_px.<span class="hljs-property">height</span>) / initScale);</li><li>      initTranslateY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(cardItemInfo_px.<span class="hljs-property">top</span> - ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">vp2px</span>(initClipHeight) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">vp2px</span>(initClipHeight) * initScale) / <span class="hljs-number">2</span>));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      initTranslateY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(cardItemInfo_px.<span class="hljs-property">top</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> - cardItemInfo_px.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>);</li><li>      initClipHeight = <span class="hljs-string">'100%'</span>;</li><li>      initClipWidth = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>((cardItemInfo_px.<span class="hljs-property">width</span>) / initScale);</li><li>      initTranslateX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(cardItemInfo_px.<span class="hljs-property">left</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> / <span class="hljs-number">2</span> - cardItemInfo_px.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>));</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 转场动画开始前通过计算scale、translate、position和clip height &amp; width，确定节点迁移前后位置一致</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initScale: '</span> + initScale + <span class="hljs-string">' initTranslateX '</span> + initTranslateX +</li><li>    <span class="hljs-string">' initTranslateY '</span> + initTranslateY + <span class="hljs-string">' initClipWidth '</span> + initClipWidth +</li><li>    <span class="hljs-string">' initClipHeight '</span> + initClipHeight + <span class="hljs-string">' initPositionValue '</span> + initPositionValue);</li><li>    <span class="hljs-comment">// 转场至新页面</span></li><li>    <span class="hljs-keyword">if</span> (isPush &amp;&amp; !isExit) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = initScale;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = initTranslateX;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span> = initClipWidth;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span> = initClipHeight;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = initTranslateY;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positionValue</span> = initPositionValue;</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">interpolatingSpring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">328</span>, <span class="hljs-number">36</span>),</li><li>        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (transitionProxy) {</li><li>            transitionProxy.<span class="hljs-title function_">finishTransition</span>();</li><li>          }</li><li>        }</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = <span class="hljs-number">1.0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span> = <span class="hljs-string">'100%'</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span> = <span class="hljs-string">'100%'</span>;</li><li>        <span class="hljs-comment">// 页面圆角与系统圆角一致</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">radius</span> = <span class="hljs-variable constant_">DEVICE_BORDER_RADIUS</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">showDetailContent</span> = <span class="hljs-literal">true</span>;</li><li>      })</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>,</li><li>        <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span>,</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 页面由透明逐渐变为设置背景色</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationBgColor</span> = <span class="hljs-string">'#00ffffff'</span>;</li><li>      })</li><li>
</li><li>      <span class="hljs-comment">// 返回旧页面</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isPush &amp;&amp; isExit) {</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>,</li><li>        <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">EaseInOut</span>,</li><li>        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (transitionProxy) {</li><li>            transitionProxy.<span class="hljs-title function_">finishTransition</span>();</li><li>          }</li><li>          <span class="hljs-title function_">prePageOnFinish</span>(myNodeController);</li><li>          <span class="hljs-comment">// 自定义节点从PageTwo下树</span></li><li>          <span class="hljs-keyword">if</span> (myNodeController != <span class="hljs-literal">undefined</span>) {</li><li>            (myNodeController <span class="hljs-keyword">as</span> <span class="hljs-title class_">MyNodeController</span>).<span class="hljs-title function_">onRemove</span>();</li><li>          }</li><li>        }</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = initScale;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = initTranslateX;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = initTranslateY;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">radius</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span> = initClipWidth;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span> = initClipHeight;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">showDetailContent</span> = <span class="hljs-literal">false</span>;</li><li>      })</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>        <span class="hljs-attr">delay</span>: <span class="hljs-number">150</span>,</li><li>        <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span>,</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationBgColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>;</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ComponentAttrUtils.ets</span></li><li><span class="hljs-comment">// 获取组件相对窗口的位置</span></li><li><span class="hljs-keyword">import</span> { componentUtils, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentAttrUtils</span> {</li><li>  <span class="hljs-comment">// 根据组件的id获取组件的位置信息</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">RectInfoInPx</span> {</li><li>    <span class="hljs-keyword">if</span> (!context || !id) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'object is empty'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">componentInfo</span>: componentUtils.<span class="hljs-property">ComponentInfo</span> = context.<span class="hljs-title function_">getComponentUtils</span>().<span class="hljs-title function_">getRectangleById</span>(id);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!componentInfo) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'object is empty'</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">rstRect</span>: <span class="hljs-title class_">RectInfoInPx</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectInfoInPx</span>();</li><li>    <span class="hljs-keyword">const</span> widthScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span>) / <span class="hljs-number">2</span>;</li><li>    <span class="hljs-keyword">const</span> heightScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span>) / <span class="hljs-number">2</span>;</li><li>    rstRect.<span class="hljs-property">left</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + widthScaleGap;</li><li>    rstRect.<span class="hljs-property">top</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + heightScaleGap;</li><li>    rstRect.<span class="hljs-property">right</span> =</li><li>      componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - widthScaleGap;</li><li>    rstRect.<span class="hljs-property">bottom</span> =</li><li>      componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> - heightScaleGap;</li><li>    rstRect.<span class="hljs-property">width</span> = rstRect.<span class="hljs-property">right</span> - rstRect.<span class="hljs-property">left</span>;</li><li>    rstRect.<span class="hljs-property">height</span> = rstRect.<span class="hljs-property">bottom</span> - rstRect.<span class="hljs-property">top</span>;</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">left</span>: rstRect.<span class="hljs-property">left</span>,</li><li>      <span class="hljs-attr">right</span>: rstRect.<span class="hljs-property">right</span>,</li><li>      <span class="hljs-attr">top</span>: rstRect.<span class="hljs-property">top</span>,</li><li>      <span class="hljs-attr">bottom</span>: rstRect.<span class="hljs-property">bottom</span>,</li><li>      <span class="hljs-attr">width</span>: rstRect.<span class="hljs-property">width</span>,</li><li>      <span class="hljs-attr">height</span>: rstRect.<span class="hljs-property">height</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectInfoInPx</span> {</li><li>  <span class="hljs-attr">left</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">right</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectJson</span> {</li><li>  <span class="hljs-attr">$rect</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [];</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// WindowUtils.ets</span></li><li><span class="hljs-comment">// 窗口信息</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowUtils</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">window</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">windowWidth_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">windowHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">topAvoidAreaHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">navigationIndicatorHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-comment">// 程序入口处的onWindowStageCreate增加对窗口宽高等的抓取</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { display, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/WindowUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentBreakPoint</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取窗口宽高</span></li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">windowRect</span>.<span class="hljs-property">width</span>;</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">windowRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateBreakpoint</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取上方避让区(状态栏等)高度</span></li><li>    <span class="hljs-keyword">let</span> avoidArea = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_SYSTEM</span>);</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> = avoidArea.<span class="hljs-property">topRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    <span class="hljs-comment">// 获取导航条高度</span></li><li>    <span class="hljs-keyword">let</span> navigationArea = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_NAVIGATION_INDICATOR</span>);</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span> = navigationArea.<span class="hljs-property">bottomRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'the width is '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> + <span class="hljs-string">'  '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> + <span class="hljs-string">'  '</span> +</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> + <span class="hljs-string">'  '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span>);</li><li>
</li><li>    <span class="hljs-comment">// 监听窗口尺寸、状态栏高度及导航条高度的变化并更新</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on windowSizeChange, the width is '</span> + data.<span class="hljs-property">width</span> + <span class="hljs-string">', the height is '</span> + data.<span class="hljs-property">height</span>);</li><li>        <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> = data.<span class="hljs-property">width</span>;</li><li>        <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> = data.<span class="hljs-property">height</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateBreakpoint</span>(data.<span class="hljs-property">width</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowSizeChanged'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'avoidAreaChange'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> == <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_SYSTEM</span>) {</li><li>          <span class="hljs-keyword">let</span> topRectHeight = data.<span class="hljs-property">area</span>.<span class="hljs-property">topRect</span>.<span class="hljs-property">height</span>;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on avoidAreaChange, the top avoid area height is '</span> + topRectHeight);</li><li>          <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> = topRectHeight;</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> == <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_NAVIGATION_INDICATOR</span>) {</li><li>          <span class="hljs-keyword">let</span> bottomRectHeight = data.<span class="hljs-property">area</span>.<span class="hljs-property">bottomRect</span>.<span class="hljs-property">height</span>;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on avoidAreaChange, the navigation indicator height is '</span> + bottomRectHeight);</li><li>          <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span> = bottomRectHeight;</li><li>        }</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`register failed. code: <span class="hljs-subst">${exception.code}</span>, message: <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    }</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateBreakpoint</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> windowWidthVp = width / (display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityDPI</span> / <span class="hljs-number">160</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">newBreakPoint</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">400</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'xs'</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">600</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'sm'</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">800</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'md'</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      newBreakPoint = <span class="hljs-string">'lg'</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span> !== newBreakPoint) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span> = newBreakPoint;</li><li>      <span class="hljs-comment">// 使用状态变量记录当前断点值</span></li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentBreakpoint'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// CustomComponent.ets</span></li><li><span class="hljs-comment">// 自定义占位节点，跨容器迁移能力</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">CardBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">"app.media.card"</span>))</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">id</span>(<span class="hljs-string">'card'</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">CardNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">wrapBuilder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;[]&gt; = <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">CardBuilder</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">needCreate</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isRemove</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">create: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">needCreate</span> = create;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> == <span class="hljs-literal">true</span>){</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">needCreate</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrapBuilder</span>)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>!.<span class="hljs-title function_">getFrameNode</span>()!;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNode</span>(): <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setNode</span>(<span class="hljs-params">node: BuilderNode&lt;[]&gt; | <span class="hljs-literal">null</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = node;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuild</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRemove</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuild</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrapBuilder</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">myNode</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createMyNode</span> =</li><li>  (<span class="hljs-params">uiContext: UIContext</span>) =&gt; {</li><li>    myNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-literal">false</span>);</li><li>    myNode.<span class="hljs-title function_">init</span>(uiContext);</li><li>  }</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getMyNode = (): <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> myNode;</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="784" originwidth="364" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.77442194509219941193913416684457:50001231000000:2800:AB5B2453C574FD2499667C95EC7BDDA2DA9CE66F950A8BF1D4E02E8254D4AEF1.gif" width="364" height="784"></span></p>    </div>    <div class="tiledSection">     <h3 id="结合bindsheet使用">结合BindSheet使用<i class="anchor-icon anchor-icon-link" anchorid="结合bindsheet使用" tips="复制节点链接"></i></h3>          <p>想实现半模态转场（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#bindsheet" target="_blank">bindSheet</a>）的同时，组件从初始界面做一镜到底动画到半模态页面的效果，可以使用这样的设计思路。将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#sheetoptions" target="_blank">SheetOptions</a>中的mode设置为SheetMode.EMBEDDED，该模式下新起的页面可以覆盖在半模态弹窗上，页面返回后该半模态依旧存在，半模态面板内容不丢失。在半模态转场的同时设置一全模态转场（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-modal-transition#bindcontentcover" target="_blank">bindContentCover</a>）页面无转场出现，该页面仅有需要做共享元素转场的组件，通过属性动画，展示组件从初始界面至半模态页面的一镜到底动效，并在动画结束时关闭页面，并将该组件迁移至半模态页面。</p>     <p>以点击图片展开半模态页的场景为例，实现步骤为：</p>     <ul>      <li>       <p>在初始界面挂载半模态转场和全模态转场两个页面，半模态页按需布局，全模态页面仅放置一镜到底动效需要的组件，抓取布局信息，使其初始位置为初始界面图片的位置。点击初始界面图片时，同时触发半模态和全模态页面出现，因设置为SheetMode.EMBEDDED模式，此时全模态页面层级最高。</p></li>      <li>       <p>设置不可见的占位图片置于半模态页上，作为一镜到底动效结束时图片的终止位置。利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-inspector" target="_blank">布局回调</a>监听该占位图片布局完成的时候，此时执行回调抓取占位图片的位置信息，随后全模态页面上的图片利用属性动画开始进行共享元素转场。</p></li>      <li>       <p>全模态页面的动画结束时触发结束回调，关闭全模态页面，将共享元素图片的节点迁移至半模态页面，替换占位图片。</p></li>      <li>       <p>需注意，半模态页面的弹起高度不同，其页面起始位置也有所不同，而全模态则是全屏显示，两者存在一高度差，做一镜到底动画时，需要计算差值并进行修正，具体可见demo。</p></li>      <li>       <p>还可以配合一镜到底动画，给初始界面图片也增加一个从透明到出现的动画，使得动效更为流畅。</p></li>     </ul>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li>├──<span class="hljs-selector-tag">entry</span>/<span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">ets</span>                 <span class="hljs-comment">// 代码区</span></li><li>│  ├──<span class="hljs-selector-tag">entryability</span></li><li>│  │  └──<span class="hljs-selector-tag">EntryAbility</span><span class="hljs-selector-class">.ets</span>             <span class="hljs-comment">// 程序入口类</span></li><li>│  ├──<span class="hljs-selector-tag">NodeContainer</span></li><li>│  │  └──<span class="hljs-selector-tag">CustomComponent</span><span class="hljs-selector-class">.ets</span>          <span class="hljs-comment">// 自定义占位节点</span></li><li>│  ├──<span class="hljs-selector-tag">pages</span></li><li>│  │  └──<span class="hljs-selector-tag">Index</span><span class="hljs-selector-class">.ets</span>                    <span class="hljs-comment">// 进行共享元素转场的主页面</span></li><li>│  └──<span class="hljs-selector-tag">utils</span></li><li>│     ├──<span class="hljs-selector-tag">ComponentAttrUtils</span><span class="hljs-selector-class">.ets</span>       <span class="hljs-comment">// 组件位置获取</span></li><li>│     └──<span class="hljs-selector-tag">WindowUtils</span><span class="hljs-selector-class">.ets</span>              <span class="hljs-comment">// 窗口信息</span></li><li>└──<span class="hljs-selector-tag">entry</span>/<span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">resources</span>           <span class="hljs-comment">// 资源文件</span></li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyNodeController</span>, createMyNode, getMyNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'../NodeContainer/CustomComponent'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ComponentAttrUtils</span>, <span class="hljs-title class_">RectInfoInPx</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ComponentAttrUtils'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/WindowUtils'</span>;</li><li><span class="hljs-keyword">import</span> { inspector } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationInfo</span> {</li><li>  <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">clipWidth</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">clipHeight</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShowSheet</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShowImage</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShowOverlay</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isAnimating</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isEnabled</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scaleValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">clipWidth</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">clipHeight</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 原图的透明度</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">opacityDegree</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// 抓取照片原位置信息</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">originInfo</span>: <span class="hljs-title class_">AnimationInfo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationInfo</span>;</li><li>  <span class="hljs-comment">// 抓取照片在半模态页上位置信息</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">targetInfo</span>: <span class="hljs-title class_">AnimationInfo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationInfo</span>;</li><li>  <span class="hljs-comment">// 半模态高度</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">bindSheetHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">450</span>;</li><li>  <span class="hljs-comment">// 半模态上图片圆角</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">sheetRadius</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>
</li><li>  <span class="hljs-comment">// 设置半模态上图片的布局监听</span></li><li>  <span class="hljs-attr">listener</span>:inspector.<span class="hljs-property">ComponentObserver</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getUIInspector</span>().<span class="hljs-title function_">createComponentObserver</span>(<span class="hljs-string">'target'</span>);</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 设置半模态上图片的布局完成回调</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">onLayoutComplete</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-built_in">void</span>=():<span class="hljs-function"><span class="hljs-params">void</span>=&gt;</span>{</li><li>      <span class="hljs-comment">// 目标图片布局完成时抓取布局信息</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateData</span>(<span class="hljs-string">'target'</span>);</li><li>      <span class="hljs-comment">// 仅半模态正确布局且此时无动画时触发一镜到底动画</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">scale</span> != <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">clipWidth</span> != <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">clipHeight</span> != <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimating</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimating</span> = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-comment">// 用于一镜到底的模态页的属性动画</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>          <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,</li><li>          <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span>,</li><li>          <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 模态转场页（overlay）上的自定义节点下树</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowOverlay</span> = <span class="hljs-literal">false</span>;</li><li>            <span class="hljs-comment">// 半模态上的自定义节点上树，由此完成节点迁移</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowImage</span> = <span class="hljs-literal">true</span>;</li><li>          }</li><li>        }, <span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">scale</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">translateX</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">clipWidth</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">clipHeight</span>;</li><li>          <span class="hljs-comment">// 修正因半模态高度和缩放导致的高度差</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetInfo</span>.<span class="hljs-property">translateY</span> +</li><li>            (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span>) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bindSheetHeight</span></li><li>              - <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span>) - <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span>));</li><li>          <span class="hljs-comment">// 修正因缩放导致的圆角差异</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">radius</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sheetRadius</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span></li><li>        })</li><li>        <span class="hljs-comment">// 原图从透明到出现的动画</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>          <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span>,</li><li>          <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span>,</li><li>        }, <span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacityDegree</span> = <span class="hljs-number">1</span>;</li><li>        })</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// 打开布局监听</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'layout'</span>, onLayoutComplete)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取对应id的组件相对窗口左上角的属性</span></li><li>  <span class="hljs-title function_">calculateData</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">AnimationInfo</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemInfo</span>: <span class="hljs-title class_">RectInfoInPx</span> =</li><li>      <span class="hljs-title class_">ComponentAttrUtils</span>.<span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getUIContext</span>(), id);</li><li>    <span class="hljs-comment">// 首先计算图片的宽高与窗口宽高的比例</span></li><li>    <span class="hljs-keyword">let</span> widthScaleRatio = itemInfo.<span class="hljs-property">width</span> / <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span>;</li><li>    <span class="hljs-keyword">let</span> heightScaleRatio = itemInfo.<span class="hljs-property">height</span> / <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span>;</li><li>    <span class="hljs-keyword">let</span> isUseWidthScale = widthScaleRatio &gt; heightScaleRatio;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemScale</span>: <span class="hljs-built_in">number</span> = isUseWidthScale ? widthScaleRatio : heightScaleRatio;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemTranslateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemClipWidth</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemClipHeight</span>: <span class="hljs-title class_">Dimension</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">itemTranslateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (isUseWidthScale) {</li><li>      itemTranslateX = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(itemInfo.<span class="hljs-property">left</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> - itemInfo.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span>);</li><li>      itemClipWidth = <span class="hljs-string">'100%'</span>;</li><li>      itemClipHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>((itemInfo.<span class="hljs-property">height</span>) / itemScale);</li><li>      itemTranslateY = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(itemInfo.<span class="hljs-property">top</span> - ((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(itemClipHeight) - <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(itemClipHeight) * itemScale) / <span class="hljs-number">2</span>));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      itemTranslateY = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(itemInfo.<span class="hljs-property">top</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> - itemInfo.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>);</li><li>      itemClipHeight = <span class="hljs-string">'100%'</span>;</li><li>      itemClipWidth = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>((itemInfo.<span class="hljs-property">width</span>) / itemScale);</li><li>      itemTranslateX = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(itemInfo.<span class="hljs-property">left</span> - (<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> / <span class="hljs-number">2</span> - itemInfo.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>));</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">scale</span>: itemScale,</li><li>      <span class="hljs-attr">translateX</span>: itemTranslateX ,</li><li>      <span class="hljs-attr">translateY</span>: itemTranslateY,</li><li>      <span class="hljs-attr">clipWidth</span>: itemClipWidth,</li><li>      <span class="hljs-attr">clipHeight</span>: itemClipHeight,</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 照片页</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'照片'</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Start</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>      <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">"app.media.flower"</span>))</li><li>        .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">opacityDegree</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'origin'</span>)<span class="hljs-comment">// 挂载半模态页</span></li><li>        .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isEnabled</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 获取原始图像的位置信息，将模态页上图片移动缩放至该位置</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateData</span>(<span class="hljs-string">'origin'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span>.<span class="hljs-property">scale</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span>.<span class="hljs-property">translateX</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span>.<span class="hljs-property">translateY</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span>.<span class="hljs-property">clipWidth</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originInfo</span>.<span class="hljs-property">clipHeight</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">radius</span> = <span class="hljs-number">0</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacityDegree</span> = <span class="hljs-number">0</span>;</li><li>          <span class="hljs-comment">// 启动半模态页和模态页</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowSheet</span> = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowOverlay</span> = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-comment">// 设置原图为不可交互抗打断</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>;</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">bindSheet</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowSheet</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mySheet</span>(), {</li><li>      <span class="hljs-comment">// Embedded模式使得其他页面可以高于半模态页</span></li><li>      <span class="hljs-attr">mode</span>: <span class="hljs-title class_">SheetMode</span>.<span class="hljs-property">EMBEDDED</span>,</li><li>      <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">bindSheetHeight</span>,</li><li>      <span class="hljs-attr">onDisappear</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 保证半模态消失时状态正确</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowImage</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowSheet</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-comment">// 设置一镜到底动画又进入可触发状态</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAnimating</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-comment">// 原图重新变为可交互状态</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>;</li><li>      }</li><li>    }) <span class="hljs-comment">// 挂载模态页作为一镜到底动画的实现页</span></li><li>    .<span class="hljs-title function_">bindContentCover</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowOverlay</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">overlayNode</span>(), {</li><li>      <span class="hljs-comment">// 模态页面设置为无转场</span></li><li>      <span class="hljs-attr">transition</span>: <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">IDENTITY</span>,</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 半模态页面</span></li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title function_">mySheet</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">20</span>}) {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'半模态页面'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      <span class="hljs-title class_">Row</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">40</span>}) {</li><li>        <span class="hljs-title class_">Column</span>({<span class="hljs-attr">space</span>: <span class="hljs-number">20</span>}) {</li><li>          <span class="hljs-title class_">ForEach</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">Stack</span>()</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)</li><li>              .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-number">60</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)</li><li>          })</li><li>        }</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowImage</span>) {</li><li>            <span class="hljs-comment">// 半模态页面的自定义图片节点</span></li><li>            <span class="hljs-title class_">ImageNode</span>()</li><li>          }</li><li>          <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// 抓取布局和占位用，实际不显示</span></li><li>            <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>            <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">"app.media.flower"</span>))</li><li>              .<span class="hljs-title function_">visibility</span>(<span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Hidden</span>)</li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'target'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">40</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title function_">overlayNode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// Stack需要设置alignContent为TopStart，否则在高度变化过程中，截图和内容都会随高度重新布局位置</span></li><li>    <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span> }) {</li><li>      <span class="hljs-title class_">ImageNode</span>()</li><li>    }</li><li>    .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span>, <span class="hljs-attr">centerX</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">centerY</span>: <span class="hljs-literal">undefined</span>})</li><li>    .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateY</span> })</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clipWidth</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clipHeight</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">radius</span>)</li><li>    .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ImageNode</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">myNodeController</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-literal">false</span>);</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 获取自定义节点</span></li><li>    <span class="hljs-keyword">let</span> node = <span class="hljs-title function_">getMyNode</span>();</li><li>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 新建自定义节点</span></li><li>      <span class="hljs-title function_">createMyNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> = <span class="hljs-title function_">getMyNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span> != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-comment">// 节点下树</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>.<span class="hljs-title function_">onRemove</span>();</li><li>    }</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// CustomComponent.ets</span></li><li><span class="hljs-comment">// 自定义占位节点，跨容器迁移能力</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">CardBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">"app.media.flower"</span>))</li><li>    <span class="hljs-comment">// 避免第一次加载图片时图片闪烁</span></li><li>    .<span class="hljs-title function_">syncLoad</span>(<span class="hljs-literal">true</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">CardNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">wrapBuilder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;[]&gt; = <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">CardBuilder</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">needCreate</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isRemove</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">create: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">needCreate</span> = create;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> == <span class="hljs-literal">true</span>){</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">needCreate</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrapBuilder</span>)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>!.<span class="hljs-title function_">getFrameNode</span>()!;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNode</span>(): <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setNode</span>(<span class="hljs-params">node: BuilderNode&lt;[]&gt; | <span class="hljs-literal">null</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = node;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuild</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRemove</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuild</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRemove</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">init</span>(<span class="hljs-params">uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">CardNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrapBuilder</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">myNode</span>: <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createMyNode</span> =</li><li>  (<span class="hljs-params">uiContext: UIContext</span>) =&gt; {</li><li>    myNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-literal">false</span>);</li><li>    myNode.<span class="hljs-title function_">init</span>(uiContext);</li><li>  }</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getMyNode = (): <span class="hljs-title class_">MyNodeController</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> myNode;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ComponentAttrUtils.ets</span></li><li><span class="hljs-comment">// 获取组件相对窗口的位置</span></li><li><span class="hljs-keyword">import</span> { componentUtils, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentAttrUtils</span> {</li><li>  <span class="hljs-comment">// 根据组件的id获取组件的位置信息</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getRectInfoById</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">RectInfoInPx</span> {</li><li>    <span class="hljs-keyword">if</span> (!context || !id) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'object is empty'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">componentInfo</span>: componentUtils.<span class="hljs-property">ComponentInfo</span> = context.<span class="hljs-title function_">getComponentUtils</span>().<span class="hljs-title function_">getRectangleById</span>(id);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!componentInfo) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'object is empty'</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">rstRect</span>: <span class="hljs-title class_">RectInfoInPx</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectInfoInPx</span>();</li><li>    <span class="hljs-keyword">const</span> widthScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span>) / <span class="hljs-number">2</span>;</li><li>    <span class="hljs-keyword">const</span> heightScaleGap = componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> * (<span class="hljs-number">1</span> - componentInfo.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span>) / <span class="hljs-number">2</span>;</li><li>    rstRect.<span class="hljs-property">left</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + widthScaleGap;</li><li>    rstRect.<span class="hljs-property">top</span> = componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + heightScaleGap;</li><li>    rstRect.<span class="hljs-property">right</span> =</li><li>      componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">x</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - widthScaleGap;</li><li>    rstRect.<span class="hljs-property">bottom</span> =</li><li>      componentInfo.<span class="hljs-property">translate</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">windowOffset</span>.<span class="hljs-property">y</span> + componentInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> - heightScaleGap;</li><li>    rstRect.<span class="hljs-property">width</span> = rstRect.<span class="hljs-property">right</span> - rstRect.<span class="hljs-property">left</span>;</li><li>    rstRect.<span class="hljs-property">height</span> = rstRect.<span class="hljs-property">bottom</span> - rstRect.<span class="hljs-property">top</span>;</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">left</span>: rstRect.<span class="hljs-property">left</span>,</li><li>      <span class="hljs-attr">right</span>: rstRect.<span class="hljs-property">right</span>,</li><li>      <span class="hljs-attr">top</span>: rstRect.<span class="hljs-property">top</span>,</li><li>      <span class="hljs-attr">bottom</span>: rstRect.<span class="hljs-property">bottom</span>,</li><li>      <span class="hljs-attr">width</span>: rstRect.<span class="hljs-property">width</span>,</li><li>      <span class="hljs-attr">height</span>: rstRect.<span class="hljs-property">height</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectInfoInPx</span> {</li><li>  <span class="hljs-attr">left</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">right</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectJson</span> {</li><li>  <span class="hljs-attr">$rect</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [];</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// WindowUtils.ets</span></li><li><span class="hljs-comment">// 窗口信息</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowUtils</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">window</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">windowWidth_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">windowHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">topAvoidAreaHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">navigationIndicatorHeight_px</span>: <span class="hljs-built_in">number</span>;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-comment">// 程序入口处的onWindowStageCreate增加对窗口宽高等的抓取</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { display, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WindowUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/WindowUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentBreakPoint</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取窗口宽高</span></li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span> = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">windowRect</span>.<span class="hljs-property">width</span>;</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">windowRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateBreakpoint</span>(<span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取上方避让区(状态栏等)高度</span></li><li>    <span class="hljs-keyword">let</span> avoidArea = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_SYSTEM</span>);</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> = avoidArea.<span class="hljs-property">topRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    <span class="hljs-comment">// 获取导航条高度</span></li><li>    <span class="hljs-keyword">let</span> navigationArea = <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_NAVIGATION_INDICATOR</span>);</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span> = navigationArea.<span class="hljs-property">bottomRect</span>.<span class="hljs-property">height</span>;</li><li>
</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'the width is '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> + <span class="hljs-string">'  '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> + <span class="hljs-string">'  '</span> +</li><li>    <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> + <span class="hljs-string">'  '</span> + <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span>);</li><li>
</li><li>    <span class="hljs-comment">// 监听窗口尺寸、状态栏高度及导航条高度的变化并更新</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on windowSizeChange, the width is '</span> + data.<span class="hljs-property">width</span> + <span class="hljs-string">', the height is '</span> + data.<span class="hljs-property">height</span>);</li><li>        <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowWidth_px</span> = data.<span class="hljs-property">width</span>;</li><li>        <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowHeight_px</span> = data.<span class="hljs-property">height</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateBreakpoint</span>(data.<span class="hljs-property">width</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowSizeChanged'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">window</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'avoidAreaChange'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> == <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_SYSTEM</span>) {</li><li>          <span class="hljs-keyword">let</span> topRectHeight = data.<span class="hljs-property">area</span>.<span class="hljs-property">topRect</span>.<span class="hljs-property">height</span>;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on avoidAreaChange, the top avoid area height is '</span> + topRectHeight);</li><li>          <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">topAvoidAreaHeight_px</span> = topRectHeight;</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> == <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_NAVIGATION_INDICATOR</span>) {</li><li>          <span class="hljs-keyword">let</span> bottomRectHeight = data.<span class="hljs-property">area</span>.<span class="hljs-property">bottomRect</span>.<span class="hljs-property">height</span>;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on avoidAreaChange, the navigation indicator height is '</span> + bottomRectHeight);</li><li>          <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">navigationIndicatorHeight_px</span> = bottomRectHeight;</li><li>        }</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`register failed. code: <span class="hljs-subst">${exception.code}</span>, message: <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    }</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateBreakpoint</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> windowWidthVp = width / (display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityDPI</span> / <span class="hljs-number">160</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">newBreakPoint</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">400</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'xs'</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">600</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'sm'</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (windowWidthVp &lt; <span class="hljs-number">800</span>) {</li><li>      newBreakPoint = <span class="hljs-string">'md'</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      newBreakPoint = <span class="hljs-string">'lg'</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span> !== newBreakPoint) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span> = newBreakPoint;</li><li>      <span class="hljs-comment">// 使用状态变量记录当前断点值</span></li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentBreakpoint'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBreakPoint</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="702" originwidth="338" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.81048306057898383338442623868250:50001231000000:2800:3AAC489B3B1A1690FC7AE6DA5F146269104A4220BAC98B41FDABDE4E4C107243.gif" width="338" height="702"></span></p>    </div>    <div class="tiledSection">     <h2 id="使用geometrytransition共享元素转场">使用geometryTransition共享元素转场<i class="anchor-icon anchor-icon-link" anchorid="使用geometrytransition共享元素转场" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-transition-animation-geometrytransition" target="_blank">geometryTransition</a>用于组件内隐式共享元素转场，在视图状态切换过程中提供丝滑的上下文继承过渡体验。</p>     <p>geometryTransition的使用方式为对需要添加一镜到底动效的两个组件使用geometryTransition接口绑定同一id，这样在其中一个组件消失同时另一个组件创建出现的时候，系统会对二者添加一镜到底动效。</p>     <p>geometryTransition绑定两个对象的实现方式使得geometryTransition区别于其他方法，最适合用于两个不同对象之间完成一镜到底。</p>    </div>    <div class="tiledSection">     <h3 id="geometrytransition的简单使用" class="firsth2">geometryTransition的简单使用<i class="anchor-icon anchor-icon-link" anchorid="geometrytransition的简单使用" tips="复制节点链接"></i></h3>          <p>对于同一个页面中的两个元素的一镜到底效果，geometryTransition接口的简单使用示例如下：</p>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { curves } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">IfElseGeometryTransition</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Center</span> }) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>        <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.spring'</span>))</li><li>          .<span class="hljs-title function_">autoResize</span>(<span class="hljs-literal">false</span>)</li><li>          .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">100</span>)</li><li>          .<span class="hljs-title function_">geometryTransition</span>(<span class="hljs-string">"picture"</span>)</li><li>          .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>)</li><li>          <span class="hljs-comment">// 在打断场景下，即动画过程中点击页面触发下一次转场，如果不加id，则会出现重影</span></li><li>          <span class="hljs-comment">// 加了id之后，新建的spring图片会复用之前的spring图片节点，不会重新创建节点，也就不会有重影问题</span></li><li>          <span class="hljs-comment">// 加id的规则为加在if和else下的第一个节点上，有多个并列节点则也需要进行添加</span></li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'item1'</span>)</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// geometryTransition此处绑定的是容器，那么容器内的子组件需设为相对布局跟随父容器变化，</span></li><li>        <span class="hljs-comment">// 套多层容器为了说明相对布局约束传递</span></li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>            <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.sky'</span>))</li><li>              .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>          }</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>        <span class="hljs-comment">// geometryTransition会同步圆角，但仅限于geometryTransition绑定处，此处绑定的是容器</span></li><li>        <span class="hljs-comment">// 则对容器本身有圆角同步而不会操作容器内部子组件的borderRadius</span></li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">geometryTransition</span>(<span class="hljs-string">"picture"</span>)</li><li>        <span class="hljs-comment">// transition保证节点离场不被立即析构，设置通用转场效果</span></li><li>        .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>)</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">40</span> })</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'item2'</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>        <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">springMotion</span>()</li><li>      }, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>;</li><li>      })</li><li>    })</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="512" originwidth="238" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.02987063536853920659485071043363:50001231000000:2800:77EB5E028A553272DF02952E2E83A9A9233B51AEF0FFF0CA5C4E20C9473DBD0A.gif" class="notEnlarge" width="238" height="512"></span></p>    </div>    <div class="tiledSection">     <h3 id="geometrytransition结合模态转场使用">geometryTransition结合模态转场使用<i class="anchor-icon anchor-icon-link" anchorid="geometrytransition结合模态转场使用" tips="复制节点链接"></i></h3>          <p>更多的场景中，需要对一个页面的元素与另一个页面的元素添加一镜到底动效。可以通过geometryTransition搭配模态转场接口实现。以点击头像弹出个人信息页的demo为例：</p>     <div _ngcontent-djy-c106="" class="highlight-div"><div _ngcontent-djy-c106="" class="highlight-div-header"><div _ngcontent-djy-c106="" class="highlight-div-header-left"><div _ngcontent-djy-c106="" class="handle-button expand-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-djy-c106="" class="highlight-div-header-right"><div _ngcontent-djy-c106="" class="handle-button ai-button"></div><div _ngcontent-djy-c106="" class="handle-button line-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-djy-c106="" class="handle-button theme-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-djy-c106="" class="handle-button copy-button"><div _ngcontent-djy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-djy-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PostData</span> {</li><li>  <span class="hljs-comment">// 图片使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-attr">avatar</span>: <span class="hljs-title class_">Resource</span> = $r(<span class="hljs-string">'app.media.flower'</span>);</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">images</span>: <span class="hljs-title class_">Resource</span>[] = [];</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isPersonalPageShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectedIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">alphaValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// 数组中图片均使用Resource资源，需用户自定义</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">allPostData</span>: <span class="hljs-title class_">PostData</span>[] = [</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.flower'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'天气晴朗'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.spring'</span>), $r(<span class="hljs-string">'app.media.tree'</span>)] },</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.sky'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'你好世界'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.island'</span>)] },</li><li>    { <span class="hljs-attr">avatar</span>: $r(<span class="hljs-string">'app.media.tree'</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">'Carl'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'万物生长'</span>,</li><li>      <span class="hljs-attr">images</span>: [$r(<span class="hljs-string">'app.media.flower'</span>), $r(<span class="hljs-string">'app.media.sky'</span>), $r(<span class="hljs-string">'app.media.spring'</span>)] }];</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onAvatarClicked</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span> = index;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span></li><li>    }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPersonalPageShow</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPersonalPageShow</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">alphaValue</span> = <span class="hljs-number">0</span>;</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onPersonalPageBack</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">animateTo</span>({</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span></li><li>    }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPersonalPageShow</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPersonalPageShow</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">alphaValue</span> = <span class="hljs-number">1</span>;</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">PersonalPageBuilder</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">allPostData</span>[index].<span class="hljs-property">avatar</span>)</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">200</span> })</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">100</span>)</li><li>        <span class="hljs-comment">// 头像配置共享元素效果，与点击的头像的id匹配</span></li><li>        .<span class="hljs-title function_">geometryTransition</span>(index.<span class="hljs-title function_">toString</span>())</li><li>        .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.99</span>))</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">allPostData</span>[index].<span class="hljs-property">name</span>)</li><li>        .<span class="hljs-title function_">font</span>({ <span class="hljs-attr">size</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">weight</span>: <span class="hljs-number">600</span> })</li><li>        <span class="hljs-comment">// 对文本添加出现转场效果</span></li><li>        .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">asymmetric</span>(</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> })),</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> })</li><li>        ))</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'你好，我是'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">allPostData</span>[index].<span class="hljs-property">name</span>)</li><li>        <span class="hljs-comment">// 对文本添加出现转场效果</span></li><li>        .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">asymmetric</span>(</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> })),</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> })</li><li>        ))</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">360</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">780</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onPersonalPageBack</span>(index);</li><li>    })</li><li>    .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">asymmetric</span>(</li><li>      <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.99</span>),</li><li>      <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>    ))</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">allPostData</span>, <span class="hljs-function">(<span class="hljs-params">postData: PostData, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Post</span>({ <span class="hljs-attr">data</span>: postData, <span class="hljs-attr">index</span>: index, <span class="hljs-attr">onAvatarClicked</span>: <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> { <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onAvatarClicked</span>(index) } })</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }, <span class="hljs-function">(<span class="hljs-params">postData: PostData, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#40808080'</span>)</li><li>    .<span class="hljs-title function_">bindContentCover</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPersonalPageShow</span>,</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">PersonalPageBuilder</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedIndex</span>), { <span class="hljs-attr">modalTransition</span>: <span class="hljs-title class_">ModalTransition</span>.<span class="hljs-property">NONE</span> })</li><li>    .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">alphaValue</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct  <span class="hljs-title class_">Post</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">PostData</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">expandImageSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">avatarSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>;</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">onAvatarClicked</span>: <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> { };</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">avatar</span>)</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span> })</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avatarSize</span> / <span class="hljs-number">2</span>)</li><li>          .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onAvatarClicked</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>);</li><li>          })</li><li>          <span class="hljs-comment">// 对头像绑定共享元素转场的id</span></li><li>          .<span class="hljs-title function_">geometryTransition</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>(), {<span class="hljs-attr">follow</span>:<span class="hljs-literal">true</span>})</li><li>          .<span class="hljs-title function_">transition</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span> }))</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">name</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">15</span> }) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">images</span>, <span class="hljs-function">(<span class="hljs-params">imageResource: Resource, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Image</span>(imageResource)</li><li>            .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">100</span> })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">imageResource: Resource, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">250</span> })</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>效果为点击主页的头像后，弹出模态页面显示个人信息，并且两个页面之间的头像做一镜到底动效：</p>     <p><span><img originheight="630" originwidth="291" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114934.54506954731139000556612758134423:50001231000000:2800:071708C7421B37EB7C9062B8B0B2E14C8E3414C65BFDAAD14708D7717ACA9108.gif" class="notEnlarge" width="291" height="630"></span></p>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/harmonyos_samples/transitions-collection" target="_blank">转场动效合集</a></li>     </ul>    </div>   </div>   <div></div></div>