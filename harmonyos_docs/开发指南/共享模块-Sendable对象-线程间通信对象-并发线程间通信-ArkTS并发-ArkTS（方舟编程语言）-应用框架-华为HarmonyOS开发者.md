<h1 _ngcontent-peg-c119="" class="doc-title ng-star-inserted" title="共享模块"> 共享模块 </h1>

<div _ngcontent-peg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>共享模块是进程内只会加载一次的模块，使用"use shared"这一指令来标记一个模块是否为共享模块。</p> <p>非共享模块在同一线程内只加载一次，而在不同线程中会多次加载，每个线程都会生成新的模块对象。因此，目前只能使用共享模块实现进程单例。</p>  <div class="tiledSection"><h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2><ul><li><p>"use shared"需要与"use strict"一样写在ArkTS文件顶层，写在import语句之后其他语句之前。</p>  <p>共享属性不具备传递性。非共享模块A即使引入了共享模块B，也不会因此变成共享模块。</p>  </li><li><p>共享模块只支持ets文件。</p>  </li><li><p>共享模块内不允许使用side-effects-import。</p>  <p>共享模块在同一进程内仅加载一次，可在不同线程间共享。</p> <p>共享模块加载时，导入的非共享模块不会立即加载。在共享模块内访问依赖的非共享模块导出变量时，当前线程会懒加载对应的非共享模块。非共享模块在线程间隔离，不同线程访问时会进行一次懒加载。</p> <p>由于side-effects-import不涉及导出变量，因此不会被加载，也不受支持。</p>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// test.ets</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"This runs immediately when imported"</span>);</li></ol></pre></div></div>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sharedModule.ets</span></li><li><span class="hljs-comment">// 不允许使用side-effects-import，编译报错</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-string">"./test"</span>;</li><li><span class="hljs-string">"use shared"</span></li></ol></pre></div></div>  </li><li><p>共享模块导出的变量必须是可共享对象。</p>  <p>共享模块在并发实例间可共享，因此导出的所有对象必须是可共享的。可共享对象参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable支持的数据类型">Sendable支持的数据类型</a>。</p>  </li><li><p>共享模块不支持re-export写法。</p>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// test.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> num = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> str = <span class="hljs-string">'aaa'</span>;</li></ol></pre></div></div>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// share.ets</span></li><li><span class="hljs-comment">// 共享模块</span></li><li><span class="hljs-string">'use shared'</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./test'</span>; <span class="hljs-comment">// 编译报错</span></li><li><span class="hljs-keyword">export</span> {num, str} <span class="hljs-keyword">from</span> <span class="hljs-string">'./test'</span>; <span class="hljs-comment">// 产生运行时报错</span></li></ol></pre></div></div>  </li><li><p>共享模块可以引用其他共享模块或非共享模块，引用和被引用场景没有限制。</p>  </li><li><p>仅支持使用静态加载、napi_load_module或napi_load_module_with_info加载共享模块。</p>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// test.ets</span></li><li><span class="hljs-keyword">import</span> { num } <span class="hljs-keyword">from</span> <span class="hljs-string">'./A'</span>; <span class="hljs-comment">// 支持静态加载</span></li><li>
</li><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">let</span> wk = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">"./A"</span>); <span class="hljs-comment">// 不支持其他方式加载共享模块, 将产生运行时报错</span></li></ol></pre></div></div>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// A.ets</span></li><li><span class="hljs-string">'use shared'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li></ol></pre></div></div>  </li></ul> </div>  <div class="tiledSection"><h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2><ol><li><p>共享模块导出Sendable对象。</p>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 共享模块sharedModule.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArkTSUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-comment">// 声明当前模块为共享模块，只能导出可Sendable数据</span></li><li><span class="hljs-string">"use shared"</span></li><li>
</li><li><span class="hljs-comment">// 共享模块，SingletonA全局唯一</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonA</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">count_</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">lock_</span>: <span class="hljs-title class_">ArkTSUtils</span>.<span class="hljs-property">locks</span>.<span class="hljs-property">AsyncLock</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArkTSUtils</span>.<span class="hljs-property">locks</span>.<span class="hljs-title class_">AsyncLock</span>()</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getCount</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lock_</span>.<span class="hljs-title function_">lockAsync</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count_</span>;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">increaseCount</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lock_</span>.<span class="hljs-title function_">lockAsync</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count_</span>++;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> singletonA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonA</span>();</li></ol></pre></div></div>   </li><li><p>在多个线程中操作共享模块导出的对象。</p>  <div _ngcontent-peg-c106="" class="highlight-div"><div _ngcontent-peg-c106="" class="highlight-div-header"><div _ngcontent-peg-c106="" class="highlight-div-header-left"><div _ngcontent-peg-c106="" class="handle-button expand-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-peg-c106="" class="highlight-div-header-right"><div _ngcontent-peg-c106="" class="handle-button ai-button"></div><div _ngcontent-peg-c106="" class="handle-button line-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-peg-c106="" class="handle-button theme-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-peg-c106="" class="handle-button copy-button"><div _ngcontent-peg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-peg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { singletonA } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sharedModule'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increaseCount</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> singletonA.<span class="hljs-title function_">increaseCount</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"SharedModule: count is:"</span> + <span class="hljs-keyword">await</span> singletonA.<span class="hljs-title function_">getCount</span>());</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printCount</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"SharedModule: count is:"</span> + <span class="hljs-keyword">await</span> singletonA.<span class="hljs-title function_">getCount</span>());</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"MainThread print count"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-title function_">printCount</span>();</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Taskpool print count"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(printCount);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"MainThread increase count"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-title function_">increaseCount</span>();</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Taskpool increase count"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(increaseCount);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>