<h1 _ngcontent-xie-c119="" class="doc-title ng-star-inserted" title="关系型数据库跨设备数据同步 (ArkTS)"> 关系型数据库跨设备数据同步 (ArkTS) </h1>

<div _ngcontent-xie-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>当应用程序本地存储的关系型数据存在跨设备同步的需求时，可以将需要同步的表数据迁移到新的支持跨设备的表中，当然也可以在刚完成表创建时设置其支持跨设备。</p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <p>关系型数据库跨设备数据同步，支持应用在多设备间同步存储的关系型数据。</p>     <ul>      <li>分布式表：支持组网内多设备间数据同步的数据库表。来自其他设备的数据将同步至本地，并通过与设备ID关联的表名进行存储。</li>      <li>数据同步：将设备上数据库中分布式表发生的变更，同步至组网内其他设备。有推送数据和拉取数据两种方式触发同步。</li>      <li>数据变化通知：组网内其他设备数据发生的变化同步至当前设备时，会执行已注册的回调函数。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>          <p>底层通信组件完成设备发现和认证，会通知上层应用程序设备上线。收到设备上线的消息后数据管理服务可以在两个设备之间建立加密的数据传输通道，利用该通道在两个设备之间进行数据同步。</p>    </div>    <div class="tiledSection">     <h3 id="数据跨设备同步机制" class="firsth2">数据跨设备同步机制<i class="anchor-icon anchor-icon-link" anchorid="数据跨设备同步机制" tips="复制节点链接"></i></h3>          <p><span><img originheight="556" originwidth="880" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114733.74455751684728151028137526629546:50001231000000:2800:0747B20D40F72FB02B7E591E551AD75A6B895100D0EB10C8C8CF92E0440848C7.jpg" width="880" height="556"></span></p>     <p>业务将数据写入关系型数据库后，向数据管理服务发起同步请求。</p>     <p>数据管理服务从应用沙箱内读取待同步数据，根据对端设备的deviceId将数据发送到其他设备的数据管理服务。再由数据管理服务将数据写入同应用的数据库内。</p>    </div>    <div class="tiledSection">     <h3 id="数据变化通知机制">数据变化通知机制<i class="anchor-icon anchor-icon-link" anchorid="数据变化通知机制" tips="复制节点链接"></i></h3>          <p>增、删、改数据库时，会给订阅者发送数据变化的通知。主要分为本地数据变化通知和分布式数据变化通知。</p>     <ul>      <li>       <p><strong>本地数据变化通知</strong>：本地设备的应用内订阅数据变化通知，数据库增删改数据时，会收到通知。</p></li>      <li>       <p><strong>分布式数据变化通知</strong>：同一应用订阅组网内其他设备数据变化的通知，其他设备增删改数据时，本设备会收到通知。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>每个应用程序最多支持同时打开16个关系型分布式数据库。</p></li>      <li>       <p>单个数据库最多支持注册8个订阅数据变化的回调。</p></li>      <li>       <p>不支持将含有复合键的表设置为分布式表。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>以下是关系型设备协同分布式数据库跨设备数据同步功能的相关接口，大部分为异步接口。异步接口均有callback和Promise两种返回形式，下表均以callback形式为例，更多接口及使用方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore" target="_blank">关系型数据库</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">setDistributedTables(tables: Array&lt;string&gt;, callback: AsyncCallback&lt;void&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">设置分布式同步表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">sync(mode: SyncMode, predicates: RdbPredicates, callback: AsyncCallback&lt;Array&lt;[string, number]&gt;&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">分布式数据同步。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(event: 'dataChange', type: SubscribeType, observer: Callback&lt;Array&lt;string&gt;&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">订阅分布式数据变化。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">off(event:'dataChange', type: SubscribeType, observer: Callback&lt;Array&lt;string&gt;&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">取消订阅分布式数据变化。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">obtainDistributedTableName(device: string, table: string, callback: AsyncCallback&lt;string&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">根据本地数据库表名获取指定设备上的表名。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">remoteQuery(device: string, table: string, predicates: RdbPredicates, columns: Array&lt;string&gt; , callback: AsyncCallback&lt;ResultSet&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">根据指定条件查询远程设备数据库中的数据。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>数据只允许向数据安全标签不高于对端设备安全等级的设备同步数据，具体规则可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/access-control-by-device-and-data-level#跨设备同步访问控制机制">跨设备同步访问控制机制</a>。</p>      </div></div></div>     <ol>      <li>       <p>导入模块。</p>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li></ol></pre></div></div></li>      <li>       <p>请求权限。</p>       <ol>        <li>需要申请ohos.permission.DISTRIBUTED_DATASYNC权限，配置方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>。</li>        <li>同时需要在应用首次启动时弹窗向用户申请授权，使用方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</li>       </ol></li>      <li>       <p>创建关系型数据库，创建数据表，并将需要进行跨设备同步的数据表设置为分布式表。</p>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { distributedDeviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">'RdbTest.db'</span>,</li><li>  <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      store = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable constant_">STORE_CONFIG</span>);</li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">executeSql</span>(<span class="hljs-string">'CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB)'</span>);</li><li>      <span class="hljs-comment">// 将已创建的表设置分布式表。</span></li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">setDistributedTables</span>([<span class="hljs-string">'EMPLOYEE'</span>]);</li><li>      <span class="hljs-comment">// 进行数据的相关操作</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set distributed tables. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>订阅组网内其他设备的数据变化消息。</p>       <ol>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#ondatachange" target="_blank">on('dataChange')</a>接口监听其他设备的数据变化，当数据变化同步至当前设备时，将执行订阅的回调方法，入参为数据发生变化的设备ID列表。</li>        <li>通过设备ID获取与设备对应的分布式表表名，查询对应设备分布式表中的数据。</li>       </ol>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 调用分布式数据订阅接口，注册数据库的观察者</span></li><li>    <span class="hljs-comment">// 当分布式数据库中的数据发生更改时，将调用回调</span></li><li>    store.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataChange'</span>, relationalStore.<span class="hljs-property">SubscribeType</span>.<span class="hljs-property">SUBSCRIBE_TYPE_REMOTE</span>, <span class="hljs-keyword">async</span> (devices) =&gt; {</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; devices.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">let</span> device = devices[i];</li><li>        <span class="hljs-keyword">if</span> (!store) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The data of device:<span class="hljs-subst">${device}</span> has been changed.`</span>);</li><li>        <span class="hljs-comment">// 获取device对应的分布式表名。</span></li><li>        <span class="hljs-keyword">const</span> distributedTableName = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">obtainDistributedTableName</span>(device, <span class="hljs-string">'EMPLOYEE'</span>);</li><li>        <span class="hljs-comment">// 创建查询谓词，查询组网内设备分布式表的数据</span></li><li>        <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(distributedTableName);</li><li>        <span class="hljs-keyword">const</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">query</span>(predicates);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`device <span class="hljs-subst">${device}</span>, table EMPLOYEE rowCount is: <span class="hljs-subst">${resultSet.rowCount}</span>`</span>);</li><li>      }</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register observer. Code:<span class="hljs-subst">${err.code}</span>,message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>同步当前设备数据变化至组网内其他设备。</p>       <ol>        <li>当前设备分布式表中的数据发生变化后，调用RdbStore的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#sync-1" target="_blank">sync</a>接口传入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-e#syncmode" target="_blank">SYNC_MODE_PUSH</a>参数推送数据变化至其他设备。</li>        <li>通过谓词的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbpredicates#indevices" target="_blank">inDevices</a>方法指定推送的目标设备。</li>       </ol>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store) {</li><li>  <span class="hljs-comment">// 当前设备分布式数据表中插入新数据</span></li><li>  <span class="hljs-keyword">const</span> ret = store.<span class="hljs-title function_">insertSync</span>(<span class="hljs-string">'EMPLOYEE'</span>, {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">'sync_me'</span>,</li><li>    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,</li><li>    <span class="hljs-attr">salary</span>: <span class="hljs-number">666</span></li><li>  });</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Insert to distributed table EMPLOYEE, result: '</span> + ret);</li><li>  <span class="hljs-comment">// 查询组网内的设备列表</span></li><li>  <span class="hljs-keyword">const</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.example.appdatamgrverify'</span>);</li><li>  <span class="hljs-keyword">const</span> deviceList = deviceManager.<span class="hljs-title function_">getAvailableDeviceListSync</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">syncTarget</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  deviceList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">networkId</span>) {</li><li>      syncTarget.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">networkId</span>);</li><li>    }</li><li>  });</li><li>  <span class="hljs-keyword">if</span> (syncTarget.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'no device to sync'</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 构造用于同步分布式表的谓词对象</span></li><li>    <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>    <span class="hljs-comment">// 指定要同步的设备列表</span></li><li>    predicates.<span class="hljs-title function_">inDevices</span>(syncTarget);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 调用同步数据的接口推送当前设备数据变化至组网内其他设备</span></li><li>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">sync</span>(relationalStore.<span class="hljs-property">SyncMode</span>.<span class="hljs-property">SYNC_MODE_PUSH</span>, predicates);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Push data success.'</span>);</li><li>      <span class="hljs-comment">// 获取同步结果</span></li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; result.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">const</span> deviceId = result[i][<span class="hljs-number">0</span>];</li><li>        <span class="hljs-keyword">const</span> syncResult = result[i][<span class="hljs-number">1</span>];</li><li>        <span class="hljs-keyword">if</span> (syncResult === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`device:<span class="hljs-subst">${deviceId}</span> sync success`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`device:<span class="hljs-subst">${deviceId}</span> sync failed, status:<span class="hljs-subst">${syncResult}</span>`</span>);</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Push data failed, code: '</span> + e.<span class="hljs-property">code</span> + <span class="hljs-string">', message: '</span> + e.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>拉取组网内其他设备的数据变化。</p>       <ol>        <li>当前设备可调用RdbStore的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#sync-1" target="_blank">sync</a>接口传入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-e#syncmode" target="_blank">SYNC_MODE_PULL</a>参数拉取组网内其他设备的数据变化。</li>        <li>通过谓词的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbpredicates#indevices" target="_blank">inDevices</a>方法指定拉取的目标设备。</li>       </ol>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store) {</li><li>  <span class="hljs-comment">// 查询组网内的设备列表</span></li><li>  <span class="hljs-keyword">const</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.example.appdatamgrverify'</span>);</li><li>  <span class="hljs-keyword">const</span> deviceList = deviceManager.<span class="hljs-title function_">getAvailableDeviceListSync</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">syncTarget</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  deviceList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">networkId</span>) {</li><li>      syncTarget.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">networkId</span>);</li><li>    }</li><li>  });</li><li>  <span class="hljs-keyword">if</span> (syncTarget.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'no device to pull data'</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 构造用于同步分布式表的谓词对象</span></li><li>    <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>    <span class="hljs-comment">// 指定要同步的设备列表</span></li><li>    predicates.<span class="hljs-title function_">inDevices</span>(syncTarget);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 调用同步数据的接口拉取其他设备数据变化至当前设备</span></li><li>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">sync</span>(relationalStore.<span class="hljs-property">SyncMode</span>.<span class="hljs-property">SYNC_MODE_PULL</span>, predicates);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Pull data success.'</span>);</li><li>      <span class="hljs-comment">// 获取同步结果</span></li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; result.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">const</span> deviceId = result[i][<span class="hljs-number">0</span>];</li><li>        <span class="hljs-keyword">const</span> syncResult = result[i][<span class="hljs-number">1</span>];</li><li>        <span class="hljs-keyword">if</span> (syncResult === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`device:<span class="hljs-subst">${deviceId}</span> sync success`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`device:<span class="hljs-subst">${deviceId}</span> sync failed, status:<span class="hljs-subst">${syncResult}</span>`</span>);</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Pull data failed, code: '</span> + e.<span class="hljs-property">code</span> + <span class="hljs-string">', message: '</span> + e.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>当数据未完成同步，或未触发数据同步时，可使用RdbStore的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#remotequery-1" target="_blank">remoteQuery</a>方法查询组网内指定设备上分布式表中的数据。</p>       <div _ngcontent-xie-c106="" class="highlight-div"><div _ngcontent-xie-c106="" class="highlight-div-header"><div _ngcontent-xie-c106="" class="highlight-div-header-left"><div _ngcontent-xie-c106="" class="handle-button expand-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xie-c106="" class="highlight-div-header-right"><div _ngcontent-xie-c106="" class="handle-button ai-button"></div><div _ngcontent-xie-c106="" class="handle-button line-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xie-c106="" class="handle-button theme-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xie-c106="" class="handle-button copy-button"><div _ngcontent-xie-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xie-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store) {</li><li>  <span class="hljs-comment">// 查询组网内的设备列表</span></li><li>  <span class="hljs-keyword">const</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.example.appdatamgrverify'</span>);</li><li>  <span class="hljs-keyword">const</span> deviceList = deviceManager.<span class="hljs-title function_">getAvailableDeviceListSync</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">devices</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  deviceList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">networkId</span>) {</li><li>      devices.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">networkId</span>);</li><li>    }</li><li>  });</li><li>  <span class="hljs-keyword">if</span> (devices.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'no device to query data'</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 构造用于查询分布式表的谓词对象</span></li><li>    <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 查询组网内设备上的分布式表</span></li><li>      <span class="hljs-keyword">const</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">remoteQuery</span>(devices[<span class="hljs-number">0</span>], <span class="hljs-string">'EMPLOYEE'</span>, predicates, [<span class="hljs-string">'ID'</span>, <span class="hljs-string">'NAME'</span>, <span class="hljs-string">'AGE'</span>, <span class="hljs-string">'SALARY'</span>, <span class="hljs-string">'CODES'</span>]);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ResultSet column names: <span class="hljs-subst">${resultSet.columnNames}</span>, column count: <span class="hljs-subst">${resultSet.columnCount}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Remote query failed, code: '</span> + e.<span class="hljs-property">code</span> + <span class="hljs-string">', message: '</span> + e.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>