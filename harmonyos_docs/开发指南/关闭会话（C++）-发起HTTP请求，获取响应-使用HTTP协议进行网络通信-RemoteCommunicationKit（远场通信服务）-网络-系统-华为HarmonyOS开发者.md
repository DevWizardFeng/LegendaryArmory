<h1 _ngcontent-nau-c119="" class="doc-title ng-star-inserted" title="关闭会话（C++）"> 关闭会话（C++） </h1>

<div _ngcontent-nau-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当一个远场通信请求完成，即数据已经成功发送并收到确认，或者在某些情况下，由于超时或其他错误原因，通信尝试失败，此时应立即调用相应的“关闭会话”或“释放资源”方法。这一操作的主要目的是：</p>    <ul>     <li>释放资源：在通信过程中，系统会分配各种资源，包括内存、网络带宽、处理器时间等，以支持数据的发送和接收。一旦通信结束，这些资源应被及时释放，以便它们可以被重新用于其他任务或通信。</li>     <li>清理状态：关闭会话还涉及清理与特定会话相关的所有内部状态信息，如缓存、连接状态标志等。这有助于保持系统的清晰性和可预测性，避免潜在的资源泄漏或状态冲突。</li>     <li>优化性能：及时释放资源有助于提高系统的整体性能。例如，通过快速释放网络带宽，可以减少延迟，提高后续通信的效率。</li>     <li>错误恢复：在遇到通信错误时，正确的关闭会话操作可以帮助系统更快地从错误状态中恢复，避免资源锁定或死锁情况的发生。</li>    </ul>    <p>在请求结束后，及时关闭会话并释放相关资源是保持系统健康和高效运行的关键步骤。这不仅有助于优化资源利用，还能提高系统的稳定性和可靠性。</p>    <div class="tiledSection">     <h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2>          <p>关闭会话能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section39031623104212">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section39031623104212" tips="复制节点链接"></i></h2>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-overview#gaf659dbbb59360b9c587fb4081b52dd14" target="_blank">接口文档</a>。</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.1" valign="top" width="50%">         <p>接口名</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.2" valign="top" width="50%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">         <p>uint32_t HMS_Rcp_CloseSession(<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-overview#ga4f3a7d39c18fe6fdf01c52759213ddcd" target="_blank">Rcp_Session</a> **session);</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>关闭会话。</p></td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="section9433448164211">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section9433448164211" tips="复制节点链接"></i></h2>          <ol>      <li><span>CPP侧导入模块。</span>       <p></p>       <div _ngcontent-nau-c106="" class="highlight-div"><div _ngcontent-nau-c106="" class="highlight-div-header"><div _ngcontent-nau-c106="" class="highlight-div-header-left"><div _ngcontent-nau-c106="" class="handle-button expand-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nau-c106="" class="highlight-div-header-right"><div _ngcontent-nau-c106="" class="handle-button ai-button"></div><div _ngcontent-nau-c106="" class="handle-button line-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nau-c106="" class="handle-button theme-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nau-c106="" class="handle-button copy-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nau-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"RemoteCommunicationKit/rcp.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li></ol></pre></div></div>       <p></p></li>      <li><span>CMakeLists.txt中添加以下lib。（具体请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/remote-communication-preparations#section2095732915253">C API开发准备</a>）。</span>       <p></p>       <div _ngcontent-nau-c106="" class="highlight-div"><div _ngcontent-nau-c106="" class="highlight-div-header"><div _ngcontent-nau-c106="" class="highlight-div-header-left"><div _ngcontent-nau-c106="" class="handle-button expand-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nau-c106="" class="highlight-div-header-right"><div _ngcontent-nau-c106="" class="handle-button ai-button"></div><div _ngcontent-nau-c106="" class="handle-button line-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nau-c106="" class="handle-button theme-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nau-c106="" class="handle-button copy-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nau-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>librcp_c.so</li></ol></pre></div></div>       <p></p></li>      <li><span>创建会话，会话发起请求后关闭会话。“http://www.example.com”请根据实际情况替换为想要请求的URL地址。等待响应返回后，销毁request并关闭session。</span>       <p></p>       <div _ngcontent-nau-c106="" class="highlight-div"><div _ngcontent-nau-c106="" class="highlight-div-header"><div _ngcontent-nau-c106="" class="highlight-div-header-left"><div _ngcontent-nau-c106="" class="handle-button expand-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nau-c106="" class="highlight-div-header-right"><div _ngcontent-nau-c106="" class="handle-button ai-button"></div><div _ngcontent-nau-c106="" class="handle-button line-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nau-c106="" class="handle-button theme-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nau-c106="" class="handle-button copy-button"><div _ngcontent-nau-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nau-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ResponseCallback</span><span class="hljs-params">(<span class="hljs-type">void</span> *usrCtx, Rcp_Response *response, <span class="hljs-type">uint32_t</span> errCode)</span> </span>{</li><li>    (<span class="hljs-type">void</span> *)usrCtx;</li><li>    <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">NULL</span>) {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Response status: %d\n"</span>, response-&gt;statusCode);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fetch failed: errCode: %u\n"</span>, errCode);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (response != <span class="hljs-literal">NULL</span>) {</li><li>        response-&gt;<span class="hljs-built_in">destroyResponse</span>(response);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *kHttpServerAddress = <span class="hljs-string">"http://www.example.com"</span>;</li><li>    Rcp_Request *request = <span class="hljs-built_in">HMS_Rcp_CreateRequest</span>(kHttpServerAddress);</li><li>    request-&gt;method = RCP_METHOD_GET;</li><li>    <span class="hljs-type">uint32_t</span> errCode = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 创建session</span></li><li>    Rcp_Session *session = <span class="hljs-built_in">HMS_Rcp_CreateSession</span>(<span class="hljs-literal">NULL</span>, &amp;errCode);</li><li>    <span class="hljs-comment">// 配置请求回调</span></li><li>    Rcp_ResponseCallbackObject responseCallback = {ResponseCallback, <span class="hljs-literal">NULL</span>};</li><li>    <span class="hljs-comment">// 发起fetch请求</span></li><li>    errCode = <span class="hljs-built_in">HMS_Rcp_Fetch</span>(session, request, &amp;responseCallback);</li><li>    <span class="hljs-comment">// 等待fetch结果，仅是等待异步调用完成，开发者可根据自己实际场景处理回调。</span></li><li>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">3</span>);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fetch completed, errCode: %u\n"</span>, errCode);</li><li>    <span class="hljs-comment">// 在退出前取消可能还在执行的requests</span></li><li>    errCode = <span class="hljs-built_in">HMS_Rcp_CancelSession</span>(session);</li><li>    <span class="hljs-comment">// 关闭session</span></li><li>    errCode = <span class="hljs-built_in">HMS_Rcp_CloseSession</span>(&amp;session);</li><li>    <span class="hljs-comment">// 清理request</span></li><li>    <span class="hljs-built_in">HMS_Rcp_DestroyRequest</span>(request);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>