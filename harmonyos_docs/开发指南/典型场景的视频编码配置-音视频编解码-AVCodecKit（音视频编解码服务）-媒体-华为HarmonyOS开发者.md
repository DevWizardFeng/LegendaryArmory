<h1 _ngcontent-cjq-c119="" class="doc-title ng-star-inserted" title="典型场景的视频编码配置"> 典型场景的视频编码配置 </h1>

<div _ngcontent-cjq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>此文档描述了AVCodec视频编码能力在不同应用场景下的推荐配置参数，供开发者根据实际应用场景进行视频编码应用的开发。</p> <p>视频编码在视频通话、视频会议、直播、视频编辑、视频分享等场景均有广泛使用，按照体验要求，上述场景可归纳划分为低时延、实时流媒体、离线编码三大类别应用场景。</p> <p>本文将给出三大类别应用场景下视频编码的推荐参数配置，供开发者根据不同的应用场景下的需求进行参数配置选择。</p>  <div class="tiledSection"><h2 id="通用开发步骤">通用开发步骤<i class="anchor-icon anchor-icon-link" anchorid="通用开发步骤" tips="复制节点链接"></i></h2><p><strong>在CMake脚本中链接动态库</strong></p> <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_venc.so)</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>  </div></div></div> <p><strong>添加头文件</strong></p> <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="低时延场景">低时延场景<i class="anchor-icon anchor-icon-link" anchorid="低时延场景" tips="复制节点链接"></i></h2><p>低时延编码场景包括视频通话、视频会议、连麦直播等对端到端时延要求较高的交互式应用。</p> <p><strong>开发指导</strong></p> <p>基础编码流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>，下面仅针对编码器配置阶段做具体说明。</p> <ol><li><p>配置编码器参数。</p>  <p> 在配置编码器参数阶段，配置适合低时延编码场景的参数。</p>  <p> 低时延编码场景，典型分辨率的编码参数（以H.265为例）推荐如下：</p>   <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.5.1.4.1.6.1.1" valign="top" width="20%">分辨率</th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.1.4.1.6.1.2" valign="top" width="20%">帧率（fps）</th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.1.4.1.6.1.3" valign="top" width="20%">码率（kpbs）</th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.1.4.1.6.1.4" valign="top" width="20%">接入帧间隔（ms）</th> <th align="left" class="cellrowborder" id="mcps1.3.5.5.1.4.1.6.1.5" valign="top" width="20%">码控模式</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%">1920x1080</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">1500</td> <td class="cellrowborder" valign="top" width="20%">-1</td> <td class="cellrowborder" valign="top" width="20%">CBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1280x720</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">1000</td> <td class="cellrowborder" valign="top" width="20%">-1</td> <td class="cellrowborder" valign="top" width="20%">CBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">960x540</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">700</td> <td class="cellrowborder" valign="top" width="20%">-1</td> <td class="cellrowborder" valign="top" width="20%">CBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">640x360</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">550</td> <td class="cellrowborder" valign="top" width="20%">-1</td> <td class="cellrowborder" valign="top" width="20%">CBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">320x180</td> <td class="cellrowborder" valign="top" width="20%">20</td> <td class="cellrowborder" valign="top" width="20%">200</td> <td class="cellrowborder" valign="top" width="20%">-1</td> <td class="cellrowborder" valign="top" width="20%">CBR</td> </tr>  </tbody></table></div> </div>  <p> 示例中的变量说明如下：</p>  <ul><li>videoEnc：视频编码器实例的指针。创建方式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式">视频编码Surface模式</a>“步骤-2：创建编码器实例对象”。</li></ul>  <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1.1 创建AVFormat参数实例。</span></li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li>
</li><li><span class="hljs-comment">// 1.2 填充编码参数键值对（以1080p@30fps SDR输入源为例）。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-number">1920</span>); <span class="hljs-comment">// 必须配置，视频宽。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-number">1080</span>); <span class="hljs-comment">// 必须配置，视频高。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">AV_PIXEL_FORMAT_NV12</span>); <span class="hljs-comment">// 必须配置，视频源数据排布格式。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// VUI信息，0:limited range 1:full range。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT709</span>); <span class="hljs-comment">// VUI信息，视频源色域。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_BT709</span>); <span class="hljs-comment">// VUI信息，OETF/EOTF曲线。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">OH_MatrixCoefficient</span>:: <span class="hljs-title class_">MATRIX_COEFFICIENT_BT709</span>); <span class="hljs-comment">// VUI信息，YUV和RGB转换矩阵。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">OH_HEVCProfile</span>::<span class="hljs-title class_">HEVC_PROFILE_MAIN</span>); <span class="hljs-comment">// 视频编码器profile。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-number">30.0</span>); <span class="hljs-comment">// 必须配置，视频帧率。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_I_FRAME_INTERVAL</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// 必须配置，接入帧间隔。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_CBR</span>); <span class="hljs-comment">// 必须配置，码控模式配置为CBR。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-number">1500000</span>); <span class="hljs-comment">// 必须配置，设置码率，单位为bps。</span></li><li>
</li><li><span class="hljs-comment">// 1.3 配置视频编码器的编码参数。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1.4 配置完成后销毁AVFormat实例。</span></li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li></ol></pre></div></div>  <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>接入帧间隔-1表示只有第一帧为接入帧，开发者可以根据传输情况和画质情况，在运行过程中动态配置编码器参数，实现插入新的接入帧（IDR）功能。</p>  </div></div></div>  </li><li><p>（可选）在运行过程中动态配置编码器参数。</p>  <p> 详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式">视频编码Surface模式</a>“步骤-9：OH_VideoEncoder_SetParameter()在运行过程中动态配置编码器参数”。</p>  <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>// <span class="hljs-number">2.1</span> 创建AVFormat参数实例。</li><li>OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create();</li><li><span class="hljs-regexp">//</span> <span class="hljs-number">2.2</span> 填充编码参数键值对（动态请求IDR帧）。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_REQUEST_I_FRAME, <span class="hljs-number">1</span>);</li><li><span class="hljs-regexp">//</span> <span class="hljs-number">2.3</span> 设置编码器参数生效。</li><li>ret = OH_VideoEncoder_SetParameter(videoEnc, <span class="hljs-keyword">format</span>);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-regexp">//</span> 异常处理。</li><li>}</li><li>// <span class="hljs-number">2.4</span> 配置完成后销毁AVFormat实例。</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>);</li></ol></pre></div></div>  <p> 如果需要适配网络波动，推荐结合采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding-temporal-scalability">时域可分层视频编码</a>配置。</p>  </li></ol> </div>  <div class="tiledSection"><h2 id="实时流媒体编码">实时流媒体编码<i class="anchor-icon anchor-icon-link" anchorid="实时流媒体编码" tips="复制节点链接"></i></h2><p>实时流媒体编码场景包括泛娱乐直播、游戏直播等对视频端到端时延要求不高的应用场景。</p> <p><strong>开发指导</strong></p> <p>基础编码流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>，下面仅针对编码器配置阶段，对配置实时流媒体编码场景的参数做具体说明。</p> <p>娱乐直播场景，典型分辨率的编码参数（以H.265为例）推荐如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.6.1.6.1.1" valign="top" width="20%">分辨率</th> <th align="left" class="cellrowborder" id="mcps1.3.6.6.1.6.1.2" valign="top" width="20%">帧率（fps）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.6.1.6.1.3" valign="top" width="20%">码率（kpbs）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.6.1.6.1.4" valign="top" width="20%">接入帧间隔（ms）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.6.1.6.1.5" valign="top" width="20%">码控模式</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%">1920x1080</td> <td class="cellrowborder" valign="top" width="20%">25</td> <td class="cellrowborder" valign="top" width="20%">3000</td> <td class="cellrowborder" valign="top" width="20%">2000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1080x720</td> <td class="cellrowborder" valign="top" width="20%">25</td> <td class="cellrowborder" valign="top" width="20%">1500</td> <td class="cellrowborder" valign="top" width="20%">2000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">960x544</td> <td class="cellrowborder" valign="top" width="20%">25</td> <td class="cellrowborder" valign="top" width="20%">1000</td> <td class="cellrowborder" valign="top" width="20%">2000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">864x480</td> <td class="cellrowborder" valign="top" width="20%">25</td> <td class="cellrowborder" valign="top" width="20%">800</td> <td class="cellrowborder" valign="top" width="20%">2000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr>  </tbody></table></div> </div> <p>游戏直播场景，典型分辨率的编码参数（以H.265为例）推荐如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.8.1.6.1.1" valign="top" width="20%">分辨率</th> <th align="left" class="cellrowborder" id="mcps1.3.6.8.1.6.1.2" valign="top" width="20%">帧率（fps）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.8.1.6.1.3" valign="top" width="20%">码率（kpbs）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.8.1.6.1.4" valign="top" width="20%">接入帧间隔（ms）</th> <th align="left" class="cellrowborder" id="mcps1.3.6.8.1.6.1.5" valign="top" width="20%">码控模式</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%">1920x1080</td> <td class="cellrowborder" valign="top" width="20%">60</td> <td class="cellrowborder" valign="top" width="20%">6000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr>  </tbody></table></div> </div> <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 创建AVFormat参数实例。</span></li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-comment">// 2. 填充编码参数键值对（以1080p@25fps SDR输入源为例）。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-number">1080</span>); <span class="hljs-comment">// 必须配置，视频宽。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-number">1920</span>); <span class="hljs-comment">// 必须配置，视频高。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">AV_PIXEL_FORMAT_NV12</span>); <span class="hljs-comment">// 必须配置，视频源数据排布格式。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// VUI信息，0:limited range 1:full range。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT709</span>); <span class="hljs-comment">// VUI信息，视频源色域。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_BT709</span>); <span class="hljs-comment">// VUI信息，OETF/EOTF曲线。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">OH_MatrixCoefficient</span>:: <span class="hljs-title class_">MATRIX_COEFFICIENT_BT709</span>); <span class="hljs-comment">// VUI信息，YUV和RGB转换矩阵。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">OH_HEVCProfile</span>::<span class="hljs-title class_">HEVC_PROFILE_MAIN</span>); <span class="hljs-comment">// 视频编码器profile。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-number">25.0</span>); <span class="hljs-comment">// 必须配置，视频帧率。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_I_FRAME_INTERVAL</span>, <span class="hljs-number">2000</span>); <span class="hljs-comment">// 必须配置，接入帧间隔，单位为ms。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_VBR</span>); <span class="hljs-comment">// 必须配置，码控模式配置为VBR。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-number">3000000</span>); <span class="hljs-comment">// 必须配置，设置码率，单位为bps。</span></li><li><span class="hljs-comment">// 3. 配置视频编码器的编码参数。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 4. 配置完成后销毁AVFormat实例。</span></li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="离线编码场景">离线编码场景<i class="anchor-icon anchor-icon-link" anchorid="离线编码场景" tips="复制节点链接"></i></h2><p>离线编码场景包括视频编辑、视频分享等多种应用场景。</p> <p><strong>开发指导</strong></p> <p>基础编码流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>，下面仅针对编码器配置阶段，对配置离线编码场景的编码参数做具体说明。</p> <p>视频编辑场景，典型分辨率的编码参数（以H.265为例）推荐如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.6.1.6.1.1" valign="top" width="20%">分辨率</th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.1.6.1.2" valign="top" width="20%">帧率（fps）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.1.6.1.3" valign="top" width="20%">码率（kpbs）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.1.6.1.4" valign="top" width="20%">接入帧间隔（ms）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.1.6.1.5" valign="top" width="20%">码控模式</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%">3840x2160</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">25000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">2560x1440</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">15000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1920x1080</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">10000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1280x720</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">854x480</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">2000</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr>  </tbody></table></div> </div> <p>视频分享场景，典型分辨率的编码参数（以H.265为例）推荐如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.8.1.6.1.1" valign="top" width="20%">分辨率</th> <th align="left" class="cellrowborder" id="mcps1.3.7.8.1.6.1.2" valign="top" width="20%">帧率（fps）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.8.1.6.1.3" valign="top" width="20%">码率（kpbs）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.8.1.6.1.4" valign="top" width="20%">接入帧间隔（ms）</th> <th align="left" class="cellrowborder" id="mcps1.3.7.8.1.6.1.5" valign="top" width="20%">码控模式</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%">3840x2160</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">5600</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">2560x1440</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">4900</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1920x1080</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">2100</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">1280x720</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">1400</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr> <tr><td class="cellrowborder" valign="top" width="20%">854x480</td> <td class="cellrowborder" valign="top" width="20%">30</td> <td class="cellrowborder" valign="top" width="20%">400</td> <td class="cellrowborder" valign="top" width="20%">5000</td> <td class="cellrowborder" valign="top" width="20%">VBR</td> </tr>  </tbody></table></div> </div> <div _ngcontent-cjq-c106="" class="highlight-div"><div _ngcontent-cjq-c106="" class="highlight-div-header"><div _ngcontent-cjq-c106="" class="highlight-div-header-left"><div _ngcontent-cjq-c106="" class="handle-button expand-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjq-c106="" class="highlight-div-header-right"><div _ngcontent-cjq-c106="" class="handle-button ai-button"></div><div _ngcontent-cjq-c106="" class="handle-button line-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjq-c106="" class="handle-button theme-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjq-c106="" class="handle-button copy-button"><div _ngcontent-cjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 创建AVFormat参数实例。</span></li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-comment">// 2. 填充编码参数键值对（以1080p@30fps SDR输入源为例）。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-number">1920</span>); <span class="hljs-comment">// 必须配置，视频宽。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-number">1080</span>); <span class="hljs-comment">// 必须配置，视频高。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">AV_PIXEL_FORMAT_NV12</span>); <span class="hljs-comment">// 必须配置，视频源数据排布格式。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// VUI信息，0:limited range 1:full range。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT709</span>); <span class="hljs-comment">// VUI信息，视频源色域。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_BT709</span>); <span class="hljs-comment">// VUI信息，OETF/EOTF曲线。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">OH_MatrixCoefficient</span>:: <span class="hljs-title class_">MATRIX_COEFFICIENT_BT709</span>); <span class="hljs-comment">// YUV和RGB转换矩阵。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">OH_HEVCProfile</span>::<span class="hljs-title class_">HEVC_PROFILE_MAIN</span>); <span class="hljs-comment">// 视频编码器profile。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-number">30.0</span>); <span class="hljs-comment">// 必须配置，视频帧率。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_I_FRAME_INTERVAL</span>, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 必须配置，接入帧间隔，单位为ms。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_VBR</span>); <span class="hljs-comment">// 必须配置，码控模式配置为VBR。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-number">2100000</span>); <span class="hljs-comment">// 必须配置，设置码率，单位为bps。</span></li><li><span class="hljs-comment">// 3. 配置视频编码器的编码参数。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 4. 配置完成后销毁AVFormat实例。</span></li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li></ol></pre></div></div> </div> </div> <div></div></div>