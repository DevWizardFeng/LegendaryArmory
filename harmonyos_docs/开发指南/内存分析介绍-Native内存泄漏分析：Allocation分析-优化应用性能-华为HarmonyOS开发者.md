<h1 _ngcontent-stn-c119="" class="doc-title ng-star-inserted" title="内存分析介绍"> 内存分析介绍 </h1>

<div _ngcontent-stn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div id="body0000001481465958">    <p id="ZH-CN_TOPIC_0000002478174424__p759842333616">应用在开发过程中，可能会因为API使用错误、变量未及时释放、异常频繁创建/释放内存等情况引发各种内存问题。</p>    <p id="ZH-CN_TOPIC_0000002478174424__zh-cn_topic_0000001481465958_p1681840816">DevEco Profiler提供了基础的内存场景分析Allocation，您可以使用Allocation来分析应用或元服务在运行时的内存分配及使用情况，识别和定位内存泄漏、内存抖动以及内存溢出等问题，对应用或元服务的内存使用进行优化。</p>    <p id="ZH-CN_TOPIC_0000002478174424__p765205034919">在设备连接完成后，可按照如下方法查看内存分析结果：</p>    <ol id="ZH-CN_TOPIC_0000002478174424__ol4740115171816">     <li id="li622118144168"><span>构建应用前请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-build-profile">模块级build-profile.json5文件</a>，增加strip字段并赋值为false（strip：是否移除当前模块.so文件中的符号表、调试信息，配置为false代表不移除）。采集函数栈解析符号需要附带符号表信息，无符号表信息可能采集不到函数名称，因此请按照下图进行配置。</span>      <p></p>      <p id="ZH-CN_TOPIC_0000002478174424__p130914534015"><span><img height="396.5129" originheight="470" originwidth="564" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.24348140518136246523322928112681:50001231000000:2800:F7105EE16BE92EEFDF6AD864264A4AE24E0B9DFC88000C6537530C9286600A30.png" title="点击放大" width="474.81"></span></p>      <p></p></li>     <li id="li131807311507"><span>创建Allocation分析任务并录制相关数据，操作方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/deep-recording">性能问题定位：深度录制</a>，或在会话区选择<strong>Open File</strong>，导入历史数据。</span>      <p></p>      <p id="ZH-CN_TOPIC_0000002478174424__p52746131074">Allocation分析任务支持录制<strong>Memory泳道</strong>、<strong>ArkTS Allocation泳道</strong>、<strong>Native Allocation泳道</strong>，在录制前单击<span><img height="25.7754" originheight="18" originwidth="20" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.12092443494207153131793796260580:50001231000000:2800:2BDF6FE1446CADFB06744613FABF9A0A71B88F38985E2F1C2F80DDF7483EAA53.png" width="27.93" class="IconPic notEnlarge"></span>指定要录制的泳道。</p>      <p id="ZH-CN_TOPIC_0000002478174424__p647484311467"><span><img height="379.9145" originheight="684" originwidth="1552" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.04970294813439202329833872774080:50001231000000:2800:8EC0A8E651584B75B9CF8080405402823D88511F539D97548884613EF1E55D88.png" title="点击放大" width="857.85"></span></p>      <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">        <ul id="ZH-CN_TOPIC_0000002478174424__ul1583112595411">         <li id="li38321259134113">在任务分析窗口，可以通过“Ctrl+鼠标滚轮”缩放时间轴，通过“Shift+鼠标滚轮”左右移动时间轴。或使用快捷键W/S放大或缩小时间轴，使用A键/D键可以左右移动时间轴。</li>         <li id="li182232025112917">将鼠标悬停在泳道任意位置，可以通过M键添加单点时间标签。</li>         <li id="li1099292513324">鼠标框选要关注的时间段，可以通过“Shift+M”添加时间段时间标签。</li>         <li id="li540422233317">在任务分析窗口，可以通过“Ctrl+, ”向前选中单点时间标签，通过“Ctrl+. ”向后选中单点时间标签。</li>         <li id="li1360912834114">在任务分析窗口，可以通过“Ctrl+[ ”向前选中时间段时间标签，通过“Ctrl+]”向后选中时间段时间标签。</li>         <li id="li876431202914">Allocation分析支持离线符号解析能力，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-time#section186881175012">离线符号解析</a>。</li>         <li id="li51881521125912">在任务录制过程中，单击分析窗口左上角的<span><img height="19.950000000000003" originheight="17" originwidth="17" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.58345530196579757509436349048889:50001231000000:2800:ECBCCC84E7C2F9247080474D2CF5FF6FEDFA7B86485354B54D0F5F9DE8BE4047.png" width="19.950000000000003" class="IconPic notEnlarge"></span>可启动内存回收机制。</li>         <li id="li1018822119592">当方舟虚拟机的调优对象的某个程序/进程占用的部分内存空间在后续的操作中不再被该对象访问时，内存回收机制会自动将这部分空间归还给系统，降低程序错误概率，减少不必要的内存损耗。</li>        </ul>       </div></div></div>      <div class="p" id="ZH-CN_TOPIC_0000002478174424__p103115328285">       <ul id="ZH-CN_TOPIC_0000002478174424__ul101108818241">        <li id="li1939413207312">Memory泳道：显示当前进程的物理内存使用情况，其度量方式包含：         <p id="ZH-CN_TOPIC_0000002478174424__p96226915620"><a name="ZH-CN_TOPIC_0000002478174424__li1939413207312"></a><a name="li1939413207312"></a><span><img originheight="14" originwidth="14" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.33158229755831526654463414737446:50001231000000:2800:766AD0F1CC366A127072ED7AD2FCD800E78F95EAB4B465F8CACE23B05CDCEEF9.png" class="IconPic notEnlarge" width="14" height="14"></span> PSS：进程独占内存和按比例分配共享库占用内存之和。</p>         <p id="ZH-CN_TOPIC_0000002478174424__p136227920567"><span><img originheight="14" originwidth="14" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.50913127276269148919556393443968:50001231000000:2800:D7330127DB59478F3B7A38E2F0EFE7EC705C7C98FE6ECAF5651E046CF1E6BEC8.png" class="IconPic notEnlarge" width="14" height="14"></span> RSS：进程独占内存和相关共享库占用内存之和。</p>         <p id="ZH-CN_TOPIC_0000002478174424__p76229916562"><span><img originheight="14" originwidth="14" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.33678356459645989591091203027525:50001231000000:2800:3D8F922ACA7893C318244E414076070005C7B01E30C52FDBCF79212C39F72F3F.png" class="IconPic notEnlarge" width="14" height="14"></span> USS：进程独占内存。</p>         <p id="ZH-CN_TOPIC_0000002478174424__p76225911565">默认只显示PSS的统计图，如需要查看USS或RSS，需要在Memory泳道的右上角点选相关数据类型。</p>         <p id="ZH-CN_TOPIC_0000002478174424__p4477134314462"><span><img originheight="120" originwidth="1549" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.92056268388700704023069064741797:50001231000000:2800:9599538C585248703624C9D7B590D69AF2A90B1D0AC61066C33B2489477380BC.png" width="920" height="71.27178825048418"></span></p>         <p id="ZH-CN_TOPIC_0000002478174424__p5313125804010">展开Memory泳道，子泳道展示的是按照内存类型将进程PSS值拆分开的各个维度的内存信息，类型包含ArkTS Heap/Native Heap/GL/Graph/Guard/AnonPage Other/FilePage Other/Dev/Stack/.hap/.so/.ttf。默认展示其中的五个子泳道，如要显示其他子泳道，可以点击主泳道的options标签并勾选其他泳道来查看。</p>         <p id="ZH-CN_TOPIC_0000002478174424__p1347834384619"><span><img height="194.93777777777777" originheight="322" originwidth="1542" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.86092033960312136573967283388521:50001231000000:2800:757B2C54B5B2A1FE83554F5039E3DB5E1C9E5381A5EC66F9D3056F9E95731F23.png" title="点击放大" width="920"></span></p>         <ul id="ZH-CN_TOPIC_0000002478174424__ul199189591365">          <li id="li16918105919364">ArkTS Heap：ArkTS堆的内存占用。</li>          <li id="li179187596367">Native Heap：Native层（主要是应用依赖的so库的C/C++代码）使用new/malloc分配的堆内存。</li>          <li id="li3918359173613">GL：应用：纹理内存，RS：纹理+图形渲染内存。</li>          <li id="li109182597367">Graph：该进程按去重规则统计的dma内存占用，包括直接通过接口申请的dma buffer和通过allocator_host申请的dma buffer。</li>          <li id="li991816597363">Guard：保护段所占内存。</li>          <li id="li2918155913615">AnonPage Other：其他所有匿名页所占内存（非heap、anon:native_heap、anon:ArkTS heap开头的匿名页）。</li>          <li id="li10918105983611">FilePage Other：其它映射到文件页但不能被归类到.so/.db/.ttf类型的内存占用。</li>          <li id="li209182059123612">Dev：进程加载的以/dev开头的文件所占内存。</li>          <li id="li391835923613">Stack：栈内存。</li>          <li id="li16918559103620">.hap：进程加载的.hap文件所占内存</li>          <li id="li491820598367">.so：进程加载的.so动态库所占内存。</li>          <li id="li12918165903610">.ttf：进程加载的.ttf字体文件所占内存。</li>         </ul></li>        <li id="li139243588533">ArkTS Allocation泳道：显示方舟虚拟机上的内存分配信息。该泳道默认不展示，如需录制该泳道数据，在录制前单击左上角菜单栏<span><img height="25.7754" originheight="18" originwidth="20" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.14686411799055000235773042804876:50001231000000:2800:4AF4C3C2EA03936CB43EB7FDEA03A6067329F7F253B6564783C2C6BD11476974.png" width="27.93" class="IconPic notEnlarge"></span>图标，勾选ArkTS Allocation泳道。由于隐私安全政策，已上架应用市场的应用不支持录制此泳道。该泳道即将下线，推荐使用Snapshot模板分析ArkTS内存泄漏。         <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">           <p id="ZH-CN_TOPIC_0000002478174424__p13697310145418">由于较大的性能开销可能导致卡顿/卡死问题，暂不支持同时录制ArkTS Allocation和Native Allocation两条泳道。</p>          </div></div></div></li>        <li id="li11101582247">Native Allocation泳道：显示具体的Native内存分配情况，包括静态统计数据、分配栈、每层函数栈消耗的Native内存等信息。由于隐私安全政策，已上架应用市场的应用不支持录制此泳道。         <p id="ZH-CN_TOPIC_0000002478174424__p1838511402310"><a name="ZH-CN_TOPIC_0000002478174424__li11101582247"></a><a name="li11101582247"></a>单击工具控制栏中的<span><img height="20.721400000000003" originheight="21" originwidth="20" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.05025420310010667099899429199023:50001231000000:2800:DA43F67B8C4EC02000298F8B60F8E092A6AD83E51DA5BE14D05FE207BC5DE2A9.png" width="19.950000000000003" class="IconPic notEnlarge"></span>按钮，可以设置是否为统计模式、统计间隔、最小跟踪内存、回栈模式、JS回栈、JS回栈深度和Native回栈深度。</p>         <ul id="ZH-CN_TOPIC_0000002478174424__ul0663144153513">          <li id="li14626194918294">Statistics Mode：该项配置代表是否开启统计模式采集数据，默认开启。开启后，数据会每隔Sampling Interval中设置的时间从设备端汇总并返回。</li>          <li id="li991534122912">Sampling Interval：统计时间间隔。仅在统计模式下需要设置，可设置范围为1s~3600s，默认为10s。</li>          <li id="li9914342295">Filter Size：最小跟踪内存。该参数表示最小抓取的内存大小。可配置范围为0-65535Bytes，默认为1024Bytes。</li>          <li id="li137075351326">Backtrace Mode：内存分配栈回栈模式。当前提供FP和DWARF两种回栈模式。FP回栈是通过帧指针（FP寄存器）链接栈帧，直接遍历调用链。DWARF回栈是基于编译器生成的DWARF调试信息进行栈回溯。默认FP回栈。FP回栈性能更好，但在某些特定场景下（例如so的编译参数控制），FP回栈可能失效，此时可选择DWARF回栈尝试。</li>          <li id="li199163412910">Record JS Stack：是否开启JS回栈。当该开关打开时，系统回栈时会自动从Native向JS层回栈，完成Native到JS的栈缝合，适合ArkTS/JS代码调用Native的场景。</li>          <li id="li189214340293">JS Backtrace Depth：JS回栈深度。可配置范围为1-128，默认10层。</li>          <li id="li17958162317305">Native Backtrace Depth：Native回栈深度。可配置范围为5-100，默认10层。</li>          <li id="li151351220163412">Backtrace Stack：回栈深度。仅当Backtrace Mode选择为DWARF模式的情况下存在，其层数代表着JS与Native的共同回栈深度。可配置范围为5-100，默认20层。           <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">             <ul id="ZH-CN_TOPIC_0000002478174424__ul31351320133418">              <li id="li713518209346">设置的最小跟踪内存数值越小、回栈深度越大，可能会导致DevEco Profiler卡顿。请根据应用实际的调测情况进行合理设置。</li>              <li id="li1913510207345">统计模式用于不关注单次分配、关注应用较长时间的内存变化情况的场景，将指定的采样间隔内的数据做合并统计，以达到降低处理数据量，提高录制效率和时长的目的。设置的Sampling Interval为近似值，即尽可能地在接近这个时间内做统计汇总，存在一定的偏差，偏差不超过1s，偏差不会对内存分配的正确性产生影响。</li>             </ul>            </div></div></div>           <p id="ZH-CN_TOPIC_0000002478174424__p1013592033418"><span><img height="316.34711111111113" originheight="528" originwidth="1547" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.65331506789792990307866882778896:50001231000000:2800:C0AFD33933522B2DCF39DFE285B3B67F9BC2332E85084657D60A0DB9CA9C7E9F.png" title="点击放大" width="920"></span></p></li>         </ul></li>       </ul>      </div>      <p></p></li>     <li id="li15953230142818"><span>在目标泳道上长按鼠标左键并拖拽，框选要展示分析的时间段。Details区域中显示此时间段内指定类型的内存分析统计信息：</span>      <p></p>      <ul id="ZH-CN_TOPIC_0000002478174424__ul1685533752">       <li id="li202101565310">Memory泳道：        <ul id="ZH-CN_TOPIC_0000002478174424__ul149321395413">         <li id="li138831510185410">主泳道的详情区域显示当前框选时间段内各采样点的应用内存PSS总和，以及各种内存页面状态的内存占用总和。          <p id="ZH-CN_TOPIC_0000002478174424__p138181927115"><a name="ZH-CN_TOPIC_0000002478174424__li138831510185410"></a><a name="li138831510185410"></a><span><img height="395.7947" originheight="680" originwidth="1550" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.25551153694225374541822884466949:50001231000000:2800:820344A25D36B9B8DA5C55566D1A0157344B479EDEC47580D46C18D6E7B9F614.png" title="点击放大" width="897.75"></span></p></li>         <li id="li4712112105913">子泳道的详情区域显示该泳道所代表的内存类型的框选时间段内各采样点的PSS总和以及各种内存页面状态的实际占用情况。          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">            <p id="ZH-CN_TOPIC_0000002478174424__p8770102217411">Graph字段统计方式为：计算/proc/process_dmabuf_info节点下该进程使用的内存大小。</p>           </div></div></div>          <p id="ZH-CN_TOPIC_0000002478174424__p460413615293"><span><img height="395.82130000000006" originheight="673" originwidth="1534" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.56092416536642714256527092532538:50001231000000:2800:BF4D08E0B4D7DF651ECEBF95BA89D86ABF3905CCB25B5D2F8806DFBA222A9E9F.png" title="点击放大" width="897.75"></span></p></li>        </ul></li>       <li id="li148551633514">ArkTS Allocation泳道：显示被选择进程所使用的所有ArkTS内存总和，框选后展示此时段内录制到的所有方舟实例的对象分配信息。框选子泳道后显示当前框选时段内运行对象的内存使用情况，包括层级、对象自身内存大小、对象关联内存大小等。该泳道即将下线，推荐使用Snapshot模板分析ArkTS内存泄漏。        <p id="ZH-CN_TOPIC_0000002478174424__p10282105792011"><a name="ZH-CN_TOPIC_0000002478174424__li148551633514"></a><a name="li148551633514"></a>“Details”区域中带<span><img height="12.967500000000001" originheight="13" originwidth="13" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.03497241193744000696495328421816:50001231000000:2800:5AAC146930CB6D50681C59EC1FCD8456B7A1E23DD8EEA7106DE8446FF4ACD545.png" width="12.967500000000001" class="IconPic notEnlarge"></span>标识的对象，表示其可以通过窗口访问。每个时段内已释放的内存大小在柱子上置灰，未释放的内存保持绿色。</p>        <p id="ZH-CN_TOPIC_0000002478174424__p1223103919250"><span><img height="372.5197" originheight="638" originwidth="1546" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104927.51584681928801885414143961672894:50001231000000:2800:700C1E4A71388A8C25D8279D5DC51B3671C4D155DD45DC60142151B8E403B470.png" title="点击放大" width="897.75"></span></p></li>       <li id="li1385573852">Native Allocation泳道：框选子泳道后显示具体的内存分配，包括静态统计数据、分配栈等。        <ul id="ZH-CN_TOPIC_0000002478174424__ul1998412463612">         <li id="li933423710610">Statistics页签中显示该段时间内的静态分配情况，包括分配方式（Malloc或Mmap）、总分配内存大小、总分配次数、尚未释放的内存大小、尚未释放次数、已释放的内存大小、已释放次数。          <p id="ZH-CN_TOPIC_0000002478174424__p176555972013"><a name="ZH-CN_TOPIC_0000002478174424__li933423710610"></a><a name="li933423710610"></a>点击任意对象上的跳转按钮，可跳转至此类对象的详细占用/分配信息。当前统计模式下不支持跳转。</p></li>         <li id="li177138136202">Call Trees页签显示线程的内存分配栈情况，包括函数地址或符号、分配大小、占比以及函数栈帧的类别等。单击任一行栈帧，“More”区域将显示经过该栈帧的分配内存最大的调用栈。</li>         <li id="li447322018206">Allocations List显示内存分配的详细信息，包括内存块起始地址、时间戳、当前活动状态、大小、调用的库、调用库的具体函数、事件类型（与Statistics页签的分配方式对应）等。          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">            <p id="ZH-CN_TOPIC_0000002478174424__p7175123075620">统计模式（Statistics Mode）开启后，不存在Allocations List信息。</p>           </div></div></div>          <p id="ZH-CN_TOPIC_0000002478174424__p11538351115716">选择任一对象，右侧会展示与该对象相关的所有库和调用者。</p>          <p id="ZH-CN_TOPIC_0000002478174424__p1879192892514"><span><img height="412.3133" originheight="710" originwidth="1553" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104928.21564391628150816175499932903556:50001231000000:2800:A8C3299A9F46F090331069E35DC826A7ECA0518B004F4729C42EDAC29D8DA1CC.png" title="点击放大" width="897.75"></span></p></li>        </ul></li>      </ul>      <p></p></li>     <li id="li1633812176196"><span>（可选）根据分析结果，双击可能存在问题的调用栈，跳转至相关代码。开发者可根据实际需要进行优化。</span>      <p></p>      <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">        <p id="ZH-CN_TOPIC_0000002478174424__p18189165245716">Release应用暂不支持跳转到用户侧Native代码。</p>       </div></div></div>      <p></p></li>    </ol>   </div>   <div></div></div>