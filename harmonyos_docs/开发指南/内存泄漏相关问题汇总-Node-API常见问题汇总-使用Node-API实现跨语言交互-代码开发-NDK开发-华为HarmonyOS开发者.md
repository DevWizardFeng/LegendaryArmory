<h1 _ngcontent-oen-c119="" class="doc-title ng-star-inserted" title="内存泄漏相关问题汇总"> 内存泄漏相关问题汇总 </h1>

<div _ngcontent-oen-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="当前是否有机制来检查是否有泄漏的napi_ref">当前是否有机制来检查是否有泄漏的napi_ref<i class="anchor-icon anchor-icon-link" anchorid="当前是否有机制来检查是否有泄漏的napi_ref" tips="复制节点链接"></i></h2><ul><li>具体问题：napi_create_reference可以创建对js对象的引用，保持js对象不释放，正常来说使用完需要使用napi_delete_reference进行释放，但怕漏delete导致js对象内存泄漏，当前是否有机制来检查/测试是否有泄漏的napi_ref？</li><li><p>检测方式：</p> <p>可使用 DevEco Studio（IDE）提供的 Allocation 工具进行检测。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations" target="_blank">基础内存分析：Allocation分析</a></p> <p>napi_create_reference这个接口内部实现会new一个C++对象，因此，如果忘记使用napi_delete_reference接口，那这个new出来的C++对象也会泄漏，这时候就可以用Allocation工具来进行检测，这个工具会把未释放的对象的分配栈都打印出来，如果napi_ref泄漏了，可以在分配栈上看出来</p> </li></ul> </div>  <div class="tiledSection"><h2 id="napi开发过程中遇见内存泄漏问题要怎么定位解决">napi开发过程中遇见内存泄漏问题要怎么定位解决<i class="anchor-icon anchor-icon-link" anchorid="napi开发过程中遇见内存泄漏问题要怎么定位解决" tips="复制节点链接"></i></h2><p>点击按钮时内存增加，即使主动触发GC也无法回收。如何在Node-API开发过程中定位和解决内存泄漏问题？</p> <ul><li><p>解决建议：</p> <p>需先了解Node-API生命周期机制，相关材料如下：</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-life-cycle">使用Node-API接口进行生命周期相关开发</a></p> <p>使用Node-API时导致内存泄漏的常见原因：</p> </li></ul> <ol><li><p>napi_value不在napi_handle_scope管理中，导致napi_value持有的ArkTS对象无法释放，该问题常见于直接使用uv_queue_work的场景中。解决方法是添加napi_open_handle_scope和napi_close_handle_scope接口。</p> <p>此类泄漏可通过snapshot分析定位原因，泄漏的ArkTS对象distance为1，即不知道被谁持有，这种情况下一般就是被native（napi_value是个指针，指向native持有者）持有了，且napi_value不在napi_handle_scope范围内，可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-coding-standard-api#section1219614634615" target="_blank">易错API的使用规范</a></p>  </li><li><p>使用 napi_create_reference 为 ArkTS 对象创建了强引用（initial_refcount 参数大于 0），且一直未删除，导致 ArkTS 对象无法被回收。napi_create_reference 接口内部会创建一个 C++ 对象，因此这种泄漏通常表现为ArkTS对象与Native对象的双重泄漏。可以使用 Allocation 工具捕获Native对象泄漏栈，检查是否存在 napi_create_reference 相关的栈帧。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations" target="_blank">基础内存分析：Allocation分析</a></p>  </li><li><p>被其它存活的ArkTS对象持有时，使用snapshot查看泄漏对象的持有者。</p>  </li></ol> </div>  <div class="tiledSection"><h2 id="napi_threadsafe_function内存泄漏应该如何处理">napi_threadsafe_function内存泄漏应该如何处理<i class="anchor-icon anchor-icon-link" anchorid="napi_threadsafe_function内存泄漏应该如何处理" tips="复制节点链接"></i></h2><p>napi_threadsafe_function（下文简称tsfn）在使用时，常常会调用 napi_acquire_threadsafe_function 来更改tsfn的引用计数，确保tsfn不会意外被释放。但在使用完成后，应该及时使用 napi_tsfn_release 模式调用 napi_release_threadsafe_function 方法，以确保在所有调用回调都执行完成后，其引用计数能回归到调用 napi_acquire_threadsafe_function 方法之前的水平。当其引用计数归为0时，tsfn才能正确的被释放。</p> <p>当env即将退出，但tsfn的引用计数未归零时，应使用 napi_tsfn_abort 模式调用 napi_release_threadsafe_function 方法，确保env释放后不再持有或使用tsfn。env退出后继续持有tsfn将导致未定义行为，可能引发崩溃。</p> <p>如下代码将展示通过注册 env_cleanup 钩子函数的方式，以确保在env退出后不再继续持有tsfn。</p> <div _ngcontent-oen-c106="" class="highlight-div"><div _ngcontent-oen-c106="" class="highlight-div-header"><div _ngcontent-oen-c106="" class="highlight-div-header-left"><div _ngcontent-oen-c106="" class="handle-button expand-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oen-c106="" class="highlight-div-header-right"><div _ngcontent-oen-c106="" class="handle-button ai-button"></div><div _ngcontent-oen-c106="" class="handle-button line-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oen-c106="" class="handle-button theme-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oen-c106="" class="handle-button copy-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oen-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span> <span class="hljs-comment">// hilog, 输出日志, 需链接 libhilog_ndk.z.so</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span> <span class="hljs-comment">// 创建线程</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> <span class="hljs-comment">// 线程休眠</span></span></li><li>
</li><li><span class="hljs-comment">// 定义输出日志的标签和域</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_DOMAIN</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0x2342</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MY_TSFN_DEMO"</span></span></li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  为构建一个 env 生命周期短于 native 生命周期的场景,</span></li><li><span class="hljs-comment">  本示例需要使用worker, taskpool 或 napi_create_ark_runtime 等方法,</span></li><li><span class="hljs-comment">  创建非主线程的ArkTS运行环境，并人为的提前结束掉该线程</span></li><li><span class="hljs-comment">*/</span></li><li>
</li><li>
</li><li><span class="hljs-comment">// 定义一个数据结构，模拟存储tsfn的场景</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTsfnContext</span> {</li><li><span class="hljs-keyword">public</span>:</li><li><span class="hljs-comment">// 因使用了Node-API方法, MyTsfnContext 应当只在ArkTS线程被构造</span></li><li><span class="hljs-built_in">MyTsfnContext</span>(napi_env env, napi_value workName) {</li><li>    <span class="hljs-comment">// 注册env销毁钩子函数</span></li><li>    <span class="hljs-built_in">napi_add_env_cleanup_hook</span>(env, Cleanup, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-comment">// 创建线程安全函数</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_create_threadsafe_function</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, workName, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>,</li><li>            TsfnFinalize, <span class="hljs-keyword">this</span>, TsfnCallJs, &amp;tsfn_) != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"tsfn is created failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    };</li><li>};</li><li>
</li><li>~<span class="hljs-built_in">MyTsfnContext</span>() { <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"MyTsfnContext is deconstructed"</span>); };</li><li>
</li><li><span class="hljs-function">napi_threadsafe_function <span class="hljs-title">GetTsfn</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    <span class="hljs-keyword">return</span> tsfn_;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetTsfn</span>() == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">napi_acquire_threadsafe_function</span>(<span class="hljs-built_in">GetTsfn</span>()) == napi_ok);</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Release</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetTsfn</span>() == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">napi_release_threadsafe_function</span>(<span class="hljs-built_in">GetTsfn</span>(), napi_tsfn_release) == napi_ok);</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Call</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetTsfn</span>() == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">napi_call_threadsafe_function</span>(<span class="hljs-built_in">GetTsfn</span>(), data, napi_tsfn_blocking) == napi_ok);</li><li>};</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li><span class="hljs-comment">// 保护多线程读写tsfn的准确性</span></li><li>std::mutex mutex_;</li><li>napi_threadsafe_function tsfn_ = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-comment">// napi_add_env_cleanup_hook 回调</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">Cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span> </span>{</li><li>    MyTsfnContext *that = <span class="hljs-built_in">reinterpret_cast</span>&lt;MyTsfnContext *&gt;(data);</li><li>    napi_threadsafe_function tsfn = that-&gt;<span class="hljs-built_in">GetTsfn</span>();</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(that-&gt;mutex_)</span></span>;</li><li>    that-&gt;tsfn_ = <span class="hljs-literal">nullptr</span>;</li><li>    lock.<span class="hljs-built_in">unlock</span>();</li><li>    <span class="hljs-built_in">OH_LOG_WARN</span>(LOG_APP, <span class="hljs-string">"cleanup is called"</span>);</li><li>    <span class="hljs-built_in">napi_release_threadsafe_function</span>(tsfn, napi_tsfn_abort);</li><li>};</li><li>
</li><li><span class="hljs-comment">// tsfn 释放时的回调</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">TsfnFinalize</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint)</span> </span>{</li><li>    MyTsfnContext *ctx = <span class="hljs-built_in">reinterpret_cast</span>&lt;MyTsfnContext *&gt;(data);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"tsfn is released"</span>);</li><li>    <span class="hljs-built_in">napi_remove_env_cleanup_hook</span>(env, MyTsfnContext::Cleanup, ctx);</li><li>    <span class="hljs-comment">// cleanup 提前释放线程安全函数, 为避免UAF, 将释放工作交给调用方</span></li><li>    <span class="hljs-keyword">if</span> (ctx-&gt;<span class="hljs-built_in">GetTsfn</span>() != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ctx is released"</span>);</li><li>        <span class="hljs-keyword">delete</span> ctx;</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-comment">// tsfn 发送到 ArkTS 线程执行的回调</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">TsfnCallJs</span><span class="hljs-params">(napi_env env, napi_value func, <span class="hljs-type">void</span> *context, <span class="hljs-type">void</span> *data)</span> </span>{</li><li>    MyTsfnContext *ctx = <span class="hljs-built_in">reinterpret_cast</span>&lt;MyTsfnContext *&gt;(context);</li><li>    <span class="hljs-type">char</span> *str = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(data);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"tsfn is called, data is: \"%{public}s\""</span>, str);</li><li>    <span class="hljs-comment">// 业务逻辑已省略，应该包括开发者额外创建的资源的释放逻辑</span></li><li>};</li><li>};</li><li>
</li><li><span class="hljs-comment">// 该方法需注册到模块Index.d.ts, 注册名为 myTsfnDemo, 接口描述如下</span></li><li><span class="hljs-comment">// export const myTsfnDemo: () =&gt; void;</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">MyTsfnDemo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"MyTsfnDemo is called"</span>);</li><li>    napi_value workName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"MyTsfnWork"</span>, NAPI_AUTO_LENGTH, &amp;workName);</li><li>    MyTsfnContext *myContext = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyTsfnContext</span>(env, workName);</li><li>    <span class="hljs-keyword">if</span> (myContext-&gt;<span class="hljs-built_in">GetTsfn</span>() == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"failed to create tsfn"</span>);</li><li>        <span class="hljs-keyword">delete</span> myContext;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    };</li><li>    <span class="hljs-type">char</span> *data0 = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[]{<span class="hljs-string">"Im call in ArkTS Thread"</span>};</li><li>    <span class="hljs-keyword">if</span> (!myContext-&gt;<span class="hljs-built_in">Call</span>(data0)) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"call tsfn failed"</span>);</li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 创建一个线程，模拟异步场景</span></li><li>    std::<span class="hljs-built_in">thread</span>(</li><li>        [](MyTsfnContext *myCtx) {</li><li>            <span class="hljs-keyword">if</span> (!myCtx-&gt;<span class="hljs-built_in">Acquire</span>()) {</li><li>                <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"acquire tsfn failed"</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>            };</li><li>            <span class="hljs-type">char</span> *data1 = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[]{<span class="hljs-string">"Im call in std::thread"</span>};</li><li>            <span class="hljs-comment">// 非必要操作, 仅用于异步流程tsfn仍有效</span></li><li>            <span class="hljs-keyword">if</span> (!myCtx-&gt;<span class="hljs-built_in">Call</span>(data1)) {</li><li>                <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"call tsfn failed"</span>);</li><li>            };</li><li>            <span class="hljs-comment">// 休眠 5s, 模拟耗时场景, env退出后, 异步任务仍未执行完成</span></li><li>            <span class="hljs-built_in">sleep</span>(<span class="hljs-number">5</span>);</li><li>            <span class="hljs-comment">// 此时异步任务已执行完成, 但tsfn已被释放并置为 nullptr</span></li><li>            <span class="hljs-type">char</span> *data2 = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[]{<span class="hljs-string">"Im call after work"</span>};</li><li>            <span class="hljs-keyword">if</span> (!myCtx-&gt;<span class="hljs-built_in">Call</span>(data2) &amp;&amp; !myCtx-&gt;<span class="hljs-built_in">Release</span>()) {</li><li>                <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"call and release tsfn failed"</span>);</li><li>                <span class="hljs-keyword">delete</span> myCtx;</li><li>            }</li><li>        },</li><li>        myContext)</li><li>        .<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>};</li></ol></pre></div></div> <div _ngcontent-oen-c106="" class="highlight-div"><div _ngcontent-oen-c106="" class="highlight-div-header"><div _ngcontent-oen-c106="" class="highlight-div-header-left"><div _ngcontent-oen-c106="" class="handle-button expand-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oen-c106="" class="highlight-div-header-right"><div _ngcontent-oen-c106="" class="handle-button ai-button"></div><div _ngcontent-oen-c106="" class="handle-button line-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oen-c106="" class="handle-button theme-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oen-c106="" class="handle-button copy-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oen-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">myTsfnDemo</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div> <p>以下内容为主线程逻辑，主要用于创建 worker 线程并通知其执行任务。</p> <div _ngcontent-oen-c106="" class="highlight-div"><div _ngcontent-oen-c106="" class="highlight-div-header"><div _ngcontent-oen-c106="" class="highlight-div-header-left"><div _ngcontent-oen-c106="" class="handle-button expand-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oen-c106="" class="highlight-div-header-right"><div _ngcontent-oen-c106="" class="handle-button ai-button"></div><div _ngcontent-oen-c106="" class="handle-button line-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oen-c106="" class="handle-button theme-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oen-c106="" class="handle-button copy-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oen-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 主线程 Index.ets</span></li><li><span class="hljs-keyword">import</span>  {worker, <span class="hljs-title class_">MessageEvents</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> mWorker = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'../workers/worker'</span>);</li><li>mWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = e.<span class="hljs-property">data</span>?.<span class="hljs-property">action</span>;</li><li>    <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'kill'</span>) {</li><li>        mWorker.<span class="hljs-title function_">terminate</span>();</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 触发方式的注册已省略</span></li><li>mWorker.<span class="hljs-title function_">postMessage</span>({<span class="hljs-attr">action</span>: <span class="hljs-string">'tsfn-demo'</span>});</li></ol></pre></div></div> <p>以下内容为Worker线程逻辑，主要用于触发Native任务。</p> <div _ngcontent-oen-c106="" class="highlight-div"><div _ngcontent-oen-c106="" class="highlight-div-header"><div _ngcontent-oen-c106="" class="highlight-div-header-left"><div _ngcontent-oen-c106="" class="handle-button expand-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oen-c106="" class="highlight-div-header-right"><div _ngcontent-oen-c106="" class="handle-button ai-button"></div><div _ngcontent-oen-c106="" class="handle-button line-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oen-c106="" class="handle-button theme-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oen-c106="" class="handle-button copy-button"><div _ngcontent-oen-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oen-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// worker.ets</span></li><li><span class="hljs-keyword">import</span>  {worker, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, <span class="hljs-title class_">MessageEvents</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> napiModule <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>; <span class="hljs-comment">// libentry.so: Node-API 库的模块名称</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li>
</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = e.<span class="hljs-property">data</span>?.<span class="hljs-property">action</span>;</li><li>    <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'tsfn-demo'</span>) {</li><li>        <span class="hljs-comment">// 触发 C++ 层的 tsfn demo</span></li><li>        napiModule.<span class="hljs-title function_">myTsfnDemo</span>();</li><li>        <span class="hljs-comment">// 通知主线程结束 worker</span></li><li>        workerPort.<span class="hljs-title function_">postMessage</span>({<span class="hljs-attr">action</span>: <span class="hljs-string">'kill'</span>});</li><li>    };</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>