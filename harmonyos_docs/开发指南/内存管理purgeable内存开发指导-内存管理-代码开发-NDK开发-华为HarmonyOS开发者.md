<h1 _ngcontent-hne-c119="" class="doc-title ng-star-inserted" title="内存管理purgeable内存开发指导"> 内存管理purgeable内存开发指导 </h1>

<div _ngcontent-hne-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>HarmonyOS提供Purgeable Memory内存管理机制，开发者可以使用相关接口创建PurgeableMemory对象，从而管理purgeable内存。</p> <p>开发者可以通过本指导了解在HarmonyOS应用中，如何使用Native层相关接口操作purgeable内存。功能包括purgeable内存的申请、释放等。</p> <p>针对Purgeable Memory内存管理机制，常见的开发场景如下：</p> <ul><li>通过该机制提供的NAPI接口申请管理PurgeableMemory对象，并将数据内容写入该对象。</li><li>使用完毕后释放。</li></ul> </div>  <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_PurgeableMemory *OH_PurgeableMemory_Create(size_t size, OH_PurgeableMemory_ModifyFunc func, void *funcPara)</td> <td class="cellrowborder" valign="top" width="50%">创建PurgeableMemory对象，每次调用都会产生一个新的PurgeableMemory对象。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">bool OH_PurgeableMemory_Destroy(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">对PurgeableMemory对象进行析构操作。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">bool OH_PurgeableMemory_BeginRead(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">对PurgeableMemory对象进行读访问。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">void OH_PurgeableMemory_EndRead(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">读操作结束，将PurgeableMemory对象的引用计数减1，当引用计数为0的时候， 该PurgeableMemory对象可以被系统回收。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">bool OH_PurgeableMemory_BeginWrite(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">对PurgeableMemory对象进行写访问。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">void OH_PurgeableMemory_EndWrite(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">写操作结束，将PurgeableMemory对象的引用计数减1，当引用计数为0的时候，该PurgeableMemory对象可以被系统回收。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">void *OH_PurgeableMemory_GetContent(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">获取PurgeableMemory对象内存数据。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">size_t OH_PurgeableMemory_ContentSize(OH_PurgeableMemory *purgObj)</td> <td class="cellrowborder" valign="top" width="50%">获取PurgeableMemory对象内存数据大小。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">bool OH_PurgeableMemory_AppendModify(OH_PurgeableMemory *purgObj, OH_PurgeableMemory_ModifyFunc func, void *funcPara)</td> <td class="cellrowborder" valign="top" width="50%">添加PurgeableMemory对象的修改方法。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="purgeable-memory应用开发步骤">Purgeable Memory应用开发步骤<i class="anchor-icon anchor-icon-link" anchorid="purgeable-memory应用开发步骤" tips="复制节点链接"></i></h2><p>以下步骤描述了在<strong>HarmonyOS</strong>中如何使用Purgeable Memory提供的NAPI接口，申请PurgeableMemory对象，并将内容写入PurgeableMemory对象后，对相应对象进行读写访问。</p> <ol><li><p>声明PurgeableMemory对象创建规则。</p>  <div _ngcontent-hne-c106="" class="highlight-div"><div _ngcontent-hne-c106="" class="highlight-div-header"><div _ngcontent-hne-c106="" class="highlight-div-header-left"><div _ngcontent-hne-c106="" class="handle-button expand-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hne-c106="" class="highlight-div-header-right"><div _ngcontent-hne-c106="" class="handle-button ai-button"></div><div _ngcontent-hne-c106="" class="handle-button line-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hne-c106="" class="handle-button theme-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hne-c106="" class="handle-button copy-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hne-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 声明构建函数的参数</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParaData</span>{</li><li>    <span class="hljs-type">int</span> start;</li><li>    <span class="hljs-type">int</span> end;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 声明一个使用ModifyFunc</span></li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FactorialFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* data, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* param)</span></span>{</li><li>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">true</span>;</li><li>    ParaData *pdata = (ParaData*) param;</li><li>    <span class="hljs-type">int</span>* oriData = (<span class="hljs-type">int</span>*)data;</li><li>    <span class="hljs-type">int</span> i = pdata-&gt;start;</li><li>    <span class="hljs-keyword">while</span> (i &lt; pdata-&gt;end) {</li><li>        *oriData *= i;</li><li>        i++;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 声明修改PurgeableMemory对象扩展函数的参数</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppendParaData</span>{</li><li>    <span class="hljs-type">int</span> newPara;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 声明修改PurgeableMemory对象的扩展函数</span></li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">AddFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* data, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* param)</span></span>{</li><li>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-type">int</span> *oriDatap = (<span class="hljs-type">int</span>*) data;</li><li>    AppendParaData* apData = (AppendParaData*)param;</li><li>    *oriDatap += apData-&gt;newPara;</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>  </li><li><p>创建PurgeableMemory对象。</p>  <div _ngcontent-hne-c106="" class="highlight-div"><div _ngcontent-hne-c106="" class="highlight-div-header"><div _ngcontent-hne-c106="" class="highlight-div-header-left"><div _ngcontent-hne-c106="" class="handle-button expand-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hne-c106="" class="highlight-div-header-right"><div _ngcontent-hne-c106="" class="handle-button ai-button"></div><div _ngcontent-hne-c106="" class="handle-button line-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hne-c106="" class="handle-button theme-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hne-c106="" class="handle-button copy-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hne-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 声明一个4MB的PurgeableMemory对象大小</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> DATASIZE (4 * 1024 * 1024)</span></li><li>
</li><li><span class="hljs-comment">// 声明创建函数的参数</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParaData</span> pdata = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>};</li><li>
</li><li><span class="hljs-comment">// 创建一个PurgeableMemory对象</span></li><li>OH_PurgeableMemory* pPurgmem = <span class="hljs-built_in">OH_PurgeableMemory_Create</span>(DATASIZE, FactorialFunc, &amp;pdata);</li></ol></pre></div></div>  </li><li><p>读访问PurgeableMemory对象。</p>  <div _ngcontent-hne-c106="" class="highlight-div"><div _ngcontent-hne-c106="" class="highlight-div-header"><div _ngcontent-hne-c106="" class="highlight-div-header-left"><div _ngcontent-hne-c106="" class="handle-button expand-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hne-c106="" class="highlight-div-header-right"><div _ngcontent-hne-c106="" class="handle-button ai-button"></div><div _ngcontent-hne-c106="" class="handle-button line-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hne-c106="" class="handle-button theme-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hne-c106="" class="handle-button copy-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hne-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//业务定义对象类型</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReqObj</span>;</li><li>
</li><li><span class="hljs-comment">// 读取对象</span></li><li><span class="hljs-keyword">if</span>(<span class="hljs-built_in">OH_PurgeableMemory_BeginRead</span>(pPurgmem)) {</li><li>    <span class="hljs-comment">// 获取PurgeableMemory对象大小</span></li><li>    <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">OH_PurgeableMemory_ContentSize</span>(pPurgmem);</li><li>
</li><li>    <span class="hljs-comment">// 获取PurgeableMemory对象内容</span></li><li>    ReqObj* pReqObj = (ReqObj*) <span class="hljs-built_in">OH_PurgeableMemory_GetContent</span>(pPurgmem);</li><li>
</li><li>    <span class="hljs-comment">// 读取PurgeableMemory对象结束</span></li><li>    <span class="hljs-built_in">OH_PurgeableMemory_EndRead</span>(pPurgmem);</li><li>}</li></ol></pre></div></div>  </li><li><p>写访问PurgeableMemory对象。</p>  <div _ngcontent-hne-c106="" class="highlight-div"><div _ngcontent-hne-c106="" class="highlight-div-header"><div _ngcontent-hne-c106="" class="highlight-div-header-left"><div _ngcontent-hne-c106="" class="handle-button expand-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hne-c106="" class="highlight-div-header-right"><div _ngcontent-hne-c106="" class="handle-button ai-button"></div><div _ngcontent-hne-c106="" class="handle-button line-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hne-c106="" class="handle-button theme-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hne-c106="" class="handle-button copy-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hne-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">//业务定义对象类型</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReqObj</span>;</li><li>
</li><li><span class="hljs-comment">// 修改PurgeableMemory对象</span></li><li><span class="hljs-keyword">if</span>(<span class="hljs-title function_">OH_PurgeableMemory_BeginWrite</span>(<span class="hljs-variable">pPurgmem</span>)) {</li><li>    <span class="hljs-comment">// 获取PurgeableMemory对象数据</span></li><li>    <span class="hljs-variable">ReqObj</span>* <span class="hljs-variable">pReqObj</span> = (<span class="hljs-variable">ReqObj</span>*) <span class="hljs-title function_">OH_PurgeableMemory_GetContent</span>(<span class="hljs-variable">pPurgmem</span>);</li><li>
</li><li>    <span class="hljs-comment">// 声明扩展创建函数的参数</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppendParaData</span> <span class="hljs-variable">apdata</span> = {<span class="hljs-number">1</span>};</li><li>
</li><li>    <span class="hljs-comment">// 更新PurgeableMemory对象重建规则</span></li><li>    <span class="hljs-title function_">OH_PurgeableMemory_AppendModify</span>(<span class="hljs-variable">pPurgmem</span>, <span class="hljs-variable">AddFunc</span>, &amp;<span class="hljs-title class_">apdata</span>);</li><li>
</li><li>    <span class="hljs-comment">// 修改PurgeableMemory对象结束</span></li><li>    <span class="hljs-title function_">OH_PurgeableMemory_EndWrite</span>(<span class="hljs-variable">pPurgmem</span>);</li><li>}</li></ol></pre></div></div>  </li><li><p>销毁PurgeableMemory对象。</p>  <div _ngcontent-hne-c106="" class="highlight-div"><div _ngcontent-hne-c106="" class="highlight-div-header"><div _ngcontent-hne-c106="" class="highlight-div-header-left"><div _ngcontent-hne-c106="" class="handle-button expand-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hne-c106="" class="highlight-div-header-right"><div _ngcontent-hne-c106="" class="handle-button ai-button"></div><div _ngcontent-hne-c106="" class="handle-button line-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hne-c106="" class="handle-button theme-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hne-c106="" class="handle-button copy-button"><div _ngcontent-hne-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hne-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁对象</span></li><li><span class="hljs-built_in">OH_PurgeableMemory_Destroy</span>(pPurgmem);</li><li><span class="hljs-comment">// 置空指针防止UAF</span></li><li>pPurgmem = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>