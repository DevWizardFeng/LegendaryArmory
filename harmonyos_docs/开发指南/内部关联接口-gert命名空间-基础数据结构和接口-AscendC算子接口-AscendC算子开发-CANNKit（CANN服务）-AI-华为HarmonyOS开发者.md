<h1 _ngcontent-ont-c119="" class="doc-title ng-star-inserted" title="内部关联接口"> 内部关联接口 </h1>

<div _ngcontent-ont-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在进行算子原型注册、Tiling实现、shape推导过程中，使用到的外部开放接口中会调用到一些辅助数据结构和接口，称之为<strong>内部关联接口</strong>。开发者不会直接调用内部关联接口，此处仅作简单介绍。</p> <div class="tiledSection"><h2 id="section96038mcpsimp">KernelContext类<i class="anchor-icon anchor-icon-link" anchorid="section96038mcpsimp" tips="复制节点链接"></i></h2><p>本类是对底层数据结构KernelRunContext的包装，包含kernel执行时所需的算子输入、输出个数信息以及输入输出数据信息、compute_node_info和kernel_extend_info。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>KernelContext类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.2.3.1.1" valign="top" width="26%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.3.1.2" valign="top" width="74%"><p>接口功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26%"><p>GetInput</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入的Chain指针。Chain是一个可以用来保存任意类型数据的类。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetInputNum</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel的输入数量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetInputPointer</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入数据的指针，本函数首先获取输入Chain，然后从输入Chain中获取指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetInputStrPointer</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入字符串的指针，本函数首先获取输入Chain，然后从输入Chain中获取指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetInputValue</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入数据的值，本函数首先获取输入Chain，然后从输入Chain中获取值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetOutput</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输出的Chain指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetOutput2</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输出的Chain指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetOutputNum</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel的输出数量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetOutputPointer</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输出数据的指针，本函数首先获取输出Chain，然后从Chain中获取指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetContext</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取底层的context结构体。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetKernelExtend</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel扩展信息的指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetComputeNodeExtend</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取计算节点信息的指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>MutableInput</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入的Chain指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>MutableInputPointer</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取输入数据的指针，本函数首先获取输入Chain，然后从输入Chain中获取指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>IsInlineSize</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>根据数据的长度判断一个数据是否会被inline存储，所谓inline存储是指此数据保存在context中时不需要单独分配内存。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96128mcpsimp">TilingParseContext类<i class="anchor-icon anchor-icon-link" anchorid="section96128mcpsimp" tips="复制节点链接"></i></h2><p>用于TilingParse所需的信息保存在本类中，本类为编写算子的TilingParse函数时提供上下文信息，在TilingParse时可以从本类中获取所需的信息。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>TilingParseContext类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.3.1.1" valign="top" width="26%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.3.1.2" valign="top" width="74%"><p>接口功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26%"><p>GetCompiledJson</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取算子编译产生的json字符串。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetCompiledInfo</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取CompiledInfo实例。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetPlatformInfo</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取fe::PlatFormInfos指针。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96158mcpsimp">Chain类<i class="anchor-icon anchor-icon-link" anchorid="section96158mcpsimp" tips="复制节点链接"></i></h2><p>Chain是一个可以用来保存任意类型数据的类。通过其Set接口保存数据，通过GetPointer或者GetValue方法获取保存的数据。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>Chain类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.2.3.1.1" valign="top" width="26%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.3.1.2" valign="top" width="74%"><p>接口功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26%"><p>GetPointer</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取指向Chain中保存数据的指针。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetValue</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取Chain中保存的数据的值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>Set</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>将数据设置到Chain中。设置数据指针时，会尝试调用deleter将原有保存在Chain的数据删除。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>SetWithDefaultDeleter</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>将数据设置到Chain中。设置数据指针时，会尝试调用deleter将原有保存在Chain的数据删除。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>HasDeleter</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>判断当前Chain中保存的数据是否有deleter。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96198mcpsimp">ContinuousBuffer类<i class="anchor-icon anchor-icon-link" anchorid="section96198mcpsimp" tips="复制节点链接"></i></h2><p>ContinuousBuffer类用于连续存储任意类型的数据，每个数据被转成uint8_t数组进行存储，每个存储单元称为一个buffer。ContinuousBuffer使用两个属性来描述被存储的数据，分别是存储buffer的个数以及每个buffer对应的内存偏移量offsets_。每个buffer在内存上是连续的。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表4 </b>ContinuousBuffer类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.3.2.3.1.1" valign="top" width="26%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.2.3.1.2" valign="top" width="74%"><p>接口功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26%"><p>GetNum</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取buffer的数量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetTotalLength</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取本实例的总长度。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>Get</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取buffer指针、长度信息。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96228mcpsimp">KernelExtendInfo类<i class="anchor-icon anchor-icon-link" anchorid="section96228mcpsimp" tips="复制节点链接"></i></h2><p>本类是用于保存的kernel运行时的额外信息，包括kernel的名字、类型、用于profiling注册的kernel type的index以及计算节点名的index。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表5 </b>KernelExtendInfo类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.1" valign="top" width="26%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.2" valign="top" width="74%"><p>接口功能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26%"><p>GetKernelName</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel name。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>SetKernelName</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>设置kernel name。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetKernelType</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel type。一个算子可以对应多个kernel，也就对应多个kernel type。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>SetKernelType</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>设置kernel type。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>SetKernelTypeIdx</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>设置kernel_type_idx_，用于profiling。profiling时设置的kernel type字符串对应的idx，用idx代替kernel type字符串作为标识，提升速度。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>SetNodeNameIdx</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>设置compute_node_name_idx_，用于profiling。profiling时，用idx代替node name字符串作为标识，提升速度。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetNodeNameIdx</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取compute_node_name_idx_，用于profiling。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26%"><p>GetKernelTypeIdx</p> </td> <td class="cellrowborder" valign="top" width="74%"><p>获取kernel_type_idx_，用于profiling。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96283mcpsimp">TensorOperateType<i class="anchor-icon anchor-icon-link" anchorid="section96283mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-ont-c106="" class="highlight-div"><div _ngcontent-ont-c106="" class="highlight-div-header"><div _ngcontent-ont-c106="" class="highlight-div-header-left"><div _ngcontent-ont-c106="" class="handle-button expand-button"><div _ngcontent-ont-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ont-c106="" class="highlight-div-header-right"><div _ngcontent-ont-c106="" class="handle-button ai-button"></div><div _ngcontent-ont-c106="" class="handle-button line-button"><div _ngcontent-ont-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ont-c106="" class="handle-button theme-button"><div _ngcontent-ont-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ont-c106="" class="handle-button copy-button"><div _ngcontent-ont-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ont-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">enum</span> <span class="hljs-title class_">TensorOperateType</span> { </li><li>  kGetTensorAddress,  <span class="hljs-comment">// &lt; 获取Tensor的地址 </span></li><li>  kFreeTensor,        <span class="hljs-comment">// &lt; 释放Tensor </span></li><li>  kPlusShareCount,    <span class="hljs-comment">// &lt; 共享Tensor </span></li><li>  kTensorOperateType </li><li>};</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section96286mcpsimp">StructSizeInfoBase类<i class="anchor-icon anchor-icon-link" anchorid="section96286mcpsimp" tips="复制节点链接"></i></h2><p>StructSizeInfoBase类用来存放、获取AscendC高阶API和开发者自定义的tiling结构体大小，通过单例实现一个结构体信息库。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表6 </b>StructSizeInfoBase类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.3.2.3.1.1" valign="top" width="18%"><p>函数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.3.2.3.1.2" valign="top" width="82%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18%"><p>GetInstance</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>获取StructSizeInfoBase类的单例。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>SetStructSize</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>设置高阶API/开发者自定义tiling结构大小。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>GetStructSize</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>获取高阶API/开发者自定义tiling结构大小。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96316mcpsimp">TilingDataStructBase类<i class="anchor-icon anchor-icon-link" anchorid="section96316mcpsimp" tips="复制节点链接"></i></h2><p>TilingDataStructBase的类，用于记录Tiling结构体构造过程信息。提供以下接口：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表7 </b>TilingDataStructBase类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.3.2.3.1.1" valign="top" width="20%"><p>函数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.2.3.1.2" valign="top" width="80%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%"><p>GetInstance</p> </td> <td class="cellrowborder" valign="top" width="80%"><p>获取TilingDataStructBase类的单例。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20%"><p>RecordTilingStruct</p> </td> <td class="cellrowborder" valign="top" width="80%"><p>用于框架检查不同算子注册同名不同结构tiling结构体情况，若出现则会打印warning信息。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96341mcpsimp">数值计算校验相关接口<i class="anchor-icon anchor-icon-link" anchorid="section96341mcpsimp" tips="复制节点链接"></i></h2><p>框架内部使用的数值计算校验相关接口。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表8 </b>接口说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.3.2.3.1.1" valign="top" width="18%"><p>函数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.2.3.1.2" valign="top" width="82%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18%"><p>MulOverflow</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>判断乘法数值运算是否溢出。其中溢出的判断条件为乘积后的数值大于ret类型TRet所能表示的最大值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>AddOverflow</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>判断加法数值运算是否溢出。其中溢出的判断条件为相加后的数值大于ret类型TRet所能表示的最大值。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>Compat</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>判断入参的数值是否超过指定类型T所能表示的数值范围。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section96371mcpsimp">OpExecuteContext类<i class="anchor-icon anchor-icon-link" anchorid="section96371mcpsimp" tips="复制节点链接"></i></h2><p>本类用于保存图模式下调用单算子执行API场景下的上下文。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表9 </b>OpExecuteContext类成员函数</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.11.3.2.3.1.1" valign="top" width="28.62%"><p>函数名称含义</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.11.3.2.3.1.2" valign="top" width="71.38%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetInputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引输入的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetOptionalInputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引的可选输入的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetDynamicInputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引的动态个数输入的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetRequiredInputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引的必选输入的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetOutputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引输出的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetDynamicOutputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引的动态个数输出的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetRequiredOutputTensor</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取指定索引的必选输出的Tensor。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetStream</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取下发算子的流信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetOpExecuteFunc</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取多kernel算子的执行回调函数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>MallocWorkspace</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>分配workspace内存。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>FreeWorkspace</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>释放workspace内存。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetDeterministic</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取确定性计算配置选项。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetAllowHf32</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取allow_hf32配置选项。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.62%"><p>GetPrecisionMode</p> </td> <td class="cellrowborder" valign="top" width="71.38%"><p>获取精度模式配置选项。</p> </td> </tr>  </tbody></table></div> </div> </div> </div> <div></div></div>