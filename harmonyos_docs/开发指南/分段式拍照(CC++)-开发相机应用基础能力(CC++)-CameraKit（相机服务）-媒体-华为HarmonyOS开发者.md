<h1 _ngcontent-eje-c119="" class="doc-title ng-star-inserted" title="分段式拍照(C/C++)"> 分段式拍照(C/C++) </h1>

<div _ngcontent-eje-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>分段式拍照是相机的最重要功能之一，相机输出低质量图用作快速显示，提升用户感知拍照速度，同时使用高质量图保证最后的成图质量达到系统相机的水平，既满足了后处理算法的需求，又不阻塞前台的拍照速度，构筑相机性能竞争力，提升了用户的体验。</p>    <ul>     <li>在第一阶段，系统快速上报轻量处理的图片，轻量处理的图片比全质量图低，出图速度快。应用通过回调会收到一个PhotoAsset对象，通过该对象可调用媒体库接口，读取图片或落盘图片。</li>     <li>在第二阶段，相机框架会根据应用的请求图片诉求或者在系统闲时，进行图像增强处理得到全质量图，将处理好的图片传回给媒体库，替换轻量处理的图片。</li>    </ul>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-eje-c106="" class="highlight-div"><div _ngcontent-eje-c106="" class="highlight-div-header"><div _ngcontent-eje-c106="" class="highlight-div-header-left"><div _ngcontent-eje-c106="" class="handle-button expand-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eje-c106="" class="highlight-div-header-right"><div _ngcontent-eje-c106="" class="handle-button ai-button"></div><div _ngcontent-eje-c106="" class="handle-button line-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eje-c106="" class="handle-button theme-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eje-c106="" class="handle-button copy-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eje-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohcamera/camera.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohcamera/photo_output.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohcamera/camera_manager.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_asset_manager_capi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_asset_change_request_capi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/media_library/media_access_helper_capi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_packer_native.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-eje-c106="" class="highlight-div"><div _ngcontent-eje-c106="" class="highlight-div-header"><div _ngcontent-eje-c106="" class="highlight-div-header-left"><div _ngcontent-eje-c106="" class="handle-button expand-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eje-c106="" class="highlight-div-header-right"><div _ngcontent-eje-c106="" class="handle-button ai-button"></div><div _ngcontent-eje-c106="" class="handle-button line-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eje-c106="" class="handle-button theme-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eje-c106="" class="handle-button copy-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eje-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libhilog_ndk.z.so</li><li>    libohcamera.so</li><li>    libimage_source.so</li><li>    libmedia_asset_manager.so</li><li>    libimage_packer.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>相机初始化及拍照触发参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-shooting">拍照(C/C++)</a>。</p></li>      <li>       <p>注册分段式（PhotoAssetAvailable）拍照回调，对比单段式拍照，仅注册的拍照回调接口不同。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>如果已经注册了PhotoAssetAvailable回调，并且在Session开始之后又注册了PhotoAvailable回调，PhotoAssetAvailable和PhotoAvailable同时注册，会导致流被重启，仅PhotoAssetAvailable生效。</p>         <p>不建议开发者同时注册PhotoAssetAvailable和PhotoAvailable。</p>        </div></div></div>       <p>注册PhotoAssetAvailableCallback回调，接收分段式拍照回图示例：</p>       <p><strong>分段式拍照开发流程（PhotoAssetAvailableCallback）</strong>：</p>       <ul>        <li>在会话commitConfig前注册分段式拍照回调。</li>        <li>通过分段式拍照回调，获取媒体库资源mediaAsset。</li>        <li>通过mediaAsset直接落盘图片或者通过mediaAsset配置策略模式请求图像资源，业务处理后通过buffer保存图片，或显示图片(参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-shooting">拍照(C/C++)</a>步骤5)。</li>        <li>使用完后解注册分段式拍照回调函数。</li>       </ul>       <div _ngcontent-eje-c106="" class="highlight-div"><div _ngcontent-eje-c106="" class="highlight-div-header"><div _ngcontent-eje-c106="" class="highlight-div-header-left"><div _ngcontent-eje-c106="" class="handle-button expand-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eje-c106="" class="highlight-div-header-right"><div _ngcontent-eje-c106="" class="handle-button ai-button"></div><div _ngcontent-eje-c106="" class="handle-button line-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eje-c106="" class="handle-button theme-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eje-c106="" class="handle-button copy-button"><div _ngcontent-eje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eje-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 方式一：调用媒体库落盘图片。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">mediaLibSavePhoto</span><span class="hljs-params">(OH_MediaAsset* mediaAsset)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (mediaAsset == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"mediaAsset is nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建媒体资产更改请求对象。</span></li><li>    OH_MediaAssetChangeRequest* changeRequest = <span class="hljs-built_in">OH_MediaAssetChangeRequest_Create</span>(mediaAsset);</li><li>    <span class="hljs-keyword">if</span> (changeRequest == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"changeRequest is nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 请求保存图片。</span></li><li>    MediaLibrary_ErrorCode errCode =</li><li>        <span class="hljs-built_in">OH_MediaAssetChangeRequest_SaveCameraPhoto</span>(changeRequest, MEDIA_LIBRARY_IMAGE_JPEG);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"SaveCameraPhoto get errCode:%{public}d"</span>, errCode);</li><li>    <span class="hljs-comment">// 发起请求。</span></li><li>    errCode = <span class="hljs-built_in">OH_MediaAccessHelper_ApplyChanges</span>(changeRequest);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ApplyChanges get errCode:%{public}d"</span>, errCode);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 方式二：调用媒体库接口请求图像资源。</span></li><li><span class="hljs-comment">// 图像源准备就绪时调用。</span></li><li>std::mutex g_mediaAssetMutex;</li><li>OH_MediaAsset* g_mediaAsset_;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnImageDataPrepared</span><span class="hljs-params">(MediaLibrary_ErrorCode result, MediaLibrary_RequestId requestId,</span></span></li><li><span class="hljs-function">                         MediaLibrary_MediaQuality mediaQuality, MediaLibrary_MediaContentType type,</span></li><li><span class="hljs-function">                         OH_ImageSourceNative* imageSourceNative)</span> {</li><li>    <span class="hljs-keyword">if</span> (imageSourceNative == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OnImageDataPrepared: imageSourceNative is nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (mediaQuality == MediaLibrary_MediaQuality::MEDIA_LIBRARY_QUALITY_FAST) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnImageDataPrepared: Using fast media quality."</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mediaQuality == MediaLibrary_MediaQuality::MEDIA_LIBRARY_QUALITY_FULL) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnImageDataPrepared: Using full media quality."</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 通过OH_ImageSourceNative创建OH_PixelmapNative。</span></li><li>    OH_PixelmapNative* pixelmapNative = <span class="hljs-literal">nullptr</span>;</li><li>    OH_DecodingOptions* decodingOptions = <span class="hljs-literal">nullptr</span>;</li><li>    Image_ErrorCode imageErr = IMAGE_SUCCESS;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageSourceNative_CreatePixelmap</span>(imageSourceNative, decodingOptions, &amp;pixelmapNative);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OnImageDataPrepared: CreatePixelmap failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建Image Packer并设置打包选项。</span></li><li>    OH_ImagePackerNative* imagePacker;</li><li>    <span class="hljs-built_in">OH_ImagePackerNative_Create</span>(&amp;imagePacker);</li><li>    OH_PackingOptions* options;</li><li>    <span class="hljs-built_in">OH_PackingOptions_Create</span>(&amp;options);</li><li>    <span class="hljs-type">char</span> format[] = <span class="hljs-string">"image/jpeg"</span>;</li><li>    Image_MimeType image_MimeType = {format, <span class="hljs-built_in">strlen</span>(format)};</li><li>    <span class="hljs-built_in">OH_PackingOptions_SetMimeType</span>(options, &amp;image_MimeType);</li><li>    <span class="hljs-built_in">OH_PackingOptions_SetQuality</span>(options, <span class="hljs-number">100</span>); <span class="hljs-comment">// 最高质量100。</span></li><li>    <span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">3072</span> * <span class="hljs-number">4096</span>; <span class="hljs-comment">// 传大于编码后的size大小，编码后会重新赋值。</span></li><li>    <span class="hljs-comment">// 解析出图片buffer。</span></li><li>    <span class="hljs-keyword">auto</span> buffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">uint8_t</span>[]&gt;(bufferSize);</li><li>    imageErr = <span class="hljs-built_in">OH_ImagePackerNative_PackToDataFromPixelmap</span>(imagePacker, options, pixelmapNative, buffer.<span class="hljs-built_in">get</span>(), &amp;bufferSize);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnImageDataPrepared: packToData ret code:%{public}u outsize:%{public}zu"</span>, imageErr, bufferSize);</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mediaAssetMutex)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (g_mediaAsset_ == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP,  <span class="hljs-string">"OnImageDataPrepared: get current mediaAsset failed!"</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 调用媒体库接口通过buffer存图。</span></li><li>    OH_MediaAssetChangeRequest* changeRequest = <span class="hljs-built_in">OH_MediaAssetChangeRequest_Create</span>(g_mediaAsset_);</li><li>    MediaLibrary_ErrorCode mediaErr = <span class="hljs-built_in">OH_MediaAssetChangeRequest_AddResourceWithBuffer</span>(changeRequest,</li><li>        MEDIA_LIBRARY_IMAGE_RESOURCE, buffer.<span class="hljs-built_in">get</span>(), bufferSize);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,  <span class="hljs-string">"OnImageDataPrepared: AddResourceWithBuffer get errCode:%{public}d"</span>, mediaErr);</li><li>    mediaErr = <span class="hljs-built_in">OH_MediaAssetChangeRequest_SaveCameraPhoto</span>(changeRequest, MEDIA_LIBRARY_IMAGE_JPEG);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,  <span class="hljs-string">"OnImageDataPrepared: SaveCameraPhoto get errCode:%{public}d"</span>, mediaErr);</li><li>    mediaErr = <span class="hljs-built_in">OH_MediaAccessHelper_ApplyChanges</span>(changeRequest);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,  <span class="hljs-string">"OnImageDataPrepared: ApplyChanges get errCode:%{public}d"</span>, mediaErr);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">mediaLibRequestBuffer</span><span class="hljs-params">(OH_MediaAsset* mediaAsset)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (mediaAsset == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"mediaAsset is nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建媒体资产管理器。</span></li><li>    OH_MediaAssetManager* mediaAssetManager = <span class="hljs-built_in">OH_MediaAssetManager_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (mediaAssetManager == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"mediaAssetManager is nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 配置请求媒体图片参数。</span></li><li>    MediaLibrary_RequestOptions requestOptions;</li><li>    <span class="hljs-comment">// 按照业务需求配置策略模式请求图像资源。</span></li><li>    <span class="hljs-comment">// MEDIA_LIBRARY_FAST_MODE：仅接收一阶段低质量图回调。</span></li><li>    <span class="hljs-comment">// MEDIA_LIBRARY_HIGH_QUALITY_MODE：仅接收二阶段全质量图回调。</span></li><li>    <span class="hljs-comment">// MEDIA_LIBRARY_BALANCED_MODE：接收一阶段及二阶段图片回调。</span></li><li>    requestOptions.deliveryMode = MEDIA_LIBRARY_FAST_MODE;</li><li>    MediaLibrary_RequestId requestId;</li><li>    <span class="hljs-comment">// 请求图像资源，图像源准备就绪时调用onImageDataPrepared。</span></li><li>    MediaLibrary_ErrorCode result = <span class="hljs-built_in">OH_MediaAssetManager_RequestImage</span>(mediaAssetManager, mediaAsset, requestOptions, &amp;requestId, OnImageDataPrepared);</li><li>    <span class="hljs-keyword">if</span> (result != MEDIA_LIBRARY_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_MediaAssetManager_RequestImage failed."</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 分段式拍照回调函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnPhotoAssetAvailable</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput, OH_MediaAsset* mediaAsset)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAssetAvailable start!"</span>);</li><li>    <span class="hljs-keyword">if</span> (mediaAsset == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OnPhotoAssetAvailable mediaAsset nullptr!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 处理方式一：调用媒体库接口落盘图片，先保存一阶段图，二阶段图就绪后媒体库会主动帮应用替换落盘图片。</span></li><li>    <span class="hljs-comment">// mediaLibSavePhoto(mediaAsset);</span></li><li>    <span class="hljs-comment">// 处理方式二：调用媒体库接口请求图像资源，获取一阶段图或二阶段图buffer，业务处理后通过buffer存图。</span></li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mediaAssetMutex)</span></span>;</li><li>    g_mediaAsset_ = mediaAsset;</li><li>    <span class="hljs-built_in">mediaLibRequestBuffer</span>(mediaAsset);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册分段式拍照回调。</span></li><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">PhotoOutputRegisterPhotoAssetAvailableCallback</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput)</span> </span>{</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_PhotoOutput_RegisterPhotoAssetAvailableCallback</span>(photoOutput, OnPhotoAssetAvailable);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_RegisterPhotoAssetAvailableCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>