<h1 _ngcontent-ngl-c119="" class="doc-title ng-star-inserted" title="分段式拍照实践(ArkTS)"> 分段式拍照实践(ArkTS) </h1>

<div _ngcontent-ngl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p>    <p>当前示例提供完整的分段式拍照流程介绍，方便开发者了解完整的接口调用顺序。</p>    <p>在参考以下示例前，建议开发者查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-deferred-capture">分段式拍照(ArkTS)</a>的具体章节，了解<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-input">设备输入</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-session-management">会话管理</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-shooting">拍照</a>等单个流程。</p>    <div class="tiledSection">     <h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2>          <p>在获取到相机支持的输出流能力后，开始创建拍照流，开发流程如下。</p>     <p><span><img originheight="4096" originwidth="2240" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114436.66149004868611294236822241634271:50001231000000:2800:BA8176C2CBFE28C7CF4995B8A997AEB826ECB8757E3F06E128D7D69EDB8A2F1D.png" width="920" height="1682.2857142857142"></span></p>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>Context获取方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>     <div _ngcontent-ngl-c106="" class="highlight-div"><div _ngcontent-ngl-c106="" class="highlight-div-header"><div _ngcontent-ngl-c106="" class="highlight-div-header-left"><div _ngcontent-ngl-c106="" class="handle-button expand-button"><div _ngcontent-ngl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ngl-c106="" class="highlight-div-header-right"><div _ngcontent-ngl-c106="" class="handle-button ai-button"></div><div _ngcontent-ngl-c106="" class="handle-button line-button"><div _ngcontent-ngl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ngl-c106="" class="handle-button theme-button"><div _ngcontent-ngl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ngl-c106="" class="handle-button copy-button"><div _ngcontent-ngl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ngl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">photoSession</span>: camera.<span class="hljs-property">PhotoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">cameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">previewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">photoOutput</span>: camera.<span class="hljs-property">PhotoOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPhotoAccessHelper</span>(<span class="hljs-params">context: Context</span>): photoAccessHelper.<span class="hljs-property">PhotoAccessHelper</span> {</li><li>  <span class="hljs-keyword">let</span> phAccessHelper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>  <span class="hljs-keyword">return</span> phAccessHelper;</li><li>}</li><li>   </li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDataHandler</span> <span class="hljs-keyword">implements</span> photoAccessHelper.<span class="hljs-property">MediaAssetDataHandler</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt; {</li><li>  <span class="hljs-title function_">onDataPrepared</span>(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (data === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error occurred when preparing data'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'on image data prepared'</span>);</li><li>    <span class="hljs-comment">// 请在获取到拍照buffer后，再释放session，提前释放session，会导致无法正常出图。</span></li><li>    <span class="hljs-title function_">releaseCamSession</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mediaLibRequestBuffer</span>(<span class="hljs-params">photoAsset: photoAccessHelper.PhotoAsset, context: Context</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">requestOptions</span>: photoAccessHelper.<span class="hljs-property">RequestOptions</span> = {</li><li>    <span class="hljs-attr">deliveryMode</span>: photoAccessHelper.<span class="hljs-property">DeliveryMode</span>.<span class="hljs-property">FAST_MODE</span>,</li><li>  }</li><li>  <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaDataHandler</span>();</li><li>  <span class="hljs-keyword">await</span> photoAccessHelper.<span class="hljs-property">MediaAssetManager</span>.<span class="hljs-title function_">requestImageData</span>(context, photoAsset, requestOptions, handler);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'requestImageData successfully'</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mediaLibSavePhoto</span>(<span class="hljs-params">photoAsset: photoAccessHelper.PhotoAsset,</span></li><li><span class="hljs-params">  phAccessHelper: photoAccessHelper.PhotoAccessHelper</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">assetChangeRequest</span>: photoAccessHelper.<span class="hljs-property">MediaAssetChangeRequest</span> =</li><li>      <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">MediaAssetChangeRequest</span>(photoAsset);</li><li>    assetChangeRequest.<span class="hljs-title function_">saveCameraPhoto</span>();</li><li>    <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">applyChanges</span>(assetChangeRequest);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'apply saveCameraPhoto successfully'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`apply saveCameraPhoto failed with error: <span class="hljs-subst">${err.code}</span>, <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setPhotoOutputCb</span>(<span class="hljs-params">photoOutput: camera.PhotoOutput, context: Context</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// 监听回调之后，调用photoOutput的capture方法，低质量图上报后触发回调。</span></li><li>  photoOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'photoAssetAvailable'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">photoAsset</span>: photoAccessHelper.<span class="hljs-property">PhotoAsset</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'getPhotoAsset start'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`err: <span class="hljs-subst">${err}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> ((err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) || photoAsset === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getPhotoAsset failed'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 调用媒体库落盘接口保存一阶段低质量图，二阶段真图就绪后媒体库会主动帮应用替换落盘图片。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">mediaLibSavePhoto</span>(photoAsset, <span class="hljs-title function_">getPhotoAccessHelper</span>(context));</li><li>    <span class="hljs-comment">// 调用媒体库接口注册低质量图或高质量图buffer回调，自定义处理。</span></li><li>    <span class="hljs-comment">// mediaLibRequestBuffer(photoAsset, context);</span></li><li>  });</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deferredCaptureCase</span>(<span class="hljs-params">context: Context, surfaceId: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(context);</li><li>  <span class="hljs-keyword">if</span> (!cameraManager) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'camera.getCameraManager error'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听相机状态变化。</span></li><li>  cameraManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'cameraStatus'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, cameraStatusInfo: camera.CameraStatusInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraStatus with errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`camera : <span class="hljs-subst">${cameraStatusInfo.camera.cameraId}</span>`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`status: <span class="hljs-subst">${cameraStatusInfo.status}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 获取相机列表。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = cameraManager.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>  <span class="hljs-keyword">if</span> (cameraArray.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraManager.getSupportedCameras error'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; cameraArray.<span class="hljs-property">length</span>; index++) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'cameraId : '</span> + cameraArray[index].<span class="hljs-property">cameraId</span>); <span class="hljs-comment">// 获取相机ID。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'cameraPosition : '</span> + cameraArray[index].<span class="hljs-property">cameraPosition</span>); <span class="hljs-comment">// 获取相机位置。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'cameraType : '</span> + cameraArray[index].<span class="hljs-property">cameraType</span>); <span class="hljs-comment">// 获取相机类型。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connectionType : '</span> + cameraArray[index].<span class="hljs-property">connectionType</span>); <span class="hljs-comment">// 获取相机连接类型。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建相机输入流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    cameraInput = cameraManager.<span class="hljs-title function_">createCameraInput</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to createCameraInput errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (cameraInput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听cameraInput错误信息。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraDevice</span>: camera.<span class="hljs-property">CameraDevice</span> = cameraArray[<span class="hljs-number">0</span>];</li><li>  cameraInput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, cameraDevice, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Camera input error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 打开相机。</span></li><li>  <span class="hljs-keyword">await</span> cameraInput.<span class="hljs-title function_">open</span>();</li><li>
</li><li>  <span class="hljs-comment">// 获取支持的模式类型。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneModes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">SceneMode</span>&gt; = cameraManager.<span class="hljs-title function_">getSupportedSceneModes</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupportPhotoMode</span>: <span class="hljs-built_in">boolean</span> = sceneModes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (!isSupportPhotoMode) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'photo mode not support'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 获取相机设备支持的输出流能力。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraOutputCap</span>: camera.<span class="hljs-property">CameraOutputCapability</span> =</li><li>    cameraManager.<span class="hljs-title function_">getSupportedOutputCapability</span>(cameraArray[<span class="hljs-number">0</span>], camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>);</li><li>  <span class="hljs-keyword">if</span> (!cameraOutputCap) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraManager.getSupportedOutputCapability error'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'outputCapability: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cameraOutputCap));</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">Profile</span>&gt; = cameraOutputCap.<span class="hljs-property">previewProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!previewProfilesArray) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createOutput previewProfilesArray == null || undefined'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">photoProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">Profile</span>&gt; = cameraOutputCap.<span class="hljs-property">photoProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!photoProfilesArray) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createOutput photoProfilesArray == null || undefined'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建预览输出流,其中参数surfaceId参考上文XComponent组件，预览流为XComponent组件提供的surface。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    previewOutput = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfilesArray[<span class="hljs-number">0</span>], surfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the PreviewOutput instance. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (previewOutput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听预览输出错误信息。</span></li><li>  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Preview output error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 创建拍照输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoOutput = cameraManager.<span class="hljs-title function_">createPhotoOutput</span>(photoProfilesArray[<span class="hljs-number">0</span>]);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to createPhotoOutput errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (photoOutput === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 注册监听photoAssetAvailable回调。</span></li><li>  <span class="hljs-title function_">setPhotoOutputCb</span>(photoOutput, context);</li><li>
</li><li>  <span class="hljs-comment">// 创建会话。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">PhotoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to create the session instance. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (photoSession === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听session错误信息。</span></li><li>  photoSession.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Capture session error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 开始配置会话。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to beginConfig. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 向会话中添加相机输入流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession.<span class="hljs-title function_">addInput</span>(cameraInput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to addInput. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 向会话中添加预览输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession.<span class="hljs-title function_">addOutput</span>(previewOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to addOutput(previewOutput). errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 向会话中添加拍照输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession.<span class="hljs-title function_">addOutput</span>(photoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to addOutput(photoOutput). errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 提交会话配置。</span></li><li>  <span class="hljs-keyword">await</span> photoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>
</li><li>  <span class="hljs-comment">// 启动会话。</span></li><li>  <span class="hljs-keyword">await</span> photoSession.<span class="hljs-title function_">start</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Promise returned to indicate the session start success.'</span>);</li><li>  });</li><li>  <span class="hljs-comment">// 判断设备是否支持闪光灯。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">flashStatus</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    flashStatus = photoSession.<span class="hljs-title function_">hasFlash</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to hasFlash. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Returned with the flash light support status:'</span> + flashStatus);</li><li>
</li><li>  <span class="hljs-keyword">if</span> (flashStatus) {</li><li>    <span class="hljs-comment">// 判断是否支持自动闪光灯模式。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">flashModeStatus</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">status</span>: <span class="hljs-built_in">boolean</span> = photoSession.<span class="hljs-title function_">isFlashModeSupported</span>(camera.<span class="hljs-property">FlashMode</span>.<span class="hljs-property">FLASH_MODE_AUTO</span>);</li><li>      flashModeStatus = status;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to check whether the flash mode is supported. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (flashModeStatus) {</li><li>      <span class="hljs-comment">// 设置自动闪光灯模式。</span></li><li>      <span class="hljs-keyword">try</span> {</li><li>        photoSession.<span class="hljs-title function_">setFlashMode</span>(camera.<span class="hljs-property">FlashMode</span>.<span class="hljs-property">FLASH_MODE_AUTO</span>);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set the flash mode. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 判断是否支持连续自动变焦模式。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">focusModeStatus</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">status</span>: <span class="hljs-built_in">boolean</span> = photoSession.<span class="hljs-title function_">isFocusModeSupported</span>(camera.<span class="hljs-property">FocusMode</span>.<span class="hljs-property">FOCUS_MODE_CONTINUOUS_AUTO</span>);</li><li>    focusModeStatus = status;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to check whether the focus mode is supported. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (focusModeStatus) {</li><li>    <span class="hljs-comment">// 设置连续自动变焦模式。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      photoSession.<span class="hljs-title function_">setFocusMode</span>(camera.<span class="hljs-property">FocusMode</span>.<span class="hljs-property">FOCUS_MODE_CONTINUOUS_AUTO</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set the focus mode. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取相机支持的可变焦距比范围。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">zoomRatioRange</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    zoomRatioRange = photoSession.<span class="hljs-title function_">getZoomRatioRange</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to get the zoom ratio range. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (zoomRatioRange.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置可变焦距比。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoSession.<span class="hljs-title function_">setZoomRatio</span>(zoomRatioRange[<span class="hljs-number">0</span>]);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set the zoom ratio value. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">photoCaptureSetting</span>: camera.<span class="hljs-property">PhotoCaptureSetting</span> = {</li><li>    <span class="hljs-attr">quality</span>: camera.<span class="hljs-property">QualityLevel</span>.<span class="hljs-property">QUALITY_LEVEL_HIGH</span>, <span class="hljs-comment">// 设置图片质量高。</span></li><li>    <span class="hljs-attr">rotation</span>: camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_0</span> <span class="hljs-comment">// 设置图片旋转角度0。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 使用当前拍照设置触发一次拍照。</span></li><li>  photoOutput.<span class="hljs-title function_">capture</span>(photoCaptureSetting, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to capture the photo <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Callback invoked to indicate the photo capture request success.'</span>);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">releaseCamSession</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 停止当前会话。</span></li><li>  <span class="hljs-keyword">await</span> photoSession?.<span class="hljs-title function_">stop</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放拍照输出流。</span></li><li>  <span class="hljs-keyword">await</span> photoOutput?.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放预览输出流。</span></li><li>  <span class="hljs-keyword">await</span> previewOutput?.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放相机输入流。</span></li><li>  <span class="hljs-keyword">await</span> cameraInput?.<span class="hljs-title function_">close</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放会话。</span></li><li>  <span class="hljs-keyword">await</span> photoSession?.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 会话置空。</span></li><li>  photoSession = <span class="hljs-literal">undefined</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'PhotoAssetDemo'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> surfaceId = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getHostContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraPermission</span>: <span class="hljs-title class_">Permissions</span> = <span class="hljs-string">'ohos.permission.CAMERA'</span>; <span class="hljs-comment">// 申请权限相关问题可参考本篇开头的申请相关权限文档</span></li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestPermissionsFn</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, [<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>]);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; res.<span class="hljs-property">permissions</span>.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>.<span class="hljs-title function_">toString</span>() === res.<span class="hljs-property">permissions</span>[i] &amp;&amp; res.<span class="hljs-property">authResults</span>[i] === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = <span class="hljs-literal">true</span>;</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissionsFn</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>          <span class="hljs-title class_">XComponent</span>({</li><li>            <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>            <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>            <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>          })</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onLoad surfaceId: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.surfaceId}</span>`</span>);</li><li>              <span class="hljs-title function_">deferredCaptureCase</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>);</li><li>            }</li><li>          })</li><li>          .<span class="hljs-title function_">renderFit</span>(<span class="hljs-title class_">RenderFit</span>.<span class="hljs-property">RESIZE_CONTAIN</span>)</li><li>        }</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'95%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'PhotoAssetDemo'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">38</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>