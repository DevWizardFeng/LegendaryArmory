<h1 _ngcontent-ski-c119="" class="doc-title ng-star-inserted" title="创建异步线程执行AVTranscoder视频转码(ArkTS)"> 创建异步线程执行AVTranscoder视频转码(ArkTS) </h1>

<div _ngcontent-ski-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发过程中，应用经常会创建异步线程执行视频转码任务以满足不同诉求，主要包括：</p>    <ul>     <li>      <p>节省存储空间。</p>      <p>高清视频文件通常存储空间占用大，几分钟的视频就可能占用数GB的存储空间。视频压缩可以显著减小文件大小，节省存储空间。</p></li>     <li>      <p>提高设备兼容性。</p>      <p>不同设备所支持播放的视频格式各不相同。视频转码可以将源视频格式转换成设备支持的常用格式，以满足不同设备的播放需求，从而提高视频文件的设备兼容性。</p></li>    </ul>    <div class="tiledSection">     <h2 id="基础概念">基础概念<i class="anchor-icon anchor-icon-link" anchorid="基础概念" tips="复制节点链接"></i></h2>          <p>视频的码率（Bitrate）和分辨率（宽×高）是影响视频画质和文件大小的两个关键因素。它们之间的关系并非简单的线性对应，而是受到编码效率、内容复杂度等多种因素的共同影响。</p>     <ul>      <li>       <p><strong>码率（Bitrate）和分辨率（宽×高）的基本概念</strong></p>       <ul>        <li>         <p>码率：指的是单位时间内视频流的数据量（单位：Kbps 或 Mbps）。1 Mbps = 1,000,000 bit/s（1,000,000比特每秒）。</p>         <p>码率越高，单位时间内传输的数据越多，潜在画质更高，但文件体积也更大。</p></li>        <li>         <p>分辨率：指视频画面的像素数量（例如 1920×1080）。</p>         <p>分辨率越高，像素数量越多，画面细节更加清晰，但需要处理的数据量也更大。</p></li>       </ul></li>      <li>       <p><strong>码率和分辨率的关系</strong></p>       <ul>        <li>         <p>直观关系</p>         <p>在相同编码效率和内容复杂度的情况下，分辨率越大，则需要分配越高的码率以保持画质。如果所分配的码率不足，编码器会通过压缩（如丢弃细节、增加块效应）来降低数据量。</p></li>        <li>         <p>公式参考（经验法则）</p>         <ul>          <li>码率正比于 分辨率宽×分辨率高×帧率×复杂度系数</li>          <li>复杂度系数与视频内容的动态程度相关，例如静态画面（例如讲座视频）低复杂度系数，可以较低码率保持清晰，动态画面（例如体育比赛）高复杂度系数，需要更高的码率。</li>         </ul></li>       </ul></li>      <li>       <p><strong>编码效率的影响</strong></p>       <p>不同的编码标准（如 H.264、H.265、AV1）具有不同的压缩效率：</p>       <ul>        <li>高效编码器（如 H.265）在相同分辨率和画质下，码率可比 H.264 降低约50%。</li>        <li>低效编码器（如 MJPEG）需要更高的码率以避免画质损失。</li>       </ul></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="选择合适的码率和分辨率">选择合适的码率和分辨率<i class="anchor-icon anchor-icon-link" anchorid="选择合适的码率和分辨率" tips="复制节点链接"></i></h2>          <ul>      <li>       <p><strong>码率转换</strong></p>       <p>输入：源视频的宽w<sub>ref</sub>、高h<sub>ref</sub>、帧率fps<sub>ref</sub>、码率R<sub>ref</sub>；目标视频的宽w<sub>tar</sub>、高h<sub>tar</sub>、帧率fps<sub>tar</sub>。</p>       <p>输出：目标视频的码率R<sub>tar</sub>。</p>       <p>计算过程：</p>       <p><span><img originheight="74" originwidth="542" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114448.60173686619607116147368687109571:50001231000000:2800:9DFC7090B28037F5320CC9D49F77867AE7DDF95A03BBF4ABC42D05FE4B0675CC.png" width="542" height="74"></span></p>       <p>分辨率和帧率的系数由以下经验公式计算可得。</p>       <p><span><img originheight="66" originwidth="547" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114448.39341083961367688549795295861064:50001231000000:2800:400C18E154EA415704B2B17F731D42C0FDBDE4CCA08B459D1440990A91A4733D.png" width="547" height="66"></span></p>       <p><span><img originheight="88" originwidth="536" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114448.79723897479696651061233646176471:50001231000000:2800:CA0801F2119EF23C1C74F212838EDF561658C111FBBE6310D2CA57C0A61C7DAC.png" width="536" height="88"></span></p>       <p>上述计算帧率的公式y=clip(0.5, 2, x)表示：如果x∈[0.5, 2.0]，取y=x；如果x＜0.5，取y=0.5；如果x＞2.0，取y=2.0。</p></li>      <li>       <p><strong>码率计算</strong></p>       <p>选定一个baseline的码率，例如720P/30fps的视频，码率默认3Mbps，记为V0。</p>       <p>如果要对视频V1做转码，输出视频为V2，可以按如下过程计算：</p>       <ol>        <li>带入(V0,V2)，得到估计码率为R2。</li>        <li>         <p>带入(V1,V2)，得到估计码率为R2'。</p>         <p>取二者最小值，以确保目标码率比源视频有所降低。</p></li>       </ol></li>      <li>       <p><strong>分辨率设置参考（以H.264为例）</strong></p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.4.2.3.2.1.5.1.1" valign="top" width="25%">分辨率</th>           <th align="left" class="cellrowborder" id="mcps1.3.4.2.3.2.1.5.1.2" valign="top" width="25%">动态内容（如游戏）</th>           <th align="left" class="cellrowborder" id="mcps1.3.4.2.3.2.1.5.1.3" valign="top" width="25%">中等动态（如电影）</th>           <th align="left" class="cellrowborder" id="mcps1.3.4.2.3.2.1.5.1.4" valign="top" width="25%">静态内容（如幻灯片）</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="25%">720p(1280 × 720)</td>           <td class="cellrowborder" valign="top" width="25%">3.5–5 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">2.5–4 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">1–2 Mbps</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">1080p(1920 × 1080)</td>           <td class="cellrowborder" valign="top" width="25%">6–8 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">4–6 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">2–3 Mbps</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="25%">4K(3840 × 2160)</td>           <td class="cellrowborder" valign="top" width="25%">25–35 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">15–25 Mbps</td>           <td class="cellrowborder" valign="top" width="25%">10–15 Mbps</td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p><strong>转换样例</strong></p>       <p>场景一：假设要转码一个分辨率1280×720，30fps的视频，码率为1Mbps，这是画质相对比较良好的视频。需要将视频转码为分辨率640×480，30fps的视频，码率应该设置为463,463bps。计算如下：</p>       <p>Resolution_factor = 0.463463</p>       <p>fps_factor = 1</p>       <p>R<sub>tar</sub> = 463,463bps</p>       <p>场景二：假设要转码一个分辨率1280×720，30fps的视频，码率为1Mbps的视频。需要将视频转码为码率为600,000bps，30fps的视频，分辨率应该设置为888×500。计算如下：</p>       <p>fps_factor = 1</p>       <p>R<sub>tar</sub> = 600,000bps</p>       <p>Resolution_factor = 0.482029</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="视频转码压缩开发样例">视频转码压缩开发样例<i class="anchor-icon anchor-icon-link" anchorid="视频转码压缩开发样例" tips="复制节点链接"></i></h2>          <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVTranscoderDemo</span> {</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-attr">avTranscoder</span>: media.<span class="hljs-property">AVTranscoder</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">context: Context</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = context;</li><li>    }</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-attr">avConfig</span>: media.<span class="hljs-property">AVTranscoderConfig</span> = {</li><li>        <span class="hljs-comment">// audioBitrate: 100000, // 音频比特率。</span></li><li>        <span class="hljs-comment">// audioCodec: media.CodecMimeType.AUDIO_AAC, // 音频编码格式。</span></li><li>        <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 封装格式。</span></li><li>        <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">1000000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>        <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频编码格式。</span></li><li>        <span class="hljs-attr">videoFrameWidth</span>: <span class="hljs-number">1280</span>, <span class="hljs-comment">// 视频分辨率的宽。</span></li><li>        <span class="hljs-attr">videoFrameHeight</span>: <span class="hljs-number">720</span>  <span class="hljs-comment">// 视频分辨率的高。</span></li><li>    };</li><li>    <span class="hljs-comment">// 注册avTranscoder回调函数。</span></li><li>    <span class="hljs-title function_">setAVTranscoderCallback</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVTranscoder"</span>)) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>                <span class="hljs-comment">// 转码完成回调函数。</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`AVTranscoder is completed`</span>);</li><li>                    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseTranscoderingProcess</span>();</li><li>                });</li><li>                <span class="hljs-comment">// 错误上报回调函数。</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVTranscoder failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                });</li><li>            }</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 开始转码对应的流程。</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">startTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVTranscoder"</span>) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> != <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">release</span>();</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-literal">undefined</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 1.创建转码实例。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVTranscoderCallback</span>();</li><li>            <span class="hljs-comment">// 2.获取转码源文件fd和目标文件fd赋予avTranscoder；参考FilePicker文档。</span></li><li>            <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'H264_AAC.mp4'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-property">fdSrc</span> = fileDescriptor;</li><li>            <span class="hljs-keyword">let</span> outputFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">filesDir</span> + <span class="hljs-string">"/output.mp4"</span>;</li><li>            <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(outputFilePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-property">fdDst</span> = file.<span class="hljs-property">fd</span>;</li><li>            <span class="hljs-comment">// 3.配置转码参数完成准备工作。</span></li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">prepare</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avConfig</span>);</li><li>            <span class="hljs-comment">// 4.开始转码。</span></li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">start</span>();</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 暂停转码对应的流程。</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">pauseTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVTranscoder"</span>)) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// 仅在调用start返回后调用pause为合理调用。</span></li><li>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">pause</span>();</li><li>            }</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 恢复对应的转码流程。</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">resumeTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVTranscoder"</span>)) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// 仅在调用pause返回后调用resume为合理调用。</span></li><li>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">resume</span>();</li><li>            }</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 释放转码流程。</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseTranscoderingProcess</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVTranscoder"</span>)) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> != <span class="hljs-literal">undefined</span>) {</li><li>                <span class="hljs-comment">// 1.释放转码实例。</span></li><li>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span>.<span class="hljs-title function_">release</span>();</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">avTranscoder</span> = <span class="hljs-literal">undefined</span>;</li><li>                <span class="hljs-comment">// 2.关闭转码目标文件fd。</span></li><li>            }</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 一个完整的【开始转码-暂停转码-恢复转码-转码完成】示例。</span></li><li>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">avTranscoderDemo</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startTranscoderingProcess</span>(); <span class="hljs-comment">// 开始转码。</span></li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseTranscoderingProcess</span>(); <span class="hljs-comment">//暂停转码。</span></li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resumeTranscoderingProcess</span>(); <span class="hljs-comment">// 恢复转码。</span></li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseTranscoderingProcess</span>(); <span class="hljs-comment">// 释放转码。</span></li><li>    }</li><li>}</li></ol></pre></div></div>     <p>具体如何使用转码能力对视频进行转码，可以参见文档：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-avtranscoder-for-transcodering">用AVTranscoder实现视频转码</a>。</p>    </div>    <div class="tiledSection">     <h2 id="使用异步线程的方式进行转码">使用异步线程的方式进行转码<i class="anchor-icon anchor-icon-link" anchorid="使用异步线程的方式进行转码" tips="复制节点链接"></i></h2>          <p>本示例使用的是worker线程的方式来实现异步线程进行转码，worker线程的详细使用方式，可以参见文档:</p>     <ul>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker" target="_blank">Worker线程使用说明</a></li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">Worker简介</a></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="开发步骤" class="firsth2">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>引入头文件，创建worker线程，并注册回调。</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorEvent</span>, <span class="hljs-title class_">MessageEvents</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableObject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../util/SendableObject'</span>;</li><li><span class="hljs-keyword">import</span> { common, sendableContextManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建Worker对象。</span></li><li><span class="hljs-keyword">private</span> workerInstance?: worker.<span class="hljs-property">ThreadWorker</span>;</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/task.ets'</span>);</li><li>
</li><li><span class="hljs-comment">// 注册onmessage回调，当宿主线程接收到来自其创建的Worker通过workerPort.postMessage接口发送的消息时被调用，在宿主线程执行。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> = e.<span class="hljs-property">data</span>;</li><li>   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'string'</span>) { <span class="hljs-comment">// complete事件。</span></li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'workerInstance onmessage is: '</span>, data);</li><li>     <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'complete'</span>) {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'complete: '</span>, data);</li><li>       <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>?.<span class="hljs-title function_">terminate</span>();</li><li>     }</li><li>   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'number'</span>) {</li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentProgress</span> = data; <span class="hljs-comment">// 当前进度。</span></li><li>   }</li><li> }</li><li>
</li><li><span class="hljs-comment">// 注册onErrors回调，可以捕获Worker线程的onmessage回调、timer回调以及文件执行等流程产生的全局异常，在宿主线程执行。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err: ErrorEvent</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"workerInstance onerror message is: "</span> + err.<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册onmessageerror回调，当Worker对象接收到一条无法被序列化的消息时被调用，在宿主线程执行。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-property">onmessageerror</span> = <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'workerInstance onmessageerror'</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册onexit回调，当Worker销毁时被调用，在宿主线程执行。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-property">onexit</span> = <span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 当Worker正常退出时code为0，异常退出时code为1。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"workerInstance onexit code is: "</span>, e);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建参数对象，向worker线程发送参数对象。</p>       <p>如下是参数对象模型：</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { sendableContextManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">//发送的参数必须加上@Sendable标注。</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableObject</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">sendableContext: sendableContextManager.SendableContext, data: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sendableContext</span> = sendableContext;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">sendableContext</span>: sendableContextManager.<span class="hljs-property">SendableContext</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getSendableContext</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sendableContext</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>如下是发送参数的逻辑：</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-comment">// 向Worker线程发送消息。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>(); <span class="hljs-comment">// 获取当前组件所在Ability的Context。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> != <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">sendableContext</span>: sendableContextManager.<span class="hljs-property">SendableContext</span> = sendableContextManager.<span class="hljs-title function_">convertFromContext</span>(</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">sendableObject</span>: <span class="hljs-title class_">SendableObject</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableObject</span>(sendableContext, <span class="hljs-string">'some information'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-title function_">postMessageWithSharedSendable</span>(sendableObject);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>worker线程接收参数，并且执行转码的逻辑。</p>       <p>worker线程接收参数：</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//worker线程接收参数。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">sendableObject</span>: <span class="hljs-title class_">SendableObject</span> = event.<span class="hljs-property">data</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">sendableContext</span>: sendableContextManager.<span class="hljs-property">SendableContext</span> =</li><li>  sendableObject.<span class="hljs-title function_">getSendableContext</span>() <span class="hljs-keyword">as</span> sendableContextManager.<span class="hljs-property">SendableContext</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">Context</span> =</li><li>  sendableContextManager.<span class="hljs-title function_">convertToContext</span>(sendableContext) <span class="hljs-keyword">as</span> common.<span class="hljs-property">Context</span>;</li><li><span class="hljs-comment">//执行转码逻辑。</span></li><li><span class="hljs-keyword">await</span> <span class="hljs-title function_">doSome</span>(context);</li><li><span class="hljs-comment">// 向主线程发送消息。</span></li><li>workerPort.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'start end'</span>);</li></ol></pre></div></div>       <p>执行转码逻辑：</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doSome</span>(<span class="hljs-params">context: common.Context</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`doSome in`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> transcoder = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVTranscoder</span>();</li><li>    <span class="hljs-comment">// 转码完成回调函数。</span></li><li>    transcoder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`transcode complete`</span>);</li><li>      fs.<span class="hljs-title function_">closeSync</span>(transcoder.<span class="hljs-property">fdDst</span>); <span class="hljs-comment">// 关闭fdDst。</span></li><li>      <span class="hljs-keyword">await</span> transcoder?.<span class="hljs-title function_">release</span>()</li><li>      workerPort.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'complete'</span>);</li><li>    })</li><li>    <span class="hljs-comment">// 转码错误回调函数。</span></li><li>    transcoder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      fs.<span class="hljs-title function_">closeSync</span>(transcoder.<span class="hljs-property">fdDst</span>);</li><li>      <span class="hljs-keyword">await</span> transcoder?.<span class="hljs-title function_">release</span>();</li><li>    })</li><li>    <span class="hljs-comment">// 转码进度更新回调函数。</span></li><li>    transcoder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progressUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">progress: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVTranscoder progressUpdate = <span class="hljs-subst">${progress}</span>`</span>);</li><li>      workerPort.<span class="hljs-title function_">postMessage</span>(progress);</li><li>    })</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取输入文件fd，H264_AAC.mp4为rawfile目录下的预置资源，需要开发者根据实际情况进行替换。</span></li><li>      <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-string">'H264_AAC.mp4'</span>);</li><li>      transcoder.<span class="hljs-property">fdSrc</span> = fileDescriptor; <span class="hljs-comment">// 设置fdSrc。</span></li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to get the file descriptor, please check the resource and path.'</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 设置输出文件路径，context.filesDir为应用的沙箱路径。</span></li><li>    <span class="hljs-keyword">let</span> fdPath = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">"/"</span> + <span class="hljs-string">"VID_"</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toString</span>()) + <span class="hljs-string">".mp4"</span>;</li><li>    <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(fdPath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>    <span class="hljs-keyword">let</span> fd = file.<span class="hljs-property">fd</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`file fd <span class="hljs-subst">${fd}</span>`</span>);</li><li>    transcoder.<span class="hljs-property">fdDst</span> = file.<span class="hljs-property">fd</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: media.<span class="hljs-property">AVTranscoderConfig</span> = {</li><li>      <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>, <span class="hljs-comment">// 封装格式。</span></li><li>      <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>, <span class="hljs-comment">// 音频编码格式。</span></li><li>      <span class="hljs-attr">videoCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>, <span class="hljs-comment">// 视频编码格式。</span></li><li>      <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">200000</span>, <span class="hljs-comment">// 视频比特率。</span></li><li>    }</li><li>    <span class="hljs-keyword">await</span> transcoder?.<span class="hljs-title function_">prepare</span>(config);</li><li>    <span class="hljs-keyword">await</span> transcoder?.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`transcode error: code = `</span> + e.<span class="hljs-property">code</span>.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">`, message = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e.message)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>监听转码的Complete回调，在转码结束的时候向主线程发送消息。</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 转码完成回调函数。</span></li><li>transcoder.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`transcode complete`</span>);</li><li>  fs.<span class="hljs-title function_">closeSync</span>(transcoder.<span class="hljs-property">fdDst</span>); <span class="hljs-comment">// 关闭fdDst。</span></li><li>  <span class="hljs-keyword">await</span> transcoder?.<span class="hljs-title function_">release</span>()</li><li>  workerPort.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'complete'</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>主线程接收到worker线程转码结束的信息，销毁worker线程。</p>       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册onmessage回调，当宿主线程接收到来自其创建的Worker通过workerPort.postMessage接口发送的消息时被调用，在宿主线程执行。</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> = e.<span class="hljs-property">data</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'string'</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'workerInstance onmessage is: '</span>, data);</li><li>    <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'complete'</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'complete: '</span>, data);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>?.<span class="hljs-title function_">terminate</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'number'</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentProgress</span> = data;</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="运行示例工程">运行示例工程<i class="anchor-icon anchor-icon-link" anchorid="运行示例工程" tips="复制节点链接"></i></h2>          <p>参考以下示例，使用worker线程的方式来实现异步线程进行转码。</p>     <ol>      <li>新建工程，下载<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/Media/AVTranscoder/AsyncTranscoder" target="_blank">完整示例工程</a>，并将示例工程的资源复制到对应目录。       <div _ngcontent-ski-c106="" class="highlight-div"><div _ngcontent-ski-c106="" class="highlight-div-header"><div _ngcontent-ski-c106="" class="highlight-div-header-left"><div _ngcontent-ski-c106="" class="handle-button expand-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ski-c106="" class="highlight-div-header-right"><div _ngcontent-ski-c106="" class="handle-button ai-button"></div><div _ngcontent-ski-c106="" class="handle-button line-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ski-c106="" class="handle-button theme-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ski-c106="" class="handle-button copy-button"><div _ngcontent-ski-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ski-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>AsyncTranscoder</li><li>entry/build-profile<span class="hljs-selector-class">.json5</span> (配置字段信息将Worker线程文件打包到应用)</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/</li><li>├── pages</li><li>│    └── Index<span class="hljs-selector-class">.ets</span> (转码界面)</li><li>├── util</li><li>│    └── SendableObject<span class="hljs-selector-class">.ets</span> (Sendable对象)</li><li>│</li><li>└── workers</li><li>    └── task<span class="hljs-selector-class">.ets</span> (转码任务)</li><li>
</li><li>entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/</li><li>├── base</li><li>│   ├── element</li><li>│   │   ├── <span class="hljs-attribute">color</span><span class="hljs-selector-class">.json</span></li><li>│   │   ├── <span class="hljs-attribute">float</span><span class="hljs-selector-class">.json</span></li><li>│   │   └── string<span class="hljs-selector-class">.json</span></li><li>│   └── media</li><li>│</li><li>└── rawfile</li><li>    └── H264_AAC<span class="hljs-selector-class">.mp4</span> (视频资源)</li></ol></pre></div></div></li>      <li>编译新建工程并运行。</li>     </ol>    </div>   </div>   <div></div></div>