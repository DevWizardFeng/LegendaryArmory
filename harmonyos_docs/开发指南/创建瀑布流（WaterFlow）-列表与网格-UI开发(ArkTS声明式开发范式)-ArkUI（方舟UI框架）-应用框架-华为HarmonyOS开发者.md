<h1 _ngcontent-fmq-c119="" class="doc-title ng-star-inserted" title="创建瀑布流（WaterFlow）"> 创建瀑布流（WaterFlow） </h1>

<div _ngcontent-fmq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow" target="_blank">瀑布流</a>常用于展示图片信息，尤其在购物和资讯类应用中。</p>    <p>ArkUI提供了WaterFlow容器组件，用于构建瀑布流布局。WaterFlow组件支持条件渲染、循环渲染和懒加载等方式生成子组件。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>本文仅展示关键代码片段，可运行的完整代码请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#示例" target="_blank">WaterFlow示例代码</a>。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="布局与约束">布局与约束<i class="anchor-icon anchor-icon-link" anchorid="布局与约束" tips="复制节点链接"></i></h2>          <p>瀑布流支持横向和纵向布局。在纵向布局中，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#columnstemplate" target="_blank">columnsTemplate</a>设置列数；在横向布局中，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#rowstemplate" target="_blank">rowsTemplate</a>设置行数。</p>     <p>在瀑布流的纵向布局中，第一行的子节点按从左到右顺序排列，从第二行开始，每个子节点将放置在当前总高度最小的列。如果多个列的总高度相同，则按照从左到右的顺序填充。如下图：</p>     <p><span><img originheight="779" originwidth="377" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114845.92976953211399364244074469668679:50001231000000:2800:EF6C867327A99EDE4BBA7139F05140DAA79CCF39EEEDFAA2DC9060E7CA8EA022.png" width="377" height="779"></span></p>     <p>在瀑布流的横向布局中，每个子节点都会放置在当前总宽度最小的行。若多行总宽度相同，则按照从上到下的顺序进行填充。</p>     <p><span><img originheight="408" originwidth="377" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114845.57380095929672224040087476400652:50001231000000:2800:68B079E5B0B2FF9E8A326B6BF1B37A96AD420D68B0ACB3553F47B7B282C32C51.png" width="377" height="408"></span></p>    </div>    <div class="tiledSection">     <h2 id="无限滚动">无限滚动<i class="anchor-icon anchor-icon-link" anchorid="无限滚动" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="到达末尾时新增数据" class="firsth2">到达末尾时新增数据<i class="anchor-icon anchor-icon-link" anchorid="到达末尾时新增数据" tips="复制节点链接"></i></h3>          <p>瀑布流常用于无限滚动的信息流。可以在瀑布流组件到达末尾位置时触发的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onreachend" target="_blank">onReachEnd</a>事件回调中对<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">LazyForEach</a>增加新数据，并将footer做成正在加载新数据的样式（使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-loadingprogress" target="_blank">LoadingProgress</a>组件）。</p>     <div _ngcontent-fmq-c106="" class="highlight-div"><div _ngcontent-fmq-c106="" class="highlight-div-header"><div _ngcontent-fmq-c106="" class="highlight-div-header-left"><div _ngcontent-fmq-c106="" class="handle-button expand-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fmq-c106="" class="highlight-div-header-right"><div _ngcontent-fmq-c106="" class="handle-button ai-button"></div><div _ngcontent-fmq-c106="" class="handle-button line-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fmq-c106="" class="handle-button theme-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fmq-c106="" class="handle-button copy-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fmq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title function_">itemFoot</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">LoadingProgress</span>()</li><li>        .<span class="hljs-title function_">color</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>).<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">'20%'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`正在加载`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">align</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">2</span> })</li><li>    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-title class_">WaterFlow</span>({ <span class="hljs-attr">footer</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">itemFoot</span>(), <span class="hljs-attr">layoutMode</span>: <span class="hljs-title class_">WaterFlowLayoutMode</span>.<span class="hljs-property">SLIDING_WINDOW</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">FlowItem</span>() {</li><li>            <span class="hljs-title class_">ReusableFlowItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>[item % <span class="hljs-number">100</span>] / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>[item%<span class="hljs-number">100</span>])</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[item % <span class="hljs-number">5</span>])</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr '</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span>))</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFAEEE0</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>      <span class="hljs-comment">// 触底加载数据</span></li><li>      .<span class="hljs-title function_">onReachEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addNewItems</span>();</li><li>        }, <span class="hljs-number">1000</span>);</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// WaterFlowDataSource中增加在数据尾部增加count个元素的方法</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">addNewItems</span>(<span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> len = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDatasetChange</span>([{ <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataOperationType</span>.<span class="hljs-property">ADD</span>, <span class="hljs-attr">index</span>: len, <span class="hljs-attr">count</span>: count }]);</li><li>    })</li><li>  }</li></ol></pre></div></div>     <p>在此处应通过在数据末尾添加元素的方式来新增数据，不可直接修改dataArray后通过LazyForEach的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach#ondatareloaded" target="_blank">onDataReloaded</a>方法通知瀑布流重新加载数据。</p>     <p>由于在瀑布流布局中，各子节点的高度不一致，下面的节点位置依赖于上面的节点，所以重新加载所有数据会触发整个瀑布流重新计算布局，可能会导致卡顿。在数据末尾增加数据后，应使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach#ondatasetchange12" target="_blank">onDatasetChange([{ type: DataOperationType.ADD, index: len, count: count }])</a>通知，以使瀑布流能够识别新增数据并继续加载，同时避免对已有数据进行重复处理。</p>     <p><span><img originheight="713" originwidth="367" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114845.36892583689614383309889595517821:50001231000000:2800:0DC134ABEB637F9E191D1F240E46BADBAD620005D4EE717F2203F06F491DF226.gif" width="367" height="713"></span></p>    </div>    <div class="tiledSection">     <h3 id="提前新增数据">提前新增数据<i class="anchor-icon anchor-icon-link" anchorid="提前新增数据" tips="复制节点链接"></i></h3>          <p>虽然在onReachEnd()触发时加载数据可以实现无限加载，但在滑动到底部会出现明显的停顿。</p>     <p>为了实现更加流畅的无限滑动，需要调整增加新数据的时机。比如可以在LazyForEach还剩余若干个数据未遍历的情况下提前加载新数据。以下代码通过在WaterFlow的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onscrollindex11" target="_blank">onScrollIndex</a>中判断当前显示的最后一个子节点相对数据集终点的距离，并在合适时机提前加载新数据，实现了无停顿的无限滚动。</p>     <div _ngcontent-fmq-c106="" class="highlight-div"><div _ngcontent-fmq-c106="" class="highlight-div-header"><div _ngcontent-fmq-c106="" class="highlight-div-header-left"><div _ngcontent-fmq-c106="" class="handle-button expand-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fmq-c106="" class="highlight-div-header-right"><div _ngcontent-fmq-c106="" class="handle-button ai-button"></div><div _ngcontent-fmq-c106="" class="handle-button line-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fmq-c106="" class="handle-button theme-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fmq-c106="" class="handle-button copy-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fmq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-title class_">WaterFlow</span>({ <span class="hljs-attr">layoutMode</span>: <span class="hljs-title class_">WaterFlowLayoutMode</span>.<span class="hljs-property">SLIDING_WINDOW</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">FlowItem</span>() {</li><li>            <span class="hljs-title class_">ReusableFlowItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>[item % <span class="hljs-number">100</span>] / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>[item%<span class="hljs-number">100</span>])</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[item % <span class="hljs-number">5</span>])</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr '</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span>))</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFAEEE0</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>      <span class="hljs-comment">// 即将触底时提前增加数据</span></li><li>      .<span class="hljs-title function_">onScrollIndex</span>(<span class="hljs-function">(<span class="hljs-params">first: <span class="hljs-built_in">number</span>, last: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (last + <span class="hljs-number">20</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addNewItems</span>(<span class="hljs-number">100</span>);</li><li>          }, <span class="hljs-number">1000</span>);</li><li>        }</li><li>      })</li><li>    }</li><li>  }</li></ol></pre></div></div>     <p><span><img originheight="713" originwidth="367" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114846.70840533628446669107447484743356:50001231000000:2800:6F63BC44273F2990C662DFAC003606398E508554975824152AB61221DFE0113C.gif" width="367" height="713"></span></p>    </div>    <div class="tiledSection">     <h2 id="动态切换列数">动态切换列数<i class="anchor-icon anchor-icon-link" anchorid="动态切换列数" tips="复制节点链接"></i></h2>          <p>通过动态调整瀑布流的列数，应用能够实现在列表模式与瀑布流模式间的切换，或适应屏幕宽度的变化。 若要动态设置列数，建议采用瀑布流的移动窗口布局模式，这可以实现更快速的列数转换。</p>     <div _ngcontent-fmq-c106="" class="highlight-div"><div _ngcontent-fmq-c106="" class="highlight-div-header"><div _ngcontent-fmq-c106="" class="highlight-div-header-left"><div _ngcontent-fmq-c106="" class="handle-button expand-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fmq-c106="" class="highlight-div-header-right"><div _ngcontent-fmq-c106="" class="handle-button ai-button"></div><div _ngcontent-fmq-c106="" class="handle-button line-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fmq-c106="" class="handle-button theme-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fmq-c106="" class="handle-button copy-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fmq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过状态变量设置列数，可以按需修改触发布局更新</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">columns</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ReusableListItem</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = params.<span class="hljs-property">item</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-string">'res/waterFlow('</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> % <span class="hljs-number">5</span> + <span class="hljs-string">').JPG'</span>)</li><li>        .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>        .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"N"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'16'</span>).<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换列数'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span> === <span class="hljs-number">2</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span> = <span class="hljs-number">1</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span> = <span class="hljs-number">2</span>;</li><li>        }</li><li>      })</li><li>      <span class="hljs-title class_">WaterFlow</span>({ <span class="hljs-attr">layoutMode</span>: <span class="hljs-title class_">WaterFlowLayoutMode</span>.<span class="hljs-property">SLIDING_WINDOW</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">FlowItem</span>() {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span> === <span class="hljs-number">1</span>) {</li><li>              <span class="hljs-title class_">ReusableListItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-title class_">ReusableFlowItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>            }</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span> === <span class="hljs-number">2</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>[item % <span class="hljs-number">100</span>] / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>[item % <span class="hljs-number">100</span>] : <span class="hljs-number">0</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[item % <span class="hljs-number">5</span>])</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr '</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">columns</span>))</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFAEEE0</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>      <span class="hljs-comment">// 即将触底时提前增加数据</span></li><li>      .<span class="hljs-title function_">onScrollIndex</span>(<span class="hljs-function">(<span class="hljs-params">first: <span class="hljs-built_in">number</span>, last: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (last + <span class="hljs-number">20</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addNewItems</span>(<span class="hljs-number">100</span>);</li><li>          }, <span class="hljs-number">1000</span>);</li><li>        }</li><li>      })</li><li>    }</li><li>  }</li></ol></pre></div></div>     <p><span><img originheight="856" originwidth="416" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114846.91972545073761606580091658821410:50001231000000:2800:40DBB72A170BAB65502A2E98B2871AD111F4872C02639BD6A58028D54E278E5C.gif" width="416" height="856"></span></p>    </div>    <div class="tiledSection">     <h2 id="分组混合布局">分组混合布局<i class="anchor-icon anchor-icon-link" anchorid="分组混合布局" tips="复制节点链接"></i></h2>          <p>许多应用界面在瀑布流上方包含其他内容，这类场景可通过在Scroll或List内部嵌套WaterFlow来实现。类似下图：</p>     <p><span><img originheight="776" originwidth="372" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114846.52502914445059306089754233357379:50001231000000:2800:B199D00644CDCAA463B741F726CCD6F110B1D908838BD155E317789F4B7A80AA.png" width="372" height="776"></span></p>     <p>如果能够将不同部分的子节点整合到一个数据源中，那么通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#sections12" target="_blank">WaterFlowSections</a>，可以在一个 WaterFlow 容器内实现混合布局。与嵌套滚动相比，这种方法可以简化滚动事件处理等应用逻辑。</p>     <p>每个瀑布流分组可以分别设置自己的列数、行间距、列间距、margin和子节点总数，如下代码可以实现上述效果：</p>     <div _ngcontent-fmq-c106="" class="highlight-div"><div _ngcontent-fmq-c106="" class="highlight-div-header"><div _ngcontent-fmq-c106="" class="highlight-div-header-left"><div _ngcontent-fmq-c106="" class="handle-button expand-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fmq-c106="" class="highlight-div-header-right"><div _ngcontent-fmq-c106="" class="handle-button ai-button"></div><div _ngcontent-fmq-c106="" class="handle-button line-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fmq-c106="" class="handle-button theme-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fmq-c106="" class="handle-button copy-button"><div _ngcontent-fmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fmq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WaterFlowDemo</span> {</li><li>  <span class="hljs-attr">minSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">80</span>;</li><li>  <span class="hljs-attr">maxSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">180</span>;</li><li>  <span class="hljs-attr">colors</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">0xFFC0CB</span>, <span class="hljs-number">0xDA70D6</span>, <span class="hljs-number">0x6B8E23</span>, <span class="hljs-number">0x6A5ACD</span>, <span class="hljs-number">0x00FFFF</span>, <span class="hljs-number">0x00FF7F</span>];</li><li>  <span class="hljs-attr">dataSource</span>: <span class="hljs-title class_">WaterFlowDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaterFlowDataSource</span>(<span class="hljs-number">100</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemWidthArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemHeightArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">gridItems</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaterFlowSections</span>();</li><li>  <span class="hljs-attr">sectionMargin</span>: <span class="hljs-title class_">Margin</span> = {</li><li>    <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-attr">left</span>: <span class="hljs-number">5</span>,</li><li>    <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-attr">right</span>: <span class="hljs-number">5</span></li><li>  };</li><li>  <span class="hljs-attr">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-attr">itemsCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-attr">crossCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-attr">columnsGap</span>: <span class="hljs-number">5</span>,</li><li>    <span class="hljs-attr">rowsGap</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-attr">margin</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sectionMargin</span>,</li><li>  };</li><li>  <span class="hljs-attr">twoColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-attr">itemsCount</span>: <span class="hljs-number">98</span>,</li><li>    <span class="hljs-attr">crossCount</span>: <span class="hljs-number">2</span>,</li><li>  };</li><li>  <span class="hljs-comment">// 使用分组瀑布流时无法通过footer设置尾部组件，可以保留一个固定的分组作为footer</span></li><li>  <span class="hljs-attr">lastSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-attr">itemsCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-attr">crossCount</span>: <span class="hljs-number">1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 计算FlowItem宽/高</span></li><li>  <span class="hljs-title function_">getSize</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> ret = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>);</li><li>    <span class="hljs-keyword">return</span> (ret &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">minSize</span> ? ret : <span class="hljs-variable language_">this</span>.<span class="hljs-property">minSize</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置FlowItem的宽/高数组</span></li><li>  <span class="hljs-title function_">setItemSizeArray</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSize</span>());</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSize</span>());</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setItemSizeArray</span>();</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; ++i) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gridItems</span>.<span class="hljs-title function_">push</span>(i);</li><li>    }</li><li>    <span class="hljs-comment">// 所有分组的itemCount之和需要和WaterFlow下数据源的子节点总数相等，否则无法正常布局</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">sectionOptions</span>: <span class="hljs-title class_">SectionOptions</span>[] = [<span class="hljs-variable language_">this</span>.<span class="hljs-property">oneColumnSection</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">twoColumnSection</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastSection</span>];</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sections</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sectionOptions);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">WaterFlow</span>({ <span class="hljs-attr">layoutMode</span>: <span class="hljs-title class_">WaterFlowLayoutMode</span>.<span class="hljs-property">SLIDING_WINDOW</span>, <span class="hljs-attr">sections</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sections</span> }) {</li><li>      <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">FlowItem</span>() {</li><li>          <span class="hljs-keyword">if</span> (item === <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-title class_">Grid</span>() {</li><li>              <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">gridItems</span>, <span class="hljs-function">(<span class="hljs-params">day: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>                <span class="hljs-title class_">GridItem</span>() {</li><li>                  <span class="hljs-title class_">Text</span>(<span class="hljs-string">'GridItem'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>                }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFFC0CB</span>)</li><li>              }, <span class="hljs-function">(<span class="hljs-params">day: <span class="hljs-built_in">number</span></span>) =&gt;</span> day.<span class="hljs-title function_">toString</span>())</li><li>            }</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-string">'30%'</span>)</li><li>            .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">5</span>)</li><li>            .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">5</span>)</li><li>            .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr '</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">5</span>))</li><li>            .<span class="hljs-title function_">rowsTemplate</span>(<span class="hljs-string">'1fr '</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">3</span>))</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title class_">ReusableFlowItem</span>({ <span class="hljs-attr">item</span>: item })</li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">aspectRatio</span>(item != <span class="hljs-number">0</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeightArray</span>[item % <span class="hljs-number">100</span>] / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemWidthArray</span>[item % <span class="hljs-number">100</span>] : <span class="hljs-number">0</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(item != <span class="hljs-number">0</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[item % <span class="hljs-number">5</span>] : <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFAEEE0</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    <span class="hljs-comment">// 即将触底时提前增加数据</span></li><li>    .<span class="hljs-title function_">onScrollIndex</span>(<span class="hljs-function">(<span class="hljs-params">first: <span class="hljs-built_in">number</span>, last: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (last + <span class="hljs-number">20</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addNewItems</span>(<span class="hljs-number">100</span>);</li><li>          <span class="hljs-comment">// 增加数据后同步调整对应分组的itemCount</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">twoColumnSection</span>.<span class="hljs-property">itemsCount</span> += <span class="hljs-number">100</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">sections</span>.<span class="hljs-title function_">update</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">twoColumnSection</span>);</li><li>        }, <span class="hljs-number">1000</span>);</li><li>      }</li><li>    })</li><li>    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>使用分组混合布局时不支持单独设置footer，可以使用最后一个分组作为尾部组件。</p>       <p>增加或删除数据后需要同步修改对应分组的itemCount。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li>       <p><a href="https://gitcode.com/harmonyos_samples/water-flow" target="_blank">实现WaterFlow瀑布流布局功能</a></p></li>      <li>       <p><a href="https://gitcode.com/harmonyos-cases/cases/blob/master/CommonAppDevelopment/feature/functionalscenes/README.md" target="_blank">主页瀑布流实现</a></p></li>     </ul>    </div>   </div>   <div></div></div>