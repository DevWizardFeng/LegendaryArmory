<h1 _ngcontent-uqi-c119="" class="doc-title ng-star-inserted" title="创建算子工程"> 创建算子工程 </h1>

<div _ngcontent-uqi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>DDK开发套件包中提供了自定义算子工程生成工具msOpGen，可基于算子原型定义输出算子工程：包括<strong>算子host侧代码实现文件</strong>、<strong>算子kernel侧实现文件</strong>以及<strong>工程编译配置文件等</strong>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用msOpGen工具创建算子工程之前，需要参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-environment-preparation">环境准备</a>章节安装驱动固件和DDK软件包，完成开发环境和运行环境的准备。</p> <p>同时需要配置ascendc环境变量，示例如下。</p> <div _ngcontent-uqi-c106="" class="highlight-div"><div _ngcontent-uqi-c106="" class="highlight-div-header"><div _ngcontent-uqi-c106="" class="highlight-div-header-left"><div _ngcontent-uqi-c106="" class="handle-button expand-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqi-c106="" class="highlight-div-header-right"><div _ngcontent-uqi-c106="" class="handle-button ai-button"></div><div _ngcontent-uqi-c106="" class="handle-button line-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqi-c106="" class="handle-button theme-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqi-c106="" class="handle-button copy-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqi-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>source ddk/tools/tools_ascendc/set_ascendc_env.sh</li></ol></pre></div></div> </div></div></div> <p>使用msOpGen工具创建算子开发工程的步骤如下。</p> <ol><li><span>编写算子的原型定义json文件，用于生成算子开发工程。</span><p></p><p>例如，AddCustom算子的json文件命名为add_custom.json，文件内容如下。</p> <div _ngcontent-uqi-c106="" class="highlight-div"><div _ngcontent-uqi-c106="" class="highlight-div-header"><div _ngcontent-uqi-c106="" class="highlight-div-header-left"><div _ngcontent-uqi-c106="" class="handle-button expand-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqi-c106="" class="highlight-div-header-right"><div _ngcontent-uqi-c106="" class="handle-button ai-button"></div><div _ngcontent-uqi-c106="" class="handle-button line-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqi-c106="" class="handle-button theme-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqi-c106="" class="handle-button copy-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqi-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">[</span> </li><li>    <span class="hljs-punctuation">{</span> </li><li>        <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AddCustom"</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"input_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"float"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"int32"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"y"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"float"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"int32"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"output_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"z"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"float"</span><span class="hljs-punctuation">,</span> </li><li>                    <span class="hljs-string">"int32"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span> </li><li>    <span class="hljs-punctuation">}</span> </li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div> <p>例如，ReduceMaxCustom算子（包含属性）的json文件命名为reduce_max_custom.json，文件内容如下。</p> <div _ngcontent-uqi-c106="" class="highlight-div"><div _ngcontent-uqi-c106="" class="highlight-div-header"><div _ngcontent-uqi-c106="" class="highlight-div-header-left"><div _ngcontent-uqi-c106="" class="handle-button expand-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqi-c106="" class="highlight-div-header-right"><div _ngcontent-uqi-c106="" class="handle-button ai-button"></div><div _ngcontent-uqi-c106="" class="handle-button line-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqi-c106="" class="handle-button theme-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqi-c106="" class="handle-button copy-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqi-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">[</span> </li><li>    <span class="hljs-punctuation">{</span> </li><li>        <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ReduceMaxCustom"</span><span class="hljs-punctuation">,</span> </li><li>         <span class="hljs-attr">"input_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ND"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"float16"</span><span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"output_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"y"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ND"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"float16"</span><span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"idx"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ND"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"int32"</span><span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"attr"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                                                                    </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"reduceDim"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"int"</span> </li><li>            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"isKeepDim"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"optional"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"int"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"default_value"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span> </li><li>    <span class="hljs-punctuation">}</span> </li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div> <p></p></li><li><span>使用msOpGen工具生成算子的开发工程。以生成AddCustom的算子工程为例，下文仅针对关键参数进行解释，详细参数说明请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-creating-operator-project-msopgen">算子工程创建工具参数说明</a>。</span><p></p><div _ngcontent-uqi-c106="" class="highlight-div"><div _ngcontent-uqi-c106="" class="highlight-div-header"><div _ngcontent-uqi-c106="" class="highlight-div-header-left"><div _ngcontent-uqi-c106="" class="handle-button expand-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqi-c106="" class="highlight-div-header-right"><div _ngcontent-uqi-c106="" class="handle-button ai-button"></div><div _ngcontent-uqi-c106="" class="handle-button line-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqi-c106="" class="handle-button theme-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqi-c106="" class="handle-button copy-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqi-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>msopgen gen -i<strong> .</strong>/add_custom.json -c ai_core-kirin9020 -f ONNX -out ./AddCustom</li></ol></pre></div></div> <ul><li>-i：指定算子原型定义文件<em>add_custom</em>.json所在路径，请根据实际情况修改。</li><li>-c：ai_core-<em>&lt;soc_version&gt;</em>代表算子在AI Core上执行，<em>&lt;soc_version&gt;</em>为AI处理器的型号，当前支持ai_core-kirin9020。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>AI处理器的型号<em>&lt;soc_version&gt;</em>请在运行环境上通过命令行获取：</p> <p>hdc -t {target} shell param get ohos.boot.chiptype</p> <p>target：设备的SN码，可以通过hdc list targets获取当前环境上所有设备的SN码。</p> </div></div></div> <ul><li>-f：第三方算子平台, 目前支持TF、ONNX</li><li>-out：生成文件所在路径，可配置为绝对路径或者相对路径，并且工具执行开发者对路径具有可读写权限。若不配置，则默认生成在执行命令的当前路径。</li></ul> <p></p></li><li><span>命令执行完后，会在-out指定目录或者默认路径下生成算子工程目录，工程中包含算子实现的模板文件，编译脚本等，以AddCustom算子为例，目录结构如下所示：</span><p></p><div _ngcontent-uqi-c106="" class="highlight-div"><div _ngcontent-uqi-c106="" class="highlight-div-header"><div _ngcontent-uqi-c106="" class="highlight-div-header-left"><div _ngcontent-uqi-c106="" class="handle-button expand-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqi-c106="" class="highlight-div-header-right"><div _ngcontent-uqi-c106="" class="handle-button ai-button"></div><div _ngcontent-uqi-c106="" class="handle-button line-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqi-c106="" class="handle-button theme-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqi-c106="" class="handle-button copy-button"><div _ngcontent-uqi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqi-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>AddCustom</li><li>├── build_devices.sh    // 编译kernel动态库入口脚本</li><li>├── build.sh            // 编译入口脚本 </li><li>├── cmake  </li><li>│   ├── config.cmake </li><li>│   ├── func.cmake </li><li>│   ├── intf.cmake </li><li>│   ├── makeself.cmake </li><li>│   └── util           // 算子工程编译所需脚本及公共编译文件存放目录 </li><li>├── CMakeLists.txt     // 算子工程的CMakeLists.txt </li><li>├── <strong>CMakePresets.json</strong>  // 编译配置项 </li><li>├── framework          // 算子插件实现文件目录，单算子模型文件的生成不依赖算子适配插件，无需关注 </li><li>├── op_host                    // host侧实现文件 </li><li>│   ├── add_custom_tiling.h<strong>    </strong>// 算子tiling定义文件 </li><li>│   ├── add_custom.cpp<strong>         </strong>// 算子原型注册、shape推导、信息库、tiling实现等内容文件 </li><li>│   ├── CMakeLists.txt </li><li>├── op_kernel                  // kernel侧实现文件 </li><li>│   ├── CMakeLists.txt    </li><li>│   ├── add_custom.cpp         // 算子代码实现文件  </li><li>└── scripts                    // 自定义算子工程打包相关脚本所在目录</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述目录结构中的粗体文件为后续算子开发过程中需要修改的文件，其他文件无需修改。</p> </div></div></div> <p></p></li></ol> <p>工程目录中的op_kernel和op_host包含了算子的核心实现文件。op_kernel下存放<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-implementation-on-the">Kernel侧算子实现</a>。op_host下存放host侧代码实现，包括<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-prototype-definition">算子原型定义实现</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tiling-implementation-on-the-host">Host侧Tiling实现</a>。其中kernel侧算子实现和host侧tiling实现在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-implementation-overview">算子实现</a>章节已经介绍了其核心的实现方法，在该章节会侧重于介绍接入DDK框架后的编程模式和API的使用。工程目录中的CMakePresets.json，用于开发者完成工程编译相关配置，之后即可进行编译部署。</p> </div> <div></div></div>