<h1 _ngcontent-yrh-c119="" class="doc-title ng-star-inserted" title="创建视频解码器和NativeWindow初始化并行"> 创建视频解码器和NativeWindow初始化并行 </h1>

<div _ngcontent-yrh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>为了解码Surface模式的正常创建，在XComponent尚未创建或OpenGL后处理（NativeImage）尚未初始化的情况下，可以创建一个空的surface，以确保视频解码器能够正常创建和运行。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>以下步骤描述了在surface的消费端没有创建之前，如何并行创建视频解码器和NativeWindow，让视频解码器正常创建执行。</p>     <p><strong>添加动态链接库</strong></p>     <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_image.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_window.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_buffer.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_image/native_image.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_window/external_window.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p>创建OH_NativeImage实例。</p>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建NativeImage实例，作为surface的消费者。</span></li><li>OH_NativeImage* image = <span class="hljs-built_in">OH_ConsumerSurface_Create</span>();</li></ol></pre></div></div></li>      <li>       <p>获取对应的数据生产者端NativeWindow。</p>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取生产者NativeWindow。</span></li><li>OHNativeWindow* nativeImageWindow = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(image);</li></ol></pre></div></div></li>      <li>       <p>设置NativeWindow的宽高。</p>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> code = SET_BUFFER_GEOMETRY;</li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">800</span>;</li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">600</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeWindow_NativeWindowHandleOpt</span>(nativeImageWindow, code, width, height);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>注册NativeImage的回调函数。</p>       <p>注册OH_NativeImage的监听者OH_OnFrameAvailableListener，包括：</p>       <ul>        <li>context 用户自定义的上下文信息；</li>        <li>onFrameAvailable 有buffer可获取触发时的回调函数。</li>       </ul>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// onFrameAvailable实现。</span></li><li><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFrameAvailable</span>()</span></li><li>{</li><li>  OHNativeWindowBuffer *buffer = nullptr;</li><li>  <span class="hljs-built_in">int</span> fenceFd;</li><li>  <span class="hljs-comment">// 通过消费端的OH_NativeImage获取一个OHNativeWindowBuffer。</span></li><li>  OH_NativeImage_AcquireNativeWindowBuffer(image, &amp;buffer, &amp;fenceFd);</li><li>  <span class="hljs-comment">// 通过OH_NativeImage实例将OHNativeWindowBuffer归还到buffer队列中。</span></li><li>  OH_NativeImage_ReleaseNativeWindowBuffer(image, buffer, fenceFd);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">context</span>()</span></li><li>{</li><li>  <span class="hljs-comment">// 开发者自定义的上下文信息。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置回调监听者。</span></li><li>OH_OnFrameAvailableListener listener = {&amp;onFrameAvailable, &amp;context};</li><li><span class="hljs-comment">// 设置帧可用回调。</span></li><li>ret = OH_NativeImage_SetOnFrameAvailableListener(image, listener);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>在此示例中，回调函数的实现仅仅是将buffer取出来并释放，开发者可以根据业务需求自行拓展。</p>        </div></div></div></li>      <li>       <p>配置解码器。</p>       <p>具体开发指导请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">视频解码Surface模式</a>“步骤-5：调用OH_VideoDecoder_Configure()配置解码器”。</p></li>      <li>       <p>设置surface。</p>       <p>在应用业务真正的surface消费端创建成功之前，可以先使用上面临时创建的消费端连接解码器。</p>       <p>示例中的变量说明如下：</p>       <ul>        <li>videoDec：视频解码器实例的指针。创建方式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">视频解码Surface模式</a>“步骤-2：创建解码器实例对象”。</li>       </ul>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li>ret = OH_VideoDecoder_SetSurface(videoDec, nativeImageWindow);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>启动解码器。</p>       <p>具体开发指导请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">视频解码Surface模式</a>“步骤-8：调用OH_VideoDecoder_Start()启动解码器”。</p></li>      <li>       <p>设置surface。</p>       <p>在应用业务真正的surface消费端创建成功后，可以调用OH_VideoDecoder_SetSurface接口，将解码输出重定向到新的surface上。</p>       <p>本例中的nativeWindow，有两种方式获取：</p>       <ol>        <li>如果解码后直接显示，则从XComponent组件获取，获取方式请参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>；</li>        <li>如果解码后接OpenGL后处理，则从NativeImage获取，获取方式请参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-image-guidelines">NativeImage</a>。</li>       </ol>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li>ret = OH_VideoDecoder_SetSurface(videoDec, nativeWindow);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁OH_NativeImage实例。</p>       <p>在调用OH_VideoDecoder_Destroy接口后，调用OH_NativeImage_Destroy接口销毁OH_NativeImage实例。</p>       <div _ngcontent-yrh-c106="" class="highlight-div"><div _ngcontent-yrh-c106="" class="highlight-div-header"><div _ngcontent-yrh-c106="" class="highlight-div-header-left"><div _ngcontent-yrh-c106="" class="handle-button expand-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yrh-c106="" class="highlight-div-header-right"><div _ngcontent-yrh-c106="" class="handle-button ai-button"></div><div _ngcontent-yrh-c106="" class="handle-button line-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yrh-c106="" class="handle-button theme-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yrh-c106="" class="handle-button copy-button"><div _ngcontent-yrh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yrh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁OH_NativeImage实例。</span></li><li><span class="hljs-built_in">OH_NativeImage_Destroy</span>(&amp;image);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>