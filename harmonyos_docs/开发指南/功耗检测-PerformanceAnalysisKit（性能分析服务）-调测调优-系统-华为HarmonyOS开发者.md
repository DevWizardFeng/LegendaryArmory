<h1 _ngcontent-whp-c119="" class="doc-title ng-star-inserted" title="功耗检测"> 功耗检测 </h1>

<div _ngcontent-whp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section0908833171614">简介<i class="anchor-icon anchor-icon-link" anchorid="section0908833171614" tips="复制节点链接"></i></h2><p>功耗检测主要提供CPU高负载检测，可以通过订阅相关事件实现检测。</p> <p>如需了解如何使用HiAppEvent提供订阅CPU高负载事件，请参考以下文档。目前仅提供ArkTS接口。</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-cpu-usage-high-arkts" target="_blank">订阅CPU高负载事件（ArkTS）</a></li></ul> </div> <div class="tiledSection"><h2 id="section17333081156">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section17333081156" tips="复制节点链接"></i></h2><p>系统会周期性及在特定条件（如前后台切换）下，采集三方应用在CPU上的运行时间，并每5分钟统计一次前5分钟的平均负载。若负载超过设定门限，将触发HiAppEvent预警事件。</p> <p>应用触发CPU高负载事件，其中负载是根据CPU核数归一化后的运行时间。例如：在5分钟内，应用进程在10核CPU上运行了5分钟，其平均负载为：5（CPU上运行时间） /  5（统计周期分钟）/ 10（核数） = 10%。</p> <p>CPU高负载事件存在以下场景：</p> <p>1. 应用在前台时触发CPU高负载事件：5分钟内平均负载大于30%。</p> <p>2. 应用在后台时触发CPU高负载事件：5分钟内平均负载大于10%。</p> <p>3. 应用线程高负载异常事件：单线程1分钟内平均负载大于70%。</p> </div> <div class="tiledSection"><h2 id="section5832932213">约束和限制<i class="anchor-icon anchor-icon-link" anchorid="section5832932213" tips="复制节点链接"></i></h2><p>触发CPU高负载异常的阈值为系统默认，不支持单应用定制。</p> <p>每个高负载场景每天只能抓取一次trace。如果开发者有重复抓取需求，可以尝试重启测试设备重新抓取。</p> </div> <div class="tiledSection"><h2 id="section1471964462613">日志规格<i class="anchor-icon anchor-icon-link" anchorid="section1471964462613" tips="复制节点链接"></i></h2><p>在订阅事件开发步骤的最后一步中，获取到系统事件数据的处理日志后（详细流程见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-cpu-usage-high-arkts" target="_blank">订阅CPU高负载事件（ArkTS）</a>），可通过查找日志中“external_log”记录的故障日志文件路径，得到故障日志。例如：</p> <div _ngcontent-whp-c106="" class="highlight-div"><div _ngcontent-whp-c106="" class="highlight-div-header"><div _ngcontent-whp-c106="" class="highlight-div-header-left"><div _ngcontent-whp-c106="" class="handle-button expand-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-whp-c106="" class="highlight-div-header-right"><div _ngcontent-whp-c106="" class="handle-button ai-button"></div><div _ngcontent-whp-c106="" class="handle-button line-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-whp-c106="" class="handle-button theme-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-whp-c106="" class="handle-button copy-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-whp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>&lt;<span class="hljs-title class_">HiAppEvent</span>&gt; <span class="hljs-variable">eventInfo</span>={<span class="hljs-string">"domain"</span>:<span class="hljs-string">"OS"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"CPU_USAGE_HIGH"</span>,<span class="hljs-string">"eventType"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"begin_time"</span>:<span class="hljs-number">1749128563568</span>,<span class="hljs-string">"bundle_name"</span>:<span class="hljs-string">"com.example.powerdemon"</span>,<span class="hljs-string">"bundle_version"</span>:<span class="hljs-string">"1.0.0"</span>,<span class="hljs-string">"end_time"</span>:<span class="hljs-number">1749128863573</span>,<span class="hljs-string">"external_log"</span>:[<span class="hljs-string">"/data/storage/el2/log/hiappevent/CPU_USAGE_HIGH_1749128939012_0.log"</span>,<span class="hljs-string">"/data/storage/el2/log/hiappevent/CPU_USAGE_HIGH_1749128939015_0.log"</span>],<span class="hljs-string">"fault_type"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"foreground"</span>:<span class="hljs-keyword">true</span>,<span class="hljs-string">"log_over_limit"</span>:<span class="hljs-keyword">false</span>,<span class="hljs-string">"threads"</span>:[{<span class="hljs-string">"name"</span>:<span class="hljs-string">"WorkerThread"</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">20743</span>,<span class="hljs-string">"usage"</span>:<span class="hljs-number">8.30084</span>},{<span class="hljs-string">"name"</span>:<span class="hljs-string">"WorkerThread"</span>,<span class="hljs-string">"tid"</span>:<span class="hljs-number">20741</span>,<span class="hljs-string">"usage"</span>:<span class="hljs-number">8.29501</span>}</li></ol></pre></div></div> <p>external_log下记录故障日志的路径，在路径下可获取到故障日志。</p> <p></p> <p>对于前后台场景触发CPU高负载事件，故障日志格式如下所示：</p> <div _ngcontent-whp-c106="" class="highlight-div"><div _ngcontent-whp-c106="" class="highlight-div-header"><div _ngcontent-whp-c106="" class="highlight-div-header-left"><div _ngcontent-whp-c106="" class="handle-button expand-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-whp-c106="" class="highlight-div-header-right"><div _ngcontent-whp-c106="" class="handle-button ai-button"></div><div _ngcontent-whp-c106="" class="handle-button line-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-whp-c106="" class="handle-button theme-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-whp-c106="" class="handle-button copy-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-whp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Result</span>: <span class="hljs-number">0</span> ( <span class="hljs-title class_">no</span> <span class="hljs-title class_">error</span> )</li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">2025</span>-<span class="hljs-number">06</span>-<span class="hljs-number">05</span> <span class="hljs-number">21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">54.000</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">57531</span>         &lt;- <span class="hljs-title class_">进程号</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020188</span>      &lt;- <span class="hljs-title class_">线程号</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">powerdemon</span>       &lt;- <span class="hljs-title class_">进程名</span></li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">57531</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">mple</span>.<span class="hljs-title class_">powerdemon</span>           &lt;- <span class="hljs-title class_">线程名</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000156</span><span class="hljs-variable">a74</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">epoll_wait</span>+<span class="hljs-number">80</span>)(<span class="hljs-variable">f77c0346c0084ebbadf721ea319f5f77</span>)      &lt;- <span class="hljs-variable">报错堆栈信息</span></li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000192</span><span class="hljs-variable">bc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EpollIoWaiter</span>::<span class="hljs-title class_">WaitFor</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">mutex</span>&gt;&amp;, <span class="hljs-title class_">long</span>)+<span class="hljs-number">232</span>)(<span class="hljs-number">4</span><span class="hljs-variable">f4eb5c696148d35cce6d2e07f75f1ea</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000021660</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventQueue</span>::<span class="hljs-title class_">WaitUntilLocked</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">time_point</span>&lt;<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">steady_clock</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">duration</span>&lt;<span class="hljs-title class_">long</span> <span class="hljs-title class_">long</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">ratio</span>&lt;<span class="hljs-number">1</span><span class="hljs-title class_">l</span>, <span class="hljs-number">1000000000</span><span class="hljs-title class_">l</span>&gt;&gt;&gt; <span class="hljs-keyword">const</span>&amp;, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">mutex</span>&gt;&amp;)+<span class="hljs-number">140</span>)(<span class="hljs-number">4</span><span class="hljs-variable">f4eb5c696148d35cce6d2e07f75f1ea</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000022</span><span class="hljs-variable">fdc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventQueueBase</span>::<span class="hljs-title class_">GetEvent</span>()+<span class="hljs-number">216</span>)(<span class="hljs-number">4</span><span class="hljs-variable">f4eb5c696148d35cce6d2e07f75f1ea</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002</span><span class="hljs-variable">cf60</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-title class_">EventRunnerImpl</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">928</span>)(<span class="hljs-number">4</span><span class="hljs-variable">f4eb5c696148d35cce6d2e07f75f1ea</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000302</span><span class="hljs-variable">f0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventRunner</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">528</span>)(<span class="hljs-number">4</span><span class="hljs-variable">f4eb5c696148d35cce6d2e07f75f1ea</span>)</li></ol></pre></div></div> <p></p> <p>对于线程高负载异常事件，故障日志为解析后的混合栈信息，包含native帧和JS帧。</p> <p>native帧格式如下：</p> <div _ngcontent-whp-c106="" class="highlight-div"><div _ngcontent-whp-c106="" class="highlight-div-header"><div _ngcontent-whp-c106="" class="highlight-div-header-left"><div _ngcontent-whp-c106="" class="handle-button expand-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-whp-c106="" class="highlight-div-header-right"><div _ngcontent-whp-c106="" class="handle-button ai-button"></div><div _ngcontent-whp-c106="" class="handle-button line-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-whp-c106="" class="handle-button theme-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-whp-c106="" class="handle-button copy-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-whp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">59</span> <span class="hljs-selector-id">#07</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000015</span><span class="hljs-selector-tag">adc</span> /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">module</span>/<span class="hljs-selector-tag">libworker</span><span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(<span class="hljs-number">74</span>be9232848e55d7c5da62a978ef624b)</li><li><span class="hljs-number">59</span> <span class="hljs-selector-id">#08</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000007</span><span class="hljs-selector-tag">dd38</span> /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">platformsdk</span>/<span class="hljs-selector-tag">libace_napi</span><span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(napi_call_function+<span class="hljs-number">216</span>)(<span class="hljs-number">7</span>d9559571526f9f5efb838da8f2ea2ac)</li><li><span class="hljs-number">59</span> <span class="hljs-selector-id">#09</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000003</span><span class="hljs-selector-tag">b10f0</span> /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">platformsdk</span>/<span class="hljs-selector-tag">libark_jsruntime</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">FunctionRef</span>::<span class="hljs-built_in">CallForNapi</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaVM const*, <span class="hljs-attribute">panda</span>::JSValueRef*, <span class="hljs-attribute">panda</span>::JSValueRef* const*, int)+<span class="hljs-number">564</span>)(<span class="hljs-number">81</span>e7710dc27ae7c5f6000ede7e911f20)</li><li>...</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.1" valign="top" width="16.666666666666664%"><p>采样到此帧的次数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.2" valign="top" width="16.666666666666664%"><p>帧的调用层级，行缩进大小与该层级对应</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.3" valign="top" width="16.666666666666664%"><p>native帧PC值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.4" valign="top" width="16.666666666666664%"><p>被调用的文件路径</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.5" valign="top" width="16.666666666666664%"><p>被调用的函数名及该函数的代码行偏移</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.12.1.7.1.6" valign="top" width="16.666666666666664%"><p>so文件md5值</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.666666666666664%"><p>59</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>#09</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>00000000003b10f0</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>/system/lib64/platformsdk/libark_jsruntime.so</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>panda::FunctionRef::CallForNapi(panda::ecmascript::EcmaVM const*, panda::JSValueRef*, panda::JSValueRef* const*, int)+564</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>81e7710dc27ae7c5f6000ede7e911f20</p> </td> </tr>  </tbody></table></div> </div> <p>JS帧格式如下：</p> <div _ngcontent-whp-c106="" class="highlight-div"><div _ngcontent-whp-c106="" class="highlight-div-header"><div _ngcontent-whp-c106="" class="highlight-div-header-left"><div _ngcontent-whp-c106="" class="handle-button expand-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-whp-c106="" class="highlight-div-header-right"><div _ngcontent-whp-c106="" class="handle-button ai-button"></div><div _ngcontent-whp-c106="" class="handle-button line-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-whp-c106="" class="handle-button theme-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-whp-c106="" class="handle-button copy-button"><div _ngcontent-whp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-whp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">59</span> <span class="hljs-selector-id">#11</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">anonymous</span> (entry/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/entry/src/main/ets/workers/Worker.<span class="hljs-attribute">ts</span>:<span class="hljs-number">12</span>:<span class="hljs-number">12</span>)</li><li><span class="hljs-number">59</span> <span class="hljs-selector-id">#12</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">eatCpu</span> (entry/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/entry/src/main/ets/workers/Worker.<span class="hljs-attribute">ts</span>:<span class="hljs-number">26</span>:<span class="hljs-number">26</span>)</li><li>...</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.15.1.5.1.1" valign="top" width="25%"><p>采样到此帧的次数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.15.1.5.1.2" valign="top" width="25%"><p>帧的调用层级，行缩进大小与该层级对应</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.15.1.5.1.3" valign="top" width="25%"><p>被调用函数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.15.1.5.1.4" valign="top" width="25%"><p>被调用函数所在的文件路径及该函数的行列号</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>59</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>#11</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>anonymous</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>entry/build/default/cache/default/default@CompileArkTS/esmodule/release/entry/src/main/ets/workers/Worker.ts:12:12</p> </td> </tr>  </tbody></table></div> </div> </div> </div> <div></div></div>