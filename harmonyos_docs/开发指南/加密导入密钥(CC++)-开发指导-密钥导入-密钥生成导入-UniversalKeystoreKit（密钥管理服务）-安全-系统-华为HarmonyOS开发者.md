<h1 _ngcontent-vio-c119="" class="doc-title ng-star-inserted" title="加密导入密钥(C/C++)"> 加密导入密钥(C/C++) </h1>

<div _ngcontent-vio-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>以加密导入ECDH密钥对为例，涉及业务侧加密密钥的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-agreement-overview">协商</a>等操作不在本示例中体现。</p>    <p>具体的场景介绍及支持的算法规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview#支持的算法">密钥导入支持的算法</a>。</p>    <div class="tiledSection">     <h2 id="在cmake脚本中链接相关动态库">在CMake脚本中链接相关动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接相关动态库" tips="复制节点链接"></i></h2>          <div _ngcontent-vio-c106="" class="highlight-div"><div _ngcontent-vio-c106="" class="highlight-div-header"><div _ngcontent-vio-c106="" class="highlight-div-header-left"><div _ngcontent-vio-c106="" class="handle-button expand-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vio-c106="" class="highlight-div-header-right"><div _ngcontent-vio-c106="" class="handle-button ai-button"></div><div _ngcontent-vio-c106="" class="handle-button line-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vio-c106="" class="handle-button theme-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vio-c106="" class="handle-button copy-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vio-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhuks_ndk.z.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>设备A（导入设备）将待导入密钥转换成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-concepts#密钥材料格式">HUKS密钥材料格式</a>To_Import_Key（仅针对非对称密钥，若待导入密钥是对称密钥则可省略此步骤）。</p></li>      <li>       <p>设备B（被导入设备）生成一个加密导入用途的、用于协商的非对称密钥对Wrapping_Key（公钥Wrapping_Pk，私钥Wrapping_Sk），其密钥用途设置为unwrap，导出Wrapping_Key的公钥材料Wrapping_Pk并保存。</p></li>      <li>       <p>设备A使用和设备B同样的算法，生成一个加密导入用途的、用于协商的非对称密钥对Caller_Key（公钥Caller_Pk，私钥Caller_Sk），导出Caller_Key的公钥材料Caller_Pk并保存。</p></li>      <li>       <p>设备A生成一个对称密钥Caller_Kek，该密钥后续将用于加密To_Import_Key。</p></li>      <li>       <p>设备A基于Caller_Key的私钥Caller_Sk和设备B Wrapping_Key的公钥Wrapping_Pk，协商出Shared_Key。</p></li>      <li>       <p>设备A使用Caller_Kek加密To_Import_Key，生成To_Import_Key_Enc。</p></li>      <li>       <p>设备A使用Shared_Key加密Caller_Kek，生成Caller_Kek_Enc。</p></li>      <li>       <p>设备A封装Caller_Pk、Caller_Kek_Enc、To_Import_Key_Enc等加密导入的密钥材料并发送给设备B，加密导入密钥材料格式见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview#加密导入密钥材料格式">加密导入密钥材料格式</a>。</p></li>      <li>       <p>设备B导入封装的加密密钥材料。</p></li>      <li>       <p>设备A、B删除用于加密导入的密钥。</p></li>     </ol>     <div _ngcontent-vio-c106="" class="highlight-div"><div _ngcontent-vio-c106="" class="highlight-div-header"><div _ngcontent-vio-c106="" class="highlight-div-header-left"><div _ngcontent-vio-c106="" class="handle-button expand-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vio-c106="" class="highlight-div-header-right"><div _ngcontent-vio-c106="" class="handle-button ai-button"></div><div _ngcontent-vio-c106="" class="handle-button line-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vio-c106="" class="handle-button theme-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vio-c106="" class="handle-button copy-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vio-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"napi/native_api.h"</span></li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">algorithm</span>&gt;</li><li>
</li><li><span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">InitParamSet</span>(</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> **<span class="hljs-variable">paramSet</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Param</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">paramCount</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_InitParamSet</span>(<span class="hljs-variable">paramSet</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_AddParams</span>(*<span class="hljs-variable">paramSet</span>, <span class="hljs-variable">params</span>, <span class="hljs-variable">paramCount</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(<span class="hljs-variable">paramSet</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_BuildParamSet</span>(<span class="hljs-variable">paramSet</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(<span class="hljs-variable">paramSet</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HksImportWrappedKeyTestParams</span> {</li><li>    <span class="hljs-comment">// server key, for real.</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">wrappingKeyAlias</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">genWrappingKeyParamSet</span>;</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">publicKeySize</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">callerKeyAlias</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">genCallerKeyParamSet</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">callerKekAlias</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">callerKek</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">importCallerKekParamSet</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">callerAgreeKeyAlias</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">agreeParamSet</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">importWrappedKeyParamSet</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">importedKeyAlias</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">importedPlainKey</span>;</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">keyMaterialLen</span>;</li><li>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">IV_SIZE</span> = <span class="hljs-number">16</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">IV</span>[<span class="hljs-variable">IV_SIZE</span>] = <span class="hljs-string">"bababababababab"</span>; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">WRAPPED_KEY_IV_SIZE</span> = <span class="hljs-number">16</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">WRAPPED_KEY_IV</span>[<span class="hljs-variable">IV_SIZE</span>] = <span class="hljs-string">"bababababababab"</span>; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">AAD_SIZE</span> = <span class="hljs-number">16</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">AAD</span>[<span class="hljs-variable">AAD_SIZE</span>] = <span class="hljs-string">"abababababababa"</span>; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">NONCE_SIZE</span> = <span class="hljs-number">12</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">NONCE</span>[<span class="hljs-variable">NONCE_SIZE</span>] = <span class="hljs-string">"hahahahahah"</span>; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">AEAD_TAG_SIZE</span> = <span class="hljs-number">16</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">X25519_256_SIZE</span> = <span class="hljs-number">256</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_wrappingKeyAliasAes256</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"test_wrappingKey_x25519_aes256"</span>),</li><li>                                                       .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"test_wrappingKey_x25519_aes256"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_callerKeyAliasAes256</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"test_caller_key_x25519_aes256"</span>),</li><li>                                                     .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"test_caller_key_x25519_aes256"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_callerKekAliasAes256</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"test_caller_kek_x25519_aes256"</span>),</li><li>                                                     .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"test_caller_kek_x25519_aes256"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_callerAes256Kek</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"This is kek to encrypt plain key"</span>),</li><li>                                                .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"This is kek to encrypt plain key"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_callerAgreeKeyAliasAes256</span> = {.<span class="hljs-variable">size</span> =</li><li>                                                              (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"test_caller_agree_key_x25519_aes256"</span>),</li><li>                                                          .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"test_caller_agree_key_x25519_aes256"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_importedKeyAliasAes256</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"test_import_key_x25519_aes256"</span>),</li><li>                                                       .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"test_import_key_x25519_aes256"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">g_importedAes256PlainKey</span> = {.<span class="hljs-variable">size</span> = (<span class="hljs-variable">uint32_t</span>)<span class="hljs-title function_">strlen</span>(<span class="hljs-string">"This is plain key to be imported"</span>),</li><li>                                                       .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-string">"This is plain key to be imported"</span>};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_importWrappedAes256Params</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_AES</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_ENCRYPT</span> | <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_DECRYPT</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_AES_KEY_SIZE_256</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PADDING</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_PADDING_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_BLOCK_MODE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_MODE_GCM</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_DIGEST</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_DIGEST_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_UNWRAP_ALGORITHM_SUITE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_UNWRAP_SUITE_X25519_AES_256_GCM_NOPADDING</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ASSOCIATED_DATA</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">AAD_SIZE</span>, .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">AAD</span>}}, <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值应与调用者信息相关。</span></li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_NONCE</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">NONCE_SIZE</span>, .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">NONCE</span>}}}; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">g_x25519PubKeySize</span> = <span class="hljs-number">32</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_genWrappingKeyParams</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_X25519</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_UNWRAP</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_CURVE25519_KEY_SIZE_256</span>}};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_genCallerX25519Params</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_X25519</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_AGREE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_CURVE25519_KEY_SIZE_256</span>}};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_importParamsCallerKek</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_AES</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_ENCRYPT</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_AES_KEY_SIZE_256</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PADDING</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_PADDING_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_BLOCK_MODE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_MODE_GCM</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_DIGEST</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_DIGEST_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_IV</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">WRAPPED_KEY_IV_SIZE</span>,</li><li>              .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">WRAPPED_KEY_IV</span>}}}; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_callerAgreeParams</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_X25519</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_AGREE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_CURVE25519_KEY_SIZE_256</span>}};</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_aesKekEncryptParams</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_AES</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_ENCRYPT</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_AES_KEY_SIZE_256</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PADDING</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_PADDING_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_BLOCK_MODE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_MODE_GCM</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_DIGEST</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_DIGEST_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ASSOCIATED_DATA</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">AAD_SIZE</span>, .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">AAD</span>}}, <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值应与调用者信息相关。</span></li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_NONCE</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">NONCE_SIZE</span>, .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">NONCE</span>}}}; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> <span class="hljs-variable">g_importAgreeKeyParams</span>[] = {</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_ALGORITHM</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_ALG_AES</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_KEY_PURPOSE_ENCRYPT</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_KEY_SIZE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_AES_KEY_SIZE_256</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_PADDING</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_PADDING_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_BLOCK_MODE</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_MODE_GCM</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_DIGEST</span>, .<span class="hljs-variable">uint32Param</span> = <span class="hljs-variable">OH_HUKS_DIGEST_NONE</span>},</li><li>    {.<span class="hljs-variable">tag</span> = <span class="hljs-variable">OH_HUKS_TAG_IV</span>,</li><li>     .<span class="hljs-variable">blob</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">IV_SIZE</span>, .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">IV</span>}}}; <span class="hljs-comment">// 此处仅为测试数据，实际使用时该值每次应该不同。</span></li><li><span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">HuksAgreeKey</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_ParamSet</span> *<span class="hljs-variable">paramSet</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">keyAlias</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">peerPublicKey</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">agreedKey</span>)</li><li>{</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">temp</span>[<span class="hljs-number">10</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">inData</span> = {<span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">temp</span>), <span class="hljs-variable">temp</span>};</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">handleU</span>[<span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint64_t</span>)] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">handle</span> = {<span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint64_t</span>), <span class="hljs-variable">handleU</span>};</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_InitSession</span>(<span class="hljs-variable">keyAlias</span>, <span class="hljs-variable">paramSet</span>, &amp;<span class="hljs-title class_">handle</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">outDataU</span>[<span class="hljs-number">1024</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">outDataUpdate</span> = {<span class="hljs-number">1024</span>, <span class="hljs-variable">outDataU</span>};</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_UpdateSession</span>(&amp;<span class="hljs-title class_">handle</span>, <span class="hljs-variable">paramSet</span>, <span class="hljs-variable">peerPublicKey</span>, &amp;<span class="hljs-title class_">outDataUpdate</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_FinishSession</span>(&amp;<span class="hljs-title class_">handle</span>, <span class="hljs-variable">paramSet</span>, &amp;<span class="hljs-title class_">inData</span>, <span class="hljs-variable">agreedKey</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">MallocAndCheckBlobData</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">blob</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">blobSize</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_SUCCESS</span>;</li><li>    <span class="hljs-variable">blob</span>-&gt;<span class="hljs-title class_">data</span> = (<span class="hljs-variable">uint8_t</span> *)<span class="hljs-title function_">malloc</span>(<span class="hljs-variable">blobSize</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">blob</span>-&gt;<span class="hljs-title class_">data</span> == <span class="hljs-variable">NULL</span>) {</li><li>        <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">TIMES</span> = <span class="hljs-number">4</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">MAX_UPDATE_SIZE</span> = <span class="hljs-number">64</span>;</li><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">MAX_OUTDATA_SIZE</span> = <span class="hljs-variable">MAX_UPDATE_SIZE</span> * <span class="hljs-variable">TIMES</span>;</li><li>#<span class="hljs-variable">define</span> <span class="hljs-title function_">HUKS_FREE_BLOB</span>(<span class="hljs-variable">blob</span>)                                                                                           \</li><li>    <span class="hljs-keyword">do</span> {                                                                                                               \</li><li>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">blob</span>).<span class="hljs-variable">data</span> != <span class="hljs-variable">nullptr</span>) {                                                                                  \</li><li>            <span class="hljs-title function_">free</span>((<span class="hljs-variable">blob</span>).<span class="hljs-variable">data</span>);                                                                                         \</li><li>            (<span class="hljs-variable">blob</span>).<span class="hljs-variable">data</span> = <span class="hljs-variable">nullptr</span>;                                                                                     \</li><li>        }                                                                                                              \</li><li>        (<span class="hljs-variable">blob</span>).<span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;                                                                                               \</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)</li><li>#<span class="hljs-variable">define</span> <span class="hljs-title function_">OH_HUKS_KEY_BYTES</span>(<span class="hljs-variable">keySize</span>) (((<span class="hljs-variable">keySize</span>) + <span class="hljs-number">7</span>) / <span class="hljs-number">8</span>)</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">HksEncryptLoopUpdate</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">handle</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_ParamSet</span> *<span class="hljs-variable">paramSet</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">inData</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">outData</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_SUCCESS</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">inDataSeg</span> = *<span class="hljs-variable">inData</span>;</li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">lastPtr</span> = <span class="hljs-variable">inData</span>-&gt;<span class="hljs-title class_">data</span> + <span class="hljs-title class_">inData</span>-&gt;<span class="hljs-title class_">size</span> - <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">outDataSeg</span> = {<span class="hljs-variable">MAX_OUTDATA_SIZE</span>, <span class="hljs-variable">NULL</span>};</li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">cur</span> = <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">data</span>;</li><li>    <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">MAX_UPDATE_SIZE</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">isFinished</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">data</span> &lt;= <span class="hljs-title class_">lastPtr</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">data</span> + <span class="hljs-variable">MAX_UPDATE_SIZE</span> &lt;= <span class="hljs-title class_">lastPtr</span>) {</li><li>            <span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">MAX_OUTDATA_SIZE</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">isFinished</span> = <span class="hljs-keyword">true</span>;</li><li>            <span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">lastPtr</span> - <span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">data</span> + <span class="hljs-number">1</span>;</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">MallocAndCheckBlobData</span>(&amp;<span class="hljs-title class_">outDataSeg</span>, <span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">size</span>).<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_UpdateSession</span>(<span class="hljs-variable">handle</span>, <span class="hljs-variable">paramSet</span>, &amp;<span class="hljs-title class_">inDataSeg</span>, &amp;<span class="hljs-title class_">outDataSeg</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-title function_">free</span>(<span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">data</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-title class_">outDataSeg</span>.<span class="hljs-title class_">data</span>, <span class="hljs-title class_">outDataSeg</span>.<span class="hljs-variable">data</span> <span class="hljs-variable">+ outDataSeg</span>.<span class="hljs-title class_">size</span>, <span class="hljs-title class_">cur</span>);</li><li>        <span class="hljs-variable">cur</span> += <span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">size</span>;</li><li>        <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">size</span> += <span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">size</span>;</li><li>        <span class="hljs-title function_">free</span>(<span class="hljs-variable">outDataSeg</span>.<span class="hljs-variable">data</span>);</li><li>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">isFinished</span> == <span class="hljs-keyword">false</span>) &amp;&amp; (<span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">data</span> + <span class="hljs-variable">MAX_UPDATE_SIZE</span> &gt; <span class="hljs-variable">lastPtr</span>)) {</li><li>            <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>        <span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">data</span> += <span class="hljs-variable">MAX_UPDATE_SIZE</span>;</li><li>    }</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">outDataFinish</span> = {<span class="hljs-variable">inDataSeg</span>.<span class="hljs-variable">size</span> * <span class="hljs-variable">TIMES</span>, <span class="hljs-variable">NULL</span>};</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">MallocAndCheckBlobData</span>(&amp;<span class="hljs-title class_">outDataFinish</span>, <span class="hljs-variable">outDataFinish</span>.<span class="hljs-variable">size</span>).<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_FinishSession</span>(<span class="hljs-variable">handle</span>, <span class="hljs-variable">paramSet</span>, &amp;<span class="hljs-title class_">inDataSeg</span>, &amp;<span class="hljs-title class_">outDataFinish</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">free</span>(<span class="hljs-variable">outDataFinish</span>.<span class="hljs-variable">data</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-title class_">outDataFinish</span>.<span class="hljs-title class_">data</span>, <span class="hljs-title class_">outDataFinish</span>.<span class="hljs-variable">data</span> <span class="hljs-variable">+ outDataFinish</span>.<span class="hljs-title class_">size</span>, <span class="hljs-title class_">cur</span>);</li><li>    <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">size</span> += <span class="hljs-variable">outDataFinish</span>.<span class="hljs-variable">size</span>;</li><li>    <span class="hljs-title function_">free</span>(<span class="hljs-variable">outDataFinish</span>.<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">HuksEncrypt</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">key</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_ParamSet</span> *<span class="hljs-variable">paramSet</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">plainText</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">cipherText</span>)</li><li>{</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">handle</span>[<span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint64_t</span>)] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">handleBlob</span> = {<span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint64_t</span>), <span class="hljs-variable">handle</span>};</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_InitSession</span>(<span class="hljs-variable">key</span>, <span class="hljs-variable">paramSet</span>, &amp;<span class="hljs-title class_">handleBlob</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">HksEncryptLoopUpdate</span>(&amp;<span class="hljs-title class_">handleBlob</span>, <span class="hljs-variable">paramSet</span>, <span class="hljs-variable">plainText</span>, <span class="hljs-variable">cipherText</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">BuildWrappedKeyData</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> **<span class="hljs-variable">blobArray</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">size</span>, <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">outData</span>)</li><li>{</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">totalLength</span> = <span class="hljs-variable">size</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint32_t</span>);</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_SUCCESS</span>;</li><li>    <span class="hljs-comment">/* 计算大小 */</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">size</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-variable">totalLength</span> += <span class="hljs-variable">blobArray</span>[<span class="hljs-variable">i</span>]-&gt;<span class="hljs-title class_">size</span>;</li><li>    }</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">outBlob</span> = {<span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">outBlob</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">totalLength</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">MallocAndCheckBlobData</span>(&amp;<span class="hljs-title class_">outBlob</span>, <span class="hljs-variable">outBlob</span>.<span class="hljs-variable">size</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">/* 拷贝数据 */</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">size</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">totalLength</span> - <span class="hljs-variable">offset</span> &gt;= <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">blobArray</span>[<span class="hljs-variable">i</span>]-&gt;<span class="hljs-title class_">size</span>)) {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">uint8_t</span> *&gt;(&amp;<span class="hljs-title class_">blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-title class_">size</span>),</li><li>                      <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">uint8_t</span> *&gt;(&amp;<span class="hljs-title class_">blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-title class_">size</span>) <span class="hljs-variable">+ sizeof</span>(<span class="hljs-title class_">blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-title class_">size</span>),</li><li>                      <span class="hljs-title class_">outBlob</span>.<span class="hljs-variable">data</span> <span class="hljs-variable">+ offset</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>        <span class="hljs-variable">offset</span> += <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">blobArray</span>[<span class="hljs-variable">i</span>]-&gt;<span class="hljs-title class_">size</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">totalLength</span> - <span class="hljs-variable">offset</span> &gt;= <span class="hljs-variable">blobArray</span>[<span class="hljs-variable">i</span>]-&gt;<span class="hljs-title class_">size</span>) {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-title class_">blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-title class_">data</span>, <span class="hljs-title class_">blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-variable">data</span> <span class="hljs-variable">+ blobArray</span>[<span class="hljs-title class_">i</span>]-&gt;<span class="hljs-title class_">size</span>, <span class="hljs-title class_">outBlob</span>.<span class="hljs-variable">data</span> <span class="hljs-variable">+ offset</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_INTERNAL_ERROR</span>;</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>        <span class="hljs-variable">offset</span> += <span class="hljs-variable">blobArray</span>[<span class="hljs-variable">i</span>]-&gt;<span class="hljs-title class_">size</span>;</li><li>    }</li><li>    <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">size</span> = <span class="hljs-variable">outBlob</span>.<span class="hljs-variable">size</span>;</li><li>    <span class="hljs-variable">outData</span>-&gt;<span class="hljs-title class_">data</span> = <span class="hljs-variable">outBlob</span>.<span class="hljs-variable">data</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">CheckParamsValid</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_SUCCESS</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">params</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_ILLEGAL_ARGUMENT</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">wrappingKeyAlias</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">genWrappingKeyParamSet</span> == <span class="hljs-variable">nullptr</span> ||</li><li>        <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKeyAlias</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">genCallerKeyParamSet</span> == <span class="hljs-variable">nullptr</span> ||</li><li>        <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKekAlias</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKek</span> == <span class="hljs-variable">nullptr</span> ||</li><li>        <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importCallerKekParamSet</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerAgreeKeyAlias</span> == <span class="hljs-variable">nullptr</span> ||</li><li>        <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">agreeParamSet</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importWrappedKeyParamSet</span> == <span class="hljs-variable">nullptr</span> ||</li><li>        <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importedKeyAlias</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importedPlainKey</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> = <span class="hljs-variable">OH_HUKS_ERR_CODE_ILLEGAL_ARGUMENT</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">GenerateAndExportHuksPublicKey</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">huksPublicKey</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_GenerateKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">wrappingKeyAlias</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">genWrappingKeyParamSet</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">huksPublicKey</span>-&gt;<span class="hljs-title class_">size</span> = <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">publicKeySize</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">MallocAndCheckBlobData</span>(<span class="hljs-variable">huksPublicKey</span>, <span class="hljs-variable">huksPublicKey</span>-&gt;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_ExportPublicKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">wrappingKeyAlias</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">huksPublicKey</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">GenerateAndExportCallerPublicKey</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">callerSelfPublicKey</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_GenerateKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKeyAlias</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">genCallerKeyParamSet</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">callerSelfPublicKey</span>-&gt;<span class="hljs-title class_">size</span> = <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">publicKeySize</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">MallocAndCheckBlobData</span>(<span class="hljs-variable">callerSelfPublicKey</span>, <span class="hljs-variable">callerSelfPublicKey</span>-&gt;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_ExportPublicKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKeyAlias</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">genWrappingKeyParamSet</span>, <span class="hljs-variable">callerSelfPublicKey</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">ImportKekAndAgreeSharedSecret</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Blob</span> *<span class="hljs-variable">huksPublicKey</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">outSharedKey</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> =</li><li>        <span class="hljs-title function_">OH_Huks_ImportKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKekAlias</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importCallerKekParamSet</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKek</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">MallocAndCheckBlobData</span>(<span class="hljs-variable">outSharedKey</span>, <span class="hljs-variable">outSharedKey</span>-&gt;<span class="hljs-title class_">size</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">HuksAgreeKey</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">agreeParamSet</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKeyAlias</span>, <span class="hljs-variable">huksPublicKey</span>, <span class="hljs-variable">outSharedKey</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">importAgreeKeyParams</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">importAgreeKeyParams</span>, <span class="hljs-variable">g_importAgreeKeyParams</span>,</li><li>                       <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_importAgreeKeyParams</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_ImportKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerAgreeKeyAlias</span>, <span class="hljs-variable">importAgreeKeyParams</span>, <span class="hljs-variable">outSharedKey</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">importAgreeKeyParams</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">EncryptImportedPlainKeyAndKek</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">plainCipherText</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">kekCipherText</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">encryptParamSet</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> =</li><li>        <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">encryptParamSet</span>, <span class="hljs-variable">g_aesKekEncryptParams</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_aesKekEncryptParams</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">HuksEncrypt</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKekAlias</span>, <span class="hljs-variable">encryptParamSet</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importedPlainKey</span>, <span class="hljs-variable">plainCipherText</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">HuksEncrypt</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerAgreeKeyAlias</span>, <span class="hljs-variable">encryptParamSet</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKek</span>, <span class="hljs-variable">kekCipherText</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">encryptParamSet</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">ImportWrappedKey</span>(</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">plainCipher</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">kekCipherText</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">peerPublicKey</span>,</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">wrappedKeyData</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">commonAad</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">AAD_SIZE</span>, .<span class="hljs-variable">data</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uint8_t</span> *&gt;(<span class="hljs-variable">AAD</span>)};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">commonNonce</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">NONCE_SIZE</span>, .<span class="hljs-variable">data</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uint8_t</span> *&gt;(<span class="hljs-variable">NONCE</span>)};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">keyMaterialLen</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint32_t</span>), .<span class="hljs-variable">data</span> = (<span class="hljs-variable">uint8_t</span> *)&amp;<span class="hljs-title class_">params</span>-&gt;<span class="hljs-title class_">keyMaterialLen</span>};</li><li>    <span class="hljs-comment">/* 从密文中拷贝AEAD的tag并缩小其大小 */</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">tagSize</span> = <span class="hljs-variable">AEAD_TAG_SIZE</span>;</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">kekTagBuf</span>[<span class="hljs-variable">tagSize</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">kekTag</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">tagSize</span>, .<span class="hljs-variable">data</span> = <span class="hljs-variable">kekTagBuf</span>};</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-variable">plainCipher</span>-&gt;<span class="hljs-variable">data</span> + (<span class="hljs-variable">plainCipher</span>-&gt;<span class="hljs-variable">size</span> <span class="hljs-variable">- tagSize</span>),</li><li>              <span class="hljs-variable">plainCipher</span>-&gt;<span class="hljs-variable">data</span> + (<span class="hljs-variable">plainCipher</span>-&gt;<span class="hljs-variable">size</span> <span class="hljs-variable">- tagSize</span>) <span class="hljs-variable">+ tagSize</span>, <span class="hljs-title class_">kekTag</span>.<span class="hljs-title class_">data</span>);</li><li>    <span class="hljs-variable">plainCipher</span>-&gt;<span class="hljs-title class_">size</span> -= <span class="hljs-variable">tagSize</span>;</li><li>    <span class="hljs-comment">/* 从密钥加密密钥的密文中拷贝AEAD的tag并缩小其大小 */</span></li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">agreeKeyTagBuf</span>[<span class="hljs-variable">tagSize</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">agreeKeyTag</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-variable">tagSize</span>, .<span class="hljs-variable">data</span> = <span class="hljs-variable">agreeKeyTagBuf</span>};</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">copy</span>(<span class="hljs-variable">kekCipherText</span>-&gt;<span class="hljs-variable">data</span> + (<span class="hljs-variable">kekCipherText</span>-&gt;<span class="hljs-variable">size</span> <span class="hljs-variable">- tagSize</span>),</li><li>              <span class="hljs-variable">kekCipherText</span>-&gt;<span class="hljs-variable">data</span> + (<span class="hljs-variable">kekCipherText</span>-&gt;<span class="hljs-variable">size</span> <span class="hljs-variable">- tagSize</span>) <span class="hljs-variable">+ tagSize</span>, <span class="hljs-title class_">agreeKeyTagBuf</span>);</li><li>    <span class="hljs-variable">kekCipherText</span>-&gt;<span class="hljs-title class_">size</span> -= <span class="hljs-variable">tagSize</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> *<span class="hljs-variable">blobArray</span>[] = {<span class="hljs-variable">peerPublicKey</span>, &amp;<span class="hljs-title class_">commonAad</span>,   &amp;<span class="hljs-title class_">commonNonce</span>, &amp;<span class="hljs-title class_">agreeKeyTag</span>,    <span class="hljs-variable">kekCipherText</span>,</li><li>                                        &amp;<span class="hljs-title class_">commonAad</span>,    &amp;<span class="hljs-title class_">commonNonce</span>, &amp;<span class="hljs-title class_">kekTag</span>,      &amp;<span class="hljs-title class_">keyMaterialLen</span>, <span class="hljs-variable">plainCipher</span>};</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">BuildWrappedKeyData</span>(<span class="hljs-variable">blobArray</span>, <span class="hljs-variable">OH_HUKS_IMPORT_WRAPPED_KEY_TOTAL_BLOBS</span>, <span class="hljs-variable">wrappedKeyData</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> *<span class="hljs-variable">purpose</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_GetParam</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importWrappedKeyParamSet</span>, <span class="hljs-variable">OH_HUKS_TAG_PURPOSE</span>, &amp;<span class="hljs-title class_">purpose</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_Huks_ImportWrappedKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importedKeyAlias</span>, <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">wrappingKeyAlias</span>,</li><li>                                       <span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importWrappedKeyParamSet</span>, <span class="hljs-variable">wrappedKeyData</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">HksImportWrappedKeyTestCommonCase</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">CheckParamsValid</span>(<span class="hljs-variable">params</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>    }</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">huksPublicKey</span> = {<span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">callerSelfPublicKey</span> = {<span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">outSharedKey</span> = {.<span class="hljs-variable">size</span> = <span class="hljs-title function_">OH_HUKS_KEY_BYTES</span>(<span class="hljs-variable">OH_HUKS_AES_KEY_SIZE_256</span>), .<span class="hljs-variable">data</span> = <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">wrappedKeyData</span> = {<span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">plainKeyCipherBuffer</span>[<span class="hljs-variable">OH_HUKS_MAX_KEY_SIZE</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">plainCipherText</span> = {<span class="hljs-variable">OH_HUKS_MAX_KEY_SIZE</span>, <span class="hljs-variable">plainKeyCipherBuffer</span>};</li><li>    <span class="hljs-variable">uint8_t</span> <span class="hljs-variable">kekCipherTextBuffer</span>[<span class="hljs-variable">OH_HUKS_MAX_KEY_SIZE</span>] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> <span class="hljs-variable">kekCipherText</span> = {<span class="hljs-variable">OH_HUKS_MAX_KEY_SIZE</span>, <span class="hljs-variable">kekCipherTextBuffer</span>};</li><li>    <span class="hljs-comment">/* 模拟加密导入密钥场景，设备A为远端设备（导入设备），设备B为本端设备（被导入设备） */</span></li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">         * 1.设备A将待导入密钥转换成HUKS密钥材料格式To_Import_Key（仅针对非对称密钥，若待导入密钥是对称密钥则可省略此步骤），</span></li><li><span class="hljs-comment">         *   本示例使用g_importedAes256PlainKey（对称密钥）作为模拟</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-comment">/* 2.设备B生成一个加密导入用途的、用于协商的非对称密钥对Wrapping_Key（公钥Wrapping_Pk，私钥Wrapping_Sk），</span></li><li><span class="hljs-comment">         *   其密钥用途设置为unwrap，导出Wrapping_Key公钥Wrapping_Pk，存放在变量huksPublicKey中</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">GenerateAndExportHuksPublicKey</span>(<span class="hljs-variable">params</span>, &amp;<span class="hljs-title class_">huksPublicKey</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 3.设备A使用和设备B同样的算法，生成一个加密导入用途的、用于协商的非对称密钥对Caller_Key（公钥Caller_Pk，私钥Caller_Sk），</span></li><li><span class="hljs-comment">         * 导出Caller_Key公钥Caller_Pk，存放在变量callerSelfPublicKey中</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">GenerateAndExportCallerPublicKey</span>(<span class="hljs-variable">params</span>, &amp;<span class="hljs-title class_">callerSelfPublicKey</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">         * 4. 设备A生成一个对称密钥Caller_Kek，该密钥后续将用于加密To_Import_Key</span></li><li><span class="hljs-comment">         * 5. 设备A基于Caller_Key的私钥Caller_Sk和设备B Wrapping_Key的公钥Wrapping_Pk，协商出Shared_Key</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">ImportKekAndAgreeSharedSecret</span>(<span class="hljs-variable">params</span>, &amp;<span class="hljs-title class_">huksPublicKey</span>, &amp;<span class="hljs-title class_">outSharedKey</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">         * 6. 设备A使用Caller_Kek加密To_Import_Key，生成To_Import_Key_Enc</span></li><li><span class="hljs-comment">         * 7. 设备A使用Shared_Key加密Caller_Kek，生成Caller_Kek_Enc</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">EncryptImportedPlainKeyAndKek</span>(<span class="hljs-variable">params</span>, &amp;<span class="hljs-title class_">plainCipherText</span>, &amp;<span class="hljs-title class_">kekCipherText</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 8. 设备A封装Caller_Pk、To_Import_Key_Enc、Caller_Kek_Enc等加密导入的材料并发送给设备B。</span></li><li><span class="hljs-comment">         * 本示例作为变量存放在callerSelfPublicKey，plainCipherText，kekCipherText</span></li><li><span class="hljs-comment">         * 9. 设备B导入封装的加密密钥材料</span></li><li><span class="hljs-comment">         */</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">ImportWrappedKey</span>(<span class="hljs-variable">params</span>, &amp;<span class="hljs-title class_">plainCipherText</span>, &amp;<span class="hljs-title class_">kekCipherText</span>, &amp;<span class="hljs-title class_">callerSelfPublicKey</span>, &amp;<span class="hljs-title class_">wrappedKeyData</span>);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">/* 10. 设备A、B删除用于加密导入的密钥 */</span></li><li>    <span class="hljs-title function_">HUKS_FREE_BLOB</span>(<span class="hljs-variable">huksPublicKey</span>);</li><li>    <span class="hljs-title function_">HUKS_FREE_BLOB</span>(<span class="hljs-variable">callerSelfPublicKey</span>);</li><li>    <span class="hljs-title function_">HUKS_FREE_BLOB</span>(<span class="hljs-variable">outSharedKey</span>);</li><li>    <span class="hljs-title function_">HUKS_FREE_BLOB</span>(<span class="hljs-variable">wrappedKeyData</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">HksClearKeysForWrappedKeyTest</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">params</span>)</li><li>{</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">CheckParamsValid</span>(<span class="hljs-variable">params</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != (<span class="hljs-variable">int32_t</span>)<span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_Huks_DeleteKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">wrappingKeyAlias</span>, <span class="hljs-variable">nullptr</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_Huks_DeleteKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKeyAlias</span>, <span class="hljs-variable">nullptr</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_Huks_DeleteKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerKekAlias</span>, <span class="hljs-variable">nullptr</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_Huks_DeleteKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">callerAgreeKeyAlias</span>, <span class="hljs-variable">nullptr</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_Huks_DeleteKeyItem</span>(<span class="hljs-variable">params</span>-&gt;<span class="hljs-title class_">importedKeyAlias</span>, <span class="hljs-variable">nullptr</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-title function_">InitCommonTestParamsAndDoImport</span>(</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">HksImportWrappedKeyTestParams</span> *<span class="hljs-variable">importWrappedKeyTestParams</span>,</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">OH_Huks_Param</span> *<span class="hljs-variable">importedKeyParamSetArray</span>,</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">arraySize</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">genX25519KeyParamSet</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">genCallerKeyParamSet</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">callerImportParamsKek</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">agreeParamSet</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *<span class="hljs-variable">importPlainKeyParams</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">genX25519KeyParamSet</span>, <span class="hljs-variable">g_genWrappingKeyParams</span>,</li><li>                           <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_genWrappingKeyParams</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">genWrappingKeyParamSet</span> = <span class="hljs-variable">genX25519KeyParamSet</span>;</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">publicKeySize</span> = <span class="hljs-variable">g_x25519PubKeySize</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">genCallerKeyParamSet</span>, <span class="hljs-variable">g_genCallerX25519Params</span>,</li><li>                           <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_genCallerX25519Params</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">genCallerKeyParamSet</span> = <span class="hljs-variable">genCallerKeyParamSet</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">callerImportParamsKek</span>, <span class="hljs-variable">g_importParamsCallerKek</span>,</li><li>                           <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_importParamsCallerKek</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">importCallerKekParamSet</span> = <span class="hljs-variable">callerImportParamsKek</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">agreeParamSet</span>, <span class="hljs-variable">g_callerAgreeParams</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_callerAgreeParams</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">OH_Huks_Param</span>));</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">agreeParamSet</span> = <span class="hljs-variable">agreeParamSet</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">InitParamSet</span>(&amp;<span class="hljs-title class_">importPlainKeyParams</span>, <span class="hljs-variable">importedKeyParamSetArray</span>, <span class="hljs-variable">arraySize</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>.<span class="hljs-variable">errorCode</span> != <span class="hljs-variable">OH_HUKS_SUCCESS</span>) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">importWrappedKeyTestParams</span>-&gt;<span class="hljs-title class_">importWrappedKeyParamSet</span> = <span class="hljs-variable">importPlainKeyParams</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">HksImportWrappedKeyTestCommonCase</span>(<span class="hljs-variable">importWrappedKeyTestParams</span>);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">genX25519KeyParamSet</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">genCallerKeyParamSet</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">callerImportParamsKek</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">agreeParamSet</span>);</li><li>    <span class="hljs-title function_">OH_Huks_FreeParamSet</span>(&amp;<span class="hljs-title class_">importPlainKeyParams</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">ImportWrappedKey</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>)</li><li>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">HksImportWrappedKeyTestParams</span> <span class="hljs-variable">importWrappedKeyTestParams001</span> = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">wrappingKeyAlias</span> = &amp;<span class="hljs-title class_">g_wrappingKeyAliasAes256</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">keyMaterialLen</span> = <span class="hljs-variable">g_importedAes256PlainKey</span>.<span class="hljs-variable">size</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">callerKeyAlias</span> = &amp;<span class="hljs-title class_">g_callerKeyAliasAes256</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">callerKekAlias</span> = &amp;<span class="hljs-title class_">g_callerKekAliasAes256</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">callerKek</span> = &amp;<span class="hljs-title class_">g_callerAes256Kek</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">callerAgreeKeyAlias</span> = &amp;<span class="hljs-title class_">g_callerAgreeKeyAliasAes256</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">importedKeyAlias</span> = &amp;<span class="hljs-title class_">g_importedKeyAliasAes256</span>;</li><li>    <span class="hljs-variable">importWrappedKeyTestParams001</span>.<span class="hljs-variable">importedPlainKey</span> = &amp;<span class="hljs-title class_">g_importedAes256PlainKey</span>;</li><li>    <span class="hljs-variable">OH_Huks_Result</span> <span class="hljs-variable">ohResult</span> =</li><li>        <span class="hljs-title function_">InitCommonTestParamsAndDoImport</span>(&amp;<span class="hljs-title class_">importWrappedKeyTestParams001</span>, <span class="hljs-variable">g_importWrappedAes256Params</span>,</li><li>                                        <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">g_importWrappedAes256Params</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span>));</li><li>    <span class="hljs-title function_">HksClearKeysForWrappedKeyTest</span>(&amp;<span class="hljs-title class_">importWrappedKeyTestParams001</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">ohResult</span>.<span class="hljs-variable">errorCode</span>, &amp;<span class="hljs-title class_">ret</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h2>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_iskeyitemexist" target="_blank">OH_Huks_IsKeyItemExist</a>验证密钥是否存在，如密钥存在即表示密钥导入成功。</p>     <div _ngcontent-vio-c106="" class="highlight-div"><div _ngcontent-vio-c106="" class="highlight-div-header"><div _ngcontent-vio-c106="" class="highlight-div-header-left"><div _ngcontent-vio-c106="" class="handle-button expand-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vio-c106="" class="highlight-div-header-right"><div _ngcontent-vio-c106="" class="handle-button ai-button"></div><div _ngcontent-vio-c106="" class="handle-button line-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vio-c106="" class="handle-button theme-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vio-c106="" class="handle-button copy-button"><div _ngcontent-vio-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vio-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IsKeyExist</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">/* 1.指定密钥别名 */</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> keyAlias = {</li><li>        (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"test_key"</span>),</li><li>        (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"test_key"</span></li><li>    };</li><li>    </li><li>    <span class="hljs-comment">/* 2.调用OH_Huks_IsKeyItemExist判断密钥是否存在  */</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> ohResult = <span class="hljs-built_in">OH_Huks_IsKeyItemExist</span>(&amp;keyAlias, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-comment">// 失败。</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// 成功。</span></li><li>    }</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ohResult.errorCode, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>