<h1 _ngcontent-eyj-c119="" class="doc-title ng-star-inserted" title="加速Web页面的访问"> 加速Web页面的访问 </h1>

<div _ngcontent-eyj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>当Web页面加载缓慢时，可以使用预连接、预加载和预获取post请求的能力加速Web页面的访问。</p>    <p>针对Web页面加载性能优化的详细内容请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-web-develop-optimization#section128761465256" target="_blank">Web页面加载优化性能指导</a>。</p>    <div class="tiledSection">     <h2 id="预解析和预连接">预解析和预连接<i class="anchor-icon anchor-icon-link" anchorid="预解析和预连接" tips="复制节点链接"></i></h2>          <p>此方法可以针对域名级进行优化，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prepareforpageload10" target="_blank">prepareForPageLoad()</a>来预解析或者预连接将要加载的页面。该方式仅对url进行DNS解析以及建立tcp连接，但不会获取主资源子资源。</p>     <p>在下面的示例中，在Web组件的onAppear中对要加载的页面进行预连接。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'loadData'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">accessBackward</span>()) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">backward</span>();</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'https://www.example.com/'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span> })</li><li>        .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 指定第二个参数为true，代表要进行预连接，如果为false该接口只会对网址进行dns预解析</span></li><li>          <span class="hljs-comment">// 第三个参数为要预连接socket的个数。最多允许6个。</span></li><li>          webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prepareForPageLoad</span>(<span class="hljs-string">'https://www.example.com/'</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">2</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>也可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#initializewebengine" target="_blank">initializeWebEngine()</a>来提前初始化内核，然后在初始化内核后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prepareforpageload10" target="_blank">prepareForPageLoad()</a>对即将要加载的页面进行预解析、预连接。这种方式适合提前对首页进行预解析、预连接。</p>     <p>在下面的示例中，Ability的onCreate中提前初始化Web内核并对首页进行预连接。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"EntryAbility onCreate"</span>);</li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">initializeWebEngine</span>();</li><li>    <span class="hljs-comment">// 预连接时，需要将'https://www.example.com'替换成真实要访问的网站地址。</span></li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prepareForPageLoad</span>(<span class="hljs-string">"https://www.example.com/"</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">2</span>);</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"abilityWant"</span>, want);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"EntryAbility onCreate done"</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="预加载">预加载<i class="anchor-icon anchor-icon-link" anchorid="预加载" tips="复制节点链接"></i></h2>          <p>此方法可针对资源级进行优化。如果能够预测到Web组件将要加载的页面或者即将要跳转的页面。可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prefetchpage10" target="_blank">prefetchPage()</a>来预加载即将要加载页面。</p>     <p>预加载会提前下载页面所需的资源，包括主资源子资源，避免阻塞页面渲染。但不会执行网页JavaScript代码。预加载是WebviewController的实例方法，需要一个已经关联好Web组件的WebviewController实例。</p>     <p>在下面的示例中，在onPageEnd的时候触发下一个要访问的页面的预加载。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'https://www.example.com/'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span> })</li><li>        .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 预加载https://www.iana.org/help/example-domains。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">prefetchPage</span>(<span class="hljs-string">'https://www.iana.org/help/example-domains'</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="预获取post请求">预获取post请求<i class="anchor-icon anchor-icon-link" anchorid="预获取post请求" tips="复制节点链接"></i></h2>          <p>此方法可以针对请求级进行优化。可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prefetchresource12" target="_blank">prefetchResource()</a>预获取将要加载页面中的post请求。在页面加载结束时，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#clearprefetchedresource12" target="_blank">clearPrefetchedResource()</a>清除后续不再使用的预获取资源缓存。</p>     <p>以下示例，在Web组件onAppear中，对要加载页面中的post请求进行预获取。在onPageEnd中，可以清除预获取的post请求缓存。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">"https://www.example.com/"</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span> })</li><li>        .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 预获取时，需要将"https://www.example1.com/post?e=f&amp;g=h"替换成真实要访问的网站地址。</span></li><li>          webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prefetchResource</span>(</li><li>            {</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example1.com/post?e=f&amp;g=h"</span>,</li><li>              <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,</li><li>              <span class="hljs-attr">formData</span>: <span class="hljs-string">"a=x&amp;b=y"</span>,</li><li>            },</li><li>            [{</li><li>              <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"c"</span>,</li><li>              <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"z"</span>,</li><li>            },],</li><li>            <span class="hljs-string">"KeyX"</span>, <span class="hljs-number">500</span>);</li><li>        })</li><li>        .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 清除后续不再使用的预获取资源缓存。</span></li><li>          webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">clearPrefetchedResource</span>([<span class="hljs-string">"KeyX"</span>,]);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>如果能够预测到Web组件将要加载页面或者即将要跳转页面中的post请求。可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prefetchresource12" target="_blank">prefetchResource()</a>预获取即将要加载页面的post请求。</p>     <p>以下示例，在onPageEnd中，触发预获取一个要访问页面的post请求。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'https://www.example.com/'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span> })</li><li>        .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 预获取时，需要将"https://www.example1.com/post?e=f&amp;g=h"替换成真实要访问的网站地址。</span></li><li>          webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prefetchResource</span>(</li><li>            {</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example1.com/post?e=f&amp;g=h"</span>,</li><li>              <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,</li><li>              <span class="hljs-attr">formData</span>: <span class="hljs-string">"a=x&amp;b=y"</span>,</li><li>            },</li><li>            [{</li><li>              <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"c"</span>,</li><li>              <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"z"</span>,</li><li>            },],</li><li>            <span class="hljs-string">"KeyX"</span>, <span class="hljs-number">500</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>也可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#initializewebengine" target="_blank">initializeWebEngine()</a>提前初始化内核，然后在初始化内核后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#prefetchresource12" target="_blank">prefetchResource()</a>预获取将要加载页面中的post请求。这种方式适合提前预获取首页的post请求。</p>     <p>以下示例，在Ability的onCreate中，提前初始化Web内核并预获取首页的post请求。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"EntryAbility onCreate"</span>);</li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">initializeWebEngine</span>();</li><li>    <span class="hljs-comment">// 预获取时，需要将"https://www.example1.com/post?e=f&amp;g=h"替换成真实要访问的网站地址。</span></li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prefetchResource</span>(</li><li>      {</li><li>        <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example1.com/post?e=f&amp;g=h"</span>,</li><li>        <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,</li><li>        <span class="hljs-attr">formData</span>: <span class="hljs-string">"a=x&amp;b=y"</span>,</li><li>      },</li><li>      [{</li><li>        <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"c"</span>,</li><li>        <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"z"</span>,</li><li>      },],</li><li>      <span class="hljs-string">"KeyX"</span>, <span class="hljs-number">500</span>);</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"abilityWant"</span>, want);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"EntryAbility onCreate done"</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="预编译生成编译缓存">预编译生成编译缓存<i class="anchor-icon anchor-icon-link" anchorid="预编译生成编译缓存" tips="复制节点链接"></i></h2>          <p>可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#precompilejavascript12" target="_blank">precompileJavaScript()</a>在页面加载前提前生成脚本文件的编译缓存。</p>     <p>推荐配合动态组件使用，使用离线的Web组件用于生成字节码缓存，并在适当的时机加载业务用Web组件使用这些字节码缓存。下方是代码示例：</p>     <ol>      <li>       <p>首先，在EntryAbility中将UIContext存到localStorage中。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">localStorage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>(<span class="hljs-string">'uiContext'</span>);</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-variable language_">localStorage</span>;</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"uiContext"</span>, windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">getUIContext</span>());</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写动态组件所需基础代码。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// DynamicComponent.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BuilderData</span> {</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">controller</span>: <span class="hljs-title class_">WebviewController</span>;</li><li>  <span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> storage : <span class="hljs-title class_">LocalStorage</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeControllerImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">BuilderData</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">wrappedBuilder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;<span class="hljs-title class_">BuilderData</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">wrappedBuilder: WrappedBuilder&lt;BuilderData[]&gt;, context: UIContext</span>) {</li><li>    storage = context.<span class="hljs-title function_">getSharedLocalStorage</span>();</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wrappedBuilder</span> = wrappedBuilder;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, controller: WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = storage!.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"uiContext"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!uiContext) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrappedBuilder</span>, { <span class="hljs-attr">url</span>: url, <span class="hljs-attr">controller</span>: controller });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNode</span> = (<span class="hljs-params">wrappedBuilder: WrappedBuilder&lt;BuilderData[]&gt;, data: BuilderData</span>) =&gt; {</li><li>  <span class="hljs-keyword">const</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeControllerImpl</span>(wrappedBuilder, data.<span class="hljs-property">context</span>);</li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(data.<span class="hljs-property">url</span>, data.<span class="hljs-property">controller</span>);</li><li>  <span class="hljs-keyword">return</span> baseNode;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写用于生成字节码缓存的组件，本例中的本地Javascript资源内容通过文件读取接口读取rawfile目录下的本地文件。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PrecompileWebview.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Config</span>, configs } <span class="hljs-keyword">from</span> <span class="hljs-string">"./PrecompileConfig"</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data: BuilderData</span>) {</li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>    .<span class="hljs-title function_">onControllerAttached</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title function_">precompile</span>(data.<span class="hljs-property">controller</span>, configs, data.<span class="hljs-property">context</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">fileAccess</span>(<span class="hljs-literal">true</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> precompileWebview = wrapBuilder&lt;<span class="hljs-title class_">BuilderData</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">precompile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">controller: WebviewController, configs: <span class="hljs-built_in">Array</span>&lt;Config&gt;, context: UIContext</span>) =&gt; {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> configs) {</li><li>    <span class="hljs-keyword">let</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readRawFile</span>(config.<span class="hljs-property">localPath</span>, context);</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      controller.<span class="hljs-title function_">precompileJavaScript</span>(config.<span class="hljs-property">url</span>, content, config.<span class="hljs-property">options</span>)</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">errCode</span> =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"precompile successfully! "</span> + errCode);</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errCode: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"precompile failed. "</span> + errCode);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"precompile failed. "</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">" "</span> + err.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readRawFile</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span>, context: UIContext</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(path);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">0</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>     <p>JavaScript资源的获取方式也可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-http" target="_blank">网络请求</a>的方式获取，但此方法获取到的http响应头非标准HTTP响应头格式，需额外将响应头转换成标准HTTP响应头格式后使用。如通过网络请求获取到的响应头是e-tag，则需要将其转换成E-Tag后使用。</p>     <ol>      <li>       <p>编写业务用组件代码。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// BusinessWebview.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data: BuilderData</span>) {</li><li>  <span class="hljs-comment">// 此处组件可根据业务需要自行扩展</span></li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>    .<span class="hljs-title function_">cacheMode</span>(<span class="hljs-title class_">CacheMode</span>.<span class="hljs-property">Default</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> businessWebview = wrapBuilder&lt;<span class="hljs-title class_">BuilderData</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li></ol></pre></div></div></li>      <li>       <p>编写资源配置信息。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PrecompileConfig.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> {</li><li>  <span class="hljs-attr">url</span>:  <span class="hljs-built_in">string</span>,</li><li>  <span class="hljs-attr">localPath</span>: <span class="hljs-built_in">string</span>, <span class="hljs-comment">// 本地资源路径</span></li><li>  <span class="hljs-attr">options</span>: webview.<span class="hljs-property">CacheOptions</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">configs</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Config</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example.com/example.js"</span>,</li><li>    <span class="hljs-attr">localPath</span>: <span class="hljs-string">"example.js"</span>,</li><li>    <span class="hljs-attr">options</span>: {</li><li>      <span class="hljs-attr">responseHeaders</span>: [</li><li>        { <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"E-Tag"</span>, <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"aWO42N9P9dG/5xqYQCxsx+vDOoU="</span>},</li><li>        { <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"Last-Modified"</span>, <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"Wed, 21 Mar 2024 10:38:41 GMT"</span>}</li><li>      ]</li><li>    }</li><li>  }</li><li>]</li></ol></pre></div></div></li>      <li>       <p>在页面中使用。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { createNode } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span></li><li><span class="hljs-keyword">import</span> { precompileWebview } <span class="hljs-keyword">from</span> <span class="hljs-string">"./PrecompileWebview"</span></li><li><span class="hljs-keyword">import</span> { businessWebview } <span class="hljs-keyword">from</span> <span class="hljs-string">"./BusinessWebview"</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">precompileNode</span>: <span class="hljs-title class_">NodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">precompileController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">businessNode</span>: <span class="hljs-title class_">NodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">businessController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 初始化用于注入本地资源的Web组件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">precompileNode</span> = <span class="hljs-title function_">createNode</span>(precompileWebview,</li><li>      { <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example.com/empty.html"</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">precompileController</span>, <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()});</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 在适当的时机加载业务用Web组件，本例以Button点击触发为例</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"加载页面"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">businessNode</span> = <span class="hljs-title function_">createNode</span>(businessWebview, {</li><li>            <span class="hljs-attr">url</span>:  <span class="hljs-string">"https://www.example.com/business.html"</span>,</li><li>            <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">businessController</span>,</li><li>            <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()</li><li>          });</li><li>        })</li><li>      <span class="hljs-comment">// 用于业务的Web组件</span></li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">businessNode</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>     <p>当需要更新本地已经生成的编译字节码时，修改cacheOptions参数中responseHeaders中的E-Tag或Last-Modified响应头对应的值，再次调用接口即可。</p>    </div>    <div class="tiledSection">     <h2 id="离线资源免拦截注入">离线资源免拦截注入<i class="anchor-icon anchor-icon-link" anchorid="离线资源免拦截注入" tips="复制节点链接"></i></h2>          <p>可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#injectofflineresources12" target="_blank">injectOfflineResources()</a>在页面加载前提前将图片、样式表或脚本资源注入到应用的内存缓存中。</p>     <p>推荐配合动态组件使用，使用离线的Web组件用于将资源注入到内核的内存缓存中，并在适当的时机加载业务用Web组件使用这些资源。下方是代码示例：</p>     <ol>      <li>       <p>首先，在EntryAbility中将UIContext存到localStorage中。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">localStorage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>(<span class="hljs-string">'uiContext'</span>);</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-variable language_">localStorage</span>;</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"uiContext"</span>, windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">getUIContext</span>());</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写动态组件所需基础代码。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// DynamicComponent.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BuilderData</span> {</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">controller</span>: <span class="hljs-title class_">WebviewController</span>;</li><li>  <span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> storage : <span class="hljs-title class_">LocalStorage</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeControllerImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">BuilderData</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">wrappedBuilder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;<span class="hljs-title class_">BuilderData</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">wrappedBuilder: WrappedBuilder&lt;BuilderData[]&gt;,  context: UIContext</span>) {</li><li>   storage = context.<span class="hljs-title function_">getSharedLocalStorage</span>();</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wrappedBuilder</span> = wrappedBuilder;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, controller: WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = storage!.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"uiContext"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!uiContext) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrappedBuilder</span>, { <span class="hljs-attr">url</span>: url, <span class="hljs-attr">controller</span>: controller });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNode</span> = (<span class="hljs-params">wrappedBuilder: WrappedBuilder&lt;BuilderData[]&gt;, data: BuilderData</span>) =&gt; {</li><li>  <span class="hljs-keyword">const</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeControllerImpl</span>(wrappedBuilder, data.<span class="hljs-property">context</span>);</li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(data.<span class="hljs-property">url</span>, data.<span class="hljs-property">controller</span>);</li><li>  <span class="hljs-keyword">return</span> baseNode;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写用于注入资源的组件代码，本例中的本地资源内容通过文件读取接口读取rawfile目录下的本地文件。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// InjectWebview.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { resourceConfigs } <span class="hljs-keyword">from</span> <span class="hljs-string">"./Resource"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data: BuilderData</span>) {</li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>    .<span class="hljs-title function_">onControllerAttached</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        data.<span class="hljs-property">controller</span>.<span class="hljs-title function_">injectOfflineResources</span>(<span class="hljs-keyword">await</span> getData (data.<span class="hljs-property">context</span>));</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"error: "</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">" "</span> + err.<span class="hljs-property">message</span>);</li><li>      }</li><li>    })</li><li>    .<span class="hljs-title function_">fileAccess</span>(<span class="hljs-literal">true</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> injectWebview = wrapBuilder&lt;<span class="hljs-title class_">BuilderData</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params">context: UIContext</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceMapArr</span>: <span class="hljs-title class_">Array</span>&lt;webview.<span class="hljs-property">OfflineResourceMap</span>&gt; = [];</li><li>
</li><li>  <span class="hljs-comment">// 读取配置，从rawfile目录中读取文件内容</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> config <span class="hljs-keyword">of</span> resourceConfigs) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">buf</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">localPath</span>) {</li><li>      buf = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readRawFile</span>(config.<span class="hljs-property">localPath</span>, context);</li><li>    }</li><li>
</li><li>    resourceMapArr.<span class="hljs-title function_">push</span>({</li><li>      <span class="hljs-attr">urlList</span>: config.<span class="hljs-property">urlList</span>,</li><li>      <span class="hljs-attr">resource</span>: buf,</li><li>      <span class="hljs-attr">responseHeaders</span>: config.<span class="hljs-property">responseHeaders</span>,</li><li>      <span class="hljs-attr">type</span>: config.<span class="hljs-property">type</span>,</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">return</span> resourceMapArr;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readRawFile</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, context: UIContext</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(url);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">0</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编写业务用组件代码。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// BusinessWebview.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data: BuilderData</span>) {</li><li>  <span class="hljs-comment">// 此处组件可根据业务需要自行扩展</span></li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>    .<span class="hljs-title function_">cacheMode</span>(<span class="hljs-title class_">CacheMode</span>.<span class="hljs-property">Default</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> businessWebview = wrapBuilder&lt;<span class="hljs-title class_">BuilderData</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li></ol></pre></div></div></li>      <li>       <p>编写资源配置信息。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Resource.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceConfig</span> {</li><li>  <span class="hljs-attr">urlList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;,</li><li>  <span class="hljs-attr">type</span>: webview.<span class="hljs-property">OfflineResourceType</span>,</li><li>  <span class="hljs-attr">responseHeaders</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Header</span>&gt;,</li><li>  <span class="hljs-attr">localPath</span>: <span class="hljs-built_in">string</span>, <span class="hljs-comment">// 本地资源存放在rawfile目录下的路径</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceConfigs</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ResourceConfig</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">localPath</span>: <span class="hljs-string">"example.png"</span>,</li><li>    <span class="hljs-attr">urlList</span>: [</li><li>      <span class="hljs-string">"https://www.example.com/"</span>,</li><li>      <span class="hljs-string">"https://www.example.com/path1/example.png"</span>,</li><li>      <span class="hljs-string">"https://www.example.com/path2/example.png"</span>,</li><li>    ],</li><li>    <span class="hljs-attr">type</span>: webview.<span class="hljs-property">OfflineResourceType</span>.<span class="hljs-property">IMAGE</span>,</li><li>    <span class="hljs-attr">responseHeaders</span>: [</li><li>      { <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"Cache-Control"</span>, <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"max-age=1000"</span> },</li><li>      { <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"Content-Type"</span>, <span class="hljs-attr">headerValue</span>: <span class="hljs-string">"image/png"</span> },</li><li>    ]</li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">localPath</span>: <span class="hljs-string">"example.js"</span>,</li><li>    <span class="hljs-attr">urlList</span>: [ <span class="hljs-comment">// 仅提供一个url，这个url既作为资源的源，也作为资源的网络请求地址</span></li><li>      <span class="hljs-string">"https://www.example.com/example.js"</span>,</li><li>    ],</li><li>    <span class="hljs-attr">type</span>: webview.<span class="hljs-property">OfflineResourceType</span>.<span class="hljs-property">CLASSIC_JS</span>,</li><li>    <span class="hljs-attr">responseHeaders</span>: [</li><li>      <span class="hljs-comment">// 以&lt;script crossorigin="anonymous" /&gt;方式使用，提供额外的响应头</span></li><li>      { <span class="hljs-attr">headerKey</span>: <span class="hljs-string">"Cross-Origin"</span>, <span class="hljs-attr">headerValue</span>:<span class="hljs-string">"anonymous"</span> }</li><li>    ]</li><li>  },</li><li>];</li></ol></pre></div></div></li>      <li>       <p>在页面中使用。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { createNode } <span class="hljs-keyword">from</span> <span class="hljs-string">"./DynamicComponent"</span></li><li><span class="hljs-keyword">import</span> { injectWebview } <span class="hljs-keyword">from</span> <span class="hljs-string">"./InjectWebview"</span></li><li><span class="hljs-keyword">import</span> { businessWebview } <span class="hljs-keyword">from</span> <span class="hljs-string">"./BusinessWebview"</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">injectNode</span>: <span class="hljs-title class_">NodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">injectController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">businessNode</span>: <span class="hljs-title class_">NodeController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">businessController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 初始化用于注入本地资源的Web组件, 提供一个空的html页面作为url即可</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">injectNode</span> = <span class="hljs-title function_">createNode</span>(injectWebview,</li><li>        { <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example.com/empty.html"</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">injectController</span>, <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()});</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// 在适当的时机加载业务用Web组件，本例以Button点击触发为例</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"加载页面"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">businessNode</span> = <span class="hljs-title function_">createNode</span>(businessWebview, {</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">"https://www.example.com/business.html"</span>,</li><li>            <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">businessController</span>,</li><li>            <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()</li><li>          });</li><li>        })</li><li>      <span class="hljs-comment">// 用于业务的Web组件</span></li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">businessNode</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>加载的HTML网页示例。</p>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="HTML prettyprint linenums hljs language-HTML" hw-language="HTML" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.example.com/path1/request.png"</span> /&gt;</span></li><li>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.example.com/path2/request.png"</span> /&gt;</span></li><li>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.example.com/example.js"</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>