<h1 _ngcontent-fxl-c119="" class="doc-title ng-star-inserted" title="动态调整预览帧率(C/C++)"> 动态调整预览帧率(C/C++) </h1>

<div _ngcontent-fxl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>动态调整帧率是直播、视频等场景下控制预览效果的重要能力之一。应用可通过此能力，显性地控制流输出帧率，以适应不同帧率下的业务目标。</p> <p>某些场景下降低帧率可在相机设备启用时降低功耗。</p> <div class="tiledSection"><h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2><p>支持的帧率范围及帧率的设置依赖于硬件能力的实现，不同的硬件平台可能拥有不同的默认帧率。</p> </div> <div class="tiledSection"><h2 id="section7138446104911">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section7138446104911" tips="复制节点链接"></i></h2><p>相机使用预览功能前，均需要创建相机会话。完成会话配置后，应用提交和开启会话，才可以开始调用相机相关功能。</p> <p>流程图如下所示：</p> <p><span><img originheight="1124" originwidth="1016" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.89032129656412574868687521211493:50001231000000:2800:06CBB75CE5B87B410BFADECABA3D6B66E14A61DD18CE322442A8C4F66F68469B.png" width="920" height="1017.7952755905511"></span></p> <p>与普通的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-preview" target="_blank">预览</a>流程相比，动态调整预览帧率的注意点如图上标识：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_createcapturesession" target="_blank">OH_CameraManager_CreateCaptureSession</a>创建会话（Session）时，需要指定模式为NORMAL_PHOTO或NORMAL_VIDEO。<p>仅当Session处于NORMAL_PHOTO或NORMAL_VIDEO模式时，支持调整预览流帧率。调整帧率的创建会话方式见<a href="/consumer/cn/doc/harmonyos-guides/camera-setframerate-native#section10844102810218">创建Session会话并指定模式</a>。</p> </li><li><a href="/consumer/cn/doc/harmonyos-guides/camera-setframerate-native#section137971332201516">动态调整帧率</a>的操作，可在启动预览前后任意时刻调用。</li><li><a href="/consumer/cn/doc/harmonyos-guides/camera-setframerate-native#section137971332201516">动态调整帧率</a>在预览里属于可选操作，可以完成：<ul><li>查询当前支持调整的帧率范围</li><li>设置当前帧率</li><li>获取当前生效的帧率设置</li></ul> </li></ol> <p>如何配置会话（Session）、释放资源，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-session-management" target="_blank">会话管理</a> &gt; <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-preview" target="_blank">预览</a>。</p> </div> <div class="tiledSection"><h2 id="section181965213464">导入模块<i class="anchor-icon anchor-icon-link" anchorid="section181965213464" tips="复制节点链接"></i></h2><ol><li><p>导入NDK接口，导入方法如下。</p> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 导入NDK接口头文件</span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div> </li><li><p>在CMake脚本中链接相关动态库。</p> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li> target_link_libraries(entry PUBLIC libohcamera.so libhilog_ndk.z.so)</li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section10844102810218">创建Session会话并指定模式<i class="anchor-icon anchor-icon-link" anchorid="section10844102810218" tips="复制节点链接"></i></h2><p>相机使用预览等功能前，均需创建相机会话，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_createcapturesession" target="_blank">OH_CameraManager_CreateCaptureSession</a>创建一个会话。</p> <p>创建会话时调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setsessionmode" target="_blank">OH_CaptureSession_SetSessionMode</a>指定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_scenemode" target="_blank">Camera_SceneMode</a>为NORMAL_PHOTO或NORMAL_VIDEO，创建出的Session处于拍照或录像模式。</p> <p>以创建Session会话并指定为NORMAL_PHOTO模式为例：</p> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_ErrorCode </span><span class=""><span class="hljs-function"><span class="hljs-title">CreateCaptureSession</span></span></span><span class="hljs-function"><span class="hljs-params">(Camera_Manager *cameraManager</span></span><span class=""><span class="hljs-function"><span class="hljs-params">, </span></span></span><span class="hljs-function"><span class="hljs-params">Camera_CaptureSession *captureSession)</span> </span>{</li><li>   Camera_ErrorCode ret = <span class=""><span class="hljs-built_in">OH_CameraManager_CreateCaptureSession</span></span>(cameraManager<span class="">, </span>&amp;captureSession)<span class="">;</span></li><li><span class="">    <span class="hljs-keyword">if</span> </span>(captureSession == <span class=""><span class="hljs-literal">nullptr</span> </span>|| ret != <span class="">CAMERA_OK</span>) {</li><li>        <span class=""><span class="hljs-built_in">OH_LOG_ERROR</span></span>(<span class="">LOG_APP</span><span class="">, </span><span class=""><span class="hljs-string">"OH_CameraManager_CreateCaptureSession failed."</span></span>)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设置会话模式为拍照或录像模式，此处以拍照模式为例</span></span></li><li>    ret = <span class=""><span class="hljs-built_in">OH_CaptureSession_SetSessionMode</span></span>(captureSession<span class="">, </span>Camera_SceneMode::<span class="">NORMAL_PHOTO</span>)<span class="">;</span></li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section137971332201516">动态调整帧率<i class="anchor-icon anchor-icon-link" anchorid="section137971332201516" tips="复制节点链接"></i></h2><ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-preview-output-h#oh_previewoutput_getsupportedframerates" target="_blank">OH_PreviewOutput_GetSupportedFrameRates</a>，查询当前previewOutput支持的帧率范围。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p><strong>调用时机</strong>：</p> <p>需要在Session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_commitconfig" target="_blank">OH_CaptureSession_CommitConfig</a>完成配流之后调用。</p> <p><strong>OH_PreviewOutput_GetSupportedFrameRates调用限制：</strong></p> <ul><li>在调用OH_PreviewOutput_GetSupportedFrameRates接口设置非固定帧率后，不支持再次调用该接口重新设置动态帧率。</li><li>在调用OH_PreviewOutput_GetSupportedFrameRates接口设置固定帧率后，支持重新设置固定帧率，但必须保证新设置的帧率可以整除之前设置的帧率或者被之前设置的帧率整除。</li></ul> </div></div></div> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">PreviewOutputGetSupportedFrameRates</span><span class="hljs-params">(Camera_PreviewOutput* previewOutput,</span></span></li><li><span class="hljs-function">    Camera_FrameRateRange** frameRateRange, <span class="hljs-type">uint32_t</span>* size)</span> {</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_PreviewOutput_GetSupportedFrameRates</span>(previewOutput, frameRateRange, size);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_GetSupportedFrameRates failed."</span>);</li><li>        <span class="hljs-keyword">return</span> CAMERA_INVALID_ARGUMENT;</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; *size; i++) {</li><li>        <span class="hljs-built_in">OH_LOG_DEBUG</span>(LOG_APP, <span class="hljs-string">"PreviewOutputGetSupportedFrameRates: SupportedFrameRates min %{public}d"</span>, (*frameRateRange)[i].min);</li><li>        <span class="hljs-built_in">OH_LOG_DEBUG</span>(LOG_APP, <span class="hljs-string">"PreviewOutputGetSupportedFrameRates: SupportedFrameRates max %{public}d"</span>, (*frameRateRange)[i].max);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> </li><li><p>根据实际开发需求，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-preview-output-h#oh_previewoutput_setframerate" target="_blank">OH_PreviewOutput_SetFrameRate</a>接口对帧率进行动态调整。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>需要在Session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_commitconfig" target="_blank">OH_CaptureSession_CommitConfig</a>完成配流之后调用。</li><li>可在Session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-preview-output-h#oh_previewoutput_start" target="_blank">OH_PreviewOutput_Start</a>启动预览前后任意时刻调用。</li></ul> </div></div></div> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">PreviewOutputSetFrameRate</span><span class="hljs-params">(Camera_PreviewOutput* previewOutput,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">uint32_t</span> minFps, <span class="hljs-type">uint32_t</span> maxFps)</span>{</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_PreviewOutput_SetFrameRate</span>(previewOutput, minFps, maxFps);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-keyword">return</span> CAMERA_INVALID_ARGUMENT;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> </li><li><p>（可选）通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-preview-output-h#oh_previewoutput_getactiveframerate" target="_blank">OH_PreviewOutput_GetActiveFrameRate</a>接口查询已设置过并生效的帧率。</p> <p>仅通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-preview-output-h#oh_previewoutput_setframerate" target="_blank">OH_PreviewOutput_SetFrameRate</a>接口显性设置过帧率才可查询当前生效帧率信息。</p> <div _ngcontent-fxl-c106="" class="highlight-div"><div _ngcontent-fxl-c106="" class="highlight-div-header"><div _ngcontent-fxl-c106="" class="highlight-div-header-left"><div _ngcontent-fxl-c106="" class="handle-button expand-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxl-c106="" class="highlight-div-header-right"><div _ngcontent-fxl-c106="" class="handle-button ai-button"></div><div _ngcontent-fxl-c106="" class="handle-button line-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxl-c106="" class="handle-button theme-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxl-c106="" class="handle-button copy-button"><div _ngcontent-fxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">PreviewOutputGetActiveFrameRate</span><span class="hljs-params">(Camera_PreviewOutput* previewOutput,</span></li><li><span class="hljs-params">    Camera_FrameRateRange* frameRateRange)</span>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_PreviewOutput_GetActiveFrameRate(previewOutput, frameRateRange);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-keyword">return</span> CAMERA_INVALID_ARGUMENT;</li><li>    }</li><li>    OH_LOG_DEBUG(LOG_APP, <span class="hljs-string">"PreviewOutputGetActiveFrameRate: ActiveFrameRate frameRateRange_ min %{public}d"</span>, (*frameRateRange).min);</li><li>    OH_LOG_DEBUG(LOG_APP, <span class="hljs-string">"PreviewOutputGetActiveFrameRate: ActiveFrameRate frameRateRange_ max %{public}d"</span>, (*frameRateRange).max);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>