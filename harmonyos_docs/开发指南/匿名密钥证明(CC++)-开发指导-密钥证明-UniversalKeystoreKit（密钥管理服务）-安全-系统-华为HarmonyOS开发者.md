<h1 _ngcontent-rbq-c119="" class="doc-title ng-star-inserted" title="匿名密钥证明(C/C++)"> 匿名密钥证明(C/C++) </h1>

<div _ngcontent-rbq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在使用本功能时，需确保网络通畅。</p>    <div class="tiledSection">     <h2 id="在cmake脚本中链接相关动态库">在CMake脚本中链接相关动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接相关动态库" tips="复制节点链接"></i></h2>          <div _ngcontent-rbq-c106="" class="highlight-div"><div _ngcontent-rbq-c106="" class="highlight-div-header"><div _ngcontent-rbq-c106="" class="highlight-div-header-left"><div _ngcontent-rbq-c106="" class="handle-button expand-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rbq-c106="" class="highlight-div-header-right"><div _ngcontent-rbq-c106="" class="handle-button ai-button"></div><div _ngcontent-rbq-c106="" class="handle-button line-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rbq-c106="" class="handle-button theme-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rbq-c106="" class="handle-button copy-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rbq-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhuks_ndk.z.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>指定密钥别名，密钥别名命名规范参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成介绍及算法规格</a>。</p></li>      <li>       <p>初始化参数集：通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-param-h#oh_huks_initparamset" target="_blank">OH_Huks_InitParamSet</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-param-h#oh_huks_addparams" target="_blank">OH_Huks_AddParams</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-param-h#oh_huks_buildparamset" target="_blank">OH_Huks_BuildParamSet</a>构造参数集paramSet，参数集中必须包含<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-type-h#oh_huks_keyalg" target="_blank">OH_Huks_KeyAlg</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-type-h#oh_huks_keysize" target="_blank">OH_Huks_KeySize</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-type-h#oh_huks_keypurpose" target="_blank">OH_Huks_KeyPurpose</a>属性。</p></li>      <li>       <p>将密钥别名与参数集作为参数传入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_anonattestkeyitem" target="_blank">OH_Huks_AnonAttestKeyItem</a>方法中，即可证明密钥。</p></li>     </ol>     <div _ngcontent-rbq-c106="" class="highlight-div"><div _ngcontent-rbq-c106="" class="highlight-div-header"><div _ngcontent-rbq-c106="" class="highlight-div-header-left"><div _ngcontent-rbq-c106="" class="handle-button expand-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rbq-c106="" class="highlight-div-header-right"><div _ngcontent-rbq-c106="" class="handle-button ai-button"></div><div _ngcontent-rbq-c106="" class="handle-button line-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rbq-c106="" class="handle-button theme-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rbq-c106="" class="handle-button copy-button"><div _ngcontent-rbq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rbq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">InitParamSet</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_ParamSet **paramSet,</span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Param *params,</span></li><li><span class="hljs-function">    <span class="hljs-type">uint32_t</span> paramCount)</span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_AddParams</span>(*paramSet, params, paramCount);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_BuildParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> g_size = <span class="hljs-number">4096</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> CERT_COUNT = <span class="hljs-number">4</span>;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FreeCertChain</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_Huks_CertChain *certChain, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> pos)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (certChain == <span class="hljs-literal">nullptr</span> || certChain-&gt;certs == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>; j &lt; pos; j++) {</li><li>        <span class="hljs-keyword">if</span> (certChain-&gt;certs[j].data != <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">free</span>(certChain-&gt;certs[j].data);</li><li>            certChain-&gt;certs[j].data = <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (certChain-&gt;certs != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">free</span>(certChain-&gt;certs);</li><li>        certChain-&gt;certs = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">ConstructDataToCertChain</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_Huks_CertChain *certChain)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (certChain == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_HUKS_ERR_CODE_ILLEGAL_ARGUMENT;</li><li>    }</li><li>    certChain-&gt;certsCount = CERT_COUNT;</li><li>
</li><li>    certChain-&gt;certs = (<span class="hljs-keyword">struct</span> OH_Huks_Blob *)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> OH_Huks_Blob) * (certChain-&gt;certsCount));</li><li>    <span class="hljs-keyword">if</span> (certChain-&gt;certs == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> OH_HUKS_ERR_CODE_INTERNAL_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; certChain-&gt;certsCount; i++) {</li><li>        certChain-&gt;certs[i].size = g_size;</li><li>        certChain-&gt;certs[i].data = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(certChain-&gt;certs[i].size);</li><li>        <span class="hljs-keyword">if</span> (certChain-&gt;certs[i].data == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">FreeCertChain</span>(certChain, i);</li><li>            <span class="hljs-keyword">return</span> OH_HUKS_ERR_CODE_INTERNAL_ERROR;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> OH_HUKS_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_genAnonAttestParams[] = {</li><li>    { .tag = OH_HUKS_TAG_ALGORITHM, .uint32Param = OH_HUKS_ALG_RSA },</li><li>    { .tag = OH_HUKS_TAG_KEY_SIZE, .uint32Param = OH_HUKS_RSA_KEY_SIZE_2048 },</li><li>    { .tag = OH_HUKS_TAG_PURPOSE, .uint32Param = OH_HUKS_KEY_PURPOSE_VERIFY },</li><li>    { .tag = OH_HUKS_TAG_DIGEST, .uint32Param = OH_HUKS_DIGEST_SHA256 },</li><li>    { .tag = OH_HUKS_TAG_PADDING, .uint32Param = OH_HUKS_PADDING_PSS },</li><li>    { .tag = OH_HUKS_TAG_BLOCK_MODE, .uint32Param = OH_HUKS_MODE_ECB },</li><li>};</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHALLENGE_DATA <span class="hljs-string">"hi_challenge_data"</span></span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_challenge = { <span class="hljs-built_in">sizeof</span>(CHALLENGE_DATA), (<span class="hljs-type">uint8_t</span> *)CHALLENGE_DATA };</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">AnonAttestKey</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">/* 1.确定密钥别名 */</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> genAlias = {</li><li>        (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"test_anon_attest"</span>),</li><li>        (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"test_anon_attest"</span></li><li>    };</li><li>    <span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_anonAttestParams[] = {</li><li>        { .tag = OH_HUKS_TAG_ATTESTATION_CHALLENGE, .blob = g_challenge },</li><li>        { .tag = OH_HUKS_TAG_ATTESTATION_ID_ALIAS, .blob = genAlias },</li><li>    };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *genParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *anonAttestParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Huks_Result ohResult;</li><li>    OH_Huks_Blob certs = { <span class="hljs-number">0</span> };</li><li>    OH_Huks_CertChain certChain = { &amp;certs, <span class="hljs-number">0</span> };</li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-comment">/* 2.初始化密钥参数集 */</span></li><li>        ohResult =</li><li>            <span class="hljs-built_in">InitParamSet</span>(&amp;genParamSet, g_genAnonAttestParams, <span class="hljs-built_in">sizeof</span>(g_genAnonAttestParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult =</li><li>            <span class="hljs-built_in">InitParamSet</span>(&amp;anonAttestParamSet, g_anonAttestParams, <span class="hljs-built_in">sizeof</span>(g_anonAttestParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;genAlias, genParamSet, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        ohResult.errorCode = <span class="hljs-built_in">ConstructDataToCertChain</span>(&amp;certChain);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 3.证明密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_AnonAttestKeyItem</span>(&amp;genAlias, anonAttestParamSet, &amp;certChain);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">FreeCertChain</span>(&amp;certChain, CERT_COUNT);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;anonAttestParamSet);</li><li>    (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;genAlias, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ohResult.errorCode, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>