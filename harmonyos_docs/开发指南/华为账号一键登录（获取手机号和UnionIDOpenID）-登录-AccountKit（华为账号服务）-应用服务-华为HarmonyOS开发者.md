<h1 _ngcontent-dgb-c119="" class="doc-title ng-star-inserted" title="华为账号一键登录（获取手机号和UnionID/OpenID）"> 华为账号一键登录（获取手机号和UnionID/OpenID） </h1>

<div _ngcontent-dgb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section9166750259">概述<i class="anchor-icon anchor-icon-link" anchorid="section9166750259" tips="复制节点链接"></i></h2>          <p><span style="color: rgb(34,34,34);">华为账号一键登录是基于</span><a href="https://oauth.net/2/" target="_blank">OAuth 2.0协议标准</a><span style="color: rgb(34,34,34);">和</span><a href="https://openid.net/connect/" target="_blank">OpenID Connect协议标准</a><span style="color: rgb(34,34,34);">构建的OAuth2.0 授权登录系统，应用可以通过华为账号一键登录能力快捷地获取华为账号用户的身份标识和手机号，快速建立应用内的用户体系。</span></p>     <p><strong>优势：</strong></p>     <ul>      <li><span style="color: rgb(48,48,48);">利用系统账号的安全性和便利性，用户无需输入账号名和密码，无需复杂的安全验证</span>，简化登录步骤，提高用户转化率。</li>      <li><span style="color: rgb(48,48,48);">提供系统验证过的手机号，关联应用已有用户</span>。</li>      <li><span style="color: rgb(48,48,48);">实现Phone、Tablet、PC/2in1、TV设备一致的登录体验。</span></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section3517618318">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section3517618318" tips="复制节点链接"></i></h2>          <p>若应用需同时获取手机号和UnionID完成用户登录，Account Kit提供了同时获取手机号和UnionID的华为账号一键登录按钮。应用可以将华为账号一键登录按钮嵌入自有的登录页，使用登录按钮获取手机号和UnionID，实现用户登录。设备登录华为账号（该账号已绑定手机号）后，一键登录获取手机号可不依赖设备插SIM卡。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>儿童账号一键登录场景：         <p>用户使用儿童账号进行登录，点击一键登录会触发Account Kit默认提供的家长验密流程（Account Kit提供的验证页，暂不可自定义），家长验密完成后可获取<span style="color: rgb(34,34,34);">用户的身份标识和手机号。并且TV设备暂不支持儿童账号。</span></p></li>        <li>手机号验证机制说明：         <p>Account Kit调用系统能力获取华为账号登录设备上的SIM卡手机号码，与华为账号绑定的手机号进行校验（有网络即可，无需使用SIM卡移动数据）。用户点击一键登录按钮后，结合华为账号使用过程中账号所绑定的手机号短信验证记录，90天内有验证通过的记录，则返回该华为账号绑定的手机号；若90天内没有验证通过的记录，则触发Account Kit默认提供的短信验证流程（Account Kit提供的验证页，暂不可自定义），确保返回的手机号经过验证。</p></li>       </ol>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section2942427314">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2942427314" tips="复制节点链接"></i></h2>          <ol>      <li>应用满足《<a href="http://www.cac.gov.cn/2021-03/22/c_1617990997054277.htm" target="_blank">常见类型移动互联网应用程序必要个人信息范围规定</a>》中使用手机号的必要业务场景。</li>      <li>使用华为账号一键登录功能用户必须同意<a href="https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN" target="_blank">《华为账号用户认证协议》</a>，当用户点击<a href="https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN" target="_blank">《华为账号用户认证协议》</a>，系统浅色模式下应用需跳转到如下链接<a href="https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN" target="_blank">https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN</a>，系统深色模式下跳转到<a href="https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN&amp;bgmode=black" target="_blank">https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN&amp;bgmode=black</a>。</li>      <li>应用在用户同意后获取到手机号，需要根据自身业务场景判断使用的方式，必要时增加其他安全验证手段，比如对二次放号的判断。</li>      <li>华为账号一键登录服务当前仅限中国境内（不包含中国香港、中国澳门、中国台湾）用户可用。</li>      <li>应用服务端获取华为账号绑定号码时，该服务器必须部署在中国境内（不包含中国香港、中国澳门、中国台湾）。</li>      <li>华为账号一键登录支持Phone、Tablet、PC/2in1设备。并且从5.1.1(19)版本开始，新增支持TV设备。</li>      <li>仅支持企业开发者使用一键登录，个人开发者请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-unionid-login">华为账号登录</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-silent-login">静默登录</a>实现登录。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section124762038203511">用户体验设计<i class="anchor-icon anchor-icon-link" anchorid="section124762038203511" tips="复制节点链接"></i></h2>          <p><span><img height="309.225" originheight="4536" originwidth="7680" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114539.36487342332017800702071903299427:50001231000000:2800:4FB4A10BE2D79E67F206859CEA5C78AFD38FB2B6E0382D69BDA0905C56CAF9AE.png" title="点击放大" width="523.6875"></span></p>     <p></p>     <p><span><img height="313.4012" originheight="4536" originwidth="9336" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114540.65290940124552655601135338500800:50001231000000:2800:0979078BA6220931948FDC3368D7D1A4BA175CA35FD8829D247FEF0951F2310C.png" title="点击放大" width="645.0500000000001"></span></p>     <p></p>    </div>    <div class="tiledSection">     <h2 id="section2558741102912">登录页面UX设计规范<i class="anchor-icon anchor-icon-link" anchorid="section2558741102912" tips="复制节点链接"></i></h2>          <p><span><img height="310.2358" originheight="1936" originwidth="4150" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114540.68851270464041534959183160657274:50001231000000:2800:D3C2134E1E1E08E7B3FFFDAEE720590C34DD2344A840D656E23073493220BB02.png" title="点击放大" width="665"></span></p>     <p>一键登录按钮的用户体验和UX设计需符合<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/id-0000001880001344#section41792374210" target="_blank">【华为账号一键登录】按钮</a>规范，用户体验设计图2中的华为标志按钮可参考<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/id-0000001880001344#section61791745172816" target="_blank">华为账号登录视觉规范</a>中的样式三。不符合规范的UX设计可能会对应用上架和用户体验带来影响。一键登录按钮的样式设计具体可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section19823216112610" target="_blank">华为账号登录按钮类型</a>。</p>    </div>    <div class="tiledSection">     <h2 id="section4654113502814">用户场景设计<i class="anchor-icon anchor-icon-link" anchorid="section4654113502814" tips="复制节点链接"></i></h2>          <p>用户使用华为账号一键登录能力，注册/登录应用时，可能存在多种场景，应用可参考如下流程，根据自身业务场景进行设计。</p>     <div class="p">      <span><img height="625.4325" originheight="5079" originwidth="4250" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114540.64158870992195119702512920713636:50001231000000:2800:19D1FD893CF5F22A98B9194F48EE415039EF42878591B4FB287571B4FF77B29F.png" title="点击放大" width="523.6875"></span>      <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">        <p><strong>将UnionID/OpenID和手机号同时与应用账号建立关联，可以为用户带来更多便利的功能。如：实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-silent-login">静默登录</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-get-user-info">获取华为账号用户信息</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-get-risklevel-byquicklogin">获取华为账号风险等级</a>等。</strong><strong>实现免用户操作登录，获得安全快捷的应用登录体验。</strong></p>       </div></div></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section15857192215104">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section15857192215104" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section789652601816" class="firsth2">用户首次登录应用<i class="anchor-icon anchor-icon-link" anchorid="section789652601816" tips="复制节点链接"></i></h3>          <p>若应用未接入过华为账号登录，不存在使用华为账号登录过的应用账号，请参考如下流程接入华为账号一键登录。</p>    </div>    <div class="fignone">     <span class="figcap"><b>图1 </b>华为账号一键登录（用户首次登录应用）流程图</span>    </div>    <p><span><img height="366.08250000000004" originheight="5075" originwidth="7257" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114540.05996059871294950998533572081626:50001231000000:2800:10553578DF36966B7CAB62F8DCA5139FED608A00AED81473E68E6D78D5D36301.png" title="点击放大" width="523.6875"></span></p>    <p>流程说明：</p>    <ol>     <li>预取号阶段（序号1-4）：      <ol>       <li>用户打开应用后，应用scope传quickLoginAnonymousPhone调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>授权请求获取匿名手机号。如果获取到匿名手机号为空，应用需要展示其他登录方式。        <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">          <p>获取匿名手机号需要进行超时处理，应用可根据实际场景设置超时时间，推荐设置5秒保证用户体验。</p>         </div></div></div></li>       <li>若华为账号未登录，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>授权请求会返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-error-code#section539558125020" target="_blank">1001502001 用户未登录华为账号</a>错误码，此时应用需要展示其他登录方式进行应用登录。</li>      </ol></li>     <li>展示一键登录页面阶段（序号5）：      <ol>       <li>获取到的匿名手机号需要展示在页面上并设置好隐私协议，设置登录按钮类型为LoginType.QUICK_LOGIN，展示包含<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-huawei-id-button#section1624716107193" target="_blank">LoginWithHuaweiIDButton</a>组件的一键登录页面。应用可结合实际登录风控场景，组件参数传入风险等级标识<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-get-risklevel-byquicklogin">获取华为账号风险等级</a>，通过华为账号一键登录获取用户风险等级，对恶意账号进行风控，提升应用的安全等级。</li>      </ol></li>     <li>点击一键登录关联用户账号阶段（序号6-16）：      <ol>       <li>用户同意协议后，点击华为账号一键登录按钮，应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section1862534912215" target="_blank">HuaweiIDCredential</a>获取到Authorization Code等数据。</li>       <li>将获取的Authorization Code数据传给应用服务端，应用服务端通过Authorization Code调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-user-info-quicklogin-by-code#section2520125725115" target="_blank">/oauth2/v6/quickLogin/getPhoneNumber接口</a>获取用户完整手机号和UnionID、OpenID。</li>       <li>应用通过关联用户手机号和UnionID、OpenID完成用户登录。</li>      </ol></li>    </ol>    <div class="tiledSection">     <h3 id="section3449182042013">用户非首次登录应用（可选）<i class="anchor-icon anchor-icon-link" anchorid="section3449182042013" tips="复制节点链接"></i></h3>          <p>应用接入过华为账号登录，存在使用华为账号登录过的用户账号，即根据UnionID/OpenID判断用户已关联过应用系统数据库，则需要参考如下流程开发。</p>     <div class="fignone">      <span class="figcap"><b>图2 </b>华为账号一键登录（用户非首次登录应用）流程图</span>     </div>     <p><span><img height="252.3675" originheight="3625" originwidth="7494" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114541.37711834244358729579720793506450:50001231000000:2800:5B8110CB8D27F6C113F6A86BC50B6D7A5CC5540FC46E743539265B86713F583A.png" title="点击放大" width="523.6875"></span></p>     <p>流程说明：</p>     <ol>      <li>应用调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>授权请求获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section10418450161620" target="_blank">AuthorizationWithHuaweiIDResponse</a>响应结果中的Authorization Code。</li>      <li>应用服务端通过Authorization Code调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-user-info-quicklogin-by-code#section2520125725115" target="_blank">/oauth2/v6/quickLogin/getPhoneNumber接口</a>获取用户相关信息。通过Authorization Code凭证获取用户信息可以有效避免黑客通过数据遍历、身份伪造、重放攻击等手段导致的安全风险。</li>      <li>应用对用户身份标识UnionID/OpenID、业务登录凭证SessionId信息进行认证后，通过UnionID/OpenID判断用户是否已关联应用系统数据库，如已关联，结合风控、安全因素及自身业务场景判断，可展示已关联的账号，由用户选择是否使用华为账号登录应用，或免用户操作，静默登录应用。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1453013601016">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1453013601016" tips="复制节点链接"></i></h2>         </div>    <p>华为账号一键登录按钮关键接口如下表所示：</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.16.1.3.1.1" valign="top" width="49.1%">         <p>接口名</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.16.1.3.1.2" valign="top" width="50.9%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section610319714214" target="_blank">createAuthorizationWithHuaweiIDRequest</a>(): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>获取授权接口，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>传入一键登录的scope：quickLoginAnonymousPhone，即可在授权结果中获取到用户的匿名化手机号和Authorization Code。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section9716526428" target="_blank">constructor</a>(context?: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-common#context" target="_blank">common.Context</a>)</p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>创建授权请求Controller。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section3975181884311" target="_blank">executeRequest</a>(request: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section3118182610348" target="_blank">AuthenticationRequest</a>): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section2697164193515" target="_blank">AuthenticationResponse</a>&gt;</p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>通过Promise方式执行授权操作。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-huawei-id-button#section1624716107193" target="_blank">LoginWithHuaweiIDButton</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>华为账号Button登录组件。</p>         <p>该组件仅纯文本样式支持华为账号一键登录功能。开发者可以通过调整按钮的大小、圆角等参数以适配HarmonyOS应用登录界面。如果仍然不能满足开发者的诉求，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section19823216112610" target="_blank">Style</a>的BUTTON_CUSTOM值定义按钮的文字颜色和背景色。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section1171153745914" target="_blank">onClickLoginWithHuaweiIDButton</a>(callback: AsyncCallback&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section1862534912215" target="_blank">HuaweiIDCredential</a>&gt;): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section6921622144614" target="_blank">LoginWithHuaweiIDButtonController</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>注册华为账号一键登录按钮的结果回调。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section20291953195314" target="_blank">setAgreementStatus</a>(agreementStatus: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section183397331373" target="_blank">AgreementStatus</a>): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section6921622144614" target="_blank">LoginWithHuaweiIDButtonController</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>设置协议状态方法。用户未同意协议前设置协议状态为NOT_ACCEPTED，用户同意协议后设置协议状态为ACCEPTED，才可以完成华为账号登录。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section1892092034820" target="_blank">onClickEvent</a>(callback: AsyncCallback&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section967316103272" target="_blank">ClickEvent</a>&gt;): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section6921622144614" target="_blank">LoginWithHuaweiIDButtonController</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>注册华为账号一键登录按钮的点击事件回调。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="49.1%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section9921053045" target="_blank">continueLogin</a>(callback: AsyncCallback&lt;void&gt;): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-component-manager#section6921622144614" target="_blank">LoginWithHuaweiIDButtonController</a></p></td>        <td class="cellrowborder" valign="top" width="50.9%">         <p>用户点击协议弹框的同意并登录按钮结果回调。</p></td>       </tr>           </tbody></table></div>    </div>    <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">      <p>上述接口需在页面或自定义组件生命周期内调用。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="section95093591227">开发前提<i class="anchor-icon anchor-icon-link" anchorid="section95093591227" tips="复制节点链接"></i></h2>          <ol>      <li>在进行代码开发前，请先确认已完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-preparations">开发准备</a>工作。       <p>若未配置签名和指纹，将报错<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-1">1001500001 应用指纹证书校验失败</a>。</p>       <p>若未申请“华为账号一键登录”权限，将报错<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-2">1001502014 应用未申请scopes或permissions权限</a>。</p></li>      <li>若应用开启了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation-guide" target="_blank">代码混淆</a>，应用工程代码中获取到的quickLoginAnonymousPhone（匿名手机号）属性需要配置混淆白名单防止编译release包时被混淆，否则无法获取到匿名手机号。在调用获取匿名手机号方法工程模块的混淆文件obfuscation-rules.txt中添加：       <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li># 开发者开启属性混淆需要配置quickLoginAnonymousPhone属性白名单防止其被混淆</li><li>-enable-property-obfuscation</li><li>-keep-property-name</li><li>quickLoginAnonymousPhone</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section834212543125">客户端开发<i class="anchor-icon anchor-icon-link" anchorid="section834212543125" tips="复制节点链接"></i></h2>          <p>开发者可参考下述内容自行开发，也可使用Account Kit为常见的三方开发框架（Flutter、H5、React-Native、uni-app）提供的SampleCode示例工程，用于接入<span style="color: rgb(34,34,34);">华为账号一键登录能力</span>，具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-18">三方开发框架接入华为账号一键登录</a>进行开发。</p>    </div>    <div class="tiledSection">     <h3 id="section44701937172920" class="firsth2">用户首次登录应用<i class="anchor-icon anchor-icon-link" anchorid="section44701937172920" tips="复制节点链接"></i></h3>          <ol>      <li id="li14938717193220"><span>导入模块</span>       <p></p>       <div class="p">        导入Account Kit的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication" target="_blank">authentication</a>模块及相关公共模块。        <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { authentication } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AccountKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       </div>       <p></p></li>      <li id="li146111330184515"><span>获取匿名手机号</span>       <p></p>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication" target="_blank">authentication</a>模块的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section12940173017165" target="_blank">AuthorizationWithHuaweiIDRequest</a>请求获取华为账号用户的匿名手机号。匿名手机号用于登录页面展示。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>该场景下forceAuthorization参数需设置为false。</p>        </div></div></div>       <p>根据获取的响应结果判断，可能存在以下场景：</p>       <div class="p">        1）返回ArkTS错误码，开发者可参考下表针对不同错误码进行处理：         <div class="tablenoborder">                  <div class="tbBox"><table id="table269794534618" class="layoutFixed idpTab">          <caption>           <b>表1 </b>获取匿名手机号错误码处理          </caption>          <thead>           <tr>            <th align="left" class="cellrowborder" id="mcps1.3.20.2.2.2.4.1.2.4.1.1" valign="top" width="16.7%">             <p>错误码</p></th>            <th align="left" class="cellrowborder" id="mcps1.3.20.2.2.2.4.1.2.4.1.2" valign="top" width="24.279999999999998%">             <p>错误描述</p></th>            <th align="left" class="cellrowborder" id="mcps1.3.20.2.2.2.4.1.2.4.1.3" valign="top" width="59.019999999999996%">             <p>处理建议</p></th>           </tr>          </thead>                     <tbody><tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001502001</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>用户未登录华为账号</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>应用展示其他登录方式</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001502005</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>网络异常</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>提示用户检查当前网络状态后重试</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001502009</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>内部错误</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>应用展示其他登录方式</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001502014</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>应用未申请scopes或permissions权限</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-2">1001502014 应用未申请scopes或permissions权限的可能原因和解决方法</a>解决该报错</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001500001</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>应用指纹证书校验失败</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-1">1001500001 应用指纹证书校验失败的可能原因和解决办法</a>解决该报错</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001500002</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>重复请求</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>重复请求，应用无需处理</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>1001500003</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>不支持该scopes或permissions</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>1、华为账号用户注册地可能非中国境内（不包含中国香港、中国澳门、中国台湾），应用展示其他登录方式</p>             <p>2、仅在5.1.1（19）支持TV设备，其他版本应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-unionid-login">华为账号登录</a>进行登录</p></td>           </tr>           <tr>            <td class="cellrowborder" valign="top" width="16.7%">             <p>12300001</p></td>            <td class="cellrowborder" valign="top" width="24.279999999999998%">             <p>系统服务异常</p></td>            <td class="cellrowborder" valign="top" width="59.019999999999996%">             <p>应用展示其他登录方式</p></td>           </tr>                   </tbody></table></div>        </div>       </div>       <p>2）获取到的匿名手机号为空，说明华为账号没有绑定手机号、权限未申请或未生效，上述异常场景应用需要展示其他登录方式。</p>       <div class="p">        3）开发者如果开启了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation-guide" target="_blank">代码混淆</a>，quickLoginAnonymousPhone（匿名手机号）属性需要配置混淆白名单防止被混淆。        <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-title function_">getQuickLoginAnonymousPhone</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 创建授权请求，并设置参数</span></li><li>    <span class="hljs-keyword">const</span> authRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createAuthorizationWithHuaweiIDRequest</span>();</li><li>    <span class="hljs-comment">// 获取匿名手机号需传quickLoginAnonymousPhone这个scope，传参之前需要先申请“华为账号一键登录”权限，否则会返回1001502014错误码</span></li><li>    authRequest.<span class="hljs-property">scopes</span> = [<span class="hljs-string">'quickLoginAnonymousPhone'</span>];</li><li>    <span class="hljs-comment">// 用于防跨站点请求伪造</span></li><li>    authRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();</li><li>    <span class="hljs-comment">// 一键登录场景该参数必须设置为false</span></li><li>    authRequest.<span class="hljs-property">forceAuthorization</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      controller.<span class="hljs-title function_">executeRequest</span>(authRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: authentication.AuthorizationWithHuaweiIDResponse</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 获取到匿名手机号</span></li><li>        <span class="hljs-keyword">const</span> anonymousPhone = response.<span class="hljs-property">data</span>?.<span class="hljs-property">extraInfo</span>?.<span class="hljs-property">quickLoginAnonymousPhone</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>        <span class="hljs-keyword">if</span> (anonymousPhone) {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in authentication.'</span>);</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">quickLoginAnonymousPhone</span>: <span class="hljs-built_in">string</span> = anonymousPhone;</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in authentication. AnonymousPhone is empty.'</span>);</li><li>        <span class="hljs-comment">// 未获取到匿名手机号，应用需要跳转到其他方式登录页面</span></li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealAllError</span>(error);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 错误处理</span></li><li>  <span class="hljs-title function_">dealAllError</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>      <span class="hljs-string">`Failed to get quickLoginAnonymousPhone, errorCode is <span class="hljs-subst">${error.code}</span>, errorMessage is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span></li><li>    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {</li><li>      <span class="hljs-comment">// 华为账号未登录，应用需要展示其他登录方式</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {</li><li>      <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或展示其他登录方式</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {</li><li>      <span class="hljs-comment">// 登录失败，应用需要展示其他登录方式</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {</li><li>      <span class="hljs-comment">// 系统服务异常，应用需要展示其他登录方式</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {</li><li>      <span class="hljs-comment">// 重复请求，应用无需处理</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 应用登录失败，应用需要展示其他登录方式</span></li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {</li><li>    <span class="hljs-comment">// 账号未登录</span></li><li>    <span class="hljs-variable constant_">ERROR_CODE_LOGIN_OUT</span> = <span class="hljs-number">1001502001</span>,</li><li>    <span class="hljs-comment">// 网络错误</span></li><li>    <span class="hljs-variable constant_">ERROR_CODE_NETWORK_ERROR</span> = <span class="hljs-number">1001502005</span>,</li><li>    <span class="hljs-comment">// 内部错误</span></li><li>    <span class="hljs-variable constant_">ERROR_CODE_INTERNAL_ERROR</span> = <span class="hljs-number">1001502009</span>,</li><li>    <span class="hljs-comment">// 系统服务异常</span></li><li>    <span class="hljs-variable constant_">ERROR_CODE_SYSTEM_SERVICE</span> = <span class="hljs-number">12300001</span>,</li><li>    <span class="hljs-comment">// 重复请求</span></li><li>    <span class="hljs-variable constant_">ERROR_CODE_REQUEST_REFUSE</span> = <span class="hljs-number">1001500002</span></li><li>  }</li></ol></pre></div></div>       </div>       <p></p></li>      <li id="li8130114016451"><span>展示一键登录页面并获取Authorization Code</span>       <p></p>       <p>将获取到的匿名手机号设置给下面QuickLoginButtonComponent组件示例代码中的<strong>quickLoginAnonymousPhone</strong>变量，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-huawei-id-button" target="_blank">LoginWithHuaweiIDButton</a>组件，实现应用自己的登录页面，并展示华为账号一键登录按钮和华为账号用户认证协议（Account Kit提供跳转链接，应用需实现协议跳转，参见<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section2942427314">约束与限制</a>第2点），用户同意协议并点击一键登录按钮后，可获取到Authorization Code，将该值传给应用服务端用于获取用户信息（完整手机号、UnionID、OpenID）。通过code凭证获取用户信息可以有效避免因<span style="color: rgb(64,64,64);">数据遍历</span>、身份伪造、重放攻击导致的安全风险。</p>       <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { loginComponentManager, <span class="hljs-title class_">LoginWithHuaweiIDButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AccountKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { connection } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">QuickLoginComponent</span> {</li><li>  <span class="hljs-comment">// 第二步获取的匿名化手机号传到此处</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">quickLoginAnonymousPhone</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">quickLoginAnonymousPhone</span>) {</li><li>      <span class="hljs-title class_">QuickLoginButtonComponent</span>({</li><li>        <span class="hljs-attr">quickLoginAnonymousPhone</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">quickLoginAnonymousPhone</span></li><li>      })</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 授权获取匿名手机号为空时，请应用自行实现其他方式登录页面</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">QuickLoginButtonComponent</span> {</li><li>  <span class="hljs-attr">logTag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'QuickLoginButtonComponent'</span>;</li><li>  <span class="hljs-attr">domainId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0x0000</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">quickLoginAnonymousPhone</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// 是否勾选协议</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isSelected</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// 华为账号用户认证协议链接，此处仅为示例，实际开发过程中，出于可维护性、安全性等方面考虑，域名不建议硬编码在本地</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">USER_AUTHENTICATION_PROTOCOL</span>: <span class="hljs-built_in">string</span> =</li><li>    <span class="hljs-string">'https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">USER_SERVICE_TAG</span> = <span class="hljs-string">'用户服务协议'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">PRIVACY_TAG</span> = <span class="hljs-string">'隐私协议'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">USER_AUTHENTICATION_TAG</span> = <span class="hljs-string">'华为账号用户认证协议'</span>;</li><li>  <span class="hljs-comment">// 定义LoginWithHuaweiIDButton展示的隐私文本，展示应用的用户服务协议、隐私协议和华为账号用户认证协议</span></li><li>  <span class="hljs-attr">privacyText</span>: loginComponentManager.<span class="hljs-property">PrivacyText</span>[] = [{</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'已阅读并同意'</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">PLAIN_TEXT</span></li><li>  }, {</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'《用户服务协议》'</span>,</li><li>    <span class="hljs-attr">tag</span>: <span class="hljs-title class_">QuickLoginButtonComponent</span>.<span class="hljs-property">USER_SERVICE_TAG</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">RICH_TEXT</span></li><li>  }, {</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'《隐私协议》'</span>,</li><li>    <span class="hljs-attr">tag</span>: <span class="hljs-title class_">QuickLoginButtonComponent</span>.<span class="hljs-property">PRIVACY_TAG</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">RICH_TEXT</span></li><li>  }, {</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'和'</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">PLAIN_TEXT</span></li><li>  }, {</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'《华为账号用户认证协议》'</span>,</li><li>    <span class="hljs-attr">tag</span>: <span class="hljs-title class_">QuickLoginButtonComponent</span>.<span class="hljs-property">USER_AUTHENTICATION_TAG</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">RICH_TEXT</span></li><li>  }, {</li><li>    <span class="hljs-attr">text</span>: <span class="hljs-string">'。'</span>,</li><li>    <span class="hljs-attr">type</span>: loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">PLAIN_TEXT</span></li><li>  }];</li><li>  <span class="hljs-comment">// 构造LoginWithHuaweiIDButton组件的控制器</span></li><li>  <span class="hljs-attr">controller</span>: loginComponentManager.<span class="hljs-property">LoginWithHuaweiIDButtonController</span> =</li><li>    <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">LoginWithHuaweiIDButtonController</span>()</li><li>      <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">       * 当应用使用自定义的登录页时，如果用户未同意协议，需要设置协议状态为NOT_ACCEPTED，当用户同意协议后再设置</span></li><li><span class="hljs-comment">       * 协议状态为ACCEPTED，才可以使用华为账号一键登录功能</span></li><li><span class="hljs-comment">       */</span></li><li>      .<span class="hljs-title function_">setAgreementStatus</span>(loginComponentManager.<span class="hljs-property">AgreementStatus</span>.<span class="hljs-property">NOT_ACCEPTED</span>)</li><li>      .<span class="hljs-title function_">onClickLoginWithHuaweiIDButton</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError | <span class="hljs-literal">undefined</span>,</span></span></li><li><span class="hljs-function">        response: loginComponentManager.HuaweiIDCredential</span>) =&gt; {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleLoginWithHuaweiIDButton</span>(error, response);</li><li>      })</li><li>      .<span class="hljs-title function_">onClickEvent</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError, clickEvent: loginComponentManager.ClickEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>            <span class="hljs-string">`onClickEvent error. errCode is <span class="hljs-subst">${error?.code}</span>, errMessage is <span class="hljs-subst">${error?.message}</span>`</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`onClickEvent clickEvent: <span class="hljs-subst">${clickEvent}</span>`</span>);</li><li>        <span class="hljs-comment">// 设置按钮为不可点击态，待业务逻辑处理完成后，再设置为可点击态</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">false</span>);</li><li>      });</li><li>  <span class="hljs-attr">agreementDialog</span>: <span class="hljs-title class_">CustomDialogController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDialogController</span>({</li><li>    <span class="hljs-attr">builder</span>: <span class="hljs-title class_">AgreementDialog</span>({</li><li>      <span class="hljs-attr">privacyText</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">privacyText</span>,</li><li>      <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agreementDialog</span>.<span class="hljs-title function_">close</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setAgreementStatus</span>(loginComponentManager.<span class="hljs-property">AgreementStatus</span>.<span class="hljs-property">NOT_ACCEPTED</span>);</li><li>      },</li><li>      <span class="hljs-attr">confirm</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agreementDialog</span>.<span class="hljs-title function_">close</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSelected</span> = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setAgreementStatus</span>(loginComponentManager.<span class="hljs-property">AgreementStatus</span>.<span class="hljs-property">ACCEPTED</span>);</li><li>        <span class="hljs-comment">// 调用此方法，同意协议与登录一并完成，无需再次点击登录按钮</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">continueLogin</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>              <span class="hljs-string">`Failed to login with agreementDialog. errCode is <span class="hljs-subst">${error.code}</span>, errMessage is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>              <span class="hljs-string">'Succeeded in clicking agreementDialog continueLogin.'</span>);</li><li>          }</li><li>        });</li><li>      },</li><li>      <span class="hljs-attr">clickHyperlinkText</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agreementDialog</span>.<span class="hljs-title function_">close</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpToPrivacyWebView</span>();</li><li>      }</li><li>    }),</li><li>    <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">false</span>,</li><li>    <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Center</span>,</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 传递页面渲染所需的数据，如匿名手机号等</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Toast提示</span></li><li>  <span class="hljs-title function_">showToast</span>(<span class="hljs-params">resource: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-attr">message</span>: resource,</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span></li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span></li><li>      <span class="hljs-keyword">const</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span></li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`showToast args  errCode is <span class="hljs-subst">${code}</span>, errMessage is <span class="hljs-subst">${message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 跳转华为账号用户认证协议页，该页面需在工程main_pages.json文件配置</span></li><li>  <span class="hljs-title function_">jumpToPrivacyWebView</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 需在module.json5中配置“ohos.permission.GET_NETWORK_INFO”权限</span></li><li>      <span class="hljs-keyword">const</span> checkNetConn = connection.<span class="hljs-title function_">hasDefaultNetSync</span>();</li><li>      <span class="hljs-keyword">if</span> (!checkNetConn) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">'服务或网络异常，请稍后重试'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> message = error.<span class="hljs-property">message</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">const</span> code = error.<span class="hljs-property">code</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to hasDefaultNetSync, errCode is <span class="hljs-subst">${code}</span>, errMessage is <span class="hljs-subst">${message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">pushUrl</span>({</li><li>      <span class="hljs-comment">// 需在module.json5配置“ohos.permission.INTERNET”网络权限</span></li><li>      <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/WebPage'</span>,</li><li>      <span class="hljs-attr">params</span>: {</li><li>        <span class="hljs-attr">isFromDialog</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">url</span>: <span class="hljs-title class_">QuickLoginButtonComponent</span>.<span class="hljs-property">USER_AUTHENTICATION_PROTOCOL</span>,</li><li>      }</li><li>    }, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>          <span class="hljs-string">`Failed to jumpToPrivacyWebView, errCode is <span class="hljs-subst">${err.code}</span>, errMessage is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">handleLoginWithHuaweiIDButton</span>(<span class="hljs-params">error: BusinessError | <span class="hljs-literal">undefined</span>,</span></li><li><span class="hljs-params">    response: loginComponentManager.HuaweiIDCredential</span>) {</li><li>    <span class="hljs-keyword">if</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>        <span class="hljs-string">`Failed to login with LoginWithHuaweiIDButton. errCode is <span class="hljs-subst">${error.code}</span>, errMessage is <span class="hljs-subst">${error.message}</span>`</span>);     </li><li>      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>(</li><li>          {</li><li>            <span class="hljs-attr">message</span>: <span class="hljs-string">"网络未连接，请检查网络设置。"</span>,</li><li>            <span class="hljs-attr">offset</span>: { <span class="hljs-attr">dx</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">dy</span>: -<span class="hljs-number">12</span> },</li><li>            <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Bottom</span>,</li><li>            <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">false</span>,</li><li>            <span class="hljs-attr">confirm</span>: {</li><li>              <span class="hljs-attr">value</span>: <span class="hljs-string">"知道了"</span>,</li><li>              <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>              }</li><li>            }</li><li>          }</li><li>        );</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span>) {</li><li>        <span class="hljs-comment">// 未同意协议，弹出协议弹框，推荐使用该回调方式</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agreementDialog</span>.<span class="hljs-title function_">open</span>();</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {</li><li>        <span class="hljs-comment">// 华为账号未登录提示</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">"华为账号未登录，请重试"</span>);</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NOT_SUPPORTED</span>) {</li><li>        <span class="hljs-comment">// 不支持该scopes或permissions提示</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">"该scopes或permissions不支持"</span>);</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_PARAMETER_ERROR</span>) {</li><li>        <span class="hljs-comment">// 参数错误提示</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">"参数错误"</span>);</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {</li><li>        <span class="hljs-comment">// 用户取消，无需特别处理</span></li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// 其他提示系统或服务异常</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">'服务或网络异常，请稍后重试'</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSelected</span>) {</li><li>        <span class="hljs-keyword">if</span> (response) {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'Succeeded in clicking LoginWithHuaweiIDButton.'</span>);</li><li>          <span class="hljs-comment">// 开发者根据实际业务情况使用以下信息</span></li><li>          <span class="hljs-keyword">const</span> authCode = response.<span class="hljs-property">authorizationCode</span>;</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agreementDialog</span>.<span class="hljs-title function_">open</span>();</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>        <span class="hljs-string">`Failed to login with LoginWithHuaweiIDButton, errCode: <span class="hljs-subst">${err.code}</span>, errMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>(</li><li>        {</li><li>          <span class="hljs-attr">message</span>: <span class="hljs-string">'服务或网络异常，请稍后重试'</span>,</li><li>          <span class="hljs-attr">offset</span>: { <span class="hljs-attr">dx</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">dy</span>: -<span class="hljs-number">12</span> },</li><li>          <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Bottom</span>,</li><li>          <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">false</span>,</li><li>          <span class="hljs-attr">confirm</span>: {</li><li>            <span class="hljs-attr">value</span>: <span class="hljs-string">'知道了'</span>,</li><li>            <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>            }</li><li>          }</li><li>        }</li><li>      );</li><li>    } <span class="hljs-keyword">finally</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">true</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Scroll</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-comment">// 此处为示例资源，开发者可使用应用图标进行替换，以保证正常编译运行</span></li><li>            <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.app_icon'</span>))</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-number">48</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">48</span>)</li><li>              .<span class="hljs-title function_">draggable</span>(<span class="hljs-literal">false</span>)</li><li>              .<span class="hljs-title function_">copyOption</span>(<span class="hljs-title class_">CopyOptions</span>.<span class="hljs-property">None</span>)</li><li>              .<span class="hljs-title function_">onComplete</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'appIcon loading success.'</span>);</li><li>              })</li><li>              .<span class="hljs-title function_">onError</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'appIcon loading fail.'</span>);</li><li>              })</li><li>
</li><li>            <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.app_name'</span>))</li><li>              .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">maxFontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_headline8'</span>))</li><li>              .<span class="hljs-title function_">minFontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body1'</span>))</li><li>              .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary'</span>))</li><li>              .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">maxWidth</span>: <span class="hljs-string">'100%'</span> })</li><li>              .<span class="hljs-title function_">margin</span>({</li><li>                <span class="hljs-attr">top</span>: <span class="hljs-number">12</span>,</li><li>              })</li><li>
</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'应用描述'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body2'</span>))</li><li>              .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_secondary'</span>))</li><li>              .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_regular'</span>))</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Regular</span>)</li><li>              .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">maxWidth</span>: <span class="hljs-string">'100%'</span> })</li><li>              .<span class="hljs-title function_">margin</span>({</li><li>                <span class="hljs-attr">top</span>: <span class="hljs-number">8</span>,</li><li>              })</li><li>          }.<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">100</span></li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">quickLoginAnonymousPhone</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary'</span>))</li><li>              .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>              .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">48</span>)</li><li>              .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>              .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">maxWidth</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">minHeight</span>: <span class="hljs-number">48</span> })</li><li>
</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'华为账号绑定号码'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body2'</span>))</li><li>              .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_secondary'</span>))</li><li>              .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_regular'</span>))</li><li>              .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Regular</span>)</li><li>              .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">19</span>)</li><li>              .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>              .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">maxWidth</span>: <span class="hljs-string">'100%'</span> })</li><li>              .<span class="hljs-title function_">margin</span>({</li><li>                <span class="hljs-attr">top</span>: <span class="hljs-number">8</span></li><li>              })</li><li>          }.<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">64</span></li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">LoginWithHuaweiIDButton</span>({</li><li>              <span class="hljs-attr">params</span>: {</li><li>                <span class="hljs-comment">// LoginWithHuaweiIDButton支持的样式</span></li><li>                <span class="hljs-attr">style</span>: loginComponentManager.<span class="hljs-property">Style</span>.<span class="hljs-property">BUTTON_RED</span>,</li><li>                <span class="hljs-comment">// 账号登录按钮在登录过程中展示加载态</span></li><li>                <span class="hljs-attr">extraStyle</span>: {</li><li>                  <span class="hljs-attr">buttonStyle</span>: <span class="hljs-keyword">new</span> loginComponentManager.<span class="hljs-title class_">ButtonStyle</span>().<span class="hljs-title function_">loadingStyle</span>({</li><li>                    <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span></li><li>                  })</li><li>                },</li><li>                <span class="hljs-comment">// LoginWithHuaweiIDButton的边框圆角半径</span></li><li>                <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">24</span>,</li><li>                <span class="hljs-comment">// LoginWithHuaweiIDButton支持的登录类型</span></li><li>                <span class="hljs-attr">loginType</span>: loginComponentManager.<span class="hljs-property">LoginType</span>.<span class="hljs-property">QUICK_LOGIN</span>,</li><li>                <span class="hljs-comment">// LoginWithHuaweiIDButton支持按钮的样式跟随系统深浅色模式切换</span></li><li>                <span class="hljs-attr">supportDarkMode</span>: <span class="hljs-literal">true</span></li><li>              },</li><li>              <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span></li><li>            })</li><li>          }</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">56</span></li><li>          })</li><li>
</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Button</span>({</li><li>              <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>,</li><li>              <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span></li><li>            }) {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">'其他方式登录'</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary_activated'</span>))</li><li>                .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>                .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_button1'</span>))</li><li>                .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>                .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>                .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-attr">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-property">Ellipsis</span> })</li><li>                .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>                .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">8</span> })</li><li>            }</li><li>            .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary_activated'</span>))</li><li>            .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_button_normal'</span>))</li><li>            .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>            .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>            .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-number">40</span> })</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'click optionalLoginButton.'</span>);</li><li>            })</li><li>          }.<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Checkbox</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'privacyCheckbox'</span>, <span class="hljs-attr">group</span>: <span class="hljs-string">'privacyCheckboxGroup'</span> })</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-number">24</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>)</li><li>              .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>              .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>              .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span> })</li><li>              .<span class="hljs-title function_">select</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSelected</span>)</li><li>              .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (value) {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSelected</span> = <span class="hljs-literal">true</span>;</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setAgreementStatus</span>(loginComponentManager.<span class="hljs-property">AgreementStatus</span>.<span class="hljs-property">ACCEPTED</span>);</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSelected</span> = <span class="hljs-literal">false</span>;</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setAgreementStatus</span>(loginComponentManager.<span class="hljs-property">AgreementStatus</span>.<span class="hljs-property">NOT_ACCEPTED</span>);</li><li>                }</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`agreementChecked: <span class="hljs-subst">${value}</span>`</span>);</li><li>              })</li><li>          }</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Text</span>() {</li><li>              <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">privacyText</span>, <span class="hljs-function">(<span class="hljs-params">item: loginComponentManager.PrivacyText</span>) =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (item?.<span class="hljs-property">type</span> === loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">PLAIN_TEXT</span> &amp;&amp; item?.<span class="hljs-property">text</span>) {</li><li>                  <span class="hljs-title class_">Span</span>(item?.<span class="hljs-property">text</span>)</li><li>                    .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_secondary'</span>))</li><li>                    .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_regular'</span>))</li><li>                    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Regular</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body3'</span>))</li><li>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item?.<span class="hljs-property">type</span> === loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">RICH_TEXT</span> &amp;&amp; item?.<span class="hljs-property">text</span>) {</li><li>                  <span class="hljs-title class_">Span</span>(item?.<span class="hljs-property">text</span>)</li><li>                    .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary_activated'</span>))</li><li>                    .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>                    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body3'</span>))</li><li>                    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      <span class="hljs-comment">// 应用需要根据item.tag实现协议页面的跳转逻辑</span></li><li>                      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`click privacy text tag: <span class="hljs-subst">${item.tag}</span>`</span>);</li><li>                      <span class="hljs-comment">// 华为账号用户认证协议</span></li><li>                      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">tag</span> === <span class="hljs-title class_">QuickLoginButtonComponent</span>.<span class="hljs-property">USER_AUTHENTICATION_TAG</span>) {</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">jumpToPrivacyWebView</span>();</li><li>                      }</li><li>                    })</li><li>                }</li><li>              }, <span class="hljs-function">(<span class="hljs-params">item: loginComponentManager.PrivacyText</span>) =&gt;</span> item.<span class="hljs-property">text</span>.<span class="hljs-title function_">toString</span>())</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">12</span> })</li><li>          .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>          .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-number">24</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">16</span>,</li><li>          <span class="hljs-attr">bottom</span>: <span class="hljs-number">16</span></li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>      .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-string">'100%'</span> })</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>,</li><li>        <span class="hljs-attr">right</span>: <span class="hljs-number">16</span></li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@CustomDialog</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">AgreementDialog</span> {</li><li>  <span class="hljs-attr">logTag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'AgreementDialog'</span>;</li><li>  <span class="hljs-attr">domainId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0x0000</span>;</li><li>  dialogController?: <span class="hljs-title class_">CustomDialogController</span>;</li><li>  <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {</li><li>  };</li><li>  <span class="hljs-attr">confirm</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {</li><li>  };</li><li>  <span class="hljs-attr">clickHyperlinkText</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">() =&gt;</span> {</li><li>  };</li><li>  <span class="hljs-attr">privacyText</span>: loginComponentManager.<span class="hljs-property">PrivacyText</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">USER_AUTHENTICATION_TAG</span> = <span class="hljs-string">'华为账号用户认证协议'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'用户协议与隐私条款'</span>)</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'loginPanel_agreement_dialog_privacy_title'</span>)</li><li>          .<span class="hljs-title function_">maxFontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_headline8'</span>))</li><li>          .<span class="hljs-title function_">minFontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body1'</span>))</li><li>          .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary'</span>))</li><li>          .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>          .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-attr">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-property">Ellipsis</span> })</li><li>          .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">2</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-number">56</span>, <span class="hljs-attr">maxWidth</span>: <span class="hljs-number">400</span> })</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">left</span>: $r(<span class="hljs-string">'sys.float.ohos_id_max_padding_start'</span>),</li><li>        <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'sys.float.ohos_id_max_padding_start'</span>)</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>() {</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">privacyText</span>, <span class="hljs-function">(<span class="hljs-params">item: loginComponentManager.PrivacyText</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (item?.<span class="hljs-property">type</span> === loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">PLAIN_TEXT</span> &amp;&amp; item?.<span class="hljs-property">text</span>) {</li><li>              <span class="hljs-title class_">Span</span>(item?.<span class="hljs-property">text</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body1'</span>))</li><li>                .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary'</span>))</li><li>                .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_regular'</span>))</li><li>                .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Regular</span>)</li><li>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item?.<span class="hljs-property">type</span> === loginComponentManager.<span class="hljs-property">TextType</span>.<span class="hljs-property">RICH_TEXT</span> &amp;&amp; item?.<span class="hljs-property">text</span>) {</li><li>              <span class="hljs-title class_">Span</span>(item?.<span class="hljs-property">text</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_body1'</span>))</li><li>                .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#CE0E2D'</span>)</li><li>                .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>                .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>                .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-comment">// 应用需要根据item.tag实现协议页面的跳转逻辑</span></li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`click privacy text tag: <span class="hljs-subst">${item.tag}</span>`</span>);</li><li>                  <span class="hljs-comment">// 华为账号用户认证协议</span></li><li>                  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">tag</span> === <span class="hljs-title class_">AgreementDialog</span>.<span class="hljs-property">USER_AUTHENTICATION_TAG</span>) {</li><li>                    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'AgreementDialog click.'</span>);</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clickHyperlinkText</span>();</li><li>                  }</li><li>                })</li><li>            }</li><li>          }, <span class="hljs-function">(<span class="hljs-params">item: loginComponentManager.PrivacyText</span>) =&gt;</span> item.<span class="hljs-property">text</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-attr">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-property">Ellipsis</span> })</li><li>        .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Start</span>)</li><li>        .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">24</span> })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Flex</span>({</li><li>        <span class="hljs-attr">direction</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-property">Row</span></li><li>      }) {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'取消'</span>,</li><li>          { <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>, <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span> })</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'loginPanel_agreement_cancel_btn'</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_text_primary'</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_button1'</span>))</li><li>          .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>          .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">maxWidth</span>: <span class="hljs-number">400</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'AgreementDialog cancel.'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cancel</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'同意并登录'</span>,</li><li>          { <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>, <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span> })</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">'loginPanel_agreement_dialog_huawei_id_login_btn'</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#CE0E2D'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'sys.float.ohos_id_text_size_button1'</span>))</li><li>          .<span class="hljs-title function_">fontFamily</span>($r(<span class="hljs-string">'sys.string.ohos_id_text_font_family_medium'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)</li><li>          .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-attr">minHeight</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">maxWidth</span>: <span class="hljs-number">400</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'AgreementDialog confirm.'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">confirm</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">top</span>: <span class="hljs-number">8</span>,</li><li>        <span class="hljs-attr">left</span>: $r(<span class="hljs-string">'sys.float.ohos_id_elements_margin_horizontal_l'</span>),</li><li>        <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'sys.float.ohos_id_elements_margin_horizontal_l'</span>),</li><li>        <span class="hljs-attr">bottom</span>: <span class="hljs-number">16</span></li><li>      })</li><li>    }.<span class="hljs-title function_">backgroundColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_dialog_default_bg'</span>))</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>,</li><li>      <span class="hljs-attr">right</span>: <span class="hljs-number">16</span></li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {</li><li>  <span class="hljs-comment">// 账号未登录</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_LOGIN_OUT</span> = <span class="hljs-number">1001502001</span>,</li><li>  <span class="hljs-comment">// 该账号不支持一键登录，如海外账号</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_NOT_SUPPORTED</span> = <span class="hljs-number">1001500003</span>,</li><li>  <span class="hljs-comment">// 网络错误</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_NETWORK_ERROR</span> = <span class="hljs-number">1001502005</span>,</li><li>  <span class="hljs-comment">// 内部错误</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_INTERNAL_ERROR</span> = <span class="hljs-number">1001502009</span>,</li><li>  <span class="hljs-comment">// 用户取消授权</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_USER_CANCEL</span> = <span class="hljs-number">1001502012</span>,</li><li>  <span class="hljs-comment">// 系统服务异常</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_SYSTEM_SERVICE</span> = <span class="hljs-number">12300001</span>,</li><li>  <span class="hljs-comment">// 用户未同意用户协议</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_AGREEMENT_STATUS_NOT_ACCEPTED</span> = <span class="hljs-number">1005300001</span>,</li><li>  <span class="hljs-comment">// 参数错误</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_PARAMETER_ERROR</span> = <span class="hljs-number">401</span>,</li><li>  <span class="hljs-comment">// 重复请求</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_REQUEST_REFUSE</span> = <span class="hljs-number">1001500002</span></li><li>}</li></ol></pre></div></div>       <p>以下是华为账号用户认证协议展示页示例代码：</p>       <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 华为账号用户认证协议展示页</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebPage</span> {</li><li>  <span class="hljs-meta">@State</span> webUrl?: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">logTag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'WebPage'</span>;</li><li>  <span class="hljs-attr">domainId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0x0000</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>({ <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Normal</span> }) {</li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'sys.media.ohos_ic_compnent_titlebar_back'</span>))</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)</li><li>            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>)</li><li>            .<span class="hljs-title function_">draggable</span>(<span class="hljs-literal">false</span>)</li><li>            .<span class="hljs-title function_">autoResize</span>(<span class="hljs-literal">false</span>)</li><li>            .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>            .<span class="hljs-title function_">fillColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_titlebar_icon'</span>))</li><li>            .<span class="hljs-title function_">matchTextDirection</span>(<span class="hljs-literal">true</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Start</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>($r(<span class="hljs-string">'sys.color.ohos_id_color_button_normal'</span>))</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>();</li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">top</span>: <span class="hljs-number">36</span>,</li><li>        <span class="hljs-attr">left</span>: <span class="hljs-number">16</span></li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Progress</span>({ <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">progress</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ProgressType</span>.<span class="hljs-property">Linear</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">progress</span> &lt;= <span class="hljs-number">99</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span>)</li><li>
</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webUrl</span> ?? <span class="hljs-string">''</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">60</span> })</li><li>        .<span class="hljs-title function_">onProgressChange</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>,</li><li>            <span class="hljs-string">'onProgressChange: '</span>, (event ? event.<span class="hljs-property">newProgress</span> : -<span class="hljs-number">1</span>));</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">progress</span> = event ? event.<span class="hljs-property">newProgress</span> : <span class="hljs-number">0</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">darkMode</span>(<span class="hljs-title class_">WebDarkMode</span>.<span class="hljs-property">Auto</span>)</li><li>        .<span class="hljs-title function_">forceDarkAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">onLoadIntercept</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">'onLoadIntercept'</span>);</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">onErrorReceive</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (event) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">domainId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">logTag</span>, <span class="hljs-string">`onErrorReceive,errorInfo: <span class="hljs-subst">${event?.error?.getErrorInfo()}</span>`</span>);</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">60</span> })</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'aboutToAppear'</span>);</li><li>    <span class="hljs-keyword">const</span> params = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">getParams</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webUrl</span> = params.<span class="hljs-property">url</span> ?? <span class="hljs-string">''</span>;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`webUrl: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.webUrl}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'aboutToDisappear'</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webUrl</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">stop</span>();</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section432713218526">用户非首次登录应用（可选）<i class="anchor-icon anchor-icon-link" anchorid="section432713218526" tips="复制节点链接"></i></h3>          <p>用户非首次登录应用流程请参考首次登录应用开发流程<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#li14938717193220">步骤1</a>及<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#li146111330184515">步骤2</a>，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section10418450161620" target="_blank">AuthorizationWithHuaweiIDResponse</a>响应结果中的Authorization Code。可能存在的异常场景及处理方法，可参考<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#table269794534618">表1 获取匿名手机号错误码处理</a>。</p>     <p>正确获取到Authorization Code，开发者可将Authorization Code传给应用服务端用于获取用户身份标识（UnionID、OpenID），即可查询该用户是否已关联。</p>     <p>1）如已关联，结合风控、安全因素及自身业务场景判断，可展示已关联的账号，由用户选择是否使用华为账号登录应用，或免用户操作，静默登录应用，客户端开发结束。</p>     <p>2）如未关联，则参考首次登录应用开发流程<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#li8130114016451">步骤3</a>继续开发。</p>    </div>    <div class="tiledSection">     <h3 id="section12250103482815">借助DevEco Studio辅助开发（可选）<i class="anchor-icon anchor-icon-link" anchorid="section12250103482815" tips="复制节点链接"></i></h3>          <ol>      <li>打开需要提供一键登录功能的页面，在页面的build()中创建一个容器（如Column）。</li>      <li>在DevEco Studio菜单栏点击View &gt; Tool Windows &gt; Kit Assistant，或使用快捷键Alt + K，进入Kit Assistant页面。</li>      <li>在左侧目录中点击选中AccountKit &gt; QuickLoginButton，并拖拽至新创建的容器中。即可在当前位置插入相应的代码片段。       <p><span><img height="220.44750000000002" originheight="1033" originwidth="2446" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114541.56372670988177736782766403066585:50001231000000:2800:BC2B14EF49D767063CB2A80B3A4B536EAA3AD4970DAC0D708C7D250F27AD067E.png" title="点击放大" width="523.6875"></span></p>       <p></p>       <p>若代码片段插入失败，可查询<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-kit-assistant" target="_blank">快速插入场景化代码片段</a>的说明排查原因。</p></li>      <li>在自动生成的代码段的getQuickLoginAnonymousPhone函数中，执行executeRequest函数可获取响应结果。       <div class="p">        根据获取的响应结果判断，可能存在以下场景：        <ul>         <li>已正确获取到用户匿名手机号及Authorization Code，开发者可将Authorization Code传给应用服务端用于获取用户身份标识（UnionID、OpenID），即可查询该用户是否已关联。          <p>1）如已关联，结合风控、安全因素及自身业务场景判断，可展示已关联的账号，由用户选择是否使用华为账号登录应用，或免用户操作，静默登录应用，客户端开发结束。</p>          <p>2）如未关联，再判断是否存在下面的异常场景，如无，则参考下面<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#li2579174225910">步骤5</a>继续开发。</p></li>         <li>存在如下异常场景：          <p>1）返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-error-code#section539558125020" target="_blank">1001502001 用户未登录华为账号</a>错误码，说明华为账号未登录。</p>          <p>2）返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-error-code#section116574197436" target="_blank">1001500003 不支持该scopes或permissions</a>错误码，说明华为账号用户注册地非中国境内（不包含中国香港、中国澳门、中国台湾）。</p>          <p>3）获取到的匿名手机号为空，说明华为账号没有绑定手机号、权限未申请或未生效。</p>          <p>上述异常场景应用需要展示其他登录方式。</p></li>        </ul>       </div></li>      <li id="li2579174225910">根据上述代码实现应用的登录页面，并展示华为账号一键登录按钮和华为账号用户认证协议（Account Kit提供跳转链接，应用需实现协议跳转，参见<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section2942427314">约束与限制</a>第2点），用户同意协议并点击一键登录按钮后，可获取到Authorization Code，将该值传给应用服务端用于获取用户信息（完整手机号、UnionID、OpenID）。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section286103315177">服务端开发<i class="anchor-icon anchor-icon-link" anchorid="section286103315177" tips="复制节点链接"></i></h2>          <ol>      <li>应用服务端使用Client ID、Client Secret、Authorization Code调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-user-info-quicklogin-by-code#section2520125725115" target="_blank">/oauth2/v6/quickLogin/getPhoneNumber接口</a>获取完整手机号和华为账号用户标识UnionID。</li>      <li>应用通过获取到的完整手机号或UnionID查询该用户是否已关联应用系统数据库。如已关联，则绑定获取的UnionID与手机号到已有用户上（如已绑定，则可忽略），完成用户登录；如未关联，则创建新用户并绑定手机号与UnionID到该用户上。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section4355919132013">客户端与服务端交互开发<i class="anchor-icon anchor-icon-link" anchorid="section4355919132013" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section9343175722020" class="firsth2">应用客户端到应用服务端的开发<i class="anchor-icon anchor-icon-link" anchorid="section9343175722020" tips="复制节点链接"></i></h3>          <p>业务流程：</p>     <p><span><img originheight="3194" originwidth="6038" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114541.92196584941960729303211161174458:50001231000000:2800:3B069992D9995ABE18753EBB920AC133D0E0930E262F9A0EA8E3CC5D183240BB.png" width="920" height="486.66445842994364"></span></p>     <ul>      <li>准备：</li>     </ul>     <ol>      <li>请先完成应用客户端一键登录的相关开发，相关开发指导参考<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section834212543125">客户端开发</a>；</li>      <li>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/remote-communication-netsend-arkts#section71222326515" target="_blank">使用fetch发送网络请求</a>完成客户端到服务端的接口请求，开发步骤如下；       <ol>        <li>在应用客户端调用应用服务端提供的接口，将Authorization Code传输给应用的服务端；         <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">           <p>应用客户端与应用服务端的交互安全需要应用自行保证。</p>          </div></div></div>         <div class="p">          <div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 客户端请求接口示例代码</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rcpRequest</span>(<span class="hljs-params">authCode: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// 定义请求头</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">headers</span>: rcp.<span class="hljs-property">RequestHeaders</span> = {</li><li>    <span class="hljs-string">'accept'</span>: <span class="hljs-string">'application/json'</span></li><li>  };</li><li>  <span class="hljs-comment">// 定义要传递的参数</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">postMessage</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {</li><li>    <span class="hljs-string">'authorizationCode'</span>: authCode</li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">securityConfig</span>: rcp.<span class="hljs-property">SecurityConfiguration</span> = {</li><li>    <span class="hljs-attr">tlsOptions</span>: {</li><li>      <span class="hljs-attr">tlsVersion</span>: <span class="hljs-string">'TlsV1.3'</span></li><li>    }</li><li>  };</li><li>  <span class="hljs-comment">// 假设"http://localhost:8080"为应用服务端地址</span></li><li>  <span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">'http://localhost:8080/login'</span>;</li><li>  <span class="hljs-comment">// 定义请求对象</span></li><li>  <span class="hljs-keyword">const</span> req = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">Request</span>(baseUrl, <span class="hljs-string">'POST'</span>, headers, postMessage);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 创建通信会话对象</span></li><li>    <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>({ <span class="hljs-attr">requestConfiguration</span>: { <span class="hljs-attr">security</span>: securityConfig } });</li><li>    <span class="hljs-comment">// 发起请求</span></li><li>    session.<span class="hljs-title function_">fetch</span>(req).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'getRcpResult'</span>, <span class="hljs-string">'Succeeded in getting result from server.'</span>);</li><li>      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">body</span>) {</li><li>        <span class="hljs-keyword">const</span> decoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>);</li><li>        <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(decoder.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(response.<span class="hljs-property">body</span>))) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;;</li><li>        <span class="hljs-comment">// 此为代码示例，具体实现请以业务服务端实际返回数据结构为准</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">phoneNumber</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result[<span class="hljs-string">'phone'</span>] ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">if</span> (phoneNumber) {</li><li>          <span class="hljs-comment">// 应用处理相关逻辑</span></li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'getRcpResult'</span>, <span class="hljs-string">'Failed to get response body.'</span>);</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'getRcpResult'</span>, <span class="hljs-string">`err: err code is <span class="hljs-subst">${err.code}</span>, err message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'getRcpResult'</span>, <span class="hljs-string">`err: err code is <span class="hljs-subst">${err.code}</span>, err message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>         </div></li>        <li>应用服务端提供接口用于接收应用客户端获取到的Authorization Code；         <div class="p">                                                 <div class="switchPre"><div class="preTab preTab-cn"><div class="activePre" switchpre-data="0" switchpre-lang="java">java</div><div switchpre-data="1" switchpre-lang="python">python</div><div switchpre-data="2" switchpre-lang="go">go</div><div switchpre-data="3" switchpre-lang="php">php</div></div><div class="switchPreBox"><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language=" java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> com.huawei.account.common.Response;</li><li><span class="hljs-keyword">import</span> com.huawei.account.entity.PhoneNumberResp;</li><li><span class="hljs-keyword">import</span> com.huawei.account.entity.LoginReq;</li><li><span class="hljs-keyword">import</span> com.huawei.account.service.impl.LoginService;</li><li><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;</li><li><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;</li><li><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</li><li><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</li><li>
</li><li><span class="hljs-meta">@RestController</span></li><li><span class="hljs-meta">@RequiredArgsConstructor</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickLoginController</span> {</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoginService loginService;</li><li>
</li><li>    <span class="hljs-meta">@PostMapping("/login")</span></li><li>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginReq requestBody)</span> {</li><li>        <span class="hljs-type">PhoneNumberResp</span> <span class="hljs-variable">accountInfo</span> <span class="hljs-operator">=</span> loginService.loginWithHuawei(requestBody.getAuthorizationCode());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"login success!"</span>, accountInfo);</li><li>    }</li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify</li><li>
</li><li><span class="hljs-keyword">from</span> service.loginService <span class="hljs-keyword">import</span> login_with_huawei</li><li>
</li><li>app = Flask(__name__)</li><li>
</li><li><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/login'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span></li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():</li><li>    <span class="hljs-comment"># 验证请求参数</span></li><li>    request_data = request.get_json()</li><li>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request_data <span class="hljs-keyword">or</span> <span class="hljs-string">'authorizationCode'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request_data:</li><li>        <span class="hljs-keyword">return</span> jsonify({</li><li>            <span class="hljs-string">'code'</span>: <span class="hljs-number">400</span>,</li><li>            <span class="hljs-string">'message'</span>: <span class="hljs-string">'invalid authorizationCode'</span>,</li><li>            <span class="hljs-string">'data'</span>: <span class="hljs-literal">None</span></li><li>        })</li><li>    authorization_code = request_data[<span class="hljs-string">'authorizationCode'</span>]</li><li>
</li><li>    <span class="hljs-comment"># 调用服务层</span></li><li>    user_info = login_with_huawei(authorization_code)</li><li>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_info:</li><li>        <span class="hljs-keyword">return</span> jsonify({</li><li>            <span class="hljs-string">'code'</span>: <span class="hljs-number">401</span>,</li><li>            <span class="hljs-string">'message'</span>: <span class="hljs-string">'Failed to authenticate with Huawei'</span>,</li><li>            <span class="hljs-string">'data'</span>: <span class="hljs-literal">None</span></li><li>        })</li><li>
</li><li>    <span class="hljs-comment"># 成功响应</span></li><li>    <span class="hljs-keyword">return</span> jsonify({</li><li>        <span class="hljs-string">'code'</span>: <span class="hljs-number">200</span>,</li><li>        <span class="hljs-string">'message'</span>: <span class="hljs-string">'Login successful'</span>,</li><li>        <span class="hljs-string">'data'</span>: user_info</li><li>    })</li><li>
</li><li>
</li><li><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</li><li>    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-number">8080</span>)</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="go prettyprint linenums hljs language-go" hw-language="go" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">package</span> main</li><li>
</li><li><span class="hljs-keyword">import</span> (</li><li>    loginService <span class="hljs-string">"./service"</span></li><li>    <span class="hljs-string">"encoding/json"</span></li><li>    <span class="hljs-string">"errors"</span></li><li>    <span class="hljs-string">"fmt"</span></li><li>    _ <span class="hljs-string">"fmt"</span></li><li>    <span class="hljs-string">"io/ioutil"</span></li><li>    <span class="hljs-string">"log"</span></li><li>    <span class="hljs-string">"net/http"</span></li><li>    _ <span class="hljs-string">"strconv"</span></li><li>)</li><li>
</li><li><span class="hljs-keyword">type</span> LoginRequest <span class="hljs-keyword">struct</span> {</li><li>    AuthorizationCode <span class="hljs-type">string</span> <span class="hljs-string">`json:"authorizationCode"`</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> {</li><li>    UserInfo UserInfo <span class="hljs-string">`json:"data"`</span></li><li>    Code     <span class="hljs-type">int</span>      <span class="hljs-string">`json:"code"`</span></li><li>    Message  <span class="hljs-type">string</span>   <span class="hljs-string">`json:"message"`</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">type</span> UserInfo <span class="hljs-keyword">struct</span> {</li><li>    OpenID            <span class="hljs-type">string</span> <span class="hljs-string">`json:"openId"`</span></li><li>    UnionID           <span class="hljs-type">string</span> <span class="hljs-string">`json:"unionId"`</span></li><li>    LoginMobileNumber <span class="hljs-type">string</span> <span class="hljs-string">`json:"phoneNumber"`</span></li><li>    LoginMobileValid  <span class="hljs-type">int</span>    <span class="hljs-string">`json:"phoneNumberValid"`</span></li><li>    PurePhoneNumber   <span class="hljs-type">string</span> <span class="hljs-string">`json:"purePhoneNumber"`</span></li><li>    PhoneCountryCode  <span class="hljs-type">string</span> <span class="hljs-string">`json:"phoneCountryCode"`</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">type</span> PhoneNumberErrRsp <span class="hljs-keyword">struct</span> {</li><li>    ResultCode <span class="hljs-type">int</span>    <span class="hljs-string">`json:"resultCode"`</span></li><li>    ResultDesc <span class="hljs-type">string</span> <span class="hljs-string">`json:"resultDesc"`</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">loginHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {</li><li>    <span class="hljs-comment">// 设置通用JSON响应头</span></li><li>    w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)</li><li>    <span class="hljs-comment">// 1. 请求体解析</span></li><li>    <span class="hljs-keyword">var</span> loginRequest LoginRequest</li><li>    <span class="hljs-keyword">if</span> err := parseLoginRequest(r, &amp;loginRequest); err != <span class="hljs-literal">nil</span> {</li><li>       sendErrorResponse(w, http.StatusBadRequest, <span class="hljs-string">"Invalid request format"</span>)</li><li>       <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-comment">// 2. 服务调用</span></li><li>    resp, err := loginService.LoginWithHuawei(loginRequest.AuthorizationCode)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       log.Printf(<span class="hljs-string">"Login service error: %v"</span>, err)</li><li>       sendErrorResponse(w, http.StatusInternalServerError, <span class="hljs-string">"Authentication failed"</span>)</li><li>       <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">defer</span> resp.Body.Close()</li><li>    <span class="hljs-comment">// 3. 响应处理</span></li><li>    userInfo, err := processUserInfoResponse(resp)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       log.Printf(<span class="hljs-string">"User info processing error: %v"</span>, err)</li><li>       sendErrorResponse(w, http.StatusInternalServerError, <span class="hljs-string">"Failed to process user data"</span>)</li><li>       <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-comment">// 4. 成功响应</span></li><li>    sendSuccessResponse(w, userInfo)</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parseLoginRequest</span><span class="hljs-params">(r *http.Request, dest *LoginRequest)</span></span> <span class="hljs-type">error</span> {</li><li>    body, err := ioutil.ReadAll(r.Body)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"failed to read request body: %v"</span>, err)</li><li>    }</li><li>    <span class="hljs-keyword">defer</span> r.Body.Close()</li><li>    <span class="hljs-keyword">if</span> err := json.Unmarshal(body, dest); err != <span class="hljs-literal">nil</span> {</li><li>       <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"invalid JSON format: %v"</span>, err)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> dest.AuthorizationCode == <span class="hljs-string">""</span> {</li><li>       <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"missing authorization code"</span>)</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processUserInfoResponse</span><span class="hljs-params">(resp *http.Response)</span></span> (*UserInfo, <span class="hljs-type">error</span>) {</li><li>    <span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"unexpected status code: %d"</span>, resp.StatusCode)</li><li>    }</li><li>    respBody, err := ioutil.ReadAll(resp.Body)</li><li>    <span class="hljs-keyword">var</span> phoneNumberErrRsp PhoneNumberErrRsp</li><li>    err = json.Unmarshal(respBody, &amp;phoneNumberErrRsp)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"failed to unmarshal response body: %v"</span>, err)</li><li>    }</li><li>    <span class="hljs-keyword">if</span> phoneNumberErrRsp.ResultCode != <span class="hljs-number">0</span> {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"api error %d: %s"</span>, phoneNumberErrRsp.ResultCode, phoneNumberErrRsp.ResultDesc)</li><li>    }</li><li>    <span class="hljs-keyword">var</span> userInfo UserInfo</li><li>    err = json.Unmarshal(respBody, &amp;userInfo)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"failed to unmarshal response body: %v"</span>, err)</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">/*</span></li><li><span class="hljs-comment">     根据业务设计流程，在数据库中查询用户信息，比如：</span></li><li><span class="hljs-comment">     1、使用UnionID查询用户，匹配到了则返回用户信息；</span></li><li><span class="hljs-comment">     2、未匹配到则使用手机号查询用户，查到了则将华为账号UnionID关联到该用户，返回用户信息；</span></li><li><span class="hljs-comment">     3、UnionID和手机号均没有匹配到，则进入注册流程</span></li><li><span class="hljs-comment">    */</span></li><li>
</li><li>    <span class="hljs-keyword">return</span> &amp;userInfo, <span class="hljs-literal">nil</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendErrorResponse</span><span class="hljs-params">(w http.ResponseWriter, statusCode <span class="hljs-type">int</span>, message <span class="hljs-type">string</span>)</span></span> {</li><li>    w.WriteHeader(statusCode)</li><li>    response := Response{</li><li>       Code:    statusCode,</li><li>       Message: message,</li><li>    }</li><li>    <span class="hljs-keyword">if</span> err := json.NewEncoder(w).Encode(response); err != <span class="hljs-literal">nil</span> {</li><li>       log.Printf(<span class="hljs-string">"Failed to encode error response: %v"</span>, err)</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendSuccessResponse</span><span class="hljs-params">(w http.ResponseWriter, userInfo *UserInfo)</span></span> {</li><li>    response := Response{</li><li>       Code:     http.StatusOK,</li><li>       Message:  <span class="hljs-string">"Login successful"</span>,</li><li>       UserInfo: *userInfo,</li><li>    }</li><li>    <span class="hljs-keyword">if</span> err := json.NewEncoder(w).Encode(response); err != <span class="hljs-literal">nil</span> {</li><li>       log.Printf(<span class="hljs-string">"Failed to encode success response: %v"</span>, err)</li><li>       w.WriteHeader(http.StatusInternalServerError)</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</li><li>    http.HandleFunc(<span class="hljs-string">"/login"</span>, loginHandler)</li><li>    log.Println(<span class="hljs-string">"Server starting on :8080..."</span>)</li><li>    <span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">":8080"</span>, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> {</li><li>       log.Fatalf(<span class="hljs-string">"Server failed: %v"</span>, err)</li><li>    }</li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="php prettyprint linenums hljs language-php" hw-language="php" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">&lt;?php</span></li><li>
</li><li><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../service/LoginService.php'</span>;</li><li>
</li><li><span class="hljs-comment">// 初始化路由</span></li><li><span class="hljs-variable">$router</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>();</li><li><span class="hljs-variable">$router</span>-&gt;<span class="hljs-title function_ invoke__">addRoute</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/login'</span>, function(<span class="hljs-variable">$request</span>) {</li><li>    <span class="hljs-comment">// 获取POST数据</span></li><li>    <span class="hljs-variable">$requestBody</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'php://input'</span>), <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$requestBody</span>[<span class="hljs-string">'authorizationCode'</span>])) {</li><li>        <span class="hljs-comment">// 调用服务层进行登录验证</span></li><li>        <span class="hljs-variable">$userInfo</span> = <span class="hljs-title class_">LoginService</span>::<span class="hljs-title function_ invoke__">loginWithHuawei</span>(<span class="hljs-variable">$requestBody</span>[<span class="hljs-string">'authorizationCode'</span>]);</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$userInfo</span>)) {</li><li>            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>([</li><li>                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">500</span>,</li><li>                <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'login failed!'</span></li><li>            ]);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 返回响应</span></li><li>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>([</li><li>            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$userInfo</span>,</li><li>            <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">200</span>,</li><li>            <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'login success!'</span></li><li>        ]);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">400</span>, <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'Missing authorization code'</span>]);</li><li>    }</li><li>});</li><li>
</li><li><span class="hljs-comment">// 处理请求</span></li><li><span class="hljs-variable">$router</span>-&gt;<span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>], <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_URI'</span>], PHP_URL_PATH));</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Router</span> </span>{</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$routes</span> = [];</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRoute</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$path</span>, <span class="hljs-variable">$handler</span></span>) </span>{</li><li>        <span class="hljs-variable language_">$this</span>-&gt;routes[<span class="hljs-title function_ invoke__">strtoupper</span>(<span class="hljs-variable">$method</span>)][<span class="hljs-variable">$path</span>] = <span class="hljs-variable">$handler</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatch</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$uri</span></span>) </span>{</li><li>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Content-Type: application/json'</span>);</li><li>        <span class="hljs-variable">$method</span> = <span class="hljs-title function_ invoke__">strtoupper</span>(<span class="hljs-variable">$method</span>);</li><li>        <span class="hljs-comment">// 精确匹配路由</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;routes[<span class="hljs-variable">$method</span>][<span class="hljs-variable">$uri</span>])) {</li><li>            <span class="hljs-variable">$handler</span> = <span class="hljs-variable language_">$this</span>-&gt;routes[<span class="hljs-variable">$method</span>][<span class="hljs-variable">$uri</span>];</li><li>            <span class="hljs-variable">$handler</span>(<span class="hljs-variable">$_REQUEST</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 未找到路由</span></li><li>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>([</li><li>            <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'Not Found'</span>,</li><li>            <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">404</span></li><li>        ]);</li><li>    }</li><li>}</li></ol></pre></div></div></div></div></div></div>         <p></p></li>        <li>应用服务端获取到Authorization Code之后，对接华为账号服务器，参考<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section286103315177">服务端开发</a>，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-user-info-quicklogin-by-code#section2520125725115" target="_blank">/oauth2/v6/quickLogin/getPhoneNumber接口</a>获取完整手机号、UnionID、OpenID；</li>        <li>根据获取的UnionID、OpenID、完整手机号，判断登录用户是否为新用户、是否已关联等等（根据实际业务开发）；</li>        <li>保存或更新用户信息到应用服务端，完成处理后，返回登录用户的信息至应用客户端；         <div class="p">                                                 <div class="switchPre"><div class="preTab preTab-cn"><div class="activePre" switchpre-data="0" switchpre-lang="java">java</div><div switchpre-data="1" switchpre-lang="python">python</div><div switchpre-data="2" switchpre-lang="go">go</div><div switchpre-data="3" switchpre-lang="php">php</div></div><div class="switchPreBox"><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONObject;</li><li><span class="hljs-keyword">import</span> com.huawei.account.config.AGCProperties;</li><li><span class="hljs-keyword">import</span> com.huawei.account.config.Constants;</li><li><span class="hljs-keyword">import</span> com.huawei.account.entity.PhoneNumberReq;</li><li><span class="hljs-keyword">import</span> com.huawei.account.entity.PhoneNumberResp;</li><li><span class="hljs-keyword">import</span> com.huawei.account.util.HttpUtil;</li><li><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;</li><li><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;</li><li><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;</li><li>
</li><li><span class="hljs-meta">@Slf4j</span></li><li><span class="hljs-meta">@Service</span></li><li><span class="hljs-meta">@RequiredArgsConstructor</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginService</span> {</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpUtil httpService;</li><li>
</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AGCProperties agcProperties;</li><li>
</li><li>    <span class="hljs-keyword">public</span> PhoneNumberResp <span class="hljs-title function_">loginWithHuawei</span><span class="hljs-params">(String authorizationCode)</span> {</li><li>        <span class="hljs-type">PhoneNumberReq</span> <span class="hljs-variable">phoneNumberReq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneNumberReq</span>();</li><li>        phoneNumberReq.setClientId(agcProperties.getClientId()); <span class="hljs-comment">// 读取配置项中Client ID</span></li><li>        phoneNumberReq.setClientSecret(agcProperties.getClientSecret()); <span class="hljs-comment">// 读取配置项中Client Secret</span></li><li>        phoneNumberReq.setCode(authorizationCode);</li><li>        <span class="hljs-type">PhoneNumberResp</span> <span class="hljs-variable">phoneNumberResp</span> <span class="hljs-operator">=</span> httpService.callHttpPost(Constants.QUICK_LOGIN_PHONE_NUMBER_URL, phoneNumberReq, PhoneNumberResp.class).getBody();</li><li>        log.info(<span class="hljs-string">"/oauth2/v6/quickLogin/getPhoneNumber response body is: {}"</span>, JSONObject.toJSONString(phoneNumberResp));</li><li>
</li><li>        <span class="hljs-comment">// 数据库相关：</span></li><li>        <span class="hljs-comment">// 使用UnionID查询用户，匹配到了则返回用户信息；</span></li><li>        <span class="hljs-comment">// 未匹配到则使用手机号查询用户，查到了则关联华为账号UnionID，返回用户信息；</span></li><li>        <span class="hljs-comment">// UnionID和手机号均没有匹配到，则进入注册流程</span></li><li>
</li><li>        <span class="hljs-keyword">return</span> phoneNumberResp;</li><li>    }</li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> requests</li><li><span class="hljs-keyword">import</span> json</li><li><span class="hljs-keyword">import</span> os</li><li>
</li><li>parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</li><li>target_file = os.path.join(parent_dir, <span class="hljs-string">"config"</span>, <span class="hljs-string">"agc.json"</span>)</li><li><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(target_file) <span class="hljs-keyword">as</span> f:</li><li>    agc_config = json.load(f)</li><li>
</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">login_with_huawei</span>(<span class="hljs-params">authorization_code</span>):</li><li>    <span class="hljs-comment"># 配置信息</span></li><li>    client_id = agc_config[<span class="hljs-string">"clientId"</span>] <span class="hljs-comment"># 读取配置项中Client ID</span></li><li>    client_secret = agc_config[<span class="hljs-string">"clientSecret"</span>] <span class="hljs-comment"># 读取配置项中Client Secret</span></li><li>    phone_number_url = <span class="hljs-string">"https://account-api.cloud.huawei.com/oauth2/v6/quickLogin/getPhoneNumber"</span></li><li>
</li><li>    <span class="hljs-comment"># 构建请求体</span></li><li>    token_request_body = {</li><li>        <span class="hljs-string">"clientId"</span>: client_id,</li><li>        <span class="hljs-string">"clientSecret"</span>: client_secret,</li><li>        <span class="hljs-string">"code"</span>: authorization_code</li><li>    }</li><li>
</li><li>    <span class="hljs-comment"># 发送请求获取一键登录用户手机号等信息</span></li><li>    user_info_response = {}</li><li>    <span class="hljs-keyword">try</span>:</li><li>        user_info_response = requests.post(phone_number_url, headers={<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>}, json=token_request_body)</li><li>        user_info_response.raise_for_status()  <span class="hljs-comment"># 如果请求失败，抛出HTTPError异常</span></li><li>        user_info = json.loads(user_info_response.content.decode(<span class="hljs-string">'utf-8'</span>))</li><li>    <span class="hljs-keyword">except</span> requests.RequestException <span class="hljs-keyword">as</span> e:</li><li>        user_info = json.loads(user_info_response.content.decode(<span class="hljs-string">'utf-8'</span>))</li><li>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Error retrieving /oauth2/v6/quickLogin/getPhoneNumber: <span class="hljs-subst">{e}</span>"</span>)</li><li>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Error retrieving /oauth2/v6/quickLogin/getPhoneNumber: <span class="hljs-subst">{user_info}</span>"</span>)</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></li><li>    <span class="hljs-keyword">if</span> <span class="hljs-string">"resultCode"</span> <span class="hljs-keyword">in</span> user_info:</li><li>        <span class="hljs-keyword">assert</span> user_info[<span class="hljs-string">"resultCode"</span>] == <span class="hljs-number">0</span></li><li>
</li><li>    <span class="hljs-comment"># 根据业务设计流程，在数据库中查询用户信息，比如：</span></li><li>    <span class="hljs-comment"># 1、使用UnionID查询用户，匹配到了则返回用户信息；</span></li><li>    <span class="hljs-comment"># 2、未匹配到则使用手机号查询用户，查到了则将华为账号UnionID关联到该用户，返回用户信息；</span></li><li>    <span class="hljs-comment"># 3、UnionID和手机号均没有匹配到，则进入注册流程</span></li><li>
</li><li>    <span class="hljs-keyword">return</span> user_info</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="go prettyprint linenums hljs language-go" hw-language="go" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">package</span> service</li><li>
</li><li><span class="hljs-keyword">import</span> (</li><li>    <span class="hljs-string">"bytes"</span></li><li>    <span class="hljs-string">"encoding/json"</span></li><li>    <span class="hljs-string">"fmt"</span></li><li>    <span class="hljs-string">"io/ioutil"</span></li><li>    <span class="hljs-string">"net"</span></li><li>    <span class="hljs-string">"net/http"</span></li><li>    <span class="hljs-string">"path/filepath"</span></li><li>    <span class="hljs-string">"sync"</span></li><li>    <span class="hljs-string">"time"</span></li><li>)</li><li>
</li><li><span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> {</li><li>    Data    <span class="hljs-keyword">interface</span>{} <span class="hljs-string">`json:"data"`</span></li><li>    Code    <span class="hljs-type">int</span>         <span class="hljs-string">`json:"code"`</span></li><li>    Message <span class="hljs-type">string</span>      <span class="hljs-string">`json:"message"`</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">type</span> PhoneNumberReq <span class="hljs-keyword">struct</span> {</li><li>    ClientId     <span class="hljs-type">string</span> <span class="hljs-string">`json:"clientId"`</span></li><li>    ClientSecret <span class="hljs-type">string</span> <span class="hljs-string">`json:"clientSecret"`</span></li><li>    Code         <span class="hljs-type">string</span> <span class="hljs-string">`json:"code"`</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">var</span> httpClient = &amp;http.Client{</li><li>    Transport: &amp;http.Transport{</li><li>       DialContext: (&amp;net.Dialer{</li><li>          Timeout: <span class="hljs-number">5</span> * time.Second,</li><li>       }).DialContext,</li><li>       TLSHandshakeTimeout:   <span class="hljs-number">5</span> * time.Second,</li><li>       ResponseHeaderTimeout: <span class="hljs-number">10</span> * time.Second,</li><li>    },</li><li>    Timeout: <span class="hljs-number">30</span> * time.Second,</li><li>}</li><li>
</li><li><span class="hljs-keyword">var</span> (</li><li>    config     *Config</li><li>    configOnce sync.Once</li><li>    configErr  <span class="hljs-type">error</span></li><li>)</li><li>
</li><li><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {</li><li>    ClientID     <span class="hljs-type">string</span> <span class="hljs-string">`json:"clientId"`</span></li><li>    ClientSecret <span class="hljs-type">string</span> <span class="hljs-string">`json:"clientSecret"`</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">()</span></span> (*Config, <span class="hljs-type">error</span>) {</li><li>    configOnce.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {</li><li>       data, err := ioutil.ReadFile(filepath.Join(<span class="hljs-string">"src"</span>, <span class="hljs-string">"config"</span>, <span class="hljs-string">"agc.json"</span>))</li><li>       <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>          configErr = err</li><li>          <span class="hljs-keyword">return</span></li><li>       }</li><li>       <span class="hljs-keyword">var</span> cfg Config</li><li>       <span class="hljs-keyword">if</span> err := json.Unmarshal(data, &amp;cfg); err != <span class="hljs-literal">nil</span> {</li><li>          configErr = err</li><li>          <span class="hljs-keyword">return</span></li><li>       }</li><li>       config = &amp;cfg</li><li>    })</li><li>    <span class="hljs-keyword">return</span> config, configErr</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoginWithHuawei</span><span class="hljs-params">(authorizationCode <span class="hljs-type">string</span>)</span></span> (*http.Response, <span class="hljs-type">error</span>) {</li><li>    config, err := LoadConfig()</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err</li><li>    }</li><li>    <span class="hljs-comment">// 1. 构造请求体</span></li><li>    reqBody := PhoneNumberReq{</li><li>       ClientId:     config.ClientID,</li><li>       ClientSecret: config.ClientSecret,</li><li>       Code:         authorizationCode,</li><li>    }</li><li>    <span class="hljs-comment">// 2. 序列化为JSON</span></li><li>    jsonData, err := json.Marshal(reqBody)</li><li>    resp, err := httpClient.Post(<span class="hljs-string">"https://account-api.cloud.huawei.com/oauth2/v6/quickLogin/getPhoneNumber"</span>, <span class="hljs-string">"application/json"</span>, bytes.NewBuffer(jsonData))</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>       fmt.Errorf(<span class="hljs-string">"failed to make POST request: %v, %v"</span>, config.ClientID, config.ClientSecret)</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"failed to make POST request: %v"</span>, err)</li><li>    }</li><li>    <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span></li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-dgb-c106="" class="highlight-div"><div _ngcontent-dgb-c106="" class="highlight-div-header"><div _ngcontent-dgb-c106="" class="highlight-div-header-left"><div _ngcontent-dgb-c106="" class="handle-button expand-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dgb-c106="" class="highlight-div-header-right"><div _ngcontent-dgb-c106="" class="handle-button ai-button"></div><div _ngcontent-dgb-c106="" class="handle-button line-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dgb-c106="" class="handle-button theme-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dgb-c106="" class="handle-button copy-button"><div _ngcontent-dgb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dgb-c106="" class="highlight-scroll-div"><pre class="php prettyprint linenums hljs language-php" hw-language="php" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">&lt;?php</span></li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginService</span> </span>{</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginWithHuawei</span>(<span class="hljs-params"><span class="hljs-variable">$authorizationCode</span></span>) </span>{</li><li>        <span class="hljs-variable">$agcConfig</span> = <span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../config/agc.php'</span>;</li><li>        <span class="hljs-variable">$requestBody</span> = [</li><li>            <span class="hljs-string">'clientId'</span> =&gt; <span class="hljs-variable">$agcConfig</span>[<span class="hljs-string">'clientId'</span>],</li><li>            <span class="hljs-string">'clientSecret'</span> =&gt; <span class="hljs-variable">$agcConfig</span>[<span class="hljs-string">'clientSecret'</span>],</li><li>            <span class="hljs-string">'code'</span> =&gt; <span class="hljs-variable">$authorizationCode</span></li><li>        ];</li><li>
</li><li>        <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();</li><li>        <span class="hljs-title function_ invoke__">curl_setopt_array</span>(<span class="hljs-variable">$ch</span>,</li><li>            [</li><li>                CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-literal">true</span>,</li><li>                CURLOPT_POST =&gt; <span class="hljs-literal">true</span>,</li><li>                CURLOPT_HTTPHEADER =&gt; [</li><li>                    <span class="hljs-string">'Content-Type: application/json'</span>,</li><li>                    <span class="hljs-string">'Accept: application/json'</span></li><li>                ],</li><li>                CURLOPT_SSL_VERIFYPEER =&gt; <span class="hljs-literal">false</span>,</li><li>                CURLOPT_SSL_VERIFYHOST =&gt; <span class="hljs-literal">false</span>,</li><li>                CURLOPT_URL =&gt; <span class="hljs-string">'https://account-api.cloud.huawei.com/oauth2/v6/quickLogin/getPhoneNumber'</span>,</li><li>                CURLOPT_POSTFIELDS =&gt; <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$requestBody</span>)</li><li>            ]);</li><li>
</li><li>        <span class="hljs-variable">$response</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$response</span> === <span class="hljs-literal">false</span>) {</li><li>            <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">'cURL Error: '</span> . <span class="hljs-title function_ invoke__">curl_error</span>(<span class="hljs-variable">$ch</span>));</li><li>            <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">$userInfo</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-variable">$response</span>, <span class="hljs-literal">true</span>);</li><li>        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'resultCode'</span>]) &amp;&amp; <span class="hljs-variable">$userInfo</span>[<span class="hljs-string">'resultCode'</span>] != <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">'cURL Error: '</span> . <span class="hljs-title function_ invoke__">curl_error</span>(<span class="hljs-variable">$ch</span>));</li><li>            <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">         * 根据业务设计流程，在数据库中查询用户信息，比如：</span></li><li><span class="hljs-comment">         * 1、使用UnionID查询用户，匹配到了则返回用户信息；</span></li><li><span class="hljs-comment">         * 2、未匹配到则使用手机号查询用户，查到了则将华为账号UnionID关联到该用户，返回用户信息；</span></li><li><span class="hljs-comment">         * 3、UnionID和手机号均没有匹配到，则进入注册流程</span></li><li><span class="hljs-comment">         */</span></li><li>
</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$userInfo</span>;</li><li>    }</li><li>}</li></ol></pre></div></div></div></div></div></div></li>       </ol></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section161071922192214">客户端与服务端联调<i class="anchor-icon anchor-icon-link" anchorid="section161071922192214" tips="复制节点链接"></i></h3>          <p>前提：根据应用登录方案设计及实现，完成客户端和服务端开发，开发指导参见<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section834212543125">客户端开发</a>、<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section286103315177">服务端开发</a>和<a href="/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section9343175722020">应用客户端到应用服务端的开发</a>。</p>     <ol>      <li>在客户端获取到Authorization Code之后，传送给服务端接口；在服务端使用Authorization Code获取华为账号绑定的手机号、UnionID、OpenID。       <p><span><img height="141.5652" originheight="212" originwidth="1195" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114541.60734460106953701051649361238315:50001231000000:2800:E09B4C16D434C6DEEA68703482E0650A1F6B20913D3B6E51356B489491A39A8C.png" title="点击放大" width="798"></span></p></li>      <li>根据应用登录方案使用华为账号绑定的手机号、UnionID、OpenID登录成功后，应用服务端返回用户信息给应用客户端，应用客户端可根据需要进行本地持久化存储，例如：登录状态、用户账号名、手机号、用户身份标识等。</li>      <li>在应用客户端首页或个人信息页等位置，对当前登录用户信息进行展示，举例如下图：</li>     </ol>     <p><span><img height="659.3209" originheight="2993" originwidth="1449" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114541.34219414175493764725427864726580:50001231000000:2800:A1AE6E71FD3DD352D6C197601F7016F6917FEA44C4B46557D000D331DB323B54.png" title="点击放大" width="319.20000000000005"></span></p>     <p></p>    </div>    <div class="tiledSection">     <h2 id="section62733816112">开发后验证<i class="anchor-icon anchor-icon-link" anchorid="section62733816112" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section4603143014113" class="firsth2">集成华为账号一键登录能力应用用户体验质量建议<i class="anchor-icon anchor-icon-link" anchorid="section4603143014113" tips="复制节点链接"></i></h3>          <p>应用完成开发后，可参照以下标准检查集成华为账号一键登录后的用户体验是否符合预期：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">               <tbody><tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>标准编号</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>标准项名称</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>类型</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>标准详细描述</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>1</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>满足华为账号提供登录设计规范</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>规则</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>需满足<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/id-0000001880001344" target="_blank">华为账号开放登录</a>中<strong><a href="https://developer.huawei.com/consumer/cn/doc/design-guides/id-0000001880001344#section41792374210" target="_blank">【华为账号一键登录】按钮</a></strong>规范，保障HarmonyOS应用拥有简单易用、高效一致、快速安全的登录体验；</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>2</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>用户交互体验原则</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>建议</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>（1）登录页面的用户协议与隐私协议、华为账号用户认证协议可展示、可点击；</p>          <p>（2）当用户点击协议后，回退页面，须回到点击前的页面；</p>          <p>（3）只有用户勾选并同意所有协议后，才可继续进行登录操作，若用户未勾选协议时直接点击华为账号登录按钮，须有明确的同意协议提醒；</p>          <p>（4）点击登录按钮须直接完成登录流程，可出现头像、昵称授权页，但取消场景须不影响登录流程；若出现处理异常，须及时终止页面，不应出现应用卡死无法操作；</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>3</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>登录页面内容用户体验原则</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>建议</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>（1）若未提供其他登录方式，不应显示“其他登录方式”的入口；</p>          <p>（2）若使用华为账号一键登录，页面匿名手机号须展示从华为账号侧获取的匿名手机号，不应展示其他来源的手机号；</p>          <p>（3）用户协议中，必须包含<a href="https://privacy.consumer.huawei.com/legal/id/authentication-terms.htm?code=CN&amp;language=zh-CN" target="_blank">《华为账号用户认证协议》</a>，且协议必须可点击、可加载，加载后支持回退页面，且回到点击前的页面；</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>4</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>异常处理用户体验原则</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>建议</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>登录页面需进行异常处理保证：</p>          <p>（1）若登录异常（如网络异常、海外账号不支持等情况），勿将错误码等原始信息直接透传给用户；</p>          <p>（2）若登录时触发了华为侧的短信验证码校验，则在校验成功之后，应用不应再展示额外的验证码验证页面；</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="12.458754124587541%">          <p>5</p></td>         <td class="cellrowborder" valign="top" width="19.518048195180484%">          <p>应用生命周期变化的华为账号用户体验原则</p></td>         <td class="cellrowborder" valign="top" width="10.46895310468953%">          <p>建议</p></td>         <td class="cellrowborder" valign="top" width="57.55424457554245%">          <p>应用更新后，其登录状态须与更新前一致；</p></td>        </tr>             </tbody></table></div>     </div>    </div>   </div>   <div></div></div>