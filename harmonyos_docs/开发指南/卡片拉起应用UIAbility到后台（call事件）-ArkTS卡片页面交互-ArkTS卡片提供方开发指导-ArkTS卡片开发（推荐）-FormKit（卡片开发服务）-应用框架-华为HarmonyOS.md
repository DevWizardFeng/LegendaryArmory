<h1 _ngcontent-tof-c119="" class="doc-title ng-star-inserted" title="卡片拉起应用UIAbility到后台（call事件）"> 卡片拉起应用UIAbility到后台（call事件） </h1>

<div _ngcontent-tof-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>许多应用希望借助卡片的能力，实现和应用在前台时相同的功能。例如音乐卡片，卡片上提供播放、暂停等按钮，点击不同按钮将触发音乐应用的不同功能，进而提高用户的体验。在卡片中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-postcardaction#postcardaction-1" target="_blank">postCardAction</a>接口的call能力，能够将卡片提供方应用的指定的UIAbility拉到后台。同时，call能力提供了调用应用指定方法、传递数据的功能，使应用在后台运行时可以通过卡片上的按钮执行不同的功能。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>本文主要介绍动态卡片的事件开发。对于静态卡片，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-formlink" target="_blank">FormLink</a>。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>创建动态卡片</p>       <p>新建一个名为WidgetEventCall的ArkTs动态卡片。</p></li>      <li>       <p>页面布局代码实现</p>       <p>在卡片页面中布局两个按钮，点击按钮A或按钮B，会调用postCardAction向指定UIAbility发送call事件，在call事件内定义了需要调用的方法。按钮A和按钮B分别对应调用funA、funB方法，其中funA携带了formID参数，funB携带了formID和num参数，开发过程中请根据实际需要传参。postCardAction中的method参数为必填参数，用于标识需要调用的方法名称，与步骤3中UIAbility监听的方法一致，其他参数为非必填。</p>       <div _ngcontent-tof-c106="" class="highlight-div"><div _ngcontent-tof-c106="" class="highlight-div-header"><div _ngcontent-tof-c106="" class="highlight-div-header-left"><div _ngcontent-tof-c106="" class="handle-button expand-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tof-c106="" class="highlight-div-header-right"><div _ngcontent-tof-c106="" class="handle-button ai-button"></div><div _ngcontent-tof-c106="" class="handle-button line-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tof-c106="" class="handle-button theme-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tof-c106="" class="handle-button copy-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tof-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//src/main/ets/widgeteventcallcard/pages/WidgetEventCall.ets</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WidgetEventCall</span> {</li><li>  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'formId'</span>) <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'12400633174999288'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">funA</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'按钮A'</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">funB</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'按钮B'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">funA</span>)</li><li>      .<span class="hljs-title function_">id</span>(<span class="hljs-string">'funA__'</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>        <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>      })</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable language_">this</span>, {</li><li>          <span class="hljs-attr">action</span>: <span class="hljs-string">'call'</span>,</li><li>          <span class="hljs-comment">// 只能跳转到当前应用下的UIAbility，与module.json5中定义保持一致</span></li><li>          <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'WidgetEventCallEntryAbility'</span>,</li><li>          <span class="hljs-attr">params</span>: {</li><li>            <span class="hljs-attr">formId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">formId</span>,</li><li>            <span class="hljs-comment">// 需要调用的方法名称</span></li><li>            <span class="hljs-attr">method</span>: <span class="hljs-string">'funA'</span></li><li>          }</li><li>        });</li><li>      })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">funB</span>)</li><li>      .<span class="hljs-title function_">id</span>(<span class="hljs-string">'funB__'</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>      .<span class="hljs-title function_">alignRules</span>({</li><li>        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'funA__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },</li><li>        <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>      })</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable language_">this</span>, {</li><li>        <span class="hljs-attr">action</span>: <span class="hljs-string">'call'</span>,</li><li>        <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'WidgetEventCallEntryAbility'</span>,</li><li>        <span class="hljs-attr">params</span>: {</li><li>          <span class="hljs-attr">formId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">formId</span>,</li><li>          <span class="hljs-comment">// 需要调用的方法名称</span></li><li>          <span class="hljs-attr">method</span>: <span class="hljs-string">'funB'</span>,</li><li>          <span class="hljs-attr">num</span>: <span class="hljs-number">1</span></li><li>        }</li><li>      });</li><li>    })</li><li>  }</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建指定的UIAbility</p>       <p>在UIAbility中监听call事件，根据监听到的method参数中的方法名称调用对应方法，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#parcelable9" target="_blank">rpc.Parcelable</a>获取参数。UIAbility中监听的方法与步骤2中调用的方法需保持一致。</p>       <div _ngcontent-tof-c106="" class="highlight-div"><div _ngcontent-tof-c106="" class="highlight-div-header"><div _ngcontent-tof-c106="" class="highlight-div-header-left"><div _ngcontent-tof-c106="" class="handle-button expand-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tof-c106="" class="highlight-div-header-right"><div _ngcontent-tof-c106="" class="handle-button ai-button"></div><div _ngcontent-tof-c106="" class="handle-button line-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tof-c106="" class="handle-button theme-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tof-c106="" class="handle-button copy-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tof-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//src/main/ets/widgeteventcallcard/WidgetEventCallEntryAbility/WidgetEventCallEntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>  </li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'WidgetEventCallEntryAbility'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">CONST_NUMBER_1</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">CONST_NUMBER_2</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-comment">// ipc通信返回类型的实现，用于数据序列化和反序列化</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyParcelable</span> <span class="hljs-keyword">implements</span> rpc.<span class="hljs-property">Parcelable</span> {</li><li>  <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>;</li><li>  </li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">num: <span class="hljs-built_in">number</span>, str: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = num;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">str</span> = str;</li><li>  }</li><li>  </li><li>  <span class="hljs-title function_">marshalling</span>(<span class="hljs-attr">messageSequence</span>: rpc.<span class="hljs-property">MessageSequence</span>): <span class="hljs-built_in">boolean</span> {</li><li>    messageSequence.<span class="hljs-title function_">writeInt</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span>);</li><li>    messageSequence.<span class="hljs-title function_">writeString</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">str</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>  </li><li>  <span class="hljs-title function_">unmarshalling</span>(<span class="hljs-attr">messageSequence</span>: rpc.<span class="hljs-property">MessageSequence</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = messageSequence.<span class="hljs-title function_">readInt</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">str</span> = messageSequence.<span class="hljs-title function_">readString</span>();</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li>  </li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WidgetEventCallEntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// 如果UIAbility启动，在收到call事件后会触发onCreate生命周期回调</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 监听call事件所需的方法并调用</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'funA'</span>, <span class="hljs-function">(<span class="hljs-params">data: rpc.MessageSequence</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 获取call事件中传递的所有参数</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FunACall param:  <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data.readString())}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyParcelable</span>(<span class="hljs-variable constant_">CONST_NUMBER_1</span>, <span class="hljs-string">'aaa'</span>);</li><li>      });</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'funB'</span>, <span class="hljs-function">(<span class="hljs-params">data: rpc.MessageSequence</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 获取call事件中传递的所有参数</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FunBCall param:  <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data.readString())}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyParcelable</span>(<span class="hljs-variable constant_">CONST_NUMBER_2</span>, <span class="hljs-string">'bbb'</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to register callee on. Cause: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err <span class="hljs-keyword">as</span> BusinessError)}</span>`</span>);</li><li>    }</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 进程退出时，解除监听</span></li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'funA'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'funB'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to register callee off. Cause: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err <span class="hljs-keyword">as</span> BusinessError)}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>配置后台运行权限</p>       <p>call事件存在约束限制，卡片提供方应用需要在module.json5下添加后台运行权限(<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all#ohospermissionkeep_background_running">ohos.permission.KEEP_BACKGROUND_RUNNING</a>)。</p>       <div _ngcontent-tof-c106="" class="highlight-div"><div _ngcontent-tof-c106="" class="highlight-div-header"><div _ngcontent-tof-c106="" class="highlight-div-header-left"><div _ngcontent-tof-c106="" class="handle-button expand-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tof-c106="" class="highlight-div-header-right"><div _ngcontent-tof-c106="" class="handle-button ai-button"></div><div _ngcontent-tof-c106="" class="handle-button line-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tof-c106="" class="handle-button theme-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tof-c106="" class="handle-button copy-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tof-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//src/main/module.json5</span></li><li><span class="hljs-string">"requestPermissions"</span>：[</li><li>   {</li><li>     <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span></li><li>   }</li><li> ]</li></ol></pre></div></div></li>      <li>       <p>配置指定的UIAbility</p>       <p>在module.json5的abilities数组内添加WidgetEventCallEntryAbility对应的配置信息。</p>       <div _ngcontent-tof-c106="" class="highlight-div"><div _ngcontent-tof-c106="" class="highlight-div-header"><div _ngcontent-tof-c106="" class="highlight-div-header-left"><div _ngcontent-tof-c106="" class="handle-button expand-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tof-c106="" class="highlight-div-header-right"><div _ngcontent-tof-c106="" class="handle-button ai-button"></div><div _ngcontent-tof-c106="" class="handle-button line-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tof-c106="" class="handle-button theme-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tof-c106="" class="handle-button copy-button"><div _ngcontent-tof-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tof-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//src/main/module.json5</span></li><li><span class="hljs-string">"abilities"</span>: [</li><li> {</li><li>   <span class="hljs-string">"name"</span>: <span class="hljs-string">'WidgetEventCallEntryAbility'</span>,</li><li>   <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">'./ets/widgeteventcallcard/WidgetEventCallEntryAbility/WidgetEventCallEntryAbility.ets'</span>,</li><li>   <span class="hljs-string">"description"</span>: <span class="hljs-string">'$string:WidgetEventCallCard_desc'</span>,</li><li>   <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:app_icon"</span>,</li><li>   <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:WidgetEventCallCard_label"</span>,</li><li>   <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"$media:app_icon"</span>,</li><li>   <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"$color:start_window_background"</span></li><li> }</li><li>]</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>