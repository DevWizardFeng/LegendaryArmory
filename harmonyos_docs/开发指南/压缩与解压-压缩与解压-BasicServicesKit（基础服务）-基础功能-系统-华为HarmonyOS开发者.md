<h1 _ngcontent-noj-c119="" class="doc-title ng-star-inserted" title="压缩与解压"> 压缩与解压 </h1>

<div _ngcontent-noj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本文针对常见的几种压缩、解压场景，介绍相关函数的使用方法。</p>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>以下是示例中使用的主要接口，更多接口及使用方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">接口描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">compressFile(inFile: string, outFile: string, options: Options): Promise&lt;void&gt;</td>         <td class="cellrowborder" valign="top" width="50%">压缩文件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">decompressFile(inFile: string, outFile: string, options?: Options): Promise&lt;void&gt;</td>         <td class="cellrowborder" valign="top" width="50%">解压文件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">compress(dest: ArrayBuffer, source: ArrayBuffer, sourceLen?: number): Promise&lt;ZipOutputInfo&gt;</td>         <td class="cellrowborder" valign="top" width="50%">将源缓冲区压缩到目标缓冲区。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">compressBound(sourceLen: number): Promise&lt;number&gt;</td>         <td class="cellrowborder" valign="top" width="50%">计算返回压缩大小的上限。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">uncompress(dest:ArrayBuffer, source: ArrayBuffer, sourceLen?: number): Promise&lt;ZipOutputInfo&gt;</td>         <td class="cellrowborder" valign="top" width="50%">将压缩后的数据解压缩为原始的未压缩形式。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">deflate(strm: ZStream, flush: CompressFlushMode): Promise&lt;ReturnStatus&gt;</td>         <td class="cellrowborder" valign="top" width="50%">压缩数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">inflate(strm: ZStream, flush: CompressFlushMode): Promise&lt;ReturnStatus&gt;</td>         <td class="cellrowborder" valign="top" width="50%">解压数据。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境准备" class="firsth2">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h3>          <p>在应用沙箱目录下创建一个测试文件data.txt，并写入测试数据。示例代码如下。</p>     <div _ngcontent-noj-c106="" class="highlight-div"><div _ngcontent-noj-c106="" class="highlight-div-header"><div _ngcontent-noj-c106="" class="highlight-div-header-left"><div _ngcontent-noj-c106="" class="handle-button expand-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-noj-c106="" class="highlight-div-header-right"><div _ngcontent-noj-c106="" class="handle-button ai-button"></div><div _ngcontent-noj-c106="" class="handle-button line-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-noj-c106="" class="handle-button theme-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-noj-c106="" class="handle-button copy-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-noj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">// 在应用沙箱目录下创建文件data.txt，并写入测试数据</span></li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'创建测试文件data.txt'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>          <span class="hljs-comment">// 创建文件data.txt</span></li><li>          <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>          <span class="hljs-comment">// 写入测试数据</span></li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">100</span>; index++) {</li><li>            fs.<span class="hljs-title function_">writeSync</span>(inFile.<span class="hljs-property">fd</span>, index + <span class="hljs-string">': hello world, hello world, hello world, hello world, hello world.\n'</span>);</li><li>          }</li><li>          <span class="hljs-comment">// 获取测试数据原始大小，并保存到dataSize中</span></li><li>          <span class="hljs-keyword">let</span> stat = fs.<span class="hljs-title function_">statSync</span>(inFile.<span class="hljs-property">path</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSize</span> = stat.<span class="hljs-property">size</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'dataSize: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSize</span>);</li><li>          <span class="hljs-comment">// 关闭文件</span></li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile);</li><li>        })</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="zip文件的压缩与解压">Zip文件的压缩与解压<i class="anchor-icon anchor-icon-link" anchorid="zip文件的压缩与解压" tips="复制节点链接"></i></h3>          <p>采用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#zlibcompressfile9-1" target="_blank">zlib.compressFile()</a>将文件data.txt压缩并归档到data.zip中，采用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#zlibdecompressfile9-1" target="_blank">zlib.decompressFile()</a>将data.zip解压到应用沙箱目录下，示例代码如下。</p>     <div _ngcontent-noj-c106="" class="highlight-div"><div _ngcontent-noj-c106="" class="highlight-div-header"><div _ngcontent-noj-c106="" class="highlight-div-header-left"><div _ngcontent-noj-c106="" class="handle-button expand-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-noj-c106="" class="highlight-div-header-right"><div _ngcontent-noj-c106="" class="handle-button ai-button"></div><div _ngcontent-noj-c106="" class="handle-button line-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-noj-c106="" class="handle-button theme-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-noj-c106="" class="handle-button copy-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-noj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, zlib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 示例一：将测试文件data.txt压缩并归档到data.zip中。</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'compressFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = path + <span class="hljs-string">'/data.txt'</span>;</li><li>        <span class="hljs-keyword">let</span> outFile = path + <span class="hljs-string">'/data.zip'</span>;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: zlib.<span class="hljs-property">Options</span> = {};</li><li>        zlib.<span class="hljs-title function_">compressFile</span>(inFile, outFile, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'compressFile success, data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errData: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`compressFile errCode: <span class="hljs-subst">${errData.code}</span>, message: <span class="hljs-subst">${errData.message}</span>`</span>);</li><li>        })</li><li>      })</li><li>
</li><li>      <span class="hljs-comment">// 示例二：将data.zip文件解压到应用沙箱目录下。</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'decompressFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = path + <span class="hljs-string">'/data.zip'</span>;</li><li>        <span class="hljs-keyword">let</span> outFile = path;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: zlib.<span class="hljs-property">Options</span> = {};</li><li>        zlib.<span class="hljs-title function_">decompressFile</span>(inFile, outFile, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'decompressFile success, data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errData: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`decompressFile errCode: <span class="hljs-subst">${errData.code}</span>, message: <span class="hljs-subst">${errData.message}</span>`</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="已知大小缓冲区的压缩与解压">已知大小缓冲区的压缩与解压<i class="anchor-icon anchor-icon-link" anchorid="已知大小缓冲区的压缩与解压" tips="复制节点链接"></i></h3>          <p>针对一个已知大小的缓冲区中的数据，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#compress12" target="_blank">compress()</a>将其压缩到一个目的缓冲区中，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#compressbound12" target="_blank">compressBound()</a>计算压缩目的缓冲区大小的上限值，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#uncompress12" target="_blank">uncompress()</a>对存储压缩数据的缓冲区进行解压。由于解压时无法获取解压后原始数据的大小，为了确认解压后目的缓冲区的大小，需要在压缩前获取原始数据的大小并保存，示例代码如下。</p>     <div _ngcontent-noj-c106="" class="highlight-div"><div _ngcontent-noj-c106="" class="highlight-div-header"><div _ngcontent-noj-c106="" class="highlight-div-header-left"><div _ngcontent-noj-c106="" class="handle-button expand-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-noj-c106="" class="highlight-div-header-right"><div _ngcontent-noj-c106="" class="handle-button ai-button"></div><div _ngcontent-noj-c106="" class="handle-button line-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-noj-c106="" class="handle-button theme-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-noj-c106="" class="handle-button copy-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-noj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, zlib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">dataSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;  <span class="hljs-comment">//用于保存原始数据的大小</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 示例一：读取data.txt文件内容并存入一个缓冲区，调用compress接口压缩缓冲区中的数据到目标缓冲区，并将目标缓冲区的内容写入文件data.bin</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'compress buffer'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.bin'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-comment">// 读取data.txt文件的内容，并存入缓冲区inBuf</span></li><li>        <span class="hljs-keyword">let</span> stat = fs.<span class="hljs-title function_">statSync</span>(inFile.<span class="hljs-property">path</span>);</li><li>        <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(stat.<span class="hljs-property">size</span>);</li><li>        <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(inFile.<span class="hljs-property">fd</span>, inBuf);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`original size: <span class="hljs-subst">${stat.size}</span>, read len: <span class="hljs-subst">${readLen}</span>`</span>);</li><li>        <span class="hljs-comment">// 获取原始数据的大小，并保存</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSize</span> = stat.<span class="hljs-property">size</span>;</li><li>        <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>        <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>        <span class="hljs-comment">// 获取一个目标缓冲区的上限</span></li><li>        zip.<span class="hljs-title function_">compressBound</span>(stat.<span class="hljs-property">size</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`the max dest buf len is <span class="hljs-subst">${data}</span>`</span>);</li><li>          <span class="hljs-comment">// 目标缓冲区outBuf</span></li><li>          <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(data);</li><li>          <span class="hljs-comment">// 将inBuf中的数据压缩到outBuf中</span></li><li>          zip.<span class="hljs-title function_">compress</span>(outBuf, inBuf, readLen).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">zipOutInfo</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`compress success, status <span class="hljs-subst">${zipOutInfo.status}</span>, destLen  <span class="hljs-subst">${zipOutInfo.destLen}</span>`</span>);</li><li>            <span class="hljs-comment">// 将outBuf中的数据写入到data.bin文件</span></li><li>            <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(outFile.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: zipOutInfo.<span class="hljs-property">destLen</span> });</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`write destBuf to data.bin, writeLen <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>            <span class="hljs-comment">// 关闭文件</span></li><li>            fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>            fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errData: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`errData is errCode:<span class="hljs-subst">${errData.code}</span>  message:<span class="hljs-subst">${errData.message}</span>`</span>);</li><li>          })</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errData: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`errData is errCode:<span class="hljs-subst">${errData.code}</span>  message:<span class="hljs-subst">${errData.message}</span>`</span>);</li><li>        })</li><li>      })</li><li>
</li><li>      <span class="hljs-comment">// 示例二：读取data.bin文件中的压缩数据并存入一个缓冲区，调用uncompress接口将缓冲区中的数据解压到目标缓冲区，并将目标缓冲区的内容写入文件data.txt</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'uncompress buffer'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.bin'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-comment">// 读取data.bin文件中的压缩数据，并存入缓冲区inBuf</span></li><li>        <span class="hljs-keyword">let</span> stat = fs.<span class="hljs-title function_">statSync</span>(inFile.<span class="hljs-property">path</span>);</li><li>        <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(stat.<span class="hljs-property">size</span>);</li><li>        <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(inFile.<span class="hljs-property">fd</span>, inBuf);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`compressed data size: <span class="hljs-subst">${stat.size}</span>, read len: <span class="hljs-subst">${readLen}</span>`</span>);</li><li>        <span class="hljs-comment">// 创建一个目标缓冲区，此处的dataSize是我们进行数据压缩前保存的数据的原始大小</span></li><li>        <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSize</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`the dest buf size is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.dataSize}</span>`</span>);</li><li>        <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>        <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>        <span class="hljs-comment">// 将inBuf中的数据解压缩outBuf中</span></li><li>        zip.<span class="hljs-title function_">uncompress</span>(outBuf, inBuf, readLen).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">zipOutInfo</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`uncompress success, status <span class="hljs-subst">${zipOutInfo.status}</span>, destLen  <span class="hljs-subst">${zipOutInfo.destLen}</span>`</span>);</li><li>          <span class="hljs-comment">// 将outBuf中的数据写入到data.txt文件</span></li><li>          <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(outFile.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: zipOutInfo.<span class="hljs-property">destLen</span> });</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`write destBuf to data.txt, writeLen <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>          <span class="hljs-comment">// 关闭文件</span></li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">errData: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`errData is errCode:<span class="hljs-subst">${errData.code}</span>  message:<span class="hljs-subst">${errData.message}</span>`</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="未知大小缓冲区的压缩与解压zlib格式">未知大小缓冲区的压缩与解压（zlib格式）<i class="anchor-icon anchor-icon-link" anchorid="未知大小缓冲区的压缩与解压zlib格式" tips="复制节点链接"></i></h3>          <p>针对一个未知大小的缓冲区中的数据，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#deflate12" target="_blank">deflate()</a>将从一个原始输入流中读取的数据进行压缩，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#inflate12" target="_blank">inflate()</a>将从一个压缩输入流中读取的数据进行解压，示例代码如下。</p>     <div _ngcontent-noj-c106="" class="highlight-div"><div _ngcontent-noj-c106="" class="highlight-div-header"><div _ngcontent-noj-c106="" class="highlight-div-header-left"><div _ngcontent-noj-c106="" class="handle-button expand-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-noj-c106="" class="highlight-div-header-right"><div _ngcontent-noj-c106="" class="handle-button ai-button"></div><div _ngcontent-noj-c106="" class="handle-button line-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-noj-c106="" class="handle-button theme-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-noj-c106="" class="handle-button copy-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-noj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { zlib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 示例一：从文件中不断读取数据进行压缩</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'deflateFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.bin'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-title function_">deflateFile</span>(inFile, outFile).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflateFile success'</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>        })</li><li>      })</li><li>
</li><li>      <span class="hljs-comment">// 示例二：从文件中不断读取压缩数据进行解压</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'inflateFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.bin'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-title function_">inflateFile</span>(inFile, outFile).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflateFile success'</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 从一个文件中，不断的读入数据，进行压缩，并写入到另一个文件中</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deflateFile</span>(<span class="hljs-params">src: fs.File, dest: fs.File</span>) {</li><li>  <span class="hljs-keyword">let</span> flush = zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">strm</span>: zlib.<span class="hljs-property">ZStream</span> = {};  <span class="hljs-comment">//初始化一个压缩流</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFLEN</span> = <span class="hljs-number">4096</span>;</li><li>  <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>);  <span class="hljs-comment">// 初始化一个输入缓冲区</span></li><li>  <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>); <span class="hljs-comment">// 初始化一个输出缓冲区</span></li><li>  <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>  <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>  <span class="hljs-comment">// 初始化流的状态</span></li><li>  <span class="hljs-keyword">let</span> initStatus = zip.<span class="hljs-title function_">deflateInit</span>(strm, zlib.<span class="hljs-property">CompressLevel</span>.<span class="hljs-property">COMPRESS_LEVEL_BEST_SPEED</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflateInit ret: '</span> + (<span class="hljs-keyword">await</span> initStatus).<span class="hljs-title function_">valueOf</span>());</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-comment">// 从文件中读取数据到缓冲区</span></li><li>    <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(src.<span class="hljs-property">fd</span>, inBuf);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"readSync readLen: "</span> + readLen);</li><li>    flush = readLen == <span class="hljs-number">0</span> ? zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">FINISH</span> : zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>;</li><li>    <span class="hljs-comment">// 设置输入缓冲区</span></li><li>    strm.<span class="hljs-property">availableIn</span> = readLen;</li><li>    strm.<span class="hljs-property">nextIn</span> = inBuf;</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-comment">// 设置输出缓冲区</span></li><li>      strm.<span class="hljs-property">availableOut</span> = <span class="hljs-variable constant_">BUFLEN</span>;</li><li>      strm.<span class="hljs-property">nextOut</span> = outBuf;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 压缩输入缓冲区中数据到输出缓冲区</span></li><li>        <span class="hljs-keyword">let</span> deflateStatus = zip.<span class="hljs-title function_">deflate</span>(strm, flush);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflate ret: '</span> + (<span class="hljs-keyword">await</span> deflateStatus).<span class="hljs-title function_">valueOf</span>());</li><li>        <span class="hljs-comment">// 更新流的状态</span></li><li>        <span class="hljs-keyword">let</span> innerStrm = zip.<span class="hljs-title function_">getZStream</span>();</li><li>        strm.<span class="hljs-property">availableIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableIn</span>;</li><li>        strm.<span class="hljs-property">nextIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextIn</span>;</li><li>        strm.<span class="hljs-property">availableOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableOut</span>;</li><li>        strm.<span class="hljs-property">nextOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextOut</span>;</li><li>        strm.<span class="hljs-property">totalIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalIn</span>;</li><li>        strm.<span class="hljs-property">totalOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalOut</span>;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (strm.<span class="hljs-property">availableOut</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-comment">// 将已完成压缩的数据，写入到输出文件中</span></li><li>          <span class="hljs-keyword">let</span> have = <span class="hljs-variable constant_">BUFLEN</span> - strm.<span class="hljs-property">availableOut</span>;</li><li>          <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(dest.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: have });</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`writeSync writeLen: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'deflate err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (strm.<span class="hljs-property">availableOut</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// 循环压缩输入缓冲区中剩余的数据，直到全部完成压缩</span></li><li>  } <span class="hljs-keyword">while</span> (flush != zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">FINISH</span>); <span class="hljs-comment">// 循环从文件中读取数据，直到数据全部读取</span></li><li>  <span class="hljs-comment">// 释放资源</span></li><li>  zip.<span class="hljs-title function_">deflateEnd</span>(strm);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 从一个文件中，不断的读入已压缩的数据，进行解压，并写入到另一个文件中</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">inflateFile</span>(<span class="hljs-params">src: fs.File, dest: fs.File</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">status</span>: zlib.<span class="hljs-property">ReturnStatus</span> = zlib.<span class="hljs-property">ReturnStatus</span>.<span class="hljs-property">OK</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">strm</span>: zlib.<span class="hljs-property">ZStream</span> = {};  <span class="hljs-comment">//初始化一个压缩流</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFLEN</span> = <span class="hljs-number">4096</span>;</li><li>  <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>);  <span class="hljs-comment">// 初始化一个输入缓冲区</span></li><li>  <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>); <span class="hljs-comment">// 初始化一个输出缓冲区</span></li><li>  <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>  <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>  <span class="hljs-comment">// 初始化流的状态</span></li><li>  <span class="hljs-keyword">let</span> initStatus = zip.<span class="hljs-title function_">inflateInit</span>(strm);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflateInit ret: '</span> + (<span class="hljs-keyword">await</span> initStatus).<span class="hljs-title function_">valueOf</span>());</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-comment">// 从文件中读取已压缩的数据到缓冲区</span></li><li>    <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(src.<span class="hljs-property">fd</span>, inBuf);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"readSync readLen: "</span> + readLen);</li><li>    <span class="hljs-keyword">if</span> (readLen == <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 设置输入缓冲区</span></li><li>    strm.<span class="hljs-property">availableIn</span> = readLen;</li><li>    strm.<span class="hljs-property">nextIn</span> = inBuf;</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-comment">// 设置输出缓冲区</span></li><li>      strm.<span class="hljs-property">availableOut</span> = <span class="hljs-variable constant_">BUFLEN</span>;</li><li>      strm.<span class="hljs-property">nextOut</span> = outBuf;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 解压输入缓冲区中数据到输出缓冲区</span></li><li>        <span class="hljs-keyword">let</span> inflateStatus = zip.<span class="hljs-title function_">inflate</span>(strm, zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflate ret: '</span> + (<span class="hljs-keyword">await</span> inflateStatus).<span class="hljs-title function_">valueOf</span>());</li><li>        status = <span class="hljs-keyword">await</span> inflateStatus;</li><li>        <span class="hljs-comment">// 更新流的状态</span></li><li>        <span class="hljs-keyword">let</span> innerStrm = zip.<span class="hljs-title function_">getZStream</span>();</li><li>        strm.<span class="hljs-property">availableIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableIn</span>;</li><li>        strm.<span class="hljs-property">nextIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextIn</span>;</li><li>        strm.<span class="hljs-property">availableOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableOut</span>;</li><li>        strm.<span class="hljs-property">nextOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextOut</span>;</li><li>        strm.<span class="hljs-property">totalIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalIn</span>;</li><li>        strm.<span class="hljs-property">totalOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalOut</span>;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (strm.<span class="hljs-property">availableOut</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-comment">// 将已完成解压的数据，写入到输出文件中</span></li><li>          <span class="hljs-keyword">let</span> have = <span class="hljs-variable constant_">BUFLEN</span> - strm.<span class="hljs-property">availableOut</span>;</li><li>          <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(dest.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: have });</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`writeSync writeLen: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'inflate err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (strm.<span class="hljs-property">availableOut</span> == <span class="hljs-number">0</span>)  <span class="hljs-comment">// 循环解压输入缓冲区中剩余的数据，直到全部完成解压</span></li><li>  } <span class="hljs-keyword">while</span> (status != zlib.<span class="hljs-property">ReturnStatus</span>.<span class="hljs-property">STREAM_END</span>.<span class="hljs-title function_">valueOf</span>())  <span class="hljs-comment">// 循环从文件中读取数据，直到数据全部读取</span></li><li>  <span class="hljs-comment">// 释放资源</span></li><li>  zip.<span class="hljs-title function_">inflateEnd</span>(strm);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="未知大小缓冲区的压缩与解压gzip格式">未知大小缓冲区的压缩与解压（gzip格式）<i class="anchor-icon anchor-icon-link" anchorid="未知大小缓冲区的压缩与解压gzip格式" tips="复制节点链接"></i></h3>          <p>采用gzip格式，针对一个未知大小的缓冲区中的数据，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#deflate12" target="_blank">deflate()</a>将从一个原始输入流中读取的数据进行压缩，使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-zlib#inflate12" target="_blank">inflate()</a>将从一个压缩输入流中读取的数据进行解压，示例代码如下。</p>     <div _ngcontent-noj-c106="" class="highlight-div"><div _ngcontent-noj-c106="" class="highlight-div-header"><div _ngcontent-noj-c106="" class="highlight-div-header-left"><div _ngcontent-noj-c106="" class="handle-button expand-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-noj-c106="" class="highlight-div-header-right"><div _ngcontent-noj-c106="" class="handle-button ai-button"></div><div _ngcontent-noj-c106="" class="handle-button line-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-noj-c106="" class="handle-button theme-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-noj-c106="" class="handle-button copy-button"><div _ngcontent-noj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-noj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { zlib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 示例一：从文件中不断读取数据进行压缩</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'deflateGzipFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.gz'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-title function_">deflateGzipFile</span>(inFile, outFile).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflateGzipFile success'</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>        })</li><li>      })</li><li>
</li><li>      <span class="hljs-comment">// 示例二：从文件中不断读取压缩数据进行解压</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'inflateGzipFile'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">filesDir</span>;</li><li>        <span class="hljs-keyword">let</span> inFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.gz'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-keyword">let</span> outFile = fs.<span class="hljs-title function_">openSync</span>(path + <span class="hljs-string">'/data.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        <span class="hljs-title function_">inflateGzipFile</span>(inFile, outFile).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflateGzipFile success'</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(inFile.<span class="hljs-property">fd</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(outFile.<span class="hljs-property">fd</span>);</li><li>        })</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 从一个文件中，不断的读入数据，进行压缩，并写入到另一个文件中</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deflateGzipFile</span>(<span class="hljs-params">src: fs.File, dest: fs.File</span>) {</li><li>  <span class="hljs-keyword">let</span> flush = zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">strm</span>: zlib.<span class="hljs-property">ZStream</span> = {};  <span class="hljs-comment">//初始化一个压缩流</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFLEN</span> = <span class="hljs-number">4096</span>;</li><li>  <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>);  <span class="hljs-comment">// 初始化一个输入缓冲区</span></li><li>  <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>); <span class="hljs-comment">// 初始化一个输出缓冲区</span></li><li>  <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>  <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>  <span class="hljs-comment">// 初始化流的状态，windowBits &gt; 15时，启用gzip格式</span></li><li>  <span class="hljs-keyword">let</span> windowBits = <span class="hljs-number">15</span> + <span class="hljs-number">16</span>;</li><li>  <span class="hljs-keyword">let</span> initStatus = zip.<span class="hljs-title function_">deflateInit2</span>(strm, zlib.<span class="hljs-property">CompressLevel</span>.<span class="hljs-property">COMPRESS_LEVEL_BEST_SPEED</span>,</li><li>    zlib.<span class="hljs-property">CompressMethod</span>.<span class="hljs-property">DEFLATED</span>, windowBits, zlib.<span class="hljs-property">MemLevel</span>.<span class="hljs-property">MEM_LEVEL_DEFAULT</span>,</li><li>    zlib.<span class="hljs-property">CompressStrategy</span>.<span class="hljs-property">COMPRESS_STRATEGY_DEFAULT_STRATEGY</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflateInit2 ret: '</span> + (<span class="hljs-keyword">await</span> initStatus).<span class="hljs-title function_">valueOf</span>());</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-comment">// 从文件中读取数据到缓冲区</span></li><li>    <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(src.<span class="hljs-property">fd</span>, inBuf);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"readSync readLen: "</span> + readLen);</li><li>    flush = readLen == <span class="hljs-number">0</span> ? zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">FINISH</span> : zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>;</li><li>    <span class="hljs-comment">// 设置输入缓冲区</span></li><li>    strm.<span class="hljs-property">availableIn</span> = readLen;</li><li>    strm.<span class="hljs-property">nextIn</span> = inBuf;</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-comment">// 设置输出缓冲区</span></li><li>      strm.<span class="hljs-property">availableOut</span> = <span class="hljs-variable constant_">BUFLEN</span>;</li><li>      strm.<span class="hljs-property">nextOut</span> = outBuf;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 压缩输入缓冲区中数据到输出缓冲区</span></li><li>        <span class="hljs-keyword">let</span> deflateStatus = zip.<span class="hljs-title function_">deflate</span>(strm, flush);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'deflate ret: '</span> + (<span class="hljs-keyword">await</span> deflateStatus).<span class="hljs-title function_">valueOf</span>());</li><li>        <span class="hljs-comment">// 更新流的状态</span></li><li>        <span class="hljs-keyword">let</span> innerStrm = zip.<span class="hljs-title function_">getZStream</span>();</li><li>        strm.<span class="hljs-property">availableIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableIn</span>;</li><li>        strm.<span class="hljs-property">nextIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextIn</span>;</li><li>        strm.<span class="hljs-property">availableOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableOut</span>;</li><li>        strm.<span class="hljs-property">nextOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextOut</span>;</li><li>        strm.<span class="hljs-property">totalIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalIn</span>;</li><li>        strm.<span class="hljs-property">totalOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalOut</span>;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (strm.<span class="hljs-property">availableOut</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-comment">// 将已完成压缩的数据，写入到输出文件中</span></li><li>          <span class="hljs-keyword">let</span> have = <span class="hljs-variable constant_">BUFLEN</span> - strm.<span class="hljs-property">availableOut</span>;</li><li>          <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(dest.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: have });</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`writeSync writeLen: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'deflate err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (strm.<span class="hljs-property">availableOut</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// 循环压缩输入缓冲区中剩余的数据，直到全部完成压缩</span></li><li>  } <span class="hljs-keyword">while</span> (flush != zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">FINISH</span>); <span class="hljs-comment">// 循环从文件中读取数据，直到数据全部读取</span></li><li>  <span class="hljs-comment">// 释放资源</span></li><li>  zip.<span class="hljs-title function_">deflateEnd</span>(strm);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 从一个文件中，不断的读入已压缩的数据，进行解压，并写入到另一个文件中</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">inflateGzipFile</span>(<span class="hljs-params">src: fs.File, dest: fs.File</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">status</span>: zlib.<span class="hljs-property">ReturnStatus</span> = zlib.<span class="hljs-property">ReturnStatus</span>.<span class="hljs-property">OK</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">strm</span>: zlib.<span class="hljs-property">ZStream</span> = {};  <span class="hljs-comment">//初始化一个压缩流</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFLEN</span> = <span class="hljs-number">4096</span>;</li><li>  <span class="hljs-keyword">let</span> inBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>);  <span class="hljs-comment">// 初始化一个输入缓冲区</span></li><li>  <span class="hljs-keyword">let</span> outBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">BUFLEN</span>); <span class="hljs-comment">// 初始化一个输出缓冲区</span></li><li>  <span class="hljs-comment">// 创建一个压缩对象实例</span></li><li>  <span class="hljs-keyword">let</span> zip = zlib.<span class="hljs-title function_">createZipSync</span>();</li><li>  <span class="hljs-comment">// 初始化流的状态，windowBits &gt; 15时，启用gzip格式</span></li><li>  <span class="hljs-keyword">let</span> windowBits = <span class="hljs-number">15</span> + <span class="hljs-number">16</span>;</li><li>  <span class="hljs-keyword">let</span> initStatus = zip.<span class="hljs-title function_">inflateInit2</span>(strm, windowBits);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflateInit2 ret: '</span> + (<span class="hljs-keyword">await</span> initStatus).<span class="hljs-title function_">valueOf</span>());</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-comment">// 从文件中读取已压缩的数据到缓冲区</span></li><li>    <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(src.<span class="hljs-property">fd</span>, inBuf);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"readSync readLen: "</span> + readLen);</li><li>    <span class="hljs-keyword">if</span> (readLen == <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 设置输入缓冲区</span></li><li>    strm.<span class="hljs-property">availableIn</span> = readLen;</li><li>    strm.<span class="hljs-property">nextIn</span> = inBuf;</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-comment">// 设置输出缓冲区</span></li><li>      strm.<span class="hljs-property">availableOut</span> = <span class="hljs-variable constant_">BUFLEN</span>;</li><li>      strm.<span class="hljs-property">nextOut</span> = outBuf;</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 解压输入缓冲区中数据到输出缓冲区</span></li><li>        <span class="hljs-keyword">let</span> inflateStatus = zip.<span class="hljs-title function_">inflate</span>(strm, zlib.<span class="hljs-property">CompressFlushMode</span>.<span class="hljs-property">NO_FLUSH</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'inflate ret: '</span> + (<span class="hljs-keyword">await</span> inflateStatus).<span class="hljs-title function_">valueOf</span>());</li><li>        status = <span class="hljs-keyword">await</span> inflateStatus;</li><li>        <span class="hljs-comment">// 更新流的状态</span></li><li>        <span class="hljs-keyword">let</span> innerStrm = zip.<span class="hljs-title function_">getZStream</span>();</li><li>        strm.<span class="hljs-property">availableIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableIn</span>;</li><li>        strm.<span class="hljs-property">nextIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextIn</span>;</li><li>        strm.<span class="hljs-property">availableOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">availableOut</span>;</li><li>        strm.<span class="hljs-property">nextOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">nextOut</span>;</li><li>        strm.<span class="hljs-property">totalIn</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalIn</span>;</li><li>        strm.<span class="hljs-property">totalOut</span> = (<span class="hljs-keyword">await</span> innerStrm).<span class="hljs-property">totalOut</span>;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (strm.<span class="hljs-property">availableOut</span> != <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-comment">// 将已完成解压的数据，写入到输出文件中</span></li><li>          <span class="hljs-keyword">let</span> have = <span class="hljs-variable constant_">BUFLEN</span> - strm.<span class="hljs-property">availableOut</span>;</li><li>          <span class="hljs-keyword">let</span> writeLen = fs.<span class="hljs-title function_">writeSync</span>(dest.<span class="hljs-property">fd</span>, outBuf, { <span class="hljs-attr">length</span>: have });</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`writeSync writeLen: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'inflate err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (strm.<span class="hljs-property">availableOut</span> == <span class="hljs-number">0</span>)  <span class="hljs-comment">// 循环解压输入缓冲区中剩余的数据，直到全部完成解压</span></li><li>  } <span class="hljs-keyword">while</span> (status != zlib.<span class="hljs-property">ReturnStatus</span>.<span class="hljs-property">STREAM_END</span>.<span class="hljs-title function_">valueOf</span>())  <span class="hljs-comment">// 循环从文件中读取数据，直到数据全部读取</span></li><li>  <span class="hljs-comment">// 释放资源</span></li><li>  zip.<span class="hljs-title function_">inflateEnd</span>(strm);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>17800005 传入的数据错误</p>       <p>可能原因和处理步骤，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-zlib#section17800005-传入的数据错误" target="_blank">错误码17800005</a>。</p></li>      <li>       <p>17800007 传入的缓冲区错误</p>       <p>可能原因和处理步骤，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-zlib#section17800007-传入的缓冲区错误" target="_blank">错误码17800007</a>。</p></li>     </ol>    </div>   </div>   <div></div></div>