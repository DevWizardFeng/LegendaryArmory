<h1 _ngcontent-ixt-c119="" class="doc-title ng-star-inserted" title="双层HDR图片转换单层"> 双层HDR图片转换单层 </h1>

<div _ngcontent-ixt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>调用者可以调用本模块提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-imageprocessing" target="_blank">C API接口</a>，实现将双层HDR图片转换为单层HDR图片。</p> <p>该能力常用于图片分享中，如下图所示：</p> <p><span><img height="106.30690000000001" originheight="157" originwidth="1041" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114452.22676351129284426751206475899599:50001231000000:2800:EE96083B8C645AF44EC3468702D1EE10B662C0ECC865C5790CCF0BDF0F05A11B.png" title="点击放大" width="704.9000000000001"></span></p> <div class="tiledSection"><h2 id="section26741381495">规格说明<i class="anchor-icon anchor-icon-link" anchorid="section26741381495" tips="复制节点链接"></i></h2><p><strong>支持的数据输入格式</strong><strong>：</strong></p> <p>使用图片双层HDR转单层HDR转换算法Compose。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.1" valign="top" width="16.666666666666664%"><p>输入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-color-space-manager-h#colorspacename" target="_blank">ColorSpaceName</a></p> <p></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.2" valign="top" width="16.666666666666664%"><p>输入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmap_hdrmetadatatype" target="_blank">HdrMetadataType</a></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.3" valign="top" width="16.666666666666664%"><p>输入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#pixel_format" target="_blank">PIXEL_FORMAT</a></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.4" valign="top" width="16.666666666666664%"><p><strong>输出<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-color-space-manager-h#colorspacename" target="_blank">ColorSpaceName</a></strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.5" valign="top" width="16.666666666666664%"><p><strong>输出</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmap_hdrmetadatatype" target="_blank">HdrMetadataType</a></p> <p></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.1.7.1.6" valign="top" width="16.666666666666664%"><p><strong>输出<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#pixel_format" target="_blank">PIXEL_FORMAT</a></strong></p> <p></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.666666666666664%"><p>DISPLAY_P3_LIMIT/DISPLAY_P3</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_BASE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>RGBA_8888</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>BT2020_HLG</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_ALTERNATE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>YCBCR_P010 / RGBA_1010102</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.666666666666664%"><p>SRGB_LIMIT/SRGB</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_BASE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>RGBA_8888</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>BT2020_HLG</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_ALTERNATE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>YCBCR_P010 / RGBA_1010102</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.666666666666664%"><p>DISPLAY_P3_LIMIT/DISPLAY_P3</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_BASE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>RGBA_8888</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>BT2020_PQ</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_ALTERNATE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>YCBCR_P010 / RGBA_1010102</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.666666666666664%"><p>SRGB_LIMIT/SRGB</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_BASE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>RGBA_8888</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>BT2020_PQ</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>HDR_METADATA_TYPE_ALTERNATE</p> </td> <td class="cellrowborder" valign="top" width="16.666666666666664%"><p>YCBCR_P010 / RGBA_1010102</p> </td> </tr>  </tbody></table></div> </div> <p><strong>分辨率规格：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.6.1.3.1.1" valign="top" width="38.21%"><p><strong>最小分辨率</strong>（单位：像素）</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.6.1.3.1.2" valign="top" width="61.79%"><p><strong>最大分辨率</strong>（单位：像素）</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="38.21%"><p>32*32</p> </td> <td class="cellrowborder" valign="top" width="61.79%"><p>8880*8880</p> </td> </tr>  </tbody></table></div> </div> <p><strong>内存规格：</strong></p> <p>处理的PixelMap对象需为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-allocator-type-c#内存类型介绍" target="_blank">DMA内存</a>。</p> </div> <div class="tiledSection"><h2 id="section10165233102918">开发指导<i class="anchor-icon anchor-icon-link" anchorid="section10165233102918" tips="复制节点链接"></i></h2></div> <p>具体实现可参考<a href="https://gitee.com/harmonyos_samples/DocsSample_MultiMedia/tree/master/UsingImageProcessingToProcessImages" target="_blank">示例工程</a>。</p> <div class="tiledSection"><h3 id="section9378144613208" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section9378144613208" tips="复制节点链接"></i></h3><div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libimage_processing.so)</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section1217812118013">ArkTS侧调用的开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1217812118013" tips="复制节点链接"></i></h3><ol><li>创建10 bit的PixelMap。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">opts</span>: image.<span class="hljs-property">InitializationOptions</span> = {</li><li>  <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">pixelFormat</span>: image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCBCR_P010</span>,</li><li>  <span class="hljs-attr">size</span>: {</li><li>    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputHeight</span>,</li><li>    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputWidth</span></li><li>  }</li><li>};</li><li><span class="hljs-keyword">let</span> outPutPixelMap = image.<span class="hljs-title function_">createPixelMapSync</span>(opts);</li></ol></pre></div></div> </li><li>创建8 bit的PixelMap。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> sdrpixelMap : image.<span class="hljs-property">PixelMap</span> = nativePix.<span class="hljs-title function_">createPixelMapTest</span>(imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>, imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>);</li><li><span class="hljs-keyword">let</span> gainmappixelMap : image.<span class="hljs-property">PixelMap</span> = nativePix.<span class="hljs-title function_">createPixelMapTest</span>(imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>, imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>);</li></ol></pre></div></div> </li><li>配置色彩框架和元数据信息。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> colorSpaceDISPLAY_P3 : colorSpaceManager.<span class="hljs-property">ColorSpaceManager</span> = colorSpaceManager.<span class="hljs-title function_">create</span>(colorSpaceManager.<span class="hljs-property">ColorSpace</span>.<span class="hljs-property">DISPLAY_P3</span>);</li><li><span class="hljs-keyword">let</span> colorSpaceBT2020_HLG : colorSpaceManager.<span class="hljs-property">ColorSpaceManager</span> = colorSpaceManager.<span class="hljs-title function_">create</span>(colorSpaceManager.<span class="hljs-property">ColorSpace</span>.<span class="hljs-property">BT2020_HLG</span>);</li><li>sdrpixelMap.<span class="hljs-title function_">setColorSpace</span>(colorSpaceDISPLAY_P3);</li><li>sdrpixelMap.<span class="hljs-title function_">setMetadata</span>(image.<span class="hljs-property">HdrMetadataKey</span>.<span class="hljs-property">HDR_METADATA_TYPE</span>, image.<span class="hljs-property">HdrMetadataType</span>.<span class="hljs-property">BASE</span>);</li><li>gainmappixelMap.<span class="hljs-title function_">setColorSpace</span>(colorSpaceDISPLAY_P3);</li><li>gainmappixelMap.<span class="hljs-title function_">setMetadata</span>(image.<span class="hljs-property">HdrMetadataKey</span>.<span class="hljs-property">HDR_METADATA_TYPE</span>, image.<span class="hljs-property">HdrMetadataType</span>.<span class="hljs-property">GAINMAP</span>);</li><li>hdrpixelMap.<span class="hljs-title function_">setColorSpace</span>(colorSpaceBT2020_HLG);</li><li>hdrpixelMap.<span class="hljs-title function_">setMetadata</span>(image.<span class="hljs-property">HdrMetadataKey</span>.<span class="hljs-property">HDR_METADATA_TYPE</span>, image.<span class="hljs-property">HdrMetadataType</span>.<span class="hljs-property">ALTERNATE</span>);</li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section424581418109">Native侧调用的开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section424581418109" tips="复制节点链接"></i></h3><ol><li>添加头文件。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_mdk_common.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_pixel_map_mdk.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/pixelmap_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/video_processing_engine/image_processing.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/video_processing_engine/image_processing_types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_color_space_manager/native_color_space_manager.h&gt;</span></span></li></ol></pre></div></div> </li><li>（可选）初始化环境。<div class="p">一般在进程内第一次使用时调用，可提前完成部分耗时操作。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>ImageProcessing_ErrorCode ret =  <span class="hljs-built_in">OH_ImageProcessing_InitializeEnvironment</span>();</li></ol></pre></div></div> </div> </li><li>（可选）查询能力支持。建议在使用对应能力前调用。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//输入格式</span></li><li>DST_INFO.colorSpace = BT2020_HLG;</li><li>DST_INFO.metadataType = HDR_METADATA_TYPE_ALTERNATE;</li><li>DST_INFO.pixelFormat = PIXEL_FORMAT_RGBA_1010102;</li><li>SRC_INFO.colorSpace = DISPLAY_P3;</li><li>SRC_INFO.metadataType = HDR_METADATA_TYPE_BASE;</li><li>SRC_INFO.pixelFormat = PIXEL_FORMAT_RGBA_8888;</li><li>SRC_GAIN_INFO.colorSpace = DISPLAY_P3;</li><li>SRC_GAIN_INFO.metadataType = HDR_METADATA_TYPE_GAINMAP;</li><li>SRC_GAIN_INFO.pixelFormat = PIXEL_FORMAT_RGBA_8888;</li><li><span class="hljs-comment">//能力查询</span></li><li><span class="hljs-type">bool</span> flag = <span class="hljs-built_in">OH_ImageProcessing_IsCompositionSupported</span>(&amp;SRC_INFO, &amp;SRC_GAIN_INFO, &amp;DST_INFO);</li></ol></pre></div></div> </li><li>创建8 bit的PixelMap。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">napi_value <span class="hljs-title">ImageProcessing::</span></span><span class=""><span class="hljs-function"><span class="hljs-title">CreatePixelMap</span></span></span><span class="hljs-function"><span class="hljs-params">(napi_env env</span></span><span class=""><span class="hljs-function"><span class="hljs-params">, </span></span></span><span class="hljs-function"><span class="hljs-params">napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value udfVar = <span class=""><span class="hljs-literal">nullptr</span>;</span></li><li>    napi_value pixelMap = <span class=""><span class="hljs-literal">nullptr</span>;</span></li><li>    napi_value thisVar = <span class=""><span class="hljs-literal">nullptr</span>;</span></li><li>    napi_value argValue[<span class=""><span class="hljs-number">2</span></span>] = {<span class=""><span class="hljs-number">0</span></span>}<span class="">;</span></li><li>    <span class="hljs-type">size_t</span> argCount = <span class=""><span class="hljs-number">2</span></span><span class="">;</span></li><li>    <span class="hljs-type">size_t</span> count = <span class=""><span class="hljs-number">2</span></span><span class="">;</span></li><li><span class="">    <span class="hljs-keyword">if</span> </span>(<span class=""><span class="hljs-built_in">napi_get_cb_info</span></span>(env<span class="">, </span>info<span class="">, </span>&amp;argCount<span class="">, </span>argValue<span class="">, </span>&amp;thisVar<span class="">, <span class="hljs-literal">nullptr</span></span>) != <span class="">napi_ok </span>|| argCount &lt; count ||</li><li>        argValue[<span class=""><span class="hljs-number">0</span></span>] == <span class=""><span class="hljs-literal">nullptr</span> </span>|| argValue[<span class=""><span class="hljs-number">1</span></span>] == <span class=""><span class="hljs-literal">nullptr</span></span>) {</li><li>        <span class=""><span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</span></li><li>    }</li><li>    <span class="hljs-type">int32_t</span> width = <span class=""><span class="hljs-number">0</span></span><span class="">;</span></li><li>    <span class="hljs-type">int32_t</span> height = <span class=""><span class="hljs-number">0</span></span><span class="">;</span></li><li>    <span class=""><span class="hljs-built_in">napi_get_value_int32</span></span>(env<span class="">, </span>argValue[<span class=""><span class="hljs-number">1</span></span>]<span class="">, </span>&amp;width)<span class="">;</span></li><li>    <span class=""><span class="hljs-built_in">napi_get_value_int32</span></span>(env<span class="">, </span>argValue[<span class=""><span class="hljs-number">0</span></span>]<span class="">, </span>&amp;height)<span class="">;</span></li><li><span class="">    <span class="hljs-keyword">struct</span> </span><span class="hljs-title class_">OhosPixelMapCreateOps</span> createOps<span class="">;</span></li><li>    createOps.<span class="">width </span>= width<span class="">;</span></li><li>    createOps.<span class="">height </span>= height<span class="">;</span></li><li>    <span class="hljs-type">int32_t</span> rgba8888 = <span class=""><span class="hljs-number">3</span></span><span class="">;</span></li><li>    createOps.<span class="">pixelFormat </span>= rgba8888<span class="">;</span></li><li>    createOps.<span class="">alphaType </span>= <span class=""><span class="hljs-number">0</span></span><span class="">;</span></li><li>    </li><li>    <span class="hljs-type">size_t</span> bufferSize = createOps.<span class="">width </span>* createOps.<span class="">height </span>* <span class=""><span class="hljs-number">4</span></span><span class="">;</span></li><li><span class="">    <span class="hljs-type">void</span> </span>*buff = <span class=""><span class="hljs-built_in">malloc</span></span>(bufferSize)<span class="">;</span></li><li>    <span class="hljs-type">int32_t</span> res = <span class=""><span class="hljs-built_in">OH_PixelMap_CreatePixelMapWithStride</span></span>(env<span class="">, </span>createOps<span class="">, </span>(<span class="hljs-type">uint8_t</span> *)buff<span class="">, </span>bufferSize<span class="">, </span>createOps.<span class="">width </span>* <span class=""><span class="hljs-number">4</span></span><span class="">,</span></li><li>        &amp;pixelMap)<span class="">;</span></li><li>    <span class=""><span class="hljs-built_in">free</span></span>(buff)<span class="">;</span></li><li>    <span class=""><span class="hljs-built_in">OH_LOG_Print</span></span>(<span class="">LOG_APP</span><span class="">, </span><span class="">LOG_INFO</span><span class="">, </span>LOG_PRINT_DOMAIN<span class="">, </span><span class=""><span class="hljs-string">"createPixelMap"</span></span><span class="">,</span></li><li>        <span class=""><span class="hljs-string">"OH_PixelMap_CreatePixelMapWithStride %{public}d"</span></span><span class="">, </span>res)<span class="">;</span></li><li><span class="">    <span class="hljs-keyword">if</span> </span>(res != <span class="">IMAGE_RESULT_SUCCESS </span>|| pixelMap == <span class=""><span class="hljs-literal">nullptr</span></span>) {</li><li>        <span class=""><span class="hljs-keyword">return</span> </span>udfVar<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>pixelMap<span class="">;</span></li><li>}</li></ol></pre></div></div> </li><li>将ArkTS中的PixelMap转换为C++的PixelMap。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_PixelmapNative* sdr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_PixelmapNative_ConvertPixelmapNativeFromNapi</span>(env, argValue[<span class="hljs-number">0</span>], &amp;sdr);</li><li>OH_PixelmapNative* gainmap = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_PixelmapNative_ConvertPixelmapNativeFromNapi</span>(env, argValue[<span class="hljs-number">1</span>], &amp;gainmap);</li><li>OH_PixelmapNative* hdr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-built_in">OH_PixelmapNative_ConvertPixelmapNativeFromNapi</span>(env, argValue[<span class="hljs-number">2</span>], &amp;hdr);</li></ol></pre></div></div> </li><li>创建图片HDR双层转单层模块。<p>应用可以通过图片处理引擎模块类型来创建图片HDR双层转单层模块。示例中的变量说明如下：</p> <ul><li>instance：图片处理模块实例。</li><li>IMAGE_PROCESSING_TYPE_COMPOSITION：HDR双层转单层。</li><li>预期返回值：IMAGE_PROCESSING_SUCCESS</li></ul> <div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OH_ImageProcessing* instance = <span class="hljs-literal">nullptr</span>;</li><li>ret = <span class="hljs-built_in">OH_ImageProcessing_Create</span>(&amp;instance, IMAGE_PROCESSING_TYPE_COMPOSITION);</li></ol></pre></div></div> </li><li>执行算法。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>ret = <span class="hljs-built_in">OH_ImageProcessing_Compose</span>(instance, sdr, gainmap, hdr);</li></ol></pre></div></div> </li><li>释放实例资源。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>ret = <span class="hljs-built_in">OH_ImageProcessing_Destroy</span>(instance);</li><li>instance = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div> </li><li>释放初始化环境资源。<div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ini" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">ret</span> = OH_ImageProcessing_DeinitializeEnvironment()<span class="hljs-comment">;</span></li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section036716376911">完整示例代码<i class="anchor-icon anchor-icon-link" anchorid="section036716376911" tips="复制节点链接"></i></h2><div class="p">ArkTS示例代码：<div class="screenLinkPre"><div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>compose.ets示例代码<span class=""><br></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DocsSample_MultiMedia/blob/master/UsingImageProcessingToProcessImages/entry/src/main/ets/view/HDRImageConversionComponent.ets#" target="_blank">HDRcompose.ets</a></div></div></div></div> </div> <p>C++相关示例代码：</p> <div class="screenLinkPre"><div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">CMakeLists</span>.txt示例代码地址<span class=""><br></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DocsSample_MultiMedia/blob/master/UsingImageProcessingToProcessImages/entry/src/main/cpp/CMakeLists.txt" target="_blank">CMakeLists.txt</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>ImageProcessing.cpp示例代码地址<span class=""><br></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DocsSample_MultiMedia/blob/master/UsingImageProcessingToProcessImages/entry/src/main/cpp/ImageProcessing/ImageProcessing.cpp" target="_blank">ImageProcessing.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-ixt-c106="" class="highlight-div"><div _ngcontent-ixt-c106="" class="highlight-div-header"><div _ngcontent-ixt-c106="" class="highlight-div-header-left"><div _ngcontent-ixt-c106="" class="handle-button expand-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ixt-c106="" class="highlight-div-header-right"><div _ngcontent-ixt-c106="" class="handle-button ai-button"></div><div _ngcontent-ixt-c106="" class="handle-button line-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ixt-c106="" class="handle-button theme-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ixt-c106="" class="handle-button copy-button"><div _ngcontent-ixt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ixt-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-undefined" data-highlighted="yes"><ol class="linenums"><li>ImageProcessing.h示例代码地址<span class=""><br></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DocsSample_MultiMedia/blob/master/UsingImageProcessingToProcessImages/entry/src/main/cpp/ImageProcessing/ImageProcessing.h" target="_blank">ImageProcessing.h</a></div></div></div></div> <p></p> </div> </div> <div></div></div>