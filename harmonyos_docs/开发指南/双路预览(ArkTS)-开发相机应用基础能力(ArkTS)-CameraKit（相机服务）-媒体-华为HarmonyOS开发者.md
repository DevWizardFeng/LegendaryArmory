<h1 _ngcontent-ech-c119="" class="doc-title ng-star-inserted" title="双路预览(ArkTS)"> 双路预览(ArkTS) </h1>

<div _ngcontent-ech-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p>    <p>双路预览，即应用可同时使用两路预览流，一路用于在屏幕上显示，一路用于图像处理等其他操作，提升处理效率。</p>    <p>相机应用通过控制相机，实现图像显示（预览）、照片保存（拍照）、视频录制（录像）等基础操作。相机开发模型为Surface模型，即应用通过Surface进行数据传递，通过ImageReceiver的surface获取拍照流的数据、通过XComponent的surface获取预览流的数据。</p>    <p>如果要实现双路预览，即将拍照流改为预览流，将拍照流中的surface改为预览流的surface，通过ImageReceiver的surface创建previewOutput，其余流程与拍照流和预览流一致。</p>    <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera" target="_blank">Camera API参考</a>。</p>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>          <ul>      <li>暂不支持动态添加流，即不能在没有调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#stop11" target="_blank">session.stop</a>的情况下，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addoutput11" target="_blank">addOutput</a>添加流。</li>      <li>对ImageReceiver组件获取到的图像数据处理后，需要将对应的图像Buffer释放，确保Surface的BufferQueue正常轮转。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="调用流程">调用流程<i class="anchor-icon anchor-icon-link" anchorid="调用流程" tips="复制节点链接"></i></h2>          <p>双路方案调用流程图建议如下：</p>     <p><span><img originheight="4096" originwidth="2709" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114427.79416386706335194265781121288404:50001231000000:2800:40413B638D4597304771732F622209EC41DAD6CA74DAC46F9C4D62049A67C188.png" width="920" height="1391.0372831303064"></span></p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ul>      <li>用于处理图像的第一路预览流：创建ImageReceiver对象，获取SurfaceId创建第一路预览流，注册图像监听，按需处理预览流每帧图像。</li>      <li>用于显示画面的第二路预览流：创建XComponent组件，获取SurfaceId创建第二路预览流，预览流画面直接在组件内渲染。</li>      <li>创建预览流获取数据：创建上述两路预览流，配置进相机会话，启动会话后，两路预览流同时获取数据。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="用于处理图像的第一路预览流" class="firsth2">用于处理图像的第一路预览流<i class="anchor-icon anchor-icon-link" anchorid="用于处理图像的第一路预览流" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>导入依赖，本篇文档需要用到图片和相机框架等相关依赖包。</p>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取第一路预览流SurfaceId：创建ImageReceiver对象，通过ImageReceiver对象可获取其SurfaceId。</p>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>; <span class="hljs-comment">// 请使用设备支持profile的size的宽。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// 请使用设备支持profile的size的高。</span></li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initImageReceiver</span>(<span class="hljs-params"></span>):<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;{</li><li>  <span class="hljs-comment">// 创建ImageReceiver对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>: image.<span class="hljs-property">Size</span> = { <span class="hljs-attr">width</span>: imageWidth, <span class="hljs-attr">height</span>: imageHeight };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">imageReceiver</span>: image.<span class="hljs-property">ImageReceiver</span> | <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    imageReceiver = image.<span class="hljs-title function_">createImageReceiver</span>(size, image.<span class="hljs-property">ImageFormat</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-number">8</span>);</li><li>  }  <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Init image receiver failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 获取第一路流SurfaceId。</span></li><li>  <span class="hljs-keyword">let</span> imageReceiverSurfaceId = <span class="hljs-keyword">await</span> imageReceiver.<span class="hljs-title function_">getReceivingSurfaceId</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initImageReceiver imageReceiverSurfaceId:<span class="hljs-subst">${imageReceiverSurfaceId}</span>`</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>ImageReceiver接收预览流图像数据获取图像格式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-image" target="_blank">Image</a>中的format参数，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>格式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-e#pixelmapformat7" target="_blank">PixelMapFormat</a>。</p>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Image格式与PixelMap格式映射关系。</span></li><li><span class="hljs-keyword">let</span> formatToPixelMapFormatMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, image.<span class="hljs-property">PixelMapFormat</span>&gt;([</li><li>  [<span class="hljs-number">12</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>],</li><li>  [<span class="hljs-number">25</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>],</li><li>  [<span class="hljs-number">35</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCBCR_P010</span>],</li><li>  [<span class="hljs-number">36</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCRCB_P010</span>]</li><li>]);</li><li><span class="hljs-comment">// PixelMapFormat格式的单个像素点大小映射关系。</span></li><li><span class="hljs-keyword">let</span> pixelMapFormatToSizeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;image.<span class="hljs-property">PixelMapFormat</span>, <span class="hljs-built_in">number</span>&gt;([</li><li>  [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>, <span class="hljs-number">4</span>],</li><li>  [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>, <span class="hljs-number">1.5</span>],</li><li>  [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCBCR_P010</span>, <span class="hljs-number">3</span>],</li><li>  [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCRCB_P010</span>, <span class="hljs-number">3</span>]</li><li>]);</li></ol></pre></div></div></li>      <li>       <p>注册监听处理预览流每帧图像数据：通过ImageReceiver组件中imageArrival事件监听获取底层返回的图像数据，详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">Image API参考</a>。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>在通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#imagecreatepixelmap8" target="_blank">createPixelMap</a>接口创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>实例时，设置的Size、srcPixelFormat等属性必须和相机预览输出流previewProfile中配置的Size、Format属性保持一致，ImageReceiver图片像素格式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-e#pixelmapformat7" target="_blank">PixelMapFormat</a>，相机预览输出流previewProfile输出格式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraformat" target="_blank">CameraFormat</a>。</li>          <li>由于一多设备产品差异性，应用开发者在创建相机预览输出流前，必须先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedoutputcapability11" target="_blank">getSupportedOutputCapability</a>方法获取当前设备支持的预览输出流previewProfile，再根据实际业务需求选择<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraformat" target="_blank">CameraFormat</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#size" target="_blank">Size</a>适合的预览输出流previewProfile。</li>          <li>ImageReceiver接收预览流图像数据实际format格式由应用开发者在创建预览输出流相机预览输出流时，根据实际业务需求选择的previewProfile中format格式参数影响，详细步骤请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-dual-channel-preview#创建预览流获取数据">创建预览流获取数据</a>。</li>         </ul>        </div></div></div>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onImageArrival</span>(<span class="hljs-params">receiver: image.ImageReceiver</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// 注册imageArrival监听。</span></li><li>  receiver.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 获取图像。</span></li><li>    receiver.<span class="hljs-title function_">readNextImage</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError, nextImage: image.Image</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err || nextImage === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readNextImage failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 解析图像内容。</span></li><li>      nextImage.<span class="hljs-title function_">getComponent</span>(image.<span class="hljs-property">ComponentType</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">imgComponent</span>: image.<span class="hljs-property">Component</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (err || imgComponent === <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getComponent failed'</span>);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (imgComponent.<span class="hljs-property">byteBuffer</span>) {</li><li>          <span class="hljs-comment">// 详情见下方解析图片buffer数据参考，本示例以方式一为例。</span></li><li>          <span class="hljs-keyword">let</span> width = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>; <span class="hljs-comment">// 获取图片的宽。</span></li><li>          <span class="hljs-keyword">let</span> height = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>; <span class="hljs-comment">// 获取图片的高。</span></li><li>          <span class="hljs-keyword">let</span> stride = imgComponent.<span class="hljs-property">rowStride</span>; <span class="hljs-comment">// 获取图片的stride。</span></li><li>          <span class="hljs-keyword">let</span> imageFormat = nextImage.<span class="hljs-property">format</span>; <span class="hljs-comment">// 获取图片的format。</span></li><li>          <span class="hljs-keyword">let</span> pixelMapFormat = formatToPixelMapFormatMap.<span class="hljs-title function_">get</span>(imageFormat) ?? image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>;</li><li>          <span class="hljs-keyword">let</span> mSize = pixelMapFormatToSizeMap.<span class="hljs-title function_">get</span>(pixelMapFormat) ?? <span class="hljs-number">1.5</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`getComponent with width:<span class="hljs-subst">${width}</span> height:<span class="hljs-subst">${height}</span> stride:<span class="hljs-subst">${stride}</span>`</span>);</li><li>          <span class="hljs-comment">// 如需使用pixelMap，参考以下逻辑。</span></li><li>          <span class="hljs-comment">// pixelMap创建时使用的size、srcPixelFormat需要与相机预览输出流previewProfile中的size、format保持一致。</span></li><li>          <span class="hljs-comment">// stride与width一致。</span></li><li>          <span class="hljs-keyword">let</span> pixelMap : image.<span class="hljs-property">PixelMap</span>;</li><li>          <span class="hljs-keyword">if</span> (stride == width) {</li><li>            pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, {</li><li>              <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>              <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat,</li><li>            })</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// stride与width不一致。</span></li><li>            <span class="hljs-keyword">const</span> dstBufferSize = width * height * mSize</li><li>            <span class="hljs-keyword">const</span> dstArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dstBufferSize)</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height * mSize; j++) {</li><li>              <span class="hljs-keyword">const</span> srcBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, j * stride, width)</li><li>              dstArr.<span class="hljs-title function_">set</span>(srcBuf, j * width)</li><li>            }</li><li>            pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(dstArr.<span class="hljs-property">buffer</span>, {</li><li>              <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>              <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat,</li><li>            })</li><li>          }</li><li>          <span class="hljs-comment">// 确保当前pixelMap没有在使用的情况下，可进行资源释放。</span></li><li>          <span class="hljs-keyword">if</span> (pixelMap != <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in releasing pixelMap object.'</span>);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to release pixelMap object. code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>            })</li><li>          }</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'byteBuffer is null'</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 确保当前buffer没有在使用的情况下，可进行资源释放。</span></li><li>        <span class="hljs-comment">// 如果对buffer进行异步操作，需要在异步操作结束后再释放该资源（nextImage.release()）。</span></li><li>        nextImage.<span class="hljs-title function_">release</span>();</li><li>      })</li><li>    })</li><li>  })</li><li>}</li></ol></pre></div></div>       <p>通过 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#component9" target="_blank">image.Component</a> 解析图片buffer数据参考：</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>需要确认图像的宽width是否与行距rowStride一致，如果不一致可参考以下方式处理：</p>        </div></div></div>       <p>方式一：去除imgComponent.byteBuffer中stride数据，拷贝得到新的buffer，调用不支持stride的接口处理buffer。</p>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pixelMap创建时使用的size、srcPixelFormat需要与相机预览输出流previewProfile中的size、format保持一致.</span></li><li><span class="hljs-keyword">const</span> dstBufferSize = width * height * mSize;</li><li><span class="hljs-keyword">const</span> dstArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dstBufferSize);</li><li><span class="hljs-comment">// 逐行读取buffer数据。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height * mSize; j++) {</li><li>  <span class="hljs-comment">// imgComponent.byteBuffer的每行数据拷贝前width个字节到dstArr中。</span></li><li>  <span class="hljs-keyword">const</span> srcBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, j * stride, width);</li><li>  dstArr.<span class="hljs-title function_">set</span>(srcBuf, j * width);</li><li>}</li><li><span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(dstArr.<span class="hljs-property">buffer</span>, {</li><li>  <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width }, <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat</li><li>
</li><li>});</li></ol></pre></div></div>       <p>方式二：根据stride*height创建pixelMap，然后调用pixelMap的cropSync方法裁剪掉多余的像素。</p>       <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建pixelMap，width宽传行距stride的值。</span></li><li><span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, {</li><li>  <span class="hljs-attr">size</span>:{<span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: stride}, <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat});</li><li><span class="hljs-comment">// 裁剪多余的像素。</span></li><li>pixelMap.<span class="hljs-title function_">cropSync</span>({<span class="hljs-attr">size</span>:{<span class="hljs-attr">width</span>:width, <span class="hljs-attr">height</span>:height}, <span class="hljs-attr">x</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">0</span>});</li></ol></pre></div></div>       <p>方式三：将原始imgComponent.byteBuffer和stride信息一起传给支持stride的接口处理。</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="用于显示画面的第二路预览流">用于显示画面的第二路预览流<i class="anchor-icon anchor-icon-link" anchorid="用于显示画面的第二路预览流" tips="复制节点链接"></i></h3>          <p>获取第二路预览流SurfaceId：创建XComponent组件用于预览流显示，获取surfaceId请参考XComponent组件提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#getxcomponentsurfaceid9" target="_blank">getXComponentSurfaceId</a>方法，而XComponent的能力由UI提供，相关介绍可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent组件参考</a>。</p>     <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct example {</li><li>  <span class="hljs-attr">xComponentCtl</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-attr">surfaceId</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">XComponent</span>({</li><li>      <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>      <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span></li><li>    })</li><li>      .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>(); <span class="hljs-comment">// 获取组件surfaceId。</span></li><li>        <span class="hljs-comment">// 使用surfaceId创建预览流，开启相机，组件实时渲染每帧预览流数据。</span></li><li>      })</li><li>      <span class="hljs-comment">// surface的宽、高设置与XComponent组件的宽、高设置相反，或使用.renderFit(RenderFit.RESIZE_CONTAIN)自动填充显示无需设置宽、高。</span></li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>))</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>))</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="创建预览流获取数据">创建预览流获取数据<i class="anchor-icon anchor-icon-link" anchorid="创建预览流获取数据" tips="复制节点链接"></i></h3>          <p>通过两个SurfaceId分别创建两路预览流输出，加入相机会话，启动相机会话，获取预览流数据。</p>     <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createDualPreviewOutput</span>(<span class="hljs-params">cameraManager: camera.CameraManager, previewProfile: camera.Profile,</span></li><li><span class="hljs-params">  session: camera.Session, imageReceiverSurfaceId: <span class="hljs-built_in">string</span>, xComponentSurfaceId: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 使用imageReceiverSurfaceId创建第一路预览。</span></li><li>    <span class="hljs-keyword">let</span> previewOutput1 = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, imageReceiverSurfaceId);</li><li>    <span class="hljs-keyword">if</span> (!previewOutput1) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createPreviewOutput1 error'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 使用xComponentSurfaceId创建第二路预览。</span></li><li>    <span class="hljs-keyword">let</span> previewOutput2 = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, xComponentSurfaceId);</li><li>    <span class="hljs-keyword">if</span> (!previewOutput2) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createPreviewOutput2 error'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 添加第一路预览流输出。</span></li><li>    session.<span class="hljs-title function_">addOutput</span>(previewOutput1);</li><li>    <span class="hljs-comment">// 添加第二路预览流输出。</span></li><li>    session.<span class="hljs-title function_">addOutput</span>(previewOutput2);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createDualPreviewOutput  call failed'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-ech-c106="" class="highlight-div"><div _ngcontent-ech-c106="" class="highlight-div-header"><div _ngcontent-ech-c106="" class="highlight-div-header-left"><div _ngcontent-ech-c106="" class="handle-button expand-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ech-c106="" class="highlight-div-header-right"><div _ngcontent-ech-c106="" class="handle-button ai-button"></div><div _ngcontent-ech-c106="" class="handle-button line-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ech-c106="" class="handle-button theme-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ech-c106="" class="handle-button copy-button"><div _ngcontent-ech-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ech-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CameraResources</span> {</li><li>  videoOutput?: camera.<span class="hljs-property">VideoOutput</span>;</li><li>  cameraInput?: camera.<span class="hljs-property">CameraInput</span>;</li><li>  previewOutput1?: camera.<span class="hljs-property">PreviewOutput</span>;</li><li>  previewOutput2?: camera.<span class="hljs-property">PreviewOutput</span>;</li><li>  session?: camera.<span class="hljs-property">VideoSession</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageReceiver</span>: image.<span class="hljs-property">ImageReceiver</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageReceiverSurfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponentCtl</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponentSurfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameras</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; | <span class="hljs-literal">undefined</span> = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getHostContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraPermission</span>: <span class="hljs-title class_">Permissions</span> = <span class="hljs-string">'ohos.permission.CAMERA'</span>; <span class="hljs-comment">// 申请权限相关问题可参考本篇开头的申请相关权限文档。</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraResources</span>: <span class="hljs-title class_">CameraResources</span> = {};</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestPermissionsFn</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, [<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>]);</li><li>      <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">permissions</span> || res.<span class="hljs-property">permissions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'requestPermissionsFromUser interface call fails'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">permissions</span>.<span class="hljs-property">length</span> !== res.<span class="hljs-property">authResults</span>.<span class="hljs-property">length</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Authentication result mismatch'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      res.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span>, permissions: <span class="hljs-built_in">string</span>[]</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>.<span class="hljs-title function_">toString</span>() === value &amp;&amp; res.<span class="hljs-property">authResults</span>[index] === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = <span class="hljs-literal">true</span>;</li><li>        }</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissionsFn</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPageShow'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initImageReceiver</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span> !== <span class="hljs-string">''</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPageHide'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 获取ImageReceiver的SurfaceId</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">receiver</span></span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initImageReceiver</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiver</span>) {</li><li>      <span class="hljs-comment">// 创建ImageReceiver。</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>: image.<span class="hljs-property">Size</span> = { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span> };</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiver</span> = image.<span class="hljs-title function_">createImageReceiver</span>(size, image.<span class="hljs-property">ImageFormat</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-number">8</span>);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Init image receiver failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 获取第一路流SurfaceId。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiverSurfaceId</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiver</span>.<span class="hljs-title function_">getReceivingSurfaceId</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initImageReceiver imageReceiverSurfaceId:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageReceiverSurfaceId}</span>`</span>);</li><li>      <span class="hljs-comment">// 注册监听处理预览流每帧图像数据。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiver</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Image格式与PixelMap格式映射关系。</span></li><li>  <span class="hljs-keyword">private</span> formatToPixelMapFormatMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, image.<span class="hljs-property">PixelMapFormat</span>&gt;([</li><li>    [<span class="hljs-number">12</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>],</li><li>    [<span class="hljs-number">25</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>],</li><li>    [<span class="hljs-number">35</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCBCR_P010</span>],</li><li>    [<span class="hljs-number">36</span>, image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCRCB_P010</span>]</li><li>  ]);</li><li>  <span class="hljs-comment">// PixelMapFormat格式的单个像素点大小映射关系。</span></li><li>  <span class="hljs-keyword">private</span> pixelMapFormatToSizeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;image.<span class="hljs-property">PixelMapFormat</span>, <span class="hljs-built_in">number</span>&gt;([</li><li>    [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>, <span class="hljs-number">4</span>],</li><li>    [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>, <span class="hljs-number">1.5</span>],</li><li>    [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCBCR_P010</span>, <span class="hljs-number">3</span>],</li><li>    [image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">YCRCB_P010</span>, <span class="hljs-number">3</span>]</li><li>  ]);</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 注册ImageReceiver图像监听</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">receiver</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">onImageArrival</span>(<span class="hljs-attr">receiver</span>: image.<span class="hljs-property">ImageReceiver</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 注册imageArrival监听。</span></li><li>    receiver.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'image arrival'</span>);</li><li>      <span class="hljs-comment">// 获取图像。</span></li><li>      receiver.<span class="hljs-title function_">readNextImage</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError, nextImage: image.Image</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err || nextImage === <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readNextImage failed'</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 解析图像内容。</span></li><li>        nextImage.<span class="hljs-title function_">getComponent</span>(image.<span class="hljs-property">ComponentType</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">imgComponent</span>: image.<span class="hljs-property">Component</span>) =&gt; {</li><li>          <span class="hljs-keyword">if</span> (err || imgComponent === <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getComponent failed'</span>);</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (imgComponent.<span class="hljs-property">byteBuffer</span>) {</li><li>            <span class="hljs-comment">// 请参考步骤7解析buffer数据，本示例以方式一为例。</span></li><li>            <span class="hljs-keyword">let</span> width = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>; <span class="hljs-comment">// 获取图片的宽。</span></li><li>            <span class="hljs-keyword">let</span> height = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>; <span class="hljs-comment">// 获取图片的高。</span></li><li>            <span class="hljs-keyword">let</span> stride = imgComponent.<span class="hljs-property">rowStride</span>; <span class="hljs-comment">// 获取图片的stride。</span></li><li>            <span class="hljs-keyword">let</span> imageFormat = nextImage.<span class="hljs-property">format</span>; <span class="hljs-comment">// 获取图片的format。</span></li><li>            <span class="hljs-keyword">let</span> pixelMapFormat = <span class="hljs-variable language_">this</span>.<span class="hljs-property">formatToPixelMapFormatMap</span>.<span class="hljs-title function_">get</span>(imageFormat) ?? image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">NV21</span>;</li><li>            <span class="hljs-keyword">let</span> mSize =  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMapFormatToSizeMap</span>.<span class="hljs-title function_">get</span>(pixelMapFormat) ?? <span class="hljs-number">1.5</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`getComponent with width:<span class="hljs-subst">${width}</span> height:<span class="hljs-subst">${height}</span> stride:<span class="hljs-subst">${stride}</span>`</span>);</li><li>            <span class="hljs-comment">// pixelMap创建时使用的size、srcPixelFormat需要与相机预览输出流previewProfile中的size、format保持一致。此处format以NV21格式为例。</span></li><li>            <span class="hljs-comment">// stride与width一致。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span>;</li><li>            <span class="hljs-keyword">if</span> (stride == width) {</li><li>              pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, {</li><li>                <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>                <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat,</li><li>              })</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// stride与width不一致。</span></li><li>              <span class="hljs-keyword">const</span> dstBufferSize = width * height * mSize <span class="hljs-comment">// 以NV21为例（YUV_420_SP格式的图片）YUV_420_SP内存计算公式：长x宽+(长x宽)/2。</span></li><li>              <span class="hljs-keyword">const</span> dstArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dstBufferSize)</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; height * mSize; j++) {</li><li>                <span class="hljs-keyword">const</span> srcBuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(imgComponent.<span class="hljs-property">byteBuffer</span>, j * stride, width)</li><li>                dstArr.<span class="hljs-title function_">set</span>(srcBuf, j * width)</li><li>              }</li><li>              pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMap</span>(dstArr.<span class="hljs-property">buffer</span>, {</li><li>                <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: height, <span class="hljs-attr">width</span>: width },</li><li>                <span class="hljs-attr">srcPixelFormat</span>: pixelMapFormat,</li><li>              })</li><li>            }</li><li>            <span class="hljs-comment">// 确保当前pixelMap没有在使用的情况下，注意要进行资源释放。</span></li><li>            <span class="hljs-keyword">if</span> (pixelMap != <span class="hljs-literal">undefined</span>) {</li><li>              <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in releasing pixelMap object.'</span>);</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to release pixelMap object. code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>              })</li><li>            }</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'byteBuffer is null'</span>);</li><li>          }</li><li>          <span class="hljs-comment">// 确保当前buffer没有在使用的情况下，可进行资源释放。</span></li><li>          <span class="hljs-comment">// 如果对buffer进行异步操作，需要在异步操作结束后再释放该资源（nextImage.release()）。</span></li><li>          nextImage.<span class="hljs-title function_">release</span>();</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'image process done'</span>);</li><li>        })</li><li>      })</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>        <span class="hljs-title class_">XComponent</span>({</li><li>          <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>          <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>          <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span></li><li>        })</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>(); <span class="hljs-comment">// 获取组件surfaceId。</span></li><li>            <span class="hljs-comment">// 初始化相机，组件实时渲染每帧预览流数据。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>()</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>))</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 初始化相机。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initCamera imageReceiverSurfaceId:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageReceiverSurfaceId}</span> xComponentSurfaceId:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.xComponentSurfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取相机管理器实例。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getCameraManager call failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 获取当前设备支持的相机device列表。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getSupportedCameras call failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 选择一个相机device，创建cameraInput输出对象。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">cameraInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createCameraInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>[<span class="hljs-number">0</span>]);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">cameraInput</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'createCameraInput call failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 打开相机。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">cameraInput</span>.<span class="hljs-title function_">open</span>();</li><li>      <span class="hljs-comment">// 获取相机device支持的profile。</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">capability</span>: camera.<span class="hljs-property">CameraOutputCapability</span> =</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">getSupportedOutputCapability</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>[<span class="hljs-number">0</span>], camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>      <span class="hljs-keyword">if</span> (!capability) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getSupportedOutputCapability call failed'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> minRatioDiff : <span class="hljs-built_in">number</span> = <span class="hljs-number">0.1</span>;</li><li>      <span class="hljs-keyword">let</span> surfaceRatio : <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>; <span class="hljs-comment">// 最接近16:9宽高比。</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: camera.<span class="hljs-property">Profile</span> = capability.<span class="hljs-property">previewProfiles</span>[<span class="hljs-number">0</span>];</li><li>      <span class="hljs-comment">// 应用开发者根据实际业务需求选择一个支持的预览流previewProfile。</span></li><li>      <span class="hljs-comment">// 此处以选择CAMERA_FORMAT_YUV_420_SP（NV21）格式、满足限定条件分辨率的预览流previewProfile为例。</span></li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; capability.<span class="hljs-property">previewProfiles</span>.<span class="hljs-property">length</span>; index++) {</li><li>        <span class="hljs-keyword">const</span> tempProfile = capability.<span class="hljs-property">previewProfiles</span>[index];</li><li>        <span class="hljs-keyword">let</span> tempRatio = tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> &gt;= tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> ?</li><li>          tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> : tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> / tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>        <span class="hljs-keyword">let</span> currentRatio = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(tempRatio - surfaceRatio);</li><li>        <span class="hljs-keyword">if</span> (currentRatio &lt;= minRatioDiff &amp;&amp; tempProfile.<span class="hljs-property">format</span> == camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YUV_420_SP</span>) {</li><li>          previewProfile = tempProfile;</li><li>          <span class="hljs-keyword">break</span>;</li><li>        }</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> = previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>; <span class="hljs-comment">// 更新xComponent组件的宽。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span> = previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>; <span class="hljs-comment">// 更新xComponent组件的高。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initCamera imageWidth:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageWidth}</span> imageHeight:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageHeight}</span>`</span>);</li><li>      <span class="hljs-comment">// 使用imageReceiverSurfaceId创建第一路预览。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput1</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageReceiverSurfaceId</span>);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput1</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera createPreviewOutput1'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 使用xComponentSurfaceId创建第二路预览。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput2</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span>);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput2</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera createPreviewOutput2'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 创建录像模式相机会话。</span></li><li>      <span class="hljs-keyword">let</span> session = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>)</li><li>      <span class="hljs-keyword">if</span> (!session) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'session is null'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span> = session <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>      <span class="hljs-comment">// 开始配置会话。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">beginConfig</span>();</li><li>      <span class="hljs-comment">// 添加相机设备输入。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">cameraInput</span>);</li><li>      <span class="hljs-comment">// 添加第一路预览流输出。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput1</span>);</li><li>      <span class="hljs-comment">// 添加第二路预览流输出。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput2</span>);</li><li>      <span class="hljs-comment">// 提交会话配置。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">commitConfig</span>();</li><li>      <span class="hljs-comment">// 开始启动已配置的输入输出流。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`initCamera fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放相机。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'releaseCamera E'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 停止当前会话。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">stop</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`session.stop call failed, error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 释放相机输入流。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">cameraInput</span>?.<span class="hljs-title function_">close</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`camera close fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 释放预览输出流。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput1</span>?.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`previewOutput1 release fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 释放拍照输出流。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">previewOutput2</span>?.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`previewOutput2 release fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 释放会话。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraResources</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`session release fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>