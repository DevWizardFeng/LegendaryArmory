<h1 _ngcontent-cvg-c119="" class="doc-title ng-star-inserted" title="图像跟踪"> 图像跟踪 </h1>

<div _ngcontent-cvg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section533191016356">概要<i class="anchor-icon anchor-icon-link" anchorid="section533191016356" tips="复制节点链接"></i></h2>          <p>从5.1.0(18)开始，AR Engine支持获取图像跟踪能力。</p>     <p>本章节介绍如何识别2D图像（二维图像）并跟踪其位姿信息，通过学习本章节，可以检测场景中是否存在输入的图像，识别之后输出图像的位姿。</p>    </div>    <div class="fignone">     <span class="figcap"><b>图1 </b>图像跟踪示意图</span>    </div>    <p><span><img originheight="657" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114356.03152207450321523457492421464293:50001231000000:2800:CB2A5A3B59D3551DF0E29C236C865714A0D6A3C9FF8D42F9D6315269DD77F3D2.png" width="318" height="657"></span></p>    <p>本章节涉及的AR Engine能力如下：</p>    <ul>     <li>运动跟踪能力</li>     <li>环境跟踪能力（平面检测）</li>    </ul>    <div class="tiledSection">     <h2 id="section4701164061710">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section4701164061710" tips="复制节点链接"></i></h2>          <p>图像识别主要依赖<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1410345414514" target="_blank">ARAugmentedImageDatabase</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section3211104815419" target="_blank">ARImage</a>，以下接口为图像识别相关接口。详细接口和说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-arkts-api" target="_blank">AR Engine API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.3.1.1" valign="top" width="49.94%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.3.1.2" valign="top" width="50.06%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section204881041154517" target="_blank">arEngine.createARAugmentedImageDatabase</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>创建一个增强型图像数据库。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section11965134812716" target="_blank">ARAugmentedImageDatabase.deserialize</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>将增强图像数据库缓冲区反序列化为一个新的增强图像数据库对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section18164121486" target="_blank">ARAugmentedImageDatabase.serialize</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>将增强图像数据库序列化为一个缓冲区。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section9315052814" target="_blank">ARAugmentedImageDatabase.addImage</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>将图像添加到图像数据库，并输出对应图像的索引。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section106577102812" target="_blank">ARAugmentedImageDatabase.getImageCount</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取图像数据库中图像的数量。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section87071617088" target="_blank">ARAugmentedImageDatabase.getCapacity</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>可以添加的最大图像数量。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section121563216515" target="_blank">ARAugmentedImageDatabase.getImageAddMode</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取图片添加模式。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section15149542135910" target="_blank">ARAugmentedImageDatabase.setImageAddMode</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>设置图片添加模式。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section72331823587" target="_blank">ARAugmentedImageDatabase.release</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>释放增强图像数据库对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1410345414514" target="_blank">ARAugmentedImageDatabase</a>占用的内存。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1060545815466" target="_blank">ARImage.release</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>释放相机视频流帧对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section3211104815419" target="_blank">ARImage</a>占用的内存。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1570811755212" target="_blank">ARAugmentedImage</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>表示可被追踪的增强图像对象。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section528511529350">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section528511529350" tips="复制节点链接"></i></h2>          <p>AR Engine仅输出识别到的平面数据。为便于用户观察，开发者可使用AGP（Ark Graphics Platform）渲染引擎或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>绘制识别的平面。关于AGP的介绍可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkgraphics3d-overview" target="_blank">ArkGraphics 3D简介</a>和<a href="https://gitcode.com/openharmony/graphic_graphic_3d" target="_blank">AGP引擎</a>。</p>     <p>对于使用ArkTS的任何AR应用，首先需要创建一个AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，用于管理AR Engine的系统状态。AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>的创建可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-arsession">管理AR会话</a>章节。</p>    </div>    <div class="tiledSection">     <h3 id="section428942411816" class="firsth2">创建UI页面<i class="anchor-icon anchor-icon-link" anchorid="section428942411816" tips="复制节点链接"></i></h3>          <p>首先创建一个初始UI页面“ARImage.ets”，设置两个按钮，用于实现“添加本地图片”和“读取本地数据库”两个功能，分别命名“ARImageByAdd.ets”和“ARImageByDatabase.ets”。并配置路由进行页面间跳转，页面路由配置详细可查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation" target="_blank">组件导航(Navigation) (推荐)</a>。</p>    </div>    <div class="tiledSection">     <h3 id="section1073153117181">ARImage页面<i class="anchor-icon anchor-icon-link" anchorid="section1073153117181" tips="复制节点链接"></i></h3>          <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImage.ets</span></li><li><span class="hljs-comment">// 导入图片模块</span></li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ARImageBuilder</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-title class_">ARImage</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ARImage</span> {</li><li>  <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>
</li><li>  <span class="hljs-comment">// UI配置</span></li><li>  <span class="hljs-title function_">build</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'选择本地图片'</span>, { <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Normal</span>, <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span> })</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">chooseImageToTrack</span>();</li><li>          })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'加载本地数据库'</span>, { <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Normal</span>, <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span> })</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadDatabaseToTrack</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceEvenly</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span> = context.<span class="hljs-property">pathStack</span>;</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 选择本地图片模式</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">chooseImageToTrack</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">photoOption</span>: photoAccessHelper.<span class="hljs-property">PhotoSelectOptions</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>      photoOption.<span class="hljs-property">MIMEType</span> = photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;</li><li>      photoOption.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">50</span>; <span class="hljs-comment">// Default</span></li><li>      photoOption.<span class="hljs-property">isEditSupported</span> = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">photoPicker</span>: photoAccessHelper.<span class="hljs-property">PhotoViewPicker</span> = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>
</li><li>      photoPicker.<span class="hljs-title function_">select</span>(photoOption).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoResult</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (photoResult.<span class="hljs-property">photoUris</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; photoResult.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>].<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pushDestinationByName</span>(<span class="hljs-string">'ARImageByAdd'</span>, photoResult.<span class="hljs-property">photoUris</span>);</li><li>        }</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to select by photoPicker. Code: <span class="hljs-subst">${error.code}</span>.`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 加载本地数据库模式</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">loadDatabaseToTrack</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pushDestinationByName</span>(<span class="hljs-string">'ARImageByDatabase'</span>, <span class="hljs-literal">null</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section162681252161918">ARImageByAdd页面<i class="anchor-icon anchor-icon-link" anchorid="section162681252161918" tips="复制节点链接"></i></h3>          <p>加载本地图片模式。</p>     <ol>      <li>选择本地图片进行图像识别能力所需要导入的模块如下：       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByAdd.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { arEngine, <span class="hljs-title class_">ARView</span>, arViewController } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AREngine'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span>, <span class="hljs-title class_">Scene</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics3D'</span>;</li><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li></ol></pre></div></div></li>      <li>配置页面路由信息，定义数据库dataBase。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByAdd.ets</span></li><li>
</li><li><span class="hljs-comment">// 页面路由</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ARImageByAddBuilder</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-title class_">ARImageByAdd</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dataBase</span>: arEngine.<span class="hljs-property">ARAugmentedImageDatabase</span>;</li></ol></pre></div></div></li>      <li>在设备界面上显示图片添加情况，无可用图片则弹窗提示，加载AR场景。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByAdd.ets</span></li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ARImageByAdd</span> {</li><li>  <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imagePathArray</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isProgramExits</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">isSaveDatabase</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> arContext?: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">totalImageCounts</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePathArray</span>.<span class="hljs-property">length</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">addFailedImageCounts</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">succeedImageCounts</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">addFailedMessage</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`添加图片进度: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.succeedImageCounts + <span class="hljs-variable language_">this</span>.addFailedImageCounts}</span> / <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.totalImageCounts}</span>`</span>)</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`添加成功数量：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.succeedImageCounts}</span>`</span>)</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`添加失败数量：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.addFailedImageCounts}</span>`</span>)</li><li>
</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedMessage</span>) {</li><li>            <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedMessage</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item}</span>`</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>            })</li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">succeedImageCounts</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalImageCounts</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span> :</li><li>        <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span>)</li><li>        .<span class="hljs-title function_">foregroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>        .<span class="hljs-title function_">zIndex</span>(<span class="hljs-number">1</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>) {</li><li>          <span class="hljs-title class_">ARView</span>({ <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> })</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">alignRules</span>({</li><li>              <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>              <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>            })</li><li>        }</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// 创建数据库，加载本地缓存，初始化AR场景，创建AR会话</span></li><li>    .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      arEngine.<span class="hljs-title function_">createARAugmentedImageDatabase</span>()</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">arDataBase</span>) =&gt;</span> {</li><li>          dataBase = arDataBase;</li><li>
</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addImage</span>(dataBase).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalImageCounts</span>) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">ShowDialog</span>(<span class="hljs-string">'请添加有效图片。'</span>);</li><li>            }</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initARView</span>();</li><li>          })</li><li>        })</li><li>    })</li><li>    .<span class="hljs-title function_">onWillDisappear</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onShown</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resumeARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span> = context.<span class="hljs-property">pathStack</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePathArray</span> = context.<span class="hljs-property">pathInfo</span>.<span class="hljs-property">param</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalImageCounts</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePathArray</span>.<span class="hljs-property">length</span>;</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 初始化AR场景，创建AR会话</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">Scene</span>.<span class="hljs-title function_">load</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">scene</span>: <span class="hljs-title class_">Scene</span>) =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">viewContext</span>: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-keyword">new</span> arViewController.<span class="hljs-title class_">ARViewContext</span>();</li><li>      viewContext.<span class="hljs-property">scene</span> = scene;</li><li>      viewContext.<span class="hljs-property">callback</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ARViewCallbackImpl</span>();</li><li>      viewContext.<span class="hljs-property">config</span> = {</li><li>        <span class="hljs-attr">type</span>: arEngine.<span class="hljs-property">ARType</span>.<span class="hljs-property">IMAGE</span>,  <span class="hljs-comment">// 使用图像跟踪模式</span></li><li>        <span class="hljs-attr">planeFindingMode</span>: arEngine.<span class="hljs-property">ARPlaneFindingMode</span>.<span class="hljs-property">HORIZONTAL_AND_VERTICAL</span>,</li><li>        <span class="hljs-attr">powerMode</span>: arEngine.<span class="hljs-property">ARPowerMode</span>.<span class="hljs-property">NORMAL</span>,</li><li>        <span class="hljs-attr">semanticMode</span>: arEngine.<span class="hljs-property">ARSemanticMode</span>.<span class="hljs-property">NONE</span>,</li><li>        <span class="hljs-attr">poseMode</span>: arEngine.<span class="hljs-property">ARPoseMode</span>.<span class="hljs-property">GRAVITY</span>,</li><li>        <span class="hljs-attr">depthMode</span>: arEngine.<span class="hljs-property">ARDepthMode</span>.<span class="hljs-property">AUTOMATIC</span>,</li><li>        <span class="hljs-attr">meshMode</span>: arEngine.<span class="hljs-property">ARMeshMode</span>.<span class="hljs-property">DISABLED</span>,</li><li>        <span class="hljs-attr">focusMode</span>: arEngine.<span class="hljs-property">ARFocusMode</span>.<span class="hljs-property">AUTO</span></li><li>      }</li><li>      viewContext.<span class="hljs-title function_">init</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> = viewContext;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in initializing ARView.'</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to init ARView. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>      })</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopARView</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isProgramExits</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSaveDatabase</span>) {</li><li>        <span class="hljs-title class_">SaveBufferToLocal</span>(dataBase, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">await</span> dataBase.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>?.<span class="hljs-title function_">destroy</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop context. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resumeARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">pauseARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 异步执行添加图片的任务</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addImage</span>(<span class="hljs-attr">dataBase</span>: arEngine.<span class="hljs-property">ARAugmentedImageDatabase</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalImageCounts</span>; index++) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">imagePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePathArray</span>[index];</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> = fileIo.<span class="hljs-title function_">openSync</span>(imagePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageName</span>: <span class="hljs-built_in">string</span> = file.<span class="hljs-property">name</span>;</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">imageSourceApi</span>: image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(file.<span class="hljs-property">fd</span>);</li><li>      <span class="hljs-keyword">try</span> {</li><li>        fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to closeSync. Code: <span class="hljs-subst">${err.code}</span>.`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> += <span class="hljs-number">1</span>;</li><li>        <span class="hljs-keyword">continue</span>;</li><li>      }</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">imageInfo</span>: image.<span class="hljs-property">ImageInfo</span> = imageSourceApi.<span class="hljs-title function_">getImageInfoSync</span>(<span class="hljs-number">0</span>);</li><li>      <span class="hljs-keyword">if</span> (!imageInfo) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to obtain the image pixel map information.'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> += <span class="hljs-number">1</span>;</li><li>        <span class="hljs-keyword">continue</span>;</li><li>      }</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">opts</span>: image.<span class="hljs-property">DecodingOptions</span> = {</li><li>        <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">desiredPixelFormat</span>: image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">RGBA_8888</span>,</li><li>        <span class="hljs-attr">desiredSize</span>: { <span class="hljs-attr">width</span>: imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>, <span class="hljs-attr">height</span>: imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> }</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> = imageSourceApi.<span class="hljs-title function_">createPixelMapSync</span>(opts);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">info</span>: image.<span class="hljs-property">ImageInfo</span> = pixelMap.<span class="hljs-title function_">getImageInfoSync</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span> = pixelMap.<span class="hljs-title function_">getPixelBytesNumber</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The ets create pixelMap width: <span class="hljs-subst">${info.size.width}</span>, height: <span class="hljs-subst">${info.size.height}</span>, size: <span class="hljs-subst">${size}</span>.`</span>);</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isProgramExits</span>) {</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">await</span> dataBase.<span class="hljs-title function_">addImage</span>(imageName, pixelMap, <span class="hljs-number">10</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: arEngine.ARAddAugmentedImageResult</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The imageResult: <span class="hljs-subst">${result.index}</span> <span class="hljs-subst">${result.stateReason}</span>.`</span>);</li><li>        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">stateReason</span> !== arEngine.<span class="hljs-property">ARAddAugmentedImageReason</span>.<span class="hljs-property">NONE</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> += <span class="hljs-number">1</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedMessage</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'失败图片名:'</span> + imageName + <span class="hljs-string">'失败原因:'</span> + errcode.<span class="hljs-title function_">get</span>(result.<span class="hljs-property">stateReason</span>) + <span class="hljs-string">' '</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">succeedImageCounts</span> += <span class="hljs-number">1</span>;</li><li>        }</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">addFailedImageCounts</span> += <span class="hljs-number">1</span>;</li><li>      })</li><li>
</li><li>      imageSourceApi.<span class="hljs-title function_">release</span>();</li><li>      pixelMap.<span class="hljs-title function_">release</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 自定义的弹窗提示</span></li><li>  <span class="hljs-title class_">ShowDialog</span>(<span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>(</li><li>      {</li><li>        <span class="hljs-attr">title</span>: <span class="hljs-string">'警告'</span>,</li><li>        <span class="hljs-attr">message</span>: msg,</li><li>        <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Center</span>,</li><li>        <span class="hljs-attr">offset</span>: { <span class="hljs-attr">dx</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">dy</span>: -<span class="hljs-number">20</span> },</li><li>        <span class="hljs-attr">gridCount</span>: <span class="hljs-number">3</span>,</li><li>        <span class="hljs-attr">transition</span>: <span class="hljs-title class_">TransitionEffect</span></li><li>          .<span class="hljs-title function_">asymmetric</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span> })</li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span></li><li>              .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">1.5</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1.5</span> })</li><li>              .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span> })</li><li>            ),</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Smooth</span> })</li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span> })</li><li>              .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Smooth</span> })</li><li>            )</li><li>          ),</li><li>        <span class="hljs-attr">buttons</span>: [{</li><li>          <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-attr">defaultFocus</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-attr">style</span>: <span class="hljs-title class_">DialogButtonStyle</span>.<span class="hljs-property">HIGHLIGHT</span>,</li><li>          <span class="hljs-attr">value</span>: <span class="hljs-string">'退出'</span>,</li><li>          <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Callback when the second button is clicked.'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>        }]</li><li>      })</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>退出应用时，缓存图片特征到本地。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByAdd.ets</span></li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveBufferToLocal</span>(<span class="hljs-params">dataBase: arEngine.ARAugmentedImageDatabase, context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">filesDir</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> =</li><li>    fileIo.<span class="hljs-title function_">openSync</span>(filesDir + <span class="hljs-string">'/test.bin'</span>,</li><li>      fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">TRUNC</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buf</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">await</span> dataBase.<span class="hljs-title function_">serialize</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">writeLen</span>: <span class="hljs-built_in">number</span> = fileIo.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, buf);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The length of buffer is: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>  fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>}</li></ol></pre></div></div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section9396615174614" target="_blank">ARViewCallback</a>，使用其中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section52341758194715" target="_blank">onFrameUpdate</a>方法进行帧数据更新，识别到目标图像则打印日志。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByAdd.ets</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARViewCallbackImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">arViewController.ARViewCallback</span> {</li><li>  <span class="hljs-title function_">onAnchorAdd</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onAnchorUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onFrameUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">sysBootTs</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">session</span> || !dataBase) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: arEngine.<span class="hljs-property">ARSession</span> = ctx.<span class="hljs-property">session</span>; <span class="hljs-comment">// 获取AR会话</span></li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageNumber</span>: <span class="hljs-built_in">number</span> = dataBase.<span class="hljs-title function_">getImageCount</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The number of images in the database is <span class="hljs-subst">${imageNumber}</span>.`</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageCapacity</span>: <span class="hljs-built_in">number</span> = dataBase.<span class="hljs-title function_">getCapacity</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The dataBase image capacity is: <span class="hljs-subst">${imageCapacity}</span>.`</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">trackable</span>: arEngine.<span class="hljs-property">ARTrackable</span>[] = session.<span class="hljs-title function_">getAllTrackables</span>(arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">AUGMENTED_IMAGE</span>);</li><li>
</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The image trackable size: <span class="hljs-subst">${trackable.length}</span>.`</span>);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; trackable.<span class="hljs-property">length</span>; ++i) {</li><li>        <span class="hljs-keyword">if</span> (trackable[i].<span class="hljs-property">type</span> === arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">AUGMENTED_IMAGE</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">arimage</span>: arEngine.<span class="hljs-property">ARAugmentedImage</span> = trackable[i] <span class="hljs-keyword">as</span> arEngine.<span class="hljs-property">ARAugmentedImage</span>;</li><li>          <span class="hljs-keyword">if</span> (arEngine.<span class="hljs-property">ARTrackingState</span>.<span class="hljs-property">TRACKING</span> !== arimage.<span class="hljs-property">state</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">centerPose</span>: arEngine.<span class="hljs-property">ARPose</span> = arimage.<span class="hljs-title function_">getPose</span>();</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The image width: <span class="hljs-subst">${arimage.extendX}</span>, height: <span class="hljs-subst">${arimage.extendZ}</span>, pose: <span class="hljs-subst">${centerPose.getMatrix()}</span>.`</span>);  <span class="hljs-comment">// 打印目标图像的信息</span></li><li>        }</li><li>      }</li><li>
</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to got image count. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 图像添加失败原因</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">errcode</span>: collections.<span class="hljs-property">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> collections.<span class="hljs-property">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt;([</li><li>  [<span class="hljs-number">0</span>, <span class="hljs-string">'success'</span>],</li><li>  [<span class="hljs-number">1</span>, <span class="hljs-string">'size not match'</span>],</li><li>  [<span class="hljs-number">2</span>, <span class="hljs-string">'too bright or too dark'</span>],</li><li>  [<span class="hljs-number">3</span>, <span class="hljs-string">'image color is relatively single'</span>],</li><li>  [<span class="hljs-number">4</span>, <span class="hljs-string">'other error'</span>]</li><li>])</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section103591753111918">ARImageByDatabase页面<i class="anchor-icon anchor-icon-link" anchorid="section103591753111918" tips="复制节点链接"></i></h3>          <p>加载本地数据库模式。</p>     <ol>      <li>选择本地数据库进行图像识别能力所需要导入的模块如下：       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByDatabase.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { arEngine, <span class="hljs-title class_">ARView</span>, arViewController } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AREngine'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span>, <span class="hljs-title class_">Scene</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics3D'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo, <span class="hljs-title class_">ReadOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div></li>      <li>配置页面路由信息，定义数据库dataBase。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByDatabase.ets</span></li><li>
</li><li><span class="hljs-comment">// 页面路由</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ARImageByDatabaseBuilder</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-title class_">ARImageByDatabase</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dataBase</span>: arEngine.<span class="hljs-property">ARAugmentedImageDatabase</span>;</li></ol></pre></div></div></li>      <li>加载AR场景，加载图像数据库，无可用数据库则弹窗提示。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByDatabase.ets</span></li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ARImageByDatabase</span> {</li><li>  <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-meta">@State</span> arContext?: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>) {</li><li>          <span class="hljs-title class_">ARView</span>({ <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> })</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">alignRules</span>({</li><li>              <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>              <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>            })</li><li>        }</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// 创建数据库，加载本地缓存，初始化AR场景，创建AR会话</span></li><li>    .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      arEngine.<span class="hljs-title function_">createARAugmentedImageDatabase</span>()</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">arDataBase</span>) =&gt;</span> {</li><li>          dataBase = arDataBase;</li><li>
</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">databaseBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-title class_">ReadBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>            dataBase.<span class="hljs-title function_">deserialize</span>(databaseBuffer).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initARView</span>();</li><li>            })</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to init context. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">ShowDialog</span>(<span class="hljs-string">'请添加有效图片。'</span>);</li><li>          }</li><li>        })</li><li>    })</li><li>    .<span class="hljs-title function_">onWillDisappear</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onShown</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resumeARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">(<span class="hljs-params">context: NavDestinationContext</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span> = context.<span class="hljs-property">pathStack</span>;</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-literal">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 初始化AR场景，创建AR会话</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">Scene</span>.<span class="hljs-title function_">load</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">scene</span>: <span class="hljs-title class_">Scene</span>) =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: arViewController.<span class="hljs-property">ARViewContext</span> = <span class="hljs-keyword">new</span> arViewController.<span class="hljs-title class_">ARViewContext</span>();</li><li>      context.<span class="hljs-property">scene</span> = scene;</li><li>      context.<span class="hljs-property">callback</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ARViewCallbackImpl</span>();</li><li>      context.<span class="hljs-property">config</span> = {</li><li>        <span class="hljs-attr">type</span>: arEngine.<span class="hljs-property">ARType</span>.<span class="hljs-property">IMAGE</span>,  <span class="hljs-comment">// 使用图像跟踪模式</span></li><li>        <span class="hljs-attr">planeFindingMode</span>: arEngine.<span class="hljs-property">ARPlaneFindingMode</span>.<span class="hljs-property">HORIZONTAL_AND_VERTICAL</span>,</li><li>        <span class="hljs-attr">powerMode</span>: arEngine.<span class="hljs-property">ARPowerMode</span>.<span class="hljs-property">NORMAL</span>,</li><li>        <span class="hljs-attr">semanticMode</span>: arEngine.<span class="hljs-property">ARSemanticMode</span>.<span class="hljs-property">NONE</span>,</li><li>        <span class="hljs-attr">poseMode</span>: arEngine.<span class="hljs-property">ARPoseMode</span>.<span class="hljs-property">GRAVITY</span>,</li><li>        <span class="hljs-attr">depthMode</span>: arEngine.<span class="hljs-property">ARDepthMode</span>.<span class="hljs-property">AUTOMATIC</span>,</li><li>        <span class="hljs-attr">meshMode</span>: arEngine.<span class="hljs-property">ARMeshMode</span>.<span class="hljs-property">ENABLE</span></li><li>      }</li><li>      context.<span class="hljs-title function_">init</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span> = context;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in initializing ARView.'</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to init context. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>      })</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopARView</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> dataBase.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arContext</span>?.<span class="hljs-title function_">destroy</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to stop context. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resumeARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">pauseARView</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 自定义的弹窗提示</span></li><li>  <span class="hljs-title class_">ShowDialog</span>(<span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>(</li><li>      {</li><li>        <span class="hljs-attr">title</span>: <span class="hljs-string">'警告'</span>,</li><li>        <span class="hljs-attr">message</span>: msg,</li><li>        <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Center</span>,</li><li>        <span class="hljs-attr">offset</span>: { <span class="hljs-attr">dx</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">dy</span>: -<span class="hljs-number">20</span> },</li><li>        <span class="hljs-attr">gridCount</span>: <span class="hljs-number">3</span>,</li><li>        <span class="hljs-attr">transition</span>: <span class="hljs-title class_">TransitionEffect</span></li><li>          .<span class="hljs-title function_">asymmetric</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span> })</li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span></li><li>              .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">1.5</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1.5</span> })</li><li>              .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span> })</li><li>            ),</li><li>          <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">OPACITY</span></li><li>            .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Smooth</span> })</li><li>            .<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span> })</li><li>              .<span class="hljs-title function_">animation</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Smooth</span> })</li><li>            )</li><li>          ),</li><li>        <span class="hljs-attr">buttons</span>: [{</li><li>          <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-attr">defaultFocus</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-attr">style</span>: <span class="hljs-title class_">DialogButtonStyle</span>.<span class="hljs-property">HIGHLIGHT</span>,</li><li>          <span class="hljs-attr">value</span>: <span class="hljs-string">'退出'</span>,</li><li>          <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Callback when the second button is clicked.'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>        }]</li><li>      })</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>读取本地数据库缓存文件的方法。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByDatabase.ets</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">ReadBuffer</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">ArrayBuffer</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">filesDir</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">srcFile</span>: fileIo.<span class="hljs-property">File</span> =</li><li>    fileIo.<span class="hljs-title function_">openSync</span>(filesDir + <span class="hljs-string">'/test.bin'</span>, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">fileStat</span>: fileIo.<span class="hljs-property">Stat</span> = fileIo.<span class="hljs-title function_">statSync</span>(srcFile.<span class="hljs-property">fd</span>);</li><li>  <span class="hljs-comment">// 读取源文件的内容并写入目标文件</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">readSize</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buf</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(fileStat.<span class="hljs-property">size</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">readOptions</span>: <span class="hljs-title class_">ReadOptions</span> = {</li><li>    <span class="hljs-attr">offset</span>: readSize,</li><li>    <span class="hljs-attr">length</span>: fileStat.<span class="hljs-property">size</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">readLen</span>: <span class="hljs-built_in">number</span> = fileIo.<span class="hljs-title function_">readSync</span>(srcFile.<span class="hljs-property">fd</span>, buf, readOptions);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The length of buffer is: <span class="hljs-subst">${readLen}</span>.`</span>);</li><li>  fileIo.<span class="hljs-title function_">closeSync</span>(srcFile);</li><li>  <span class="hljs-keyword">return</span> buf;</li><li>}</li></ol></pre></div></div></li>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section9396615174614" target="_blank">ARViewCallback</a>，使用其中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section52341758194715" target="_blank">onFrameUpdate</a>方法进行帧数据更新，识别到目标图像则打印日志。       <div _ngcontent-cvg-c106="" class="highlight-div"><div _ngcontent-cvg-c106="" class="highlight-div-header"><div _ngcontent-cvg-c106="" class="highlight-div-header-left"><div _ngcontent-cvg-c106="" class="handle-button expand-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvg-c106="" class="highlight-div-header-right"><div _ngcontent-cvg-c106="" class="handle-button ai-button"></div><div _ngcontent-cvg-c106="" class="handle-button line-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvg-c106="" class="handle-button theme-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvg-c106="" class="handle-button copy-button"><div _ngcontent-cvg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ARImageByDatabase.ets</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARViewCallbackImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">arViewController.ARViewCallback</span> {</li><li>  <span class="hljs-title function_">onAnchorAdd</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onAnchorUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onFrameUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">sysBootTs</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">session</span> || !dataBase) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: arEngine.<span class="hljs-property">ARSession</span> = ctx.<span class="hljs-property">session</span>;</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageNumber</span>: <span class="hljs-built_in">number</span> = dataBase.<span class="hljs-title function_">getImageCount</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The number of images in the database is <span class="hljs-subst">${imageNumber}</span>.`</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageCapacity</span>: <span class="hljs-built_in">number</span> = dataBase.<span class="hljs-title function_">getCapacity</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The dataBase image capacity = <span class="hljs-subst">${imageCapacity}</span>.`</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">trackable</span>: arEngine.<span class="hljs-property">ARTrackable</span>[] = session.<span class="hljs-title function_">getAllTrackables</span>(arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">AUGMENTED_IMAGE</span>);</li><li>
</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The image trackable size: <span class="hljs-subst">${trackable.length}</span>.`</span>);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; trackable.<span class="hljs-property">length</span>; ++i) {</li><li>        <span class="hljs-keyword">if</span> (trackable[i].<span class="hljs-property">type</span> === arEngine.<span class="hljs-property">ARTrackableType</span>.<span class="hljs-property">AUGMENTED_IMAGE</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">arimage</span>: arEngine.<span class="hljs-property">ARAugmentedImage</span> = trackable[i] <span class="hljs-keyword">as</span> arEngine.<span class="hljs-property">ARAugmentedImage</span>;</li><li>          <span class="hljs-keyword">if</span> (arEngine.<span class="hljs-property">ARTrackingState</span>.<span class="hljs-property">TRACKING</span> !== arimage.<span class="hljs-property">state</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">centerPose</span>: arEngine.<span class="hljs-property">ARPose</span> = arimage.<span class="hljs-title function_">getPose</span>();</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The image width: <span class="hljs-subst">${arimage.extendX}</span>, height: <span class="hljs-subst">${arimage.extendZ}</span>, pose: <span class="hljs-subst">${centerPose.getMatrix()}</span>.`</span>);  <span class="hljs-comment">// 打印目标图像的信息</span></li><li>        }</li><li>      }</li><li>
</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to got image count. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>