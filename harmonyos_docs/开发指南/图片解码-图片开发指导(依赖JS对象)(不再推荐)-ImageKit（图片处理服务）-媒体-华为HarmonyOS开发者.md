<h1 _ngcontent-odh-c119="" class="doc-title ng-star-inserted" title="图片解码"> 图片解码 </h1>

<div _ngcontent-odh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>当前开发指导使用的接口为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image" target="_blank">Image</a>模块下的C API，可完成图片编解码，图片接收器，处理图像数据等功能。这部分API在API version 11之前发布，在后续的版本不再增加新功能，<strong>不再推荐使用</strong>。</p>      <p>开发者可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image-nativemodule" target="_blank">Image_NativeModule</a>模块下的C API，不仅提供上述图片框架基础功能，还可以完成多图编解码等新特性，相关开发指导请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-source-c">图片开发指导(C/C++)</a>节点下的内容。这部分API从API version 12开始支持，并将持续演进，<strong>推荐开发者使用</strong>。</p>      <p>两套C API不建议同时使用，在部分场景下存在不兼容的问题。</p>     </div></div></div>    <p>将所支持格式的图片文件解码成PixelMap，以便在应用或系统中进行图片显示或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-transformation">图片处理</a>。当前支持的图片文件格式包括JPEG、PNG、GIF、WebP、BMP、SVG、ICO、DNG、HEIC（不同硬件设备支持情况不同）。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>图片解码相关API的详细介绍请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">图片解码接口文档</a>。</p>    </div>    <div class="tiledSection">     <h3 id="添加依赖" class="firsth2">添加依赖<i class="anchor-icon anchor-icon-link" anchorid="添加依赖" tips="复制节点链接"></i></h3>          <p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加libace_napi.z.so、libpixelmap_ndk.z.so、libimage_source_ndk.z.so、librawfile.z.so以及日志依赖libhilog_ndk.z.so。</p>     <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libpixelmap_ndk.z.so libimage_source_ndk.z.so librawfile.z.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="添加接口映射">添加接口映射<i class="anchor-icon anchor-icon-link" anchorid="添加接口映射" tips="复制节点链接"></i></h3>          <p>打开src/main/cpp/hello.cpp文件，在Init函数中添加getSyncPixelMap函数接口映射，作用是以同步的方式生成PixelMap，具体代码如下：</p>     <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"getSyncPixelMap"</span>, <span class="hljs-literal">nullptr</span>, getSyncPixelMap, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>    };</li><li>
</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="js侧调用">JS侧调用<i class="anchor-icon anchor-icon-link" anchorid="js侧调用" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>打开src\main\cpp\types\libentry\index.d.ts（其中libentry根据工程名生成），导入如下引用文件：</p>       <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 同步调用，入参为资源管理器和图片资源名称，返回PixelMap。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSyncPixelMap</span>: <span class="hljs-function">(<span class="hljs-params">resMgr: resourceManager.ResourceManager, src: string</span>) =&gt;</span> image.<span class="hljs-property">PixelMap</span>;</li></ol></pre></div></div></li>      <li>       <p>准备图片资源文件，本示例文件名为example.jpg，导入到src\main\resources\rawfile\ 路径下。</p></li>      <li>       <p>打开src\main\ets\pages\index.ets，导入"libentry.so（根据工程名生成）"，调用Native接口，传入JS的资源对象。示例如下：</p>       <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>@<span class="hljs-title class_">Entry</span></li><li>@<span class="hljs-title class_">Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title class_">State</span> pixelMap : <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>     <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>     <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>     <span class="hljs-comment">// 调用自定义的getSyncPixelMap接口，获取pixelMap。</span></li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = testNapi.<span class="hljs-title function_">getSyncPixelMap</span>(context.<span class="hljs-property">resourceManager</span>, <span class="hljs-string">"example.jpg"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>     <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>)</li><li>           .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>           .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>     }</li><li>     .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="native接口调用">Native接口调用<i class="anchor-icon anchor-icon-link" anchorid="native接口调用" tips="复制节点链接"></i></h3>          <p>具体接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-image" target="_blank">API文档</a>。</p>     <p>在hello.cpp文件中获取JS的资源对象，并转为Native的资源对象，即可调用Native接口，调用方式示例代码如下：</p>     <p><strong>添加引用文件</strong></p>     <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 引入图片框架、raw文件、raw文件管理和日志打印头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_source_mdk.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_pixel_map_mdk.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file_manager.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">getSyncPixelMap</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>   napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>   <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>   </li><li>   napi_valuetype srcType;</li><li>   <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;srcType);</li><li>
</li><li>   <span class="hljs-comment">// 入参args[0]是资源管理器，用来初始化native层的资源管理器。</span></li><li>   NativeResourceManager *mNativeResMgr = <span class="hljs-built_in">OH_ResourceManager_InitNativeResourceManager</span>(env, args[<span class="hljs-number">0</span>]);</li><li>   </li><li>   <span class="hljs-type">size_t</span> strSize;</li><li>   <span class="hljs-type">char</span> srcBuf[<span class="hljs-number">2048</span>];</li><li>   <span class="hljs-comment">// 入参args[1]是文件名称。</span></li><li>   <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], srcBuf, <span class="hljs-built_in">sizeof</span>(srcBuf), &amp;strSize);</li><li>
</li><li>   <span class="hljs-comment">// 用资源管理器打开Raw文件。</span></li><li>   RawFile * rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(mNativeResMgr, srcBuf);</li><li>   <span class="hljs-keyword">if</span> (rawFile != <span class="hljs-literal">NULL</span>) {</li><li>      <span class="hljs-comment">// 获取文件大小，并读取数据。</span></li><li>      <span class="hljs-type">long</span> len = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>      <span class="hljs-type">uint8_t</span> * data = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">malloc</span>(len));</li><li>      <span class="hljs-type">int</span> res = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, data, len);</li><li>
</li><li>      OhosImageSource imageSource_c;</li><li>      imageSource_c.buffer = data;</li><li>      imageSource_c.bufferSize = len;</li><li>
</li><li>      OhosImageSourceOps ops{};</li><li>      napi_value imageSource;</li><li>      napi_value pixelMap;</li><li>
</li><li>      <span class="hljs-comment">// 用读取到的Raw数据创建ImageSource。</span></li><li>      <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_ImageSource_Create</span>(env, &amp;imageSource_c, &amp;ops, &amp;imageSource);</li><li>
</li><li>      <span class="hljs-comment">// 初始化native层的ImageSource。</span></li><li>      ImageSourceNative * imageSourceNative_c = <span class="hljs-built_in">OH_ImageSource_InitNative</span>(env, imageSource);</li><li>      OhosImageDecodingOps decodingOps{};</li><li>      <span class="hljs-comment">// 创建pixelMap。</span></li><li>      <span class="hljs-built_in">OH_ImageSource_CreatePixelMap</span>(imageSourceNative_c, &amp;decodingOps, &amp;pixelMap);</li><li>
</li><li>      <span class="hljs-comment">// 下列方法,为gif等动图格式提供。</span></li><li>      <span class="hljs-comment">// napi_value pixelMapList;</span></li><li>      <span class="hljs-comment">// OH_ImageSource_CreatePixelMapList(imageSourceNative_c, &amp;decodingOps, &amp;pixelMapList);</span></li><li>      <span class="hljs-comment">// OhosImageSourceDelayTimeList list{};</span></li><li>      <span class="hljs-comment">// OH_ImageSource_GetDelayTime(imageSourceNative_c, &amp;list);</span></li><li>      <span class="hljs-comment">// uint32_t count;</span></li><li>      <span class="hljs-comment">// OH_ImageSource_GetFrameCount(imageSourceNative_c, &amp;count);</span></li><li>
</li><li>      OhosImageSourceInfo info{};</li><li>      <span class="hljs-comment">// 读取图片宽高。</span></li><li>      <span class="hljs-built_in">OH_ImageSource_GetImageInfo</span>(imageSourceNative_c, <span class="hljs-number">0</span>, &amp;info);</li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, <span class="hljs-number">0xFF00</span>, <span class="hljs-string">"[decode]"</span>, <span class="hljs-string">"imageInfo width:%{public}d , height:%{public}d"</span>, info.size.width, info.size.height);</li><li>      </li><li>      <span class="hljs-comment">// 读取ImageSource的ImageWidth配置参数并打印日志。</span></li><li>      OhosImageSourceProperty target;</li><li>      <span class="hljs-type">char</span> exifKey_c[] = <span class="hljs-string">"ImageWidth"</span>;</li><li>      target.size = <span class="hljs-built_in">strlen</span>(exifKey_c);</li><li>      target.value = exifKey_c;</li><li>
</li><li>      OhosImageSourceProperty response{};</li><li>      response.size = <span class="hljs-number">20</span>;</li><li>      response.value = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-built_in">malloc</span>(<span class="hljs-number">20</span>));</li><li>      <span class="hljs-built_in">OH_ImageSource_GetImageProperty</span>(imageSourceNative_c, &amp;target, &amp;response);</li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, <span class="hljs-number">0xFF00</span>, <span class="hljs-string">"[decode]"</span>, <span class="hljs-string">"ImageProperty width after modify:%{public}s"</span>, response.value);</li><li>
</li><li>      <span class="hljs-comment">// 处理完毕，释放native层资源。</span></li><li>      <span class="hljs-built_in">OH_ImageSource_Release</span>(imageSourceNative_c);</li><li>      <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>      <span class="hljs-keyword">return</span> pixelMap;</li><li>   }</li><li>   <span class="hljs-built_in">OH_ResourceManager_ReleaseNativeResourceManager</span>(mNativeResMgr);</li><li>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>     <p>图片框架支持增量式解码，使用方法如下：</p>     <div _ngcontent-odh-c106="" class="highlight-div"><div _ngcontent-odh-c106="" class="highlight-div-header"><div _ngcontent-odh-c106="" class="highlight-div-header-left"><div _ngcontent-odh-c106="" class="handle-button expand-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odh-c106="" class="highlight-div-header-right"><div _ngcontent-odh-c106="" class="handle-button ai-button"></div><div _ngcontent-odh-c106="" class="handle-button line-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odh-c106="" class="handle-button theme-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odh-c106="" class="handle-button copy-button"><div _ngcontent-odh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 引入图片框架、raw文件、raw文件管理和日志打印头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_source_mdk.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image_pixel_map_mdk.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rawfile/raw_file_manager.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">getSyncPixelMap</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>   napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>   <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>   </li><li>   napi_valuetype srcType;</li><li>   <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;srcType);</li><li>
</li><li>   <span class="hljs-comment">// 入参args[0]是资源管理器，用来初始化native层的资源管理器。</span></li><li>   NativeResourceManager * mNativeResMgr = <span class="hljs-built_in">OH_ResourceManager_InitNativeResourceManager</span>(env, args[<span class="hljs-number">0</span>]);</li><li>   </li><li>   <span class="hljs-type">size_t</span> strSize;</li><li>   <span class="hljs-type">char</span> srcBuf[<span class="hljs-number">2048</span>];</li><li>   <span class="hljs-comment">// 入参args[1]是文件名称。</span></li><li>   <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], srcBuf, <span class="hljs-built_in">sizeof</span>(srcBuf), &amp;strSize);</li><li>
</li><li>   <span class="hljs-comment">// 用资源管理器打开Raw文件。</span></li><li>   RawFile * rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(mNativeResMgr, srcBuf);</li><li>   <span class="hljs-keyword">if</span> (rawFile != <span class="hljs-literal">NULL</span>) {</li><li>      <span class="hljs-comment">// 获取文件大小，若大于2048字节，则增量式解码，否则直接全部解码。</span></li><li>      <span class="hljs-type">long</span> len = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>      <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">2048</span>) {</li><li>         <span class="hljs-type">uint8_t</span> * data = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">malloc</span>(len));</li><li>         <span class="hljs-comment">// 读取文件全部数据。</span></li><li>         <span class="hljs-type">int</span> res = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, data, len);</li><li>         </li><li>         <span class="hljs-type">uint8_t</span> * holderdata = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">malloc</span>(len));</li><li>
</li><li>         OhosImageSource imageSource_c;</li><li>         <span class="hljs-comment">// imageSource_c的buffer分配了空间，但是数据是空的。</span></li><li>         imageSource_c.buffer = holderdata;</li><li>         imageSource_c.bufferSize = len;</li><li>         OhosImageSourceOps ops{};</li><li>         napi_value imageSource;</li><li>         <span class="hljs-comment">// 初始化增量ImageSource。</span></li><li>         <span class="hljs-built_in">OH_ImageSource_CreateIncremental</span>(env, &amp;imageSource_c, &amp;ops, &amp;imageSource);</li><li>
</li><li>         <span class="hljs-comment">// 初始化native层的ImageSource。</span></li><li>         ImageSourceNative * imageSourceNative_c = <span class="hljs-built_in">OH_ImageSource_InitNative</span>(env, imageSource);</li><li>
</li><li>         <span class="hljs-comment">// 以下模拟分片加载场景，分两次加载分片。第一次加载2048字节，第二次加载剩余的数据。</span></li><li>         OhosImageSourceUpdateData firstData{};</li><li>         firstData.buffer = data; <span class="hljs-comment">// 图片数据。</span></li><li>         firstData.bufferSize = len; <span class="hljs-comment">// 图片数据总大小。</span></li><li>         firstData.isCompleted = <span class="hljs-literal">false</span>;</li><li>         firstData.offset = <span class="hljs-number">0</span>; <span class="hljs-comment">// 第一次重头开始加载。</span></li><li>         firstData.updateLength = <span class="hljs-number">2048</span>; <span class="hljs-comment">// 第一次加载了2048字节。</span></li><li>         <span class="hljs-built_in">OH_ImageSource_UpdateData</span>(imageSourceNative_c, &amp;firstData);</li><li>
</li><li>         OhosImageSourceUpdateData secondData{};</li><li>         secondData.buffer = data;</li><li>         secondData.bufferSize = len;</li><li>         secondData.isCompleted = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 最后一次加载，要标记加载完成。</span></li><li>         secondData.offset = <span class="hljs-number">2048</span>; <span class="hljs-comment">// 已经加载过2048字节了，第二次偏移已经加载的量。</span></li><li>         secondData.updateLength = len - <span class="hljs-number">2048</span>; <span class="hljs-comment">// 第二次加载剩余的数据。</span></li><li>         <span class="hljs-built_in">OH_ImageSource_UpdateData</span>(imageSourceNative_c, &amp;secondData);</li><li>
</li><li>         napi_value pixelMap;</li><li>         OhosImageDecodingOps decodingOps{};</li><li>         decodingOps.index = <span class="hljs-number">0</span>;</li><li>         <span class="hljs-comment">// 创建pixelMap。</span></li><li>         <span class="hljs-built_in">OH_ImageSource_CreatePixelMap</span>(imageSourceNative_c, &amp;decodingOps, &amp;pixelMap);</li><li>
</li><li>         <span class="hljs-comment">// 处理完毕，释放native层资源。</span></li><li>         <span class="hljs-built_in">OH_ImageSource_Release</span>(imageSourceNative_c);</li><li>         <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>         <span class="hljs-keyword">return</span> pixelMap;</li><li>      }</li><li>      <span class="hljs-comment">// 读取Raw文件全部数据。</span></li><li>      <span class="hljs-type">uint8_t</span> * data = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">malloc</span>(len));</li><li>      <span class="hljs-type">int</span> res = <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, data, len);</li><li>
</li><li>      OhosImageSource imageSource_c;</li><li>      imageSource_c.buffer = data;</li><li>      imageSource_c.bufferSize = len;</li><li>
</li><li>      OhosImageSourceOps ops{};</li><li>      napi_value imageSource;</li><li>      napi_value pixelMap;</li><li>
</li><li>      <span class="hljs-comment">// 用读取到的Raw数据创建ImageSource。</span></li><li>      <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_ImageSource_Create</span>(env, &amp;imageSource_c, &amp;ops, &amp;imageSource);</li><li>
</li><li>      <span class="hljs-comment">// 初始化native层的ImageSource。</span></li><li>      ImageSourceNative * imageSourceNative_c = <span class="hljs-built_in">OH_ImageSource_InitNative</span>(env, imageSource);</li><li>      OhosImageDecodingOps decodingOps{};</li><li>
</li><li>      <span class="hljs-comment">// 创建pixelMap。</span></li><li>      <span class="hljs-built_in">OH_ImageSource_CreatePixelMap</span>(imageSourceNative_c, &amp;decodingOps, &amp;pixelMap);</li><li>
</li><li>      <span class="hljs-comment">// 处理完毕，释放native层资源。</span></li><li>      <span class="hljs-built_in">OH_ImageSource_Release</span>(imageSourceNative_c);</li><li>      <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>      <span class="hljs-keyword">return</span> pixelMap;</li><li>   }</li><li>   <span class="hljs-built_in">OH_ResourceManager_ReleaseNativeResourceManager</span>(mNativeResMgr);</li><li>   <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>