<h1 _ngcontent-ked-c119="" class="doc-title ng-star-inserted" title="图编译和图执行"> 图编译和图执行 </h1>

<div _ngcontent-ked-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>单算子模型执行是指基于图IR执行算子，先编译算子（例如，使用OMG工具将Ascend IR定义的单算子描述文件编译成算子omc模型文件），再调用模型加载推理接口执行单算子网络。下文仅提供单算子模型执行的样例和基础内容讲解，详细内容请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-on-device-deployment">端侧部署</a>章节。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>HarmonyOS Next暂不支持图编译与图执行，仅支持通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-ai-framework-operator-adaptation">AI框架算子适配</a>方式集成自定义算子，以下步骤仅供参考。</p> </div></div></div> <div class="tiledSection"><h2 id="section5453mcpsimp">环境要求<i class="anchor-icon anchor-icon-link" anchorid="section5453mcpsimp" tips="复制节点链接"></i></h2><ul><li>已参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-environment-preparation">环境准备</a>，完成DDK驱动和软件的安装，配置DDK软件所需基本环境变量。<p>安装DDK软件后，使用DDK运行开发者进行编译、运行时，需要以DDK运行开发者登录环境，执行<strong>source ${install_path}/ddk/tools/tools_ascendc/set_ascendc_env.sh</strong>命令设置环境变量。其中${install_path}为DDK软件的安装目录，例如：/home。</p> </li><li>已参考完成算子的开发和部署。</li></ul> </div> <div class="tiledSection"><h2 id="section5462mcpsimp">准备验证代码工程<i class="anchor-icon anchor-icon-link" anchorid="section5462mcpsimp" tips="复制节点链接"></i></h2><p>在执行NPU调试命令时，例如：</p> <div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>ascendebug kernel --backend npu  --chip-version kirin9020 --repo-type customize --json-file ./temp.json --core-type AiCore</li></ol></pre></div></div> <p>命令行参数详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section1351011652416">NPU调测参数</a>，会在${debug_workspace} /${op_type} /npu/src下生成验证样例工程，代码工程目录结构如下。</p> <div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>src</li><li>├── BuildIRGraph.cpp  // 生成单算子图源文件</li><li>├── BuildIRGraph.h    // 单算子图入口：CreateCustomIRGraph</li><li>├── build.sh            // omc 模型编译脚本</li><li>├── CMakeLists.txt</li><li>├── custom_graph.omc // 编译后得到的omc模型</li><li>└── op_proto.h         // 算子编译输出的算子原型定义头文件</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section5473mcpsimp">生成单算子离线模型文件<i class="anchor-icon anchor-icon-link" anchorid="section5473mcpsimp" tips="复制节点链接"></i></h2><p>执行验证样例工程下的build.sh。</p> <div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>./build.sh</li></ol></pre></div></div> <p>以上命令执行后，会在当前路径下生成custom_graph.omc的离线模型文件。</p> </div> <div class="tiledSection"><h2 id="section5480mcpsimp">生成输入数据<i class="anchor-icon anchor-icon-link" anchorid="section5480mcpsimp" tips="复制节点链接"></i></h2><p>在样例工程目录下，执行如下命令：</p> <div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>python3 scripts/gen_data.py</li></ol></pre></div></div> <p>会在input目录下生成两个shape为(8,2048)，数据类型为float16的数据文件input_0.bin与input_1.bin，用于进行AddCustom算子的验证。</p> <p>代码样例如下。</p> <div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np </li><li>a = np.random.randint(<span class="hljs-number">100</span>, size=(<span class="hljs-number">8</span>, <span class="hljs-number">2048</span>,)).astype(np.float16) </li><li>b = np.random.randint(<span class="hljs-number">100</span>, size=(<span class="hljs-number">8</span>, <span class="hljs-number">2048</span>,)).astype(np.float16) </li><li>a.tofile(<span class="hljs-string">'input_0.bin'</span>) </li><li>b.tofile(<span class="hljs-string">'input_1.bin'</span>)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section5499mcpsimp">APP集成代码<i class="anchor-icon anchor-icon-link" anchorid="section5499mcpsimp" tips="复制节点链接"></i></h2><p>开发者可以参考如下样例编写模型加载、执行的代码逻辑。完整集成流程请参考<a href="https://developer.huawei.com/consumer/cn/doc/hiai-Guides/app-dev-0000001052605540" target="_blank">应用开发</a>。</p> <div class="p">以下是关键步骤的代码示例，不可以直接拷贝编译运行，仅供参考，调用接口后，需增加异常处理的分支，并记录报错日志、提示日志，此处不一一列举。<div _ngcontent-ked-c106="" class="highlight-div"><div _ngcontent-ked-c106="" class="highlight-div-header"><div _ngcontent-ked-c106="" class="highlight-div-header-left"><div _ngcontent-ked-c106="" class="handle-button expand-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ked-c106="" class="highlight-div-header-right"><div _ngcontent-ked-c106="" class="handle-button ai-button"></div><div _ngcontent-ked-c106="" class="handle-button line-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ked-c106="" class="handle-button theme-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ked-c106="" class="handle-button copy-button"><div _ngcontent-ked-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ked-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RunModel</span><span class="hljs-params">(<span class="hljs-type">void</span>* modelData, <span class="hljs-type">size_t</span> modelSize)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 1.加载omc模型</span></li><li>    <span class="hljs-keyword">auto</span> modelDescV1 = std::<span class="hljs-built_in">make_shared</span>&lt;hiai::AiModelDescription&gt;(<span class="hljs-string">"model"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>    modelDescV1-&gt;<span class="hljs-built_in">SetModelBuffer</span>(modelData, modelSize);</li><li>
</li><li>    std::vector&lt;std::shared_ptr&lt;hiai::AiModelDescription&gt;&gt; modelDescVec;</li><li>    modelDescVec.<span class="hljs-built_in">push_back</span>(modelDescV1);</li><li>    <span class="hljs-keyword">auto</span> clientV1 = std::<span class="hljs-built_in">make_shared</span>&lt;hiai::AiModelMngerClient&gt;();</li><li>    <span class="hljs-keyword">if</span> (clientV1-&gt;<span class="hljs-built_in">Init</span>(<span class="hljs-literal">nullptr</span>) != hiai::SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"client Init() failed."</span>);</li><li>        <span class="hljs-keyword">return</span> FAILURE;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (clientV1-&gt;<span class="hljs-built_in">Load</span>(modelDescVec) != hiai::SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"client Load() failed."</span>);</li><li>        <span class="hljs-keyword">return</span> FAILURE;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"load model success"</span>);</li><li>    std::vector&lt;hiai::TensorDimension&gt; inDimVecV1;</li><li>    std::vector&lt;hiai::TensorDimension&gt; outDimVecV1;</li><li>    std::vector&lt;std::shared_ptr&lt;hiai::AiTensor&gt;&gt; inTensorVecV1;</li><li>    std::vector&lt;std::shared_ptr&lt;hiai::AiTensor&gt;&gt; outTensorVecV1;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (clientV1-&gt;<span class="hljs-built_in">GetModelIOTensorDim</span>(modelDescV1-&gt;<span class="hljs-built_in">GetName</span>(), inDimVecV1, outDimVecV1) != hiai::SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"client GetModelIOTensorDim() failed."</span>);</li><li>        clientV1-&gt;<span class="hljs-built_in">UnLoadModel</span>();</li><li>        <span class="hljs-keyword">return</span> FAILURE;</li><li>    }</li><li>    <span class="hljs-comment">// 2、设置模型输入、输出</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; INPUT_NUM &amp;&amp;  i &lt; inDimVecV1.<span class="hljs-built_in">size</span>(); ++i) {</li><li>        <span class="hljs-type">void</span> *data = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"open input file  inputFile: %s "</span>, INPUT_LIST[i].<span class="hljs-built_in">c_str</span>());</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadData</span>(INPUT_LIST[i], &amp;data, size)) {</li><li>            <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"open input file failed! inputFile: %s "</span>, INPUT_LIST[i].<span class="hljs-built_in">c_str</span>());</li><li>            clientV1-&gt;<span class="hljs-built_in">UnLoadModel</span>();</li><li>            <span class="hljs-keyword">return</span> FAILURE;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">auto</span> inputV1 = std::<span class="hljs-built_in">make_shared</span>&lt;hiai::AiTensor&gt;();</li><li>
</li><li>        inputV1-&gt;<span class="hljs-built_in">Init</span>(&amp;inDimVecV1[i], INPUT_TYPE);</li><li>        <span class="hljs-keyword">if</span> (inputV1-&gt;<span class="hljs-built_in">GetSize</span>() != size) {</li><li>            <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"inputSize: %d != fileSize: %zu "</span>, inputV1-&gt;<span class="hljs-built_in">GetSize</span>(), size);</li><li>            clientV1-&gt;<span class="hljs-built_in">UnLoadModel</span>();</li><li>            <span class="hljs-built_in">free</span>(data);</li><li>            data = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-keyword">return</span> FAILURE;</li><li>        }</li><li>        <span class="hljs-built_in">memcpy</span>(inputV1-&gt;<span class="hljs-built_in">GetBuffer</span>(), data, size);</li><li>        inTensorVecV1.<span class="hljs-built_in">push_back</span>(inputV1);</li><li>        <span class="hljs-built_in">free</span>(data);</li><li>        data = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"load input success"</span>);</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outDimVecV1.<span class="hljs-built_in">size</span>(); i++) {</li><li>        <span class="hljs-keyword">auto</span> outputV1 = std::<span class="hljs-built_in">make_shared</span>&lt;hiai::AiTensor&gt;();</li><li>        outputV1-&gt;<span class="hljs-built_in">Init</span>(&amp;outDimVecV1[i], OUTPUT_TYPE);</li><li>        outTensorVecV1.<span class="hljs-built_in">push_back</span>(outputV1);</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"init output success"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 3、进行模型推理</span></li><li>    hiai::AiContext context;</li><li>    context.<span class="hljs-built_in">AddPara</span>(<span class="hljs-string">"model_name"</span>, <span class="hljs-string">"model"</span>);</li><li>    <span class="hljs-type">int32_t</span> istamp = <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-keyword">auto</span> retCode = clientV1-&gt;<span class="hljs-built_in">Process</span>(context, inTensorVecV1, outTensorVecV1, <span class="hljs-number">1000</span>, istamp);</li><li>    <span class="hljs-keyword">if</span> (retCode != hiai::SUCCESS) {</li><li>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"process failed."</span>);</li><li>        clientV1-&gt;<span class="hljs-built_in">UnLoadModel</span>();</li><li>        <span class="hljs-keyword">return</span> retCode;</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"process success"</span>);</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; outTensorVecV1.<span class="hljs-built_in">size</span>(); i++) {</li><li>        <span class="hljs-type">char</span>* data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(outTensorVecV1[i]-&gt;<span class="hljs-built_in">GetBuffer</span>());</li><li>        <span class="hljs-built_in">DumpBufferToFile</span>(data, outTensorVecV1[i]-&gt;<span class="hljs-built_in">GetSize</span>(), OUTPUT_PATH);</li><li>    }</li><li>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"dump output success"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 4、模型卸载</span></li><li>    clientV1-&gt;<span class="hljs-built_in">UnLoadModel</span>();</li><li>    <span class="hljs-keyword">return</span> retCode;</li><li>}</li></ol></pre></div></div> </div> </div> </div> <div></div></div>