<h1 _ngcontent-tuw-c119="" class="doc-title ng-star-inserted" title="在NDK中保证多实例场景功能正常"> 在NDK中保证多实例场景功能正常 </h1>

<div _ngcontent-tuw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>API version 20开始，ArkUI开发框架新增了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_runtaskinscope" target="_blank">OH_ArkUI_RunTaskInScope</a>接口，解决Native侧多实例场景下的组件操作问题。该功能通过动态切换执行上下文，确保跨实例组件属性设置的合法性，避免实例上下文不匹配导致的接口调用异常。</p>    <p>在NDK多窗口开发时，可能会涉及到组件的跨实例设置属性等场景，使用该能力可确保在调用跨实例组件设置属性时的上下文正确性，避免跨实例接口调用失败。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>        <p>适用于NDK多窗口开发中不同UI实例间的交互场景，例如在页面B中修改页面A创建的组件属性或未挂载到UI树的组件逻辑。</p></li>       <li>        <p>支持通过userData参数传递自定义数据结构（如组件指针、业务参数等），便于在回调任务中精准定位目标组件。</p></li>       <li>        <p>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_nodeutils_getattachednodehandlebyid" target="_blank">OH_ArkUI_NodeUtils_GetAttachedNodeHandleById</a>等接口配合使用，有效规避跨实例访问导致的空指针或权限异常问题。</p></li>      </ul>     </div></div></div>    <p>本示例展示OH_ArkUI_RunTaskInScope接口的基础使用方式，OH_ArkUI_NodeUtils_GetAttachedNodeHandleById用于获取前置实例页面内的组件，相关使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_nodeutils_getattachednodehandlebyid" target="_blank">OH_ArkUI_NodeUtils_GetAttachedNodeHandleById</a>，此处userData传入的数据类型为最终要设置的组件指针，便于设置对应组件属性。</p>    <div _ngcontent-tuw-c106="" class="highlight-div"><div _ngcontent-tuw-c106="" class="highlight-div-header"><div _ngcontent-tuw-c106="" class="highlight-div-header-left"><div _ngcontent-tuw-c106="" class="handle-button expand-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tuw-c106="" class="highlight-div-header-right"><div _ngcontent-tuw-c106="" class="handle-button ai-button"></div><div _ngcontent-tuw-c106="" class="handle-button line-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tuw-c106="" class="handle-button theme-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tuw-c106="" class="handle-button copy-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tuw-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//page1</span></li><li>ArkUI_NodeHandle button = nodeAPI-&gt;createNode(ARKUI_NODE_BUTTON);</li><li>ArkUI_AttributeItem LABEL_Item = {.<span class="hljs-built_in">string</span> = <span class="hljs-string">"pageOneButton"</span>};</li><li><span class="hljs-comment">//设置id，用于在第二个页面内通过接口查找</span></li><li>ArkUI_AttributeItem id = {.<span class="hljs-built_in">string</span> = <span class="hljs-string">"pageOneButton"</span>};</li><li>nodeAPI-&gt;setAttribute(button, NODE_ID, &amp;id);</li><li>nodeAPI-&gt;setAttribute(button, NODE_BUTTON_LABEL, &amp;LABEL_Item);</li></ol></pre></div></div>    <div _ngcontent-tuw-c106="" class="highlight-div"><div _ngcontent-tuw-c106="" class="highlight-div-header"><div _ngcontent-tuw-c106="" class="highlight-div-header-left"><div _ngcontent-tuw-c106="" class="handle-button expand-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tuw-c106="" class="highlight-div-header-right"><div _ngcontent-tuw-c106="" class="handle-button ai-button"></div><div _ngcontent-tuw-c106="" class="handle-button line-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tuw-c106="" class="handle-button theme-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tuw-c106="" class="handle-button copy-button"><div _ngcontent-tuw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tuw-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//page2</span></li><li><span class="hljs-comment">//pageOneButton由前置页面创建，通过OH_ArkUI_NodeUtils_GetAttachedNodeHandleById在第二个页面获取。</span></li><li>ArkUI_NodeHandle pageOneButton = nullptr;</li><li><span class="hljs-keyword">auto</span> ec = OH_ArkUI_NodeUtils_GetAttachedNodeHandleById(<span class="hljs-string">"pageOneButton"</span>, &amp;pageOneButton);</li><li><span class="hljs-keyword">auto</span> uiContext = OH_ArkUI_GetContextByNode(pageOneButton);</li><li>OH_ArkUI_RunTaskInScope(uiContext, pageOneButton, [](<span class="hljs-type">void</span> *userData) {</li><li>        <span class="hljs-keyword">auto</span> *nodeAPI = reinterpret_cast&lt;ArkUI_NativeNodeAPI_1 *&gt;(</li><li>            OH_ArkUI_QueryModuleInterfaceByName(ARKUI_NATIVE_NODE, <span class="hljs-string">"ArkUI_NativeNodeAPI_1"</span>));</li><li>        <span class="hljs-keyword">auto</span> pageOneButton = (ArkUI_NodeHandle)userData;</li><li>        ArkUI_NumberValue value[] = {<span class="hljs-number">480</span>};</li><li>        ArkUI_AttributeItem LABEL_Item = {.<span class="hljs-built_in">string</span> = <span class="hljs-string">"success"</span>};</li><li>        value[<span class="hljs-number">0</span>].f32 = <span class="hljs-number">250</span>;</li><li>        ArkUI_AttributeItem button_Item = {value, <span class="hljs-keyword">sizeof</span>(value) / <span class="hljs-keyword">sizeof</span>(ArkUI_NumberValue)};</li><li>        nodeAPI-&gt;setAttribute(pageOneButton, NODE_BUTTON_LABEL, &amp;LABEL_Item);</li><li>        nodeAPI-&gt;setAttribute(pageOneButton, NODE_WIDTH, &amp;button_Item);</li><li>    }</li><li>);</li></ol></pre></div></div>   </div>   <div></div></div>