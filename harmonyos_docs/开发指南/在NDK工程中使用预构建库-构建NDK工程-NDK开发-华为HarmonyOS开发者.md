<h1 _ngcontent-cey-c119="" class="doc-title ng-star-inserted" title="在NDK工程中使用预构建库"> 在NDK工程中使用预构建库 </h1>

<div _ngcontent-cey-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在NDK工程中，可以通过CMake语法规则引入并使用预构建库。在引用预构建库时，模块libs目录中的预构建库，以及在CMakeLists.txt编译脚本中声明的预构建库都会被打包。</p>  <div class="tiledSection"><h2 id="预构建库使用约束">预构建库使用约束<i class="anchor-icon anchor-icon-link" anchorid="预构建库使用约束" tips="复制节点链接"></i></h2><p>1.确保引入的SO动态库是通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-overview">HarmonyOS NDK 编译工具链</a>编译生成，如何通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-overview">HarmonyOS NDK 编译工具链</a>编译预构建库，请参照<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-cmake-adapts-to-harmonyos#section1826019653918" target="_blank">CMake构建三方库适配流程</a>。</p> <p>2.确保引入的SO动态库的依赖库也导入到工程中且通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-overview">HarmonyOS NDK 编译工具链</a>编译生成。</p> </div>  <div class="tiledSection"><h2 id="直接引入预构建库">直接引入预构建库<i class="anchor-icon anchor-icon-link" anchorid="直接引入预构建库" tips="复制节点链接"></i></h2><p>可以通过直接将预构建的库文件复制到项目文件中, 来使用预构建库。例如在项目中需要使用预构建库libavcodec_ffmpeg.so，其开发态存放路径如下图所示：</p> <p><span><img originheight="339" originwidth="350" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114334.62018432067698401420206247439426:50001231000000:2800:77A843E81219FE74ACC4396957F62FAA975DDB98D61D0AE9DDE7E32619523220.png" width="350" height="339"></span></p> <p>在模块的CMakeLists.txt编译脚本中通过add_library添加所需的预构建库，并声明预构建库路径等信息后，可以在target_link_libraries中声明链接该预构建库，脚本示例如下所示：</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">add_library</span>(library SHARED hello.cpp)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(avcodec_ffmpeg SHARED IMPORTED)</li><li><span class="hljs-built_in">set_target_properties</span>(avcodec_ffmpeg</li><li>    PROPERTIES</li><li>    IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/third_party/FFmpeg/libs/${OHOS_ARCH}/libavcodec_ffmpeg.so)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(library PUBLIC libace_napi.z.so avcodec_ffmpeg)</li></ol></pre></div></div> <p>在模块的CMakeLists.txt编译脚本中添加include_directories：</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-bash" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li>include_directories(</li><li>    <span class="hljs-comment"># ...</span></li><li>    <span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span>/third_party/FFmpeg/include</li><li>)</li></ol></pre></div></div> <p>当在HAR中使用预构建库时，当前编译的库和链接所需预构建库会打包到HAR中的libs目录下，如下图所示：</p> <p><span><img originheight="374" originwidth="344" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114334.09647449863448133504262759912048:50001231000000:2800:FCD4754AAC59B75F1A5DC57A10A97DCB8B3B13DC60D3A820BE223FB0F3BD8DBD.png" width="344" height="374"></span></p> </div>  <div class="tiledSection"><h3 id="预构建库的soname问题" class="firsth2">预构建库的SONAME问题<i class="anchor-icon anchor-icon-link" anchorid="预构建库的soname问题" tips="复制节点链接"></i></h3><p>请确保引入的预构建动态库（so）正确设置了SONAME。</p> <p>如果预构建so没有SONAME，链接器将会将so的绝对路径插入到依赖这个so的二进制文件的dynamic section中。当这些二进制文件随hap包发布运行时，动态加载器（dynamic loader）可能最终无法找到这个so而导致错误。</p> <p>可以使用llvm-readelf工具查看so文件是否设置了SONAME。llvm-readelf工具路径为：${DevEco Studio安装目录}/sdk/default/openharmony/native/llvm/bin或者${command-line-tools安装目录}/sdk/default/openharmony/native/llvm/bin/llvm-readelf。</p> <p>示例如下：</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="bash prettyprint linenums hljs language-bash" hw-language="bash" data-highlighted="yes"><ol class="linenums"><li>&gt; <span class="hljs-variable">${YOUR_PATH}</span>/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-readelf -d libavcodec_ffmpeg.so | grep SONAME</li><li>0x000000000000000e (SONAME)             Library soname: [libavcodec_ffmpeg.so]</li></ol></pre></div></div> <p>若预构建so使用cmake进行构建，则所有的so默认会设置SONAME（只要目标平台支持）。</p> <p>若预构建so使用其他构建工具，可以通过配置ldflags来设置。</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="bash prettyprint linenums hljs language-bash" hw-language="bash" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">${...}</span>/clang++ <span class="hljs-variable">${...}</span> -Wl,-soname,libavcodec_ffmpeg.so</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="使用远程依赖har中集成的预构建库">使用远程依赖HAR中集成的预构建库<i class="anchor-icon anchor-icon-link" anchorid="使用远程依赖har中集成的预构建库" tips="复制节点链接"></i></h2><p>当使用远程依赖HAR中集成的预构建库时，CMakeLists.txt文件中引用脚本如下所示：</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">set</span>(DEPENDENCY_PATH ${CMAKE_CURRENT_SOURCE_DIR}/../../../oh_modules)</li><li><span class="hljs-built_in">add_library</span>(library SHARED IMPORTED)</li><li><span class="hljs-built_in">set_target_properties</span>(library</li><li>    PROPERTIES</li><li>    IMPORTED_LOCATION ${DEPENDENCY_PATH}/library/libs/${OHOS_ARCH}/liblibrary.so)</li><li><span class="hljs-built_in">add_library</span>(entry SHARED hello.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so library)</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="使用本地har中集成的预构建库">使用本地HAR中集成的预构建库<i class="anchor-icon anchor-icon-link" anchorid="使用本地har中集成的预构建库" tips="复制节点链接"></i></h2><p>当使用本地HAR中集成的预构建库时，CMakeLists.txt文件中引用脚本如下所示：</p> <div _ngcontent-cey-c106="" class="highlight-div"><div _ngcontent-cey-c106="" class="highlight-div-header"><div _ngcontent-cey-c106="" class="highlight-div-header-left"><div _ngcontent-cey-c106="" class="handle-button expand-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cey-c106="" class="highlight-div-header-right"><div _ngcontent-cey-c106="" class="handle-button ai-button"></div><div _ngcontent-cey-c106="" class="handle-button line-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cey-c106="" class="handle-button theme-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cey-c106="" class="handle-button copy-button"><div _ngcontent-cey-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cey-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">set</span>(LIBRARY_DIR "${NATIVERENDER_ROOT_PATH}/../../../../library/build/default/intermediates/libs/default/${OHOS_ARCH}/")</li><li><span class="hljs-built_in">add_library</span>(library SHARED IMPORTED)</li><li><span class="hljs-built_in">set_target_properties</span>(library</li><li>    PROPERTIES</li><li>    IMPORTED_LOCATION ${LIBRARY_DIR}/liblibrary.so)</li><li><span class="hljs-built_in">add_library</span>(entry SHARED hello.cpp)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so library)</li></ol></pre></div></div> </div> </div> <div></div></div>