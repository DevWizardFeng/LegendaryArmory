<h1 _ngcontent-cxm-c119="" class="doc-title ng-star-inserted" title="在Worker线程中使用相机(ArkTS)"> 在Worker线程中使用相机(ArkTS) </h1>

<div _ngcontent-cxm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">Worker</a>主要作用是为应用程序提供一个多线程的运行环境，可满足应用程序在执行过程中与主线程分离，在后台线程中运行一个脚本进行耗时操作，极大避免类似于计算密集型或高延迟的任务阻塞主线程的运行。</p>    <p>通常开发者使用相机功能需要创建相机会话，并持续接收处理预览流、拍照流、录像流等从而实现相关相机功能，这些密集型操作如果都放在主线程即UI线程，可能会阻塞UI绘制，推荐开发者在worker线程中实现相机功能。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入依赖，本篇文档需要用到worker和相机框架等相关依赖包。</p>       <div _ngcontent-cxm-c106="" class="highlight-div"><div _ngcontent-cxm-c106="" class="highlight-div-header"><div _ngcontent-cxm-c106="" class="highlight-div-header-left"><div _ngcontent-cxm-c106="" class="handle-button expand-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cxm-c106="" class="highlight-div-header-right"><div _ngcontent-cxm-c106="" class="handle-button ai-button"></div><div _ngcontent-cxm-c106="" class="handle-button line-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cxm-c106="" class="handle-button theme-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cxm-c106="" class="handle-button copy-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cxm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorEvent</span>, <span class="hljs-title class_">MessageEvents</span>, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建相机服务代理类，调用CameraKit方法都放在这个类里执行。</p>       <div _ngcontent-cxm-c106="" class="highlight-div"><div _ngcontent-cxm-c106="" class="highlight-div-header"><div _ngcontent-cxm-c106="" class="highlight-div-header-left"><div _ngcontent-cxm-c106="" class="handle-button expand-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cxm-c106="" class="highlight-div-header-right"><div _ngcontent-cxm-c106="" class="handle-button ai-button"></div><div _ngcontent-cxm-c106="" class="handle-button line-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cxm-c106="" class="handle-button theme-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cxm-c106="" class="handle-button copy-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cxm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CameraService</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameras</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">previewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">photoOutput</span>: camera.<span class="hljs-property">PhotoOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">session</span>: camera.<span class="hljs-property">PhotoSession</span> | camera.<span class="hljs-property">VideoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-comment">// 初始化相机。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initCamera</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initCamera surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>      <span class="hljs-comment">// 获取相机管理器实例。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(context);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span> === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraManager is undefined'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraManager.getSupportedCameras error"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 创建cameraInput输出对象。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createCameraInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>[<span class="hljs-number">0</span>]);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span> === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to create the camera input.'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 打开相机。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>.<span class="hljs-title function_">open</span>();</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: camera.<span class="hljs-property">Profile</span> = {</li><li>        <span class="hljs-attr">format</span>: camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YUV_420_SP</span>,</li><li>        <span class="hljs-attr">size</span>: {</li><li>          <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>,</li><li>          <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span></li><li>        }</li><li>      };</li><li>      <span class="hljs-comment">// 创建预览流输出。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, surfaceId);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span> === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to create the preview stream.'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">photoProfile</span>: camera.<span class="hljs-property">Profile</span> = {</li><li>        <span class="hljs-attr">format</span>: camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_JPEG</span>,</li><li>        <span class="hljs-attr">size</span>: {</li><li>          <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>,</li><li>          <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span></li><li>        }</li><li>      };</li><li>      <span class="hljs-comment">// 创建拍照流输出。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createPhotoOutput</span>(photoProfile);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span> === <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to create the photoOutput.'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 创建相机会话，启动会话。</span></li><li>      <span class="hljs-keyword">let</span> session = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>);</li><li>      <span class="hljs-keyword">if</span> (!session) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'session is null'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span> = session <span class="hljs-keyword">as</span> camera.<span class="hljs-property">PhotoSession</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">beginConfig</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span>);</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">commitConfig</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`initCamera fail: <span class="hljs-subst">${err}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放相机资源。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'releaseCamera is called'</span>);</li><li>    <span class="hljs-comment">// 停止当前会话。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to stop session: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放相机输入流。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>?.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to close the camera: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放预览输出流。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to stop the preview stream: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放拍照输出流。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Stop Photo Stream Failure: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to release session: '</span>, e)});</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'releaseCamera success'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建worker线程文件，配置worker。</p>       <p>DevEco Studio支持一键生成Worker，在对应的{moduleName}目录下任意位置，点击鼠标右键 &gt; New &gt; Worker，即可自动生成Worker的模板文件及配置信息，无需再手动在build-profile.json5中进行相关配置。</p>       <p>CameraWorker.ets实现参考：</p>       <div _ngcontent-cxm-c106="" class="highlight-div"><div _ngcontent-cxm-c106="" class="highlight-div-header"><div _ngcontent-cxm-c106="" class="highlight-div-header-left"><div _ngcontent-cxm-c106="" class="handle-button expand-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cxm-c106="" class="highlight-div-header-right"><div _ngcontent-cxm-c106="" class="handle-button ai-button"></div><div _ngcontent-cxm-c106="" class="handle-button line-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cxm-c106="" class="handle-button theme-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cxm-c106="" class="handle-button copy-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cxm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> cameraService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CameraService</span>();</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li>
</li><li><span class="hljs-comment">// 自定义消息格式。</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageInfo</span> {</li><li>  <span class="hljs-attr">hasResolve</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>; <span class="hljs-comment">// 注意worker线程中无法使用getContext()直接获取宿主线程context，需要通过消息从宿主线程通信到worker线程使用。</span></li><li>  <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvents</span>) =&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">messageInfo</span>: <span class="hljs-title class_">MessageInfo</span> = e.<span class="hljs-property">data</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`worker onmessage type:<span class="hljs-subst">${messageInfo.<span class="hljs-keyword">type</span>}</span>`</span>)</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-string">'initCamera'</span> === messageInfo.<span class="hljs-property">type</span>) {</li><li>    <span class="hljs-comment">// 在worker线程中收到宿主线程初始化相机的消息。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`worker initCamera surfaceId:<span class="hljs-subst">${messageInfo.surfaceId}</span>`</span>)</li><li>    <span class="hljs-comment">// 在worker线程中初始化相机。</span></li><li>    <span class="hljs-keyword">await</span> cameraService.<span class="hljs-title function_">initCamera</span>(messageInfo.<span class="hljs-property">context</span>, messageInfo.<span class="hljs-property">surfaceId</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'releaseCamera'</span> === messageInfo.<span class="hljs-property">type</span>) {</li><li>    <span class="hljs-comment">// 在worker线程中收到宿主线程释放相机的消息。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'worker releaseCamera.'</span>);</li><li>    <span class="hljs-comment">// 在worker线程中释放相机。</span></li><li>    <span class="hljs-keyword">await</span> cameraService.<span class="hljs-title function_">releaseCamera</span>();</li><li>  }</li><li>}</li><li>
</li><li>workerPort.<span class="hljs-property">onmessageerror</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>}</li><li>
</li><li>workerPort.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e: ErrorEvent</span>) =&gt;</span> {</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建组件，用于显示预览流，在页面相关生命周期中构造ThreadWorker实例，在worker线程中完成相机初始化和释放。</p>       <div _ngcontent-cxm-c106="" class="highlight-div"><div _ngcontent-cxm-c106="" class="highlight-div-header"><div _ngcontent-cxm-c106="" class="highlight-div-header-left"><div _ngcontent-cxm-c106="" class="handle-button expand-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cxm-c106="" class="highlight-div-header-right"><div _ngcontent-cxm-c106="" class="handle-button ai-button"></div><div _ngcontent-cxm-c106="" class="handle-button line-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cxm-c106="" class="handle-button theme-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cxm-c106="" class="handle-button copy-button"><div _ngcontent-cxm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cxm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-comment">// 创建ThreadWorker对象获取worker实例。</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">workerInstance</span>: worker.<span class="hljs-property">ThreadWorker</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/CameraWorker.ets'</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getHostContext</span>();</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-string">''</span> !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>) {</li><li>      <span class="hljs-comment">// 通过worker实例向worker线程发送消息初始化相机。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-title function_">postMessage</span>({</li><li>        <span class="hljs-attr">type</span>: <span class="hljs-string">'initCamera'</span>,</li><li>        <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>,</li><li>        <span class="hljs-attr">surfaceId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>,</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 通过worker实例向worker线程发送消息销毁相机。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-title function_">postMessage</span>({</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-string">'releaseCamera'</span>,</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">XComponent</span>({</li><li>          <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>          <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>          <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>        })</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>            <span class="hljs-comment">// 初始化XComponent获取预览流surfaceId。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">surfaceRect</span>: <span class="hljs-title class_">SurfaceRect</span> = {</li><li>              <span class="hljs-attr">surfaceWidth</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>,</li><li>              <span class="hljs-attr">surfaceHeight</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span></li><li>            };</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">setXComponentSurfaceRect</span>(surfaceRect);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onLoad surfaceId: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.surfaceId}</span>`</span>);</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'create stage worker failed'</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 宿主线程向worker线程发送初始化相机消息。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-title function_">postMessage</span>({</li><li>              <span class="hljs-attr">type</span>: <span class="hljs-string">'initCamera'</span>,</li><li>              <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-comment">// 将宿主线程的context传给worker线程使用。</span></li><li>              <span class="hljs-attr">surfaceId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>, <span class="hljs-comment">// 将surfaceId传给worker线程使用。</span></li><li>            })</li><li>          })<span class="hljs-comment">// The width and height of the surface are opposite to those of the XComponent.</span></li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>))</li><li>
</li><li>      }.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'WorkerDemo'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">End</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="trace对比">trace对比<i class="anchor-icon anchor-icon-link" anchorid="trace对比" tips="复制节点链接"></i></h2>          <p>不使用Worker：</p>     <p><span><img originheight="969" originwidth="1552" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.44922105507635221293455224014442:50001231000000:2800:8BF6D2E1A1F67FEB4EF1925B073B8E3F21128E0153549C354B30F1CE05865048.png" width="920" height="574.4072164948453"></span></p>     <p>使用Worker：</p>     <p><span><img originheight="1065" originwidth="1744" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.84127430025482659306095971159825:50001231000000:2800:371824190B35EC419A5C13CAF051BDDDAF33B51E5245378919694A3322CACEBF.png" width="920" height="561.8119266055045"></span></p>    </div>   </div>   <div></div></div>