<h1 _ngcontent-kql-c119="" class="doc-title ng-star-inserted" title="基于AVPlayer播放DRM节目(ArkTS)"> 基于AVPlayer播放DRM节目(ArkTS) </h1>

<div _ngcontent-kql-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以调用DRM Kit和Media Kit的ArkTS接口实现AVPlayer播放器，完成DRM节目播放。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入DRM Kit和Media Kit接口。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { drm } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DrmKit'</span></li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span></li></ol></pre></div></div></li>      <li>       <p>导入BusinessError模块抛出Drm Kit接口的错误码。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreateavplayer9" target="_blank">createAVPlayer</a>，创建AVPlayer实例并设置DRM信息监听事件。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">playerHandle</span>: media.<span class="hljs-property">AVPlayer</span>;</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initPlayer</span>(<span class="hljs-params"></span>) {</li><li>playerHandle = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>playerHandle.<span class="hljs-title function_">on</span>(<span class="hljs-string">'mediaKeySystemInfoUpdate'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">mediaKeySystemInfo</span>: drm.<span class="hljs-property">MediaKeySystemInfo</span>[]) =&gt; {</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'player has received drmInfo signal: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(mediaKeySystemInfo))</li><li><span class="hljs-comment">// 处理DRM信息。</span></li><li><span class="hljs-comment">// 设置解密session。</span></li><li>})</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-drm-f#drmcreatemediakeysystem" target="_blank">createMediaKeySystem</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-drm-mediakeysystem#createmediakeysession" target="_blank">createMediaKeySession</a>根据DRM信息中的uuid创建MediaKeySystem和MediaKeySession实例。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">mediaKeySystem</span>: drm.<span class="hljs-property">MediaKeySystem</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">mediaKeySession</span>: drm.<span class="hljs-property">MediaKeySession</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">drmInfoArr</span>: drm.<span class="hljs-property">MediaKeySystemInfo</span>[] = mediaKeySystemInfo</li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; drmInfoArr.<span class="hljs-property">length</span>; i++) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'drmInfoArr - uuid: '</span> + drmInfoArr[i].<span class="hljs-property">uuid</span>)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'drmInfoArr - pssh: '</span> + drmInfoArr[i].<span class="hljs-property">pssh</span>)</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">description</span>: drm.<span class="hljs-property">MediaKeySystemDescription</span>[] = drm.<span class="hljs-title function_">getMediaKeySystems</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">solutionName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"com.wiseplay.drm"</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> description) {</li><li>    <span class="hljs-keyword">if</span> (drmInfoArr[i].<span class="hljs-property">uuid</span> == item.<span class="hljs-property">uuid</span>) {</li><li>      solutionName = item.<span class="hljs-property">name</span></li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = drm.<span class="hljs-title function_">isMediaKeySystemSupported</span>(solutionName, <span class="hljs-string">"video/mp4"</span>);</li><li>    <span class="hljs-keyword">if</span> (isSupported) {</li><li>      mediaKeySystem = drm.<span class="hljs-title function_">createMediaKeySystem</span>(solutionName);</li><li>      mediaKeySession = mediaKeySystem.<span class="hljs-title function_">createMediaKeySession</span>();</li><li>  }</li><li>  <span class="hljs-comment">// 媒体密钥请求与处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-drm-mediakeysession#generatemediakeyrequest" target="_blank">generateMediaKeyRequest</a>生成媒体密钥请求，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-drm-mediakeysession#processmediakeyresponse" target="_blank">processMediaKeyResponse</a>处理媒体密钥响应。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">initData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(drmInfoArr[i].<span class="hljs-property">pssh</span>);</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">optionsData</span>: drm.<span class="hljs-property">OptionsData</span>[] = [{</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">"optionalDataName"</span>,</li><li>  <span class="hljs-attr">value</span>: <span class="hljs-string">"optionalDataValue"</span></li><li>}]</li><li>mediaKeySession.<span class="hljs-title function_">generateMediaKeyRequest</span>(<span class="hljs-string">"video/mp4"</span>, initData, drm.<span class="hljs-property">MediaKeyType</span>.<span class="hljs-property">MEDIA_KEY_TYPE_ONLINE</span>, optionsData).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (licenseRequest) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"generateMediaKeyRequest success"</span>, licenseRequest.<span class="hljs-property">mediaKeyRequestType</span>, licenseRequest.<span class="hljs-property">data</span>, licenseRequest.<span class="hljs-property">defaultURL</span>);</li><li>  <span class="hljs-comment">// 将媒体密钥请求返回的licenseRequest.data通过网络请求发送给DRM服务获取媒体密钥响应，并处理。</span></li><li>  <span class="hljs-keyword">let</span> licenseResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]);</li><li>  mediaKeySession.<span class="hljs-title function_">processMediaKeyResponse</span>(licenseResponse).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">mediaKeyId: <span class="hljs-built_in">Uint8Array</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"processMediaKeyResponse success"</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err:BusinessError</span>) =&gt;</span>{</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"processMediaKeyResponse err end"</span>, err.<span class="hljs-property">code</span>);</li><li>  });</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err:BusinessError</span>) =&gt;</span>{</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"generateMediaKeyRequest err end"</span>, err.<span class="hljs-property">code</span>);</li><li>});</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-drm-mediakeysession#requiresecuredecodermodule" target="_blank">requireSecureDecoderModule</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setdecryptionconfig11" target="_blank">setDecryptionConfig</a>，在处理媒体密钥响应成功后设置解密session。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">svp</span>: <span class="hljs-built_in">boolean</span> = mediaKeySession.requireSecureDecoderModule(<span class="hljs-string">'video/avc'</span>);</li><li>playerHandle.<span class="hljs-title function_">setDecryptionConfig</span>(mediaKeySession, svp)</li></ol></pre></div></div></li>      <li>       <p>销毁AVPlayer实例并根据released事件监听销毁MediaKeySession和MediaKeySystem实例。</p>       <div _ngcontent-kql-c106="" class="highlight-div"><div _ngcontent-kql-c106="" class="highlight-div-header"><div _ngcontent-kql-c106="" class="highlight-div-header-left"><div _ngcontent-kql-c106="" class="handle-button expand-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kql-c106="" class="highlight-div-header-right"><div _ngcontent-kql-c106="" class="handle-button ai-button"></div><div _ngcontent-kql-c106="" class="handle-button line-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kql-c106="" class="handle-button theme-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kql-c106="" class="handle-button copy-button"><div _ngcontent-kql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kql-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>playerHandle.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">state</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">reason</span>: media.<span class="hljs-property">StateChangeReason</span>) =&gt; {</li><li>   <span class="hljs-keyword">if</span> (state == <span class="hljs-string">'released'</span>) {</li><li>      mediaKeySession.<span class="hljs-title function_">destroy</span>();</li><li>      mediaKeySystem.<span class="hljs-title function_">destroy</span>();</li><li>   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state == <span class="hljs-string">'releasing'</span>) {</li><li>      <span class="hljs-keyword">await</span> playerHandle.<span class="hljs-title function_">release</span>();</li><li>   }</li><li>})</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>