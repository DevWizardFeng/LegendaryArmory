<h1 _ngcontent-eay-c119="" class="doc-title ng-star-inserted" title="基于TracingConfiguration实现性能维测"> 基于TracingConfiguration实现性能维测 </h1>

<div _ngcontent-eay-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2>          <p>性能维测能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section2023916816502">捕获有关HTTP请求/响应流的详细信息<i class="anchor-icon anchor-icon-link" anchorid="section2023916816502" tips="复制节点链接"></i></h2>          <p>当需要进行性能维测时，可以采集应用中HTTP请求的详细跟踪信息时，利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section557714186379" target="_blank">TracingConfiguration</a>进行相关配置。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section557714186379" target="_blank">TracingConfiguration</a>中可以设置verbose（启用详细跟踪）、infoToCollect（配置要收集的特定类型的信息事件）、collectTimeInfo（在跟踪过程中是否应收集与时间相关的信息）、httpEventsHandler（为HTTP请求/响应过程中的特定操作定义响应处理程序的回调）四个参数。</p>    </div>    <p>下面将以获取HTTP请求/响应时的数据接收时、请求头接收时、数据传输完成时等详细信息为例，进行介绍。</p>    <ol>     <li><span>导入需要的模块，示例中包含了利用远场通信框架发起网络请求以及请求后的响应和错误处理，所以需导入以下模块。</span>      <p></p>      <div _ngcontent-eay-c106="" class="highlight-div"><div _ngcontent-eay-c106="" class="highlight-div-header"><div _ngcontent-eay-c106="" class="highlight-div-header-left"><div _ngcontent-eay-c106="" class="handle-button expand-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eay-c106="" class="highlight-div-header-right"><div _ngcontent-eay-c106="" class="handle-button ai-button"></div><div _ngcontent-eay-c106="" class="handle-button line-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eay-c106="" class="handle-button theme-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eay-c106="" class="handle-button copy-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eay-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>      <p></p></li>     <li><span>创建自定义响应处理程序，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section87603011401" target="_blank">HttpEventsHandler</a>中设置onDataReceive（当接收到HTTP响应正文的一部分时调用的回调）、onHeaderReceive（用于在响应期间处理接收到的headers的回调）、onDataEnd（数据传输完成时触发的回调）。</span>      <p></p>      <div _ngcontent-eay-c106="" class="highlight-div"><div _ngcontent-eay-c106="" class="highlight-div-header"><div _ngcontent-eay-c106="" class="highlight-div-header-left"><div _ngcontent-eay-c106="" class="handle-button expand-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eay-c106="" class="highlight-div-header-right"><div _ngcontent-eay-c106="" class="handle-button ai-button"></div><div _ngcontent-eay-c106="" class="handle-button line-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eay-c106="" class="handle-button theme-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eay-c106="" class="handle-button copy-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eay-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义自定义响应处理程序</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">customHttpEventsHandler</span>: rcp.<span class="hljs-property">HttpEventsHandler</span> = {</li><li>  <span class="hljs-attr">onDataReceive</span>: <span class="hljs-function">(<span class="hljs-params">incomingData: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 用于处理传入数据的自定义逻辑</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Received data:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(incomingData));</li><li>    <span class="hljs-keyword">return</span> incomingData.<span class="hljs-property">byteLength</span>;</li><li>  },</li><li>  <span class="hljs-attr">onHeaderReceive</span>: <span class="hljs-function">(<span class="hljs-params">headers: rcp.RequestHeaders</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 处理响应头的自定义逻辑</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Received headers:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(headers));</li><li>  },</li><li>  <span class="hljs-attr">onDataEnd</span>: <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 用于处理数据传输完成的自定义逻辑</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Data transfer complete'</span>);</li><li>  }</li><li>};</li></ol></pre></div></div>      <p></p></li>     <li><span>设置tracingConfig对象中的verbose为true，表示启用详细跟踪，设置tracingConfig对象中的infoToCollect对象中的incomingData为true（收集传入的数据信息事件）、outgoingData为true（收集传出的数据信息事件）、incomingHeader为true（收集传入的header信息事件）、outgoingHeader为true（收集传出的header信息事件）。</span>      <p></p>      <div _ngcontent-eay-c106="" class="highlight-div"><div _ngcontent-eay-c106="" class="highlight-div-header"><div _ngcontent-eay-c106="" class="highlight-div-header-left"><div _ngcontent-eay-c106="" class="handle-button expand-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eay-c106="" class="highlight-div-header-right"><div _ngcontent-eay-c106="" class="handle-button ai-button"></div><div _ngcontent-eay-c106="" class="handle-button line-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eay-c106="" class="handle-button theme-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eay-c106="" class="handle-button copy-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eay-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置跟踪设置</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">tracingConfig</span>: rcp.<span class="hljs-property">TracingConfiguration</span> = {</li><li>  <span class="hljs-attr">verbose</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">infoToCollect</span>: {</li><li>    <span class="hljs-attr">incomingHeader</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 收集传入的header信息事件</span></li><li>    <span class="hljs-attr">outgoingHeader</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 收集传入的header信息事件</span></li><li>    <span class="hljs-attr">incomingData</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 收集传入数据信息事件</span></li><li>    <span class="hljs-attr">outgoingData</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 收集传出数据信息事件</span></li><li>  },</li><li>  <span class="hljs-attr">collectTimeInfo</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">httpEventsHandler</span>: customHttpEventsHandler</li><li>};</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">securityConfig</span>: rcp.<span class="hljs-property">SecurityConfiguration</span> = {</li><li>  <span class="hljs-attr">tlsOptions</span>: {</li><li>    <span class="hljs-attr">tlsVersion</span>: <span class="hljs-string">'TlsV1.3'</span></li><li>  }</li><li>};</li></ol></pre></div></div>      <p></p></li>     <li><span>调用rcp.createSession()传入tracingConfig ，创建通信会话对象session。</span>      <p></p>      <div _ngcontent-eay-c106="" class="highlight-div"><div _ngcontent-eay-c106="" class="highlight-div-header"><div _ngcontent-eay-c106="" class="highlight-div-header-left"><div _ngcontent-eay-c106="" class="handle-button expand-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eay-c106="" class="highlight-div-header-right"><div _ngcontent-eay-c106="" class="handle-button ai-button"></div><div _ngcontent-eay-c106="" class="handle-button line-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eay-c106="" class="handle-button theme-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eay-c106="" class="handle-button copy-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eay-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建通信会话对象，并传入相关配置</span></li><li><span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>({ <span class="hljs-attr">requestConfiguration</span>: { <span class="hljs-attr">tracing</span>: tracingConfig, <span class="hljs-attr">security</span>: securityConfig } });</li><li>session.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://developer.huawei.com'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Request succeeded, message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(response)}</span>`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`err: err code is <span class="hljs-subst">${err.code}</span>, err message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>});</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h2 id="section143821143125014">HTTP请求过程中各时间点详解<i class="anchor-icon anchor-icon-link" anchorid="section143821143125014" tips="复制节点链接"></i></h2>          <p>在实施性能维测的过程中，HTTP请求的各个时间点至关重要。借助TimeInfo提供的详细字段，可以精准控制请求过程，无论是直接利用这些字段，还是通过它们之间的运算，都能准确获取所需的时间点，从而提升测试效率。</p>    </div>    <p>下面，我们将通过图片、时间线及一段示例代码，详细解析请求过程中的关键时间点。</p>    <p><span><img height="443.373721" originheight="1238" originwidth="1802" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115032.40910285487780564500403345081301:50001231000000:2800:E23EAAD924EF072ED6C8F577651496A9E6E8F683DC9313EE172B4575BF29917E.png" title="点击放大" width="645.3825"></span></p>    <p>从图中可以看到HTTP请求过程的基本过程，并且有一些关键的时间点，下面将以时间线的方式对其进行说明：</p>    <div class="tiledSection">     <h3 id="section1399813266512" class="firsth2">TimeInfo时间线<i class="anchor-icon anchor-icon-link" anchorid="section1399813266512" tips="复制节点链接"></i></h3>          <p>请求开始 （0时刻） -&gt; nameLookupTimeMs（DNS解析）-&gt; connectTimeMs（建立连接）-&gt; tlsHandshakeTimeMs（TLS握手）-&gt; preTransferTimeMs（请求业务数据发送到服务器的时间点） -&gt; startTransferTimeMs（从服务器接收到首包数据的时间点）。</p>    </div>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>各时间节点所显示的时间均相对于0时刻，即从0时刻开始计时的时间。例如tlsHandshakeTimeMs为150.1ms，指从发起请求时间0开始，直到TLS握手结束所花费的时间为150.1ms。</p>      <p>网络请求过程中关键节点时间计算方法：</p>      <ul>       <li>首包耗时：startTransferTimeMs - preTransferTimeMs</li>       <li>TLS握手（不包含建连时间）耗时：tlsHandshakeTimeMs - connectTimeMs</li>       <li>接收剩余数据的耗时：totalTimeMs - startTransferTimeMs</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h3 id="section13770933164618">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section13770933164618" tips="复制节点链接"></i></h3>          <p>这段代码在使用过程中会将上述说明中三个比较关键的时间点打印出来，开发者可以根据获取到的时间对应用性能实现动态调整，获取最佳体验。</p>     <div _ngcontent-eay-c106="" class="highlight-div"><div _ngcontent-eay-c106="" class="highlight-div-header"><div _ngcontent-eay-c106="" class="highlight-div-header-left"><div _ngcontent-eay-c106="" class="handle-button expand-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eay-c106="" class="highlight-div-header-right"><div _ngcontent-eay-c106="" class="handle-button ai-button"></div><div _ngcontent-eay-c106="" class="handle-button line-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eay-c106="" class="handle-button theme-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eay-c106="" class="handle-button copy-button"><div _ngcontent-eay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eay-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 1、创建session、requestURL </span></li><li><span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li><span class="hljs-keyword">const</span> requestURL = <span class="hljs-string">"https://www.example.com"</span>;</li><li>
</li><li><span class="hljs-comment">// 2、在需要跟踪分析请求过程中各个时间段消耗的时间，请将此开关打开</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">configuration</span>: rcp.<span class="hljs-property">Configuration</span> = {</li><li>  <span class="hljs-attr">tracing</span>: {</li><li>    <span class="hljs-attr">collectTimeInfo</span>: <span class="hljs-literal">true</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 3、创建请求</span></li><li><span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">Request</span>(requestURL, <span class="hljs-string">"GET"</span>);</li><li>request.<span class="hljs-property">configuration</span> = configuration;</li><li>
</li><li><span class="hljs-comment">// 4、使用fetch发起网络请求，request中携带上面配置好的configuration</span></li><li>session.<span class="hljs-title function_">fetch</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: rcp.Response</span>) =&gt;</span> {</li><li><span class="hljs-comment">// 由于timeInfo中各个参数有可能为undefined，所以需要在两个时间段做运算前添加判空操作</span></li><li>  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">timeInfo</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`timeInfo is undefined <span class="hljs-subst">${response.timeInfo}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> remainderDataTime = response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">totalTimeMs</span> - response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">startTransferTimeMs</span>;</li><li>  <span class="hljs-keyword">let</span> firstPackageTime = response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">startTransferTimeMs</span> - response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">preTransferTimeMs</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">TLSTime</span> = response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">tlsHandshakeTimeMs</span> - response.<span class="hljs-property">timeInfo</span>?.<span class="hljs-property">connectTimeMs</span>;</li><li>  </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`首包耗时<span class="hljs-subst">${firstPackageTime}</span>`</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`TLS握手（不包含建连时间）耗时<span class="hljs-subst">${TLSTime}</span>`</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`接收剩余数据的耗时<span class="hljs-subst">${remainderDataTime}</span>`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Response err, the err is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>})</li></ol></pre></div></div>    </div>   </div>   <div></div></div>