<h1 _ngcontent-sab-c119="" class="doc-title ng-star-inserted" title="基于服务账号生成鉴权令牌"> 基于服务账号生成鉴权令牌 </h1>

<div _ngcontent-sab-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section4780149123414">概述<i class="anchor-icon anchor-icon-link" anchorid="section4780149123414" tips="复制节点链接"></i></h2>          <p>服务账号（Service Account）是一种可实现服务器与服务器之间接口鉴权的账号，在华为开发者联盟的<a href="https://developer.huawei.com/consumer/cn/console/api/myApi" target="_blank">API Console</a>上创建服务账号，您可根据返回的公私钥在业务应用中生成鉴权令牌，调用支持此类鉴权的华为公开API。</p>     <p>服务账号令牌为JWT（JSON Web Token）格式字符串，JWT数据格式包括三个部分：</p>     <ul>      <li>Header（头部）</li>      <li>Payload（负载）</li>      <li>Signature（签名）</li>     </ul>     <p>这三个部分通过“.”进行连接，其中Signature为通过SHA256withRSA/PSS算法对Header与Payload拼接的字符串签名生成的字符串。</p>     <p><strong>示例</strong></p>     <div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li>eyJra*****JjNjBjMXXX.</li><li>eyJhd*****JodHRXXX.</li><li>BRNss*****<span class="hljs-number">7</span>az5oU7-Zp<span class="">5</span>g<span class="">9</span>X<span class="">2</span>WJVXXX</li></ol></pre></div></div>     <p>更多JWT的相关知识请参见<a href="https://jwt.io/introduction/" target="_blank">Introduction to JSON Web Tokens</a>。</p>    </div>    <div class="tiledSection">     <h2 id="section16173145352">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section16173145352" tips="复制节点链接"></i></h2>          <ol>      <li><span>创建服务账号密钥文件。</span>       <p></p>       <p>您需要在华为开发者联盟的<a href="https://developer.huawei.com/consumer/cn/console/api/myApi" target="_blank">API Console</a>上创建并下载推送服务API的服务账号密钥文件，凭证创建入口如下图所示，选择所在项目，创建“服务账号密钥“凭证。相关创建步骤请参见<a href="https://developer.huawei.com/consumer/cn/doc/start/api-0000001062522591#section3554194116341" target="_blank">API服务操作指南-服务账号密钥</a>。</p>       <p><span><img height="281.96532" originheight="698" originwidth="1889" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114551.81641997674100848813726934954783:50001231000000:2800:80C3FA96C75C6B726377130FBD5A8F2A2FFF64FB31C8F54FD6E2010EBC96DADF.png" title="点击放大" width="763.0715400000001"></span></p>       <p></p>       <p>您申请后的服务账号密钥样例文件形式可参考（文件内容已经经过脱敏处理）：</p>       <div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"project_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*****"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"key_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*****"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"private_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-----BEGIN PRIVATE KEY-----\nMIIJQgIBADANBgkqhkiG9w0BAQEFAASCCSwwggkoAgEAAoICAQCKw6kJKtCh7qmMvp1u1dI27z2TKZrPOzHbQaXO/Eez0AWZ2EN+ouF496R3pfo7fQXC1XOT/YTbVC4DNZwWSMA54fu3/AOCY9Zzyi46OK*****==\n-----END PRIVATE KEY-----\n"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"sub_account"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*****"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"auth_uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/authorize"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"token_uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/token"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"auth_provider_cert_uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/certs"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"client_cert_uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/x509?client_id="</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>       <p></p></li>      <li><span>请确认以上密钥文件中的project_id是否与您的应用所属项目一致。</span>       <p></p>       <p>您的应用所属项目ID查看方法：登录<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>网站，选择“开发与服务”，在项目列表中选择对应的项目，左侧导航栏选择“项目设置”，在该页面获取。</p>       <p><span><img height="231.130725" originheight="482" originwidth="1893" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114551.18995695572475605916965347214785:50001231000000:2800:7CA172B8402312A3546258DE3FAA6DF6D7239951DAFFCC3ED923E79A3EE004F2.png" title="点击放大" width="907.725"></span></p>       <p></p>       <p></p></li>      <li><span>生成JWT Header数据。</span>       <p></p>       <p>根据服务账号密钥文件中的key_id（对应示例中的kid）字段拼接以下JSON体，对JSON体进行BASE64编码。</p>       <p>示例</p>       <div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li><span class="">  <span class="hljs-attr">"kid"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-string">"*****"</span></span><span class="hljs-punctuation">,</span></li><li><span class="">  <span class="hljs-attr">"typ"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-string">"JWT"</span></span><span class="hljs-punctuation">,</span></li><li><span class="">  <span class="hljs-attr">"alg"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-string">"PS256"</span></span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.2.2.3.2.4.1.3.1.1" valign="top" width="24.27%">            <p>字段名</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.2.2.3.2.4.1.3.1.2" valign="top" width="75.73%">            <p>描述</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>kid</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>服务账号密钥文件中key_id字段。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>typ</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>数据类型，固定为：JWT。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>alg</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>算法类型，固定为：PS256。</p></td>          </tr>                 </tbody></table></div>       </div>       <p></p></li>      <li><span>生成JWT Payload数据。</span>       <p></p>       <p>根据服务账号密钥文件中的sub_account（对应示例中的iss）字段拼接以下JSON体，对JSON体进行BASE64编码。</p>       <p><strong>示例</strong></p>       <div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li><span class="">  <span class="hljs-attr">"aud"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/token"</span></span><span class="hljs-punctuation">,</span></li><li><span class="">  <span class="hljs-attr">"iss"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-string">"*****"</span></span><span class="hljs-punctuation">,</span></li><li><span class="">  <span class="hljs-attr">"exp"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-number">1581410664</span></span><span class="hljs-punctuation">,</span></li><li><span class="">  <span class="hljs-attr">"iat"</span></span><span class="hljs-punctuation">:</span> <span class=""><span class="hljs-number">1581407064</span></span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.2.2.4.2.4.1.3.1.1" valign="top" width="24.27%">            <p>字段名</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.2.2.4.2.4.1.3.1.2" valign="top" width="75.73%">            <p>描述</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>iss</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>服务账号密钥文件中sub_account字段，标识数据生成者。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>aud</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>固定为：https://oauth-login.cloud.huawei.com/oauth2/v3/token。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>iat</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>JWT签发UTC时间戳，为自UTC时间1970年1月1日00:00:00起的秒数（您的服务器时间需要校准为标准时间）。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.27%">            <p>exp</p></td>           <td class="cellrowborder" valign="top" width="75.73%">            <p>JWT到期UTC时间戳，比iat晚3600秒。</p></td>          </tr>                 </tbody></table></div>       </div>       <p></p></li>      <li><span>生成JWT Token。</span>       <p></p>       <p>将完成BASE64编码后的Header字符串与Payload字符串，通过“.”进行连接，您可在业务应用中，通过服务账号密钥文件中的private_key（华为不进行存储，请您妥善保管），使用SHA256withRSA/PSS算法对拼接的字符串签名。</p>       <p>至此，您已经完成服务账号鉴权令牌JWT Token的生成。</p>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section33041381718">调用推送服务REST API<i class="anchor-icon anchor-icon-link" anchorid="section33041381718" tips="复制节点链接"></i></h2>          <p>您的应用调用推送服务REST API时，需要把已获得的服务账号鉴权令牌放在Authorization头部来进行鉴权。请使用v3版本调用推送服务REST API。</p>     <p><strong>示例</strong></p>     <div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li>POST <span class="hljs-string">"https://push-api.cloud.huawei.com/v3/3158882***52863/messages:send"</span></li><li>Authorization<span class="hljs-punctuation">:</span> Bearer eyJr*****OiIx---****.eyJh*****iJodHR--***.QRod*****<span class="hljs-number">4</span>Gp---****</li><li>push-type<span class="hljs-punctuation">:</span><span class="hljs-number">0</span></li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>Authorization格式：Bearer后面拼接空格，再拼接获取的鉴权信息。</p>       <p>接口版本：请使用V3版本调用推送服务REST API。</p>       <p>场景化消息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-struct" target="_blank">请求体</a>中，接口URL版本为V3（https://push-api.cloud.huawei.com/v3/[projectId]/messages:send）时，仅支持给HarmonyOS Next/5.x及之后的系统版本推送通知；接口URL版本为V2（https://push-api.cloud.huawei.com/v2/[projectId]/messages:send）时，仅支持给HarmonyOS 3.x/4.x的系统版本推送通知。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section1910053451218">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1910053451218" tips="复制节点链接"></i></h2>          <p>为了方便您生成服务账号鉴权令牌，我们提供了Java语言的示例代码，请按照说明替换参数运行。</p>     <p>如果您使用其他开发语言，请选择对应的<a href="https://jwt.io/libraries" target="_blank">JWT开源组件</a>进行开发。</p>     <p>其中鉴权令牌生成步骤如下：</p>     <ol>      <li><span>完成上述<a href="/consumer/cn/doc/harmonyos-guides/push-jwt-token#section16173145352">开发步骤</a>中的步骤1创建服务账号密钥文件后，从华为开发者联盟的<a href="https://developer.huawei.com/consumer/cn/console/api/myApi" target="_blank">API Console</a>上创建并下载推送服务API的服务账号密钥文件（.json文件），格式如下：</span>       <p></p>       <p><span><img originheight="221" originwidth="542" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114551.82492261282002481683098022191011:50001231000000:2800:2862E719DD6F015A82A5072CE95D5B6D9387614139875B390693B5D9076077BE.png" width="542" height="221"></span></p>       <p></p></li>      <li><span>以上json文件复制至工程中，参考如下代码进行解析（以private.json为例）。</span></li>     </ol>     <div class="p">                                   <div class="switchPre"><div class="preTab preTab-cn"><div class="activePre" switchpre-data="0" switchpre-lang="Java">Java</div><div switchpre-data="1" switchpre-lang="Node.js">Node.js</div><div switchpre-data="2" switchpre-lang="Go">Go</div><div switchpre-data="3" switchpre-lang="Python">Python</div><div switchpre-data="4" switchpre-lang="PHP">PHP</div></div><div class="switchPreBox"><div class="prebox"><div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/* 推荐的java版本为java8，maven依赖如下：</span></li><li><span class="hljs-comment">  &lt;dependency&gt;</span></li><li><span class="hljs-comment">   &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span></li><li><span class="hljs-comment">   &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span></li><li><span class="hljs-comment">   &lt;version&gt;2.16.2&lt;/version&gt;</span></li><li><span class="hljs-comment">  &lt;/dependency&gt;</span></li><li><span class="hljs-comment">  &lt;dependency&gt;</span></li><li><span class="hljs-comment">   &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span></li><li><span class="hljs-comment">   &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;</span></li><li><span class="hljs-comment">   &lt;version&gt;0.11.5&lt;/version&gt;</span></li><li><span class="hljs-comment">  &lt;/dependency&gt;</span></li><li><span class="hljs-comment">  &lt;dependency&gt;</span></li><li><span class="hljs-comment">   &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span></li><li><span class="hljs-comment">   &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;</span></li><li><span class="hljs-comment">   &lt;version&gt;0.11.5&lt;/version&gt;</span></li><li><span class="hljs-comment">   &lt;scope&gt;runtime&lt;/scope&gt;</span></li><li><span class="hljs-comment">  &lt;/dependency&gt;</span></li><li><span class="hljs-comment">  &lt;dependency&gt;</span></li><li><span class="hljs-comment">   &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span></li><li><span class="hljs-comment">   &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt;</span></li><li><span class="hljs-comment">   &lt;version&gt;0.11.5&lt;/version&gt;</span></li><li><span class="hljs-comment">   &lt;scope&gt;runtime&lt;/scope&gt;</span></li><li><span class="hljs-comment">  &lt;/dependency&gt;</span></li><li><span class="hljs-comment">  &lt;dependency&gt;</span></li><li><span class="hljs-comment">   &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;</span></li><li><span class="hljs-comment">   &lt;artifactId&gt;bcprov-jdk18on&lt;/artifactId&gt;</span></li><li><span class="hljs-comment">   &lt;version&gt;1.78.1&lt;/version&gt;</span></li><li><span class="hljs-comment">   &lt;scope&gt;runtime&lt;/scope&gt;</span></li><li><span class="hljs-comment">  &lt;/dependency&gt;</span></li><li><span class="hljs-comment">*/</span></li><li>
</li><li><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</li><li><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</li><li>
</li><li><span class="hljs-keyword">import</span> io.jsonwebtoken.*;</li><li><span class="hljs-keyword">import</span> io.jsonwebtoken.lang.Maps;</li><li>
</li><li><span class="hljs-keyword">import</span> java.io.File;</li><li><span class="hljs-keyword">import</span> java.io.IOException;</li><li><span class="hljs-keyword">import</span> java.net.URL;</li><li><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;</li><li><span class="hljs-keyword">import</span> java.security.KeyFactory;</li><li><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;</li><li><span class="hljs-keyword">import</span> java.security.PrivateKey;</li><li><span class="hljs-keyword">import</span> java.security.interfaces.RSAPrivateKey;</li><li><span class="hljs-keyword">import</span> java.security.spec.InvalidKeySpecException;</li><li><span class="hljs-keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;</li><li><span class="hljs-keyword">import</span> java.util.Base64;</li><li><span class="hljs-keyword">import</span> java.util.Map;</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonWebTokenFactory</span> {</li><li>
</li><li>    <span class="hljs-comment">// 实际开发时请将公网地址存储在配置文件或数据库</span></li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/token"</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createJwt</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, InvalidKeySpecException, IOException, NullPointerException {</li><li>        <span class="hljs-comment">// 读取配置文件</span></li><li>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();</li><li>        <span class="hljs-comment">// 上述private.json文件放置于工程的src/main/resources路径下</span></li><li>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> JsonWebTokenFactory.class.getClassLoader().getResource(<span class="hljs-string">"private.json"</span>);</li><li>        <span class="hljs-keyword">if</span> (url == <span class="hljs-literal">null</span>) {</li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"File not exist"</span>);</li><li>        }</li><li>        <span class="hljs-type">JsonNode</span> <span class="hljs-variable">rootNode</span> <span class="hljs-operator">=</span> mapper.readTree(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(url.getPath()));</li><li>
</li><li>        <span class="hljs-type">RSAPrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> (RSAPrivateKey) generatePrivateKey(rootNode.get(<span class="hljs-string">"private_key"</span>).asText()</li><li>                .replace(<span class="hljs-string">"-----BEGIN PRIVATE KEY-----"</span>, <span class="hljs-string">""</span>)</li><li>                .replace(<span class="hljs-string">"-----END PRIVATE KEY-----"</span>, <span class="hljs-string">""</span>)</li><li>                .replaceAll(<span class="hljs-string">"\\s"</span>, <span class="hljs-string">""</span>));</li><li>        <span class="hljs-type">long</span> <span class="hljs-variable">iat</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;</li><li>        <span class="hljs-type">long</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> iat + <span class="hljs-number">3600</span>;</li><li>
</li><li>        Map&lt;String, Object&gt; header = Maps.&lt;String, Object&gt;of(JwsHeader.KEY_ID, rootNode.get(<span class="hljs-string">"key_id"</span>).asText())</li><li>                .and(JwsHeader.TYPE, JwsHeader.JWT_TYPE)</li><li>                .and(JwsHeader.ALGORITHM, SignatureAlgorithm.PS256.getValue())</li><li>                .build();</li><li>
</li><li>        Map&lt;String, Object&gt; payload = Maps.&lt;String, Object&gt;of(Claims.ISSUER, rootNode.get(<span class="hljs-string">"sub_account"</span>).asText())</li><li>                .and(Claims.ISSUED_AT, iat)</li><li>                .and(Claims.EXPIRATION, exp)</li><li>                .and(Claims.AUDIENCE, AUD)</li><li>                .build();</li><li>
</li><li>        <span class="hljs-keyword">return</span> Jwts.builder()</li><li>                .setHeader(header)</li><li>                .setPayload(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(payload))</li><li>                .signWith(privateKey, SignatureAlgorithm.PS256)</li><li>                .compact();</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> PrivateKey <span class="hljs-title function_">generatePrivateKey</span><span class="hljs-params">(String base64Key)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, InvalidKeySpecException {</li><li>        <span class="hljs-type">PKCS8EncodedKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS8EncodedKeySpec</span>(Base64.getDecoder().decode(base64Key.getBytes(StandardCharsets.UTF_8)));</li><li>        <span class="hljs-type">KeyFactory</span> <span class="hljs-variable">keyFactory</span> <span class="hljs-operator">=</span> KeyFactory.getInstance(<span class="hljs-string">"RSA"</span>);</li><li>        <span class="hljs-keyword">return</span> keyFactory.generatePrivate(keySpec);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 获取鉴权令牌</span></li><li>            <span class="hljs-type">String</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> createJwt();</li><li>        } <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException e) {</li><li>            <span class="hljs-comment">// 异常处理流程1</span></li><li>        } <span class="hljs-keyword">catch</span> (InvalidKeySpecException e) {</li><li>            <span class="hljs-comment">// 异常处理流程2</span></li><li>        } <span class="hljs-keyword">catch</span> (IOException e) {</li><li>            <span class="hljs-comment">// 异常处理流程3</span></li><li>        } <span class="hljs-keyword">catch</span> (NullPointerException e) {</li><li>            <span class="hljs-comment">// 异常处理流程4</span></li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// 依赖：npm i jsonwebtoken</span></span></li><li><span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">jwt</span></span> <span class="">=</span> <span class=""><span class="hljs-title function_">require</span></span>(<span class=""><span class="hljs-string">'jsonwebtoken'</span></span>);</li><li><span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">fs</span></span> <span class="">=</span> <span class=""><span class="hljs-title function_">require</span></span>(<span class=""><span class="hljs-string">'fs'</span></span>);</li><li><span class=""><span class="hljs-keyword">let</span></span> <span class=""><span class="hljs-variable">privateJson</span></span>;</li><li><span class=""><span class="hljs-keyword">try</span></span> {</li><li>  <span class=""><span class="hljs-comment">// readFileSync首个参数修改为</span></span><span class="hljs-comment">private.json的实际路径</span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">data</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">fs</span></span>.<span class=""><span class="hljs-title function_">readFileSync</span></span>(<span class=""><span class="hljs-string">'private.json'</span></span>, <span class=""><span class="hljs-string">'utf8'</span></span>);</li><li>  <span class=""><span class="hljs-variable">privateJson</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">JSON</span></span>.<span class=""><span class="hljs-title function_">parse</span></span>(<span class=""><span class="hljs-variable">data</span></span>);</li><li>  <span class=""><span class="hljs-comment">// 自定义Header</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">header</span></span> <span class="">=</span> {</li><li>    <span class=""><span class="hljs-variable">alg</span></span><span class="">:</span> <span class=""><span class="hljs-string">'PS256'</span></span>, <span class=""><span class="hljs-comment">// 建议使用PS256算法</span></span></li><li>    <span class=""><span class="hljs-variable">kid</span></span><span class="">:</span> <span class=""><span class="hljs-title class_">privateJson</span></span>?.<span class=""><span class="hljs-title class_">key_id</span></span>,</li><li>    <span class=""><span class="hljs-variable">typ</span></span><span class="">:</span> <span class=""><span class="hljs-string">'JWT'</span></span>    <span class=""><span class="hljs-comment">// 类型为JWT</span></span></li><li>  };</li><li>  <span class=""><span class="hljs-comment">// 创建JWT载荷</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">payload</span></span> <span class="">=</span> {</li><li>    <span class=""><span class="hljs-variable">iss</span></span><span class="">:</span> <span class=""><span class="hljs-title class_">privateJson</span></span>?.<span class=""><span class="hljs-title class_">sub_account</span></span>,</li><li>    <span class=""><span class="hljs-variable">aud</span></span><span class="">:</span> <span class=""><span class="hljs-string">'https://oauth-login.cloud.huawei.com/oauth2/v3/token'</span></span>, <span class=""><span class="hljs-comment">// 实际开发时请将公网地址存储在配置文件或数据库</span></span></li><li>    <span class=""><span class="hljs-variable">iat</span></span><span class="">:</span> <span class=""><span class="hljs-title class_">Math</span></span>.<span class=""><span class="hljs-title class_">floor</span></span>(<span class=""><span class="hljs-title class_">Date</span></span>.<span class=""><span class="hljs-title class_">now</span></span>() <span class="">/</span> <span class=""><span class="hljs-number">1000</span></span>),</li><li>    <span class=""><span class="hljs-variable">exp</span></span><span class="">:</span> <span class=""><span class="hljs-title class_">Math</span></span>.<span class=""><span class="hljs-title class_">floor</span></span>(<span class=""><span class="hljs-title class_">Date</span></span>.<span class=""><span class="hljs-title class_">now</span></span>() <span class="">/</span> <span class=""><span class="hljs-number">1000</span></span>) <span class="">+</span> <span class=""><span class="hljs-number">3600</span></span></li><li>  };</li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">private_key</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">privateJson</span></span>?.<span class=""><span class="hljs-variable">private_key</span></span>;</li><li>  <span class=""><span class="hljs-comment">// 将字符串中的 \\n 替换成真正的换行符 \n，再按换行符分割为数组</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">lines</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">private_key</span></span>.<span class=""><span class="hljs-title function_">replace</span></span>(<span class="">/</span><span class="">\\</span><span class=""><span class="hljs-variable">n</span>/</span><span class=""><span class="hljs-variable">g</span></span>, <span class=""><span class="hljs-string">'</span></span><span class=""><span class="hljs-string">\n</span></span><span class=""><span class="hljs-string">'</span></span>).<span class=""><span class="hljs-title function_">split</span></span>(<span class=""><span class="hljs-string">'</span></span><span class=""><span class="hljs-string">\n</span></span><span class=""><span class="hljs-string">'</span></span>);</li><li>  <span class=""><span class="hljs-comment">// 取前三行</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">firstThreeLines</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">lines</span></span>.<span class=""><span class="hljs-title function_">slice</span></span>(<span class=""><span class="hljs-number">0</span></span>, <span class=""><span class="hljs-number">3</span></span>);</li><li>  <span class=""><span class="hljs-comment">// 重新拼接成一个三行的字符串：</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">PRIVATE_KEY</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">firstThreeLines</span></span>.<span class=""><span class="hljs-title function_">join</span></span>(<span class=""><span class="hljs-string">'</span></span><span class=""><span class="hljs-string">\n</span></span><span class=""><span class="hljs-string">'</span></span>);</li><li>  <span class=""><span class="hljs-comment">// 获取鉴权令牌</span></span></li><li>  <span class=""><span class="hljs-keyword">const</span></span> <span class=""><span class="hljs-variable">token</span></span> <span class="">=</span> <span class=""><span class="hljs-variable">jwt</span></span>.<span class=""><span class="hljs-title function_">sign</span></span>(<span class=""><span class="hljs-variable">payload</span></span>, <span class=""><span class="hljs-variable">PRIVATE_KEY</span></span>, { <span class=""><span class="hljs-variable">algorithm</span></span><span class="">:</span> <span class=""><span class="hljs-string">'PS256'</span></span>, <span class=""><span class="hljs-variable">header</span></span><span class="">:</span> <span class=""><span class="hljs-title class_">header</span></span> });</li><li>} <span class=""><span class="hljs-keyword">catch</span></span> (<span class=""><span class="hljs-variable">error</span></span>) {</li><li>  <span class=""><span class="hljs-variable">console</span></span>.<span class=""><span class="hljs-title function_">error</span></span>(<span class=""><span class="hljs-string">"处理文件时出错:"</span></span>, <span class=""><span class="hljs-variable">error</span></span>);</li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-go" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 依赖：go get github.com/golang-jwt/jwt/v5</span></li><li>
</li><li><span class="hljs-keyword">package</span> main</li><li>
</li><li><span class="hljs-keyword">import</span> (</li><li>    <span class="hljs-string">"encoding/json"</span></li><li>    <span class="hljs-string">"encoding/pem"</span></li><li>    <span class="hljs-string">"errors"</span></li><li>    <span class="hljs-string">"fmt"</span></li><li>    <span class="hljs-string">"github.com/golang-jwt/jwt/v5"</span></li><li>    <span class="hljs-string">"log"</span></li><li>    <span class="hljs-string">"os"</span></li><li>    <span class="hljs-string">"strings"</span></li><li>    <span class="hljs-string">"time"</span></li><li>)</li><li>
</li><li><span class="hljs-keyword">type</span> ServiceAccountKey <span class="hljs-keyword">struct</span> {</li><li>    KeyID      <span class="hljs-type">string</span> <span class="hljs-string">`json:"key_id"`</span></li><li>    SubAccount <span class="hljs-type">string</span> <span class="hljs-string">`json:"sub_account"`</span></li><li>    PrivateKey <span class="hljs-type">string</span> <span class="hljs-string">`json:"private_key"`</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</li><li>    <span class="hljs-comment">// 替换为实际JSON文件路径，此处以本文件同级目录为例</span></li><li>    signedToken, err := generateJWTToken(<span class="hljs-string">"private.json"</span>)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        log.Fatalf(<span class="hljs-string">"Failed to generate JWT token: %v"</span>, err)</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// signedToken为鉴权令牌，调用推送服务REST API时放在Authorization头部来进行鉴权。</span></li><li>    sendMessage(signedToken)</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(token <span class="hljs-type">string</span>)</span></span> {</li><li>    <span class="hljs-comment">// 自行实现业务流程</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateJWTToken</span><span class="hljs-params">(keyFile <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {</li><li>    saKey, err := loadServiceAccountKey(keyFile)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err</li><li>    }</li><li>
</li><li>    formattedPrivateKey, err := formatPrivateKey(saKey.PrivateKey)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err</li><li>    }</li><li>
</li><li>    privateKey, err := jwt.ParseRSAPrivateKeyFromPEM([]<span class="hljs-type">byte</span>(formattedPrivateKey))</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(<span class="hljs-string">"failed to parse private key: %w"</span>, err)</li><li>    }</li><li>
</li><li>    token, err := buildJWTToken(saKey.KeyID, saKey.SubAccount)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> token.SignedString(privateKey)</li><li>}</li><li>
</li><li><span class="hljs-comment">// buildJWTToken 构造 JWT token 对象</span></li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildJWTToken</span><span class="hljs-params">(keyID, subAccount <span class="hljs-type">string</span>)</span></span> (*jwt.Token, <span class="hljs-type">error</span>) {</li><li>    now := time.Now().UTC()</li><li>    iat := now.Unix()</li><li>    exp := iat + <span class="hljs-number">3600</span> <span class="hljs-comment">// token 过期时间：一小时后</span></li><li>
</li><li>    claims := jwt.MapClaims{</li><li>        <span class="hljs-comment">// 实际开发时请将公网地址存储在配置文件或数据库</span></li><li>        <span class="hljs-string">"aud"</span>: <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/token"</span>,</li><li>        <span class="hljs-string">"iss"</span>: subAccount,</li><li>        <span class="hljs-string">"exp"</span>: exp,</li><li>        <span class="hljs-string">"iat"</span>: iat,</li><li>    }</li><li>
</li><li>    token := jwt.NewWithClaims(jwt.SigningMethodPS256, claims)</li><li>
</li><li>    <span class="hljs-comment">// 设置 header</span></li><li>    token.Header[<span class="hljs-string">"kid"</span>] = keyID</li><li>    token.Header[<span class="hljs-string">"typ"</span>] = <span class="hljs-string">"JWT"</span></li><li>    token.Header[<span class="hljs-string">"alg"</span>] = <span class="hljs-string">"PS256"</span></li><li>
</li><li>    <span class="hljs-keyword">return</span> token, <span class="hljs-literal">nil</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// loadServiceAccountKey 从 JSON 文件加载服务账号密钥</span></li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">loadServiceAccountKey</span><span class="hljs-params">(filename <span class="hljs-type">string</span>)</span></span> (*ServiceAccountKey, <span class="hljs-type">error</span>) {</li><li>    data, err := os.ReadFile(filename)</li><li>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"failed to read key file: %w"</span>, err)</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">var</span> saKey ServiceAccountKey</li><li>    <span class="hljs-keyword">if</span> err := json.Unmarshal(data, &amp;saKey); err != <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"failed to parse key file: %w"</span>, err)</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> saKey.KeyID == <span class="hljs-string">""</span> || saKey.SubAccount == <span class="hljs-string">""</span> || saKey.PrivateKey == <span class="hljs-string">""</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"invalid service account key file: missing required fields"</span>)</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> &amp;saKey, <span class="hljs-literal">nil</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// formatPrivateKey 格式化私钥字符串为 PEM 格式</span></li><li><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">formatPrivateKey</span><span class="hljs-params">(privateKeyStr <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {</li><li>    trimmed := strings.TrimSpace(privateKeyStr)</li><li>
</li><li>    <span class="hljs-comment">// 如果已经是 PEM 格式，则直接返回</span></li><li>    <span class="hljs-keyword">if</span> strings.HasPrefix(trimmed, <span class="hljs-string">"-----BEGIN PRIVATE KEY-----"</span>) &amp;&amp;</li><li>        strings.HasSuffix(trimmed, <span class="hljs-string">"-----END PRIVATE KEY-----"</span>) {</li><li>        <span class="hljs-keyword">return</span> trimmed, <span class="hljs-literal">nil</span></li><li>    }</li><li>
</li><li>    block, _ := pem.Decode([]<span class="hljs-type">byte</span>(trimmed))</li><li>    <span class="hljs-keyword">if</span> block == <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, errors.New(<span class="hljs-string">"failed to decode PEM block"</span>)</li><li>    }</li><li>
</li><li>    pemBytes := pem.EncodeToMemory(block)</li><li>    <span class="hljs-keyword">if</span> pemBytes == <span class="hljs-literal">nil</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, errors.New(<span class="hljs-string">"failed to encode private key to PEM format"</span>)</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(pemBytes), <span class="hljs-literal">nil</span></li><li>}</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># 依赖：pip install PyJWT cryptography</span></li><li>
</li><li><span class="hljs-keyword">import</span> jwt</li><li><span class="hljs-keyword">import</span> json</li><li><span class="hljs-keyword">import</span> time</li><li><span class="hljs-keyword">from</span> cryptography.hazmat.primitives <span class="hljs-keyword">import</span> serialization</li><li>
</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_private_key_from_json</span>(<span class="hljs-params">json_file_path</span>):</li><li>    <span class="hljs-string">"""</span></li><li><span class="hljs-string">    从JSON文件中加载私钥信息</span></li><li><span class="hljs-string">    :param json_file_path: JSON文件路径</span></li><li><span class="hljs-string">    :return: (key_id, sub_account, private_key_pem)</span></li><li><span class="hljs-string">    """</span></li><li>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(json_file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:</li><li>        data = json.load(f)</li><li>
</li><li>    <span class="hljs-comment"># 获取KID和ISS</span></li><li>    key_id = data.get(<span class="hljs-string">'key_id'</span>)</li><li>    sub_account = data.get(<span class="hljs-string">'sub_account'</span>)</li><li>
</li><li>    <span class="hljs-comment"># 将私钥转换为PEM格式</span></li><li>    private_key_str = data.get(<span class="hljs-string">'private_key'</span>)</li><li>    private_key_pem = serialization.load_pem_private_key(</li><li>        private_key_str.encode(),</li><li>        password=<span class="hljs-literal">None</span></li><li>    )</li><li>
</li><li>    <span class="hljs-keyword">return</span> key_id, sub_account, private_key_pem</li><li>
</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_jwt_token</span>(<span class="hljs-params">json_file_path</span>):</li><li>    <span class="hljs-comment"># 从JSON文件加载信息</span></li><li>    kid, iss, private_key = load_private_key_from_json(json_file_path)</li><li>
</li><li>    <span class="hljs-comment"># 当前时间和过期时间（示例中使用固定值，实际应根据需求计算）</span></li><li>    iat = <span class="hljs-built_in">int</span>(time.time())</li><li>    exp = iat + <span class="hljs-number">3600</span></li><li>
</li><li>    <span class="hljs-comment"># 构造Header</span></li><li>    header = {</li><li>        <span class="hljs-string">"kid"</span>: kid,</li><li>        <span class="hljs-string">"typ"</span>: <span class="hljs-string">"JWT"</span>,</li><li>        <span class="hljs-string">"alg"</span>: <span class="hljs-string">"PS256"</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment"># 构造Payload</span></li><li>    payload = {</li><li>        <span class="hljs-comment"># 实际开发时请将公网地址存储在配置文件或数据库</span></li><li>        <span class="hljs-string">"aud"</span>: <span class="hljs-string">"https://oauth-login.cloud.huawei.com/oauth2/v3/token"</span>,</li><li>        <span class="hljs-string">"iss"</span>: iss,</li><li>        <span class="hljs-string">"exp"</span>: exp,</li><li>        <span class="hljs-string">"iat"</span>: iat</li><li>    }</li><li>
</li><li>    <span class="hljs-comment"># 生成JWT Token</span></li><li>    token = jwt.encode(</li><li>        payload=payload,</li><li>        key=private_key,</li><li>        algorithm=<span class="hljs-string">'PS256'</span>,</li><li>        headers=header</li><li>    )</li><li>
</li><li>    <span class="hljs-keyword">return</span> token</li><li>
</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_message</span>(<span class="hljs-params">jwt_token</span>):</li><li>    <span class="hljs-comment"># 自行实现业务流程</span></li><li>    <span class="hljs-keyword">pass</span></li><li>
</li><li><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</li><li>    json_file = <span class="hljs-string">"private.json"</span>  <span class="hljs-comment"># 替换为实际JSON文件路径，此处以本文件同级目录为例</span></li><li>
</li><li>    <span class="hljs-keyword">try</span>:</li><li>        <span class="hljs-comment"># jwt_token 为鉴权令牌，调用推送服务REST API时放在Authorization头部来进行鉴权。</span></li><li>        jwt_token = generate_jwt_token(json_file)</li><li>        send_message(jwt_token)</li><li>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:</li><li>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Error generating JWT token: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)</li></ol></pre></div></div></div><div class="prebox"><div _ngcontent-sab-c106="" class="highlight-div"><div _ngcontent-sab-c106="" class="highlight-div-header"><div _ngcontent-sab-c106="" class="highlight-div-header-left"><div _ngcontent-sab-c106="" class="handle-button expand-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sab-c106="" class="highlight-div-header-right"><div _ngcontent-sab-c106="" class="handle-button ai-button"></div><div _ngcontent-sab-c106="" class="handle-button line-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sab-c106="" class="handle-button theme-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sab-c106="" class="handle-button copy-button"><div _ngcontent-sab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">&lt;?php</span></li><li><span class="hljs-comment">// 依赖：composer require lcobucci/jwt:^5.4.2</span></li><li><span class="hljs-comment">// 依赖：composer require lcobucci/jwt-rsassa-pss</span></li><li><span class="hljs-comment">// php: ~8.2.0 || ~8.3.0 || ~8.4.0</span></li><li><span class="hljs-keyword">require</span> <span class="hljs-string">'vendor/autoload.php'</span>;</li><li>
</li><li><span class="hljs-keyword">use</span> <span class="hljs-title">Lcobucci</span>\<span class="hljs-title">JWT</span>\<span class="hljs-title">Configuration</span>;</li><li><span class="hljs-keyword">use</span> <span class="hljs-title">Lcobucci</span>\<span class="hljs-title">JWT</span>\<span class="hljs-title">Signer</span>\<span class="hljs-title">RsaPss</span>\<span class="hljs-title">Sha256</span>;</li><li><span class="hljs-keyword">use</span> <span class="hljs-title">Lcobucci</span>\<span class="hljs-title">JWT</span>\<span class="hljs-title">Signer</span>\<span class="hljs-title">Key</span>\<span class="hljs-title">InMemory</span>;</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceAccount</span></span></li><li><span class="hljs-class"></span>{</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$keyId</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$subAccount</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$privateKey</span>;</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$tokenURI</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$keyId</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$subAccount</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$privateKey</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$tokenURI</span></span>)</span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-variable language_">$this</span>-&gt;keyId = <span class="hljs-variable">$keyId</span>;</li><li>        <span class="hljs-variable language_">$this</span>-&gt;subAccount = <span class="hljs-variable">$subAccount</span>;</li><li>        <span class="hljs-variable language_">$this</span>-&gt;privateKey = <span class="hljs-variable">$privateKey</span>;</li><li>        <span class="hljs-variable language_">$this</span>-&gt;tokenURI = <span class="hljs-variable">$tokenURI</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadServiceAccount</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$filePath</span></span>): <span class="hljs-title">ServiceAccount</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filePath</span>)) {</li><li>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"配置文件不存在: <span class="hljs-subst">$filePath</span>"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">$json</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filePath</span>);</li><li>    <span class="hljs-variable">$config</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-variable">$json</span>, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">json_last_error</span>() !== JSON_ERROR_NONE) {</li><li>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"JSON解析错误: "</span> . <span class="hljs-title function_ invoke__">json_last_error_msg</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 验证必要字段</span></li><li>    <span class="hljs-variable">$requiredKeys</span> = [<span class="hljs-string">'key_id'</span>, <span class="hljs-string">'sub_account'</span>, <span class="hljs-string">'private_key'</span>, <span class="hljs-string">'token_uri'</span>];</li><li>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$requiredKeys</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>) {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$config</span>[<span class="hljs-variable">$key</span>])) {</li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"配置缺少必要字段: <span class="hljs-subst">$key</span>"</span>);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 处理私钥中的换行符</span></li><li>    <span class="hljs-variable">$privateKey</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'\n'</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-variable">$config</span>[<span class="hljs-string">'private_key'</span>]);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceAccount</span>(</li><li>        <span class="hljs-variable">$config</span>[<span class="hljs-string">'key_id'</span>],</li><li>        <span class="hljs-variable">$config</span>[<span class="hljs-string">'sub_account'</span>],</li><li>        <span class="hljs-variable">$privateKey</span>,</li><li>        <span class="hljs-variable">$config</span>[<span class="hljs-string">'token_uri'</span>]</li><li>    );</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span>(<span class="hljs-params"></span>)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 自行实现业务流程</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateJWTToken</span>(<span class="hljs-params">ServiceAccount <span class="hljs-variable">$serviceAccount</span></span>)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-variable">$now</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>();</li><li>    <span class="hljs-variable">$expire</span> = <span class="hljs-variable">$now</span>-&gt;<span class="hljs-title function_ invoke__">modify</span>(<span class="hljs-string">"+3600 seconds"</span>);</li><li>
</li><li>    <span class="hljs-variable">$configuration</span> = <span class="hljs-title class_">Configuration</span>::<span class="hljs-title function_ invoke__">forSymmetricSigner</span>(</li><li>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sha256</span>(),</li><li>        <span class="hljs-title class_">InMemory</span>::<span class="hljs-title function_ invoke__">plainText</span>(<span class="hljs-variable">$serviceAccount</span>-&gt;privateKey)</li><li>    );</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$configuration</span>-&gt;<span class="hljs-title function_ invoke__">builder</span>()</li><li>        -&gt;<span class="hljs-title function_ invoke__">withHeader</span>(<span class="hljs-string">'alg'</span>, <span class="hljs-string">'PS256'</span>) <span class="hljs-comment">// 指定PS256算法</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">withHeader</span>(<span class="hljs-string">'typ'</span>, <span class="hljs-string">'JWT'</span>)   <span class="hljs-comment">// JWT类型</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">withHeader</span>(<span class="hljs-string">'kid'</span>, <span class="hljs-variable">$serviceAccount</span>-&gt;keyId) <span class="hljs-comment">// 密钥ID</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">issuedBy</span>(<span class="hljs-variable">$serviceAccount</span>-&gt;subAccount) <span class="hljs-comment">// iss</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">permittedFor</span>(<span class="hljs-variable">$serviceAccount</span>-&gt;tokenURI) <span class="hljs-comment">// aud</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">issuedAt</span>(<span class="hljs-variable">$now</span>) <span class="hljs-comment">// iat</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">expiresAt</span>(<span class="hljs-variable">$expire</span>) <span class="hljs-comment">// exp</span></li><li>        -&gt;<span class="hljs-title function_ invoke__">getToken</span>(<span class="hljs-variable">$configuration</span>-&gt;<span class="hljs-title function_ invoke__">signer</span>(), <span class="hljs-variable">$configuration</span>-&gt;<span class="hljs-title function_ invoke__">signingKey</span>())</li><li>        -&gt;<span class="hljs-title function_ invoke__">toString</span>();</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-comment">// 替换为JSON文件实际路径，此处以与本文件同级目录为例</span></li><li>        <span class="hljs-variable">$filePath</span> = <span class="hljs-string">'private.json'</span>;</li><li>        <span class="hljs-variable">$serviceAccount</span> = <span class="hljs-title function_ invoke__">loadServiceAccount</span>(<span class="hljs-variable">$filePath</span>);</li><li>        <span class="hljs-variable">$signedToken</span> = <span class="hljs-title function_ invoke__">generateJWTToken</span>(<span class="hljs-variable">$serviceAccount</span>);</li><li>
</li><li>        <span class="hljs-comment">// signedToken为鉴权令牌，调用推送服务REST API时放在Authorization头部来进行鉴权。</span></li><li>        <span class="hljs-title function_ invoke__">sendMessage</span>(<span class="hljs-variable">$signedToken</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {</li><li>        <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">"Error: "</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());</li><li>        <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-title function_ invoke__">main</span>();</li><li><span class="hljs-meta">?&gt;</span></li></ol></pre></div></div></div></div></div></div>    </div>   </div>   <div></div></div>