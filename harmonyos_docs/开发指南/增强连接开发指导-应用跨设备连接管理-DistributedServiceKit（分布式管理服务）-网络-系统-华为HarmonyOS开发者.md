<h1 _ngcontent-jet-c119="" class="doc-title ng-star-inserted" title="增强连接开发指导"> 增强连接开发指导 </h1>

<div _ngcontent-jet-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>随着技术的发展，各种应用层出不穷，设备间的互联关系也成为一种常态，此时对于网络环境的依赖也不可避免。然而，在某些特殊场景下（如航空、远洋航行等），网络受限，蓝牙成为少数可行的连接方式。但是传统蓝牙连接存在着连接数量有限、连接成功率低、连接不稳定等缺点，影响了用户体验。</p>     <p>HarmonyOS提供了分布式增强连接能力，实现跨设备互联，完成与对端设备的连接，交换应用业务数据。相比传统蓝牙连接，使用多通道合并算法，增加设备连接数量，增强连接稳定性，提升跨端互通体验。</p>    </div>    <div class="tiledSection">     <h3 id="实现原理" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h3>          <p>在设备互联过程中，发现对端的蓝牙地址并建立物理链路；在多设备互联场景下，通过特有的多通道合并算法，在保证设备间交互能力的前提下，减少实际物理链路的个数，达到设备间可用连接数增大、降低干扰提升通信的稳定性的效果。</p>     <p>两个设备的交互实现如下，在使用linkEnhance能力后，当两端同时发起连接时，会自动识别合并底层多余物理链路，减少实际物理链路的个数，减少蓝牙链路资源的消耗，增加可用连接数量。</p>     <p><span><img originheight="417" originwidth="798" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115038.02686527571906984905473913760219:50001231000000:2800:09FE1BB81FAB04AD195E715451096E0BAF1E898005A3197EDBA9C55E6C682017.png" width="798" height="417"></span></p>    </div>    <div class="tiledSection">     <h3 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>设备互联时需要开启蓝牙功能。</p></li>      <li>       <p>通过蓝牙广播/扫描接口获取对端设备BLE MAC。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ble-development-guide">蓝牙ble接口参见</a></p></li>      <li>       <p>不同设备间只有相同bundleName的应用才能进行互联。</p></li>      <li>       <p>需要配置ohos.permission.DISTRIBUTED_DATASYNC权限。</p></li>      <li>       <p>该接口提供连接能力，链路安全策略遵循调用者初始设置的蓝牙配对策略（如：Numeric Comparion、Passkey Entry、Just Works、Out of Band四种方式）。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="环境准备">环境准备<i class="anchor-icon anchor-icon-link" anchorid="环境准备" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="环境要求" class="firsth2">环境要求<i class="anchor-icon anchor-icon-link" anchorid="环境要求" tips="复制节点链接"></i></h3>          <p>打开客户端和服务端设备的蓝牙开关。</p>    </div>    <div class="tiledSection">     <h3 id="搭建环境">搭建环境<i class="anchor-icon anchor-icon-link" anchorid="搭建环境" tips="复制节点链接"></i></h3>          <ol>      <li>在PC上安装<a href="https://developer.huawei.com/consumer/cn/download/deveco-studio" target="_blank">DevEco Studio</a>，版本要求在4.1及以上。</li>      <li>将public-SDK更新到API 20或以上。</li>      <li>用USB线缆将两台调测设备（设备A和设备B）连接到PC。</li>      <li>打开设备A和设备B的蓝牙开关。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>常用接口说明如下表。更多接口的详细介绍参考@ohos.distributedsched.linkEnhance<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-link-enhance" target="_blank">增强连接</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">connect()</td>         <td class="cellrowborder" valign="top" width="50%">Client端发起连接远端设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">disconnect()</td>         <td class="cellrowborder" valign="top" width="50%">断开与远端设备的连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">close()</td>         <td class="cellrowborder" valign="top" width="50%">销毁Connection对象，注销所有注册的事件，调用该接口后Connection对象将不能再使用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getPeerDeviceId()</td>         <td class="cellrowborder" valign="top" width="50%">获取远端设备的deviceId。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">sendData(data:ArrayBuffer)</td>         <td class="cellrowborder" valign="top" width="50%">向远端设备发送数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'connectResult')</td>         <td class="cellrowborder" valign="top" width="50%">订阅连接结果通知变化的事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'disconnected')</td>         <td class="cellrowborder" valign="top" width="50%">订阅连接状态断开的事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'dataReceived')</td>         <td class="cellrowborder" valign="top" width="50%">注册收数据的通知事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">createConnection(deviceId：string,name:string)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个connection对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">start()</td>         <td class="cellrowborder" valign="top" width="50%">服务端开启服务。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">stop()</td>         <td class="cellrowborder" valign="top" width="50%">服务端停止服务。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">close()</td>         <td class="cellrowborder" valign="top" width="50%">销毁Server对象，注销已注册的服务并取消已订阅的所有事件，调用该接口后Server对象将不能再使用。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'acceptConnected')</td>         <td class="cellrowborder" valign="top" width="50%">Server端订阅收到对端连接的事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'serverStopped')</td>         <td class="cellrowborder" valign="top" width="50%">Server端订阅服务状态停止的事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">createServer(name: string)</td>         <td class="cellrowborder" valign="top" width="50%">创建一个server对象。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="增强连接开发指导-1">增强连接开发指导<i class="anchor-icon anchor-icon-link" anchorid="增强连接开发指导-1" tips="复制节点链接"></i></h2>          <ul>      <li>服务端开启蓝牙后，创建Server对象，并调用start()接口开启服务，让服务端处于可连接状态，通过注册的事件监听，监听事件的变化通知。</li>      <li>客户端开启蓝牙后，创建Connection对象，并调用connect()接口发起连接，通过注册的事件监听，监听事件的变化通知。</li>      <li>连接成功后，可以使用sendData接口发送数据。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="服务端开发指导" class="firsth2">服务端开发指导<i class="anchor-icon anchor-icon-link" anchorid="服务端开发指导" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>导入所需的模块。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> {linkEnhance} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>在module.json5配置文件中配置分布式数据同步权限ohos.permission.DISTRIBUTED_DATASYNC。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span> : {</li><li>    <span class="hljs-string">"requestPermissions"</span>:[</li><li>      {</li><li>        <span class="hljs-string">"name"</span> : <span class="hljs-string">"ohos.permission.DISTRIBUTED_DATASYNC"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:distributed_permission"</span>,</li><li>        <span class="hljs-string">"usedScene"</span>: {</li><li>          <span class="hljs-string">"abilities"</span>: [</li><li>            <span class="hljs-string">"MainAbility"</span></li><li>          ],</li><li>          <span class="hljs-string">"when"</span>: <span class="hljs-string">"inuse"</span></li><li>        }</li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建server对象，并开启服务，注册监听。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'TEST'</span>;</li><li><span class="hljs-comment">// server端注册服务</span></li><li><span class="hljs-title function_">linkEnhanceStart</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'start server deviceId = '</span> + name);</li><li>  <span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 使用服务名构造Server</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">server</span>: linkEnhance.<span class="hljs-property">Server</span> = linkEnhance.<span class="hljs-title function_">createServer</span>(name);</li><li>
</li><li>    <span class="hljs-comment">// 订阅服务接收事件和服务停止事件</span></li><li>    server.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionAccepted'</span>, (<span class="hljs-attr">connection</span>: linkEnhance.<span class="hljs-property">Connection</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'serverOnCallback'</span>);</li><li>    });</li><li>    server.<span class="hljs-title function_">on</span>(<span class="hljs-string">'serverStopped'</span>, (<span class="hljs-attr">reason</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'serverStopped， reason= '</span> + reason);</li><li>    });</li><li>    <span class="hljs-comment">// 启动服务</span></li><li>    server.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'start server errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>当连接被连上时，需要保存connection对象。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>serverAcceptOnCallback = (<span class="hljs-attr">connection</span>: linkEnhance.<span class="hljs-property">Connection</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'serverOnCallback'</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>
</li><li>    <span class="hljs-comment">// 收到连接请求后，订阅connection的断连事件。</span></li><li>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'disconnected'</span>, <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">number</span></span>)=&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnected, reason = '</span> + reason);</li><li>    });</li><li>    <span class="hljs-comment">// 收到连接请求后，订阅connection的数据接收事件。</span></li><li>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataReceived'</span>, <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>)=&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'dataReceived, dataLen='</span> + data.<span class="hljs-property">byteLength</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-keyword">let</span> len = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> arraybuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(len);</li><li>    <span class="hljs-comment">// 向远端发送数据。</span></li><li>    connection.<span class="hljs-title function_">sendData</span>(arraybuffer);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'server on callback errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>断开连接并销毁Connection对象。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 断连接。</span></li><li><span class="hljs-title function_">linkEnhanceDisconnect</span>(<span class="hljs-params">connection: linkEnhance.Connection</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnect deviceId = '</span> + connection.<span class="hljs-title function_">getPeerDeviceId</span>());</li><li>  <span class="hljs-keyword">try</span> {</li><li>    connection.<span class="hljs-title function_">disconnect</span>();</li><li>    connection.<span class="hljs-title function_">close</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>停止服务并销毁server对象。</p>       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Server端停止服务</span></li><li><span class="hljs-title function_">linkEnhanceStop</span>(<span class="hljs-params">server: linkEnhance.Server</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'stop server'</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    server.<span class="hljs-title function_">stop</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'stop server errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li><li><span class="hljs-comment">// Server端停止服务并取消所有的订阅事件</span></li><li><span class="hljs-title function_">linkEnhanceClose</span>(<span class="hljs-params">server: linkEnhance.Server</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'close server'</span> );</li><li>  <span class="hljs-keyword">try</span> {</li><li>    server.<span class="hljs-title function_">close</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'close server errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="客户端开发指导">客户端开发指导<i class="anchor-icon anchor-icon-link" anchorid="客户端开发指导" tips="复制节点链接"></i></h3>          <ol>      <li>导入所需的模块。       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { linkEnhance }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>在module.json5配置文件中配置分布式数据同步权限ohos.permission.DISTRIBUTED_DATASYNC。       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span> : {</li><li>    <span class="hljs-string">"requestPermissions"</span>:[</li><li>      {</li><li>        <span class="hljs-string">"name"</span> : <span class="hljs-string">"ohos.permission.DISTRIBUTED_DATASYNC"</span>,</li><li>        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:distributed_permission"</span>,</li><li>        <span class="hljs-string">"usedScene"</span>: {</li><li>          <span class="hljs-string">"abilities"</span>: [</li><li>            <span class="hljs-string">"MainAbility"</span></li><li>          ],</li><li>          <span class="hljs-string">"when"</span>: <span class="hljs-string">"inuse"</span></li><li>        }</li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>创建connection对象，订阅连接结果通知变化的事件，连接服务端。       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">"testDemo"</span>;</li><li><span class="hljs-comment">// client端主动连接时调用</span></li><li><span class="hljs-title function_">linkEnhanceConnect</span>(<span class="hljs-params">peerDeviceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'connection server deviceId = '</span> + peerDeviceId);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 使用peerDeviceId构造Connection后续的交互都需要使用该对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">connection</span>: linkEnhance.<span class="hljs-property">Connection</span> = linkEnhance.<span class="hljs-title function_">createConnection</span>(peerDeviceId, <span class="hljs-string">"demo"</span>);</li><li>    <span class="hljs-comment">// 订阅连接结果</span></li><li>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectResult'</span>, (<span class="hljs-attr">data</span>: linkEnhance.<span class="hljs-property">ConnectResult</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'clientConnectResultCallback result = '</span> + data.<span class="hljs-property">success</span>);</li><li>      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">success</span>) {</li><li>        <span class="hljs-comment">// 向服务端发送数据</span></li><li>        <span class="hljs-keyword">let</span> len = <span class="hljs-number">1</span>;</li><li>        <span class="hljs-keyword">let</span> arraybuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(len);</li><li>        connection.<span class="hljs-title function_">sendData</span>(arraybuffer);</li><li>      }</li><li>    });</li><li>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'disconnected'</span>, <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">number</span></span>)=&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnected reason = '</span> + reason);</li><li>    });</li><li>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataReceived'</span>, <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>)=&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'dataReceived, dataLen='</span> + data.<span class="hljs-property">byteLength</span>);</li><li>    });</li><li>    <span class="hljs-comment">// 发起连接</span></li><li>    connection.<span class="hljs-title function_">connect</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'connect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>断开连接，销毁Connection对象。       <div _ngcontent-jet-c106="" class="highlight-div"><div _ngcontent-jet-c106="" class="highlight-div-header"><div _ngcontent-jet-c106="" class="highlight-div-header-left"><div _ngcontent-jet-c106="" class="handle-button expand-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jet-c106="" class="highlight-div-header-right"><div _ngcontent-jet-c106="" class="handle-button ai-button"></div><div _ngcontent-jet-c106="" class="handle-button line-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jet-c106="" class="handle-button theme-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jet-c106="" class="handle-button copy-button"><div _ngcontent-jet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jet-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">disconnect</span>(<span class="hljs-params">connection: linkEnhance.Connection</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnect deviceId = '</span> + connection.<span class="hljs-title function_">getPeerDeviceId</span>());</li><li>  <span class="hljs-keyword">try</span> {</li><li>    connection.<span class="hljs-title function_">disconnect</span>();</li><li>    connection.<span class="hljs-title function_">close</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'disconnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> +</li><li>    (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>