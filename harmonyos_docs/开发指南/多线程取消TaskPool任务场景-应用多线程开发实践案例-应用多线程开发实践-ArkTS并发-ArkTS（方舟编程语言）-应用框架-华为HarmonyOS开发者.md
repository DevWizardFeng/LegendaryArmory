<h1 _ngcontent-rrf-c119="" class="doc-title ng-star-inserted" title="多线程取消TaskPool任务场景"> 多线程取消TaskPool任务场景 </h1>

<div _ngcontent-rrf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>由于任务池<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>的任务对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#task" target="_blank">Task</a>不支持跨线程传递，无法在子线程中直接取消任务。从 API version 18 开始，Task新增了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#属性" target="_blank">任务ID</a>属性，支持通过任务ID在子线程中取消任务。开发者可将已创建任务的任务ID存储在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable">Sendable对象</a>中，需要取消任务时，通过Sendable对象在子线程中取消任务。详情可参考以下示例。</p>    <ol>     <li>      <p>定义一个Sendable类，在类属性中存储任务ID。</p>      <div _ngcontent-rrf-c106="" class="highlight-div"><div _ngcontent-rrf-c106="" class="highlight-div-header"><div _ngcontent-rrf-c106="" class="highlight-div-header-left"><div _ngcontent-rrf-c106="" class="handle-button expand-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rrf-c106="" class="highlight-div-header-right"><div _ngcontent-rrf-c106="" class="handle-button ai-button"></div><div _ngcontent-rrf-c106="" class="handle-button line-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rrf-c106="" class="handle-button theme-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rrf-c106="" class="handle-button copy-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rrf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sendable.ets</span></li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableTest</span> {</li><li> <span class="hljs-comment">// 存储任务ID</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">taskId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskId</span> = id;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTaskId</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskId</span>;</li><li>  }</li><li>}</li></ol></pre></div></div></li>     <li>      <p>在UI主线程向TaskPool提交一个延时任务，并在子线程取消该任务。</p>      <div _ngcontent-rrf-c106="" class="highlight-div"><div _ngcontent-rrf-c106="" class="highlight-div-header"><div _ngcontent-rrf-c106="" class="highlight-div-header-left"><div _ngcontent-rrf-c106="" class="handle-button expand-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rrf-c106="" class="highlight-div-header-right"><div _ngcontent-rrf-c106="" class="handle-button ai-button"></div><div _ngcontent-rrf-c106="" class="handle-button line-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rrf-c106="" class="handle-button theme-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rrf-c106="" class="handle-button copy-button"><div _ngcontent-rrf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rrf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableTest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendable'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancel</span>(<span class="hljs-params">send: SendableTest</span>) {</li><li>  <span class="hljs-comment">// 在多线程中通过任务ID取消任务</span></li><li>  taskpool.<span class="hljs-title function_">cancel</span>(send.<span class="hljs-title function_">getTaskId</span>());</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"cancel task finished"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">delayed</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"delayed task finished"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">let</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(delayed);</li><li>            taskpool.<span class="hljs-title function_">executeDelayed</span>(<span class="hljs-number">2000</span>, task).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`taskpool execute error, message is: <span class="hljs-subst">${e.message}</span>`</span>); <span class="hljs-comment">// taskpool execute error, message is: taskpool:: task has been canceled</span></li><li>            });</li><li>            <span class="hljs-keyword">let</span> send = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableTest</span>(task.<span class="hljs-property">taskId</span>);</li><li>            taskpool.<span class="hljs-title function_">execute</span>(cancel, send);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>