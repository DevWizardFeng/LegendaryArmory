<h1 _ngcontent-frj-c119="" class="doc-title ng-star-inserted" title="大语言模型低位量化"> 大语言模型低位量化 </h1>

<div _ngcontent-frj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7872454132911">简介<i class="anchor-icon anchor-icon-link" anchorid="section7872454132911" tips="复制节点链接"></i></h2><p>本工具提供大语言模型（Large Language Model，以下简称LLM）的4bit低位量化能力，采用标准的三段式量化流程：权重量化、激活量化和量化参数提取。三段式量化流程说明如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>大语言模型4bit低位量化三阶段流程</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.1" valign="top" width="14.871487148714872%"><p>阶段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.2" valign="top" width="40.45404540454046%"><p>输入</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.3" valign="top" width="44.67446744674467%"><p>输出</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="14.871487148714872%"><p>阶段一（权重量化）</p> </td> <td class="cellrowborder" rowspan="3" valign="top" width="40.45404540454046%"><ul><li>开发者提供</li></ul> <p>- JSON数据集（text字段作prompt）</p> <p>- HuggingFace模型路径（开发者浮点模型）</p> <ul><li>量化配置及执行文件</li></ul> <p>- config.yaml</p> <p>- demo.py</p> <p>- run.sh</p> </td> <td class="cellrowborder" valign="top" width="44.67446744674467%"><ul><li>dopt_config.json：开发者需完成该文件的量化策略配置后，重新执行此阶段</li></ul> <ul><li>trained_quant_weight.pth：权重量化参数</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>开发者需根据阶段一生成的dopt_config.json文件手动进行量化策略配置后，再次执行该阶段。</p> </div></div></div> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>阶段二（激活量化）</p> </td> <td class="cellrowborder" valign="top"><p>trained.pth：用于阶段三加载或量化仿真验证</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>阶段三（量化参数提取）</p> </td> <td class="cellrowborder" valign="top"><ul><li>fake_quant_weight.pth：用于ONNX模型导出</li><li>quant_params_file：权重及激活量化参数</li></ul> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1540710183017">量化前准备工作<i class="anchor-icon anchor-icon-link" anchorid="section1540710183017" tips="复制节点链接"></i></h2><ul><li><span style="color: rgb(64,64,64);">HuggingFace浮点模型</span></li><li>JSON格式数据集，使用“text”字段作为prompt关键字</li><li>量化配置文件<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section19562154641017">config.yaml</a></li><li><a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section158091338101113">demo.py</a>及<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section11700841124819">run.sh</a>执行脚本</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>LLM在量化过程中使用AutoModelForCausalLM以及AutoTokenizer加载，所以开发者的HuggingFace浮点模型需要满足该加载方式约束。</li><li>run.sh执行脚本环境须与开发者推理或者训练环境保持一致，否则模型加载失败。</li></ul> </div></div></div> </div> <div class="tiledSection"><h3 id="section19562154641017" class="firsth2">config.yaml示例<i class="anchor-icon anchor-icon-link" anchorid="section19562154641017" tips="复制节点链接"></i></h3><p>config.yaml用于模型量化配置，开发者可根据实际需要进行配置。以下示例可供参考，主要参数说明请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section760161441112">config.yaml配置参数说明</a>。</p> <div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="yaml prettyprint linenums hljs language-yaml" hw-language="yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">kd:</span></li><li>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">True</span></li><li>  <span class="hljs-attr">loss:</span> <span class="hljs-string">mse</span></li><li>  <span class="hljs-attr">micro_batch_size:</span> <span class="hljs-number">2</span></li><li>  <span class="hljs-attr">gradient_accumulation_steps:</span> <span class="hljs-number">4</span></li><li>  <span class="hljs-attr">weight_decay:</span> <span class="hljs-number">0.0</span></li><li>  <span class="hljs-attr">warmup_steps:</span> <span class="hljs-number">10</span></li><li>  <span class="hljs-attr">num_epochs:</span> <span class="hljs-number">3</span></li><li>  <span class="hljs-attr">learning_rate:</span> <span class="hljs-type">!!float</span> <span class="hljs-number">1e-4</span></li><li>  <span class="hljs-attr">eval_step:</span> <span class="hljs-number">1</span></li><li>  <span class="hljs-attr">logging_step:</span> <span class="hljs-number">50</span></li><li>  <span class="hljs-attr">lr_scheduler_type:</span> <span class="hljs-string">cosine</span></li><li>  <span class="hljs-attr">trainable_keys:</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">quant_alpha</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">norm</span></li><li>  <span class="hljs-attr">no_split_module_classes:</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">Qwen2DecoderLayer</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">GlmDecoderLayer</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">LlamaDecoderLayer</span></li><li>    <span class="hljs-bullet">-</span> <span class="hljs-string">HunYuanDecoderLayer</span></li><li><span class="hljs-attr">dataset:</span></li><li>  <span class="hljs-attr">train_files:</span> <span class="hljs-string">dataset.json</span></li><li>  <span class="hljs-attr">train_samples:</span> <span class="hljs-number">1024</span></li><li>  <span class="hljs-attr">ptq_samples:</span> <span class="hljs-number">1024</span></li><li><span class="hljs-attr">extra_training_config:</span></li><li>  <span class="hljs-attr">fp16:</span> <span class="hljs-literal">True</span></li><li><span class="hljs-attr">cutoff_len:</span> <span class="hljs-number">128</span></li><li><span class="hljs-attr">num_samples:</span> <span class="hljs-number">256</span></li><li><span class="hljs-attr">lut_mode:</span> <span class="hljs-literal">False</span></li><li><span class="hljs-attr">embedding_in_omc:</span> <span class="hljs-literal">False</span></li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section760161441112">config.yaml配置参数说明<i class="anchor-icon anchor-icon-link" anchorid="section760161441112" tips="复制节点链接"></i></h3><p>以下为config.yaml文件的关键配置参数，具体说明如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" colspan="2" id="mcps1.3.4.3.1.5.1.1" valign="top"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.5.1.2" valign="top"><p>默认取值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.5.1.3" valign="top"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="12" valign="top" width="15.120000000000001%"><p>kd：量化蒸馏相关</p> </td> <td class="cellrowborder" valign="top" width="21.349999999999998%"><p>enable</p> </td> <td class="cellrowborder" valign="top" width="16.77%"><p>True</p> </td> <td class="cellrowborder" valign="top" width="46.760000000000005%"><ul><li>True：使用蒸馏量化策略</li><li>false：使用无训练量化策略</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>loss</p> </td> <td class="cellrowborder" valign="top"><p>mse</p> </td> <td class="cellrowborder" valign="top"><p>量化蒸馏损失函数，仅支持mse</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>micro_batch_size</p> </td> <td class="cellrowborder" valign="top"><p>2</p> </td> <td class="cellrowborder" valign="top"><p>单卡batch</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>gradient_accumulation_steps</p> </td> <td class="cellrowborder" valign="top"><p>4</p> </td> <td class="cellrowborder" valign="top"><p>梯度累计步数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>weight_decay</p> </td> <td class="cellrowborder" valign="top"><p>0.0</p> </td> <td class="cellrowborder" valign="top"><p>权重衰减系数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>warmup_steps</p> </td> <td class="cellrowborder" valign="top"><p>10</p> </td> <td class="cellrowborder" valign="top"><p>预热步数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>num_epochs</p> </td> <td class="cellrowborder" valign="top"><p>3</p> </td> <td class="cellrowborder" valign="top"><p>训练迭代次数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>learning_rate</p> </td> <td class="cellrowborder" valign="top"><p>1e-4</p> </td> <td class="cellrowborder" valign="top"><p>学习率</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>logging_step</p> </td> <td class="cellrowborder" valign="top"><p>50</p> </td> <td class="cellrowborder" valign="top"><p>log打印步数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>lr_scheduler_type</p> </td> <td class="cellrowborder" valign="top"><p>cosine</p> </td> <td class="cellrowborder" valign="top"><p>学习率调整策略。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>trainable_keys</p> </td> <td class="cellrowborder" valign="top"><p>-</p> </td> <td class="cellrowborder" valign="top"><p>配置可训练参数。</p> <ul><li>quant_alpha：量化层的训练参数</li><li>norm：layer_norm层的可训练参数</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>no_split_module_classes</p> </td> <td class="cellrowborder" valign="top"><p>-</p> </td> <td class="cellrowborder" valign="top"><p>多卡切分时，选择切分粒度。</p> <ul><li>Qwen2DecoderLayer</li><li>GlmDecoderLayer</li><li>LlamaDecoderLayer</li><li>HunYuanDecoderLayer</li></ul> </td> </tr> <tr><td class="cellrowborder" rowspan="8" valign="top" width="15.120000000000001%"><p>dataset</p> </td> <td class="cellrowborder" valign="top" width="21.349999999999998%"><p>train_files</p> </td> <td class="cellrowborder" valign="top" width="16.77%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="46.760000000000005%"><p>JSON格式训练数据文件，dataset.json</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>train_samples</p> </td> <td class="cellrowborder" valign="top"><p>1024</p> </td> <td class="cellrowborder" valign="top"><p>训练集样本数，缺省默认全量数据集</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>ptq_samples</p> </td> <td class="cellrowborder" valign="top"><p>1024</p> </td> <td class="cellrowborder" valign="top"><p>PTQ优化样本数，缺省默认全量数据集</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>extra_training_config</p> </td> <td class="cellrowborder" valign="top"><p>fp16</p> </td> <td class="cellrowborder" valign="top"><p>训练数据类型，仅支持fp16</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>cutoff_len</p> </td> <td class="cellrowborder" valign="top"><p>128</p> </td> <td class="cellrowborder" valign="top"><p>样本序列长度</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>num_samples</p> </td> <td class="cellrowborder" valign="top"><p>256</p> </td> <td class="cellrowborder" valign="top"><p>激活量化校准样本数</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>lut_mode</p> </td> <td class="cellrowborder" valign="top"><p>False</p> </td> <td class="cellrowborder" valign="top"><ul><li>True：导出参数使用lut表</li><li>False：导出参数不使用lut表</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>embedding_in_omc</p> </td> <td class="cellrowborder" valign="top"><p>False</p> </td> <td class="cellrowborder" valign="top"><ul><li>True：导出embedding的量化参数到量化文件</li><li>False：单独保存为bin文件</li></ul> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section158091338101113">demo.py示例<i class="anchor-icon anchor-icon-link" anchorid="section158091338101113" tips="复制节点链接"></i></h3><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">#!/usr/bin/env python</span></li><li><span class="hljs-comment"># -*- coding: utf-8 -*-</span></li><li><span class="hljs-comment"># Copyright Huawei Technologies Co., Ltd. 2010-2024. All rights reserved</span></li><li><span class="hljs-keyword">import</span> os</li><li><span class="hljs-keyword">import</span> sys</li><li><span class="hljs-keyword">import</span> argparse</li><li><span class="hljs-keyword">from</span> dopt.log <span class="hljs-keyword">import</span> Logger</li><li><span class="hljs-keyword">from</span> dopt.dopt_llm.opt_main <span class="hljs-keyword">import</span> parse_args, generate_quant_config, llm_quant_pipline</li><li><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</li><li>    args = parse_args()</li><li>    <span class="hljs-comment">### step1 generate dopt_quant_config</span></li><li>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(args.dopt_config):</li><li>        generate_quant_config(args.model_path, args.dopt_config)</li><li>        Logger.info(<span class="hljs-string">f'generate plugin quang config please set quant strategy firstly'</span>)</li><li>        exit()</li><li>    optimize_info = {</li><li>        <span class="hljs-string">"model_path"</span> :  args.model_path,</li><li>        <span class="hljs-string">"config_yaml"</span>:  args.optimize_config,</li><li>        <span class="hljs-string">"dopt_config"</span>:  args.dopt_config,</li><li>        <span class="hljs-string">"output_dir"</span> :  args.output_dir,</li><li>        <span class="hljs-string">"hf_type_save"</span>: args.hf_type_save,</li><li>        <span class="hljs-string">"quant_stage"</span> : args.quant_stage,</li><li>        <span class="hljs-string">"group_size"</span> :  args.group_size,</li><li>        <span class="hljs-string">"act_bits"</span>:     args.act_bits,</li><li>        <span class="hljs-string">"w_bits"</span>:       args.w_bits,</li><li>    }</li><li>    <span class="hljs-comment">### step2 run llm model Quantification optimization process</span></li><li>    llm_quant_pipline(**optimize_info)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section11700841124819">执行三段式量化<i class="anchor-icon anchor-icon-link" anchorid="section11700841124819" tips="复制节点链接"></i></h2><p>按以下步骤执行run.sh文件，stagex为传入参数，具体可参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section11317363241">run.sh示例</a>。</p> <ol><li><span>权重量化。</span><p></p><ol><li>选配量化策略。<div class="p">生成插件式量化配置文件<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section15113659191318">dopt_config.json</a>。<div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*bash run.sh stage1*/</span> </li></ol></pre></div></div> </div> <p>量化策略可选配置为：</p> <div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">Quant_act_weight_eco   decode层策略</span></li><li><span class="hljs-comment">Quant_lm_head          lm_head层策略</span></li><li><span class="hljs-comment">Quant_Embed_MinMax     embedding层策略</span></li><li><span class="hljs-comment">*/</span></li></ol></pre></div></div> </li><li>进行权重量化。<div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">/*bash run.sh stage1*/</span></li></ol></pre></div></div> </li></ol> <p></p></li><li><span>激活量化。</span><p></p><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*bash run.sh stage2*/</span></li></ol></pre></div></div> <p></p></li><li><span>提取量化参数。</span><p></p><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*bash run.sh stage3*/</span></li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section11317363241" class="firsth2">run.sh示例<i class="anchor-icon anchor-icon-link" anchorid="section11317363241" tips="复制节点链接"></i></h3><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span></li><li>set -e</li><li>export WANDB_DISABLED=true</li><li>export HF_DATASETS_OFFLINE=0</li><li>export PYTHONPATH=../../dopt_tool_chain:$PYTHONPATH</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">设置为cuda或npu模式</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">cuda模式</span></li><li>export DEVICE=cuda</li><li>export CUDA_VISIBLE_DEVICES=1</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">npu模式</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> DEVICE=npu</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> ASCEND_RT_VISIBLE_DEVICES=2,3</span></li><li>ROOT=''</li><li>testcase='demo_case'</li><li>RUN_FILE=${ROOT}/demo.py</li><li>output_dir=${ROOT}/${testcase}/train_output</li><li>mkdir -p ${output_dir}</li><li>model_path=model_path_or_name</li><li>dopt_config=./${testcase}/dopt_config.json</li><li>quant_stage=$1</li><li>group_size=128</li><li>act_bits=16</li><li>w_bits=4</li><li>python -u \</li><li>    ${RUN_FILE} --model-path $model_path \</li><li>    --dopt-config $dopt_config \</li><li>    --optimize-config ${ROOT}/config.yaml \</li><li>    --quant-stage $quant_stage \</li><li>    --group-size $group_size \</li><li>    --act-bits $act_bits \</li><li>    --w-bits $w_bits \</li><li>    --output-dir ${output_dir} 2&gt;&amp;1 | tee ${output_dir}/logs.log</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section15113659191318">dopt_config.json量化配置文件说明<i class="anchor-icon anchor-icon-link" anchorid="section15113659191318" tips="复制节点链接"></i></h3><p>工具支持开发者插件式自定义LLM量化规格：</p> <ul><li>逐层权重量化位宽(bit)和分组大小(group_size)。</li><li>逐层激活量化位宽(bit)。</li><li>量化策略：decoder层使用"Quant_act_weight_eco"，lm_head层使用"Quant_lm_head"，embedding层使用"Quant_Embed_MinMax"。</li></ul> <div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>     <span class="hljs-attr">"layer_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>         <span class="hljs-attr">"model.layers.0.self_attn.q_proj"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>             <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;class 'torch.nn.modules.linear.Linear'&gt;"</span><span class="hljs-punctuation">,</span></li><li>             <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Quant_act_weight_eco"</span><span class="hljs-punctuation">,</span></li><li>             <span class="hljs-attr">"weight"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span></li><li>                 <span class="hljs-attr">"bit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span></li><li>                 <span class="hljs-attr">"group_size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">64</span></li><li>             <span class="hljs-punctuation">}</span></li><li>             <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span></li><li>                 <span class="hljs-attr">"bit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span></li><li>             <span class="hljs-punctuation">}</span></li><li>         <span class="hljs-punctuation">}</span></li><li>         <span class="hljs-comment">// ...</span></li><li> <span class="hljs-punctuation">}</span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section65303253384">量化工具输出件<i class="anchor-icon anchor-icon-link" anchorid="section65303253384" tips="复制节点链接"></i></h2><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>trained.pth            <span class="hljs-comment">### 量化仿真可使用该文件</span></li><li>fake_quant_weight.pth  <span class="hljs-comment">### 导出onnx文件使用该权重</span></li><li>trained_quant_weight.pth <span class="hljs-comment">### 阶段一的输出，阶段二的输入</span></li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section828015456811">量化仿真<i class="anchor-icon anchor-icon-link" anchorid="section828015456811" tips="复制节点链接"></i></h2><p><span style="color: rgb(64,64,64);">量化完成后，开发者可进行量化仿真推理，通过对比量化模型与原始浮点模型的输出结果，</span><span style="color: rgb(64,64,64);">来评估量化模型精度是否满足要求。</span>量化仿真推理工程可参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section20831155341215">qwen2模型量化仿真推理demo</a>。</p> <p><span><img height="145.63500000000002" originheight="975" originwidth="3494" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114254.06666097923277876110713849171524:50001231000000:2800:18661CBC053FC3F2B3B5168F66554781280B354F7C79D61C19810E1C2F5B511F.jpg" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section14449923141211" class="firsth2">插件方法<i class="anchor-icon anchor-icon-link" anchorid="section14449923141211" tips="复制节点链接"></i></h3><p>浮点模型完成加载和初始化后，使用以下接口将浮点模型转换为量化模型，模型推理逻辑不变，可参考<a href="/consumer/cn/doc/harmonyos-guides/cannkit-large-language-model#section20831155341215">qwen2模型量化仿真推理demo</a>。</p> <div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">"path/to/dopt"</span>)</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_quanted_model</span>(<span class="hljs-params">base_model, dopt_config, quanted_ckpt</span>):</li><li>     <span class="hljs-keyword">from</span> dopt.dopt_llm.do_opt <span class="hljs-keyword">import</span>(</li><li>         optimize_model,</li><li>         set_quant_state,</li><li>         set_calibrate_state,</li><li>         set_run_mode,</li><li>     )</li><li>     model = optimize_model(base_model, dopt_config)</li><li>     model.load_state_dict(torch.load(quanted_ckpt, map_location=torch.device(<span class="hljs-string">'cpu'</span>)), strict=<span class="hljs-literal">True</span>)</li><li>     set_quant_state(model, weight_state=<span class="hljs-literal">True</span>, input_state=<span class="hljs-literal">True</span>)</li><li>     set_calibrate_state(model, <span class="hljs-literal">False</span>)    </li><li>     model.<span class="hljs-built_in">eval</span>()</li><li>     <span class="hljs-keyword">return</span> model</li></ol></pre></div></div> <ul><li>base_model：开发者浮点模型（使用transformers库AutoModelForCausalLM类进行加载）。</li><li>dopt_config：量化配置文件。</li><li>quanted_ckpt：量化后pth文件。</li></ul> </div> <div class="tiledSection"><h3 id="section20831155341215">qwen2模型量化仿真推理demo<i class="anchor-icon anchor-icon-link" anchorid="section20831155341215" tips="复制节点链接"></i></h3><div _ngcontent-frj-c106="" class="highlight-div"><div _ngcontent-frj-c106="" class="highlight-div-header"><div _ngcontent-frj-c106="" class="highlight-div-header-left"><div _ngcontent-frj-c106="" class="handle-button expand-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frj-c106="" class="highlight-div-header-right"><div _ngcontent-frj-c106="" class="handle-button ai-button"></div><div _ngcontent-frj-c106="" class="handle-button line-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frj-c106="" class="handle-button theme-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frj-c106="" class="handle-button copy-button"><div _ngcontent-frj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> os</li><li><span class="hljs-keyword">import</span> sys</li><li><span class="hljs-keyword">import</span> torch</li><li><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM, AutoTokenizer</li><li>sys.path.append(<span class="hljs-string">'path/to/dopt'</span>)</li><li>os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">"0"</span></li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_quanted_model</span>(<span class="hljs-params">base_model, dopt_config, quanted_ckpt</span>):</li><li>    <span class="hljs-string">"""</span></li><li><span class="hljs-string">    加载量化模型核心函数</span></li><li><span class="hljs-string">    :param base_model: 原始HF模型对象</span></li><li><span class="hljs-string">    :param dopt_config: 量化配置文件路径（dopt_config.json）</span></li><li><span class="hljs-string">    :param quanted_ckpt: 量化权重路径（trained.pth）</span></li><li><span class="hljs-string">    :return: 量化后的模型</span></li><li><span class="hljs-string">    """</span></li><li>    <span class="hljs-keyword">from</span> dopt.dopt_llm.do_opt <span class="hljs-keyword">import</span>(</li><li>        optimize_model,</li><li>        set_quant_state,</li><li>        set_calibrate_state,</li><li>        set_run_mode,</li><li>    )</li><li>    <span class="hljs-comment"># 模型量化优化（根据配置文件应用4bit量化策略）</span></li><li>    model = optimize_model(base_model, dopt_config)</li><li>    <span class="hljs-comment"># 加载量化权重（强制CPU加载避免显存冲突）</span></li><li>    model.load_state_dict(torch.load(quanted_ckpt, map_location=torch.device(<span class="hljs-string">'cpu'</span>)), strict=<span class="hljs-literal">True</span>)</li><li>    <span class="hljs-comment"># 设置量化状态</span></li><li>    set_quant_state(model, weight_state=<span class="hljs-literal">True</span>, input_state=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 启用权重和激活量化</span></li><li>    set_calibrate_state(model, <span class="hljs-literal">False</span>)  <span class="hljs-comment"># 关闭校准模式</span></li><li>    set_run_mode(model, <span class="hljs-string">"hardware"</span>)   <span class="hljs-comment"># 设置为硬件推理模式</span></li><li>    model.<span class="hljs-built_in">eval</span>()</li><li>    <span class="hljs-keyword">return</span> model</li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">prompt = <span class="hljs-string">"Give me a short introduction to large language model."</span></span>):</li><li>    <span class="hljs-string">"""</span></li><li><span class="hljs-string">    量化模型推理函数</span></li><li><span class="hljs-string">    :param prompt: 输入文本（默认示例prompt）</span></li><li><span class="hljs-string">    :return: 模型生成的响应</span></li><li><span class="hljs-string">    """</span></li><li>    <span class="hljs-comment"># 构建Qwen2专用对话模板</span></li><li>    messages = [</li><li>        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"You are Qwen, created by Alibaba Cloud..."</span>},</li><li>        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}</li><li>    ]</li><li>    <span class="hljs-comment"># 应用模板并tokenize</span></li><li>    text = tokenizer.apply_chat_template(</li><li>        messages,</li><li>        tokenize=<span class="hljs-literal">False</span>,</li><li>        add_generation_prompt=<span class="hljs-literal">True</span></li><li>    )</li><li>    model_inputs = tokenizer([text], return_tensors=<span class="hljs-string">"pt"</span>).to(model.device)</li><li>    <span class="hljs-comment"># 执行生成</span></li><li>    generated_ids = model.generate(</li><li>        **model_inputs,</li><li>        max_new_tokens=<span class="hljs-number">512</span>,  <span class="hljs-comment"># 控制最大生成长度</span></li><li>    )</li><li>    <span class="hljs-comment"># 后处理：去除输入部分</span></li><li>    generated_ids = [</li><li>        output_ids[<span class="hljs-built_in">len</span>(input_ids):]</li><li>        <span class="hljs-keyword">for</span> input_ids, output_ids <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(model_inputs.input_ids, generated_ids)</li><li>    ]</li><li>    <span class="hljs-keyword">return</span> tokenizer.batch_decode(generated_ids, skip_special_tokens=<span class="hljs-literal">True</span>)[<span class="hljs-number">0</span>]</li><li><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</li><li>    <span class="hljs-comment"># === 1. 加载原始模型 ===</span></li><li>    model_name = <span class="hljs-string">"path/to/model"</span>  <span class="hljs-comment"># 需替换为实际模型路径</span></li><li>    model = AutoModelForCausalLM.from_pretrained(</li><li>        model_name,</li><li>        torch_dtype=torch.float16,  <span class="hljs-comment"># 半精度加载</span></li><li>        device_map=<span class="hljs-string">"auto"</span>           <span class="hljs-comment"># 自动分配GPU</span></li><li>    )</li><li>    tokenizer = AutoTokenizer.from_pretrained(model_name)</li><li>    <span class="hljs-comment"># === 2. 加载量化模型 ===</span></li><li>    quant_res_root = <span class="hljs-string">'dsr1_qwen7b_ptq'</span>  <span class="hljs-comment"># 量化结果目录</span></li><li>    dopt_config = <span class="hljs-string">f"./<span class="hljs-subst">{quant_res_root}</span>/dopt_config.json"</span>    <span class="hljs-comment"># 阶段一生成的配置文件</span></li><li>    quanted_ckpt = <span class="hljs-string">f"./<span class="hljs-subst">{quant_res_root}</span>/train_output/trained.pth"</span>  <span class="hljs-comment"># 阶段二生成的权重</span></li><li>    model = get_quanted_model(</li><li>        model,</li><li>        dopt_config,  <span class="hljs-comment"># 需确保已正确配置量化参数</span></li><li>        quanted_ckpt   <span class="hljs-comment"># 需与当前模型架构匹配</span></li><li>    )</li><li>    <span class="hljs-comment"># === 3. 执行推理测试 ===</span></li><li>    prompt = <span class="hljs-string">"who are you?"</span></li><li>    response = generate(prompt)</li><li>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"量化模型推理结果："</span>, response)</li><li>    <span class="hljs-string">"""</span></li><li><span class="hljs-string">    预期输出示例：</span></li><li><span class="hljs-string">    "Hi, I am Qwen, ..."</span></li><li><span class="hljs-string">    """</span></li></ol></pre></div></div> </div> </div> <div></div></div>