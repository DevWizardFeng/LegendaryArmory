<h1 _ngcontent-uqm-c119="" class="doc-title ng-star-inserted" title="如何将码图背景颜色设置成透明色"> 如何将码图背景颜色设置成透明色 </h1>

<div _ngcontent-uqm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p><strong>问题现象</strong></p> <p>当前码图生成不支持设置背景颜色为透明色。</p> <p><strong>解决措施</strong></p> <p>通过图片处理将码图的背景颜色转换为透明色。</p> <p>示例代码（仅供参考）：</p> <div _ngcontent-uqm-c106="" class="highlight-div"><div _ngcontent-uqm-c106="" class="highlight-div-header"><div _ngcontent-uqm-c106="" class="highlight-div-header-left"><div _ngcontent-uqm-c106="" class="handle-button expand-button"><div _ngcontent-uqm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uqm-c106="" class="highlight-div-header-right"><div _ngcontent-uqm-c106="" class="handle-button ai-button"></div><div _ngcontent-uqm-c106="" class="handle-button line-button"><div _ngcontent-uqm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uqm-c106="" class="handle-button theme-button"><div _ngcontent-uqm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uqm-c106="" class="handle-button copy-button"><div _ngcontent-uqm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uqm-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 通过传入createBarcode生成的PixelMap对象及其背景色，获取透明背景色的PixelMap对象</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">image.PixelMap</span>} <span class="hljs-variable">originalPixelMap</span> - createBarcode生成的PixelMap对象。</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">backgroundColor</span> - CreateOptions设置的十六进制背景色。</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;image.PixelMap | undefined&gt;</span>} 成功返回新的PixelMap对象，失败则返回undefined。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertBackgroundColorToTransparent</span>(<span class="hljs-params">originalPixelMap: image.PixelMap,</span></li><li><span class="hljs-params">  backgroundColor: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 获取图像信息</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">imageInfo</span>: image.<span class="hljs-property">ImageInfo</span> = <span class="hljs-keyword">await</span> originalPixelMap.<span class="hljs-title function_">getImageInfo</span>();</li><li>
</li><li>    <span class="hljs-comment">// 创建缓冲区以存储像素数据</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(originalPixelMap.<span class="hljs-title function_">getPixelBytesNumber</span>());</li><li>
</li><li>    <span class="hljs-comment">// 将像素数据读取到缓冲区</span></li><li>    originalPixelMap.<span class="hljs-title function_">readPixelsToBufferSync</span>(buffer);</li><li>
</li><li>    <span class="hljs-comment">// 初始化新像素图的选项</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: image.<span class="hljs-property">InitializationOptions</span> = {</li><li>      <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-attr">srcPixelFormat</span>: imageInfo.<span class="hljs-property">pixelFormat</span>,</li><li>      <span class="hljs-attr">pixelFormat</span>: imageInfo.<span class="hljs-property">pixelFormat</span>,</li><li>      <span class="hljs-attr">size</span>: imageInfo.<span class="hljs-property">size</span></li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 创建新的可编辑PixelMap对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">newPixelMap</span>: image.<span class="hljs-property">PixelMap</span> = image.<span class="hljs-title function_">createPixelMapSync</span>(buffer, options);</li><li>
</li><li>    <span class="hljs-comment">// 定义码图图片数据区域</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">area</span>: image.<span class="hljs-property">PositionArea</span> = {</li><li>      <span class="hljs-attr">pixels</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> * imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> * <span class="hljs-number">4</span>), <span class="hljs-comment">// 像素数据缓冲区</span></li><li>      <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 偏移量</span></li><li>      <span class="hljs-attr">stride</span>: imageInfo.<span class="hljs-property">stride</span>, <span class="hljs-comment">// 间距</span></li><li>      <span class="hljs-attr">region</span>: { <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>, <span class="hljs-attr">width</span>: imageInfo.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> }, <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> } <span class="hljs-comment">// 区域</span></li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 将区域数据转换为 Uint8Array</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">areaUint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(area.<span class="hljs-property">pixels</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">originalPixelMapUint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);</li><li>
</li><li>    <span class="hljs-comment">// 从backgroundColor中提取红、绿、蓝通道的值</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">redBg</span>: <span class="hljs-built_in">number</span> = (backgroundColor &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">greenBg</span>: <span class="hljs-built_in">number</span> = (backgroundColor &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">blueBg</span>: <span class="hljs-built_in">number</span> = backgroundColor &amp; <span class="hljs-number">0xFF</span>;</li><li>
</li><li>    <span class="hljs-comment">// 遍历像素</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; originalPixelMapUint8Array.<span class="hljs-property">length</span>; i += <span class="hljs-number">4</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">red</span>: <span class="hljs-built_in">number</span> = originalPixelMapUint8Array[i];</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">green</span>: <span class="hljs-built_in">number</span> = originalPixelMapUint8Array[i + <span class="hljs-number">1</span>];</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">blue</span>: <span class="hljs-built_in">number</span> = originalPixelMapUint8Array[i + <span class="hljs-number">2</span>];</li><li>
</li><li>      <span class="hljs-comment">// 检查像素是否为背景色</span></li><li>      <span class="hljs-keyword">if</span> (red === redBg &amp;&amp; green === greenBg &amp;&amp; blue === blueBg) {</li><li>        areaUint8Array[i] = blue;</li><li>        areaUint8Array[i  + <span class="hljs-number">1</span>] = green;</li><li>        areaUint8Array[i + <span class="hljs-number">2</span>] = red;</li><li>        areaUint8Array[i + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 设置透明色</span></li><li>      } <span class="hljs-keyword">else</span> {</li><li>        areaUint8Array[i] = blue;</li><li>        areaUint8Array[i  + <span class="hljs-number">1</span>] = green;</li><li>        areaUint8Array[i + <span class="hljs-number">2</span>] = red;</li><li>        areaUint8Array[i + <span class="hljs-number">3</span>] = originalPixelMapUint8Array[i + <span class="hljs-number">3</span>]; <span class="hljs-comment">// 保留原透明度</span></li><li>      }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 写入新像素数据</span></li><li>    <span class="hljs-keyword">await</span> newPixelMap.<span class="hljs-title function_">writePixels</span>(area);</li><li>
</li><li>    <span class="hljs-comment">// 返回新的PixelMap对象</span></li><li>    <span class="hljs-keyword">return</span> newPixelMap;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">'CreateBarcode'</span>, <span class="hljs-string">`Failed to convertBackgroundColorToTransparent. Code: <span class="hljs-subst">${error.code}</span>.`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div></div></div>