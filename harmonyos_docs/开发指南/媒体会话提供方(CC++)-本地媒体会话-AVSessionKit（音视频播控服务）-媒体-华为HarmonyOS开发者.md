<h1 _ngcontent-jqt-c119="" class="doc-title ng-star-inserted" title="媒体会话提供方(C/C++)"> 媒体会话提供方(C/C++) </h1>

<div _ngcontent-jqt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>OHAVSession系统提供的通过使用C API实现媒体会话提供方，从而在媒体会话控制方（例如播控中心）中展示媒体相关信息，及响应媒体会话控制方下发的播控命令。</p>    <div class="tiledSection">     <h2 id="使用入门">使用入门<i class="anchor-icon anchor-icon-link" anchorid="使用入门" tips="复制节点链接"></i></h2>          <p>开发者要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsession-h" target="_blank">OHAVSession</a>实现媒体会话，需要添加对应的头文件。</p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libohavsession.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="添加头文件">添加头文件<i class="anchor-icon anchor-icon-link" anchorid="添加头文件" tips="复制节点链接"></i></h3>          <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/av_session/native_avmetadata.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/av_session/native_avsession.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/av_session/native_avsession_errors.h&gt;</span></span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <p>开发者可以通过以下几个步骤在NDK接入本地会话。</p>     <ol>      <li>       <p>创建会话并激活媒体，需要传入会话类型AVSession_Type，自定义的TAG，以及应用的包名、ability名字。</p>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>OH_AVSession* avsession;</li><li><span class="hljs-built_in">OH_AVSession_Create</span>(SESSION_TYPE_AUDIO, "testsession", "com.example.application",   "MainAbility", &amp;avsession);</li><li><span class="hljs-built_in">OH_AVSession_Activate</span>(avsession);</li></ol></pre></div></div>       <p>AVSession_Type包含如下四种类型：</p>       <ul>        <li>SESSION_TYPE_AUDIO</li>        <li>SESSION_TYPE_VIDEO</li>        <li>SESSION_TYPE_VOICE_CALL</li>        <li>SESSION_TYPE_VIDEO_CALL</li>       </ul></li>      <li>       <p>应用内播放对应的媒体资源时，同步设置媒体元数据信息。</p>       <p>要设置元数据，需使用OH_AVMetadataBuilder构造具体的数据，生成一个OH_AVMetadata。生成OH_AVMetadata后，使用OH_AVMetadata的各个功能接口进行资源的设置。</p>       <p>使用OH_AVMetadataBuilder构造元数据示例：</p>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//创建OH_AVMetadataBuilder构造器。</span></li><li>OH_AVMetadataBuilder* builder;</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_Create</span>(&amp;builder);</li><li>
</li><li>OH_AVMetadata* ohMetadata;</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetTitle</span>(builder, "Anonymous title");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetArtist</span>(builder, "Anonymous artist");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetAuthor</span>(builder, "Anonymous author");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetAlbum</span>(builder, "Anonymous album");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetWriter</span>(builder, "Anonymous writer");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetComposer</span>(builder, "Anonymous composer");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetDuration</span>(builder, <span class="hljs-number">3600</span>);</li><li><span class="hljs-comment">// MediaImageUri只支持网络地址。</span></li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetMediaImageUri</span>(builder, "https://xxx.xxx.xx");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetSubtitle</span>(builder, "Anonymous subtitle");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetDescription</span>(builder, "For somebody");</li><li><span class="hljs-comment">// Lyric只支持媒体歌词内容（应用需将歌词内容拼接为一个字符串传入）。</span></li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetLyric</span>(builder, "balabala");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetAssetId</span>(builder, "<span class="hljs-number">000</span>");</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetSkipIntervals</span>(builder, SECONDS_30);</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_SetDisplayTags</span>(builder,  AVSESSION_DISPLAYTAG_AUDIO_VIVID);</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * generate an AVMetadata 构造AVMetadata对象</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-built_in">OH_AVMetadataBuilder_GenerateAVMetadata</span>(builder, &amp;ohMetadata);</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * set AVMetadata 设置AVMetadata对象</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-built_in">OH_AVSession_SetAVMetadata</span>(avsession, ohMetadata);</li></ol></pre></div></div>       <p>在不使用AVMetadata之后，开发者应该执行OH_AVMetadataBuilder_Destroy接口来销毁元数据，且不要继续使用。</p>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVMetadata_Destroy</span>(ohMetadata);</li><li><span class="hljs-built_in">OH_AVMetadataBuilder_Destroy</span>(builder);</li></ol></pre></div></div></li>      <li>       <p>跟随媒体播放状态的变化，及时更新媒体播放状态。</p>       <p>媒体播放状态，包含状态值、播放位置、播放速度、收藏状态等，可以按需使用对应的接口进行设置。</p>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">AVSession_ErrCode</span> ret = <span class="hljs-built_in">AV_SESSION_ERR_SUCCESS</span>;</li><li>
</li><li><span class="hljs-comment">// 设置播放状态，其中state范围应为[0,11]。</span></li><li><span class="hljs-built_in">AVSession_PlaybackState</span> state = PLAYBACK_STATE_PREPARING;</li><li>ret = OH_AVSession_SetPlaybackState(avsession, state);</li><li>
</li><li><span class="hljs-comment">// 设置播放位置。</span></li><li><span class="hljs-built_in">AVSession_PlaybackPosition</span>* playbackPosition = new  <span class="hljs-built_in">AVSession_PlaybackPosition</span>;</li><li>playbackPosition-&gt;elapsedTime = <span class="hljs-number">1000</span>;</li><li>playbackPosition-&gt;updateTime = <span class="hljs-number">16111150</span>;</li><li>ret = OH_AVSession_SetPlaybackPosition(avsession, playbackPosition);</li></ol></pre></div></div></li>      <li>       <p>注册播控命令事件监听，便于响应用户通过媒体会话控制方，例如播控中心下发的播控命令。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>媒体会话提供方在注册相关固定播控命令事件监听时，监听的事件会在媒体会话控制方的getValidCommands()方法中体现，即媒体会话控制方认为该方法有效，因此在需要时会触发相应的事件。为了保证媒体会话控制方下发的播控命令可以被正常执行，媒体会话提供方请勿进行无逻辑的空实现监听。</p>         <p>调用注册接口后，在业务结束时需要调用取消注册接口，避免出现异常。</p>        </div></div></div>       <p>Session侧目前支持的播控命令包括：</p>       <ul>        <li>播放</li>        <li>暂停</li>        <li>停止</li>        <li>上一首</li>        <li>下一首</li>        <li>快退</li>        <li>快进</li>        <li>设置进度</li>        <li>设置收藏</li>       </ul>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置播放/暂停/停止/上一首/下一首回调。</span></li><li><span class="hljs-comment">// CONTROL_CMD_PLAY = 0; 播放。</span></li><li><span class="hljs-comment">// CONTROL_CMD_PAUSE = 1; 暂停。</span></li><li><span class="hljs-comment">// CONTROL_CMD_STOP = 2;  停止。</span></li><li><span class="hljs-comment">// CONTROL_CMD_PLAY_NEXT = 3; 下一首。</span></li><li><span class="hljs-comment">// CONTROL_CMD_PLAY_PREVIOUS = 4; 上一首。</span></li><li><span class="hljs-built_in">AVSession_ControlCommand</span> command = CONTROL_CMD_PLAY;</li><li>OH_AVSessionCallback_OnCommand commandCallback = [](OH_AVSession* session, <span class="hljs-built_in">AVSession_ControlCommand</span> command,</li><li>    <span class="hljs-type">void</span>* userData) -&gt; <span class="hljs-built_in">AVSessionCallback_Result</span></li><li>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVSESSION_CALLBACK_RESULT_SUCCESS</span>;</li><li>};</li><li>OH_AVSession_RegisterCommandCallback(avsession, command, commandCallback, (<span class="hljs-type">void</span> *)(&amp;userData));</li><li>
</li><li><span class="hljs-comment">//设置快进回调。</span></li><li>OH_AVSessionCallback_OnFastForward fastForwardCallback = [](OH_AVSession* session, uint32_t seekTime,</li><li>    <span class="hljs-type">void</span>* userData) -&gt; <span class="hljs-built_in">AVSessionCallback_Result</span></li><li>{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVSESSION_CALLBACK_RESULT_SUCCESS</span>;</li><li>};</li><li>OH_AVSession_RegisterForwardCallback(avsession, fastForwardCallback, (<span class="hljs-type">void</span> *)(&amp;userData));</li></ol></pre></div></div>       <p>相关回调接口如下：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.5.3.4.7.1.3.1.1" valign="top" width="50%">接口</th>           <th align="left" class="cellrowborder" id="mcps1.3.5.3.4.7.1.3.1.2" valign="top" width="50%">说明</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVSession_RegisterCommandCallback(OH_AVSession* avsession, AVSession_ControlCommand command, OH_AVSessionCallback_OnCommand callback, void* userData)</td>           <td class="cellrowborder" valign="top" width="50%">注册通用播控的回调，支持：播放、暂停、停止、上一首、下一首回调。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVSession_RegisterForwardCallback(OH_AVSession* avsession, OH_AVSessionCallback_OnFastForward callback, void* userData)</td>           <td class="cellrowborder" valign="top" width="50%">注册快进的回调。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVSession_RegisterRewindCallback(OH_AVSession* avsession, OH_AVSessionCallback_OnRewind callback, void* userData)</td>           <td class="cellrowborder" valign="top" width="50%">注册快退的回调。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVSession_RegisterSeekCallback(OH_AVSession* avsession, OH_AVSessionCallback_OnSeek callback, void* userData)</td>           <td class="cellrowborder" valign="top" width="50%">注册跳转的回调。</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">OH_AVSession_RegisterToggleFavoriteCallback(OH_AVSession* avsession, OH_AVSessionCallback_OnToggleFavorite callback, void* userData)</td>           <td class="cellrowborder" valign="top" width="50%">注册收藏的回调。</td>          </tr>                 </tbody></table></div>       </div></li>      <li>       <p>音视频应用在退出，并且不需要继续播放时，及时取消监听以及销毁媒体会话释放资源。示例代码如下所示：</p>       <div _ngcontent-jqt-c106="" class="highlight-div"><div _ngcontent-jqt-c106="" class="highlight-div-header"><div _ngcontent-jqt-c106="" class="highlight-div-header-left"><div _ngcontent-jqt-c106="" class="handle-button expand-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jqt-c106="" class="highlight-div-header-right"><div _ngcontent-jqt-c106="" class="handle-button ai-button"></div><div _ngcontent-jqt-c106="" class="handle-button line-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jqt-c106="" class="handle-button theme-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jqt-c106="" class="handle-button copy-button"><div _ngcontent-jqt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jqt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_AVSession_Destroy</span>(avsession);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>