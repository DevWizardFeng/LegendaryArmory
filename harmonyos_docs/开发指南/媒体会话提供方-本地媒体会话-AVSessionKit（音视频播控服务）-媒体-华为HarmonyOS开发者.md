<h1 _ngcontent-kgf-c119="" class="doc-title ng-star-inserted" title="媒体会话提供方"> 媒体会话提供方 </h1>

<div _ngcontent-kgf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>音视频应用在实现音视频功能的同时，需要作为媒体会话提供方接入媒体会话，在媒体会话控制方（例如播控中心）中展示媒体相关信息，并响应媒体会话控制方下发的播控命令。</p>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>媒体会话元数据（AVMetadata）： 用于描述媒体数据相关属性，包含标识当前媒体的ID（assetId），上一首媒体的ID（previousAssetId），下一首媒体的ID（nextAssetId），标题（title），专辑作者（author），专辑名称（album），词作者（writer），媒体时长（duration）等属性。</p></li>      <li>       <p>媒体播放状态（AVPlaybackState）：用于描述媒体播放状态的相关属性，包含当前媒体的播放状态（state）、播放位置（position）、播放倍速（speed）、缓冲时间（bufferedTime）、循环模式（loopMode）、是否收藏（isFavorite）、正在播放的媒体Id（activeItemId）、自定义媒体数据（extras）等属性。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>媒体会话提供方使用的关键接口如下表所示。接口返回值有两种返回形式：callback和promise，下表中为callback形式接口，promise和callback只是返回值方式不一样，功能相同。</p>     <p>更多API说明请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession" target="_blank">API文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">createAVSession(context: Context, tag: string, type: AVSessionType, callback: AsyncCallback&lt;AVSession&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">          <p>创建媒体会话。</p>          <p>一个UIAbility只能存在一个媒体会话，重复创建会失败。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setAVMetadata(data: AVMetadata, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置媒体会话元数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setAVPlaybackState(state: AVPlaybackState, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置媒体会话播放状态。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setLaunchAbility(ability: WantAgent, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置启动UIAbility。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getController(callback: AsyncCallback&lt;AVSessionController&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">获取当前会话自身控制器。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getOutputDevice(callback: AsyncCallback&lt;OutputDeviceInfo&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">获取播放设备相关信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">activate(callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">激活媒体会话。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">deactivate(callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">禁用当前会话。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">destroy(callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">销毁媒体会话。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setAVQueueItems(items: Array&lt;AVQueueItem&gt;, callback: AsyncCallback&lt;void&gt;): void <sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置媒体播放列表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setAVQueueTitle(title: string, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置媒体播放列表名称。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">dispatchSessionEvent(event: string, args: {[key: string]: Object}, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置会话内自定义事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setExtras(extras: {[key: string]: Object}, callback: AsyncCallback&lt;void&gt;): void<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">设置键值对形式的自定义媒体数据包。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getOutputDeviceSync(): OutputDeviceInfo<sup>10+</sup></td>         <td class="cellrowborder" valign="top" width="50%">使用同步方法获取当前输出设备信息。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>音视频应用作为媒体会话提供方接入媒体会话的基本步骤如下所示：</p>     <ol>      <li>       <p>通过AVSessionManager的方法创建并激活媒体会话。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>以下示例代码仅展示创建AVSession对象的接口调用，应用在真正使用时，需要确保AVSession对象实例在应用后台播放业务活动期间一直存在，避免被系统回收、释放，导致后台发声时被系统管控。</p>        </div></div></div>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// 开始创建并激活媒体会话。</span></li><li>            <span class="hljs-comment">// 创建session。</span></li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>            <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>            <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">activate</span>();</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`session create done : sessionId : <span class="hljs-subst">${session.sessionId}</span>`</span>);</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVSession create Error: Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            }</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>跟随媒体信息的变化，及时设置媒体会话信息。需要设置的媒体会话信息主要包括：</p>       <ul>        <li>媒体会话元数据AVMetadata。</li>        <li>媒体播放状态AVPlaybackState。</li>       </ul>       <p>音视频应用设置的媒体会话信息，会被媒体会话控制方通过AVSessionController相关方法获取后进行显示或处理。</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-string">'audio'</span>);</li><li>          <span class="hljs-comment">// 播放器逻辑··· 引发媒体信息与播放状态的变更。</span></li><li>          <span class="hljs-comment">// 设置必要的媒体信息。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVMetadata</span> = {</li><li>            <span class="hljs-attr">assetId</span>: <span class="hljs-string">'0'</span>, <span class="hljs-comment">// 由应用指定，用于标识应用媒体库里的媒体。</span></li><li>            <span class="hljs-attr">title</span>: <span class="hljs-string">'TITLE'</span>,</li><li>            <span class="hljs-attr">mediaImage</span>: <span class="hljs-string">'IMAGE'</span>,</li><li>            <span class="hljs-attr">artist</span>: <span class="hljs-string">'ARTIST'</span></li><li>          };</li><li>          session.<span class="hljs-title function_">setAVMetadata</span>(metadata).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SetAVMetadata successfully`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set AVMetadata. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>          <span class="hljs-comment">// 简单设置一个播放状态 - 暂停 未收藏。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">playbackState</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVPlaybackState</span> = {</li><li>            <span class="hljs-attr">state</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">PlaybackState</span>.<span class="hljs-property">PLAYBACK_STATE_PAUSE</span>,</li><li>            <span class="hljs-attr">isFavorite</span>: <span class="hljs-literal">false</span></li><li>          };</li><li>          session.<span class="hljs-title function_">setAVPlaybackState</span>(playbackState, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set AVPlaybackState. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SetAVPlaybackState successfully`</span>);</li><li>            }</li><li>          });</li><li>          <span class="hljs-comment">// 设置一个播放列表。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">queueItemDescription_1</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVMediaDescription</span> = {</li><li>            <span class="hljs-attr">assetId</span>: <span class="hljs-string">'001'</span>,</li><li>            <span class="hljs-attr">title</span>: <span class="hljs-string">'music_name'</span>,</li><li>            <span class="hljs-attr">subtitle</span>: <span class="hljs-string">'music_sub_name'</span>,</li><li>            <span class="hljs-attr">description</span>: <span class="hljs-string">'music_description'</span>,</li><li>            <span class="hljs-attr">mediaImage</span>: <span class="hljs-string">"PIXELMAP_OBJECT"</span>,</li><li>            <span class="hljs-attr">extras</span>: { <span class="hljs-string">'extras'</span>: <span class="hljs-string">'any'</span> }</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">queueItem_1</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVQueueItem</span> = {</li><li>            <span class="hljs-attr">itemId</span>: <span class="hljs-number">1</span>,</li><li>            <span class="hljs-attr">description</span>: queueItemDescription_1</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">queueItemDescription_2</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVMediaDescription</span> = {</li><li>            <span class="hljs-attr">assetId</span>: <span class="hljs-string">'002'</span>,</li><li>            <span class="hljs-attr">title</span>: <span class="hljs-string">'music_name'</span>,</li><li>            <span class="hljs-attr">subtitle</span>: <span class="hljs-string">'music_sub_name'</span>,</li><li>            <span class="hljs-attr">description</span>: <span class="hljs-string">'music_description'</span>,</li><li>            <span class="hljs-attr">mediaImage</span>: <span class="hljs-string">"PIXELMAP_OBJECT"</span>,</li><li>            <span class="hljs-attr">extras</span>: { <span class="hljs-string">'extras'</span>: <span class="hljs-string">'any'</span> }</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">queueItem_2</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVQueueItem</span> = {</li><li>            <span class="hljs-attr">itemId</span>: <span class="hljs-number">2</span>,</li><li>            <span class="hljs-attr">description</span>: queueItemDescription_2</li><li>          };</li><li>          <span class="hljs-keyword">let</span> queueItemsArray = [queueItem_1, queueItem_2];</li><li>          session.<span class="hljs-title function_">setAVQueueItems</span>(queueItemsArray).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SetAVQueueItems successfully`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set AVQueueItem, error code: <span class="hljs-subst">${err.code}</span>, error message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>          <span class="hljs-comment">// 设置媒体播放列表名称。</span></li><li>          <span class="hljs-keyword">let</span> queueTitle = <span class="hljs-string">'QUEUE_TITLE'</span>;</li><li>          session.<span class="hljs-title function_">setAVQueueTitle</span>(queueTitle).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SetAVQueueTitle successfully`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set AVQueueTitle, error code: <span class="hljs-subst">${err.code}</span>, error message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置用于被媒体会话控制方拉起的UIAbility。当用户操作媒体会话控制方的界面时，例如点击播控中心的卡片，可以拉起此处配置的UIAbility。</p>       <p>设置UIAbility时通过WantAgent接口实现，更多关于WantAgent的信息请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantagent" target="_blank">WantAgent</a>。</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { wantAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>        <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>        <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">wantAgentInfo</span>: wantAgent.<span class="hljs-property">WantAgentInfo</span> = {</li><li>            <span class="hljs-attr">wants</span>: [</li><li>            {</li><li>                <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.musicdemo'</span>,</li><li>                <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'MainAbility'</span></li><li>            }</li><li>            ],</li><li>            <span class="hljs-comment">// OperationType.START_ABILITIES</span></li><li>            <span class="hljs-attr">operationType</span>: <span class="hljs-number">2</span>,</li><li>            <span class="hljs-attr">requestCode</span>: <span class="hljs-number">0</span>,</li><li>            <span class="hljs-attr">wantAgentFlags</span>: [wantAgent.<span class="hljs-property">WantAgentFlags</span>.<span class="hljs-property">UPDATE_PRESENT_FLAG</span>]</li><li>        }</li><li>        wantAgent.<span class="hljs-title function_">getWantAgent</span>(wantAgentInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">agent</span>) =&gt;</span> {</li><li>            session.<span class="hljs-title function_">setLaunchAbility</span>(agent);</li><li>        })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>}</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置一个即时的自定义会话事件，以供媒体控制方接收到事件后进行相应的操作。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>通过dispatchSessionEvent方法设置的数据不会保存在会话对象或AVSession服务中。</p>        </div></div></div>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>          <span class="hljs-keyword">let</span> eventName = <span class="hljs-string">'dynamic_lyric'</span>;</li><li>          <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">dispatchSessionEvent</span>(eventName, { <span class="hljs-attr">lyric</span>: <span class="hljs-string">'This is my lyric'</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Dispatch session event successfully`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to dispatch session event. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置与当前会话相关的自定义媒体数据包，以供媒体控制方接收到事件后进行相应的操作。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>通过setExtras方法设置的数据包会被存储在AVSession服务中，数据的生命周期与会话一致；会话对应的Controller可以使用getExtras来获取该数据。</p>        </div></div></div>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>          <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">setExtras</span>({ <span class="hljs-attr">extra</span>: <span class="hljs-string">'This is my custom media packet'</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Set extras successfully`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set extras. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>注册播控命令事件监听，便于响应用户通过媒体会话控制方，例如播控中心，下发的播控命令。</p>       <p>在Session侧注册的监听分为固定播控命令和高级播控事件两种。</p>       <p>6.1 固定控制命令的监听</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>媒体会话提供方在注册相关固定播控命令事件监听时，监听的事件会在媒体会话控制方的getValidCommands()方法中体现，即媒体会话控制方会认为对应的方法有效，进而根据需要触发相应暂不使用时的事件。为了保证媒体会话控制方下发的播控命令可以被正常执行，媒体会话提供方请勿进行无逻辑的空实现监听。</p>        </div></div></div>       <p>Session侧的固定播控命令主要包括播放、暂停、上一首、下一首等基础操作命令，详细介绍请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-i#avcontrolcommand10" target="_blank">AVControlCommand</a>。</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>          <span class="hljs-comment">// 一般在监听器中会对播放器做相应逻辑处理。</span></li><li>          <span class="hljs-comment">// 不要忘记处理完后需要通过set接口同步播放相关信息，参考上面的用例。</span></li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'play'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on play , do play task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('play')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'pause'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on pause , do pause task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('pause')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stop'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on stop , do stop task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('stop')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playNext'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on playNext , do playNext task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('playNext')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态，使用SetAVMetadata上报媒体信息。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playPrevious'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on playPrevious , do playPrevious task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('playPrevious')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态，使用SetAVMetadata上报媒体信息。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'fastForward'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on fastForward , do fastForward task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('fastForward')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态和播放position。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'rewind'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on rewind , do rewind task`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('rewind')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态和播放position。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seek'</span>, <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on seek , the seek time is <span class="hljs-subst">${time}</span>`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('seek')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报播放状态和播放position。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'setSpeed'</span>, <span class="hljs-function">(<span class="hljs-params">speed</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on setSpeed , the speed is <span class="hljs-subst">${speed}</span>`</span>);</li><li>            <span class="hljs-comment">// 实现具体功能。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'setLoopMode'</span>, <span class="hljs-function">(<span class="hljs-params">mode</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on setLoopMode , the loop mode is <span class="hljs-subst">${mode}</span>`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('setLoopMode')取消监听。</span></li><li>            <span class="hljs-comment">// 应用自定下一个模式，处理完毕后，请使用SetAVPlaybackState上报切换后的LoopMode。</span></li><li>          });</li><li>          session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'toggleFavorite'</span>, <span class="hljs-function">(<span class="hljs-params">assetId</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on toggleFavorite , the target asset Id is <span class="hljs-subst">${assetId}</span>`</span>);</li><li>            <span class="hljs-comment">// 如暂不支持该指令，请勿注册；或在注册后但暂不使用时，通过session.off('toggleFavorite')取消监听。</span></li><li>            <span class="hljs-comment">// 处理完毕后，请使用SetAVPlaybackState上报收藏结果isFavorite。</span></li><li>          });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>6.2 高级播控事件的监听</p>       <p>Session侧的可以注册的高级播控事件主要包括：</p>       <ul>        <li>skipToQueueItem: 播放列表其中某项被选中的事件。</li>        <li>handleKeyEvent: 按键事件。</li>        <li>outputDeviceChange: 播放设备变化的事件。</li>        <li>commonCommand: 自定义控制命令变化的事件。</li>       </ul>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>            <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>            <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>            <span class="hljs-comment">// 一般在监听器中会对播放器做相应逻辑处理。</span></li><li>            <span class="hljs-comment">// 不要忘记处理完后需要通过set接口同步播放相关信息，参考上面的用例。</span></li><li>            session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'skipToQueueItem'</span>, <span class="hljs-function">(<span class="hljs-params">itemId</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on skipToQueueItem , do skip task`</span>);</li><li>              <span class="hljs-comment">// 实现具体功能。</span></li><li>            });</li><li>            session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'handleKeyEvent'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on handleKeyEvent , the event is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(event)}</span>`</span>);</li><li>              <span class="hljs-comment">// 实现具体功能。</span></li><li>            });</li><li>            session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'outputDeviceChange'</span>, <span class="hljs-function">(<span class="hljs-params">device</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on outputDeviceChange , the device info is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(device)}</span>`</span>);</li><li>              <span class="hljs-comment">// 实现具体功能。</span></li><li>            });</li><li>            session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'commonCommand'</span>, <span class="hljs-function">(<span class="hljs-params">commandString, args</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`on commonCommand , command is <span class="hljs-subst">${commandString}</span>, args are <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);</li><li>              <span class="hljs-comment">// 实现具体功能。</span></li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVSession create Error: Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            }</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取当前媒体会话自身的控制器，与媒体会话对应进行通信交互。</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>            <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>            <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>  </li><li>            <span class="hljs-comment">// 通过已有session获取一个controller对象。</span></li><li>            <span class="hljs-keyword">let</span> controller = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getController</span>();</li><li>  </li><li>            <span class="hljs-comment">// controller可以与原session对象进行基本的通信交互，比如下发播放命令。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">avCommand</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVControlCommand</span> = { <span class="hljs-attr">command</span>: <span class="hljs-string">'play'</span> };</li><li>            controller.<span class="hljs-title function_">sendControlCommand</span>(avCommand);</li><li>            </li><li>            <span class="hljs-comment">// 或者做状态变更监听。</span></li><li>            controller.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {</li><li>  </li><li>              <span class="hljs-comment">// do some things.</span></li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`AVSession create or getController Error: Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            }</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>音视频应用在退出，并且不需要继续播放时，及时取消监听以及销毁媒体会话释放资源。</p>       <p>取消播控命令监听的示例代码如下所示 ：</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>
</li><li>          <span class="hljs-comment">// 取消指定session下的相关监听。</span></li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'play'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'pause'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stop'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'playNext'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'playPrevious'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'skipToQueueItem'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'handleKeyEvent'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'outputDeviceChange'</span>);</li><li>          session.<span class="hljs-title function_">off</span>(<span class="hljs-string">'commonCommand'</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>销毁媒体会话示例代码如下所示：</p>       <div _ngcontent-kgf-c106="" class="highlight-div"><div _ngcontent-kgf-c106="" class="highlight-div-header"><div _ngcontent-kgf-c106="" class="highlight-div-header-left"><div _ngcontent-kgf-c106="" class="handle-button expand-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kgf-c106="" class="highlight-div-header-right"><div _ngcontent-kgf-c106="" class="handle-button ai-button"></div><div _ngcontent-kgf-c106="" class="handle-button line-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kgf-c106="" class="handle-button theme-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kgf-c106="" class="handle-button copy-button"><div _ngcontent-kgf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kgf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession <span class="hljs-keyword">as</span> <span class="hljs-title class_">AVSessionManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello world'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-comment">// 假设已经创建了一个session，如何创建session可以参考之前的案例。</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">type</span>: <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-property">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AVSessionManager</span>.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>          <span class="hljs-comment">// 主动销毁已创建的session。</span></li><li>          session.<span class="hljs-title function_">destroy</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to destroy session. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Destroy : SUCCESS `</span>);</li><li>            }</li><li>          });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>