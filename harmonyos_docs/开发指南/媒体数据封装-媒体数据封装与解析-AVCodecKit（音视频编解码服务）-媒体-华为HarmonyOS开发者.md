<h1 _ngcontent-hjl-c119="" class="doc-title ng-star-inserted" title="媒体数据封装"> 媒体数据封装 </h1>

<div _ngcontent-hjl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以调用本模块的Native API接口，完成音视频封装，即将音频、视频等编码后的媒体数据，按一定的格式存储到文件里。</p>    <p>当前支持的封装能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#媒体数据封装">AVCodec支持的格式</a>。</p>    <p>如果需要对HDRVivid视频码流进行封装，需要配置MimeType为H265 (OH_AVCODEC_MIMETYPE_VIDEO_HEVC)，本功能从API version 11开始支持。</p>    <p><strong>适用场景</strong></p>    <ul>     <li>      <p>录像、录音</p>      <p>保存录像、录音文件时，需要先对音视频流进行编码，再封装为文件。</p></li>     <li>      <p>音视频编辑</p>      <p>完成编辑后的音视频，需要封装为文件。</p></li>     <li>      <p>音视频转码</p>      <p>转码后，保存文件时需要封装。</p></li>    </ul>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avmuxer-h" target="_blank">API文档</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>如果调用封装模块写本地文件，需要<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>：ohos.permission.READ_MEDIA, ohos.permission.WRITE_MEDIA。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avmuxer.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，完成音视频封装的全流程。以封装mp4格式的音视频文件为例。</p>     <p>不同的封装格式需要配置的key请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#媒体数据封装">AVCodec支持的格式</a>。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avmuxer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>调用OH_AVMuxer_Create()创建封装器实例对象。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置封装格式为mp4。</span></li><li><span class="hljs-type">OH_AVOutputFormat</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> AV_OUTPUT_FORMAT_MPEG_4;</li><li><span class="hljs-comment">// 以读写方式创建fd。</span></li><li><span class="hljs-type">int32_t</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> open(<span class="hljs-string">"test.mp4"</span>, O_CREAT | O_RDWR | O_TRUNC, S_IRUSR | S_IWUSR);</li><li>OH_AVMuxer *muxer = OH_AVMuxer_Create(fd, format);</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AVMuxer_SetRotation()设置旋转角度。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 旋转角度，视频画面需要旋转的时候设置。</span></li><li><span class="hljs-built_in">OH_AVMuxer_SetRotation</span>(muxer, <span class="hljs-number">0</span>);</li></ol></pre></div></div></li>      <li>       <p>添加文件级数据。</p>       <p>文件级数据已定义的key详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#媒体数据封装">AVCodec支持的格式</a>。</p>       <p>用户自定义的key必须以"com.openharmony."为开头。值类型可以为int32_t、float、string，从API20开始增加支持uint8_t*。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>已定义的key必须在OH_AVMuxer_Start()前设置，用户自定义的key可以在OH_AVMuxer_Stop()前设置。</p>        </div></div></div>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create(); <span class="hljs-regexp">//</span> 用OH_AVFormat_Create创建<span class="hljs-keyword">format</span>。</li><li>
</li><li>// 设置已定义的key。</li><li>OH_AVFormat_SetStringValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_CREATION_TIME, <span class="hljs-string">"2024-12-28T00:00:00:000000Z"</span>); <span class="hljs-regexp">//</span> 从API14开始支持设置创建时间（使用ISO <span class="hljs-number">8601</span>标准的时间格式且为UTC时间）。</li><li>OH_AVFormat_SetStringValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_COMMENT, <span class="hljs-string">"comment test"</span>); <span class="hljs-regexp">//</span> 从API2<span class="hljs-number">0</span>开始支持设置评论。值类型为string。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_ENABLE_MOOV_FRONT, <span class="hljs-number">1</span>); <span class="hljs-regexp">//</span> 从API2<span class="hljs-number">0</span>开始支持设置moov元数据是否前置。默认值为<span class="hljs-number">0</span>，设置<span class="hljs-number">1</span>代表前置。</li><li>
</li><li>// 设置用户自定义key（需要com.openharmony.开头）。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, <span class="hljs-string">"com.openharmony.testInt"</span>, <span class="hljs-number">1024</span>); <span class="hljs-regexp">//</span> 值类型为int32_t。</li><li>OH_AVFormat_SetFloatValue(<span class="hljs-keyword">format</span>, <span class="hljs-string">"com.openharmony.testFloat"</span>, <span class="hljs-number">1.024</span>); <span class="hljs-regexp">//</span> 值类型为float。</li><li>OH_AVFormat_SetStringValue(<span class="hljs-keyword">format</span>, <span class="hljs-string">"com.openharmony.testString"</span>, <span class="hljs-string">"string test"</span>); <span class="hljs-regexp">//</span> 值类型为string，长度不超过<span class="hljs-number">256</span>。</li><li>uint8_t testData[] = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};</li><li>OH_AVFormat_SetBuffer(<span class="hljs-keyword">format</span>, <span class="hljs-string">"com.openharmony.testBuffer"</span>, testData, sizeof(testData)); <span class="hljs-regexp">//</span> 从API2<span class="hljs-number">0</span>开始支持值类型为uint8_t*。</li><li>
</li><li><span class="hljs-keyword">int</span> ret = OH_AVMuxer_SetFormat(muxer, <span class="hljs-keyword">format</span>); <span class="hljs-regexp">//</span> 设置封装的<span class="hljs-keyword">format</span>。</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>   <span class="hljs-regexp">//</span> 设置<span class="hljs-keyword">format</span>失败，未找到有效待写入的key数据。</li><li>}</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>); <span class="hljs-regexp">//</span> 销毁。</li></ol></pre></div></div></li>      <li>       <p>添加音频轨。</p>       <p><strong>方法一：用OH_AVFormat_Create创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> audioTrackId = <span class="hljs-number">-1</span>;</li><li><span class="hljs-type">uint8_t</span> *buffer = ...; <span class="hljs-comment">// 编码config data，如果没有可以不传。</span></li><li><span class="hljs-type">size_t</span> size = ...;  <span class="hljs-comment">// 编码config data的长度，根据实际情况配置。</span></li><li>OH_AVFormat *formatAudio = <span class="hljs-built_in">OH_AVFormat_Create</span>(); <span class="hljs-comment">// 用OH_AVFormat_Create创建format，这里以封装44100Hz采样率、2声道的AAC-LC音频为例。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(formatAudio, OH_MD_KEY_CODEC_MIME, OH_AVCODEC_MIMETYPE_AUDIO_AAC); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_AUD_SAMPLE_RATE, <span class="hljs-number">44100</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_AUD_CHANNEL_COUNT, <span class="hljs-number">2</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_PROFILE, AAC_PROFILE_LC); <span class="hljs-comment">// 选填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetBuffer</span>(formatAudio, OH_MD_KEY_CODEC_CONFIG, buffer, size); <span class="hljs-comment">// 选填。</span></li><li>
</li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer, &amp;audioTrackId, formatAudio);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || audioTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 音频轨添加失败。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatAudio); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div>       <p><strong>方法二：用OH_AVFormat_CreateAudioFormat创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> audioTrackId = <span class="hljs-number">-1</span>;</li><li><span class="hljs-type">uint8_t</span> *buffer = ...; <span class="hljs-comment">// 编码config data，如果没有可以不传。</span></li><li><span class="hljs-type">size_t</span> size = ...;  <span class="hljs-comment">// 编码config data的长度，根据实际情况配置。</span></li><li>OH_AVFormat *formatAudio = <span class="hljs-built_in">OH_AVFormat_CreateAudioFormat</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-number">44100</span>, <span class="hljs-number">2</span>);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_PROFILE, AAC_PROFILE_LC); <span class="hljs-comment">// 选填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetBuffer</span>(formatAudio, OH_MD_KEY_CODEC_CONFIG, buffer, size); <span class="hljs-comment">// 选填。</span></li><li>
</li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer, &amp;audioTrackId, formatAudio);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || audioTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 音频轨添加失败。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatAudio); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div></li>      <li>       <p>添加视频轨。</p>       <p><strong>方法一：用OH_AVFormat_Create创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> videoTrackId = <span class="hljs-number">-1</span>;</li><li><span class="hljs-type">uint8_t</span> *buffer = ...; <span class="hljs-comment">// 编码config data，如果没有可以不传。</span></li><li><span class="hljs-type">size_t</span> size = ...;  <span class="hljs-comment">// 编码config data的长度，根据实际情况配置。</span></li><li>OH_AVFormat *formatVideo = <span class="hljs-built_in">OH_AVFormat_Create</span>();</li><li><span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(formatVideo, OH_MD_KEY_CODEC_MIME, OH_AVCODEC_MIMETYPE_VIDEO_AVC); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_WIDTH, <span class="hljs-number">1280</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_HEIGHT, <span class="hljs-number">720</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetBuffer</span>(formatVideo, OH_MD_KEY_CODEC_CONFIG, buffer, size); <span class="hljs-comment">// 非必须。</span></li><li>
</li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer, &amp;videoTrackId, formatVideo);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || videoTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 视频轨添加失败。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatVideo); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div>       <p><strong>方法二：用OH_AVFormat_CreateVideoFormat创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> videoTrackId = <span class="hljs-number">-1</span>;</li><li><span class="hljs-type">uint8_t</span> *buffer = ...; <span class="hljs-comment">// 编码config data，如果没有可以不传。</span></li><li><span class="hljs-type">size_t</span> size = ...;  <span class="hljs-comment">// 编码config data的长度，根据实际情况配置。</span></li><li>OH_AVFormat *formatVideo = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1280</span>, <span class="hljs-number">720</span>);</li><li><span class="hljs-built_in">OH_AVFormat_SetBuffer</span>(formatVideo, OH_MD_KEY_CODEC_CONFIG, buffer, size); <span class="hljs-comment">// 非必须。</span></li><li>
</li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer, &amp;videoTrackId, formatVideo);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || videoTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 视频轨添加失败。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatVideo); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div></li>      <li>       <p>添加辅助轨。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>设置OH_MD_KEY_TRACK_TYPE时，值为MEDIA_TYPE_AUXILIARY代表添加辅助轨。</p>         <p>设置OH_MD_KEY_TRACK_REFERENCE_TYPE时，值必须为"hint"、"cdsc"、"font"、"hind"、"vdep"、"vplx"、"subt"、"thmb"、"auxl"、"cdtg"、"shsc"或"aest"其中一项。</p>         <p>设置OH_MD_KEY_TRACK_DESCRIPTION时，值必须为"com.openharmony."开头且长度不超过256的字符串。</p>         <p>设置OH_MD_KEY_REFERENCE_TRACK_IDS时，track id值必须大于等于0，且必须是已经存在的track id。</p>        </div></div></div>       <p><strong>添加音频辅助轨</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">audioAuxlTrackId</span> = -<span class="hljs-number">1</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">int32_t</span>&gt; <span class="hljs-title class_">audioTrackIDsVector</span> = {<span class="hljs-number">0</span>}; <span class="hljs-comment">// 根据实际情况设置被辅助音频轨的编号，可填写多个值。</span></li><li><span class="hljs-variable">int32_t</span> *<span class="hljs-variable">audioAuxlTrackIDs</span> = <span class="hljs-variable">audioTrackIDsVector</span>.<span class="hljs-title function_">data</span>();</li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">audioAuxlFormat</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_CODEC_MIME</span>, <span class="hljs-variable">OH_AVCODEC_MIMETYPE_AUDIO_AAC</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_AUD_SAMPLE_RATE</span>, <span class="hljs-number">44100</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_AUD_CHANNEL_COUNT</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">AAC_PROFILE_LC</span>); <span class="hljs-comment">// 选填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_TYPE</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_MediaType</span>::<span class="hljs-title class_">MEDIA_TYPE_AUXILIARY</span>)); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_REFERENCE_TYPE</span>, <span class="hljs-string">"auxl"</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_DESCRIPTION</span>, <span class="hljs-string">"com.openharmony.audiomode.auxiliary"</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntBuffer</span>(<span class="hljs-variable">audioAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_REFERENCE_TRACK_IDS</span>, <span class="hljs-variable">audioAuxlTrackIDs</span>, <span class="hljs-variable">audioTrackIDsVector</span>.<span class="hljs-title function_">size</span>()); <span class="hljs-comment">// 必填。</span></li><li>
</li><li><span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVMuxer_AddTrack</span>(<span class="hljs-variable">muxer</span>, &amp;<span class="hljs-title class_">audioAuxlTrackId</span>, <span class="hljs-variable">audioAuxlFormat</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">audioAuxlTrackId</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 音频辅助轨添加失败。</span></li><li>}</li></ol></pre></div></div>       <p><strong>添加视频辅助轨</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">videoAuxlTrackId</span> = -<span class="hljs-number">1</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">int32_t</span>&gt; <span class="hljs-title class_">videoTrackIDsVector</span> = {<span class="hljs-number">0</span>}; <span class="hljs-comment">// 根据实际情况设置被辅助视频轨的编号，可填写多个值。</span></li><li><span class="hljs-variable">int32_t</span> *<span class="hljs-variable">videoAuxlTrackIDs</span> = <span class="hljs-variable">videoTrackIDsVector</span>.<span class="hljs-title function_">data</span>();</li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">videoAuxlFormat</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_CODEC_MIME</span>, <span class="hljs-variable">OH_AVCODEC_MIMETYPE_VIDEO_AVC</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-number">1280</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-number">720</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_TYPE</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_MediaType</span>::<span class="hljs-title class_">MEDIA_TYPE_AUXILIARY</span>)); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_REFERENCE_TYPE</span>, <span class="hljs-string">"vdep"</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetStringValue</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_TRACK_DESCRIPTION</span>, <span class="hljs-string">"com.openharmony.moviemode.depth"</span>); <span class="hljs-comment">// 必填。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntBuffer</span>(<span class="hljs-variable">videoAuxlFormat</span>, <span class="hljs-variable">OH_MD_KEY_REFERENCE_TRACK_IDS</span>, <span class="hljs-variable">videoAuxlTrackIDs</span>, <span class="hljs-variable">videoTrackIDsVector</span>.<span class="hljs-title function_">size</span>()); <span class="hljs-comment">// 必填。</span></li><li>
</li><li><span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVMuxer_AddTrack</span>(<span class="hljs-variable">muxer</span>, &amp;<span class="hljs-title class_">videoAuxlTrackId</span>, <span class="hljs-variable">videoAuxlFormat</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">videoAuxlTrackId</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 视频辅助轨添加失败。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>添加封面轨。</p>       <p><strong>方法一：用OH_AVFormat_Create创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> coverTrackId = <span class="hljs-number">-1</span>;</li><li>OH_AVFormat *formatCover = OH_AVFormat_Create();</li><li>OH_AVFormat_SetStringValue(formatCover, OH_MD_KEY_CODEC_MIME, OH_AVCODEC_MIMETYPE_IMAGE_JPG);</li><li>OH_AVFormat_SetIntValue(formatCover, OH_MD_KEY_WIDTH, <span class="hljs-number">1280</span>);</li><li>OH_AVFormat_SetIntValue(formatCover, OH_MD_KEY_HEIGHT, <span class="hljs-number">720</span>);</li><li>
</li><li><span class="hljs-type">int</span> ret = OH_AVMuxer_AddTrack(muxer, &amp;coverTrackId, formatCover);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span> || coverTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 添加封面失败。</span></li><li>}</li><li>OH_AVFormat_Destroy(formatCover); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div>       <p><strong>方法二：用OH_AVFormat_CreateVideoFormat创建format</strong></p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> coverTrackId = <span class="hljs-number">-1</span>;</li><li>OH_AVFormat *formatCover = OH_AVFormat_CreateVideoFormat(OH_AVCODEC_MIMETYPE_IMAGE_JPG, <span class="hljs-number">1280</span>, <span class="hljs-number">720</span>);</li><li>
</li><li><span class="hljs-type">int</span> ret = OH_AVMuxer_AddTrack(muxer, &amp;coverTrackId, formatCover);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span> || coverTrackId &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 添加封面失败。</span></li><li>}</li><li>OH_AVFormat_Destroy(formatCover); <span class="hljs-comment">// 销毁。</span></li></ol></pre></div></div></li>      <li>       <p>调用OH_AVMuxer_Start()开始封装。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用start，写封装文件头。start后，不能设置媒体参数、不能添加音视频轨。</span></li><li><span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">OH_AVMuxer_Start</span>(muxer) != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AVMuxer_WriteSampleBuffer()，写入封装数据。</p>       <p>封装数据包括视频、音频、封面等数据。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// start后，才能开始写入数据。</span></li><li><span class="hljs-type">int</span> size = ...;</li><li>OH_AVBuffer *sample = OH_AVBuffer_Create(size); <span class="hljs-comment">// 创建AVBuffer。</span></li><li><span class="hljs-comment">// 通过OH_AVBuffer_GetAddr(sample)往sampleBuffer里写入数据参考OH_AVBuffer的使用方法。</span></li><li><span class="hljs-comment">// 封装封面，必须一次写完一张图片。</span></li><li>
</li><li><span class="hljs-comment">// 创建buffer info。</span></li><li>OH_AVCodecBufferAttr info = {<span class="hljs-number">0</span>};</li><li>info.pts = ...; <span class="hljs-comment">// 当前数据的开始播放的时间，单位微秒，相对时间。</span></li><li>info.size = size; <span class="hljs-comment">// 当前数据的长度。</span></li><li>info.offset = <span class="hljs-number">0</span>; <span class="hljs-comment">// 偏移，一般为0。</span></li><li>info.flags |= <span class="hljs-built_in">AVCODEC_BUFFER_FLAGS_SYNC_FRAME</span>; <span class="hljs-comment">// 当前数据的标志。具体参考OH_AVCodecBufferFlags。</span></li><li>info.flags |= <span class="hljs-built_in">AVCODEC_BUFFER_FLAGS_CODEC_DATA</span>; <span class="hljs-comment">// 当annex-b格式的avc包含codec config的标志。</span></li><li>OH_AVBuffer_SetBufferAttr(sample, &amp;info); <span class="hljs-comment">// 设置buffer的属性。</span></li><li><span class="hljs-type">int</span> trackId = audioTrackId; <span class="hljs-comment">// 选择写的音视频轨。</span></li><li>
</li><li><span class="hljs-type">int</span> ret = OH_AVMuxer_WriteSampleBuffer(muxer, trackId, sample);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AVMuxer_Stop()，停止封装。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用stop，写封装文件尾。stop后不能写入媒体数据。</span></li><li><span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">OH_AVMuxer_Stop</span>(muxer) != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AVMuxer_Destroy()销毁实例，释放资源。</p>       <p>注意不能重复销毁，否则将会导致程序崩溃。</p>       <div _ngcontent-hjl-c106="" class="highlight-div"><div _ngcontent-hjl-c106="" class="highlight-div-header"><div _ngcontent-hjl-c106="" class="highlight-div-header-left"><div _ngcontent-hjl-c106="" class="handle-button expand-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hjl-c106="" class="highlight-div-header-right"><div _ngcontent-hjl-c106="" class="handle-button ai-button"></div><div _ngcontent-hjl-c106="" class="handle-button line-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hjl-c106="" class="handle-button theme-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hjl-c106="" class="handle-button copy-button"><div _ngcontent-hjl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hjl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (OH_AVMuxer_Destroy(muxer) != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>muxer = <span class="hljs-literal">NULL</span>;</li><li>close(fd); <span class="hljs-comment">// 关闭文件描述符。</span></li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>