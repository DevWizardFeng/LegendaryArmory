<h1 _ngcontent-ecu-c119="" class="doc-title ng-star-inserted" title="安全单元访问开发指南"> 安全单元访问开发指南 </h1>

<div _ngcontent-ecu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>电子设备上可能存在一个或多个安全单元（SecureElement，简称SE），比如有eSE(Embedded SE)和SIM卡。安全单元的访问控制，通过GPAC（GlobalPlatform Access Control）规范实现。</p>    </div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>应用程序可以通过接口访问安全单元，比如往安全单元里面写入数据，实现在电子设备上模拟一张NFC卡片的目的。该卡片数据可能存储在eSE安全单元，或在SIM卡安全单元上。安全单元上一般会预置有访问控制规则，应用程序需要具备对应的权限，也就是通过安全单元的访问控制权限校验之后，才能正常访问安全单元。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>安全单元完整的API说明以及示例代码请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-secureelement" target="_blank">安全单元接口</a>。</p>     <p>实现安全单元的访问，可能使用到下面的接口。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.4.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">createService(): Promise&lt;SEService&gt;</td>         <td class="cellrowborder" valign="top" width="50%">建立一个可用于连接到系统中所有可用SE的新连接。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getReaders(): Reader[]</td>         <td class="cellrowborder" valign="top" width="50%">返回可用SE Reader的数组，包含该设备上支持的所有的安全单元。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">openSession(): Session</td>         <td class="cellrowborder" valign="top" width="50%">在SE Reader实例上创建连接会话，返回Session实例。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">openLogicalChannel(aid: number[]): Promise&lt;Channel&gt;</td>         <td class="cellrowborder" valign="top" width="50%">打开逻辑通道，返回逻辑Channel实例对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">transmit(command: number[]): Promise&lt;number[]&gt;</td>         <td class="cellrowborder" valign="top" width="50%">向SE发送APDU数据</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">close(): void</td>         <td class="cellrowborder" valign="top" width="50%">关闭Channel。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="主要场景开发步骤">主要场景开发步骤<i class="anchor-icon anchor-icon-link" anchorid="主要场景开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="应用程序访问安全单元" class="firsth2">应用程序访问安全单元<i class="anchor-icon anchor-icon-link" anchorid="应用程序访问安全单元" tips="复制节点链接"></i></h3>          <ol>      <li>import需要的安全单元模块。</li>      <li>判断设备是否支持安全单元能力。</li>      <li>访问安全单元，实现数据的读取或写入。</li>      <li>释放通道资源。</li>     </ol>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>从API version 9之后的应用开发新增支持Stage模型，作为目前主推并长期演进的模型。</li>        <li>由于SE的安全级别较高，必须将构建模式设置为release进行打包，否则应用将无法正常运行。</li>       </ul>      </div></div></div>     <div _ngcontent-ecu-c106="" class="highlight-div"><div _ngcontent-ecu-c106="" class="highlight-div-header"><div _ngcontent-ecu-c106="" class="highlight-div-header-left"><div _ngcontent-ecu-c106="" class="handle-button expand-button"><div _ngcontent-ecu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ecu-c106="" class="highlight-div-header-right"><div _ngcontent-ecu-c106="" class="handle-button ai-button"></div><div _ngcontent-ecu-c106="" class="handle-button line-button"><div _ngcontent-ecu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ecu-c106="" class="handle-button theme-button"><div _ngcontent-ecu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ecu-c106="" class="handle-button copy-button"><div _ngcontent-ecu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ecu-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { omapi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">seService</span>: omapi.<span class="hljs-property">SEService</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">seReaders</span>: omapi.<span class="hljs-property">Reader</span>[];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">seSession</span>: omapi.<span class="hljs-property">Session</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">seChannel</span>: omapi.<span class="hljs-property">Channel</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">testSelectedAid</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">0xA0</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x10</span>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0x00</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 判断设备是否支持安全单元能力</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Communication.SecureElement"</span>)) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'secure element unavailable.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'secure element available.'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">omaTest</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">omaTest</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 创建安全单元service，用于访问安全单元</span></li><li>    <span class="hljs-keyword">await</span> omapi.<span class="hljs-title function_">createService</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">undefined</span> || !data.<span class="hljs-title function_">isConnected</span>()) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'secure element service disconnected.'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      seService = data;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'secure element service connected.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'createService error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 获取设备上所有支持的readers，即所有的安全单元列表</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      seReaders = seService.<span class="hljs-title function_">getReaders</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'getReaders error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (seReaders == <span class="hljs-literal">undefined</span> || seReaders.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'no valid reader found.'</span>);</li><li>      seService.<span class="hljs-title function_">shutdown</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 根据业务需求，选择一个安全单元来访问，比如选择eSE或SIM或SIM2</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">reader</span>: (omapi.<span class="hljs-property">Reader</span> | <span class="hljs-literal">undefined</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; seReaders.<span class="hljs-property">length</span>; ++i) {</li><li>      <span class="hljs-keyword">let</span> r = seReaders[i];</li><li>      <span class="hljs-comment">// 安全单元的Name来区分，比如是eSE或SIM或SIM2</span></li><li>      <span class="hljs-keyword">if</span> (r.<span class="hljs-title function_">getName</span>().<span class="hljs-title function_">includes</span>(<span class="hljs-string">"SIM"</span>)) {</li><li>        reader = r;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (reader == <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'no valid sim reader.'</span>);</li><li>      seService.<span class="hljs-title function_">shutdown</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'reader is %{public}s'</span>, reader?.<span class="hljs-title function_">getName</span>());</li><li>
</li><li>    <span class="hljs-comment">// 在选定的一个安全单元实例上，打开一个会话session</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      seSession = reader?.<span class="hljs-title function_">openSession</span>() <span class="hljs-keyword">as</span> omapi.<span class="hljs-property">Session</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'openSession error %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (seSession == <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'seSession invalid.'</span>);</li><li>      seService.<span class="hljs-title function_">shutdown</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 通过会话session实例，创建逻辑通道或基础通道，一般选择逻辑通道访问，因为基础通道可能是受限的</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// testSelectedAid 根据实际业务，修改为打开逻辑通道的应用的aid值</span></li><li>      seChannel = <span class="hljs-keyword">await</span> seSession.<span class="hljs-title function_">openLogicalChannel</span>(testSelectedAid, p2);</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'openLogicalChannel exception %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(exception));</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (seChannel == <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'seChannel invalid.'</span>);</li><li>      seService.<span class="hljs-title function_">shutdown</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 使用通道发送APDU数据到安全单元，testApduData根据实际业务，修改为正确的业务数据值。所填充的APDU数据格式，需要符合APDU规范。</span></li><li>    <span class="hljs-keyword">let</span> testApduData = [<span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>];</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">response</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-keyword">await</span> seChannel.<span class="hljs-title function_">transmit</span>(testApduData);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'seChannel.transmit() response = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response));</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'seChannel.transmit() exception = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(exception));</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 通道访问结束后，必须确保通道资源是关闭的</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      seChannel.<span class="hljs-title function_">close</span>();</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'seChannel.close() exception = %{public}s.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(exception));</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 关闭服务资源，关闭应用程序和安全单元服务的绑定关系</span></li><li>    seService.<span class="hljs-title function_">shutdown</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>