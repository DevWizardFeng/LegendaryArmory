<h1 _ngcontent-vpw-c119="" class="doc-title ng-star-inserted" title="安全地理位置场景"> 安全地理位置场景 </h1>

<div _ngcontent-vpw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1393224216108">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1393224216108" tips="复制节点链接"></i></h2>          <p>在安全地理位置场景中，通过创建证明密钥、打开证明会话的方式，对从GPS硬件或网络位置获取到的地理位置信息进行签名，确保地理位置信息的真实性和完整性。</p>    </div>    <div class="tiledSection">     <h2 id="section104414218221">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section104414218221" tips="复制节点链接"></i></h2>          <p>该特性需要设备支持安全地理位置功能。</p>     <div class="p">      开发者可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section166716269293" target="_blank">initializeAttestContext</a>接口来初始化安全地理位置的证明会话，当返回值为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-arktsapi-errcode-taas#section2791195012317" target="_blank">ATTEST_ERROR_COMMUNICATION_FAILED</a>时，当前设备不支持安全地理位置。具体判断方法参考如下示例：      <div _ngcontent-vpw-c106="" class="highlight-div"><div _ngcontent-vpw-c106="" class="highlight-div-header"><div _ngcontent-vpw-c106="" class="highlight-div-header-left"><div _ngcontent-vpw-c106="" class="handle-button expand-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpw-c106="" class="highlight-div-header-right"><div _ngcontent-vpw-c106="" class="handle-button ai-button"></div><div _ngcontent-vpw-c106="" class="handle-button line-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpw-c106="" class="handle-button theme-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpw-c106="" class="handle-button copy-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { trustedAppService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DeviceSecurityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// 初始化证明会话的参数</span></li><li><span class="hljs-keyword">const</span> userData = <span class="hljs-string">"trusted_app_service_demo"</span> <span class="hljs-comment">// 示例值，实际值请自行生成，长度在16到127 Bytes之间</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestType</span>.<span class="hljs-property">ATTEST_TYPE_LOCATION</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_ID</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">0</span>) <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">此参数在安全地理位置场景下不生效</span></span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: initProperties</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">certChainList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li><span class="hljs-comment">// 初始化安全地理位置的证明会话，需要确保证明密钥成功创建且未过期。</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">initializeAttestContext</span>(userData, initOptions);</li><li>  certChainList = result.<span class="hljs-property">certChains</span>;</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> == trustedAppService.<span class="hljs-property">AttestExceptionErrCode</span>.<span class="hljs-property">ATTEST_ERROR_COMMUNICATION_FAILED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`current device not support secure location`</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to initialize attest context, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section13594426183318">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section13594426183318" tips="复制节点链接"></i></h2>          <p><span><img height="716.2254477711244" originheight="3406" originwidth="4375" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115037.54594679498904794047498250339941:50001231000000:2800:71462D4C60A55FBB3A9ABABB0EB4C7EEC1CBF63D5688B332DE8F9057F8CB67A9.jpg" title="点击放大" width="920"></span></p>     <p>应用获取安全地理位置的优先级策略有两种，分别是精度优先和速度优先。如果选择精度优先策略，可信应用服务会优先返回GPS的结果，GPS获取超时后返回网络地理位置；而如果选择速度优先策略，可信应用服务会返回从二者中最先获取到的结果。</p>    </div>    <div class="tiledSection">     <h2 id="section31055391019">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section31055391019" tips="复制节点链接"></i></h2>          <p>接口及使用方法请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="64.64%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="35.36%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section81796536265" target="_blank">createAttestKey</a>(options: AttestOptions): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>创建证明密钥。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section166716269293" target="_blank">initializeAttestContext</a>(userData: string, options: AttestOptions): Promise&lt;AttestReturnResult&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>初始化证明会话。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section18667940102912" target="_blank">finalizeAttestContext</a>(options: AttestOptions): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>结束证明会话。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section19260221152819" target="_blank">destroyAttestKey</a>(): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>销毁证明密钥。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section1744710293017" target="_blank">getCurrentSecureLocation</a>(timeout: number, priority: LocatingPriority): Promise&lt;SecureLocation&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>获取安全地理位置信息。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section9187179113620">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9187179113620" tips="复制节点链接"></i></h2>          <ol>      <li><span>申请位置权限，权限名称为“<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all-user#ohospermissionapproximately_location" target="_blank">ohos.permission.APPROXIMATELY_LOCATION</a>”和“<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all-user#ohospermissionlocation" target="_blank">ohos.permission.LOCATION</a>”，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization" target="_blank">向用户申请授权</a>。</span></li>      <li><span>导入可信应用服务模块。</span>       <p></p>       <div _ngcontent-vpw-c106="" class="highlight-div"><div _ngcontent-vpw-c106="" class="highlight-div-header"><div _ngcontent-vpw-c106="" class="highlight-div-header-left"><div _ngcontent-vpw-c106="" class="handle-button expand-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpw-c106="" class="highlight-div-header-right"><div _ngcontent-vpw-c106="" class="handle-button ai-button"></div><div _ngcontent-vpw-c106="" class="handle-button line-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpw-c106="" class="handle-button theme-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpw-c106="" class="handle-button copy-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { trustedAppService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DeviceSecurityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>创建证明密钥并初始化证明会话。</span>       <p></p>       <div _ngcontent-vpw-c106="" class="highlight-div"><div _ngcontent-vpw-c106="" class="highlight-div-header"><div _ngcontent-vpw-c106="" class="highlight-div-header-left"><div _ngcontent-vpw-c106="" class="handle-button expand-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpw-c106="" class="highlight-div-header-right"><div _ngcontent-vpw-c106="" class="handle-button ai-button"></div><div _ngcontent-vpw-c106="" class="handle-button line-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpw-c106="" class="handle-button theme-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpw-c106="" class="handle-button copy-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建证明密钥的参数</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">createProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestKeyAlg</span>.<span class="hljs-property">ATTEST_ALG_ECC</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestKeySize</span>.<span class="hljs-property">ATTEST_ECC_KEY_SIZE_256</span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">createOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: createProperties</li><li>};</li><li><span class="hljs-comment">// 初始化证明会话的参数</span></li><li><span class="hljs-keyword">const</span> userData = <span class="hljs-string">"trusted_app_service_demo"</span> <span class="hljs-comment">// 示例值，实际值请自行生成，长度在16到127 Bytes之间</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestType</span>.<span class="hljs-property">ATTEST_TYPE_LOCATION</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_ID</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">0</span>) <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">此参数在安全地理位置场景下不生效</span></span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: initProperties</li><li>};</li><li><span class="hljs-comment">// 创建证明密钥并打开证明会话</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">certChainList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">createAttestKey</span>(createOptions);</li><li>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">initializeAttestContext</span>(userData, initOptions);</li><li>  certChainList = result.<span class="hljs-property">certChains</span>;</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to initialize attest context, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>获取安全地理位置信息，以精度优先为例。</span>       <p></p>       <div _ngcontent-vpw-c106="" class="highlight-div"><div _ngcontent-vpw-c106="" class="highlight-div-header"><div _ngcontent-vpw-c106="" class="highlight-div-header-left"><div _ngcontent-vpw-c106="" class="handle-button expand-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpw-c106="" class="highlight-div-header-right"><div _ngcontent-vpw-c106="" class="handle-button ai-button"></div><div _ngcontent-vpw-c106="" class="handle-button line-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpw-c106="" class="handle-button theme-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpw-c106="" class="handle-button copy-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> timeout = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 获取安全地理位置的超时时间，单位为毫秒</span></li><li><span class="hljs-keyword">const</span> priority = trustedAppService.<span class="hljs-property">LocatingPriority</span>.<span class="hljs-property">PRIORITY_ACCURACY</span>; <span class="hljs-comment">// 采用精度优先策略</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">secureLocation</span>: trustedAppService.<span class="hljs-property">SecureLocation</span>;</li><li><span class="hljs-comment">// 获取当前安全地理位置信息</span></li><li><span class="hljs-keyword">try</span> {</li><li>  secureLocation = <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">getCurrentSecureLocation</span>(timeout, priority);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get current secure location, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>结束证明会话。</span>       <p></p>       <div _ngcontent-vpw-c106="" class="highlight-div"><div _ngcontent-vpw-c106="" class="highlight-div-header"><div _ngcontent-vpw-c106="" class="highlight-div-header-left"><div _ngcontent-vpw-c106="" class="handle-button expand-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vpw-c106="" class="highlight-div-header-right"><div _ngcontent-vpw-c106="" class="handle-button ai-button"></div><div _ngcontent-vpw-c106="" class="handle-button line-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vpw-c106="" class="handle-button theme-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vpw-c106="" class="handle-button copy-button"><div _ngcontent-vpw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vpw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 结束证明会话的参数</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">finalProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestType</span>.<span class="hljs-property">ATTEST_TYPE_LOCATION</span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">finalOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: finalProperties,</li><li>};</li><li><span class="hljs-comment">// 结束证明会话</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">finalizeAttestContext</span>(finalOptions);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finalize attest context, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre></div></div>       <p>如果需要销毁证明密钥，请在结束证明会话后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section19260221152819" target="_blank">destroyAttestKey</a>接口。</p>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>