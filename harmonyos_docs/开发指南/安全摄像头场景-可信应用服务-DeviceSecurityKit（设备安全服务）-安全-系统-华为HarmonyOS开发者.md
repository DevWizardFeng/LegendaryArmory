<h1 _ngcontent-trx-c119="" class="doc-title ng-star-inserted" title="安全摄像头场景"> 安全摄像头场景 </h1>

<div _ngcontent-trx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1393224216108">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1393224216108" tips="复制节点链接"></i></h2>          <p>在安全摄像头场景中，通过创建证明密钥、打开证明会话的方式，对安全摄像头捕捉到的图像数据进行签名，确保图像数据的真实性和完整性。</p>    </div>    <div class="tiledSection">     <h2 id="section104414218221">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section104414218221" tips="复制节点链接"></i></h2>          <p>该特性需要设备支持安全摄像头功能。</p>     <p>开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedscenemodes11" target="_blank">getSupportedSceneModes</a>方法，当返回值为camera.SceneMode.SECURE_PHOTO，当前设备支持安全摄像头，返回其他值表示当前设备不支持安全摄像头。具体判断方法参考如下示例：</p>     <div _ngcontent-trx-c106="" class="highlight-div"><div _ngcontent-trx-c106="" class="highlight-div-header"><div _ngcontent-trx-c106="" class="highlight-div-header-left"><div _ngcontent-trx-c106="" class="handle-button expand-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-trx-c106="" class="highlight-div-header-right"><div _ngcontent-trx-c106="" class="handle-button ai-button"></div><div _ngcontent-trx-c106="" class="handle-button line-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-trx-c106="" class="handle-button theme-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-trx-c106="" class="handle-button copy-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-trx-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// 获得安全摄像头</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSecureCameraDevice</span>(<span class="hljs-params">cameraManager: camera.CameraManager</span>): camera.<span class="hljs-property">CameraDevice</span> {</li><li>    <span class="hljs-comment">// 获得设备支持的摄像头列表</span></li><li>    <span class="hljs-keyword">const</span> cameraDevices = cameraManager.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>    <span class="hljs-keyword">if</span> (cameraDevices.<span class="hljs-property">length</span> &lt; <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'no camera devices'</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 获取前置摄镜头对象。当前安全摄像头仅支持前置镜头。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">frontCamera</span>: camera.<span class="hljs-property">CameraDevice</span> | <span class="hljs-literal">undefined</span> = cameraDevices.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">profile: camera.CameraDevice</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> profile.<span class="hljs-property">cameraPosition</span> != camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>    });</li><li>    <span class="hljs-keyword">if</span> (frontCamera === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'no front cameras'</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 检查前置摄像头设备是否支持安全模式；若支持，即可使用该前置摄像头做后续安全摄像头操作。</span></li><li>    <span class="hljs-keyword">const</span> modes = cameraManager.<span class="hljs-title function_">getSupportedSceneModes</span>(frontCamera);</li><li>    <span class="hljs-keyword">if</span> (modes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">SECURE_PHOTO</span>) === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'current device not support secure camera'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> frontCamera;</li><li>  }</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="section13594426183318">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section13594426183318" tips="复制节点链接"></i></h2>          <p><span><img height="918.8504627766598" originheight="4875" originwidth="4881" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115029.17072249182876450948919728720238:50001231000000:2800:D3796B4F66E79D35FE263894F5BD3F5BFF1EDB25D2EE3A3093B09903A7E4A9A9.jpg" title="点击放大" width="920"></span></p>    </div>    <div class="tiledSection">     <h2 id="section31055391019">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section31055391019" tips="复制节点链接"></i></h2>          <p>接口及使用方法请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="64.64%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="35.36%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section81796536265" target="_blank">createAttestKey</a>(options: AttestOptions): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>创建证明密钥。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section166716269293" target="_blank">initializeAttestContext</a>(userData: string, options: AttestOptions): Promise&lt;AttestReturnResult&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>初始化证明会话。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section18667940102912" target="_blank">finalizeAttestContext</a>(options: AttestOptions): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>结束证明会话。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="64.64%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section19260221152819" target="_blank">destroyAttestKey</a>(): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="35.36%">          <p>销毁证明密钥。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section9187179113620">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9187179113620" tips="复制节点链接"></i></h2>          <ol>      <li><span>导入camera模块、trustedAppService模块和相关依赖模块。</span>       <p></p>       <div _ngcontent-trx-c106="" class="highlight-div"><div _ngcontent-trx-c106="" class="highlight-div-header"><div _ngcontent-trx-c106="" class="highlight-div-header-left"><div _ngcontent-trx-c106="" class="handle-button expand-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-trx-c106="" class="highlight-div-header-right"><div _ngcontent-trx-c106="" class="handle-button ai-button"></div><div _ngcontent-trx-c106="" class="handle-button line-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-trx-c106="" class="handle-button theme-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-trx-c106="" class="handle-button copy-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-trx-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { trustedAppService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DeviceSecurityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-secure-photo" target="_blank">安全相机开发指导</a>，初始化安全相机。</span>       <p></p>       <p>开发者需要完成：</p>       <ul>        <li>选择支持安全相机的设备。</li>        <li>查询相机设备在安全模式下支持的输出能力。</li>        <li>创建设备输入输出。</li>        <li>打开安全设备（安全摄像头），并获取安全设备序列号。</li>       </ul>       <p></p></li>      <li><span>创建证明密钥和初始化证明会话。</span>       <p></p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>只有创建证明密钥成功后，才能初始化证明会话。</li>          <li>证明密钥的有效期为7天，为了避免反复创建证明密钥，建议先调用初始化证明会话，如果初始化失败，再去销毁、创建证明密钥，然后重新初始化证明密钥。</li>          <li>每次打开安全摄像头都需要获取设备序列号，只有初始化安全相机证明会话时需要传入有效值，其他场景传“0”即可。</li>          <li>调用initializeAttestContext初始化证明会话时，userData的长度必须在16到127 Bytes之间。</li>         </ul>        </div></div></div>       <div class="p">        <div _ngcontent-trx-c106="" class="highlight-div"><div _ngcontent-trx-c106="" class="highlight-div-header"><div _ngcontent-trx-c106="" class="highlight-div-header-left"><div _ngcontent-trx-c106="" class="handle-button expand-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-trx-c106="" class="highlight-div-header-right"><div _ngcontent-trx-c106="" class="handle-button ai-button"></div><div _ngcontent-trx-c106="" class="handle-button line-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-trx-c106="" class="handle-button theme-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-trx-c106="" class="handle-button copy-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-trx-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建证明密钥的参数</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">createProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestKeyAlg</span>.<span class="hljs-property">ATTEST_ALG_ECC</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestKeySize</span>.<span class="hljs-property">ATTEST_ECC_KEY_SIZE_256</span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">createOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: createProperties</li><li>};</li><li><span class="hljs-comment">// 初始化证明会话的参数</span></li><li><span class="hljs-keyword">const</span> userData = <span class="hljs-string">"trusted_app_service_demo"</span>; <span class="hljs-comment">// 示例值，实际值请自行生成，长度在16到127Bytes之间</span></li><li><span class="hljs-keyword">const</span> deviceId = <span class="hljs-number">7483679320805398131</span>; <span class="hljs-comment">// 示例值，实际值请通过Camera Kit获取</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestType</span>.<span class="hljs-property">ATTEST_TYPE_CAMERA</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_ID</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-title class_">BigInt</span>(deviceId)</li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">initOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: initProperties</li><li>};</li><li><span class="hljs-comment">// 创建证明密钥并打开证明会话</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">certChainList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">createAttestKey</span>(createOptions);</li><li>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">initializeAttestContext</span>(userData, initOptions);</li><li>  certChainList = result.<span class="hljs-property">certChains</span>;</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to initialize attest context, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre></div></div>       </div>       <p></p></li>      <li><span>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-secure-photo" target="_blank">安全相机开发指导</a>，完成安全相机会话的创建，配置输入、输出流，启动预览流和安全数据流。</span></li>      <li><span>结束证明会话。</span>       <p></p>       <div _ngcontent-trx-c106="" class="highlight-div"><div _ngcontent-trx-c106="" class="highlight-div-header"><div _ngcontent-trx-c106="" class="highlight-div-header-left"><div _ngcontent-trx-c106="" class="handle-button expand-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-trx-c106="" class="highlight-div-header-right"><div _ngcontent-trx-c106="" class="handle-button ai-button"></div><div _ngcontent-trx-c106="" class="handle-button line-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-trx-c106="" class="handle-button theme-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-trx-c106="" class="handle-button copy-button"><div _ngcontent-trx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-trx-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 结束证明会话的参数</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">finalProperties</span>: <span class="hljs-title class_">Array</span>&lt;trustedAppService.<span class="hljs-property">AttestParam</span>&gt; = [</li><li>  {</li><li>    <span class="hljs-attr">tag</span>: trustedAppService.<span class="hljs-property">AttestTag</span>.<span class="hljs-property">ATTEST_TAG_DEVICE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: trustedAppService.<span class="hljs-property">AttestType</span>.<span class="hljs-property">ATTEST_TYPE_CAMERA</span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">finalOptions</span>: trustedAppService.<span class="hljs-property">AttestOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: finalProperties,</li><li>};</li><li><span class="hljs-comment">// 结束证明会话</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> trustedAppService.<span class="hljs-title function_">finalizeAttestContext</span>(finalOptions);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finalize attest context, message:<span class="hljs-subst">${error.message}</span>, code:<span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre></div></div>       <p>如果需要销毁证明密钥，请在结束证明会话后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-taas-api#section19260221152819" target="_blank">destroyAttestKey</a>接口。由于安全摄像头、安全地理位置和安全图像压缩、裁剪共用同一个证明密钥，销毁前需要保证安全地理位置功能未在使用该证明密钥。</p>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>