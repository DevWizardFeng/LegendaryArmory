<h1 _ngcontent-kpt-c119="" class="doc-title ng-star-inserted" title="完整示例代码"> 完整示例代码 </h1>

<div _ngcontent-kpt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>需要完成网络权限的申请，参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-rag-development#section84162596597">开发准备</a>。</p> </div></div></div> <div class="tiledSection"><h2 id="section639017492313">EntryAbility.ets<i class="anchor-icon anchor-icon-link" anchorid="section639017492313" tips="复制节点链接"></i></h2><p>应用的生命周期实现在这个文件中，主要在应用启动时进行RagSession、数据库连接的创建，应用关闭时进行RagSession、数据库连接的释放。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">SetUp</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../entryability/SetUp'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../entryability/Config'</span>;</li><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;common.<span class="hljs-property">UIAbilityContext</span>&gt;(<span class="hljs-string">'Context'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">setUp</span>: <span class="hljs-title class_">SetUp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetUp</span>();</li><li>    setUp.<span class="hljs-title function_">initTable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      setUp.<span class="hljs-title function_">insertData</span>();</li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">SetUp</span>&gt;(<span class="hljs-string">'SetUpObject'</span>, setUp);</li><li>    });</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Config</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();</li><li>    rag.<span class="hljs-title function_">createRagSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, config.<span class="hljs-title function_">getRAGConfig</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;rag.<span class="hljs-property">RagSession</span>&gt;(<span class="hljs-string">'RagSessionObject'</span>, data);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`createRagSession failed, code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>    <span class="hljs-keyword">const</span> session = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;rag.<span class="hljs-property">RagSession</span>&gt;(<span class="hljs-string">'RagSessionObject'</span>) <span class="hljs-keyword">as</span> rag.<span class="hljs-property">RagSession</span>;</li><li>    session?.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'close rag session failed'</span>);</li><li>    });</li><li>    <span class="hljs-keyword">const</span> setup = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">SetUp</span>&gt;(<span class="hljs-string">'SetUpObject'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">SetUp</span>;</li><li>    setup?.<span class="hljs-title function_">closeStore</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section123912493313">SetUp.ets<i class="anchor-icon anchor-icon-link" anchorid="section123912493313" tips="复制节点链接"></i></h2><p>SetUp.ets负责数据源的构造，目前实现是从一个自带的Json文件读取数据，并且插入一个开启知识加工开关的数据库中。数据更新成功后，将会自动触发知识加工，形成知识库。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/SetUp.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'SetUp'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetUp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'testmail_store.db'</span>;  <span class="hljs-comment">// 与knowledge_schema.json文件中数据库名保持一致</span></li><li>  <span class="hljs-attr">storeConfig</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeName</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>    <span class="hljs-attr">enableSemanticIndex</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 源数据库需配置该项为true才会触发知识加工</span></li><li>    <span class="hljs-attr">tokenizer</span>: relationalStore.<span class="hljs-property">Tokenizer</span>.<span class="hljs-property">CUSTOM_TOKENIZER</span></li><li>  };</li><li>  store?: relationalStore.<span class="hljs-property">RdbStore</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getStore</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>) {</li><li>        <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;common.<span class="hljs-property">UIAbilityContext</span>&gt;(<span class="hljs-string">'Context'</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// 获取全局context</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable language_">this</span>.<span class="hljs-property">storeConfig</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Init DB failed, code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initTable</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> tmpStore = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStore</span>();</li><li>      <span class="hljs-keyword">const</span> createTableSql = <span class="hljs-string">'CREATE TABLE IF NOT EXISTS email(id integer primary key, subject text, content text, '</span> +</li><li>        <span class="hljs-string">'image_text text, attachment_names text, inline_files text, sender text, receivers text, received_date text);'</span>;</li><li>      <span class="hljs-keyword">await</span> tmpStore?.<span class="hljs-title function_">execute</span>(createTableSql, <span class="hljs-number">0</span>, <span class="hljs-literal">undefined</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'InitTable success'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Init DB failed, code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">insertData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;common.<span class="hljs-property">UIAbilityContext</span>&gt;(<span class="hljs-string">'Context'</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// 获取全局context</span></li><li>      <span class="hljs-keyword">const</span> fileList = context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileListSync</span>(<span class="hljs-string">''</span>);</li><li>      <span class="hljs-keyword">let</span> dataIndex = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> file <span class="hljs-keyword">of</span> fileList) {  <span class="hljs-comment">// 从json文件中解析数据到数据库中</span></li><li>        <span class="hljs-keyword">if</span> (!file.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'sourceData'</span>) || !file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.json'</span>)) {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`file <span class="hljs-subst">${file}</span> skip`</span>);</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`file <span class="hljs-subst">${file}</span> start`</span>);</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">const</span> rawFileData = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(file);</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">fileData</span>: <span class="hljs-built_in">string</span> = buffer.<span class="hljs-title function_">from</span>(rawFileData).<span class="hljs-title function_">toString</span>();</li><li>          <span class="hljs-keyword">const</span> resultObjArr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fileData) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">object</span>&gt;;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">jsonObj</span>: <span class="hljs-built_in">object</span> | <span class="hljs-literal">undefined</span>;</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; resultObjArr.<span class="hljs-property">length</span>; i++) {</li><li>            <span class="hljs-keyword">try</span> {</li><li>              jsonObj = resultObjArr[i];</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">sender</span>: <span class="hljs-built_in">string</span> = jsonObj?.[<span class="hljs-string">'sender_name'</span>];</li><li>              <span class="hljs-keyword">if</span> (!sender || sender.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>                sender = <span class="hljs-string">'undefined'</span>;</li><li>              }</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">receiverStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(jsonObj[<span class="hljs-string">'to'</span>]);</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">formattedDateStr</span>: <span class="hljs-built_in">string</span> = jsonObj?.[<span class="hljs-string">'received_time'</span>]?.<span class="hljs-title function_">replace</span>(<span class="hljs-string">' '</span>, <span class="hljs-string">'T'</span>);</li><li>              <span class="hljs-keyword">let</span> received_date = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">parse</span>(formattedDateStr);</li><li>              <span class="hljs-keyword">if</span> (!received_date || <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(received_date)) {</li><li>                received_date = <span class="hljs-number">0</span>;</li><li>              }</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">subject</span>: <span class="hljs-built_in">string</span> = jsonObj?.[<span class="hljs-string">'subject'</span>]?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">''</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">doc</span>: <span class="hljs-built_in">string</span> = jsonObj?.[<span class="hljs-string">'body'</span>]?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">''</span>);</li><li>              <span class="hljs-keyword">let</span> sql = <span class="hljs-string">`insert or replace into email VALUES(<span class="hljs-subst">${dataIndex}</span>, '<span class="hljs-subst">${subject}</span>', '<span class="hljs-subst">${doc}</span>', '',`</span> +</li><li>                <span class="hljs-string">` '', '', '<span class="hljs-subst">${sender}</span>', '<span class="hljs-subst">${receiverStr}</span>', '<span class="hljs-subst">${received_date}</span>');`</span></li><li>              <span class="hljs-keyword">const</span> tmpStore = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStore</span>();</li><li>              <span class="hljs-keyword">await</span> tmpStore?.<span class="hljs-title function_">executeSql</span>(sql);</li><li>              dataIndex++;</li><li>            } <span class="hljs-keyword">catch</span> (e) {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Insert failed, code is <span class="hljs-subst">${e.code}</span>,message is <span class="hljs-subst">${e.message}</span>, jsonObj: <span class="hljs-subst">${jsonObj}</span>`</span>);</li><li>            }</li><li>          }</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Load file failed, code is <span class="hljs-subst">${e.code}</span>,message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`file <span class="hljs-subst">${file}</span> end`</span>);</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'insertData end'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Init DB failed, code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">closeStore</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>?.<span class="hljs-title function_">close</span>();</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Close store failed, code is <span class="hljs-subst">${e.code}</span>,message is <span class="hljs-subst">${e.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section123929493317">HttpUtils.ets<i class="anchor-icon anchor-icon-link" anchorid="section123929493317" tips="复制节点链接"></i></h2><p>HttpUtils.ets是与大模型交互的Http工具类，主要负责发往大模型的报文拼装、流式Http消息接收回调的注册等。开发者需根据自身资源，选用合适的大模型。示例代码使用的是<a href="https://console.huaweicloud.com/modelarts" target="_blank">ModelArts</a>，需要把其中的"****replace your API key in here****"替换为真实的API Key。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/HttpUtils.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'HttpUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpUtils</span> {</li><li>  httpRequest?: http.<span class="hljs-property">HttpRequest</span>;</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'https://api.modelarts-maas.com/v1/chat/completions'</span>; <span class="hljs-comment">// 开发者需要根据选择的大模型对应修改url以及下面的model</span></li><li>  <span class="hljs-attr">isFinished</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">initOption</span>(<span class="hljs-params">question: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: http.<span class="hljs-property">HttpRequestOptions</span> = {</li><li>      <span class="hljs-comment">// 请求方式</span></li><li>      <span class="hljs-attr">method</span>: http.<span class="hljs-property">RequestMethod</span>.<span class="hljs-property">POST</span>,</li><li>      <span class="hljs-comment">// 请求头</span></li><li>      <span class="hljs-attr">header</span>: {</li><li>        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,</li><li>        <span class="hljs-comment">// API-KEY from Model</span></li><li>        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer ****replace your API key in here****`</span></li><li>      },</li><li>      <span class="hljs-comment">// 请求体</span></li><li>      <span class="hljs-attr">extraData</span>: {</li><li>        <span class="hljs-string">'stream'</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">'temperature'</span>: <span class="hljs-number">0.1</span>,</li><li>        <span class="hljs-string">'max_tokens'</span>: <span class="hljs-number">1000</span>,</li><li>        <span class="hljs-string">'frequency_penalty'</span>: <span class="hljs-number">1</span>,</li><li>        <span class="hljs-string">'model'</span>: <span class="hljs-string">'qwen3-235b-a22b'</span>,</li><li>        <span class="hljs-string">'top_p'</span>: <span class="hljs-number">0.1</span>,</li><li>        <span class="hljs-string">'presence_penalty'</span>: -<span class="hljs-number">1</span>,</li><li>        <span class="hljs-string">'messages'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(question),</li><li>        <span class="hljs-string">"chat_template_kwargs"</span>: {</li><li>          <span class="hljs-comment">// 关闭思考中数据</span></li><li>          <span class="hljs-string">"enable_thinking"</span>: <span class="hljs-literal">false</span></li><li>        }</li><li>      }</li><li>    };</li><li>    <span class="hljs-keyword">return</span> option;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestInStream</span>(<span class="hljs-params">question: <span class="hljs-built_in">string</span></span>) { <span class="hljs-comment">// 拼装流式请求的option并发起流式请求</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span> = http.<span class="hljs-title function_">createHttp</span>();</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">requestInStream</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initOption</span>(question)).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Failed to request. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFinished</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">on</span>(<span class="hljs-params">callback: Callback&lt;<span class="hljs-built_in">ArrayBuffer</span>&gt;</span>) { <span class="hljs-comment">// 注册数据接受、数据结束的监听</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span> = http.<span class="hljs-title function_">createHttp</span>();</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataReceive'</span>, callback);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">end</span>(<span class="hljs-params"></span>) { <span class="hljs-comment">// 取消注册数据接受、数据结束的监听，释放httpRequest</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'dataReceive'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">destroy</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'dataReceive'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">destroy</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpUtils</span>;</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section14393184912315">MyChatLlm.ets<i class="anchor-icon anchor-icon-link" anchorid="section14393184912315" tips="复制节点链接"></i></h2><p>应用继承实现ChatLLM类，相当于应用侧实现的大模型客户端，将在创建RagSession的时候把这个大模型客户端作为入参传入RagSession中。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/MyChatLlm.ets</span></li><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span>, util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">HttpUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HttpUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">"MyChatLLM"</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseLLMResponse</span>(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>): rag.<span class="hljs-property">LLMStreamAnswer</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> decoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">`"utf-8"`</span>);</li><li>    <span class="hljs-keyword">let</span> str = decoder.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data));</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, str);</li><li>    <span class="hljs-keyword">let</span> chunk = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isFinished</span>: <span class="hljs-built_in">boolean</span> = (str.<span class="hljs-property">length</span> &lt; <span class="hljs-number">20</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> resultStr <span class="hljs-keyword">of</span> str.<span class="hljs-title function_">split</span>(<span class="hljs-string">'data:'</span>)) {</li><li>      <span class="hljs-keyword">if</span> (resultStr.<span class="hljs-title function_">trim</span>() == (<span class="hljs-string">'[DONE]'</span>)) {</li><li>        isFinished = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (resultStr.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">continue</span>;</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resultStr.<span class="hljs-title function_">trim</span>());</li><li>        <span class="hljs-keyword">if</span> ((obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span>)?.[<span class="hljs-string">'choices'</span>].<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> ((obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span>)?.[<span class="hljs-string">'choices'</span>][<span class="hljs-number">0</span>]?.[<span class="hljs-string">'delta'</span>]?.[<span class="hljs-string">'reasoning_content'</span>]) {</li><li>          chunk += (obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span>)?.[<span class="hljs-string">'choices'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'delta'</span>][<span class="hljs-string">'reasoning_content'</span>];</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span>)?.[<span class="hljs-string">'choices'</span>][<span class="hljs-number">0</span>]?.[<span class="hljs-string">'delta'</span>]?.[<span class="hljs-string">'content'</span>]) {</li><li>          chunk += (obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span>)?.[<span class="hljs-string">'choices'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'delta'</span>][<span class="hljs-string">'content'</span>];</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Parse LLM response failed, resultStr: <span class="hljs-subst">${resultStr}</span>`</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">answer</span>: rag.<span class="hljs-property">LLMStreamAnswer</span> = {</li><li>      <span class="hljs-attr">isFinished</span>: isFinished,</li><li>      <span class="hljs-attr">chunk</span>: chunk</li><li>    };</li><li>    <span class="hljs-keyword">return</span> answer;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Parse LLM response failed, error code: <span class="hljs-subst">${err.code}</span>, error message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyChatLLM</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rag.ChatLLM</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">streamChat</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;rag.<span class="hljs-property">LLMStreamAnswer</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;rag.<span class="hljs-property">LLMRequestInfo</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">ret</span>: rag.<span class="hljs-property">LLMRequestStatus</span> = rag.<span class="hljs-property">LLMRequestStatus</span>.<span class="hljs-property">LLM_SUCCESS</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-title function_">dataCallback</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt; { <span class="hljs-comment">// 收到数据时的回调函数，解析数据并组装LLMStreamAnswer，通过callback回调</span></li><li>        hilog.<span class="hljs-title function_">debug</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on callback enter. data length: %{public}d'</span>, data.<span class="hljs-property">byteLength</span>);</li><li>        <span class="hljs-comment">// 解析大模型返回报文，逻辑因选择模型而异</span></li><li>        <span class="hljs-keyword">const</span> answer = <span class="hljs-title function_">parseLLMResponse</span>(data);</li><li>        <span class="hljs-keyword">if</span> (!answer) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-property">isFinished</span> = answer.<span class="hljs-property">isFinished</span>;</li><li>        <span class="hljs-title function_">callback</span>(answer);</li><li>        hilog.<span class="hljs-title function_">debug</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLLM'</span>, <span class="hljs-string">'Request LLM success. isFinished: %{public}s, data: %{public}s'</span>,</li><li>          <span class="hljs-title class_">Number</span>(answer.<span class="hljs-property">isFinished</span>).<span class="hljs-title function_">toString</span>(), answer.<span class="hljs-property">chunk</span>);</li><li>      };</li><li>
</li><li>      <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">on</span>(dataCallback);</li><li>      <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">requestInStream</span>(query);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Request LLM failed, error code: <span class="hljs-subst">${err.code}</span>, error message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      ret = rag.<span class="hljs-property">LLMRequestStatus</span>.<span class="hljs-property">LLM_REQUEST_ERROR</span>; <span class="hljs-comment">// 开发者可判断错误码从而返回其他LLM错误码</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">chatId</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">status</span>: ret,</li><li>    };</li><li>  }</li><li>  <span class="hljs-title function_">cancel</span>(<span class="hljs-attr">chatId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`The request for the large model has been canceled. chatId: <span class="hljs-subst">${chatId}</span>`</span>);</li><li>    <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">cancel</span>();</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section9395949137">Config.ets<i class="anchor-icon anchor-icon-link" anchorid="section9395949137" tips="复制节点链接"></i></h2><p>Config.ets主要负责RagSession创建时入参的组装。详细配置方法及含义可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/dataaugmentation-retrieval">智慧化数据检索</a>。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/Config.ets</span></li><li><span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rag, retrieval } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">MyChatLlm</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyChatLlm'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">getRetrievalConfig</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">storeConfigVector</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">'testmail_store_vector.db'</span>, <span class="hljs-comment">// 知识加工后向量数据库文件名，在原数据库名基础上加_vector后缀</span></li><li>      <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      <span class="hljs-attr">vector</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 向量数据库应设置该项为true</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">storeConfigInvIdx</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">'testmail_store.db'</span>, <span class="hljs-comment">// 知识加工后，倒排数据库即原数据库</span></li><li>      <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      <span class="hljs-attr">tokenizer</span>: relationalStore.<span class="hljs-property">Tokenizer</span>.<span class="hljs-property">CUSTOM_TOKENIZER</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;common.<span class="hljs-property">UIAbilityContext</span>&gt;(<span class="hljs-string">'Context'</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">channelConfigVector</span>: retrieval.<span class="hljs-property">ChannelConfig</span> = {</li><li>      <span class="hljs-attr">channelType</span>: retrieval.<span class="hljs-property">ChannelType</span>.<span class="hljs-property">VECTOR_DATABASE</span>,</li><li>      <span class="hljs-attr">context</span>: context,</li><li>      <span class="hljs-attr">dbConfig</span>: storeConfigVector</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">channelConfigInvIdx</span>: retrieval.<span class="hljs-property">ChannelConfig</span> = {</li><li>      <span class="hljs-attr">channelType</span>: retrieval.<span class="hljs-property">ChannelType</span>.<span class="hljs-property">INVERTED_INDEX_DATABASE</span>,</li><li>      <span class="hljs-attr">context</span>: context,</li><li>      <span class="hljs-attr">dbConfig</span>: storeConfigInvIdx</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">retrievalConfig</span>: retrieval.<span class="hljs-property">RetrievalConfig</span> = {</li><li>      <span class="hljs-attr">channelConfigs</span>: [channelConfigInvIdx, channelConfigVector]</li><li>    };</li><li>    <span class="hljs-keyword">return</span> retrievalConfig;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getRetrivalCondition</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">recallConditionInvIdx</span>: retrieval.<span class="hljs-property">InvertedIndexRecallCondition</span> = {</li><li>      <span class="hljs-attr">ftsTableName</span>: <span class="hljs-string">'email_inverted'</span>,</li><li>      <span class="hljs-attr">fromClause</span>: <span class="hljs-string">'select email_inverted.reference_id as rowid, * from email INNER JOIN email_inverted ON email.id = email_inverted.reference_id'</span>,</li><li>      <span class="hljs-attr">primaryKey</span>: [<span class="hljs-string">'chunk_id'</span>],</li><li>      <span class="hljs-attr">responseColumns</span>: [<span class="hljs-string">'reference_id'</span>, <span class="hljs-string">'chunk_id'</span>, <span class="hljs-string">'chunk_source'</span>, <span class="hljs-string">'chunk_text'</span>, <span class="hljs-string">'subject'</span>, <span class="hljs-string">'image_text'</span>,</li><li>        <span class="hljs-string">'attachment_names'</span>],</li><li>      <span class="hljs-attr">deepSize</span>: <span class="hljs-number">500</span>,</li><li>      <span class="hljs-attr">recallName</span>: <span class="hljs-string">'invertedvectorRecall'</span>,</li><li>    };</li><li>    <span class="hljs-keyword">let</span> floatArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-number">128</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0.1</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">vectorQuery</span>: retrieval.<span class="hljs-property">VectorQuery</span> = {</li><li>      <span class="hljs-attr">column</span>: <span class="hljs-string">'repr'</span>,</li><li>      <span class="hljs-attr">value</span>: floatArray,</li><li>      <span class="hljs-attr">similarityThreshold</span>: <span class="hljs-number">0.1</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">recallConditionVector</span>: retrieval.<span class="hljs-property">VectorRecallCondition</span> = {</li><li>      <span class="hljs-attr">vectorQuery</span>: vectorQuery,</li><li>      <span class="hljs-attr">fromClause</span>: <span class="hljs-string">'email_vector'</span>,</li><li>      <span class="hljs-attr">primaryKey</span>: [<span class="hljs-string">'id'</span>],</li><li>      <span class="hljs-attr">responseColumns</span>: [<span class="hljs-string">'reference_id'</span>, <span class="hljs-string">'chunk_id'</span>, <span class="hljs-string">'chunk_source'</span>, <span class="hljs-string">'repr'</span>],</li><li>      <span class="hljs-attr">recallName</span>: <span class="hljs-string">'vectorRecall'</span>,</li><li>      <span class="hljs-attr">deepSize</span>: <span class="hljs-number">500</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">rerankMethod</span>: retrieval.<span class="hljs-property">RerankMethod</span> = {</li><li>      <span class="hljs-attr">rerankType</span>: retrieval.<span class="hljs-property">RerankType</span>.<span class="hljs-property">RRF</span>,</li><li>      <span class="hljs-attr">isSoftmaxNormalized</span>: <span class="hljs-literal">true</span>,</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">retrievalCondition</span>: retrieval.<span class="hljs-property">RetrievalCondition</span> = {</li><li>      <span class="hljs-attr">rerankMethod</span>: rerankMethod,</li><li>      <span class="hljs-attr">recallConditions</span>: [recallConditionInvIdx, recallConditionVector],</li><li>      <span class="hljs-attr">resultCount</span>: <span class="hljs-number">5</span></li><li>    };</li><li>    <span class="hljs-keyword">return</span> retrievalCondition;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getRAGConfig</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">retrievalConfig</span>: retrieval.<span class="hljs-property">RetrievalConfig</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRetrievalConfig</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">retrievalCondition</span>: retrieval.<span class="hljs-property">RetrievalCondition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRetrivalCondition</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: rag.<span class="hljs-property">Config</span> = {</li><li>      <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyChatLlm</span>(),</li><li>      <span class="hljs-attr">retrievalConfig</span>: retrievalConfig,</li><li>      <span class="hljs-attr">retrievalCondition</span>: retrievalCondition</li><li>    };</li><li>    <span class="hljs-keyword">return</span> config;</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section1139715492036">Index.ets<i class="anchor-icon anchor-icon-link" anchorid="section1139715492036" tips="复制节点链接"></i></h2><p>应用界面功能的实现包含：输入问 入框、开始问答的按钮、答案输出的输出框。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">inputStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'知识问答开发指南完整示例代码'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">answerStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">thoughtStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">8</span> }) {</li><li>        <span class="hljs-title class_">TextArea</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputStr</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Input question here!'</span> })</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">8</span> })</li><li>          .<span class="hljs-title function_">borderStyle</span>(<span class="hljs-title class_">BorderStyle</span>.<span class="hljs-property">Dotted</span>)</li><li>          .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputStr</span> = newValue;</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'95%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'15%'</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      }</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'streamRun'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-comment">// 获取创建的RagSession</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: rag.<span class="hljs-property">RagSession</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;rag.<span class="hljs-property">RagSession</span>&gt;(<span class="hljs-string">'RagSessionObject'</span>) <span class="hljs-keyword">as</span> rag.<span class="hljs-property">RagSession</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: rag.<span class="hljs-property">RunConfig</span> = {</li><li>            <span class="hljs-comment">// 指定流式输出的输出类型</span></li><li>            <span class="hljs-attr">answerTypes</span>: [rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">THOUGHT</span>, rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">ANSWER</span>]</li><li>          };</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">thoughtStr</span> = <span class="hljs-string">''</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">''</span>;</li><li>          <span class="hljs-comment">// 发起提问</span></li><li>          session.<span class="hljs-title function_">streamRun</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">inputStr</span>, config, (<span class="hljs-function">(<span class="hljs-params">err: BusinessError, stream: rag.Stream</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// 接收答案的callback回调，处理答案信息</span></li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">`streamRun inner failed. code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>;</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// 根据不同的数据类型，选择不同的处理方式</span></li><li>              <span class="hljs-keyword">switch</span> (stream.<span class="hljs-property">type</span>) {</li><li>                <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">THOUGHT</span>:</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">thoughtStr</span> += stream.<span class="hljs-property">answer</span>.<span class="hljs-property">chunk</span>;</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">ANSWER</span>:</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> += stream.<span class="hljs-property">answer</span>.<span class="hljs-property">chunk</span>;</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">REFERENCE</span>:</li><li>                <span class="hljs-attr">default</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">`streamRun msg: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(stream)}</span>`</span>);</li><li>              }</li><li>            }</li><li>          })).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">`streamRun failed. code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>;</li><li>          });</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'30%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'5%'</span>)</li><li>      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">thoughtStr</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          .<span class="hljs-title function_">padding</span>(<span class="hljs-number">8</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'95%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'auto'</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span>)</li><li>          .<span class="hljs-title function_">padding</span>(<span class="hljs-number">8</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'95%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'auto'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF5DEB3</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'95%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'75%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section18537389330">knowledge_schema.json<i class="anchor-icon anchor-icon-link" anchorid="section18537389330" tips="复制节点链接"></i></h2><p>知识加工的schema文件用来定义知识加工时对于源数据库的处理逻辑。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/resources/rawfile/arkdata/knowledge/knowledge_schema.json ------ 实际使用时请删除本行注释</span></li><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"knowledgeSource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"dbName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"testmail_store.db"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"tables"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"tableName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"email"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"referenceFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"id"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"knowledgeFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subject"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Text"</span><span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"content"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Text"</span><span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image_text"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Text"</span><span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"attachment_names"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Text"</span><span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inline_files"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Json"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"File"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$[*].uri"</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sender"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Scalar"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sender"</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"receivers"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Scalar"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"receivers"</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"columnName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"received_date"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Scalar"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"received_date"</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li><li>    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <div class="tiledSection"><h2 id="section9854538113315">sourceData.json<i class="anchor-icon anchor-icon-link" anchorid="section9854538113315" tips="复制节点链接"></i></h2><p>sourceData.json文件中的内容为模拟数据源，作为输入插入应用数据库表。真实情况应用数据输入途径应该是界面输入、服务器获取等。</p> </div> <div _ngcontent-kpt-c106="" class="highlight-div"><div _ngcontent-kpt-c106="" class="highlight-div-header"><div _ngcontent-kpt-c106="" class="highlight-div-header-left"><div _ngcontent-kpt-c106="" class="handle-button expand-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpt-c106="" class="highlight-div-header-right"><div _ngcontent-kpt-c106="" class="handle-button ai-button"></div><div _ngcontent-kpt-c106="" class="handle-button line-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpt-c106="" class="handle-button theme-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpt-c106="" class="handle-button copy-button"><div _ngcontent-kpt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpt-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/resources/rawfile/sourceData.json ------ 仅用于测试数据插入，请开发者根据业务需要预置数据库数据</span></li><li><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"【请阅】手机优惠政策"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"sender_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"sender_email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan@xxx.com"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"received_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-05-15 15:49:04.135"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"recipients"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lisi@xxx.com"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lisi"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span></li><li>    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wangwu@xxx.com"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wangwu"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span></li><li>    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhaoliu@xxx.com"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhaoliu"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-string">"lisi"</span></li><li>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"cc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-string">"wangwu"</span></li><li>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"bcc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-string">"zhaoliu"</span></li><li>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"优惠政策：\r\n旗舰系列优惠10%！！ 非旗舰系列优惠20%！！。"</span><span class="hljs-punctuation">,</span></li><li>  <span class="hljs-attr">"unread"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span></li><li><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li></ol></pre></div></div> </div> <div></div></div>