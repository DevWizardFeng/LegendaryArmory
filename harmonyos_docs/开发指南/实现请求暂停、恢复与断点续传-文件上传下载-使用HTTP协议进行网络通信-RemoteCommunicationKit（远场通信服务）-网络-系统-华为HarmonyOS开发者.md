<h1 _ngcontent-tfn-c119="" class="doc-title ng-star-inserted" title="实现请求暂停、恢复与断点续传"> 实现请求暂停、恢复与断点续传 </h1>

<div _ngcontent-tfn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2>          <p>请求暂停、恢复与断点续传能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section84625225310">请求暂停、恢复<i class="anchor-icon anchor-icon-link" anchorid="section84625225310" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1445492712549" class="firsth2">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1445492712549" tips="复制节点链接"></i></h3>          <p>Remote Communication Kit提供完善的功能支持，包括请求的暂停和恢复功能。这不仅涵盖接收暂停，还包括发送暂停。</p>    </div>    <div class="tiledSection">     <h3 id="section2541252115420">使用实例<i class="anchor-icon anchor-icon-link" anchorid="section2541252115420" tips="复制节点链接"></i></h3>          <ol>      <li><span>导入需要的模块。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>定义调试信息接口、调试信息源类型以及调试信息序列化函数，用于将调试信息序列化为StringifiedDebugInfo数组。函数首先根据infoSource的类型获取调试信息，然后使用TextDecoder将调试信息的data字段解码为字符串，并返回一个包含解码后的调试信息的数组。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">HTTP_SERVER_POST</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"https://example.org/anything"</span>;</li><li><span class="hljs-comment">// 定义调试信息接口</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">StringifiedDebugInfo</span> {</li><li>  <span class="hljs-attr">type</span>: rcp.<span class="hljs-property">DebugEvent</span>;</li><li>  <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>;</li><li>};</li><li><span class="hljs-comment">// 定义调试信息源类型</span></li><li><span class="hljs-keyword">type</span> <span class="hljs-title class_">DebugInfoSource</span> = <span class="hljs-literal">undefined</span> | rcp.<span class="hljs-property">DebugInfo</span>[] | rcp.<span class="hljs-property">Response</span>;</li><li>
</li><li><span class="hljs-comment">// 定义调试信息序列化函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">debugInfoStringify</span>(<span class="hljs-params">infoSource: DebugInfoSource</span>): <span class="hljs-title class_">StringifiedDebugInfo</span>[] {</li><li>  <span class="hljs-keyword">const</span> debugInfo = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(infoSource)</li><li>    ? (infoSource <span class="hljs-keyword">as</span> rcp.<span class="hljs-property">DebugInfo</span>[])</li><li>    : (infoSource <span class="hljs-keyword">as</span> rcp.<span class="hljs-property">Response</span>).<span class="hljs-property">debugInfo</span>;</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!debugInfo) {</li><li>    <span class="hljs-keyword">return</span> [];</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">const</span> decoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>);</li><li>  <span class="hljs-keyword">return</span> debugInfo.<span class="hljs-title function_">map</span>((<span class="hljs-attr">i</span>: rcp.<span class="hljs-property">DebugInfo</span>): <span class="hljs-function"><span class="hljs-params">StringifiedDebugInfo</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">type</span>: i.<span class="hljs-property">type</span>,</li><li>      <span class="hljs-attr">data</span>: decoder.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(i.<span class="hljs-property">data</span>)).<span class="hljs-title function_">trim</span>(),</li><li>    };</li><li>  });</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>获取发送暂停和恢复事件，用于从调试信息中筛选出发送暂停和恢复事件。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSendPausedEvents</span>(<span class="hljs-params">debugInfo: DebugInfoSource</span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">debugInfoStringify</span>(debugInfo).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.<span class="hljs-property">data</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'[[RCP]]: Pause sending'</span>));</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSendResumedEvents</span>(<span class="hljs-params">debugInfo: DebugInfoSource</span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">debugInfoStringify</span>(debugInfo).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> i.<span class="hljs-property">data</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'[[RCP]]: Resume sending'</span>));</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>编写发起请求的函数。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-title class_">SendingPauseByTimeout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">done</span>: <span class="hljs-title class_">Function</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>  <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>  <span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">Request</span>(<span class="hljs-variable constant_">HTTP_SERVER_POST</span>);</li><li>  <span class="hljs-comment">// 定义发送暂停策略，kind为'timeout'，timeoutMs为1ms</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">sendPolicy</span>: rcp.<span class="hljs-property">SendingPausePolicy</span> = {</li><li>    <span class="hljs-attr">kind</span>: <span class="hljs-string">'timeout'</span>,</li><li>    <span class="hljs-attr">timeoutMs</span>: <span class="hljs-number">1</span>,</li><li>  };</li><li>  <span class="hljs-comment">// 定义暂停策略，sending字段引用了上述定义的发送暂停策略</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">pausePolicy</span>: rcp.<span class="hljs-property">PausePolicy</span> = {</li><li>    <span class="hljs-attr">sending</span>: sendPolicy,</li><li>  };</li><li>  <span class="hljs-comment">// 设置请求的配置，包括传输策略和跟踪信息</span></li><li>  request.<span class="hljs-property">configuration</span> = {</li><li>    <span class="hljs-attr">transfer</span>: {</li><li>      <span class="hljs-attr">pausePolicy</span>: pausePolicy,</li><li>    },</li><li>    <span class="hljs-attr">tracing</span>: {</li><li>      <span class="hljs-attr">infoToCollect</span>: {</li><li>        <span class="hljs-attr">textual</span>: <span class="hljs-literal">true</span>,</li><li>      },</li><li>    },</li><li>  };</li><li>  <span class="hljs-comment">// 定义请求体数据</span></li><li>  <span class="hljs-keyword">const</span> data = <span class="hljs-string">'TestData'</span>;</li><li>  <span class="hljs-comment">// 设置请求头，'Content-Length'字段表示请求体的长度</span></li><li>  request.<span class="hljs-property">headers</span> = {</li><li>    <span class="hljs-string">'Content-Length'</span>: data.<span class="hljs-property">length</span>.<span class="hljs-title function_">toString</span>(),</li><li>  };</li><li>  <span class="hljs-comment">// 定义布尔型标志变量用于控制请求体生成</span></li><li>  <span class="hljs-keyword">let</span> isReadCompleted = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// 设置请求方法为POST</span></li><li>  request.<span class="hljs-property">method</span> = <span class="hljs-string">'POST'</span>;</li><li>  <span class="hljs-comment">// 定义请求体内容生成函数，如果read为true，则返回空的ArrayBuffer，否则生成包含请求体数据的ArrayBuffer</span></li><li>  request.<span class="hljs-property">content</span> = <span class="hljs-function">(<span class="hljs-params">maxSize</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (isReadCompleted) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0</span>);</li><li>    }</li><li>    isReadCompleted = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(data.<span class="hljs-property">length</span>);</li><li>    util.<span class="hljs-property">TextEncoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">encodeIntoUint8Array</span>(data, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer));</li><li>    <span class="hljs-keyword">return</span> buffer;</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 发送请求并等待响应</span></li><li>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">fetch</span>(request)</li><li>
</li><li>  <span class="hljs-comment">// 从响应的调试信息中获取发送暂停和恢复事件</span></li><li>  <span class="hljs-keyword">const</span> pausedEvents = <span class="hljs-title function_">getSendPausedEvents</span>(response);</li><li>  <span class="hljs-keyword">const</span> resumedEvents = <span class="hljs-title function_">getSendResumedEvents</span>(response);</li><li>
</li><li>  <span class="hljs-comment">// 关闭会话</span></li><li>  session.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-comment">// 调用完成回调函数</span></li><li>  <span class="hljs-title function_">done</span>();</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section4239181554">实现断点续传<i class="anchor-icon anchor-icon-link" anchorid="section4239181554" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section0207130175519" class="firsth2">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section0207130175519" tips="复制节点链接"></i></h3>          <p>在需要接续数据请求的场景中，用户可以通过定义<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section838945575618" target="_blank">TransferRange</a>对象的from和to属性来控制数据的截取范围。下载的内容可以被准确地截取并拼接到目标文件中，确保数据的完整性和一致性，开发者可以灵活地管理和恢复下载过程。</p>    </div>    <div class="tiledSection">     <h3 id="section158333015518">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section158333015518" tips="复制节点链接"></i></h3>          <ol>      <li><span>导入模块。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>创建session，定义请求URL，并对request进行配置，同时定义变量以记录下载文件的总大小。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建会话</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: rcp.<span class="hljs-property">Session</span> | <span class="hljs-literal">null</span> = rcp.<span class="hljs-title function_">createSession</span>();</li><li><span class="hljs-comment">// 定义服务器地址</span></li><li><span class="hljs-keyword">const</span> kHttpServerAddress = <span class="hljs-string">"http://www.example.com/fetch"</span>;</li><li><span class="hljs-comment">// 创建请求</span></li><li><span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">Request</span>(kHttpServerAddress, <span class="hljs-string">"GET"</span>);</li><li><span class="hljs-comment">// 定义变量记录下载文件的大小</span></li><li><span class="hljs-keyword">let</span> totalSize = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 定义一个存储上次传输位置的变量</span></li><li><span class="hljs-keyword">let</span> lastTransferPosition = <span class="hljs-number">0</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>编写一个函数以获取要下载的文件大小。有多种方法可以获取下载文件的大小，请根据实际需求选择合适的方法。在本例中，通过从响应数据的header中的content-range字段来获取下载文件的总大小。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 获取要下载文件的大小</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> 文件的大小</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getTotalSize</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  request.<span class="hljs-property">transferRange</span> = { <span class="hljs-attr">from</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">1</span> };</li><li>  <span class="hljs-keyword">let</span> totalSize = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> rep = <span class="hljs-keyword">await</span> session?.<span class="hljs-title function_">fetch</span>(request);</li><li>    <span class="hljs-keyword">if</span> (rep) {</li><li>      <span class="hljs-comment">// 从响应数据的header的content-range字段中提取出文件的大小</span></li><li>      <span class="hljs-keyword">let</span> contentRange = rep.<span class="hljs-property">headers</span>[<span class="hljs-string">'content-range'</span>];</li><li>      <span class="hljs-keyword">let</span> sizeStr = contentRange ? contentRange.<span class="hljs-title function_">substring</span>(contentRange.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'\/'</span>) + <span class="hljs-number">1</span>, contentRange.<span class="hljs-property">length</span>) : <span class="hljs-string">'0'</span>;</li><li>      totalSize = <span class="hljs-title class_">Number</span>(sizeStr);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getTotalSize err: code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`getTotalSize totalSize: <span class="hljs-subst">${totalSize.toString()}</span>`</span>);</li><li>  <span class="hljs-keyword">return</span> totalSize;</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>编写一个依据传输范围下载文件的函数。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 根据传输范围下载文件</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">from</span> - 传输范围的起始位置</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">to</span> - 传输范围的结束位置</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadTransfer</span>(<span class="hljs-params"><span class="hljs-keyword">from</span>: <span class="hljs-built_in">number</span>, to: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-comment">// 设置请求的数据传输范围</span></li><li>  request.<span class="hljs-property">transferRange</span> = { <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span>, <span class="hljs-attr">to</span>: to };</li><li>  session?.<span class="hljs-title function_">fetch</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">rep</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (rep.<span class="hljs-property">body</span>) {</li><li>      <span class="hljs-comment">// 处理响应，可以在此处将文件保存到本地</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Response succeeded: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(rep.headers)}</span>`</span>);</li><li>      <span class="hljs-comment">// 下次传输的起始位置 = 上次的位置 + 本次传输数据的长度</span></li><li>      lastTransferPosition += rep.<span class="hljs-property">body</span>.<span class="hljs-property">byteLength</span>;</li><li>      <span class="hljs-keyword">if</span> (lastTransferPosition &lt; totalSize) {</li><li>        <span class="hljs-comment">// 计算下一次传输范围的结束位置</span></li><li>        <span class="hljs-keyword">const</span> nextTo = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(lastTransferPosition + <span class="hljs-number">100</span>, totalSize);</li><li>        <span class="hljs-comment">// 递归调用继续下载下一段数据</span></li><li>        <span class="hljs-title function_">downloadTransfer</span>(lastTransferPosition, nextTo);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Response succeeded, completed."</span>);</li><li>      }</li><li>    }</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Continue transfer error: code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>使用以下方式开始下载。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 开始下载</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startDownload</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!session) {</li><li>    session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>  }</li><li>  <span class="hljs-comment">// 传输位置归零</span></li><li>  lastTransferPosition = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 获取要下载文件的总大小</span></li><li>  totalSize = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getTotalSize</span>();</li><li>  <span class="hljs-comment">// 计算传输范围的结束位置</span></li><li>  <span class="hljs-keyword">const</span> nextTo = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(lastTransferPosition + <span class="hljs-number">100</span>, totalSize);</li><li>  <span class="hljs-comment">// 开始下载</span></li><li>  <span class="hljs-title function_">downloadTransfer</span>(lastTransferPosition, nextTo);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>使用以下方式暂停下载。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 暂停下载</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">pauseDownload</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 取消下载请求</span></li><li>  session?.<span class="hljs-title function_">cancel</span>(request);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>使用以下方式继续下载。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 继续下载</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">resumeDownload</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 计算传输范围的结束位置</span></li><li>  <span class="hljs-keyword">const</span> nextTo = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(lastTransferPosition + <span class="hljs-number">100</span>, totalSize);</li><li>  <span class="hljs-comment">// 开始下载</span></li><li>  <span class="hljs-title function_">downloadTransfer</span>(lastTransferPosition, nextTo);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>使用以下方式停止下载。</span>       <p></p>       <div _ngcontent-tfn-c106="" class="highlight-div"><div _ngcontent-tfn-c106="" class="highlight-div-header"><div _ngcontent-tfn-c106="" class="highlight-div-header-left"><div _ngcontent-tfn-c106="" class="handle-button expand-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tfn-c106="" class="highlight-div-header-right"><div _ngcontent-tfn-c106="" class="handle-button ai-button"></div><div _ngcontent-tfn-c106="" class="handle-button line-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tfn-c106="" class="handle-button theme-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tfn-c106="" class="handle-button copy-button"><div _ngcontent-tfn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tfn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 停止下载</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">stopDownload</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 取消下载请求</span></li><li>  session?.<span class="hljs-title function_">cancel</span>(request);</li><li>  <span class="hljs-comment">// 关闭session</span></li><li>  session?.<span class="hljs-title function_">close</span>();</li><li>  session = <span class="hljs-literal">null</span>;</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>