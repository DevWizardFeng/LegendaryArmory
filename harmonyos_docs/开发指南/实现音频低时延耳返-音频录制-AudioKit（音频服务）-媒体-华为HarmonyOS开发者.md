<h1 _ngcontent-iip-c119="" class="doc-title ng-star-inserted" title="实现音频低时延耳返"> 实现音频低时延耳返 </h1>

<div _ngcontent-iip-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 20开始，支持音频低时延耳返。</p>    <p>AudioLoopback是音频返听器，可将音频以更低时延的方式实时传输到耳机中，让用户可以实时听到自己或者其他的相关声音。</p>    <p>常用于K歌类应用，将录制的人声和背景音乐实时传送到耳机中，使用户通过反馈即时进行调整，获得更好的使用体验。</p>    <p>当启用音频返听时，系统会创建低时延渲染器与低时延采集器，实现低时延耳返功能。采集的音频直接通过内部路由返回到渲染器。对于渲染器，其音频焦点策略与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#streamusage" target="_blank">STREAM_USAGE_MUSIC</a>相匹配。对于采集器，其音频焦点策略与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#sourcetype8" target="_blank">SOURCE_TYPE_MIC</a>相匹配。</p>    <p>输入\输出设备由系统自动选择。如果当前输入\输出不支持低时延，则音频返听无法启用。在运行过程中，如果音频焦点被另一个音频流抢占，输入\输出设备切换到不支持低时延的设备，系统会自动禁用音频返听。</p>    <div class="tiledSection">     <h2 id="使用前提">使用前提<i class="anchor-icon anchor-icon-link" anchorid="使用前提" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>当前仅支持通过有线耳机实现低时延返听功能，音频由有线耳机进行采集并播放。</p></li>      <li>       <p>低功耗渲染器和低时延渲染器在API version 20不能实现并发。若要启用渲染器，建议采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#streamusage" target="_blank">STREAM_USAGE_UNKNOWN</a>；系统内决策采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#streamusage" target="_blank">STREAM_USAGE_MUSIC</a>创建普通渲染器。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>使用AudioLoopback音频返听涉及到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#isaudioloopbacksupported20" target="_blank">isAudioLoopbackSupported</a>返听能力查询、AudioLoopback实例创建、返听音量设置、返听状态监听与返听启用禁用等。本开发指导将以一次启用返听的过程为例，向开发者讲解如何使用AudioLoopback进行音频返听，建议搭配<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback" target="_blank">AudioLoopback</a>的API说明阅读。</p>     <p>下图展示了AudioLoopback的状态变化，在创建实例后，调用对应的方法可以进入指定的状态实现对应行为。</p>     <p>需要注意的是在确定的状态执行不合适的方法可能导致AudioLoopback发生错误，建议开发者在调用状态转换的方法前进行状态检查，避免程序运行产生预期以外的结果。</p>     <p><strong>AudioLoopback状态变化示意图</strong></p>     <p><span><img originheight="612" originwidth="909" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114434.41780302825704964557553193411512:50001231000000:2800:F28C8B6B40DAB7FF0796E2FD9EF3E4EC6265DE3C5870D1489263D7E489C80661.png" width="909" height="612"></span></p>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#onstatuschange20" target="_blank">on('statusChange')</a>方法可以监听AudioLoopback的状态变化，每个状态对应值与说明见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackstatus20" target="_blank">AudioLoopbackStatus</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤及注意事项" class="firsth2">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>查询返听能力并创建AudioLoopback实例，音频返听模式可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackmode20" target="_blank">AudioLoopbackMode</a>。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>返听需要申请麦克风权限ohos.permission.MICROPHONE，申请方式参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> </li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">mode</span>: audio.<span class="hljs-property">AudioLoopbackMode</span> = audio.<span class="hljs-property">AudioLoopbackMode</span>.<span class="hljs-property">HARDWARE</span>;</li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">audioLoopback</span>: audio.<span class="hljs-property">AudioLoopback</span>;</li><li> <span class="hljs-keyword">let</span> isSupported = audio.<span class="hljs-title function_">getAudioManager</span>().<span class="hljs-title function_">getStreamManager</span>().<span class="hljs-title function_">isAudioLoopbackSupported</span>(mode);</li><li> <span class="hljs-keyword">if</span> (isSupported) {</li><li>   audio.<span class="hljs-title function_">createAudioLoopback</span>(mode).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">loopback</span>) =&gt;</span> {</li><li>     audioLoopback = loopback;</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Invoke createAudioLoopback succeeded.'</span>);</li><li>   }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke createAudioLoopback failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>   });</li><li> }</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#getstatus20" target="_blank">getStatus</a>方法，查询当前返听状态。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>音频返听状态受音频焦点、低时延管控、采集与播放设备等因素影响。</p>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioLoopback.<span class="hljs-title function_">getStatus</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">status: audio.AudioLoopbackStatus</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`getStatus success, status is <span class="hljs-subst">${status}</span>.`</span>);</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getStatus failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li> })</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#setvolume20" target="_blank">setVolume</a>方法，设置音频返听音量。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ul>          <li>在启用返听前设置音量，音量将在启用返听成功后生效。</li>          <li>在启用返听后设置音量，音量将立即生效。</li>          <li>启用返听前未设置音量，启用返听时将采用默认音量0.5。</li>         </ul>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioLoopback.<span class="hljs-title function_">setVolume</span>(<span class="hljs-number">0.5</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setVolume success.'</span>);</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setVolume failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li> });</li></ol></pre></div></div></li>      <li>       <p>从API21开始，支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#setreverbpreset21" target="_blank">setReverbPreset</a>方法，设置音频返听的混响模式。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ul>          <li>在启用返听前设置混响模式，混响模式将在启用返听成功后生效。</li>          <li>在启用返听后设置混响模式，混响模式将立即生效。</li>          <li>启用返听前未设置混响模式，启用返听时将采用默认混响模式<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackreverbpreset21" target="_blank">THEATER</a>。</li>         </ul>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">try</span> {</li><li>   audioLoopback.<span class="hljs-title function_">setReverbPreset</span>(audio.<span class="hljs-property">AudioLoopbackReverbPreset</span>.<span class="hljs-property">THEATER</span>);</li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setReverbPreset :ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li> }</li></ol></pre></div></div></li>      <li>       <p>从API21开始，支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#getreverbpreset21" target="_blank">getReverbPreset</a>方法，查询当前的音频返听的混响模式。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>若未设置混响模式，查询得到将是默认混响模式<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackreverbpreset21" target="_blank">THEATER</a>。</p>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-keyword">let</span> reverbPreset = audioLoopback.<span class="hljs-title function_">getReverbPreset</span>();</li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getReverbPreset:ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li> }</li></ol></pre></div></div></li>      <li>       <p>从API21开始，支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#setequalizerpreset21" target="_blank">setEqualizerPreset</a>方法，设置音频返听的均衡器类型。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ul>          <li>在启用返听前设置均衡器类型，均衡器类型将在启用返听成功后生效。</li>          <li>在启用返听后设置均衡器类型，均衡器类型将立即生效。</li>          <li>启用返听前未设置均衡器类型，启用返听时将采用默认均衡器类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackequalizerpreset21" target="_blank">FULL</a>。</li>         </ul>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">try</span> {</li><li>   audioLoopback.<span class="hljs-title function_">setEqualizerPreset</span>(audio.<span class="hljs-property">AudioLoopbackEqualizerPreset</span>.<span class="hljs-property">FULL</span>);</li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setEqualizerPreset :ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li> }</li></ol></pre></div></div></li>      <li>       <p>从API21开始，支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#getequalizerpreset21" target="_blank">getEqualizerPreset</a>方法，查询当前的音频返听的均衡器类型。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>若未设置均衡器类型，查询得到将是默认均衡器类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audioloopbackequalizerpreset21" target="_blank">FULL</a>。</p>        </div></div></div>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-keyword">let</span> reverbPreset = audioLoopback.<span class="hljs-title function_">getEqualizerPreset</span>();</li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getEqualizerPreset:ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li> }</li></ol></pre></div></div></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audioloopback#enable20" target="_blank">enable</a>方法，启用或禁用音频返听功能。</p>       <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> audioLoopback.<span class="hljs-title function_">enable</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">isSuccess</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (isSuccess) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'enable success.'</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'enable failed.'</span>);</li><li>   }</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`enable failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li> });</li><li>
</li><li> audioLoopback.<span class="hljs-title function_">enable</span>(<span class="hljs-literal">false</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">isSuccess</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">if</span> (isSuccess) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'disable success.'</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'disable failed.'</span>);</li><li>   }</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`disable failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li> });</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h3>          <p>使用AudioLoopback启用音频低时延返听示例代码如下所示。</p>     <div _ngcontent-iip-c106="" class="highlight-div"><div _ngcontent-iip-c106="" class="highlight-div-header"><div _ngcontent-iip-c106="" class="highlight-div-header-left"><div _ngcontent-iip-c106="" class="handle-button expand-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iip-c106="" class="highlight-div-header-right"><div _ngcontent-iip-c106="" class="handle-button ai-button"></div><div _ngcontent-iip-c106="" class="handle-button line-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iip-c106="" class="handle-button theme-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iip-c106="" class="handle-button copy-button"><div _ngcontent-iip-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iip-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'AudioLoopbackDemo'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">mode</span>: audio.<span class="hljs-property">AudioLoopbackMode</span> = audio.<span class="hljs-property">AudioLoopbackMode</span>.<span class="hljs-property">HARDWARE</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioLoopback</span>: audio.<span class="hljs-property">AudioLoopback</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">currentReverbPreset</span>: audio.<span class="hljs-property">AudioLoopbackReverbPreset</span> = audio.<span class="hljs-property">AudioLoopbackReverbPreset</span>.<span class="hljs-property">THEATER</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">currentEqualizerPreset</span>: audio.<span class="hljs-property">AudioLoopbackEqualizerPreset</span> = audio.<span class="hljs-property">AudioLoopbackEqualizerPreset</span>.<span class="hljs-property">FULL</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">statusChangeCallback</span> = (<span class="hljs-params">status: audio.AudioLoopbackStatus</span>) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">UNAVAILABLE_DEVICE</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Audio loopback status is: UNAVAILABLE_DEVICE'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">UNAVAILABLE_SCENE</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Audio loopback status is: UNAVAILABLE_SCENE'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">AVAILABLE_IDLE</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Audio loopback status is: AVAILABLE_IDLE'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">AVAILABLE_RUNNING</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Audio loopback status is: AVAILABLE_RUNNING'</span>);</li><li>  }</li><li>};</li><li>
</li><li><span class="hljs-comment">// 查询能力，创建实例。</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> isSupported = audio.<span class="hljs-title function_">getAudioManager</span>().<span class="hljs-title function_">getStreamManager</span>().<span class="hljs-title function_">isAudioLoopbackSupported</span>(mode);</li><li>  <span class="hljs-keyword">if</span> (isSupported) {</li><li>    audio.<span class="hljs-title function_">createAudioLoopback</span>(mode).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">loopback</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Invoke createAudioLoopback succeeded.'</span>);</li><li>      audioLoopback = loopback;</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke createAudioLoopback failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback is unsupported.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置音频返听音量。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setVolume</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioLoopback !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">setVolume</span>(volume);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Invoke setVolume <span class="hljs-subst">${volume}</span> succeeded.`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke setVolume failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback not created.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置音频返听的混响模式。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setReverbPreset</span>(<span class="hljs-params">preset: audio.AudioLoopbackReverbPreset</span>) {</li><li>  <span class="hljs-keyword">if</span> (audioLoopback !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      audioLoopback.<span class="hljs-title function_">setReverbPreset</span>(preset);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setReverbPreset( <span class="hljs-subst">${preset}</span> succeeded.`</span>);</li><li>      currentReverbPreset = audioLoopback.<span class="hljs-title function_">getReverbPreset</span>(); <span class="hljs-comment">// 查询当前的混响模式，防止设置失败。</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setReverbPreset( failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback not created.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置音频返听的均衡器类型。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setEqualizerPreset</span>(<span class="hljs-params">preset: audio.AudioLoopbackEqualizerPreset</span>) {</li><li>  <span class="hljs-keyword">if</span> (audioLoopback !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      audioLoopback.<span class="hljs-title function_">setEqualizerPreset</span>(preset);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setEqualizerPreset <span class="hljs-subst">${preset}</span> succeeded.`</span>);</li><li>      currentEqualizerPreset = audioLoopback.<span class="hljs-title function_">getEqualizerPreset</span>(); <span class="hljs-comment">// 查询当前的均衡器类型，防止设置失败。</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`setEqualizerPreset failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback not created.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置监听事件，启用音频返听。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">enable</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioLoopback !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">getStatus</span>();</li><li>      <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">AVAILABLE_IDLE</span>) {</li><li>        <span class="hljs-comment">// 注册监听。</span></li><li>        audioLoopback.<span class="hljs-title function_">on</span>(<span class="hljs-string">'statusChange'</span>, statusChangeCallback);</li><li>        <span class="hljs-comment">// 启动返听。</span></li><li>        <span class="hljs-keyword">let</span> success = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">enable</span>(<span class="hljs-literal">true</span>);</li><li>        <span class="hljs-keyword">if</span> (success) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Invoke enable succeeded'</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          status = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">getStatus</span>();</li><li>          <span class="hljs-title function_">statusChangeCallback</span>(status);</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">statusChangeCallback</span>(status);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke enable failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback not created.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 禁用音频返听，关闭监听事件。</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">disable</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (audioLoopback !== <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">getStatus</span>();</li><li>      <span class="hljs-keyword">if</span> (status == audio.<span class="hljs-property">AudioLoopbackStatus</span>.<span class="hljs-property">AVAILABLE_RUNNING</span>) {</li><li>        <span class="hljs-comment">// 禁用返听。</span></li><li>        <span class="hljs-keyword">let</span> success = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">enable</span>(<span class="hljs-literal">false</span>);</li><li>        <span class="hljs-keyword">if</span> (success) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Invoke disable succeeded'</span>);</li><li>          <span class="hljs-comment">// 关闭监听。</span></li><li>          audioLoopback.<span class="hljs-title function_">off</span>(<span class="hljs-string">'statusChange'</span>, statusChangeCallback);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          status = <span class="hljs-keyword">await</span> audioLoopback.<span class="hljs-title function_">getStatus</span>();</li><li>          <span class="hljs-title function_">statusChangeCallback</span>(status);</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">statusChangeCallback</span>(status);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke disable failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Audio loopback not created.'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="音频低时延返听示例">音频低时延返听示例<i class="anchor-icon anchor-icon-link" anchorid="音频低时延返听示例" tips="复制节点链接"></i></h3>          <p>可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/Audio" target="_blank">使用AudioLoopback启用音频低时延返听的示例</a>。</p>    </div>   </div>   <div></div></div>