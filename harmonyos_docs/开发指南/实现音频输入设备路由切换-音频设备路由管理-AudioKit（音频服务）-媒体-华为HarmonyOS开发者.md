<h1 _ngcontent-lni-c119="" class="doc-title ng-star-inserted" title="实现音频输入设备路由切换"> 实现音频输入设备路由切换 </h1>

<div _ngcontent-lni-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 21开始，支持音频输入设备路由切换。</p>    <p>当应用进行音频输入时，系统会根据音频流类型选择对应的输入设备（SOURCE_TYPE_MIC：内置MIC录音；SOURCE_TYPE_VOICE_COMMUNICATION：跟随当前输出设备）。若默认输入设备不满足应用需求，应用可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiosessionmanager#setbluetoothandnearlinkpreferredrecordcategory21" target="_blank">setBluetoothAndNearlinkPreferredRecordCategory</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiosessionmanager#selectmediainputdevice21" target="_blank">selectMediaInputDevice</a>实现音频输入设备路由切换。</p>    <div class="tiledSection">     <h2 id="选择使用蓝牙或者星闪设备进行录音">选择使用蓝牙或者星闪设备进行录音<i class="anchor-icon anchor-icon-link" anchorid="选择使用蓝牙或者星闪设备进行录音" tips="复制节点链接"></i></h2>          <p>应用可使用AudioSessionManager的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiosessionmanager#setbluetoothandnearlinkpreferredrecordcategory21" target="_blank">setBluetoothAndNearlinkPreferredRecordCategory</a>设置应用程序的输入设备选择偏好，当蓝牙或星闪设备上线时生效。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>通话场景下，如果蓝牙或星闪设备在线，系统默认使用蓝牙或星闪设备作为输入设备。</p>      </div></div></div>     <div _ngcontent-lni-c106="" class="highlight-div"><div _ngcontent-lni-c106="" class="highlight-div-header"><div _ngcontent-lni-c106="" class="highlight-div-header-left"><div _ngcontent-lni-c106="" class="handle-button expand-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lni-c106="" class="highlight-div-header-right"><div _ngcontent-lni-c106="" class="handle-button ai-button"></div><div _ngcontent-lni-c106="" class="handle-button line-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lni-c106="" class="handle-button theme-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lni-c106="" class="handle-button copy-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lni-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;  <span class="hljs-comment">// 导入audio模块。</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> audioManager = audio.<span class="hljs-title function_">getAudioManager</span>();  <span class="hljs-comment">// 需要先创建AudioManager实例。</span></li><li>
</li><li><span class="hljs-keyword">let</span> audioSessionManager = audioManager.<span class="hljs-title function_">getSessionManager</span>();  <span class="hljs-comment">// 再调用AudioManager的方法创建AudioSessionManager实例。</span></li><li>
</li><li>audioSessionManager.<span class="hljs-title function_">setBluetoothAndNearlinkPreferredRecordCategory</span>(audio.<span class="hljs-property">BluetoothAndNearlinkPreferredRecordCategory</span>.<span class="hljs-property">PREFERRED_LOW_LATENCY</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in setting bluetooth and nearlink preferred record category.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set bluetooth and nearlink preferred record category. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="选择任意设备进行录音">选择任意设备进行录音<i class="anchor-icon anchor-icon-link" anchorid="选择任意设备进行录音" tips="复制节点链接"></i></h2>          <p>应用可使用AudioSessionManager的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiosessionmanager#selectmediainputdevice21" target="_blank">selectMediaInputDevice</a>选择输入设备。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>通话场景下，输入设备跟随当前输出设备，此时其他与通话并发的录音流也会跟随通话输入设备。</p>      </div></div></div>     <div _ngcontent-lni-c106="" class="highlight-div"><div _ngcontent-lni-c106="" class="highlight-div-header"><div _ngcontent-lni-c106="" class="highlight-div-header-left"><div _ngcontent-lni-c106="" class="handle-button expand-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lni-c106="" class="highlight-div-header-right"><div _ngcontent-lni-c106="" class="handle-button ai-button"></div><div _ngcontent-lni-c106="" class="handle-button line-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lni-c106="" class="handle-button theme-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lni-c106="" class="handle-button copy-button"><div _ngcontent-lni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lni-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;  <span class="hljs-comment">// 导入audio模块。</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> audioManager = audio.<span class="hljs-title function_">getAudioManager</span>();  <span class="hljs-comment">// 需要先创建AudioManager实例。</span></li><li>
</li><li><span class="hljs-keyword">let</span> audioSessionManager = audioManager.<span class="hljs-title function_">getSessionManager</span>();  <span class="hljs-comment">// 再调用AudioManager的方法创建AudioSessionManager实例。</span></li><li>
</li><li><span class="hljs-comment">// 监听音频可选输入设备连接状态变化事件，当有输入设备上下线时会收到回调通知。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">availableDeviceChangeCallback</span> = (<span class="hljs-params">deviceChanged: audio.DeviceChangeAction</span>) =&gt; {</li><li>  <span class="hljs-comment">// 回调返回更新后的可用输入设备列表，应用也可在此处执行选择输入设备操作。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: audio.<span class="hljs-property">AudioDeviceDescriptors</span> = deviceChanged.<span class="hljs-property">deviceDescriptors</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in using on or off function, AudioDeviceDescriptors: <span class="hljs-subst">${data}</span>.`</span>);</li><li>};</li><li>audioSessionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'availableDeviceChange'</span>, audio.<span class="hljs-property">DeviceUsage</span>.<span class="hljs-property">MEDIA_INPUT_DEVICES</span>, availableDeviceChangeCallback);</li><li>
</li><li><span class="hljs-comment">// 监听当前输入设备变化事件，当选择输入设备成功后会触发该回调。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">currentInputDeviceChangedCallback</span> = (<span class="hljs-params">currentInputDeviceChangedEvent: audio.CurrentInputDeviceChangedEvent</span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in using on or off function, CurrentInputDeviceChangedEvent: <span class="hljs-subst">${currentInputDeviceChangedEvent}</span>.`</span>);</li><li>};</li><li>audioSessionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'currentInputDeviceChanged'</span>, currentInputDeviceChangedCallback);</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 获取当前可选的音频输入设备列表。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: audio.<span class="hljs-property">AudioDeviceDescriptors</span> = audioSessionManager.<span class="hljs-title function_">getAvailableDevices</span>(audio.<span class="hljs-property">DeviceUsage</span>.<span class="hljs-property">MEDIA_INPUT_DEVICES</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in getting available devices, AudioDeviceDescriptors: <span class="hljs-subst">${data}</span>.`</span>);</li><li>
</li><li>  <span class="hljs-comment">// 当前可选音频输入设备列表不为空时，可进行选择。</span></li><li>  <span class="hljs-keyword">if</span> (data[<span class="hljs-number">0</span>]) {</li><li>    <span class="hljs-comment">// 选择输入设备。</span></li><li>    <span class="hljs-keyword">await</span> audioSessionManager.<span class="hljs-title function_">selectMediaInputDevice</span>(data[<span class="hljs-number">0</span>]).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in selecting media input device.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to select media input device. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get available devices. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 可通过该接口查询选择输入设备是否成功。</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">device</span>: audio.<span class="hljs-property">AudioDeviceDescriptor</span> = audioSessionManager.<span class="hljs-title function_">getSelectedMediaInputDevice</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting select media input device.'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get selected media input device. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 取消监听音频可选输入设备连接状态变化事件。</span></li><li>audioSessionManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'availableDeviceChange'</span>, availableDeviceChangeCallback);</li><li>
</li><li><span class="hljs-comment">// 取消监听当前输入设备变化事件。</span></li><li>audioSessionManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'currentInputDeviceChanged'</span>, currentInputDeviceChangedCallback);</li><li>
</li><li><span class="hljs-comment">// 清空通过selectMediaInputDevice选择的输入设备。</span></li><li>audioSessionManager.<span class="hljs-title function_">clearSelectedMediaInputDevice</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in clearing selected media input device.'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to clear selected media input device. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre></div></div>    </div>   </div>   <div></div></div>