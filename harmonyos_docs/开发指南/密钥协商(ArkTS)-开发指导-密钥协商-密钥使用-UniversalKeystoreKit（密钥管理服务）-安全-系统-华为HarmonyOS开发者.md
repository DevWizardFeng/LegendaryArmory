<h1 _ngcontent-lkx-c119="" class="doc-title ng-star-inserted" title="密钥协商(ArkTS)"> 密钥协商(ArkTS) </h1>

<div _ngcontent-lkx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>以X25519和DH两个协商密钥类型为例，在密钥由HUKS管理的情况下，完成密钥协商。具体的场景介绍及支持的算法规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-agreement-overview#支持的算法">密钥协商支持的算法</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p><strong>生成密钥</strong></p>     <p>设备A、设备B各自生成一个非对称密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview">密钥导入</a>。</p>     <p>密钥生成时，可指定参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-type-h#oh_huks_keystoragetype" target="_blank">HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG</a>（可选），用于标识基于该密钥协商出的密钥是否由HUKS管理。</p>     <ul>      <li>       <p>当TAG设置为HUKS_STORAGE_ONLY_USED_IN_HUKS时，表示基于该密钥协商出的密钥，由HUKS管理，可保证协商密钥全生命周期不出安全环境。</p></li>      <li>       <p>当TAG设置为HUKS_STORAGE_KEY_EXPORT_ALLOWED时，表示基于该密钥协商出的密钥，返回给调用方管理，由业务自行保证密钥安全。</p></li>      <li>       <p>若业务未设置TAG的具体值，表示基于该密钥协商出的密钥，可由HUKS管理，也可返回给调用方管理，业务可在后续协商时再选择使用何种方式保护密钥。</p></li>     </ul>     <p><strong>导出密钥</strong></p>     <p>设备A、B导出非对称密钥对的公钥材料，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-export-key-arkts">密钥导出</a>。</p>     <p><strong>密钥协商</strong></p>     <p>设备A、B分别基于本端私钥和对端设备的公钥，协商出共享密钥。</p>     <p>密钥协商时，可指定参数HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG（可选），用于标识协商得到的密钥是否由HUKS管理。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.11.1.4.1.1" valign="top" width="33.33333333333333%">生成</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.11.1.4.1.2" valign="top" width="33.33333333333333%">协商</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.11.1.4.1.3" valign="top" width="33.33333333333333%">规格</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_ONLY_USED_IN_HUKS</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_ONLY_USED_IN_HUKS</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_ONLY_USED_IN_HUKS</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>        </tr>             </tbody></table></div>     </div>     <p>注：协商时指定的TAG值，不可与生成时指定的TAG值冲突。表格中仅列举有效的指定方式。</p>     <p><strong>删除密钥</strong></p>     <p>当密钥废弃不用时，设备A、B均需要删除密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-delete-key-arkts">密钥删除</a>。</p>     <p>下面分别以X25519 与 DH密钥为例，进行协商。</p>    </div>    <div class="tiledSection">     <h3 id="x25519非对称密钥协商用例" class="firsth2">X25519非对称密钥协商用例<i class="anchor-icon anchor-icon-link" anchorid="x25519非对称密钥协商用例" tips="复制节点链接"></i></h3>          <div _ngcontent-lkx-c106="" class="highlight-div"><div _ngcontent-lkx-c106="" class="highlight-div-header"><div _ngcontent-lkx-c106="" class="highlight-div-header-left"><div _ngcontent-lkx-c106="" class="handle-button expand-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lkx-c106="" class="highlight-div-header-right"><div _ngcontent-lkx-c106="" class="handle-button ai-button"></div><div _ngcontent-lkx-c106="" class="handle-button line-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lkx-c106="" class="handle-button theme-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lkx-c106="" class="handle-button copy-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lkx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 以下以X25519密钥的Promise操作使用为例</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.BasicServicesKit"</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">StringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">Uint8ArrayToString</span>(<span class="hljs-params">fileData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> dataString = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; fileData.<span class="hljs-property">length</span>; i++) {</li><li>    dataString += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(fileData[i]);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> dataString;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 确定密钥别名和封装密钥属性参数集</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">let</span> srcKeyAliasFirst = <span class="hljs-string">"AgreeX25519KeyFirstAlias"</span>;</li><li><span class="hljs-keyword">let</span> srcKeyAliasSecond = <span class="hljs-string">"AgreeX25519KeySecondAlias"</span>;</li><li><span class="hljs-keyword">let</span> agreeX25519InData = <span class="hljs-string">'AgreeX25519TestIndata'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">finishOutData</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">handle</span>: <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">exportKey</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">exportKeyFirst</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">exportKeySecond</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-comment">/* 集成生成密钥参数集 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_X25519</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_AGREE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_CURVE25519_KEY_SIZE_256</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DIGEST</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyDigest</span>.<span class="hljs-property">HUKS_DIGEST_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyStorageType</span>.<span class="hljs-property">HUKS_STORAGE_ONLY_USED_IN_HUKS</span>,</li><li>  }</li><li>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">HuksOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: properties,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li><span class="hljs-comment">/* 集成第一个协商参数集 */</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">finishProperties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyStorageType</span>.<span class="hljs-property">HUKS_STORAGE_ONLY_USED_IN_HUKS</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_IS_KEY_ALIAS</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_AES</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_AES_KEY_SIZE_256</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>:</li><li>    huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span> |</li><li>    huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DIGEST</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyDigest</span>.<span class="hljs-property">HUKS_DIGEST_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_ECB</span>,</li><li>  }</li><li>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">finishOptionsFirst</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: [</li><li>    ...finishProperties, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_ALIAS</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-title class_">StringToUint8Array</span>(srcKeyAliasFirst + <span class="hljs-string">'final'</span>),</li><li>  }],</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-title class_">StringToUint8Array</span>(agreeX25519InData)</li><li>}</li><li><span class="hljs-comment">/* 集成第二个协商参数集 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">finishOptionsSecond</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: [</li><li>    ...finishProperties, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_ALIAS</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-title class_">StringToUint8Array</span>(srcKeyAliasSecond + <span class="hljs-string">'final'</span>),</li><li>  }],</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-title class_">StringToUint8Array</span>(agreeX25519InData)</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 生成密钥 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateKeyItem</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter generateKeyItem"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: generateKeyItem success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 初始化密钥会话接口，并获取一个句柄（必选）和挑战值（可选） */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSession</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter initSession"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        handle = data.<span class="hljs-property">handle</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: initSession success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 分段添加密钥操作的数据并进行相应的密钥操作，输出处理数据 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSession</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter updateSession"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">updateSession</span>(handle, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: updateSession success, data is `</span> + <span class="hljs-title class_">Uint8ArrayToString</span>(data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>));</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: updateSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: updateSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 结束密钥会话并进行相应的密钥操作，输出处理数据 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">finishSession</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter finishSession"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(handle, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        finishOutData = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: finishSession success, data is `</span> + <span class="hljs-title class_">Uint8ArrayToString</span>(data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>));</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 导出密钥 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">exportKeyItem</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter exportKeyItem"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">exportKeyItem</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        exportKey = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: exportKey success, data is `</span> + <span class="hljs-title class_">Uint8ArrayToString</span>(data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>));</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: exportKeyItem failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: exportKeyItem input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 删除密钥操作 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteKeyItem</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"promise: enter deleteKeyItem"</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">deleteKeyItem</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: deleteKeyItem success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: deleteKeyItem failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: deleteKeyItem input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testAgree</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">/* 1.确定密钥别名并集成要参数集。A设备：srcKeyAliasFirst；B设备：srcKeyAliasSecond */</span></li><li>  <span class="hljs-comment">/* 2.设备A生成密钥 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateKeyItem</span>(srcKeyAliasFirst, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-comment">/* 3.设备B生成密钥 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateKeyItem</span>(srcKeyAliasSecond, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-comment">/* 4.设备A、B导出非对称密钥的公钥 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportKeyItem</span>(srcKeyAliasFirst, <span class="hljs-title class_">HuksOptions</span>);</li><li>  exportKeyFirst = exportKey;</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportKeyItem</span>(srcKeyAliasSecond, <span class="hljs-title class_">HuksOptions</span>);</li><li>  exportKeySecond = exportKey;</li><li>  <span class="hljs-comment">/* 5.对第一个密钥进行协商（三段式） */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSession</span>(srcKeyAliasFirst, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-title class_">HuksOptions</span>.<span class="hljs-property">inData</span> = exportKeySecond;</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateSession</span>(handle, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">finishSession</span>(handle, finishOptionsFirst);</li><li>  <span class="hljs-comment">/* 6.对第二个密钥进行协商（三段式） */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSession</span>(srcKeyAliasSecond, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-title class_">HuksOptions</span>.<span class="hljs-property">inData</span> = exportKeyFirst;</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateSession</span>(handle, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">finishSession</span>(handle, finishOptionsSecond);</li><li>  <span class="hljs-comment">/* 7.设备A、B删除密钥 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">deleteKeyItem</span>(srcKeyAliasFirst, <span class="hljs-title class_">HuksOptions</span>);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">deleteKeyItem</span>(srcKeyAliasSecond, <span class="hljs-title class_">HuksOptions</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="dh密钥协商用例">DH密钥协商用例<i class="anchor-icon anchor-icon-link" anchorid="dh密钥协商用例" tips="复制节点链接"></i></h3>          <div _ngcontent-lkx-c106="" class="highlight-div"><div _ngcontent-lkx-c106="" class="highlight-div-header"><div _ngcontent-lkx-c106="" class="highlight-div-header-left"><div _ngcontent-lkx-c106="" class="handle-button expand-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lkx-c106="" class="highlight-div-header-right"><div _ngcontent-lkx-c106="" class="handle-button ai-button"></div><div _ngcontent-lkx-c106="" class="handle-button line-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lkx-c106="" class="handle-button theme-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lkx-c106="" class="handle-button copy-button"><div _ngcontent-lkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lkx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 下面以DH密钥的Promise操作使用为例</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">StringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = []</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i))</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr)</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">Uint8ArrayToBigInt</span>(<span class="hljs-params">arr: <span class="hljs-built_in">Uint8Array</span></span>): <span class="hljs-built_in">bigint</span> {</li><li>  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">byteMax</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-title class_">BigInt</span>(<span class="hljs-string">'0x100'</span>)</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-title class_">BigInt</span>(<span class="hljs-string">'0'</span>)</li><li>  <span class="hljs-keyword">while</span> (i &lt; arr.<span class="hljs-property">length</span>) {</li><li>    result = result * byteMax</li><li>    result = result + <span class="hljs-title class_">BigInt</span>(arr[i])</li><li>    i += <span class="hljs-number">1</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> result</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgree</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>  <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>  <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_DH</span>,</li><li>}, {</li><li>  <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>  <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_AGREE</span>,</li><li>}]</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">dh2048Agree</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [</li><li>  ...dhAgree, {</li><li>  <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>  <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_DH_KEY_SIZE_2048</span>,</li><li>}]</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">dhGenOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: dh2048Agree,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([])</li><li>}</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">emptyOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: [],</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([])</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HuksDhAgreeExportKey</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>,</span></li><li><span class="hljs-params">  peerPubKey: huks.HuksReturnResult</span>): <span class="hljs-title class_">Promise</span>&lt;huks.<span class="hljs-property">HuksReturnResult</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> initHandle = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, dhGenOptions)</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgreeUpdateBobPubKey</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: [</li><li>      ...dh2048Agree, {</li><li>      <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG</span>,</li><li>      <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyStorageType</span>.<span class="hljs-property">HUKS_STORAGE_KEY_EXPORT_ALLOWED</span>,</li><li>    }],</li><li>    <span class="hljs-attr">inData</span>: peerPubKey.<span class="hljs-property">outData</span></li><li>  }</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">updateSession</span>(initHandle.<span class="hljs-property">handle</span>, dhAgreeUpdateBobPubKey)</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(initHandle.<span class="hljs-property">handle</span>, emptyOptions)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HuksDhAgreeExportTest</span>(<span class="hljs-params"></span></li><li><span class="hljs-params">  aliasA: <span class="hljs-built_in">string</span>, aliasB: <span class="hljs-built_in">string</span>,</span></li><li><span class="hljs-params">  pubKeyA: huks.HuksReturnResult, pubKeyB: huks.HuksReturnResult</span>) {</li><li>
</li><li>  <span class="hljs-keyword">const</span> agreedKeyFromAlice = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeExportKey</span>(aliasA, pubKeyB)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! agreedKeyFromAlice export is 0x<span class="hljs-subst">${Uint8ArrayToBigInt(agreedKeyFromAlice.outData).toString(<span class="hljs-number">16</span>)}</span>`</span>)</li><li>
</li><li>  <span class="hljs-keyword">const</span> agreedKeyFromBob = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeExportKey</span>(aliasB, pubKeyA)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! agreedKeyFromBob export is 0x<span class="hljs-subst">${Uint8ArrayToBigInt(agreedKeyFromBob.outData).toString(<span class="hljs-number">16</span>)}</span>`</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HuksDhAgreeInHuks</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, peerPubKey: huks.HuksReturnResult,</span></li><li><span class="hljs-params">  aliasAgreedKey: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;huks.<span class="hljs-property">HuksReturnResult</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">onlyUsedInHuks</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_STORAGE_FLAG</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyStorageType</span>.<span class="hljs-property">HUKS_STORAGE_ONLY_USED_IN_HUKS</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyStorageType</span>.<span class="hljs-property">HUKS_STORAGE_ONLY_USED_IN_HUKS</span>,</li><li>  }]</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgreeInit</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: [</li><li>      ...dhAgree,</li><li>      { <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>, <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_AES_KEY_SIZE_256</span>, },</li><li>      ...onlyUsedInHuks],</li><li>    <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([])</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgreeFinishParams</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [</li><li>    ...onlyUsedInHuks,</li><li>    { <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_IS_KEY_ALIAS</span>, <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> },</li><li>    { <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>, <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_AES</span> },</li><li>    { <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>, <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_AES_KEY_SIZE_256</span> },</li><li>    {</li><li>      <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>      <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span> | huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span></li><li>    }</li><li>  ]</li><li>
</li><li>  <span class="hljs-keyword">const</span> handle = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, dhAgreeInit)</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgreeUpdatePubKey</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: [...dhAgree, ...onlyUsedInHuks],</li><li>    <span class="hljs-attr">inData</span>: peerPubKey.<span class="hljs-property">outData</span></li><li>  }</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">updateSession</span>(handle.<span class="hljs-property">handle</span>, dhAgreeUpdatePubKey)</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">dhAgreeAliceFinnish</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: [...dhAgreeFinishParams, {</li><li>      <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_ALIAS</span>, <span class="hljs-attr">value</span>: <span class="hljs-title class_">StringToUint8Array</span>(aliasAgreedKey)</li><li>    }], <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([])</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(handle.<span class="hljs-property">handle</span>, dhAgreeAliceFinnish)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HuksDhAgreeInHuksTest</span>(<span class="hljs-params"></span></li><li><span class="hljs-params">  aliasA: <span class="hljs-built_in">string</span>, aliasB: <span class="hljs-built_in">string</span>,</span></li><li><span class="hljs-params">  pubKeyA: huks.HuksReturnResult, pubKeyB: huks.HuksReturnResult,</span></li><li><span class="hljs-params">  aliasAgreedKeyFromA: <span class="hljs-built_in">string</span>, aliasAgreedKeyFromB: <span class="hljs-built_in">string</span></span>) {</li><li>
</li><li>  <span class="hljs-keyword">const</span> finishAliceResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeInHuks</span>(aliasA, pubKeyB, aliasAgreedKeyFromA)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! finishAliceResult in huks is 0x<span class="hljs-subst">${Uint8ArrayToBigInt(finishAliceResult.outData).toString(<span class="hljs-number">16</span>)}</span>`</span>)</li><li>  <span class="hljs-keyword">const</span> aliceAgreedExist = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">isKeyItemExist</span>(aliasAgreedKeyFromA, emptyOptions)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! aliceAgreedExist in huks is <span class="hljs-subst">${aliceAgreedExist}</span>`</span>)</li><li>
</li><li>  <span class="hljs-keyword">const</span> finishBobResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeInHuks</span>(aliasB, pubKeyA, aliasAgreedKeyFromB)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! finishBobResult in huks is 0x<span class="hljs-subst">${Uint8ArrayToBigInt(finishBobResult.outData).toString(<span class="hljs-number">16</span>)}</span>`</span>)</li><li>  <span class="hljs-keyword">const</span> bobAgreedExist = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">isKeyItemExist</span>(aliasAgreedKeyFromB, emptyOptions)</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ok! bobAgreedExist in huks is <span class="hljs-subst">${bobAgreedExist}</span>`</span>)</li><li>
</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">deleteKeyItem</span>(aliasAgreedKeyFromA, emptyOptions)</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">deleteKeyItem</span>(aliasAgreedKeyFromB, emptyOptions)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HuksDhAgreeTest</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> aliasAlice = <span class="hljs-string">'alice'</span></li><li>  <span class="hljs-keyword">const</span> aliasBob = <span class="hljs-string">'bob'</span></li><li>
</li><li>  <span class="hljs-comment">/* 调用generateKeyItem生成别名为alice与bob的两个密钥 */</span></li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(aliasAlice, dhGenOptions)</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(aliasBob, dhGenOptions)</li><li>
</li><li>  <span class="hljs-comment">/* 导出非对称密钥alice与bob的公钥 */</span></li><li>  <span class="hljs-keyword">const</span> pubKeyAlice = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">exportKeyItem</span>(aliasAlice, emptyOptions)</li><li>  <span class="hljs-keyword">const</span> pubKeyBob = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">exportKeyItem</span>(aliasBob, emptyOptions)</li><li>
</li><li>  <span class="hljs-comment">/* 开始协商，协商生成的密钥返回给业务管理 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeExportTest</span>(aliasAlice, aliasBob, pubKeyAlice, pubKeyBob)</li><li>
</li><li>  <span class="hljs-comment">/* 开始协商，协商生成的密钥由HUKS管理 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">HuksDhAgreeInHuksTest</span>(aliasAlice, aliasBob, pubKeyAlice, pubKeyBob, <span class="hljs-string">'agreedKeyFromAlice'</span>, <span class="hljs-string">'agreedKeyFromBob'</span>)</li><li>
</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">deleteKeyItem</span>(aliasAlice, emptyOptions)</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">deleteKeyItem</span>(aliasBob, emptyOptions)</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>