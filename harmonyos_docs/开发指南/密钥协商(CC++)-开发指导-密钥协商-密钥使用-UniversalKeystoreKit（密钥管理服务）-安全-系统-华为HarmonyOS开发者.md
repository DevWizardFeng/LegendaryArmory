<h1 _ngcontent-pgp-c119="" class="doc-title ng-star-inserted" title="密钥协商(C/C++)"> 密钥协商(C/C++) </h1>

<div _ngcontent-pgp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>以ECDH协商密钥类型为例，在密钥由HUKS管理的情况下，完成密钥协商。具体的场景介绍及支持的算法规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-agreement-overview#支持的算法">密钥协商支持的算法</a>。</p>  <div class="tiledSection"><h2 id="在cmake脚本中链接相关动态库">在CMake脚本中链接相关动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接相关动态库" tips="复制节点链接"></i></h2><div _ngcontent-pgp-c106="" class="highlight-div"><div _ngcontent-pgp-c106="" class="highlight-div-header"><div _ngcontent-pgp-c106="" class="highlight-div-header-left"><div _ngcontent-pgp-c106="" class="handle-button expand-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgp-c106="" class="highlight-div-header-right"><div _ngcontent-pgp-c106="" class="handle-button ai-button"></div><div _ngcontent-pgp-c106="" class="handle-button line-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgp-c106="" class="handle-button theme-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgp-c106="" class="handle-button copy-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgp-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhuks_ndk.z.so)</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p><strong>生成密钥</strong></p> <p>设备A、设备B各自生成一个非对称密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview">密钥导入</a>。</p> <p>密钥生成时，可指定参数，OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG（可选），用于标识此步骤生成的密钥是否由HUKS管理。</p> <p><strong>导出密钥</strong></p> <p>设备A、B导出非对称密钥对的公钥材料，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-export-key-arkts">密钥导出</a>。</p> <p><strong>密钥协商</strong></p> <p>设备A、B分别基于本端私钥和对端设备的公钥，协商出共享密钥。</p> <p>密钥协商时，可指定参数OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG（可选），用于标识协商得到的密钥是否由HUKS管理。</p> <ul><li><p>当TAG设置为OH_HUKS_STORAGE_ONLY_USED_IN_HUKS时，表示基于该密钥协商出的密钥，由HUKS管理，可保证协商密钥全生命周期不出安全环境。</p>  </li><li><p>当TAG设置为OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED时，表示基于该密钥协商出的密钥，返回给调用方管理，由业务自行保证密钥安全。</p>  </li><li><p>若业务未设置TAG的具体值，表示基于该密钥协商出的密钥，既可由HUKS管理，也可返回给调用方管理，业务可在后续协商时再选择使用何种方式保护密钥。</p>  </li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.11.1.4.1.1" valign="top" width="33.33333333333333%">生成</th> <th align="left" class="cellrowborder" id="mcps1.3.3.11.1.4.1.2" valign="top" width="33.33333333333333%">协商</th> <th align="left" class="cellrowborder" id="mcps1.3.3.11.1.4.1.3" valign="top" width="33.33333333333333%">规格</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td> </tr>  </tbody></table></div> </div> <p>注：协商时指定的TAG值，不可与生成时指定的TAG值冲突。表格中仅列举有效的指定方式。</p> <p><strong>删除密钥</strong></p> <p>当密钥废弃不用时，设备A、B均需要删除密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-delete-key-ndk">密钥删除</a>。</p> <div _ngcontent-pgp-c106="" class="highlight-div"><div _ngcontent-pgp-c106="" class="highlight-div-header"><div _ngcontent-pgp-c106="" class="highlight-div-header-left"><div _ngcontent-pgp-c106="" class="handle-button expand-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgp-c106="" class="highlight-div-header-right"><div _ngcontent-pgp-c106="" class="handle-button ai-button"></div><div _ngcontent-pgp-c106="" class="handle-button line-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgp-c106="" class="handle-button theme-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgp-c106="" class="handle-button copy-button"><div _ngcontent-pgp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-comment">/* 初始化参数 */</span></li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">InitParamSet</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_ParamSet **paramSet,</span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Param *params,</span></li><li><span class="hljs-function">    <span class="hljs-type">uint32_t</span> paramCount)</span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_AddParams</span>(*paramSet, params, paramCount);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_BuildParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> IV_SIZE = <span class="hljs-number">16</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> IV[IV_SIZE] = { <span class="hljs-number">0</span> }; <span class="hljs-comment">// this is a test value, for real use the iv should be different every time.</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_keyAliasFinal1001 = {</li><li>    (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_1_final"</span>),</li><li>    (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_1_final"</span></li><li>};</li><li><span class="hljs-comment">/* 集成密钥参数集 */</span></li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_genAgreeParams[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_ECC</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_ECC_KEY_SIZE_256</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_DIGEST,</li><li>        .uint32Param = OH_HUKS_DIGEST_NONE</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_agreeParamsInit01[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_ECDH</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_ECC_KEY_SIZE_256</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_agreeParamsFinish01[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG,</li><li>        .uint32Param = OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_AES</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_AES_KEY_SIZE_256</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_ALIAS,</li><li>        .blob = g_keyAliasFinal1001</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PADDING,</li><li>        .uint32Param = OH_HUKS_PADDING_NONE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_BLOCK_MODE,</li><li>        .uint32Param = OH_HUKS_MODE_CBC</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_keyAliasFinal2001 = {</li><li>    (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_2_final"</span>),</li><li>    (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_2_final"</span></li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_agreeParamsInit02[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_ECDH</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_ECC_KEY_SIZE_256</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_agreeParamsFinish02[] = {</li><li>    {</li><li>        .tag = OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG,</li><li>        .uint32Param = OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_AES</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_AES_KEY_SIZE_256</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_KEY_ALIAS,</li><li>        .blob = g_keyAliasFinal2001</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_PADDING,</li><li>        .uint32Param = OH_HUKS_PADDING_NONE</li><li>    }, {</li><li>        .tag = OH_HUKS_TAG_BLOCK_MODE,</li><li>        .uint32Param = OH_HUKS_MODE_CBC</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> ECDH_COMMON_SIZE = <span class="hljs-number">1024</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_keyAlias01001 = {</li><li>    (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_1"</span>),</li><li>    (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_1"</span></li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_keyAlias02001 = {</li><li>    (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_2"</span>),</li><li>    (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"HksECDHAgreeKeyAliasTest001_2"</span></li><li>};</li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">MallocAndCheckBlobData</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_Blob *blob,</span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> blobSize)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> ret;</li><li>    ret.errorCode = OH_HUKS_SUCCESS;</li><li>    blob-&gt;data = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(blobSize);</li><li>    <span class="hljs-keyword">if</span> (blob-&gt;data == <span class="hljs-literal">NULL</span>) {</li><li>        ret.errorCode = OH_HUKS_ERR_CODE_INTERNAL_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-comment">/* 导出密钥 */</span></li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">HksEcdhAgreeExport</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *keyAlias1, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *keyAlias2,</span></span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_Blob *publicKey1, <span class="hljs-keyword">struct</span> OH_Huks_Blob *publicKey2, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_ParamSet *genParamSet)</span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_ExportPublicKeyItem</span>(keyAlias1, genParamSet, publicKey1);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_ExportPublicKeyItem</span>(keyAlias2, genParamSet, publicKey2);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *g_inData = <span class="hljs-string">"Hks_ECDH_Agree_Test_000000000000000000000000000000000000000000000000000000000000"</span></li><li>                                    <span class="hljs-string">"00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span></li><li>                                    <span class="hljs-string">"0000000000000000000000000000000000000000000000000000000000000000000000000_string"</span>;</li><li><span class="hljs-comment">/* 协商密钥操作 */</span></li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">HksEcdhAgreeFinish</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *keyAlias, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Blob *publicKey,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_ParamSet *initParamSet, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_ParamSet *finishParamSet,</span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_Blob *outData)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> inData = {</li><li>        (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(g_inData),</li><li>        (<span class="hljs-type">uint8_t</span> *)g_inData</li><li>    };</li><li>    <span class="hljs-type">uint8_t</span> handleU[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> handle = { <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>), handleU };</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitSession</span>(keyAlias, initParamSet, &amp;handle, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-type">uint8_t</span> outDataU[ECDH_COMMON_SIZE] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> outDataUpdate = { ECDH_COMMON_SIZE, outDataU };</li><li>    ret = <span class="hljs-built_in">OH_Huks_UpdateSession</span>(&amp;handle, initParamSet, publicKey, &amp;outDataUpdate);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_FinishSession</span>(&amp;handle, finishParamSet, &amp;inData, outData);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-comment">/* 协商密钥整体流程 */</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">AgreeKey</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *genParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *initParamSet01 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *finishParamSet01 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *initParamSet02 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *finishParamSet02 = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> publicKey01 = { .size = OH_HUKS_ECC_KEY_SIZE_256, .data = <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> publicKey02 = { .size = OH_HUKS_ECC_KEY_SIZE_256, .data = <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> outData01 = { .size = ECDH_COMMON_SIZE, .data = <span class="hljs-literal">nullptr</span> };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> outData02 = { .size = ECDH_COMMON_SIZE, .data = <span class="hljs-literal">nullptr</span> };</li><li>    OH_Huks_Result ohResult;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-comment">/* 1.确定密钥别名集成密钥参数集 */</span></li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;genParamSet, g_genAgreeParams, <span class="hljs-built_in">sizeof</span>(g_genAgreeParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;initParamSet01, g_agreeParamsInit01,</li><li>            <span class="hljs-built_in">sizeof</span>(g_agreeParamsInit01) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;finishParamSet01, g_agreeParamsFinish01,</li><li>            <span class="hljs-built_in">sizeof</span>(g_agreeParamsFinish01) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;initParamSet02, g_agreeParamsInit02,</li><li>            <span class="hljs-built_in">sizeof</span>(g_agreeParamsInit02) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;finishParamSet02, g_agreeParamsFinish02,</li><li>            <span class="hljs-built_in">sizeof</span>(g_agreeParamsFinish02) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 2.设备A生成密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;g_keyAlias01001, genParamSet, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 3.设备B生成密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;g_keyAlias02001, genParamSet, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">MallocAndCheckBlobData</span>(&amp;publicKey01, publicKey01.size);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">MallocAndCheckBlobData</span>(&amp;publicKey02, publicKey02.size);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 4.设备A、B导出公钥 */</span></li><li>        ohResult = <span class="hljs-built_in">HksEcdhAgreeExport</span>(&amp;g_keyAlias01001, &amp;g_keyAlias02001, &amp;publicKey01, &amp;publicKey02, genParamSet);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">MallocAndCheckBlobData</span>(&amp;outData01, outData01.size);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        ohResult = <span class="hljs-built_in">MallocAndCheckBlobData</span>(&amp;outData02, outData02.size);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 5.设备A协商密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">HksEcdhAgreeFinish</span>(&amp;g_keyAlias01001, &amp;publicKey02, initParamSet01, finishParamSet01, &amp;outData01);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 5.设备B协商密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">HksEcdhAgreeFinish</span>(&amp;g_keyAlias02001, &amp;publicKey01, initParamSet02, finishParamSet02, &amp;outData02);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">free</span>(publicKey01.data);</li><li>    <span class="hljs-built_in">free</span>(publicKey02.data);</li><li>    <span class="hljs-built_in">free</span>(outData01.data);</li><li>    <span class="hljs-built_in">free</span>(outData02.data);</li><li>    <span class="hljs-comment">/* 6.设备A、B删除密钥 */</span></li><li>    <span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;g_keyAlias01001, genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;g_keyAlias02001, genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;g_keyAliasFinal1001, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;g_keyAliasFinal2001, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;initParamSet01);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;finishParamSet01);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;initParamSet02);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;finishParamSet02);</li><li>
</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ohResult.errorCode, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>