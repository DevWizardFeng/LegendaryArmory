<h1 _ngcontent-cbs-c119="" class="doc-title ng-star-inserted" title="密钥派生(C/C++)"> 密钥派生(C/C++) </h1>

<div _ngcontent-cbs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>以HKDF256密钥为例，完成密钥派生。具体的场景介绍及支持的算法规格，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-derivation-overview#支持的算法">密钥派生支持的算法</a>。</p>    <div class="tiledSection">     <h2 id="在cmake脚本中链接相关动态库">在CMake脚本中链接相关动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接相关动态库" tips="复制节点链接"></i></h2>          <div _ngcontent-cbs-c106="" class="highlight-div"><div _ngcontent-cbs-c106="" class="highlight-div-header"><div _ngcontent-cbs-c106="" class="highlight-div-header-left"><div _ngcontent-cbs-c106="" class="handle-button expand-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cbs-c106="" class="highlight-div-header-right"><div _ngcontent-cbs-c106="" class="handle-button ai-button"></div><div _ngcontent-cbs-c106="" class="handle-button line-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cbs-c106="" class="handle-button theme-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cbs-c106="" class="handle-button copy-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cbs-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhuks_ndk.z.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p><strong>生成密钥</strong></p>     <ol>      <li>       <p>指定密钥别名，密钥别名命名规范参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成介绍及算法规格</a>。</p></li>      <li>       <p>初始化密钥属性集，可指定参数，OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG（可选），用于标识基于该密钥派生出的密钥是否由HUKS管理。</p>       <ul>        <li>         <p>当TAG设置为OH_HUKS_STORAGE_ONLY_USED_IN_HUKS时，表示基于该密钥派生出的密钥，由HUKS管理，可保证派生密钥全生命周期不出安全环境。</p></li>        <li>         <p>当TAG设置为OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED时，表示基于该密钥派生出的密钥，返回给调用方管理，由业务自行保证密钥安全。</p></li>        <li>         <p>若业务未设置TAG的具体值，表示基于该密钥派生出的密钥，即可由HUKS管理，也可返回给调用方管理，业务可在后续派生时再选择使用何种方式保护密钥。</p></li>       </ul></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_generatekeyitem" target="_blank">OH_Huks_GenerateKeyItem</a>生成密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-overview">密钥生成</a>。</p></li>     </ol>     <p>除此之外，开发者也可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-import-overview">密钥导入</a>，导入已有的密钥。</p>     <p><strong>密钥派生</strong></p>     <ol>      <li>       <p>获取密钥别名，指定对应的属性参数HuksOptions。</p>       <p>可指定参数OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG（可选），用于标识派生得到的密钥是否由HUKS管理。</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.3.1.4.1.1" valign="top" width="33.33333333333333%">生成</th>           <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.3.1.4.1.2" valign="top" width="33.33333333333333%">派生</th>           <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.3.1.4.1.3" valign="top" width="33.33333333333333%">规格</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥由HUKS管理</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">OH_HUKS_STORAGE_KEY_EXPORT_ALLOWED</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">未指定TAG具体值</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">密钥返回给调用方管理</td>          </tr>                 </tbody></table></div>       </div>       <p>注：派生时指定的TAG值，不可与生成时指定的TAG值冲突。表格中仅列举有效的指定方式。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_initsession" target="_blank">OH_Huks_InitSession</a>初始化密钥会话，并获取会话的句柄handle。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_updatesession" target="_blank">OH_Huks_UpdateSession</a>更新密钥会话。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_finishsession" target="_blank">OH_Huks_FinishSession</a>结束密钥会话，完成派生。</p></li>     </ol>     <p><strong>删除密钥</strong></p>     <p>当密钥废弃不用时，需要调用OH_Huks_DeleteKeyItem删除密钥，具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-delete-key-ndk">密钥删除</a>。</p>     <div _ngcontent-cbs-c106="" class="highlight-div"><div _ngcontent-cbs-c106="" class="highlight-div-header"><div _ngcontent-cbs-c106="" class="highlight-div-header-left"><div _ngcontent-cbs-c106="" class="handle-button expand-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cbs-c106="" class="highlight-div-header-right"><div _ngcontent-cbs-c106="" class="handle-button ai-button"></div><div _ngcontent-cbs-c106="" class="handle-button line-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cbs-c106="" class="handle-button theme-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cbs-c106="" class="handle-button copy-button"><div _ngcontent-cbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cbs-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">InitParamSet</span><span class="hljs-params">(</span></span></li><li><span class="hljs-function">    <span class="hljs-keyword">struct</span> OH_Huks_ParamSet **paramSet,</span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Param *params,</span></li><li><span class="hljs-function">    <span class="hljs-type">uint32_t</span> paramCount)</span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_AddParams</span>(*paramSet, params, paramCount);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_BuildParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> DERIVE_KEY_SIZE_32 = <span class="hljs-number">32</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> DERIVE_KEY_SIZE_256 = <span class="hljs-number">256</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> g_deriveKeyAlias = {</li><li>    (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"test_derive"</span>),</li><li>    (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"test_derive"</span></li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_genDeriveParams[] = {</li><li>    {</li><li>        .tag =  OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_AES</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_DERIVE</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_DIGEST,</li><li>        .uint32Param = OH_HUKS_DIGEST_SHA256</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = OH_HUKS_AES_KEY_SIZE_256</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_hkdfParams[] = {</li><li>    {</li><li>        .tag =  OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_HKDF</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_DERIVE</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_DIGEST,</li><li>        .uint32Param = OH_HUKS_DIGEST_SHA256</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_DERIVE_KEY_SIZE,</li><li>        .uint32Param = DERIVE_KEY_SIZE_32</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_hkdfFinishParams[] = {</li><li>    {</li><li>        .tag =  OH_HUKS_TAG_DERIVED_AGREED_KEY_STORAGE_FLAG,</li><li>        .uint32Param = OH_HUKS_STORAGE_ONLY_USED_IN_HUKS</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_KEY_ALIAS,</li><li>        .blob = g_deriveKeyAlias</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_ALGORITHM,</li><li>        .uint32Param = OH_HUKS_ALG_AES</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_KEY_SIZE,</li><li>        .uint32Param = DERIVE_KEY_SIZE_256</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_PURPOSE,</li><li>        .uint32Param = OH_HUKS_KEY_PURPOSE_DERIVE</li><li>    }, {</li><li>        .tag =  OH_HUKS_TAG_DIGEST,</li><li>        .uint32Param = OH_HUKS_DIGEST_SHA256</li><li>    }</li><li>};</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> COMMON_SIZE = <span class="hljs-number">2048</span>;</li><li><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *g_deriveInData = <span class="hljs-string">"Hks_HKDF_Derive_Test_00000000000000000000000000000000000000000000000000000000000"</span></li><li>                                    <span class="hljs-string">"00000000000000000000000000000000000000000000000000000000000000000000000000000000"</span></li><li>                                    <span class="hljs-string">"0000000000000000000000000000000000000000000000000000000000000000000000000_string"</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DeriveKey</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> genAlias = {</li><li>        (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(<span class="hljs-string">"test_signVerify"</span>),</li><li>        (<span class="hljs-type">uint8_t</span> *)<span class="hljs-string">"test_signVerify"</span></li><li>    };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> inData = {</li><li>        (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(g_deriveInData),</li><li>        (<span class="hljs-type">uint8_t</span> *)g_deriveInData</li><li>    };</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *genParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *hkdfParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *hkdfFinishParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Huks_Result ohResult;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;genParamSet, g_genDeriveParams, <span class="hljs-built_in">sizeof</span>(g_genDeriveParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;hkdfParamSet, g_hkdfParams, <span class="hljs-built_in">sizeof</span>(g_hkdfParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>           <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// finish paramset</span></li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;hkdfFinishParamSet, g_hkdfFinishParams,</li><li>            <span class="hljs-built_in">sizeof</span>(g_hkdfFinishParams) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">/* 1. Generate Key */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;genAlias, genParamSet, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 2. Derive */</span></li><li>        <span class="hljs-comment">// Init</span></li><li>        <span class="hljs-type">uint8_t</span> handleD[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)] = {<span class="hljs-number">0</span>};</li><li>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> handleDerive = { <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>), handleD };</li><li>        ohResult = <span class="hljs-built_in">OH_Huks_InitSession</span>(&amp;genAlias, hkdfParamSet, &amp;handleDerive, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">// Update</span></li><li>        <span class="hljs-type">uint8_t</span> tmpOut[COMMON_SIZE] = {<span class="hljs-number">0</span>};</li><li>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> outData = { COMMON_SIZE, tmpOut };</li><li>        ohResult = <span class="hljs-built_in">OH_Huks_UpdateSession</span>(&amp;handleDerive, hkdfParamSet, &amp;inData, &amp;outData);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">// Finish</span></li><li>        <span class="hljs-type">uint8_t</span> outDataD[COMMON_SIZE] = {<span class="hljs-number">0</span>};</li><li>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> outDataDerive = { COMMON_SIZE, outDataD };</li><li>        ohResult = <span class="hljs-built_in">OH_Huks_FinishSession</span>(&amp;handleDerive, hkdfFinishParamSet, &amp;inData, &amp;outDataDerive);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;genAlias, <span class="hljs-literal">nullptr</span>);</li><li>    (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_Huks_DeleteKeyItem</span>(&amp;g_deriveKeyAlias, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;genParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;hkdfParamSet);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;hkdfFinishParamSet);</li><li>
</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ohResult.errorCode, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>