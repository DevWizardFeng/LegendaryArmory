<h1 _ngcontent-qay-c119="" class="doc-title ng-star-inserted" title="对焦(C/C++)"> 对焦(C/C++) </h1>

<div _ngcontent-qay-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>相机框架提供对设备对焦的能力，业务应用可以根据使用场景进行对焦模式和对焦点的设置。</p> <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h" target="_blank">Camera API参考</a>。</p> <ol><li><p>导入NDK接口，导入方法如下。</p> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 导入NDK接口头文件</span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div> </li><li><p>在CMake脚本中链接相关动态库。</p> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li> target_link_libraries(entry PUBLIC libohcamera.so libhilog_ndk.z.so)</li></ol></pre></div></div> </li><li><p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setfocusmode" target="_blank">OH_CaptureSession_SetFocusMode</a>设置对焦模式。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>需要先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_isfocusmodesupported" target="_blank">OH_CaptureSession_IsFocusModeSupported</a>检查设备是否支持指定的焦距模式。</li><li>需要在Session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_commitconfig" target="_blank">OH_CaptureSession_CommitConfig</a>完成配流之后调用。</li></ul> </div></div></div> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li> Camera_ErrorCode SetFocusMode(Camera_CaptureSession *captureSession, uint32_t mode)</li><li> {</li><li>     <span class="hljs-type">bool</span> isFocusModeSupported = <span class="hljs-literal">false</span>;</li><li>     Camera_FocusMode focusMode = static_cast&lt;Camera_FocusMode&gt;(mode);</li><li>     Camera_ErrorCode ret = OH_CaptureSession_IsFocusModeSupported(captureSession, focusMode, &amp;isFocusModeSupported);</li><li>     <span class="hljs-keyword">if</span> (&amp;isFocusModeSupported == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>         OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"IsFocusModeSupported failed."</span>);</li><li>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">CAMERA_INVALID_ARGUMENT</span>;</li><li>     }</li><li>
</li><li>     <span class="hljs-keyword">if</span> (!isFocusModeSupported) {</li><li>         OH_LOG_INFO(LOG_APP, <span class="hljs-string">"current focusMode(%{public}d) is not supported."</span>, focusMode);</li><li>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">CAMERA_OK</span>;</li><li>     }</li><li>
</li><li>     OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFocusMode focusMode(%{public}d)."</span>, focusMode);</li><li>     ret = OH_CaptureSession_SetFocusMode(captureSession, focusMode);</li><li>     <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>         OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"SetFocusMode failed."</span>);</li><li>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">CAMERA_INVALID_ARGUMENT</span>;</li><li>     }</li><li>     <span class="hljs-keyword">return</span> ret;</li><li> }</li></ol></pre></div></div> </li><li><div class="p">如果通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setfocusmode" target="_blank">OH_CaptureSession_SetFocusMode</a>设置对焦模式为自动对焦模式，支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setfocuspoint" target="_blank">OH_CaptureSession_SetFocusPoint</a>设置对焦点，根据对焦点执行一次自动对焦。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>需要在Session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_commitconfig" target="_blank">OH_CaptureSession_CommitConfig</a>完成配流之后调用。</p> </div></div></div> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li> Camera_ErrorCode <span class="hljs-title function_">SetFocusPoint</span><span class="hljs-params">(Camera_CaptureSession *captureSession, <span class="hljs-type">float</span> x, <span class="hljs-type">float</span> y)</span></li><li> {</li><li>     Camera_Point focusPoint;</li><li>     focusPoint.x = x;</li><li>     focusPoint.y = y;</li><li>     <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_SetFocusPoint(captureSession, focusPoint);</li><li>     <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>         OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"SetFocusPoint failed."</span>);</li><li>         <span class="hljs-keyword">return</span> CAMERA_INVALID_ARGUMENT;</li><li>     }</li><li>     <span class="hljs-keyword">return</span> ret;</li><li> }</li></ol></pre></div></div> </div> </li></ol> </div> <div class="tiledSection"><h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2><p>在相机应用开发过程中，可以随时监听相机聚焦的状态变化。</p> <p>通过注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_onfocusstatechange" target="_blank">OnFocusStateChange</a>的回调函数获取监听结果，仅当自动对焦模式时，且相机对焦状态发生改变时触发该事件。</p> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> <span class="hljs-title function_">CaptureSessionOnFocusStateChange</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_FocusState focusState)</span></li><li>    {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSession_Callbacks CaptureSessionOnFocusStateChange"</span>);</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSession focusState = %{public}d"</span>, focusState);</li><li>        <span class="hljs-comment">// 为保证对焦功能的用户体验，在自动对焦成功后，可将对焦模式设置为连续自动对焦</span></li><li>        <span class="hljs-keyword">if</span> (focusState == Camera_FocusState::FOCUS_STATE_FOCUSED) {</li><li>            <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> SetFocusMode(captureSession, Camera_FocusMode::FOCUS_MODE_CONTINUOUS_AUTO);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">CaptureSessionOnError</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_ErrorCode errorCode)</span></li><li>    {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSession_Callbacks CaptureSessionOnError"</span>);</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSession errorCode = %{public}d"</span>, errorCode);</li><li>    }</li><li>
</li><li>    CaptureSession_Callbacks* GetCaptureSessionRegister(<span class="hljs-keyword">void</span>)</li><li>    {</li><li>        <span class="hljs-keyword">static</span> <span class="hljs-type">CaptureSession_Callbacks</span> <span class="hljs-variable">captureSessionCallbacks</span> <span class="hljs-operator">=</span> {</li><li>            .onFocusStateChange = CaptureSessionOnFocusStateChange,</li><li>            .onError = CaptureSessionOnError</li><li>        };</li><li>        <span class="hljs-keyword">return</span> &amp;captureSessionCallbacks;</li><li>    }</li></ol></pre></div></div> <div _ngcontent-qay-c106="" class="highlight-div"><div _ngcontent-qay-c106="" class="highlight-div-header"><div _ngcontent-qay-c106="" class="highlight-div-header-left"><div _ngcontent-qay-c106="" class="handle-button expand-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qay-c106="" class="highlight-div-header-right"><div _ngcontent-qay-c106="" class="handle-button ai-button"></div><div _ngcontent-qay-c106="" class="handle-button line-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qay-c106="" class="handle-button theme-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qay-c106="" class="handle-button copy-button"><div _ngcontent-qay-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qay-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class=""><span class="hljs-title function_">RegisterCallback</span></span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="">OH_CaptureSession_RegisterCallback</span>(captureSession<span class="">, </span><span class="">GetCaptureSessionRegister</span>())<span class="">;</span></li><li><span class="">    <span class="hljs-keyword">if</span> </span>(ret != <span class="">CAMERA_OK</span>) {</li><li>        <span class="">OH_LOG_ERROR</span>(<span class="">LOG_APP</span><span class="">, </span><span class=""><span class="hljs-string">"OH_CaptureSession_RegisterCallback failed."</span></span>)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">return</span> </span>ret<span class="">;</span></li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>