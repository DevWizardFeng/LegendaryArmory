<h1 _ngcontent-sld-c119="" class="doc-title ng-star-inserted" title="屏幕录制支持矩形区域录制"> 屏幕录制支持矩形区域录制 </h1>

<div _ngcontent-sld-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="基础概念">基础概念<i class="anchor-icon anchor-icon-link" anchorid="基础概念" tips="复制节点链接"></i></h2>          <p>从API20开始，屏幕录制支持矩形区域录制是在现有的录制区域捕获基础上开放的能力，允许开发者自主选择录屏需要捕获的区域位置，并通过调整屏幕捕获ID和指定的捕获区域area确定矩形录制区域。</p>     <p>在功能开发前，开发者需要掌握以下基础概念：</p>     <ul>      <li>屏幕捕获ID（displayId）：需要执行矩形区域录制的屏幕ID。</li>      <li>指定的捕获区域（area）：依据需要设置区域坐标和尺寸，如创建区域的起点和录制矩形的长度和宽度。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="适用场景">适用场景<i class="anchor-icon anchor-icon-link" anchorid="适用场景" tips="复制节点链接"></i></h2>          <p>用户希望能够提供矩形区域录制功能的场景，例如：</p>     <ul>      <li><strong>在线教育场景</strong>：教师在进行课程讲解时，会在一个较大的屏幕上展示多种内容。若能够选择性地录制某个矩形区域，则可以减少不必要的干扰，使学生更加专注于教学内容。</li>      <li><strong>游戏直播场景</strong>：对于玩家来说，在直播或录制游戏时，仅关注游戏界面本身，可通过区域录制让观众专注于游戏本身。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p><strong>在CMake脚本中链接动态库</strong></p>     <div _ngcontent-sld-c106="" class="highlight-div"><div _ngcontent-sld-c106="" class="highlight-div-header"><div _ngcontent-sld-c106="" class="highlight-div-header-left"><div _ngcontent-sld-c106="" class="handle-button expand-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sld-c106="" class="highlight-div-header-right"><div _ngcontent-sld-c106="" class="handle-button ai-button"></div><div _ngcontent-sld-c106="" class="handle-button line-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sld-c106="" class="handle-button theme-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sld-c106="" class="handle-button copy-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sld-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_avscreen_capture.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>     <p><strong>添加头文件</strong></p>     <div _ngcontent-sld-c106="" class="highlight-div"><div _ngcontent-sld-c106="" class="highlight-div-header"><div _ngcontent-sld-c106="" class="highlight-div-header-left"><div _ngcontent-sld-c106="" class="handle-button expand-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sld-c106="" class="highlight-div-header-right"><div _ngcontent-sld-c106="" class="handle-button ai-button"></div><div _ngcontent-sld-c106="" class="handle-button line-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sld-c106="" class="handle-button theme-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sld-c106="" class="handle-button copy-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sld-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avscreen_capture_errors.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li></ol></pre></div></div>     <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avscreen-capture-h#oh_avscreencapture_setcapturearea" target="_blank">OH_AVScreenCapture_SetCaptureArea()</a>接口传入希望录制的矩形区域。</p>     <p>示例中的变量说明如下：</p>     <ul>      <li>capture：指向<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture-oh-avscreencapture" target="_blank">OH_AVScreenCapture</a>实例的指针。</li>      <li>displayId：需要捕获区域所在的屏幕Id。</li>      <li>area：需要捕获区域的坐标和宽高。类型为OH_Rect，包括成员变量x、y、width、height。       <ul>        <li>x、y分别为矩形区域起点的横坐标、纵坐标位置。</li>        <li>width、height分别为矩形区域的宽度和长度。</li>        <li>多个参数之间通过";"连接，所有参数均为整数。</li>        <li>使用前请确保传入参数有效，并尽量避免坐标和宽高为负数。</li>       </ul></li>     </ul>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p><strong>录制区域限制</strong>：</p>       <ul>        <li>安全图层不支持录制。</li>        <li>         <p>不支持跨屏（一边在左边/一边在右边）录制。</p>         <p><strong>录制区域更改</strong>：支持录制过程中，更新录制区域。</p>         <p><strong>设置失败的处理</strong>：如果区域位置设置失败，系统将按照上一次的区域进行捕获。建议开发者在设置区域时进行错误检查和处理，以确保捕获区域的准确性。</p>         <p><strong>参数设置非负</strong>：该接口设置的坐标和宽高不能为负数，捕获区域不能跨屏幕，区域位置设置失败后仍按照上一次的区域进行捕获。</p></li>       </ul>      </div></div></div>     <div _ngcontent-sld-c106="" class="highlight-div"><div _ngcontent-sld-c106="" class="highlight-div-header"><div _ngcontent-sld-c106="" class="highlight-div-header-left"><div _ngcontent-sld-c106="" class="handle-button expand-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sld-c106="" class="highlight-div-header-right"><div _ngcontent-sld-c106="" class="handle-button ai-button"></div><div _ngcontent-sld-c106="" class="handle-button line-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sld-c106="" class="handle-button theme-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sld-c106="" class="handle-button copy-button"><div _ngcontent-sld-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sld-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_AVScreenCapture</span> *<span class="hljs-variable">capture</span> = <span class="hljs-title function_">OH_AVScreenCapture_Create</span>();</li><li><span class="hljs-comment">// 初始化录屏，传入配置信息OH_AVScreenRecorderConfig。</span></li><li><span class="hljs-variable">OH_AudioCaptureInfo</span> <span class="hljs-variable">miccapinfo</span> = {.<span class="hljs-variable">audioSampleRate</span> = <span class="hljs-number">16000</span>, .<span class="hljs-variable">audioChannels</span> = <span class="hljs-number">2</span>, .<span class="hljs-variable">audioSource</span> = <span class="hljs-variable">OH_MIC</span>};</li><li><span class="hljs-variable">OH_VideoCaptureInfo</span> <span class="hljs-variable">videocapinfo</span> = {</li><li>    .<span class="hljs-variable">videoFrameWidth</span> = <span class="hljs-number">768</span>, .<span class="hljs-variable">videoFrameHeight</span> = <span class="hljs-number">1280</span>, .<span class="hljs-variable">videoSource</span> = <span class="hljs-variable">OH_VIDEO_SOURCE_SURFACE_RGBA</span>};</li><li><span class="hljs-variable">OH_AudioInfo</span> <span class="hljs-variable">audioinfo</span> = {</li><li>    .<span class="hljs-variable">micCapInfo</span> = <span class="hljs-variable">miccapinfo</span>,</li><li>};</li><li><span class="hljs-variable">OH_VideoInfo</span> <span class="hljs-variable">videoinfo</span> = {.<span class="hljs-variable">videoCapInfo</span> = <span class="hljs-variable">videocapinfo</span>};</li><li><span class="hljs-variable">OH_AVScreenCaptureConfig</span> <span class="hljs-variable">config</span> = {.<span class="hljs-variable">captureMode</span> = <span class="hljs-variable">OH_CAPTURE_HOME_SCREEN</span>,</li><li>                                   .<span class="hljs-variable">dataType</span> = <span class="hljs-variable">OH_ORIGINAL_STREAM</span>,</li><li>                                   .<span class="hljs-variable">audioInfo</span> = <span class="hljs-variable">audioinfo</span>,</li><li>                                   .<span class="hljs-variable">videoInfo</span> = <span class="hljs-variable">videoinfo</span>};</li><li><span class="hljs-title function_">OH_AVScreenCapture_Init</span>(<span class="hljs-variable">capture</span>, <span class="hljs-variable">config</span>);</li><li><span class="hljs-comment">// 1. 可选，可以根据需要设置区域坐标和大小，设置想要捕获的区域，如下方创建了一个从（0, 0）为起点的长100，宽100的矩形区域。</span></li><li><span class="hljs-variable">OH_Rect</span>* <span class="hljs-variable">region</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">OH_Rect</span>;</li><li><span class="hljs-variable">region</span>-&gt;<span class="hljs-title class_">x</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">region</span>-&gt;<span class="hljs-title class_">y</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">region</span>-&gt;<span class="hljs-title class_">width</span> = <span class="hljs-number">100</span>;</li><li><span class="hljs-variable">region</span>-&gt;<span class="hljs-title class_">height</span> = <span class="hljs-number">100</span>;</li><li><span class="hljs-comment">// 2. 传入矩形区域所在的屏幕Id。</span></li><li><span class="hljs-variable">uint64_t</span> <span class="hljs-variable">regionDisplayId</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-title function_">OH_AVScreenCapture_SetCaptureArea</span>(<span class="hljs-variable">capture</span>, <span class="hljs-variable">regionDisplayId</span>, <span class="hljs-variable">region</span>);</li><li>
</li><li><span class="hljs-comment">// 开始录屏。</span></li><li><span class="hljs-title function_">OH_AVScreenCapture_StartScreenCapture</span>(<span class="hljs-variable">capture</span>);</li></ol></pre></div></div>    </div>   </div>   <div></div></div>